<template>
  <div class="unified-user-management">
    <!-- –ü–†–û–°–¢–û–ô –¢–ï–°–¢–û–í–´–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div class="test-header">
      <h1>üéØ –ù–æ–≤—ã–π –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
      <p>TASK-089: –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</p>
    </div>

    <div class="test-content">
      <div class="status-grid">
        <div class="status-card">
          <h3>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</h3>
          <ul>
            <li>–°—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–¥–∞–ª–µ–Ω</li>
            <li>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞</li>
            <li>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã</li>
          </ul>
        </div>

        <div class="status-card">
          <h3>üîß –í —Ä–∞–±–æ—Ç–µ</h3>
          <ul>
            <li>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</li>
            <li>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞</li>
            <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ API</li>
          </ul>
        </div>

        <div class="status-card">
          <h3>üéØ –¶–µ–ª—å</h3>
          <ul>
            <li>–ï–¥–∏–Ω—ã–π drill-down –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</li>
            <li>–ë–µ–∑ –∫–Ω–æ–ø–∫–∏ "–î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞"</li>
            <li>–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</li>
          </ul>
        </div>
      </div>

      <div class="test-actions">
        <button @click="testComponents" class="test-btn">
          üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        </button>
        <button @click="showArchitecture" class="info-btn">
          üìã –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
        </button>
      </div>

      <div v-if="testResults" class="test-results">
        <h3>üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
        <pre>{{ testResults }}</pre>
      </div>

      <div v-if="architectureInfo" class="architecture-info">
        <h3>üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</h3>
        <pre>{{ architectureInfo }}</pre>
      </div>
    </div>
  </div>
</template>

<script>
import { ref } from 'vue';

/**
 * UnifiedUserManagement - –ü–†–û–°–¢–û–ô –¢–ï–°–¢–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢
 * –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ TASK-089
 */
export default {
  name: 'UnifiedUserManagement',

  props: {
    /**
     * –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–ª—è SSR –∏–ª–∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏)
     */
    initialUsers: {
      type: Array,
      default: () => []
    },

    /**
     * –ù–∞—á–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
     */
    initialFilters: {
      type: Object,
      default: () => ({})
    },

    /**
     * –ù–∞—á–∞–ª—å–Ω—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
     */
    initialSelectedUser: {
      type: Object,
      default: null
    },

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    config: {
      type: Object,
      default: () => ({
        enablePersistence: true,
        enableKeyboardShortcuts: true,
        defaultView: 'global'
      })
    }
  },

  emits: [
    'user-selected',
    'context-changed',
    'data-exported',
    'permissions-updated',
    'bulk-action-completed'
  ],

  setup(props, { emit }) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è composables
    const {
      state,
      hasSelectedUsers,
      selectedUserStats,
      canEditPermissions,
      canDeleteUsers,
      contextTitle,
      isContextGlobal,
      isContextUser,
      isContextManagement,
      loadUsers,
      loadGlobalMetrics,
      selectUser,
      deselectUser,
      switchToGlobal,
      switchToManagement,
      updateFilters,
      resetFilters,
      saveFilterPreset,
      loadFilterPreset,
      updateBreadcrumbs,
      goBack,
      updateUserPermissions,
      toggleUserVisibility,
      performBulkAction,
      refreshData,
      emitNotification
    } = useUnifiedUserManagement({
      enablePersistence: props.config.enablePersistence,
      defaultContext: props.config.defaultView
    });

    const {
      canGoBack,
      canGoForward,
      currentCrumb,
      previousCrumb,
      isAtRoot,
      navigationPath,
      navigateToContext,
      goBack: navGoBack,
      navigateToCrumb,
      goToRoot,
      addCustomCrumb,
      removeLastCrumb,
      clearNavigation,
      getNavigationHistory,
      clearNavigationHistory
    } = useContextNavigation({
      enablePersistence: props.config.enablePersistence
    });

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const showUserProfileModal = ref(false);
    const showBulkActionsModal = ref(false);
    const showExportModal = ref(false);
    const modalUser = ref(null);
    const modalActivityData = ref(null);
    const exportDataType = ref('users');
    const notification = ref(null);
    const notificationTimeout = ref(null);

    // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    const isLoading = computed(() => state.loading);
    const loadingMessage = computed(() => state.loadingMessage);
    const hasError = computed(() => !!state.error);
    const errorMessage = computed(() => state.error);
    const currentContext = computed(() => state.currentContext);
    const selectedUser = computed(() => state.selectedUser);
    const selectedUsers = computed(() => state.selectedUsers);
    const breadcrumbs = computed(() => state.breadcrumbs);
    const filters = computed(() => state.filters);
    const userFilters = computed(() => state.filters);
    const filteredUsers = computed(() => state.filteredUsers);
    const pagination = computed(() => state.pagination);
    const globalMetrics = computed(() => state.globalMetrics);
    const viewOptions = computed(() => state.viewOptions);
    const departments = computed(() => state.departments || []);
    const activityTypes = computed(() => state.activityTypes || []);
    const filterPresets = computed(() => state.filterPresets || []);
    const activePreset = computed(() => state.activePreset);
    const recentActivity = computed(() => state.recentActivity || []);
    const auditLog = computed(() => state.auditLog || []);
    const isNavigating = computed(() => state.isNavigating);

    // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    const bulkActions = computed(() => [
      { id: 'change_department', label: '–ò–∑–º–µ–Ω–∏—Ç—å –æ—Ç–¥–µ–ª', icon: 'BuildingIcon' },
      { id: 'toggle_admin', label: '–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', icon: 'ShieldIcon' },
      { id: 'export', label: '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö', icon: 'DownloadIcon' },
      { id: 'hide_users', label: '–°–∫—Ä—ã—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', icon: 'EyeOffIcon' }
    ]);

    const userActivityData = computed(() => {
      if (!selectedUser.value) return {};

      // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ API)
      return {
        timeline: [],
        sessions: [],
        stats: selectedUserStats.value,
        trends: {}
      };
    });

    // –ú–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleUserSelect = async (user) => {
      try {
        await selectUser(user);
        emit('user-selected', user);
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
      }
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     */
    const handleUserSelectMultiple = (users) => {
      state.selectedUsers = users;
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
     */
    const handleFiltersChange = (newFilters) => {
      updateFilters(newFilters);
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
     */
    const handlePaginationChange = async (newPage) => {
      await loadUsers({ page: newPage });
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ü–∏–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    const handleViewOptionsChange = (newOptions) => {
      Object.assign(state.viewOptions, newOptions);
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
      localStorage.setItem('um-view-options', JSON.stringify(state.viewOptions));
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
     */
    const handleUserAction = async (action, user) => {
      try {
        switch (action) {
          case 'view-profile':
            await handleViewProfile(user);
            break;
          case 'edit-permissions':
            await handleEditPermissions(user);
            break;
          case 'toggle-visibility':
            await toggleUserVisibility(user.id);
            break;
          case 'delete':
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.name}?`)) {
              await performBulkAction('delete', [user.id]);
            }
            break;
          default:
            console.warn('[UnifiedUserManagement] Unknown user action:', action);
        }
      } catch (error) {
        showNotification(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è: ${error.message}`, 'error');
      }
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ breadcrumb –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     */
    const handleBreadcrumbNavigate = async (crumb) => {
      try {
        if (crumb.action) {
          await crumb.action();
        } else {
          await navigateToContext(crumb.context, crumb.data);
        }
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏', 'error');
      }
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
     */
    const handleGoBack = async () => {
      try {
        const success = await goBack();
        if (!success) {
          await switchToGlobal();
        }
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞', 'error');
      }
    };

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
     */
    const handleAdditionalAction = (action) => {
      switch (action.id) {
        case 'refresh':
          handleRefresh();
          break;
        case 'export':
          handleGlobalExport();
          break;
        case 'settings':
          handleSettings();
          break;
        default:
          console.warn('[UnifiedUserManagement] Unknown additional action:', action);
      }
    };

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è breadcrumb
     */
    const getAdditionalActions = () => {
      return [
        {
          id: 'refresh',
          text: '–û–±–Ω–æ–≤–∏—Ç—å',
          icon: 'RefreshCwIcon',
          class: 'refresh'
        },
        {
          id: 'export',
          text: '–≠–∫—Å–ø–æ—Ä—Ç',
          icon: 'DownloadIcon',
          class: 'export'
        },
        {
          id: 'settings',
          text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
          icon: 'SettingsIcon',
          class: 'settings'
        }
      ];
    };

    // –ú–µ—Ç–æ–¥—ã –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ –¥–µ–π—Å—Ç–≤–∏–π

    /**
     * –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleViewProfile = async (user) => {
      modalUser.value = user;
      modalActivityData.value = await loadUserActivityData(user.id);
      showUserProfileModal.value = true;
    };

    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleEditPermissions = async (user) => {
      await switchToManagement({ selectedUsers: [user] });
    };

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleExportData = (user) => {
      exportDataType.value = 'user';
      state.selectedUsers = [user];
      showExportModal.value = true;
    };

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    const handleExportUserData = () => {
      handleExportData(selectedUser.value);
    };

    /**
     * –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleViewDetailedAnalysis = () => {
      // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
      addCustomCrumb({
        id: 'detailed-analysis',
        label: '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑',
        icon: 'BarChartIcon',
        action: () => removeLastCrumb()
      });
    };

    /**
     * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
     */
    const handlePermissionsChange = async (userId, permissions) => {
      try {
        await updateUserPermissions(userId, permissions);
        showNotification('–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        emit('permissions-updated', { userId, permissions });
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤', 'error');
      }
    };

    /**
     * –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
     */
    const handleBulkUpdate = async (action, data) => {
      try {
        await performBulkAction(action, state.selectedUsers.map(u => u.id), data);
        showNotification(`–ú–∞—Å—Å–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ "${action}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`, 'success');
        emit('bulk-action-completed', { action, data });
      } catch (error) {
        showNotification(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è "${action}"`, 'error');
      }
    };

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
     */
    const handleRefresh = async () => {
      try {
        await refreshData();
        showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
      }
    };

    /**
     * –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
     */
    const handleGlobalExport = () => {
      exportDataType.value = 'users';
      showExportModal.value = true;
    };

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    const handleSettings = () => {
      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
      showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    };

    // –ú–µ—Ç–æ–¥—ã –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è
     */
    const closeUserProfileModal = () => {
      showUserProfileModal.value = false;
      modalUser.value = null;
      modalActivityData.value = null;
    };

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleUserProfileSave = async (updatedUser) => {
      try {
        // –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ API)
        await new Promise(resolve => setTimeout(resolve, 500));

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const userIndex = state.users.findIndex(u => u.id === updatedUser.id);
        if (userIndex !== -1) {
          state.users[userIndex] = { ...state.users[userIndex], ...updatedUser };
        }

        showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        closeUserProfileModal();
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
      }
    };

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
     */
    const closeBulkActionsModal = () => {
      showBulkActionsModal.value = false;
    };

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
     */
    const handleBulkActionExecute = async (action) => {
      await handleBulkUpdate(action.id, action.data);
      closeBulkActionsModal();
    };

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    const closeExportModal = () => {
      showExportModal.value = false;
      exportDataType.value = 'users';
    };

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    const handleExportExecute = async (exportConfig) => {
      try {
        // –ò–º–∏—Ç–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É)
        await new Promise(resolve => setTimeout(resolve, 1000));

        showNotification('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
        closeExportModal();
        emit('data-exported', exportConfig);
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
      }
    };

    // –ú–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
     */
    const handleSidebarToggle = (collapsed) => {
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage
      localStorage.setItem('um-sidebar-collapsed', collapsed);
    };

    /**
     * –ö–ª–∏–∫ –Ω–∞ –º–µ—Ç—Ä–∏–∫—É
     */
    const handleMetricClick = (metric) => {
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫–∏
      switch (metric.id) {
        case 'active_users':
          updateFilters({ activity_filter: 'active' });
          break;
        case 'new_users_today':
          updateFilters({ time_range: 'today', activity_filter: 'new' });
          break;
        // –î—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏...
      }
    };

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
     */
    const handleFilterPresetApply = (preset) => {
      loadFilterPreset(preset.id);
      showNotification(`–ü—Ä–∏–º–µ–Ω–µ–Ω —Ñ–∏–ª—å—Ç—Ä "${preset.label}"`, 'success');
    };

    /**
     * –ö–ª–∏–∫ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ
     */
    const handleActivityClick = (activity) => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –Ω–µ–¥–∞–≤–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
      console.log('Activity clicked:', activity);
    };

    /**
     * –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const handleUserFilterChange = (newFilters) => {
      updateFilters(newFilters);
    };

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
     */
    const handleBulkAction = async (bulkAction) => {
      await handleBulkUpdate(bulkAction.action, bulkAction.users.map(u => u.id));
    };

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const loadUserActivityData = async (userId) => {
      // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ API)
      await new Promise(resolve => setTimeout(resolve, 300));
      return {
        timeline: [],
        sessions: [],
        stats: selectedUserStats.value
      };
    };

    /**
     * –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
     */
    const retryLoading = async () => {
      state.error = null;
      try {
        await refreshData();
      } catch (error) {
        state.error = error.message;
      }
    };

    /**
     * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    const showNotification = (message, type = 'info') => {
      notification.value = { message, type };

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
      if (notificationTimeout.value) {
        clearTimeout(notificationTimeout.value);
      }

      notificationTimeout.value = setTimeout(() => {
        closeNotification();
      }, 5000);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ emitNotification –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      emitNotification(message, type);
    };

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    const closeNotification = () => {
      notification.value = null;
      if (notificationTimeout.value) {
        clearTimeout(notificationTimeout.value);
        notificationTimeout.value = null;
      }
    };

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
    const setupKeyboardShortcuts = () => {
      const handleKeydown = (event) => {
        // Ctrl/Cmd + R - –æ–±–Ω–æ–≤–∏—Ç—å
        if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
          event.preventDefault();
          handleRefresh();
        }

        // Ctrl/Cmd + E - —ç–∫—Å–ø–æ—Ä—Ç
        if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
          event.preventDefault();
          handleGlobalExport();
        }

        // Escape - –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        if (event.key === 'Escape') {
          if (showUserProfileModal.value) {
            closeUserProfileModal();
          } else if (showBulkActionsModal.value) {
            closeBulkActionsModal();
          } else if (showExportModal.value) {
            closeExportModal();
          }
        }
      };

      document.addEventListener('keydown', handleKeydown);

      return () => {
        document.removeEventListener('keydown', handleKeydown);
      };
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    let cleanupKeyboardShortcuts;

    onMounted(async () => {
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
      if (props.config.enableKeyboardShortcuts) {
        cleanupKeyboardShortcuts = setupKeyboardShortcuts();
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      try {
        if (props.initialUsers.length > 0) {
          state.users = props.initialUsers;
        }

        if (props.initialSelectedUser) {
          await selectUser(props.initialSelectedUser);
        }

        await nextTick();
      } catch (error) {
        console.error('[UnifiedUserManagement] Initialization error:', error);
        state.error = error.message;
      }
    });

    onUnmounted(() => {
      // –û—á–∏—Å—Ç–∫–∞
      if (cleanupKeyboardShortcuts) {
        cleanupKeyboardShortcuts();
      }

      if (notificationTimeout.value) {
        clearTimeout(notificationTimeout.value);
      }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    return {
      // –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      showUserProfileModal,
      showBulkActionsModal,
      showExportModal,
      modalUser,
      modalActivityData,
      exportDataType,
      notification,

      // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
      isLoading,
      loadingMessage,
      hasError,
      errorMessage,
      currentContext,
      selectedUser,
      selectedUsers,
      breadcrumbs,
      filters,
      userFilters,
      filteredUsers,
      pagination,
      globalMetrics,
      viewOptions,
      departments,
      activityTypes,
      filterPresets,
      activePreset,
      recentActivity,
      auditLog,
      isNavigating,
      bulkActions,
      userActivityData,

      // –ú–µ—Ç–æ–¥—ã
      handleUserSelect,
      handleUserSelectMultiple,
      handleFiltersChange,
      handlePaginationChange,
      handleViewOptionsChange,
      handleUserAction,
      handleBreadcrumbNavigate,
      handleGoBack,
      handleAdditionalAction,
      getAdditionalActions,
      handleViewProfile,
      handleEditPermissions,
      handleExportData,
      handleExportUserData,
      handleViewDetailedAnalysis,
      handlePermissionsChange,
      handleBulkUpdate,
      handleRefresh,
      handleGlobalExport,
      handleSettings,
      closeUserProfileModal,
      handleUserProfileSave,
      closeBulkActionsModal,
      handleBulkActionExecute,
      closeExportModal,
      handleExportExecute,
      handleSidebarToggle,
      handleMetricClick,
      handleFilterPresetApply,
      handleActivityClick,
      handleUserFilterChange,
      handleBulkAction,
      loadUserActivityData,
      retryLoading,
      showNotification,
      closeNotification
    };
  }
};
</script>

<style scoped>
.unified-user-management {
  position: relative;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--um-bg-primary, #ffffff);
  overflow: hidden;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.9);
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--um-border-color, #e0e0e0);
  border-top: 3px solid var(--um-primary, #2196f3);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-message {
  color: var(--um-text-secondary, #757575);
  font-size: 14px;
  text-align: center;
}

.error-state {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--um-bg-primary, #ffffff);
}

.error-content {
  text-align: center;
  max-width: 400px;
  padding: 32px;
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.error-title {
  margin: 0 0 8px 0;
  color: var(--um-text-primary, #212121);
  font-size: 20px;
  font-weight: 600;
}

.error-message {
  margin: 0 0 24px 0;
  color: var(--um-text-secondary, #757575);
  line-height: 1.5;
}

.error-retry-btn {
  padding: 10px 20px;
  border: 1px solid var(--um-primary, #2196f3);
  border-radius: 6px;
  background: var(--um-primary, #2196f3);
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.error-retry-btn:hover {
  background: #1976d2;
}

.management-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.management-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 0;
  overflow: hidden;
}

.main-content-area {
  padding: 24px;
  overflow-y: auto;
  background: var(--um-bg-primary, #ffffff);
}

.global-actions {
  position: fixed;
  bottom: 24px;
  right: 24px;
  display: flex;
  gap: 8px;
  z-index: 50;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  border: 1px solid var(--um-border-color, #e0e0e0);
  border-radius: 8px;
  background: var(--um-bg-primary, #ffffff);
  color: var(--um-text-primary, #212121);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.action-btn:hover:not(:disabled) {
  border-color: var(--um-primary, #2196f3);
  background: var(--um-hover, rgba(33, 150, 243, 0.1));
  color: var(--um-primary, #2196f3);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.action-btn.refresh:hover {
  border-color: var(--um-success, #4caf50);
  background: rgba(76, 175, 80, 0.1);
  color: var(--um-success, #4caf50);
}

.action-btn.export:hover {
  border-color: var(--um-info, #00bcd4);
  background: rgba(0, 188, 212, 0.1);
  color: var(--um-info, #00bcd4);
}

.action-btn.settings:hover {
  border-color: var(--um-secondary, #757575);
  background: rgba(117, 117, 117, 0.1);
  color: var(--um-secondary, #757575);
}

.action-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.notification-toast {
  position: fixed;
  top: 24px;
  right: 24px;
  max-width: 400px;
  z-index: 1000;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.notification-content {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  background: var(--um-bg-primary, #ffffff);
  border-left: 4px solid var(--um-primary, #2196f3);
}

.notification-toast.success .notification-content {
  border-left-color: var(--um-success, #4caf50);
}

.notification-toast.error .notification-content {
  border-left-color: var(--um-danger, #f44336);
}

.notification-icon {
  font-size: 18px;
  flex-shrink: 0;
  margin-top: 2px;
}

.notification-message {
  flex: 1;
  color: var(--um-text-primary, #212121);
  line-height: 1.4;
}

.notification-close {
  background: none;
  border: none;
  color: var(--um-text-secondary, #757575);
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.notification-close:hover {
  background: var(--um-hover, rgba(33, 150, 243, 0.1));
  color: var(--um-text-primary, #212121);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
  .management-grid {
    grid-template-columns: 280px 1fr;
  }
}

@media (max-width: 768px) {
  .unified-user-management {
    height: auto;
  }

  .management-grid {
    display: flex;
    flex-direction: column;
  }

  .main-content-area {
    padding: 16px;
  }

  .global-actions {
    position: static;
    margin-top: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .notification-toast {
    left: 16px;
    right: 16px;
    max-width: none;
  }
}

@media (max-width: 480px) {
  .main-content-area {
    padding: 12px;
  }

  .action-btn {
    padding: 8px 12px;
    font-size: 13px;
  }

  .global-actions {
    gap: 4px;
  }
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
@media (prefers-color-scheme: dark) {
  .unified-user-management {
    background: var(--um-bg-dark-primary, #1e1e1e);
  }

  .loading-overlay {
    background: rgba(30, 30, 30, 0.9);
  }

  .error-state {
    background: var(--um-bg-dark-primary, #1e1e1e);
  }

  .error-title {
    color: var(--um-text-dark-primary, #ffffff);
  }

  .error-message {
    color: var(--um-text-dark-secondary, #b0b0b0);
  }

  .main-content-area {
    background: var(--um-bg-dark-primary, #1e1e1e);
  }

  .action-btn {
    background: var(--um-bg-dark-primary, #2d2d2d);
    border-color: var(--um-border-dark-color, #424242);
    color: var(--um-text-dark-primary, #ffffff);
  }

  .notification-content {
    background: var(--um-bg-dark-primary, #2d2d2d);
    border-left-color: var(--um-primary, #2196f3);
  }

  .notification-message {
    color: var(--um-text-dark-primary, #ffffff);
  }

  .notification-close {
    color: var(--um-text-dark-secondary, #b0b0b0);
  }
}

/* –í—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç */
@media (prefers-contrast: high) {
  .action-btn {
    border-width: 2px;
  }

  .notification-content {
    border-width: 2px;
  }

  .error-retry-btn {
    border-width: 2px;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .loading-spinner {
    animation: none;
  }

  .action-btn {
    transition: none;
  }

  .notification-toast {
    animation: none;
  }
}
</style>