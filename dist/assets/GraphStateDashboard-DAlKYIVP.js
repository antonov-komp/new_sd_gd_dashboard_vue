const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ticketListUtils-BWDAFYrG.js","assets/index-BRm7kaI_.js","assets/main-CNUoupqr.js","assets/main-hkNOQW78.css","assets/index-Bxxce_5E.css","assets/index-ndgs3vxo.js"])))=>i.map(i=>d[i]);
import{_ as Ie,a as I,o as E,b as i,F as ue,e as de,n as oe,l as me,t as x,g as N,c as te,G as Ue,m as Oe,f as Ae,d as Z,j as re,k as Te,H as qe,i as ne,B as Je,T as At,I as Ot,u as Ze,J as Be,K as Qe,p as tt,L as rt,x as Ut,M as zt,N as Pt,C as Lt,O as lt,D as Kt,P as Vt,Q as Gt,y as at,R as je,z as Yt,r as qt}from"./main-CNUoupqr.js";import{L as It,D as Xt,B as Jt}from"./index-ndgs3vxo.js";import{S as it,d as ct,K as Zt,D as $t,B as pt,m as Mt,e as st,f as fe,h as Nt,j as Qt,T as Rt,k as ea,l as Ft}from"./index-BRm7kaI_.js";const Ee={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Ce{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new He("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new He("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const s=this.validateSectorData(t);if(!s.isValid)throw new He(`Ошибка валидации данных сектора: ${s.errors.join(", ")}`,"VALIDATION_ERROR",{validation:s});const n=this.normalizeSectorData(t),c={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||Ee.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},o=this.validateSnapshot(c);if(!o.isValid)throw new He(`Ошибка валидации слепка: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",o.warnings);const u=this.getApiBaseUrl(),f=await fetch(`${u}${Ee.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:e,date:this.formatDate(new Date)})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const p=await f.json();if(!p.success)throw new Error(p.message||"Ошибка создания слепка");return p.data.snapshot}catch(s){throw console.error("SnapshotService.createSnapshot error:",s),s instanceof He?s:new He(`Ошибка создания слепка: ${s.message}`,"API_ERROR",{originalError:s})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,l=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ee.defaultSectorId);const s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?${e.toString()}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка получения списка слепков");return(await Promise.all(l.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(u){return console.warn(`Ошибка загрузки слепка ${o.date}/${o.type}:`,u),null}}))).filter(o=>o!==null).sort((o,u)=>new Date(o.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:s={}}=t,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},l=[],c=[],o=[];e.forEach(p=>{const d=p.id;if(n[d]){let g=0;p.employees.forEach(D=>{const k=D.tickets||[];g+=k.length;let w=l.find(S=>S.id===D.id);w||(w={id:D.id,name:D.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(w)),k.forEach(S=>{c.push(S.id),o.push({id:S.id,title:S.title||"Без названия",assignedTo:{id:D.id,name:D.name},createdAt:S.createdAt||"",updatedAt:S.modifiedAt||S.updatedAt||""}),w.ticketsByStage[d]=(w.ticketsByStage[d]||0)+1,w.totalTickets+=1})}),n[d].count=g}});const u={unassigned:0,keeper:0,total:0};Object.values(s).forEach(p=>{Array.isArray(p)&&p.forEach(d=>{u.total+=1,d.assigneeId===1051||d.assignedById===1051?u.keeper+=1:u.unassigned+=1,c.push(d.id),o.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const f=Object.values(n).reduce((p,d)=>p+d.count,0)+u.total;return{statistics:{stages:{...n,total:f},employees:l,zeroPoint:u},ticketIds:[...new Set(c)],tickets:o}}static generateSnapshotMetadata(t,e,a){const s=new Date,n=-s.getTimezoneOffset(),l=Math.floor(n/60),c=n%60,o=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`,u=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${o}`;return{version:Ee.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${s}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,s=a.getFullYear(),n=this.getWeekNumber(a),l=this.formatDate(t);let c;if(e==="current"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`current-state-${l}-${u}.json`}else if(e==="manual"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`manual-${l}-${u}.json`}else c=`${e}-${l}.json`;return e==="current"?`current/${c}`:`${s}/week-${n}/${c}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const s=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-s)/864e5+1)/7)}static validateSnapshot(t){var s,n,l;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const c=t.statistics.stages,o=(((s=c.formed)==null?void 0:s.count)||0)+(((n=c.review)==null?void 0:n.count)||0)+(((l=c.execution)==null?void 0:l.count)||0);c.total!==o&&a.push(`Несоответствие общего количества тикетов: ожидается ${o}, указано ${c.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const c=t.statistics.zeroPoint,o=(c.unassigned||0)+(c.keeper||0);c.total!==o&&a.push(`Несоответствие статистики нулевой точки: ожидается ${o}, указано ${c.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const c=new Set(t.ticketIds),o=new Set(t.tickets.map(u=>u.id));c.size!==o.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((u,f)=>{u.id||e.push(`Тикет #${f}: отсутствует ID`),u.title||e.push(`Тикет #${f}: отсутствует заголовок`),(!u.assignedTo||!u.assignedTo.id)&&a.push(`Тикет #${f}: отсутствует ответственный (может быть в нулевой точке)`),u.createdAt||e.push(`Тикет #${f}: отсутствует дата создания`),u.updatedAt||e.push(`Тикет #${f}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}`,l=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const s of e)try{await this.deleteSnapshot(s.metadata.createdAt.split("T")[0],s.metadata.type)&&a++}catch(n){console.warn(`Ошибка удаления слепка ${s.metadata.createdAt}:`,n)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ee.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,s=(e.getDay()||7)-1,n=new Date(e);return n.setDate(e.getDate()-s),n.setHours(0,0,0,0),n}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,s=7-(e.getDay()||7),n=new Date(e);return n.setDate(e.getDate()+s),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),s=this.getWeekNumberInfo(t),n=await this.getAllSnapshots({startDate:e,endDate:a}),l=n.find(u=>u.metadata.type==="week_start")||null,c=n.find(u=>u.metadata.type==="week_end")||null,o=n.filter(u=>u.metadata.type==="manual");return{weekStart:l,weekEnd:c,manual:o,weekInfo:s}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof He)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},s=new Map;let n=null,l=null;e.forEach(o=>{const u=o.metadata.type;a.hasOwnProperty(u)&&a[u]++;const f=this.getWeekNumberInfo(o.metadata.createdAt),p=`${f.year}-W${f.week}`;s.set(p,(s.get(p)||0)+1);const d=new Date(o.metadata.createdAt);(!n||d<new Date(n.metadata.createdAt))&&(n=o),(!l||d>new Date(l.metadata.createdAt))&&(l=o)});const c=Array.from(s.entries()).map(([o,u])=>{const[f,p]=o.split("-W");return{year:parseInt(f),week:parseInt(p),count:u}}).sort((o,u)=>o.year!==u.year?o.year-u.year:o.week-u.week);return{total:e.length,byType:a,byWeek:c,oldest:n,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class He extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const _e={formed:{bitrixId:ct.formed,name:it.FORMED.name},review:{bitrixId:ct.review,name:it.REVIEW.name},execution:{bitrixId:ct.execution,name:it.EXECUTION.name}},Xe=Zt;function ta(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=aa(r.stages),e=sa(r.stages),a=na(r.zeroPointTickets||{}),s=oa(r.zeroPointTickets||{}),n=la(r.stages,r.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:s},ticketIds:n.ticketIds,tickets:n.tickets}}function aa(r){const t={formed:{count:0,stageId:_e.formed.bitrixId,stageName:_e.formed.name},review:{count:0,stageId:_e.review.bitrixId,stageName:_e.review.name},execution:{count:0,stageId:_e.execution.bitrixId,stageName:_e.execution.name},total:0};return r.forEach(e=>{if(!_e[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(s=>{s.tickets&&Array.isArray(s.tickets)&&(a+=s.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function sa(r){const t=new Map;return r.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const s=t.get(a.id),n=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;_e[e.id]&&(s.ticketsByStage[e.id]=(s.ticketsByStage[e.id]||0)+n),s.totalTickets+=n})}),Array.from(t.values())}function na(r){let t=0,e=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t++:(typeof n=="object"?n.id:n)===Xe?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function oa(r){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(t).forEach(e=>{const a=r[e];Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t[e].unassigned++:(typeof n=="object"?n.id:n)===Xe?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function la(r,t){const e=new Set,a=new Map;return Array.isArray(r)&&r.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const c=parseInt(l.id);if(isNaN(c)){console.warn("Invalid ticket ID:",l.id);return}e.add(c);let o=l.assignedTo;!o&&n.id&&(o={id:n.id,name:n.name||`Сотрудник #${n.id}`}),a.set(c,{id:c,title:l.title||"Без названия",assignedTo:o||null,createdAt:et(l.createdAt||l.createdTime),updatedAt:et(l.updatedAt||l.modifiedAt||l.updatedTime),stageId:l.stageId||s.id||null,departmentHead:l.departmentHead||null,departmentHeadFull:l.departmentHeadFull||l.departmentHead||null,priorityId:l.priorityId||null,priorityLabel:l.priorityLabel||null,service:l.service||null,serviceLabel:l.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",n.id);return}e.add(l);let c=n.assignedTo;if(!c&&n.assignedById){const o=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;o&&o!==Xe?c={id:o,name:"Неизвестный"}:o===Xe&&(c={id:Xe,name:"Хранитель объектов"})}a.set(l,{id:l,title:n.title||"Без названия",assignedTo:c||null,createdAt:et(n.createdAt||n.createdTime),updatedAt:et(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((s,n)=>s-n),tickets:Array.from(a.values())}}function et(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const t=new Date(r);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",r),null}class gt{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:s=!0,includeTicketDetails:n=!1}=t;try{const l=await $t.getSectorData(e,a);return s?ta(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await $t.getSectorData(!0);return t!=null}catch{return!1}}}class ut{static compareTwoSnapshots(t,e,a={}){const{includeTickets:s=!1,includeEmployees:n=!0}=a,l=this.validateSnapshot(t),c=this.validateSnapshot(e);if(!l.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...c.errors].join(", "));const o=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),f=n?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],p=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=s?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,g=this.buildSummary(u,f,p,d);return{metadata:o,stages:u,employees:f,zeroPoint:p,tickets:d,summary:g}}static calculateDelta(t,e){const a=this.normalizeValue(t),s=this.normalizeValue(e),n=s-a;let l=0;a!==0?l=n/a*100:s!==0&&(l=s>0?1/0:-1/0);const c=this.getTrend(n);return{value1:a,value2:s,delta:n,deltaPercent:Math.round(l*100)/100,trend:c}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var c,o;const a=["formed","review","execution"],s={};for(const u of a){const f=((c=t[u])==null?void 0:c.count)||0,p=((o=e[u])==null?void 0:o.count)||0;s[u]=this.calculateDelta(f,p)}const n=t.total||0,l=e.total||0;return s.total=this.calculateDelta(n,l),s}static compareEmployees(t,e){var c,o;const a=new Map(t.map(u=>[u.id,u])),s=new Map(e.map(u=>[u.id,u])),n=new Set([...a.keys(),...s.keys()]),l=[];for(const u of n){const f=a.get(u)||null,p=s.get(u)||null;if(!f||!p){l.push({id:u,name:(f==null?void 0:f.name)||(p==null?void 0:p.name)||"Неизвестный",snapshot1:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,snapshot2:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,delta:this.calculateEmployeeDelta(f,p),trend:f?"removed":"new"});continue}const d={},g=["formed","review","execution"];for(const k of g){const w=((c=f.ticketsByStage)==null?void 0:c[k])||0,S=((o=p.ticketsByStage)==null?void 0:o[k])||0;d[k]=this.calculateDelta(w,S)}const D=this.calculateDelta(f.totalTickets||0,p.totalTickets||0);l.push({id:u,name:f.name,snapshot1:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},snapshot2:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},delta:{ticketsByStage:d,totalTickets:D},trend:D.trend})}return l}static calculateEmployeeDelta(t,e){var l,c;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},s=["formed","review","execution"];for(const o of s){const u=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[o])||0,f=((c=e==null?void 0:e.ticketsByStage)==null?void 0:c[o])||0;a[o]=this.calculateDelta(u,f)}const n=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:n}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,s){var g,D;const n=new Set(t),l=new Set(e),c=e.filter(k=>!n.has(k)),o=t.filter(k=>!l.has(k)),u=[],f=[],p=new Map(a.map(k=>[k.id,k])),d=new Map(s.map(k=>[k.id,k]));for(const k of t){if(!l.has(k))continue;const w=p.get(k),S=d.get(k);if(!w||!S)continue;const T=(((g=w.assignedTo)==null?void 0:g.id)||null)!==(((D=S.assignedTo)==null?void 0:D.id)||null),z=(w.stageId||null)!==(S.stageId||null);T||z?u.push(k):f.push(k)}return{new:c,removed:o,changed:u,unchanged:f}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),s=new Date(e.metadata.createdAt),n=new Date,l=s.getTime()-a.getTime(),c=Math.floor(l/(1e3*60*60*24)),o=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:n.toISOString(),timeDiff:{days:c,hours:o,minutes:u,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,a,s){var u,f,p;const n=t.total.delta,l=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,c=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,o=n!==0||l>0||c>0;return{totalDelta:n,stagesChanged:l,employeesChanged:c,hasChanges:o,newTicketsCount:((u=s==null?void 0:s.new)==null?void 0:u.length)||0,removedTicketsCount:((f=s==null?void 0:s.removed)==null?void 0:f.length)||0,changedTicketsCount:((p=s==null?void 0:s.changed)==null?void 0:p.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const s=["formed","review","execution"];for(const n of s)t.statistics.stages[n]||a.push(`Missing stage: ${n}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const c=this.validateSnapshot(l);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...t].sort((l,c)=>{const o=new Date(l.metadata.createdAt),u=new Date(c.metadata.createdAt);return o-u}),s=[];for(let l=0;l<a.length-1;l++)s.push({from:l,to:l+1,result:this.compareTwoSnapshots(a[l],a[l+1],e)});const n=this.buildTrends(a);return{snapshots:a.map((l,c)=>({index:c,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:s,trends:n}}static buildTrends(t){var a,s,n,l,c,o,u,f,p,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const g of t){const D=g.statistics;e.stages.formed.push(((s=(a=D.stages)==null?void 0:a.formed)==null?void 0:s.count)||0),e.stages.review.push(((l=(n=D.stages)==null?void 0:n.review)==null?void 0:l.count)||0),e.stages.execution.push(((o=(c=D.stages)==null?void 0:c.execution)==null?void 0:o.count)||0),e.stages.total.push(((u=D.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((f=D.zeroPoint)==null?void 0:f.unassigned)||0),e.zeroPoint.keeper.push(((p=D.zeroPoint)==null?void 0:p.keeper)||0),e.zeroPoint.total.push(((d=D.zeroPoint)==null?void 0:d.total)||0)}return e}}const ra={class:"stages-container"},ia={class:"stages-chips"},ca=["checked","disabled","onChange"],ua={class:"stage-chip-label"},da={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:r=>r.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t;function s(n,l){const c={...e.selected};c[n]=l,a("update:selected",c),a("change",n,l)}return(n,l)=>(E(),I("div",ra,[l[0]||(l[0]=i("h4",{class:"stages-title"},"Этапы для отображения:",-1)),i("div",ia,[(E(!0),I(ue,null,de(r.stages,c=>(E(),I("label",{key:c.id,class:oe(["stage-chip",{"stage-chip--active":r.selected[c.id],"stage-chip--disabled":r.disabled}])},[i("input",{type:"checkbox",checked:r.selected[c.id],disabled:r.disabled,onChange:o=>s(c.id,o.target.checked)},null,40,ca),i("span",{class:"stage-chip-color",style:me({backgroundColor:c.color})},null,4),i("span",ua,x(c.name),1)],2))),128))])]))}},pa=Ie(da,[["__scopeId","data-v-fe03c03c"]]),dt=140,We=new Map;class Bt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await pt.call("crm.item.list",{entityTypeId:dt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let a=[];if(e&&e.result&&(Array.isArray(e.result)?a=e.result:e.result.items&&Array.isArray(e.result.items)?a=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(a=e.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const s=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s),ticketSample:JSON.stringify(s).substring(0,500)});const n=Mt(s),l=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:n.departmentHead,departmentHeadFull:l?String(l).trim():null});let c=null;if(l){const o=String(l).trim();o.length>0&&(c=o)}return{...n,departmentHeadFull:c}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(s=>{We.has(s)?e.push(We.get(s)):a.push(s)}),a.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:dt});const s=await pt.call("crm.item.list",{entityTypeId:dt,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!s,resultType:typeof s,resultKeys:s?Object.keys(s):[],hasResultResult:!!(s!=null&&s.result),resultResultType:typeof(s==null?void 0:s.result),isArray:Array.isArray(s==null?void 0:s.result),resultResultLength:Array.isArray(s==null?void 0:s.result)?s.result.length:"not array",fullResult:s});let n=[];if(s&&s.result&&(Array.isArray(s.result)?n=s.result:s.result.items&&Array.isArray(s.result.items)?n=s.result.items:s.result.data&&Array.isArray(s.result.data)&&(n=s.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!s,hasResultResult:!!(s!=null&&s.result),resultType:typeof(s==null?void 0:s.result),result:s,resultKeys:s?Object.keys(s):[]}),e;const l=n.map((c,o)=>{o===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const u=Mt(c);o===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:u.id,hasDepartmentHead:!!u.departmentHead,departmentHead:u.departmentHead,mappedTicketKeys:Object.keys(u).filter(g=>g.toLowerCase().includes("department"))});const f=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;o===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:f,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm"))});let p=null;if(f){const g=String(f).trim();g.length>0&&(p=g)}!p&&u.departmentHead&&(p=u.departmentHead);const d={...u,departmentHeadFull:p||u.departmentHead||null};return o===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&We.set(d.id,d),d});return[...e,...l]}catch(s){return console.error("[TicketDetailsService] Error loading tickets details batch:",s),console.error("[TicketDetailsService] Error details:",{message:s.message,stack:s.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){We.size>t&&We.clear()}static getCacheSize(){return We.size}}async function ga(r,t,e,a=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:r,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!r||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const s=e.tickets.filter(f=>{const p=f.assignedTo;return p?(typeof p=="object"?p.id:p)===r:!1});if(s.length===0)return[];const n=!s[0].stageId||!s[0].departmentHead;let l=null;if(n){const f=s.map(p=>p.id);if(a&&typeof a=="object")l=a;else try{const p=await Bt.getTicketsDetails(f);l=new Map,p.forEach(d=>{d&&d.id&&l.set(d.id,d)})}catch(p){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",p),l=null}}return s.map(f=>{const p=f.id,d={id:p,title:f.title||"Без названия",assignedTo:f.assignedTo,createdAt:f.createdAt,updatedAt:f.updatedAt};if(l){const g=l instanceof Map?l.get(p):l[p];g?(d.stageId=g.stageId||null,d.departmentHead=g.departmentHead||null,d.departmentHeadFull=g.departmentHeadFull||g.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=f.stageId||null,d.departmentHead=f.departmentHead||null,d.departmentHeadFull=f.departmentHeadFull||f.departmentHead||null;return d}).filter(f=>f.stageId?st(f.stageId)===t:!0)}function xt(r,t=new Date){if(!r||r.length===0)return[];const e=r.length,a={};return Object.values(fe).forEach(n=>{a[n]={category:n,label:Nt[n].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:Nt[n].color}}),r.forEach(n=>{if(!n.createdAt){a[fe.MORE_THAN_YEAR].count++,a[fe.MORE_THAN_YEAR].tickets.push(n);return}const l=Qt(n.createdAt,t);a[l]&&(a[l].count++,a[l].tickets.push(n))}),Object.values(a).filter(n=>n.count>0).map(n=>{const l=e>0?parseFloat((n.count/e*100).toFixed(1)):0;return{...n,percentage:l,progressBarWidth:l}}).sort((n,l)=>{const c=[fe.TODAY,fe.YESTERDAY,fe.THIS_WEEK,fe.LAST_WEEK,fe.MORE_THAN_TWO_WEEKS,fe.UP_TO_ONE_MONTH,fe.MORE_THAN_TWO_MONTHS,fe.MORE_THAN_HALF_YEAR,fe.MORE_THAN_YEAR];return c.indexOf(n.category)-c.indexOf(l.category)})}function fa(r){if(!r||r.length===0)return[];const t={};r.forEach(a=>{let s=a.departmentHeadFull||a.departmentHead;r.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(n=>n.toLowerCase().includes("department"))}),s?(s=String(s).trim(),s.length===0&&(s="Без заказчика")):s="Без заказчика",t[s]||(t[s]={departmentName:s,count:0}),t[s].count++});const e=Object.values(t);return e.sort((a,s)=>s.count!==a.count?s.count-a.count:a.departmentName.localeCompare(s.departmentName,"ru")),e}const ze=10;function nt(r,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(s=>s.ticketsByStage&&s.ticketsByStage[r]>0).forEach(s=>{e.push({id:s.id,name:s.name,count:s.ticketsByStage[r]||0})});const a=ma(r,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((s,n)=>n.count-s.count)}function ma(r,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[r])return t.statistics.zeroPointByStage[r].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function jt(r,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[r])==null?void 0:e.count)||0}function ot(r,t=ze){if(!r||r.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...r].sort((l,c)=>c.count-l.count),a=e.slice(0,t),s=e.slice(t),n=s.reduce((l,c)=>l+c.count,0);return{visible:a,others:{employees:s,count:n,employeeCount:s.length}}}function Wt(r,t){return!r||r.length===0?[]:t===0?r.map(e=>({...e,percentage:0})):r.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Ke(r,t,e="#007bff",a=ze){if(!r||r.length===0)return{employees:[],others:null};const{visible:s,others:n}=ot(r,a),l=Wt(s,t).map(o=>({...o,progressBarWidth:o.percentage,progressBarColor:o.isKeeper?"#f59e0b":e}));let c=null;if(n.count>0){const o=parseFloat((n.count/t*100).toFixed(1));c={...n,percentage:o,progressBarWidth:o,progressBarColor:"#6c757d"}}return{employees:l,others:c}}function ha(r,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(s=>{const n=t[s];if(!n)return;const l=nt(r,n),c=jt(r,n);if(l.length===0)return;const{visible:o,others:u}=ot(l,ze),f=Wt(o,c);e[s]=f,u.count>0&&(e.others[s]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/c*100).toFixed(1))})}),e}function va(r,t="current",e=[]){const a=r[t];if(!a)return{labels:[],datasets:[]};const s=new Map;e.forEach(p=>{nt(p.id,a).forEach(g=>{s.has(g.id)||s.set(g.id,{id:g.id,name:g.name,isKeeper:g.isKeeper||!1,ticketsByStage:{}}),s.get(g.id).ticketsByStage[p.id]=g.count})});const n=Array.from(s.values()).map(p=>{const d=Object.values(p.ticketsByStage).reduce((g,D)=>g+D,0);return{...p,totalTickets:d}});n.sort((p,d)=>d.totalTickets-p.totalTickets);const{visible:l,others:c}=ot(n,ze),o=e.map(()=>""),u={};e.forEach(p=>{const d=nt(p.id,a),{visible:g}=ot(d,ze);u[p.id]=g.map(D=>({id:D.id,name:D.name,count:D.count}))});const f=l.map((p,d)=>{const g=e.map(k=>p.ticketsByStage[k.id]||0),D=e.map(k=>{if((p.ticketsByStage[k.id]||0)===0)return"transparent";const T=k.color.replace("#",""),z=parseInt(T.substring(0,2),16),Q=parseInt(T.substring(2,4),16),ae=parseInt(T.substring(4,6),16),L=.6+d*.05;return`rgba(${z}, ${Q}, ${ae}, ${Math.min(L,.95)})`});return{label:p.name,data:g,backgroundColor:D,borderColor:e.map(k=>{const w=k.color.replace("#",""),S=parseInt(w.substring(0,2),16),T=parseInt(w.substring(2,4),16),z=parseInt(w.substring(4,6),16);return`rgba(${S}, ${T}, ${z}, 0.8)`}),borderWidth:1,meta:{employeeId:p.id,employeeName:p.name}}});if(c.count>0){const p=e.map(d=>c.employees.reduce((g,D)=>g+(D.ticketsByStage[d.id]||0),0));f.push({label:`Другие (${c.employeeCount})`,data:p,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:o,datasets:f,meta:{employeesByStage:u}}}function ya(r,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(u=>u.id===r),s=a?a.name:"",n=a?a.color:"#007bff",l=nt(r,t),c=jt(r,t);if(l.length===0)return{stageName:s,totalCount:0,employees:[],others:null};const o=Ke(l,c,n,ze);return{stageName:s,totalCount:c,employees:o.employees,others:o.others}}function ka(r,t){return(t==null?void 0:t[r])||r}function wa(r,t){return(t==null?void 0:t[r])||"#007bff"}function ft({snapshots:r,graphType:t,timePoint:e,snapshotType:a}){return r?t==="line"&&e?r[e]||null:t==="bar"&&a?r[a]||null:r.current||r.weekEnd||r.weekStart||null:null}function mt(r,t){var e,a,s;return((s=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[r])==null?void 0:s.count)||0}function ba({stageId:r,timePoint:t,meta:e,snapshots:a,stageColor:s,maxVisible:n}){if(!(e!=null&&e.employees)||!t)return null;const l=e.employees[t];if(!l||l.length===0)return null;const c=(a==null?void 0:a[t])||null,o=mt(r,c)||l.reduce((f,p)=>f+(p.count||0),0),u=Ke(l,o,s,n);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}function Sa({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s}){var u;const n=(u=t==null?void 0:t.employees)==null?void 0:u[r];if(!n||!n.employees||n.employees.length===0)return null;const l=ft({snapshots:e,graphType:"doughnut"}),c=n.totalCount??mt(r,l)??n.employees.reduce((f,p)=>f+(p.count||0),0),o=Ke(n.employees,c,a,s);return{stageId:r,totalCount:c,employees:o.employees,others:o.others,snapshot:l}}function Da({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s,snapshotType:n}){var f;const l=(f=t==null?void 0:t.employeesByStage)==null?void 0:f[r];if(!l||l.length===0)return null;const c=ft({snapshots:e,graphType:"bar",snapshotType:n}),o=mt(r,c)||l.reduce((p,d)=>p+(d.count||0),0),u=Ke(l,o,a,s);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}async function Ea({stageId:r,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:s=null,meta:n=null,stageColorMap:l=null,stageNameMap:c=null,maxVisible:o=10,restLoader:u=null}){if(!r)throw new Error("stageId обязателен для загрузки данных уровня 1");const f=ka(r,c),p=wa(r,l);let d=null;if(t==="line"?d=ba({stageId:r,timePoint:e,meta:n==null?void 0:n.line,snapshots:s,stageColor:p,maxVisible:o}):t==="doughnut"?d=Sa({stageId:r,meta:n==null?void 0:n.doughnut,snapshots:s,stageColor:p,maxVisible:o}):t==="bar"&&(d=Da({stageId:r,meta:n==null?void 0:n.bar,snapshots:s,stageColor:p,maxVisible:o,snapshotType:a})),d)return{stageId:r,stageName:f,color:p,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot};if(typeof u=="function"){const g=await u({stageId:r,graphType:t,timePoint:e,snapshotType:a,snapshots:s});if(g&&Array.isArray(g.employees)){const D=g.totalCount??g.employees.reduce((w,S)=>w+(S.count||0),0),k=Ke(g.employees,D,p,o);return{stageId:r,stageName:f,color:p,totalCount:D,employees:k.employees,others:k.others,snapshot:g.snapshot||ft({snapshots:s,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const _a={key:"level-1",class:"level-1"},Ca={class:"modal-header"},Ta={class:"stage-header"},Aa=["aria-expanded","onKeydown"],Ia={class:"stage-title"},$a=["aria-selected","onClick","onKeydown"],Ma={class:"stage-name"},Na={class:"modal-total"},Ra={class:"view-switcher"},Fa={class:"modal-body"},xa={key:0,class:"load-error"},Ha={key:1,class:"stage-loader"},Oa={key:2},Pa={key:0,class:"no-employees"},La={key:1,class:"employees-list"},Ba=["onClick"],ja={class:"employee-name"},Wa={class:"employee-progress"},Ua={class:"employee-count"},za={key:0,class:"employee-item employee-others"},Ka={class:"employee-name"},Va={class:"employee-progress"},Ga={class:"employee-count"},Ya={key:3,class:"view-time"},qa={key:0,class:"no-data"},Xa={key:1,class:"date-categories-list"},Ja=["onClick"],Za={class:"category-label"},Qa={class:"category-progress"},es={class:"category-count"},ts={key:4,class:"view-departments"},as={key:0,class:"no-data"},ss={key:1,class:"departments-table-container"},ns={class:"departments-table"},os=["onClick"],ls={class:"col-department"},rs={class:"department-name"},is={class:"col-count"},cs={class:"count-value"},us={key:"level-2",class:"level-2"},ds={class:"modal-header"},ps={class:"modal-total"},gs={class:"modal-body"},fs={class:"stage-info"},ms={class:"stage-badge"},hs={key:0,class:"no-data"},vs={key:1,class:"date-categories-list"},ys=["onClick"],ks={class:"category-label"},ws={class:"category-progress"},bs={class:"category-count"},Ss={key:"level-3",class:"level-3"},Ds={class:"modal-header"},Es={class:"header-info"},_s={class:"header-badges"},Cs={class:"date-badge"},Ts={class:"stage-badge"},As={class:"modal-total"},Is={class:"modal-body"},$s={key:0,class:"no-data"},Ms={key:1,class:"departments-table-container"},Ns={class:"departments-table"},Rs=["onClick"],Fs={class:"col-department"},xs={class:"department-name"},Hs={class:"col-count"},Os={class:"count-value"},Ps={key:"level-4",class:"level-4"},Ls={class:"modal-header"},Bs={class:"header-info"},js={key:0,class:"header-badges"},Ws={key:0,class:"date-badge"},Us={key:1,class:"department-badge"},zs={class:"stage-badge"},Ks={class:"modal-total"},Vs={class:"modal-body"},Gs={key:"loading",class:"loading-state"},Ys={key:"error-fallback",class:"error-state-with-fallback"},qs={class:"tickets-list-container"},Xs={key:"error",class:"error-state"},Js={class:"error-message"},Zs={key:"empty",class:"empty-state"},Qs={class:"empty-state-title"},en={class:"empty-state-message"},tn={key:"tickets",class:"tickets-list-container"},an={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(r,{expose:t,emit:e}){const a=r,s=e,n=Ze(),l=N(1),c=N("employees"),o=N(null),u=N([]),f=N([]),p=N(null),d=N(null),g=N(null),D=N(a.stageSwitchContext||null),k=N(!1),w=N(null),S=N(null),T=N(!1),z=N(null),Q=N(null),ae=te(()=>{var y,M;const m=((y=D.value)==null?void 0:y.stageNameMap)||{},b=((M=D.value)==null?void 0:M.stageColorMap)||{};return Object.keys(m).map(K=>{var U;return{id:K,name:m[K],color:b[K]||"#007bff",disabled:K===(((U=o.value)==null?void 0:U.stageId)||a.stageId)}})});te(()=>l.value>1);const L=te(()=>{var m,b,y,M,K;switch(l.value){case 1:return((m=o.value)==null?void 0:m.stageName)||a.stageName;case 2:return((b=p.value)==null?void 0:b.employeeName)||"";case 3:return`${((y=p.value)==null?void 0:y.employeeName)||""} — ${((M=d.value)==null?void 0:M.dateCategoryLabel)||""}`;case 4:if(!((K=g.value)!=null&&K.context))return"Список тикетов";const U=g.value.context,se=[];return U.employeeName&&se.push(U.employeeName),U.dateCategoryLabel&&se.push(U.dateCategoryLabel),U.departmentName&&se.push(U.departmentName),U.stageName&&se.push(U.stageName),se.length>0?se.join(" — "):"Список тикетов";default:return""}});function O(){var m,b,y;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((m=a.employees)==null?void 0:m.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((y=(b=a.snapshot)==null?void 0:b.ticketIds)==null?void 0:y.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",q(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function q(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const m=o.value.snapshot.tickets||[],b=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:m.length,currentStageId:b,sampleTicket:m[0]?{id:m[0].id,stageId:m[0].stageId,hasDepartmentHead:!!m[0].departmentHead,departmentHead:m[0].departmentHead,hasDepartmentHeadFull:!!m[0].departmentHeadFull,departmentHeadFull:m[0].departmentHeadFull,allKeys:Object.keys(m[0])}:null});let y=m.filter(H=>H.stageId?st(H.stageId)===b:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:m.length,afterFilter:y.length,stageId:b,ticketsWithStageId:y.filter(H=>H.stageId).length,ticketsWithoutStageId:y.filter(H=>!H.stageId).length});const M=y.filter(H=>!H.departmentHead&&!H.departmentHeadFull);if(M.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:M.length,totalTickets:y.length,ticketsWithDepartment:y.filter(V=>V.departmentHead||V.departmentHeadFull).length});const H=M.map(V=>V.id).filter(V=>V);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:H.length,ticketIdsSample:H.slice(0,10)});const V=await Bt.getTicketsDetails(H),C=new Map;V.forEach(v=>{v&&v.id&&C.set(v.id,v)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:V.length,detailsMapSize:C.size,sampleDetail:V[0]?{id:V[0].id,departmentHead:V[0].departmentHead,departmentHeadFull:V[0].departmentHeadFull}:null}),y=y.map(v=>{const R=C.get(v.id);return R?{...v,stageId:R.stageId||v.stageId||null,departmentHead:R.departmentHead||v.departmentHead||null,departmentHeadFull:R.departmentHeadFull||R.departmentHead||v.departmentHead||null}:v}),y=y.filter(v=>v.stageId?st(v.stageId)===b:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:y.length,ticketsWithDepartment:y.filter(v=>v.departmentHead||v.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(v=>!v.departmentHead&&!v.departmentHeadFull).length,ticketsWithStageId:y.filter(v=>v.stageId).length,ticketsWithoutStageId:y.filter(v=>!v.stageId).length});const h=y.length,_=y.slice(0,3).map(v=>({id:v.id,departmentHead:v.departmentHead,departmentHeadFull:v.departmentHeadFull,stageId:v.stageId}));y=y.filter(v=>v.stageId?st(v.stageId)===b:!0);const $=y.slice(0,3).map(v=>({id:v.id,departmentHead:v.departmentHead,departmentHeadFull:v.departmentHeadFull,stageId:v.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:h,afterStageFilter:y.length,filteredOut:h-y.length,currentStageId:b,ticketsWithDepartment:y.filter(v=>v.departmentHead||v.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(v=>!v.departmentHead&&!v.departmentHeadFull).length,sampleBeforeFilter:_,sampleAfterFilter:$,sampleWithDepartment:y.find(v=>v.departmentHead||v.departmentHeadFull)?{id:y.find(v=>v.departmentHead||v.departmentHeadFull).id,departmentHead:y.find(v=>v.departmentHead||v.departmentHeadFull).departmentHead,departmentHeadFull:y.find(v=>v.departmentHead||v.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(y.find(v=>v.departmentHead||v.departmentHeadFull)).filter(v=>v.toLowerCase().includes("department"))}:null})}catch(V){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",V),console.error("[EmployeeDetailsModal] Error details:",{message:V.message,stack:V.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:y.length,currentStageId:b,ticketsWithStageId:y.filter(H=>H.stageId).length,ticketsWithoutStageId:y.filter(H=>!H.stageId).length,ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length});const K=xt(y);u.value=K,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:y.length,sampleTickets:y.slice(0,5).map(H=>({id:H.id,departmentHead:H.departmentHead,departmentHeadFull:H.departmentHeadFull,hasDepartmentHead:!!H.departmentHead,hasDepartmentHeadFull:!!H.departmentHeadFull,allKeys:Object.keys(H).filter(V=>V.toLowerCase().includes("department"))})),ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length});const U=fa(y);f.value=U;const se=K.reduce((H,V)=>H+V.count,0),ke=U.reduce((H,V)=>H+V.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:b,totalTicketsForGrouping:y.length,timeCategoriesCount:K.length,totalTicketsInTimeCategories:se,departmentsCount:U.length,totalTicketsInDepartments:ke,departmentsSample:U.slice(0,5),ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length,consistencyCheck:{totalTickets:y.length,timeCategoriesTotal:se,departmentsTotal:ke,isConsistent:y.length===se&&y.length===ke}})}catch(m){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",m),console.error("[EmployeeDetailsModal] Error stack:",m.stack)}}async function X(m){var y;if(!m){n.error("Не указан stageId для загрузки данных");return}if(((y=o.value)==null?void 0:y.stageId)===m)return;if(!D.value){n.error("Нет контекста для смены стадии (stageSwitchContext)");return}k.value=!0,w.value=null;const b=o.value?{...o.value}:null;S.value=(b==null?void 0:b.stageId)||null;try{const M=await Ea({...D.value,stageId:m});o.value={stageId:M.stageId,stageName:M.stageName,stageColor:M.color,totalCount:M.totalCount,employees:M.employees,others:M.others,snapshot:M.snapshot||(b==null?void 0:b.snapshot)||null,ticketDetails:M.ticketDetails||null},p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",await q()}catch(M){console.error("[EmployeeDetailsModal] Failed to reload stage data:",M),w.value=(M==null?void 0:M.message)||"Не удалось загрузить данные стадии",b&&(o.value=b),n.error(w.value)}finally{k.value=!1}}async function ie(m){if(!m||m.count===0){n.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!d.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),n.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:b}=await Be(async()=>{const{createContextFromLevel3:M}=await import("./ticketListUtils-BWDAFYrG.js");return{createContextFromLevel3:M}},__vite__mapDeps([0,1,2,3,4,5])),y=await b(d.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function ce(m){if(!m||m.count===0){n.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:b}=await Be(async()=>{const{createContextFromLevel1Department:M}=await import("./ticketListUtils-BWDAFYrG.js");return{createContextFromLevel1Department:M}},__vite__mapDeps([0,1,2,3,4,5])),y=b(o.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:y.stageName,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function $e(m){if(!m||m.count===0){n.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){n.info(`В категории "${m.label}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:b}=await Be(async()=>{const{createContextFromLevel1Time:M}=await import("./ticketListUtils-BWDAFYrG.js");return{createContextFromLevel1Time:M}},__vite__mapDeps([0,1,2,3,4,5])),y=b(o.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:y.stageName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}Ue(()=>a.isVisible,m=>{m?O():(Pe(),Y())}),Ue(()=>a.stageSwitchContext,m=>{D.value=m},{deep:!0}),Oe(()=>{a.isVisible&&O()});async function be(m,b=null){var y,M,K;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",m),console.log("[EmployeeDetailsModal] Current popup level:",l.value),b&&b.currentTarget&&(b.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{b.currentTarget&&(b.currentTarget.style.transform="")},150)),!m||!m.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",m);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),n.warning("ID стадии не указан");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),n.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",m.id,"stage:",o.value.stageId);const U=await ga(m.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(U==null?void 0:U.length)||0,U),!U||U.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),n.info(`У сотрудника "${m.name}" нет тикетов на стадии "${o.value.stageName}"`);return}const se=xt(U);console.log("[EmployeeDetailsModal] Date categories:",(se==null?void 0:se.length)||0,se),p.value={employeeId:m.id,employeeName:m.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:U.length,dateCategories:se,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),l.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",l.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(y=p.value)==null?void 0:y.employeeName,dateCategoriesCount:((K=(M=p.value)==null?void 0:M.dateCategories)==null?void 0:K.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",l.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(U){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",U),console.error("[EmployeeDetailsModal] Error stack:",U.stack),n.error("Ошибка загрузки данных о тикетах: "+U.message)}}async function Ve(m){if(!m||m.count===0){n.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){n.info(`В категории "${m.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),n.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:b}=await Be(async()=>{const{createContextFromLevel2:M}=await import("./ticketListUtils-BWDAFYrG.js");return{createContextFromLevel2:M}},__vite__mapDeps([0,1,2,3,4,5])),y=b(p.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function we(m){var b;if(console.time("[Performance] goToLevel4"),!m){console.error("[EmployeeDetailsModal] Context is required for level 4"),n.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:m.sourceLevel,employeeId:m.employeeId,stageId:m.stageId,dateCategory:m.dateCategory,departmentName:m.departmentName,ticketsCount:((b=m.tickets)==null?void 0:b.length)||0});try{g.value={context:m,tickets:[],totalCount:0,isLoading:!0,error:null};let y=m.tickets||[];if(y.length===0&&m.snapshot){const{filterTicketsByContext:K}=await Be(async()=>{const{filterTicketsByContext:U}=await import("./ticketListUtils-BWDAFYrG.js");return{filterTicketsByContext:U}},__vite__mapDeps([0,1,2,3,4,5]));y=await K(m)}(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),y=m.tickets||[]),(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),m.snapshot&&m.snapshot.tickets&&(y=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",y.length)));let M=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:K}=await Be(async()=>{const{prepareTicketsForDisplay:U}=await import("./ticketListUtils-BWDAFYrG.js");return{prepareTicketsForDisplay:U}},__vite__mapDeps([0,1,2,3,4,5]));M=await K(y,m.snapshot,m.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(K){console.error("[EmployeeDetailsModal] Error preparing tickets:",K),console.timeEnd("[Performance] prepareTicketsForDisplay"),M=y||[],n.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:y.length,preparedCount:M.length}),g.value={context:m,tickets:M,totalCount:M.length,isLoading:!1,error:null},l.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:g.value.totalCount,ticketsCount:g.value.tickets.length,isLoading:g.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",y),console.error("[EmployeeDetailsModal] Error details:",{message:y.message,stack:y.stack,context:m});let M=[];if(m.snapshot&&m.snapshot.tickets)try{const K=m.stageId;K?M=(m.snapshot.tickets||[]).filter(U=>U.stageId===K):M=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",M.length)}catch(K){console.error("[EmployeeDetailsModal] Error using fallback tickets:",K)}g.value={context:m,tickets:M,totalCount:M.length,isLoading:!1,error:{message:y.message,hasFallback:M.length>0}},M.length>0?(n.warning("Ошибка загрузки данных. Отображаются данные из кеша."),l.value=4):(n.error("Ошибка загрузки тикетов: "+y.message),he()),console.timeEnd("[Performance] goToLevel4")}}function he(){if(l.value===4){if(g.value&&g.value.context){const m=g.value.context.sourceLevel;l.value=m}else l.value=1;g.value=null}else l.value===3?(l.value=2,d.value=null,g.value=null):l.value===2&&(l.value=1,p.value=null,d.value=null,g.value=null)}function Pe(){l.value=1,o.value=null,p.value=null,d.value=null,g.value=null}function Se(){var K;if(!((K=g.value)!=null&&K.context))return"Нет тикетов";const{sourceLevel:m,employeeName:b,dateCategoryLabel:y,departmentName:M}=g.value.context;return m===2&&b&&y?`Нет тикетов у ${b} в категории "${y}"`:m===3&&b&&M?`Нет тикетов у ${b} у заказчика "${M}"`:m===1&&y?`Нет тикетов в категории "${y}"`:m===1&&M?`Нет тикетов у заказчика "${M}"`:"Нет тикетов для отображения"}function Le(){var b;if(!((b=g.value)!=null&&b.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:m}=g.value.context;return m?`На стадии "${m}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function Ge(){var b;if(!((b=g.value)!=null&&b.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const m=g.value.context;await we(m)}function Me(m){if(!m){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),n.warning("Ошибка: тикет не найден");return}if(!m.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",m),n.error("Ошибка: ID тикета не указан");return}try{const b=ea(m.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:m.id,iframeUrl:b}),!b||typeof b!="string"||b.length===0)throw new Error("Не удалось сформировать URL для тикета");const y=window.open(b,"_blank","noopener,noreferrer");if(!y||y.closed||typeof y.closed>"u")try{const M=document.createElement("a");M.href=b,M.target="_blank",M.rel="noopener noreferrer",M.style.display="none",document.body.appendChild(M),M.click(),document.body.removeChild(M),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:m.id,iframeUrl:b})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:m.id,iframeUrl:b})}catch(b){console.error("[EmployeeDetailsModal] Error opening ticket:",b),console.error("[EmployeeDetailsModal] Error details:",{message:b.message,stack:b.stack,ticket:m}),n.error("Ошибка открытия тикета: "+b.message)}}function ve(){Pe(),s("close")}t({reloadLevel1ForStage:X});function P(m){m&&m.stopPropagation(),T.value=!T.value}function Y(){T.value&&(T.value=!1)}function ye(m){if(!T.value)return;const b=z.value,y=Q.value;b&&b.contains(m.target)||y&&y.contains(m.target)||(T.value=!1)}async function Ne(m){if(m.disabled){T.value=!1;return}T.value=!1,await X(m.id)}function pe(m){if(T.value){m.stopPropagation(),Y();return}ve()}return(m,b)=>(E(),Ae(Ot,{to:"body"},[r.isVisible?(E(),I("div",{key:0,class:"employee-details-modal",onClick:ne(ve,["self"]),onKeydown:qe(pe,["esc"])},[i("div",{class:"modal-content",onClick:ye},[re(Je,{name:"level",mode:"out-in"},{default:Te(()=>{var y,M,K,U,se,ke,H,V,C,h,_,$,v,R,F,G,j,B,J;return[l.value===1?(E(),I("div",_a,[i("div",Ca,[i("div",Ta,[i("button",{ref_key:"stageTriggerRef",ref:Q,class:"stage-trigger","aria-expanded":T.value,"aria-haspopup":"listbox",onClick:ne(P,["stop"]),onKeydown:[qe(ne(P,["prevent"]),["enter"]),qe(ne(P,["prevent"]),["space"]),qe(ne(Y,["stop","prevent"]),["esc"])]},[i("span",{class:"stage-color",style:me({backgroundColor:((y=o.value)==null?void 0:y.stageColor)||((U=(M=D.value)==null?void 0:M.stageColorMap)==null?void 0:U[(K=o.value)==null?void 0:K.stageId])||((ke=(se=D.value)==null?void 0:se.stageColorMap)==null?void 0:ke[r.stageId])||"#007bff"})},null,4),i("span",Ia,x(((H=o.value)==null?void 0:H.stageName)||r.stageName),1),i("span",{class:oe(["stage-caret",{open:T.value}])},"▾",2)],40,Aa),T.value?(E(),I("div",{key:0,ref_key:"stageDropdownRef",ref:z,class:"stage-dropdown",role:"listbox"},[(E(!0),I(ue,null,de(ae.value,A=>(E(),I("div",{key:A.id,class:oe(["stage-option",{disabled:A.disabled}]),role:"option","aria-selected":A.disabled,onClick:ne(W=>Ne(A),["stop"]),onKeydown:qe(ne(W=>Ne(A),["prevent"]),["enter"])},[i("span",{class:"stage-color",style:me({backgroundColor:A.color})},null,4),i("span",Ma,x(A.name),1)],42,$a))),128))],512)):Z("",!0)]),i("span",Na,"Всего: "+x(((V=o.value)==null?void 0:V.totalCount)||r.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Ra,[i("button",{class:oe(["view-switch-btn",{active:c.value==="employees"}]),onClick:b[0]||(b[0]=A=>c.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="time"}]),onClick:b[1]||(b[1]=A=>c.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="departments"}]),onClick:b[2]||(b[2]=A=>c.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),i("div",Fa,[w.value?(E(),I("div",xa,[i("span",null,"Ошибка: "+x(w.value),1),i("button",{class:"btn-retry-stage",onClick:b[3]||(b[3]=A=>{var W;return X(((W=o.value)==null?void 0:W.stageId)||r.stageId)})}," Повторить ")])):Z("",!0),k.value?(E(),I("div",Ha,[...b[4]||(b[4]=[i("div",{class:"loading-spinner small"},null,-1),i("span",null,"Загрузка стадии...",-1)])])):Z("",!0),c.value==="employees"?(E(),I("div",Oa,[(((C=o.value)==null?void 0:C.employees)||r.employees).length===0&&(!((h=o.value)!=null&&h.others||r.others)||(((_=o.value)==null?void 0:_.others)||r.others).count===0)?(E(),I("div",Pa," Нет данных о сотрудниках ")):(E(),I("div",La,[(E(!0),I(ue,null,de((($=o.value)==null?void 0:$.employees)||r.employees,A=>(E(),I("div",{key:A.id,class:oe(["employee-item",{"employee-keeper":A.isKeeper}]),onClick:ne(W=>be(A,W),["stop"]),title:"Кликните для детализации по временным градациям"},[i("span",ja,x(A.name),1),i("div",Wa,[i("div",{class:"progress-bar",style:me({width:A.progressBarWidth+"%",backgroundColor:A.progressBarColor})},null,4)]),i("span",Ua,x(A.count)+" тикетов ("+x(A.percentage)+"%) ",1),b[5]||(b[5]=i("span",{class:"employee-arrow"},"→",-1))],10,Ba))),128)),((v=o.value)!=null&&v.others||r.others)&&(((R=o.value)==null?void 0:R.others)||r.others).count>0?(E(),I("div",za,[i("span",Ka,"Другие ("+x((((F=o.value)==null?void 0:F.others)||r.others).employeeCount)+")",1),i("div",Va,[i("div",{class:"progress-bar",style:me({width:(((G=o.value)==null?void 0:G.others)||r.others).progressBarWidth+"%",backgroundColor:(((j=o.value)==null?void 0:j.others)||r.others).progressBarColor})},null,4)]),i("span",Ga,x((((B=o.value)==null?void 0:B.others)||r.others).count)+" тикетов ("+x((((J=o.value)==null?void 0:J.others)||r.others).percentage)+"%) ",1)])):Z("",!0)]))])):c.value==="time"?(E(),I("div",Ya,[u.value.length===0?(E(),I("div",qa," Загрузка данных... ")):(E(),I("div",Xa,[(E(!0),I(ue,null,de(u.value,A=>(E(),I("div",{key:A.category,class:"category-item",onClick:ne(W=>$e(A),["stop"])},[i("span",Za,x(A.label),1),i("div",Qa,[i("div",{class:"progress-bar",style:me({width:A.progressBarWidth+"%",backgroundColor:A.progressBarColor})},null,4)]),i("span",es,x(A.count)+" тикетов ("+x(A.percentage)+"%) ",1),b[6]||(b[6]=i("span",{class:"category-arrow"},"→",-1))],8,Ja))),128))]))])):c.value==="departments"?(E(),I("div",ts,[f.value.length===0?(E(),I("div",as," Загрузка данных... ")):(E(),I("div",ss,[i("table",ns,[b[8]||(b[8]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(E(!0),I(ue,null,de(f.value,(A,W)=>(E(),I("tr",{key:W,class:"department-row",onClick:ne(ee=>ce(A),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",ls,[i("span",rs,x(A.departmentName),1)]),i("td",is,[i("span",cs,x(A.count),1)]),b[7]||(b[7]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,os))),128))])])]))])):Z("",!0)])])):l.value===2&&p.value?(E(),I("div",us,[i("div",ds,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("h3",null,x(p.value.employeeName),1),i("span",ps,"Всего: "+x(p.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",gs,[i("div",fs,[i("span",ms,x(p.value.stageName),1)]),p.value.dateCategories.length===0?(E(),I("div",hs," Нет данных о тикетах ")):(E(),I("div",vs,[(E(!0),I(ue,null,de(p.value.dateCategories,A=>(E(),I("div",{key:A.category,class:"category-item",onClick:ne(W=>Ve(A),["stop"])},[i("span",ks,x(A.label),1),i("div",ws,[i("div",{class:"progress-bar",style:me({width:A.progressBarWidth+"%",backgroundColor:A.progressBarColor})},null,4)]),i("span",bs,x(A.count)+" тикетов ("+x(A.percentage)+"%) ",1)],8,ys))),128))]))])])):l.value===3&&d.value?(E(),I("div",Ss,[i("div",Ds,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("div",Es,[i("h3",null,x(d.value.employeeName),1),i("div",_s,[i("span",Cs,x(d.value.dateCategoryLabel),1),i("span",Ts,x(d.value.stageName),1)])]),i("span",As,"Всего: "+x(d.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Is,[d.value.departments.length===0?(E(),I("div",$s," Нет данных о заказчиках ")):(E(),I("div",Ms,[i("table",Ns,[b[10]||(b[10]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(E(!0),I(ue,null,de(d.value.departments,(A,W)=>(E(),I("tr",{key:W,class:"department-row",onClick:ne(ee=>ie(A),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",Fs,[i("span",xs,x(A.departmentName),1)]),i("td",Hs,[i("span",Os,x(A.count),1)]),b[9]||(b[9]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,Rs))),128))])])]))])])):l.value===4&&g.value?(E(),I("div",Ps,[i("div",Ls,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("div",Bs,[i("h3",null,x(L.value),1),g.value.context?(E(),I("div",js,[g.value.context.dateCategoryLabel?(E(),I("span",Ws,x(g.value.context.dateCategoryLabel),1)):Z("",!0),g.value.context.departmentName?(E(),I("span",Us,x(g.value.context.departmentName),1)):Z("",!0),i("span",zs,x(g.value.context.stageName),1)])):Z("",!0)]),i("span",Ks,"Всего: "+x(g.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Vs,[re(Je,{name:"loading",mode:"out-in"},{default:Te(()=>[g.value.isLoading?(E(),I("div",Gs,[...b[11]||(b[11]=[i("div",{class:"loading-spinner"},null,-1),i("p",null,"Загрузка тикетов...",-1)])])):g.value.error&&g.value.error.hasFallback?(E(),I("div",Ys,[b[12]||(b[12]=i("div",{class:"error-banner"},[i("span",{class:"error-icon"},"⚠️"),i("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),i("div",qs,[re(At,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(E(!0),I(ue,null,de(g.value.tickets,(A,W)=>(E(),Ae(Rt,{key:A.id,ticket:A,draggable:!1,style:me({"--ticket-index":W}),onClick:ee=>Me(A)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):g.value.error&&!g.value.error.hasFallback?(E(),I("div",Xs,[b[13]||(b[13]=i("div",{class:"error-icon"},"❌",-1)),b[14]||(b[14]=i("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),i("p",Js,x(g.value.error.message),1),i("button",{class:"btn-retry",onClick:Ge},"Повторить попытку")])):!g.value.tickets||g.value.tickets.length===0?(E(),I("div",Zs,[b[15]||(b[15]=i("div",{class:"empty-state-icon"},"📭",-1)),i("h3",Qs,x(Se()),1),i("p",en,x(Le()),1)])):(E(),I("div",tn,[re(At,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(E(!0),I(ue,null,de(g.value.tickets,(A,W)=>(E(),Ae(Rt,{key:A.id,ticket:A,draggable:!1,style:me({"--ticket-index":W}),onClick:ee=>Me(A)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):Z("",!0)]}),_:1})])],32)):Z("",!0)]))}},sn=Ie(an,[["__scopeId","data-v-6ac66e72"]]);function nn(r,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof r!="number"||r<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((l,c)=>{if(!l||!l.data||!Array.isArray(l.data))return;const o=l.data[r];o!=null&&!isNaN(o)&&a.push({datasetIndex:c,value:Number(o),y:Number(o)})}),a.length<2)return 0;const s=[];return a.forEach(l=>{let c=!1;for(const o of s){const u=o.y;if(Math.abs(l.y-u)<e){o.points.push(l),o.y=o.points.reduce((p,d)=>p+d.y,0)/o.points.length,c=!0;break}}c||s.push({points:[l],y:l.y})}),s.length===0?0:s.reduce((l,c)=>c.points.length>l.points.length?c:l,s[0]).points.length}function on(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.value-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.value,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.value})}),e}function ln(r,t=.5){var n,l;if(!r)return console.warn("findOverlappingPoints: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];const e=(n=r.data)==null?void 0:n.datasets,a=((l=r.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const s=[];return a.forEach((c,o)=>{try{if(nn(o,e,t)<2)return;const f=[];if(e.forEach((k,w)=>{if(!k||!k.data||!Array.isArray(k.data))return;const S=k.data[o];S==null||isNaN(S)||f.push({datasetIndex:w,value:Number(S),label:k.label||`Dataset ${w}`})}),f.length<2)return;const p=on(f,t);if(p.length===0)return;const d=p.reduce((k,w)=>w.points.length>k.points.length?w:k,p[0]);if(d.points.length<2)return;let g=null,D=null;for(let k=0;k<e.length;k++)try{const w=r.getDatasetMeta(k);if(w&&w.data&&w.data[o]){g=w,D=w.data[o];break}}catch{continue}if(!D||typeof D.x!="number"||typeof D.y!="number")return;s.push({position:o,count:d.points.length,x:D.x,y:D.y,value:d.y,points:d.points.map(k=>({datasetIndex:k.datasetIndex,value:k.value,label:k.label}))})}catch(u){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${o}:`,u)}}),s}function rn(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.y-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.y,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.y})}),e}function cn(r,t,e=.5){var u,f;if(!r)return console.warn("calculatePointJitter: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(u=r.data)==null?void 0:u.datasets,s=((f=r.data)==null?void 0:f.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(s)||t>=s.length)return[];const n=[];if(a.forEach((p,d)=>{if(!p||!p.data||!Array.isArray(p.data))return;const g=p.data[t];if(!(g==null||isNaN(g)))try{const D=r.getDatasetMeta(d);if(D&&D.data&&D.data[t]){const k=D.data[t];k&&typeof k.x=="number"&&typeof k.y=="number"&&n.push({datasetIndex:d,value:Number(g),x:k.x,y:k.y})}}catch(D){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,D)}}),n.length===0)return[];const l=rn(n,e),c=[];l.forEach(p=>{const d=p.points||[];d.length>1?d.forEach((D,k)=>{const w=(k-(d.length-1)/2)*4;c.push({datasetIndex:D.datasetIndex,jitterX:w,value:D.value})}):d.length===1&&c.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const o=new Set(c.map(p=>p.datasetIndex));return n.forEach(p=>{o.has(p.datasetIndex)||c.push({datasetIndex:p.datasetIndex,jitterX:0,value:p.value})}),c}const un=.5,Ht=6,dn=2;function pn(r){return typeof r!="number"||r<2?Ht:Ht+(r-1)*dn}function gn(r,t){if(!r||!r.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=r.ctx,{x:s,y:n,points:l}=t,c=pn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(s,n,c,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&r.data&&r.data.datasets){const f=l[0].datasetIndex,p=r.data.datasets[f];if(p&&p.pointBackgroundColor){const d=Array.isArray(p.pointBackgroundColor)?p.pointBackgroundColor[t.position]||p.pointBackgroundColor[0]:p.pointBackgroundColor;if(d)if(d.startsWith("#")){const g=parseInt(d.slice(1,3),16),D=parseInt(d.slice(3,5),16),k=parseInt(d.slice(5,7),16);u=`rgba(${g}, ${D}, ${k}, 0.4)`}else d.startsWith("rgba")?u=d.replace(/rgba?\(([^)]+)\)/,(g,D)=>{const k=D.split(",").map(w=>w.trim());return`rgba(${k[0]}, ${k[1]}, ${k[2]}, 0.4)`}):u=d+"66"}}a.fillStyle=u,a.fill(),a.strokeStyle=u.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(u){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",u)}finally{a.restore()}}}const fn={id:"overlappingPointsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const t=ln(r,un);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{gn(r,a)}catch(s){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,s)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},mn=.5,hn={id:"pointJitterPlugin",beforeDatasetsDraw:r=>{var t,e;if(!(!r||!r.config||r.config.type!=="line")){r._jitterData||(r._jitterData={});try{const a=(t=r.data)==null?void 0:t.datasets,s=((e=r.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(s)||s.length===0)return;r._jitterData={},s.forEach((n,l)=>{const c=cn(r,l,mn);c&&c.length>0&&c.forEach(o=>{const u=`${o.datasetIndex}_${l}`;r._jitterData[u]=o.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx&&!(!r._jitterData||Object.keys(r._jitterData).length===0))try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);!l||l.hidden||!s.data||!Array.isArray(s.data)||s.data.forEach((c,o)=>{const u=l.data[o];if(!u||typeof u.x!="number"||typeof u.y!="number"||c==null||isNaN(c))return;const f=`${n}_${o}`,p=r._jitterData[f];if(!(p===void 0||p===0)){e.save();try{const d=s.pointStyle||"circle",g=(s.pointRadius||7)+1,D=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[o]||s.pointBackgroundColor[0]:s.pointBackgroundColor,k=Array.isArray(s.pointBorderColor)?s.pointBorderColor[o]||s.pointBorderColor[0]:s.pointBorderColor,w=s.pointBorderWidth||1,S=u.x+p,T=u.y;switch(e.fillStyle=D||"#007bff",e.strokeStyle=k||"#ffffff",e.lineWidth=w,e.beginPath(),d){case"circle":e.arc(S,T,g,0,2*Math.PI);break;case"triangle":e.moveTo(S,T-g),e.lineTo(S-g,T+g),e.lineTo(S+g,T+g),e.closePath();break;case"rect":case"rectRounded":const z=g*1.4;e.rect(S-z/2,T-z/2,z,z);break;case"rectRot":const Q=g*1.4;e.moveTo(S,T-Q/2),e.lineTo(S+Q/2,T),e.lineTo(S,T+Q/2),e.lineTo(S-Q/2,T),e.closePath();break;case"star":const ae=g;for(let q=0;q<5;q++){const X=q*4*Math.PI/5-Math.PI/2,ie=S+ae*Math.cos(X),ce=T+ae*Math.sin(X);q===0?e.moveTo(ie,ce):e.lineTo(ie,ce)}e.closePath();break;case"cross":const L=g;e.moveTo(S-L,T-L),e.lineTo(S+L,T+L),e.moveTo(S+L,T-L),e.lineTo(S-L,T+L);break;case"crossRot":const O=g;e.moveTo(S-O,T),e.lineTo(S+O,T),e.moveTo(S,T-O),e.lineTo(S,T+O);break;default:e.arc(S,T,g,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),u._originalX||(u._originalX=u.x,u._originalY=u.y),u._jitterX=p,u._jitteredX=S,u._jitteredY=T}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${n}_${o}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:r=>{r._jitterData}},vn={id:"pointLabelsPlugin",afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);if(!l||l.hidden||!s.data||!Array.isArray(s.data))return;const c=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[0]||"#6b7280":s.pointBackgroundColor||"#6b7280";s.data.forEach((o,u)=>{const f=l.data[u];if(!f||typeof f.x!="number"||typeof f.y!="number"||o==null||isNaN(o))return;const p=f._jitteredX!==void 0?f._jitteredX:f.x,d=f._jitteredY!==void 0?f._jitteredY:f.y,g=p+8,D=d-5,k=String(Math.round(o));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const S=e.measureText(k).width,T=11,z=3,Q=g-z,ae=D-T/2-z,L=S+z*2,O=T+z*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Q,ae,L,O),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Q,ae,L,O),e.fillStyle=c,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(k,g,D)}catch(w){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${n}_${u}:`,w)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},yn={class:"graph-state-chart"},kn={class:"chart-header"},wn={class:"chart-type-selector"},bn=["onClick","title"],Sn={class:"chart-type-icon"},Dn={class:"chart-type-label"},En={key:0,class:"comparison-type-selector"},_n={class:"radio-group"},Cn={key:0},Tn={key:1},An={key:2,class:"graph-legend"},In={key:4,class:"error-container"},$n={class:"error-message"},Mn={class:"chart-wrapper"},Nn={class:"chart-canvas-container"},Rn={key:0,class:"bar-chart-stage-labels"},Fn={key:6,class:"no-data"},xn={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(r,{emit:t}){const e=(C,h)=>typeof window>"u"?h:getComputedStyle(document.documentElement).getPropertyValue(C).trim()||h,a=r,s=t,n=N(!1),l=N(null),c=N(null),o=N({weekStart:null,weekEnd:null,current:null}),u=N(null),f=N("weekStartToWeekEnd"),p=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=N("line"),g=N(!1),D=N(""),k=N(""),w=N(0),S=N([]),T=N(null),z=N(null),Q=N(null),ae=N(null),L=N([]),O=te(()=>{switch(d.value){case"line":return It;case"bar":return Jt;case"doughnut":return Xt;default:return It}}),q={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},X=[{id:"formed",name:"Сформировано обращение",color:q.formed},{id:"review",name:"Рассмотрение ТЗ",color:q.review},{id:"execution",name:"Исполнение",color:q.execution}],ie=te(()=>X.reduce((C,h)=>(C[h.id]=h.name,C),{})),ce=["circle","triangle","rect","rectRot","star","cross","crossRot"],$e=N({formed:!0,review:!0,execution:!0}),be=Ze(),Ve={id:"employeeLabelsPlugin",afterDatasetsDraw:C=>{if(C.config.type==="bar")try{const h=C.ctx;if(!C.data||!C.data.datasets)return;const _=C.data.datasets,$=C.scales.y;_.forEach((v,R)=>{const F=C.getDatasetMeta(R);if(!F||F.hidden)return;const G=v.label||"";if(!G||G.includes("Другие"))return;const j=G.trim().split(/\s+/);let B="";if(j.length===1)B=j[0];else{const A=j[0],W=j.slice(1).join(" ");B=`${A}
${W}`}const J=B.split(`
`);v.data.forEach((A,W)=>{if(A===0||!A)return;const ee=F.data[W];if(!ee||typeof ee.x!="number"||typeof ee.y!="number")return;const ge=ee.x,Re=ee.y+ee.height+25;h.save(),h.font="bold 9px Arial, sans-serif",h.fillStyle="#6b7280",h.textAlign="center",h.textBaseline="top",h.translate(ge,Re),h.rotate(-12*Math.PI/180),J.forEach((De,Fe)=>{const xe=De.trim();xe&&h.fillText(xe,0,Fe*11)}),h.restore()})})}catch(h){console.error("Error in employeeLabelsPlugin:",h)}}};Qe.register(Ve);function we(){const C=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(h=>{!h||!h.statistics||!h.statistics.employees||h.statistics.employees.forEach(_=>{C.has(_.id)||C.set(_.id,{id:_.id,name:_.name})})}),L.value=Array.from(C.values()).sort((h,_)=>h.name.localeCompare(_.name))}function he(C,h="background"){var $;return(($={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[C])==null?void 0:$[h])||e("--b24-text-secondary","#6c757d")}function Pe(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const C=ut.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let h=null,_=null;o.value.current&&(h=ut.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),_=ut.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:C,weekEndToCurrent:h,weekStartToCurrent:_}}catch(C){console.error("Ошибка сравнения слепков:",C),be.warning("Не удалось выполнить сравнение слепков: "+C.message)}}function Se(C){return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[C]||"formed"}function Le(C){return Se(C)}function Ge(C){return C===0?"weekStart":C===1?"weekEnd":C===2?"current":"weekEnd"}function Me(C){return o.value[C]||null}function ve(C,h,_,$,v=null,R=null,F=null,G=null){var j;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:C,stageId:h,totalCount:_,employeesCount:($==null?void 0:$.length)||0,hasSnapshot:!!R,snapshotTicketIds:((j=R==null?void 0:R.ticketIds)==null?void 0:j.length)||0}),D.value=C,k.value=h||"",w.value=_,S.value=$||[],T.value=v&&v.count>0?v:null,z.value=R,Q.value=F,ae.value=G,g.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:k.value,hasCurrentSnapshot:!!z.value})}function P(C,h,_){var j,B,J,A,W,ee;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:C,timePoint:h,employeeDataCount:_==null?void 0:_.length});const $=X.find(ge=>ge.id===C);if(!$){console.warn("[GraphStateChart] Stage not found:",C);return}const v=Me(h);if(console.log("[GraphStateChart] Snapshot for timePoint:",h,v?"found":"not found"),!v){console.warn("[GraphStateChart] Snapshot not found for timePoint:",h),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!o.value.weekStart,weekEnd:!!o.value.weekEnd,current:!!o.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!v.tickets,ticketsIsArray:Array.isArray(v.tickets),ticketsLength:((j=v.tickets)==null?void 0:j.length)||0,hasTicketIds:!!v.ticketIds,ticketIdsLength:((B=v.ticketIds)==null?void 0:B.length)||0,hasMetadata:!!v.metadata,hasStatistics:!!v.statistics,snapshotKeys:Object.keys(v),snapshotType:typeof v}),!v.tickets||!Array.isArray(v.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",v),be.warning("Слепок не содержит данных о тикетах");return}const R=((W=(A=(J=v.statistics)==null?void 0:J.stages)==null?void 0:A[C])==null?void 0:W.count)||0;console.log("[GraphStateChart] Total count for stage:",R);const F=Ke(_,R,$.color,10),G={graphType:"line",stageId:C,stageName:$.name,timePoint:h,snapshots:o.value,meta:{line:dataset.meta},stageColorMap:q,stageNameMap:ie.value};console.log("[GraphStateChart] Opening modal with:",{stageName:$.name,stageId:C,totalCount:R,employeesCount:((ee=F.employees)==null?void 0:ee.length)||0,hasSnapshot:!!v,snapshotHasTickets:!!v.tickets}),ve($.name,C,R,F.employees,F.others,v,null,G)}function Y(C,h){var v,R,F;if(!h||!h.employees||h.employees.length===0){be.warning("Нет данных о сотрудниках для этого этапа");return}const _=o.value.current||o.value.weekEnd||o.value.weekStart,$={graphType:"doughnut",stageId:C,stageName:h.stageName,snapshots:o.value,meta:{doughnut:((F=(R=(v=c.value)==null?void 0:v.datasets)==null?void 0:R[0])==null?void 0:F.meta)||null},stageColorMap:q,stageNameMap:ie.value};ve(h.stageName,C,h.totalCount,h.employees,h.others,_,null,$)}function ye(){g.value=!1,D.value="",k.value="",w.value=0,S.value=[],T.value=null,z.value=null,Q.value=null}function Ne(C,h,_){var J,A;if(d.value!=="line"||h.length===0)return;const $=h[0],v=$.datasetIndex,R=$.index,F=_.data.datasets[v];if(!F||!F.meta)return;const G=Le(F.label),j=Ge(R),B=(A=(J=F.meta)==null?void 0:J.employees)==null?void 0:A[j];!B||B.length===0||P(G,j,B)}function pe(C,h,_){var J,A;if(d.value!=="doughnut"||h.length===0)return;const v=h[0].index,R=_.data,F=R.labels[v],G=Le(F),j=(A=(J=R.datasets[0])==null?void 0:J.meta)==null?void 0:A.employees,B=j==null?void 0:j[G];if(!B){console.warn("Данные о сотрудниках не найдены для этапа:",G);return}Y(G,B)}function m(C){var $;const h=X[C];if(!h)return 0;const _=o.value.current||o.value.weekEnd||o.value.weekStart;return!_||!_.statistics||!_.statistics.stages?0:(($=_.statistics.stages[h.id])==null?void 0:$.count)||0}function b(C){var v;const h=X.find(R=>R.id===C);if(!h)return"";const _=o.value.current||o.value.weekEnd||o.value.weekStart;if(!_||!_.statistics||!_.statistics.stages)return h.name;const $=((v=_.statistics.stages[C])==null?void 0:v.count)||0;return`${h.name} (${$})`}const y=te(()=>{if(!c.value)return null;if(d.value==="doughnut"||d.value==="bar")return c.value;const C=c.value.datasets.filter(h=>{const _=X.find($=>$.name===h.label);return _?$e.value[_.id]:!0});return{...c.value,datasets:C}});te(()=>d.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const M=te(()=>{const C={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(h,_,$)=>{d.value==="line"?Ne(h,_,$):d.value==="doughnut"&&pe(h,_,$)},onHover:(h,_,$)=>{d.value==="doughnut"&&(h.native.target.style.cursor=_.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",onClick:(h,_,$)=>{if(d.value==="bar"){const R=_.datasetIndex;if(R!==void 0){const F=$.chart.getDatasetMeta(R);F.hidden=!F.hidden,$.chart.update()}return}const v=_.datasetIndex;if(v!==void 0){const R=$.chart.getDatasetMeta(v);R.hidden=!R.hidden,$.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:h=>{if(d.value==="bar"){const _=h[0].dataIndex,$=X[_];return $?$.name:""}return h[0].label||""},label:h=>{var R,F,G,j,B,J;const _=h.dataset.label||"",$=h.parsed.y||h.parsed||0,v=h.dataIndex;if(d.value==="bar"){const A=h.dataset,W=h.dataIndex,ee=X[W],ge=ee?ee.name:"";return`${A.label}: ${$} тикетов на этапе "${ge}"`}if(d.value==="doughnut"){const A=h.dataset.data.reduce((ee,ge)=>ee+ge,0),W=A>0?($/A*100).toFixed(1):0;return`${_}: ${$} тикетов (${W}%)`}else{if(!u.value||v===0)return`${_}: ${$} тикетов`;let A=null;const W=Se(_);if(f.value==="weekStartToWeekEnd"&&v===1?A=(F=(R=u.value.weekStartToWeekEnd)==null?void 0:R.stages)==null?void 0:F[W]:f.value==="weekEndToCurrent"&&v===2&&o.value.current?A=(j=(G=u.value.weekEndToCurrent)==null?void 0:G.stages)==null?void 0:j[W]:f.value==="weekStartToCurrent"&&v===2&&o.value.current&&(A=(J=(B=u.value.weekStartToCurrent)==null?void 0:B.stages)==null?void 0:J[W]),!A)return`${_}: ${$} тикетов`;const ee=A.delta,ge=A.deltaPercent,Re=A.trend;let De=`${_}: ${$} тикетов`;if(ee!==0){const Fe=ee>0?"+":"",xe=Re==="increase"?"↑":Re==="decrease"?"↓":"→";De+=` (${Fe}${ee}, ${Fe}${ge.toFixed(1)}%) ${xe}`}else De+=" (без изменений)";return De}},afterBody:h=>{if(d.value==="bar"&&h.length>0){const R=h[0];R.dataset;const F=R.parsed.y||0,G=R.dataIndex,j=m(G);return[`${j>0?(F/j*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&h.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const R=[];if(u.value){const F=h[0].dataIndex;if(F!==0){let G=null;if(Se(h[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&F===1?G=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&F===2?G=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&F===2&&(G=u.value.weekStartToCurrent),G&&G.metadata){const j=G.metadata.timeDiff;R.push(`Период: ${j.days} дн. ${j.hours} ч. ${j.minutes} мин.`)}}}return R.push("Кликните для детализации по сотрудникам"),R}if(!u.value)return[];const _=h[0].dataIndex;if(_===0)return[];let $=null;if(Se(h[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&_===1?$=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&_===2?$=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&_===2&&($=u.value.weekStartToCurrent),!$||!$.metadata)return[];const v=$.metadata.timeDiff;return[`Период: ${v.days} дн. ${v.hours} ч. ${v.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...C,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...C,cutout:"60%"}:C});function K(C){const h=new Date(C),_=h.getFullYear(),$=String(h.getMonth()+1).padStart(2,"0"),v=String(h.getDate()).padStart(2,"0");return`${_}-${$}-${v}`}function U(C){const{current:h,weekEnd:_}=C,$=h||_;if(!$||!$.statistics||!$.statistics.stages)return null;const v=[],R=[],F=[],G=[],j={};return X.forEach(B=>{var A;const J=((A=$.statistics.stages[B.id])==null?void 0:A.count)||0;if(J>0){v.push(B.name),R.push(J),F.push(B.color+"80"),G.push(B.color);const W=ya(B.id,$,X);W&&W.employees&&(j[B.id]=W)}}),R.length===0?null:{labels:v,datasets:[{label:"Распределение по этапам",data:R,backgroundColor:F,borderColor:G,borderWidth:2,meta:{employees:j}}]}}function se(C){if(d.value==="doughnut")return U(C);if(d.value==="bar"){const F=a.showCurrentState&&C.current?"current":C.weekEnd?"weekEnd":"weekStart";return va(C,F,X)}const{weekStart:h,weekEnd:_,current:$}=C,v=[],R=[];return X.forEach((F,G)=>{var ge,Re,De,Fe,xe,ht,vt,yt,kt,wt,bt,St,Dt,Et,_t,Ct,Tt;const j=[];if(h&&h.statistics&&h.statistics.stages){const le=h.statistics.stages[F.id];if(v.length===0){const Ye=(ge=h.metadata)!=null&&ge.createdAt?new Date(h.metadata.createdAt):null;v.push(Ye?K(Ye):"Начало недели")}j.push((le==null?void 0:le.count)||0)}else v.length===0&&v.push("Начало недели"),j.push(0);if(_&&_.statistics&&_.statistics.stages){const le=_.statistics.stages[F.id];if(v.length===1){const Ye=(Re=_.metadata)!=null&&Re.createdAt?new Date(_.metadata.createdAt):null;v.push(Ye?K(Ye):"Конец недели")}j.push((le==null?void 0:le.count)||0)}else v.length===1&&v.push("Конец недели"),j.push(0);if($&&a.showCurrentState&&$.statistics&&$.statistics.stages){const le=$.statistics.stages[F.id];v.length===2&&v.push("Текущее состояние"),j.push((le==null?void 0:le.count)||0)}const B=["stable"];u.value?f.value==="weekStartToWeekEnd"?(B.push(((xe=(Fe=(De=u.value.weekStartToWeekEnd)==null?void 0:De.stages)==null?void 0:Fe[F.id])==null?void 0:xe.trend)||"stable"),$&&B.push(((yt=(vt=(ht=u.value.weekStartToCurrent)==null?void 0:ht.stages)==null?void 0:vt[F.id])==null?void 0:yt.trend)||"stable")):f.value==="weekEndToCurrent"&&$?(B.push("stable"),B.push(((bt=(wt=(kt=u.value.weekEndToCurrent)==null?void 0:kt.stages)==null?void 0:wt[F.id])==null?void 0:bt.trend)||"stable")):f.value==="weekStartToCurrent"&&$?(B.push(((Et=(Dt=(St=u.value.weekStartToWeekEnd)==null?void 0:St.stages)==null?void 0:Dt[F.id])==null?void 0:Et.trend)||"stable"),B.push(((Tt=(Ct=(_t=u.value.weekStartToCurrent)==null?void 0:_t.stages)==null?void 0:Ct[F.id])==null?void 0:Tt.trend)||"stable")):(B.push("stable"),$&&B.push("stable")):(B.push("stable"),$&&B.push("stable"));let J,A,W;u.value&&d.value!=="doughnut"?(J=B.map(le=>he(le,"background")+"40"),A=B.map(le=>he(le,"border")),W=B.map(le=>he(le,"point"))):(J=F.color+"40",A=F.color,W=F.color);let ee=null;d.value==="line"&&(ee={employees:ha(F.id,C)}),R.push({label:F.name,data:j,backgroundColor:(Array.isArray(J),J),borderColor:(Array.isArray(A),A),borderWidth:2,...d.value==="line"&&{pointStyle:ce[G%ce.length]},pointBackgroundColor:(Array.isArray(W),W),pointBorderColor:(Array.isArray(A),A),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:ee})}),v.length===0&&(v.push("Начало недели","Конец недели"),a.showCurrentState&&v.push("Текущее состояние")),{labels:v,datasets:R}}const ke=async()=>{var C,h,_;n.value=!0,l.value=null;try{const $=(C=a.period)!=null&&C.endDate?new Date(a.period.endDate):new Date,v=(h=a.period)!=null&&h.startDate?new Date(a.period.startDate):Ce.getWeekStartDate($),R=(_=a.period)!=null&&_.endDate?new Date(a.period.endDate):Ce.getWeekEndDate($),F=Ce.formatDate(v),G=Ce.formatDate(R),[j,B]=await Promise.all([Ce.getSnapshot(F,"week_start"),Ce.getSnapshot(G,"week_end")]);let J=null;a.showCurrentState&&(J=await gt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:j,weekEnd:B,current:J},we(),Pe(),V(),s("data-loaded",{weekStart:j,weekEnd:B,current:J})}catch($){console.error("Error loading chart data:",$),l.value=$.message||"Ошибка загрузки данных графика",be.error("Ошибка загрузки данных графика: "+l.value),s("error",l.value)}finally{n.value=!1}};Oe(()=>{Qe.register(fn),Qe.register(hn),Qe.register(vn),ke()});function H(C){$e.value=C}const V=()=>{var h;const C=se({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==((h=C==null?void 0:C.labels)==null?void 0:h.length))c.value=C;else if(C){const _=JSON.stringify(c.value),$=JSON.stringify(C);_!==$&&(c.value=C)}};return Ue(()=>[a.period,a.showCurrentState],()=>{ke()},{deep:!0}),Ue(d,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&V()}),Ue(f,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&V()}),(C,h)=>(E(),I("div",yn,[i("div",kn,[h[3]||(h[3]=i("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),i("div",wn,[(E(),I(ue,null,de(p,_=>i("button",{key:_.value,onClick:$=>d.value=_.value,class:oe(["chart-type-btn",{active:d.value===_.value}]),title:_.label},[i("span",Sn,x(_.icon),1),i("span",Dn,x(_.label),1)],10,bn)),64))])]),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(E(),I("div",En,[h[7]||(h[7]=i("h4",{class:"comparison-title"},"Тип сравнения:",-1)),i("div",_n,[i("label",null,[tt(i("input",{type:"radio","onUpdate:modelValue":h[0]||(h[0]=_=>f.value=_),value:"weekStartToWeekEnd",onChange:V},null,544),[[rt,f.value]]),h[4]||(h[4]=i("span",null,"Начало недели → Конец недели",-1))]),o.value.current?(E(),I("label",Cn,[tt(i("input",{type:"radio","onUpdate:modelValue":h[1]||(h[1]=_=>f.value=_),value:"weekEndToCurrent",onChange:V},null,544),[[rt,f.value]]),h[5]||(h[5]=i("span",null,"Конец недели → Текущее состояние",-1))])):Z("",!0),o.value.current?(E(),I("label",Tn,[tt(i("input",{type:"radio","onUpdate:modelValue":h[2]||(h[2]=_=>f.value=_),value:"weekStartToCurrent",onChange:V},null,544),[[rt,f.value]]),h[6]||(h[6]=i("span",null,"Начало недели → Текущее состояние",-1))])):Z("",!0)])])):Z("",!0),!n.value&&!l.value&&c.value?(E(),Ae(pa,{key:1,stages:X,selected:$e.value,"onUpdate:selected":H,onChange:V},null,8,["selected"])):Z("",!0),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(E(),I("div",An,[...h[8]||(h[8]=[Ut('<h4 class="legend-title" data-v-3ee1103a>Легенда:</h4><div class="legend-items" data-v-3ee1103a><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-increase" data-v-3ee1103a></span><span data-v-3ee1103a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-decrease" data-v-3ee1103a></span><span data-v-3ee1103a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-stable" data-v-3ee1103a></span><span data-v-3ee1103a>Серый — без изменений</span></div></div>',2)])])):Z("",!0),n.value?(E(),Ae(Pt,{key:3,message:"Загрузка данных графика..."})):l.value?(E(),I("div",In,[i("p",$n,"❌ "+x(l.value),1),i("button",{onClick:ke,class:"btn-retry"},"Повторить загрузку")])):y.value?(E(),I("div",{key:5,class:oe(["chart-container",`chart-type-${d.value}`])},[i("div",Mn,[i("div",Nn,[(E(),Ae(zt(O.value),{data:y.value,options:M.value},null,8,["data","options"]))]),d.value==="bar"?(E(),I("div",Rn,[(E(),I(ue,null,de(X,_=>i("div",{key:_.id,class:"stage-label-item"},x(b(_.id)),1)),64))])):Z("",!0)])],2)):(E(),I("div",Fn,[...h[9]||(h[9]=[i("p",null,"📊 Нет данных для отображения",-1),i("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),re(sn,{"is-visible":g.value,"stage-name":D.value,"stage-id":k.value,"total-count":w.value,employees:S.value,others:T.value,snapshot:z.value,"ticket-details":Q.value,"stage-switch-context":ae.value,onClose:ye},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},Hn=Ie(xn,[["__scopeId","data-v-3ee1103a"]]),On={key:0,class:"create-snapshot-button-container"},Pn=["disabled"],Ln={class:"modal-content"},Bn={class:"modal-header"},jn=["disabled"],Wn={class:"modal-body"},Un={key:0,class:"progress-container"},zn={class:"progress-bar-wrapper"},Kn={class:"progress-text"},Vn={class:"progress-percent"},Gn={class:"progress-description"},Yn={key:1},qn={class:"modal-footer"},Xn=["disabled"],Jn=["disabled"],Zn={key:0},Qn={key:0},eo={key:1},to={key:2},ao={key:1},so={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(r,{emit:t}){const e=r,a=t,s=N(e.user),n=N(!1),l=N(!1),c=N(0),o=N("idle"),u=N(""),f=Ze(),p=te(()=>s.value?Kt(s.value):!1);Oe(async()=>{if(!e.user)try{const w=await Lt.checkAccess();w.allowed&&(s.value=w.user)}catch(w){console.error("Error loading user:",w)}});const d=()=>{if(!p.value){f.warning("Только администраторы могут создавать слепки");return}n.value=!0},g=()=>{l.value||(n.value=!1,o.value="idle",c.value=0,u.value="")},D=async()=>{if(!l.value){if(!p.value){f.warning("Только администраторы могут создавать слепки");return}l.value=!0,o.value="loading_data",c.value=0,u.value="Инициализация загрузки данных...";try{u.value="Загрузка данных сектора из Bitrix24...";const w=await gt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:z=>{var ae;const Q=Math.min(80,(z.progress||0)*.8);c.value=Q,o.value="loading_data",u.value=z.description||((ae=z.details)==null?void 0:ae.description)||"Загрузка данных сектора..."}});o.value="creating_snapshot",c.value=85,u.value="Создание слепка...";const S=s.value;if(!S)throw new Error("Пользователь не определён");const T=await Ce.createSnapshot(w,"manual",{createdBy:{id:S.ID,name:`${S.NAME||""} ${S.LAST_NAME||""}`.trim()||S.EMAIL||`User ${S.ID}`},sectorId:"1C"});o.value="success",c.value=100,u.value="Слепок успешно создан!",f.success("Слепок состояния сектора успешно создан"),a("snapshot-created",T),setTimeout(()=>{g()},1500)}catch(w){o.value="error",c.value=0,u.value="Ошибка создания слепка",console.error("Error creating snapshot:",w);let S="Ошибка создания слепка";w.message&&(w.message.includes("загрузки данных")||w.message.includes("sector data")?S="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":w.message.includes("создания слепка")||w.message.includes("snapshot")?S="Не удалось создать слепок. Обратитесь в поддержку.":w.message.includes("валидац")||w.message.includes("validation")?S="Ошибка валидации данных. Проверьте данные сектора.":S=w.message),f.error(S)}finally{l.value=!1}}},k=w=>{w.key==="Escape"&&n.value&&!l.value&&g()};return Oe(()=>{window.addEventListener("keydown",k)}),lt(()=>{window.removeEventListener("keydown",k)}),(w,S)=>p.value?(E(),I("div",On,[i("button",{class:"create-snapshot-btn",onClick:d,disabled:l.value,title:"Создать слепок состояния сектора"},[...S[1]||(S[1]=[i("span",{class:"btn-icon"},"📸",-1),i("span",{class:"btn-text"},"Создать слепок",-1)])],8,Pn),(E(),Ae(Ot,{to:"body"},[re(Je,{name:"modal"},{default:Te(()=>[n.value?(E(),I("div",{key:0,class:"modal-overlay",onClick:S[0]||(S[0]=ne(T=>!l.value&&g(),["self"]))},[i("div",Ln,[i("div",Bn,[S[2]||(S[2]=i("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),i("button",{class:"modal-close",onClick:g,disabled:l.value,"aria-label":"Закрыть"}," ✕ ",8,jn)]),i("div",Wn,[o.value!=="idle"?(E(),I("div",Un,[i("div",zn,[i("div",{class:"progress-bar",style:me({width:`${c.value}%`})},null,4)]),i("div",Kn,[i("span",Vn,x(Math.round(c.value))+"%",1),i("span",Gn,x(u.value),1)])])):(E(),I("div",Yn,[...S[3]||(S[3]=[i("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),i("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),i("div",qn,[i("button",{class:"btn btn-secondary",onClick:g,disabled:l.value}," Отмена ",8,Xn),i("button",{class:"btn btn-primary",onClick:D,disabled:l.value},[l.value?(E(),I("span",Zn,[o.value==="loading_data"?(E(),I("span",Qn,"Загрузка данных...")):o.value==="creating_snapshot"?(E(),I("span",eo,"Создание...")):(E(),I("span",to,"Обработка..."))])):(E(),I("span",ao,"Создать"))],8,Jn)])])])):Z("",!0)]),_:1})]))])):Z("",!0)}},no=Ie(so,[["__scopeId","data-v-09bccee2"]]),oo=20,lo=5*60*1e3;async function ro({search:r="",limit:t=oo,sectorDepartmentId:e=Ft.SECTOR_1C}={}){const a=`sector1c_employees_${r}_${t}_${e||"all"}`,s=sessionStorage.getItem(a);if(s)try{const{data:n,timestamp:l}=JSON.parse(s);if(Date.now()-l<lo)return n}catch(n){console.warn("[sector1cEmployees] Cache parse error:",n)}try{const n={ACTIVE:"Y"};e?Array.isArray(e)?n.UF_DEPARTMENT=e:n.UF_DEPARTMENT=[e]:n.UF_DEPARTMENT=[Ft.SECTOR_1C],r&&r.length>=2&&(n["%NAME"]=r,n["%LAST_NAME"]=r,n["%WORK_POSITION"]=r);const o=((await pt.call("user.get",{filter:n,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:io(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:o,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return o}catch(n){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",n),new Error(`Не удалось загрузить сотрудников: ${n.message}`)}}function io(r){const t=[r.LAST_NAME,r.NAME,r.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):r.NAME||"Без имени"}const co={class:"employee-select-field-text"},uo={key:0,class:"employee-select-dropdown"},po={class:"employee-select-dropdown-search"},go={key:0,class:"employee-select-state"},fo={key:1,class:"employee-select-state employee-select-state--error"},mo={key:2,class:"employee-select-state"},ho=["checked"],vo=["checked","onChange"],yo={class:"employee-select-item-content"},ko={class:"employee-select-item-name"},wo={key:0,class:"employee-select-item-position"},bo={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(null),l=N(""),c=N([]),o=N(!1),u=N(null),f=N(!1),p=te(()=>{if(!l.value)return c.value;const L=l.value.toLowerCase();return c.value.filter(O=>O.name.toLowerCase().includes(L)||O.position&&O.position.toLowerCase().includes(L))}),d=te(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const L=c.value.find(O=>O.id===e.selected[0]);return L?L.name:e.placeholder}return`Выбрано: ${e.selected.length} ${Q(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function g(L=""){o.value=!0,u.value=null;try{c.value=await ro({search:L})}catch(O){u.value=O,a("error",O)}finally{o.value=!1}}function D(){a("search",l.value)}function k(){o.value||(f.value=!f.value,f.value?(c.value.length===0&&g(),Gt(()=>{n.value&&n.value.focus()})):l.value="")}function w(L){s.value&&!s.value.contains(L.target)&&(f.value=!1,l.value="")}function S(L){const O=[...e.selected],q=O.indexOf(L);if(L==="all")if(q>-1)O.splice(q,1);else return a("update:selected",["all"]);else if(q>-1)O.splice(q,1);else{const X=O.indexOf("all");X>-1&&O.splice(X,1),O.push(L)}a("update:selected",O)}function T(L){return L==="all"?e.selected.includes("all"):e.selected.includes(L)||e.selected.includes("all")}const z=te(()=>l.value?`Нет сотрудников по запросу "${l.value}"`:"Нет сотрудников сектора 1С");function Q(L,O,q,X){const ie=L%10,ce=L%100;return ce>=11&&ce<=19?X:ie===1?O:ie>=2&&ie<=4?q:X}function ae(){g(l.value)}return Ue(()=>e.selected,L=>{(!L||L.length===0)&&a("update:selected",["all"])},{immediate:!0}),Oe(()=>{document.addEventListener("click",w),(!e.selected||e.selected.length===0)&&a("update:selected",["all"])}),lt(()=>{document.removeEventListener("click",w)}),(L,O)=>(E(),I("div",{class:"employee-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["employee-select-field",{"employee-select-field--open":f.value,"employee-select-field--disabled":o.value}]),onClick:k},[i("span",co,x(d.value),1),i("span",{class:oe(["employee-select-field-icon",{open:f.value}])},"▼",2)],2),re(Je,{name:"dropdown-fade"},{default:Te(()=>[f.value?(E(),I("div",uo,[i("div",po,[tt(i("input",{"onUpdate:modelValue":O[0]||(O[0]=q=>l.value=q),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:D,onClick:O[1]||(O[1]=ne(()=>{},["stop"])),ref_key:"searchInput",ref:n},null,544),[[Vt,l.value]])]),o.value?(E(),I("div",go,[...O[6]||(O[6]=[i("span",{class:"spinner"},"⏳",-1),i("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):u.value?(E(),I("div",fo,[i("span",null,"❌ "+x(u.value.message||"Ошибка загрузки сотрудников"),1),i("button",{onClick:[ae,O[2]||(O[2]=ne(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!o.value&&p.value.length===0&&!u.value?(E(),I("div",mo,[i("span",null,"📭 "+x(z.value),1)])):(E(),I("div",{key:3,class:"employee-select-list",style:me({maxHeight:`${r.maxHeight}px`})},[i("label",{class:oe(["employee-select-item",{"employee-select-item--selected":T("all")}]),onClick:O[4]||(O[4]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T("all"),onChange:O[3]||(O[3]=q=>S("all"))},null,40,ho),O[7]||(O[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(E(!0),I(ue,null,de(p.value,q=>(E(),I("label",{key:q.id,class:oe(["employee-select-item",{"employee-select-item--selected":T(q.id)}]),onClick:O[5]||(O[5]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T(q.id),onChange:X=>S(q.id)},null,40,vo),i("div",yo,[i("span",ko,x(q.name),1),q.position?(E(),I("span",wo,x(q.position),1)):Z("",!0)])],2))),128))],4))])):Z("",!0)]),_:1})],512))}},So=Ie(bo,[["__scopeId","data-v-6b8c949b"]]),Do={class:"stage-select-field-text"},Eo={key:0,class:"stage-select-dropdown"},_o={class:"stage-select-list"},Co=["checked"],To=["checked","onChange"],Ao={class:"stage-select-item-content"},Io={class:"stage-select-item-name"},$o={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(!1),l=te(()=>Object.values(e.selected).every(d=>d===!0)),c=te(()=>{if(l.value)return e.placeholder;const d=e.stages.filter(g=>e.selected[g.id]);return d.length===0?"Этапы не выбраны":d.length===1?d[0].name:`Выбрано: ${d.length} этапа(ов)`});function o(){n.value=!n.value,n.value}function u(d){s.value&&!s.value.contains(d.target)&&(n.value=!1)}function f(d,g){const D={...e.selected};D[d]=g,a("update:selected",D),a("change",d,g)}function p(){const d=l.value,g={};e.stages.forEach(D=>{g[D.id]=!d}),a("update:selected",g),a("change","all",!d)}return Oe(()=>{document.addEventListener("click",u)}),lt(()=>{document.removeEventListener("click",u)}),(d,g)=>(E(),I("div",{class:"stage-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["stage-select-field",{"stage-select-field--open":n.value,"stage-select-field--disabled":!1}]),onClick:o},[i("span",Do,x(c.value),1),i("span",{class:oe(["stage-select-field-icon",{open:n.value}])},"▼",2)],2),re(Je,{name:"dropdown-fade"},{default:Te(()=>[n.value?(E(),I("div",Eo,[i("div",_o,[i("label",{class:oe(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:g[0]||(g[0]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:l.value,onChange:p},null,40,Co),g[2]||(g[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(E(!0),I(ue,null,de(r.stages,D=>(E(),I("label",{key:D.id,class:oe(["stage-select-item",{"stage-select-item--selected":r.selected[D.id]}]),onClick:g[1]||(g[1]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:r.selected[D.id],onChange:k=>f(D.id,k.target.checked)},null,40,To),i("div",Ao,[i("span",{class:"stage-select-item-color",style:me({backgroundColor:D.color})},null,4),i("span",Io,x(D.name),1)])],2))),128))])])):Z("",!0)]),_:1})],512))}},Mo=Ie($o,[["__scopeId","data-v-ce2229b2"]]),No={class:"filters-panel"},Ro={class:"filters-header"},Fo=["disabled"],xo={class:"filters-content"},Ho={class:"filter-section"},Oo={class:"section-content"},Po={class:"filter-section"},Lo={class:"section-content"},Bo={class:"filter-section"},jo={class:"section-content"},Wo=["value"],Uo={key:0,class:"custom-date-range"},zo={class:"date-range-inputs"},Ko={class:"date-input-group"},Vo=["value","max"],Go={class:"date-input-group"},Yo=["value","min","max"],qo={key:0,class:"filter-error"},Xo={key:1,class:"filter-hint"},Jo={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(r,{emit:t}){const e=r,a=t,s=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],n=N(null),l=te(()=>{const D=new Date;return D.setFullYear(D.getFullYear()-1),D.toISOString().split("T")[0]}),c=te(()=>new Date().toISOString().split("T")[0]);function o(D){a("update:stages",D),a("apply")}function u(D,k){a("apply")}function f(D){a("update:employees",D),a("apply")}function p(D){a("update:dateRange",D),n.value=null,a("apply")}function d(D,k){const w={...e.customDateRange};if(w[D]=k,w.startDate&&w.endDate){const S=new Date(w.startDate),T=new Date(w.endDate);if(S>T){n.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((T-S)/(1e3*60*60*24))>365){n.value="Период не может превышать 365 дней";return}}n.value=null,a("update:customDateRange",w),a("apply")}function g(){n.value=null,a("reset")}return(D,k)=>(E(),I("div",No,[i("div",Ro,[k[3]||(k[3]=i("h2",null,"Фильтры",-1)),i("button",{onClick:g,class:"btn-reset-filters",disabled:!r.hasActiveFilters}," Сбросить фильтры ",8,Fo)]),i("div",xo,[i("div",Ho,[k[4]||(k[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📊"),at(" Этапы ")],-1)),i("div",Oo,[re(Mo,{selected:r.stages,stages:s,placeholder:"Выберите этапы","onUpdate:selected":o,onChange:u},null,8,["selected"])])]),i("div",Po,[k[5]||(k[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"👥"),at(" Сотрудники сектора 1С ")],-1)),i("div",Lo,[re(So,{selected:r.employees,"onUpdate:selected":f},null,8,["selected"])])]),i("div",Bo,[k[9]||(k[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📅"),at(" Период ")],-1)),i("div",jo,[i("select",{value:r.dateRange,onChange:k[0]||(k[0]=w=>p(w.target.value)),class:"date-range-select"},[...k[6]||(k[6]=[i("option",{value:"last-week"},"Последняя неделя",-1),i("option",{value:"last-2-weeks"},"Последние 2 недели",-1),i("option",{value:"last-month"},"Последний месяц",-1),i("option",{value:"custom"},"Произвольный период",-1)])],40,Wo),r.dateRange==="custom"?(E(),I("div",Uo,[i("div",zo,[i("div",Ko,[k[7]||(k[7]=i("label",null,"С:",-1)),i("input",{type:"date",value:r.customDateRange.startDate,onChange:k[1]||(k[1]=w=>d("startDate",w.target.value)),max:r.customDateRange.endDate||c.value,class:"date-input"},null,40,Vo)]),i("div",Go,[k[8]||(k[8]=i("label",null,"По:",-1)),i("input",{type:"date",value:r.customDateRange.endDate,onChange:k[2]||(k[2]=w=>d("endDate",w.target.value)),min:r.customDateRange.startDate||l.value,max:c.value,class:"date-input"},null,40,Yo)])]),n.value?(E(),I("small",qo,x(n.value),1)):(E(),I("small",Xo," Выберите начальную и конечную дату для отображения данных "))])):Z("",!0)])])])]))}},Zo=Ie(Jo,[["__scopeId","data-v-4b7456a2"]]);function Qo(){const r=N(!1),t=N(null),e=N(null),a=N(0),s=Ze(),n=async(w=!0,S=null)=>{r.value=!0,t.value=null,a.value=0;try{const T=await gt.getSectorDataForSnapshot({useCache:w,onProgress:z=>{z&&typeof z.progress=="number"&&(a.value=z.progress),S&&S(z)},normalize:!0});return e.value=T,T}catch(T){throw t.value=T.message||"Ошибка загрузки данных сектора",s.error("Ошибка загрузки данных сектора: "+t.value),T}finally{r.value=!1,a.value=100}},l=async(w,S={})=>{if(!e.value){const T="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=T,s.error(T),new Error(T)}r.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(w))throw new Error(`Неверный тип слепка: ${w}. Допустимые значения: week_start, week_end, manual, current`);const T=await Ce.createSnapshot(e.value,w,S);return s.success("Слепок успешно создан"),T}catch(T){throw t.value=T.message||"Ошибка создания слепка",s.error("Ошибка создания слепка: "+t.value),T}finally{r.value=!1}},c=()=>{r.value=!1,t.value=null,e.value=null,a.value=0},o=te(()=>e.value!==null&&e.value!==void 0),u=N({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),f=te(()=>{const w=new Date;let S,T;switch(u.value.dateRange){case"last-week":S=new Date(w),S.setDate(w.getDate()-7),T=w;break;case"last-2-weeks":S=new Date(w),S.setDate(w.getDate()-14),T=w;break;case"last-month":S=new Date(w),S.setMonth(w.getMonth()-1),T=w;break;case"custom":S=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,T=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:S=new Date(w),S.setDate(w.getDate()-7),T=w}return{startDate:S?S.toISOString().split("T")[0]:null,endDate:T?T.toISOString().split("T")[0]:null}}),p=()=>{g()},d=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},g()},g=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(w){console.error("Ошибка сохранения фильтров в localStorage:",w)}},D=()=>{try{const w=localStorage.getItem("graphStateFilters");if(w){const S=JSON.parse(w);S&&typeof S=="object"&&(u.value={stages:S.stages||{formed:!0,review:!0,execution:!0},employees:S.employees||["all"],dateRange:S.dateRange||"last-week",customDateRange:S.customDateRange||{startDate:null,endDate:null}})}}catch(w){console.error("Ошибка загрузки фильтров из localStorage:",w)}},k=te(()=>{const w=Object.values(u.value.stages).some(z=>!z),S=!u.value.employees.includes("all"),T=u.value.dateRange!=="last-week";return w||S||T});return{isLoading:r,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:o,filters:u,selectedPeriod:f,hasActiveFilters:k,loadSectorDataForSnapshot:n,createSnapshot:l,resetState:c,applyFilters:p,resetFilters:d,saveFiltersToLocalStorage:g,loadFiltersFromLocalStorage:D}}const el={class:"graph-state-dashboard"},tl={key:1,class:"error-message-container"},al={class:"error-message"},sl={class:"error-text"},nl={key:0,class:"error-details"},ol={class:"dashboard-header"},ll={class:"header-content"},rl={class:"breadcrumbs-row"},il=["aria-disabled","data-fallback","disabled"],cl={class:"breadcrumbs","aria-label":"Навигация"},ul={class:"header-actions"},dl=["disabled"],pl={key:0},gl={key:1},fl={key:3,class:"dashboard-content"},ml={class:"chart-container"},hl="Назад",vl={__name:"GraphStateDashboard",setup(r){const t=(P,Y)=>typeof window>"u"?Y:getComputedStyle(document.documentElement).getPropertyValue(P).trim()||Y,e=Ze(),a=Yt(),s={name:"dashboard-sector-1c"},{filters:n,selectedPeriod:l,hasActiveFilters:c,applyFilters:o,resetFilters:u,loadFiltersFromLocalStorage:f}=Qo(),p=N(null),d=N(!0),g=N(!1),D=N("Загрузка данных..."),k=N(null),w=N(!1),S=N(!1),T=N(typeof window<"u"?window.innerWidth:1024),z=N(null),Q=N(!1),ae=te(()=>T.value<768);te(()=>T.value>=768&&T.value<1024),te(()=>T.value>=1024);const L=te(()=>typeof window>"u"?!1:window.history.length>1);te(()=>{const P=new Date;return P.setFullYear(P.getFullYear()-1),P.toISOString().split("T")[0]}),te(()=>new Date().toISOString().split("T")[0]);function O(P){n.value.stages=P}function q(P){n.value.employees=P}function X(P){n.value.dateRange=P}function ie(P){n.value.customDateRange=P}function ce(){o()}function $e(){u(),z.value=null,ce(),e.info("Фильтры сброшены")}function be(P){e.success("Слепок успешно создан")}function Ve(P){g.value=!1,D.value="",console.log("Данные графика загружены:",P)}function we(P){g.value=!1,he({message:P||"Ошибка загрузки графика",details:null,type:"error"})}function he(P){k.value={message:P.message||"Произошла ошибка",details:P.details||null,type:P.type||"error",timestamp:new Date},console.error("Dashboard error:",k.value),e.error(k.value.message)}function Pe(){k.value=null}function Se(){k.value=null,g.value=!0,D.value="Повторная загрузка данных..."}async function Le(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}w.value=!0;try{const P=document.querySelector(".chart-container");if(!P)throw new Error("График не найден");const Y=window.html2canvas,ye=await Y(P,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Ne=window.jsPDF,pe=new Ne("landscape","mm","a4"),m=297,b=ye.height*m/ye.width;pe.setFontSize(18),pe.text("График состояния сектора 1С",148.5,15,{align:"center"});const y=new Date().toLocaleDateString("ru-RU");pe.setFontSize(10);const M=l.value.startDate&&l.value.endDate?`Период: ${l.value.startDate} - ${l.value.endDate}`:"Период: не указан";pe.text(M,148.5,25,{align:"center"}),pe.text(`Экспорт от ${y}`,148.5,30,{align:"center"}),pe.addImage(ye.toDataURL("image/png"),"PNG",10,35,m-20,b-20),pe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${y}`,author:"Bitrix24 Dashboard"});const K=`graph-state-${y.replace(/\//g,"-")}.pdf`;pe.save(K),e.success("График успешно экспортирован в PDF")}catch(P){console.error("Ошибка экспорта в PDF:",P),he({message:"Ошибка экспорта в PDF: "+(P.message||"Неизвестная ошибка"),details:P.stack,type:"error"})}finally{w.value=!1}}function Ge(P){var Y;if((Y=P==null?void 0:P.preventDefault)==null||Y.call(P),!Q.value){Q.value=!0;try{if(L.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(s)}finally{Q.value=!1}}}function Me(){typeof window<"u"&&(T.value=window.innerWidth)}async function ve(){try{const P=await Lt.checkAccess();P.allowed&&(p.value=P.user)}catch(P){console.error("Error loading user:",P)}}return Oe(()=>{f(),ve(),typeof window<"u"&&(T.value=window.innerWidth,window.addEventListener("resize",Me))}),lt(()=>{typeof window<"u"&&window.removeEventListener("resize",Me)}),(P,Y)=>{const ye=qt("router-link");return E(),I("div",el,[g.value?(E(),Ae(Pt,{key:0,message:D.value},null,8,["message"])):Z("",!0),k.value?(E(),I("div",tl,[i("div",al,[i("div",{class:"error-header"},[Y[1]||(Y[1]=i("span",{class:"error-icon"},"❌",-1)),Y[2]||(Y[2]=i("h3",null,"Ошибка",-1)),i("button",{onClick:Pe,class:"error-close","aria-label":"Закрыть"},"✕")]),i("p",sl,x(k.value.message),1),k.value.details?(E(),I("div",nl,[i("details",null,[Y[3]||(Y[3]=i("summary",null,"Детали ошибки",-1)),i("pre",null,x(k.value.details),1)])])):Z("",!0),i("div",{class:"error-actions"},[i("button",{onClick:Se,class:"btn-retry"},"Повторить попытку")])])])):Z("",!0),i("div",ol,[i("div",ll,[i("div",rl,[i("button",{class:"btn-back-link",type:"button",onClick:Ge,"aria-label":hl,"aria-disabled":!L.value,"data-fallback":!L.value,disabled:Q.value,title:"Назад"}," ← ",8,il),i("nav",cl,[re(ye,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Te(()=>[...Y[4]||(Y[4]=[at(" Дашборд сектора 1С ",-1)])]),_:1}),Y[5]||(Y[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),Y[6]||(Y[6]=i("span",{class:"breadcrumb-current"},"График состояния",-1))])]),Y[7]||(Y[7]=i("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),Y[8]||(Y[8]=i("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),i("div",ul,[i("button",{onClick:Le,class:"btn-export-pdf",disabled:w.value||g.value,title:"Экспортировать график в PDF"},[w.value?(E(),I("span",gl,"⏳ Экспорт...")):(E(),I("span",pl,"📄 Экспорт в PDF"))],8,dl),re(no,{user:p.value,onSnapshotCreated:be},null,8,["user"])])]),ae.value?(E(),I("button",{key:2,class:"mobile-filters-toggle",onClick:Y[0]||(Y[0]=Ne=>S.value=!S.value)},[Y[9]||(Y[9]=i("span",null,"Фильтры",-1)),i("span",{class:oe(["toggle-icon",{open:S.value}])},"▼",2)])):Z("",!0),i("div",{class:oe({"mobile-open":S.value&&ae.value,"mobile-closed":!S.value&&ae.value})},[re(Zo,{stages:je(n).stages,employees:je(n).employees,dateRange:je(n).dateRange,customDateRange:je(n).customDateRange,hasActiveFilters:je(c),"onUpdate:stages":O,"onUpdate:employees":q,"onUpdate:dateRange":X,"onUpdate:customDateRange":ie,onReset:$e,onApply:ce},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!g.value&&!k.value?(E(),I("div",fl,[i("div",ml,[re(Hn,{period:je(l),"show-current-state":d.value,onDataLoaded:Ve,onError:we},null,8,["period","show-current-state"])])])):Z("",!0)])}}},yl=Ie(vl,[["__scopeId","data-v-e995acfd"]]),Sl=Object.freeze(Object.defineProperty({__proto__:null,default:yl},Symbol.toStringTag,{value:"Module"}));export{Sl as G,Bt as T,ga as g};
