import{_ as he,a as E,o as S,d as i,F as re,f as ie,j as Z,n as me,t as x,r as A,c as K,G as xe,m as De,g as Me,b as Y,k as ae,l as Fe,i as se,B as Ge,H as Ot,I as Tt,u as Pe,J as vt,p as je,K as Qe,x as xt,L as Bt,M as At,C as $t,N as Ke,D as Ft,O as Pt,P as Lt,y as He,Q as $e,z as Ut,e as Wt}from"./main-aZGYsAk-.js";import{L as yt,D as jt,B as Ht}from"./index-Cf8wdeg6.js";import{S as et,h as tt,K as zt,d as wt,B as st,m as kt,j as Vt,k as te,D as St,a as Gt,l as bt}from"./index-BNDXMy1z.js";const pe={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class ge{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new be("sectorData Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new be("type Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð´Ð½Ð¸Ð¼ Ð¸Ð·: week_start, week_end, manual, current","VALIDATION_ERROR");const o=this.validateSectorData(t);if(!o.isValid)throw new be(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});const s=this.normalizeSectorData(t),l={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||pe.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},r=this.validateSnapshot(l);if(!r.isValid)throw new be(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ ÑÐ»ÐµÐ¿ÐºÐ°: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});r.warnings.length>0&&console.warn("ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ ÑÐ»ÐµÐ¿ÐºÐ°:",r.warnings);const u=this.getApiBaseUrl(),d=await fetch(`${u}${pe.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:e,date:this.formatDate(new Date)})});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const f=await d.json();if(!f.success)throw new Error(f.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°");return f.data.snapshot}catch(o){throw console.error("SnapshotService.createSnapshot error:",o),o instanceof be?o:new be(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°: ${o.message}`,"API_ERROR",{originalError:o})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),s=`${this.getApiBaseUrl()}${pe.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success){if(l.message&&l.message.includes("Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"))return null;throw new Error(l.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°")}return l.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",pe.defaultSectorId);const o=`${this.getApiBaseUrl()}${pe.snapshotsEndpoint}?${e.toString()}`,s=await fetch(o,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=await s.json();if(!n.success)throw new Error(n.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÑÐ»ÐµÐ¿ÐºÐ¾Ð²");return(await Promise.all(n.data.snapshots.map(async r=>{try{return await this.getSnapshot(r.date,r.type)}catch(u){return console.warn(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ»ÐµÐ¿ÐºÐ° ${r.date}/${r.type}:`,u),null}}))).filter(r=>r!==null).sort((r,u)=>new Date(r.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:o={}}=t,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"}},n=[],l=[],r=[];e.forEach(f=>{const p=f.id;if(s[p]){let k=0;f.employees.forEach(w=>{const h=w.tickets||[];k+=h.length;let m=n.find(y=>y.id===w.id);m||(m={id:w.id,name:w.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(m)),h.forEach(y=>{l.push(y.id),r.push({id:y.id,title:y.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:{id:w.id,name:w.name},createdAt:y.createdAt||"",updatedAt:y.modifiedAt||y.updatedAt||""}),m.ticketsByStage[p]=(m.ticketsByStage[p]||0)+1,m.totalTickets+=1})}),s[p].count=k}});const u={unassigned:0,keeper:0,total:0};Object.values(o).forEach(f=>{Array.isArray(f)&&f.forEach(p=>{u.total+=1,p.assigneeId===1051||p.assignedById===1051?u.keeper+=1:u.unassigned+=1,l.push(p.id),r.push({id:p.id,title:p.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:p.assignedTo||p.assignedById?{id:p.assignedById||p.assigneeId,name:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹"}:null,createdAt:p.createdAt||"",updatedAt:p.modifiedAt||p.updatedAt||""})})});const d=Object.values(s).reduce((f,p)=>f+p.count,0)+u.total;return{statistics:{stages:{...s,total:d},employees:n,zeroPoint:u},ticketIds:[...new Set(l)],tickets:r}}static generateSnapshotMetadata(t,e,a){const o=new Date,s=-o.getTimezoneOffset(),n=Math.floor(s/60),l=s%60,r=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(l).padStart(2,"0")}`,u=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}T${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}:${String(o.getSeconds()).padStart(2,"0")}${r}`;return{version:pe.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°"},type:t,sectorId:a,sectorName:a==="1C"?"Ð¡ÐµÐºÑ‚Ð¾Ñ€ 1Ð¡":`Ð¡ÐµÐºÑ‚Ð¾Ñ€ ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ð´Ð°Ñ‚Ð°");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${o}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,o=a.getFullYear(),s=this.getWeekNumber(a),n=this.formatDate(t);let l;if(e==="current"){const r=new Date,u=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;l=`current-state-${n}-${u}.json`}else if(e==="manual"){const r=new Date,u=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;l=`manual-${n}-${u}.json`}else l=`${e}-${n}.json`;return e==="current"?`current/${l}`:`${o}/week-${s}/${l}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const o=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-o)/864e5+1)/7)}static validateSnapshot(t){var o,s,n;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð´Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ»ÐµÐ¿ÐºÐ°"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÑÐµÐºÑ‚Ð¾Ñ€Ð°"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¾Ð·Ð´Ð°Ñ‚ÐµÐ»Ðµ")):e.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¿ÐºÐ°"),!t.statistics)e.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°");else{if(!t.statistics.stages)e.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÑ‚Ð°Ð¿Ð°Ð¼");else{const l=t.statistics.stages,r=(((o=l.formed)==null?void 0:o.count)||0)+(((s=l.review)==null?void 0:s.count)||0)+(((n=l.execution)==null?void 0:n.count)||0);l.total!==r&&a.push(`ÐÐµÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²: Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ ${r}, ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ${l.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),!t.statistics.zeroPoint)e.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸");else{const l=t.statistics.zeroPoint,r=(l.unassigned||0)+(l.keeper||0);l.total!==r&&a.push(`ÐÐµÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸: Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ ${r}, ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ${l.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),!Array.isArray(t.tickets))e.push("tickets Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼");else{const l=new Set(t.ticketIds),r=new Set(t.tickets.map(u=>u.id));l.size!==r.size&&a.push("ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ID Ð² ticketIds Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²"),t.tickets.forEach((u,d)=>{u.id||e.push(`Ð¢Ð¸ÐºÐµÑ‚ #${d}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ID`),u.title||e.push(`Ð¢Ð¸ÐºÐµÑ‚ #${d}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº`),(!u.assignedTo||!u.assignedTo.id)&&a.push(`Ð¢Ð¸ÐºÐµÑ‚ #${d}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ)`),u.createdAt||e.push(`Ð¢Ð¸ÐºÐµÑ‚ #${d}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ`),u.updatedAt||e.push(`Ð¢Ð¸ÐºÐµÑ‚ #${d}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),Array.isArray(t.employees)||e.push("employees Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),s=`${this.getApiBaseUrl()}${pe.snapshotsEndpoint}`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const o of e)try{await this.deleteSnapshot(o.metadata.createdAt.split("T")[0],o.metadata.type)&&a++}catch(s){console.warn(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ° ${o.metadata.createdAt}:`,s)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=pe.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ ${a} Ð½Ð° ${e} Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð°`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,o=(e.getDay()||7)-1,s=new Date(e);return s.setDate(e.getDate()-o),s.setHours(0,0,0,0),s}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,o=7-(e.getDay()||7),s=new Date(e);return s.setDate(e.getDate()+o),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),o=this.getWeekNumberInfo(t),s=await this.getAllSnapshots({startDate:e,endDate:a}),n=s.find(u=>u.metadata.type==="week_start")||null,l=s.find(u=>u.metadata.type==="week_end")||null,r=s.filter(u=>u.metadata.type==="manual");return{weekStart:n,weekEnd:l,manual:r,weekInfo:o}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof be)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("Ð²ÐµÑ€ÑÐ¸Ñ")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("Ð´Ð¾ÑÑ‚ÑƒÐ¿")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},o=new Map;let s=null,n=null;e.forEach(r=>{const u=r.metadata.type;a.hasOwnProperty(u)&&a[u]++;const d=this.getWeekNumberInfo(r.metadata.createdAt),f=`${d.year}-W${d.week}`;o.set(f,(o.get(f)||0)+1);const p=new Date(r.metadata.createdAt);(!s||p<new Date(s.metadata.createdAt))&&(s=r),(!n||p>new Date(n.metadata.createdAt))&&(n=r)});const l=Array.from(o.entries()).map(([r,u])=>{const[d,f]=r.split("-W");return{year:parseInt(d),week:parseInt(f),count:u}}).sort((r,u)=>r.year!==u.year?r.year-u.year:r.week-u.week);return{total:e.length,byType:a,byWeek:l,oldest:s,newest:n}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class be extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const fe={formed:{bitrixId:tt.formed,name:et.FORMED.name},review:{bitrixId:tt.review,name:et.REVIEW.name},execution:{bitrixId:tt.execution,name:et.EXECUTION.name}},Be=zt;function Kt(c){if(!c||typeof c!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!c.stages||!Array.isArray(c.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=Yt(c.stages),e=qt(c.stages),a=Xt(c.zeroPointTickets||{}),o=Jt(c.zeroPointTickets||{}),s=Zt(c.stages,c.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:o},ticketIds:s.ticketIds,tickets:s.tickets}}function Yt(c){const t={formed:{count:0,stageId:fe.formed.bitrixId,stageName:fe.formed.name},review:{count:0,stageId:fe.review.bitrixId,stageName:fe.review.name},execution:{count:0,stageId:fe.execution.bitrixId,stageName:fe.execution.name},total:0};return c.forEach(e=>{if(!fe[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(o=>{o.tickets&&Array.isArray(o.tickets)&&(a+=o.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function qt(c){const t=new Map;return c.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const o=t.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;fe[e.id]&&(o.ticketsByStage[e.id]=(o.ticketsByStage[e.id]||0)+s),o.totalTickets+=s})}),Array.from(t.values())}function Xt(c){let t=0,e=0;return!c||typeof c!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(c).forEach(a=>{Array.isArray(a)&&a.forEach(o=>{if(!o)return;const s=o.assignedTo||o.assignedById;!s||s===null?t++:(typeof s=="object"?s.id:s)===Be?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function Jt(c){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!c||typeof c!="object"||Object.keys(t).forEach(e=>{const a=c[e];Array.isArray(a)&&a.forEach(o=>{if(!o)return;const s=o.assignedTo||o.assignedById;!s||s===null?t[e].unassigned++:(typeof s=="object"?s.id:s)===Be?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function Zt(c,t){const e=new Set,a=new Map;return Array.isArray(c)&&c.forEach(o=>{!o.employees||!Array.isArray(o.employees)||o.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID:",n.id);return}e.add(l);let r=n.assignedTo;!r&&s.id&&(r={id:s.id,name:s.name||`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${s.id}`}),a.set(l,{id:l,title:n.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:r||null,createdAt:We(n.createdAt||n.createdTime),updatedAt:We(n.updatedAt||n.modifiedAt||n.updatedTime)})})})}),t&&typeof t=="object"&&Object.values(t).forEach(o=>{Array.isArray(o)&&o.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const n=parseInt(s.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",s.id);return}e.add(n);let l=s.assignedTo;if(!l&&s.assignedById){const r=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;r&&r!==Be?l={id:r,name:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹"}:r===Be&&(l={id:Be,name:"Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²"})}a.set(n,{id:n,title:s.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:l||null,createdAt:We(s.createdAt||s.createdTime),updatedAt:We(s.updatedAt||s.modifiedAt||s.updatedTime)})})}),{ticketIds:Array.from(e).sort((o,s)=>o-s),tickets:Array.from(a.values())}}function We(c){if(!c)return null;if(c instanceof Date)return c.toISOString();if(typeof c=="string"){if(c.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return c;const t=new Date(c);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",c),null}class nt{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:o=!0,includeTicketDetails:s=!1}=t;try{const n=await wt.getSectorData(e,a);return o?Kt(n):(s&&console.warn("includeTicketDetails Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾"),n)}catch(n){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",n),n}}static async isDataAvailable(){try{const t=await wt.getSectorData(!0);return t!=null}catch{return!1}}}class at{static compareTwoSnapshots(t,e,a={}){const{includeTickets:o=!1,includeEmployees:s=!0}=a,n=this.validateSnapshot(t),l=this.validateSnapshot(e);if(!n.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...l.errors].join(", "));const r=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),d=s?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],f=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),p=o?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,k=this.buildSummary(u,d,f,p);return{metadata:r,stages:u,employees:d,zeroPoint:f,tickets:p,summary:k}}static calculateDelta(t,e){const a=this.normalizeValue(t),o=this.normalizeValue(e),s=o-a;let n=0;a!==0?n=s/a*100:o!==0&&(n=o>0?1/0:-1/0);const l=this.getTrend(s);return{value1:a,value2:o,delta:s,deltaPercent:Math.round(n*100)/100,trend:l}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var l,r;const a=["formed","review","execution"],o={};for(const u of a){const d=((l=t[u])==null?void 0:l.count)||0,f=((r=e[u])==null?void 0:r.count)||0;o[u]=this.calculateDelta(d,f)}const s=t.total||0,n=e.total||0;return o.total=this.calculateDelta(s,n),o}static compareEmployees(t,e){var l,r;const a=new Map(t.map(u=>[u.id,u])),o=new Map(e.map(u=>[u.id,u])),s=new Set([...a.keys(),...o.keys()]),n=[];for(const u of s){const d=a.get(u)||null,f=o.get(u)||null;if(!d||!f){n.push({id:u,name:(d==null?void 0:d.name)||(f==null?void 0:f.name)||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",snapshot1:d?{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0}:null,snapshot2:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,delta:this.calculateEmployeeDelta(d,f),trend:d?"removed":"new"});continue}const p={},k=["formed","review","execution"];for(const h of k){const m=((l=d.ticketsByStage)==null?void 0:l[h])||0,y=((r=f.ticketsByStage)==null?void 0:r[h])||0;p[h]=this.calculateDelta(m,y)}const w=this.calculateDelta(d.totalTickets||0,f.totalTickets||0);n.push({id:u,name:d.name,snapshot1:{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0},snapshot2:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},delta:{ticketsByStage:p,totalTickets:w},trend:w.trend})}return n}static calculateEmployeeDelta(t,e){var n,l;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},o=["formed","review","execution"];for(const r of o){const u=((n=t==null?void 0:t.ticketsByStage)==null?void 0:n[r])||0,d=((l=e==null?void 0:e.ticketsByStage)==null?void 0:l[r])||0;a[r]=this.calculateDelta(u,d)}const s=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,o){var k,w;const s=new Set(t),n=new Set(e),l=e.filter(h=>!s.has(h)),r=t.filter(h=>!n.has(h)),u=[],d=[],f=new Map(a.map(h=>[h.id,h])),p=new Map(o.map(h=>[h.id,h]));for(const h of t){if(!n.has(h))continue;const m=f.get(h),y=p.get(h);if(!m||!y)continue;const T=(((k=m.assignedTo)==null?void 0:k.id)||null)!==(((w=y.assignedTo)==null?void 0:w.id)||null),j=(m.stageId||null)!==(y.stageId||null);T||j?u.push(h):d.push(h)}return{new:l,removed:r,changed:u,unchanged:d}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),o=new Date(e.metadata.createdAt),s=new Date,n=o.getTime()-a.getTime(),l=Math.floor(n/(1e3*60*60*24)),r=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:l,hours:r,minutes:u,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(t,e,a,o){var u,d,f;const s=t.total.delta,n=Object.keys(t).filter(p=>p==="total"?!1:t[p].delta!==0).length,l=e.filter(p=>p.trend==="new"||p.trend==="removed"?!0:p.delta.totalTickets.delta!==0).length,r=s!==0||n>0||l>0;return{totalDelta:s,stagesChanged:n,employeesChanged:l,hasChanges:r,newTicketsCount:((u=o==null?void 0:o.new)==null?void 0:u.length)||0,removedTicketsCount:((d=o==null?void 0:o.removed)==null?void 0:d.length)||0,changedTicketsCount:((f=o==null?void 0:o.changed)==null?void 0:f.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const o=["formed","review","execution"];for(const s of o)t.statistics.stages[s]||a.push(`Missing stage: ${s}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of t){const l=this.validateSnapshot(n);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const a=[...t].sort((n,l)=>{const r=new Date(n.metadata.createdAt),u=new Date(l.metadata.createdAt);return r-u}),o=[];for(let n=0;n<a.length-1;n++)o.push({from:n,to:n+1,result:this.compareTwoSnapshots(a[n],a[n+1],e)});const s=this.buildTrends(a);return{snapshots:a.map((n,l)=>({index:l,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:o,trends:s}}static buildTrends(t){var a,o,s,n,l,r,u,d,f,p;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const k of t){const w=k.statistics;e.stages.formed.push(((o=(a=w.stages)==null?void 0:a.formed)==null?void 0:o.count)||0),e.stages.review.push(((n=(s=w.stages)==null?void 0:s.review)==null?void 0:n.count)||0),e.stages.execution.push(((r=(l=w.stages)==null?void 0:l.execution)==null?void 0:r.count)||0),e.stages.total.push(((u=w.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((d=w.zeroPoint)==null?void 0:d.unassigned)||0),e.zeroPoint.keeper.push(((f=w.zeroPoint)==null?void 0:f.keeper)||0),e.zeroPoint.total.push(((p=w.zeroPoint)==null?void 0:p.total)||0)}return e}}const Qt={class:"stages-container"},ea={class:"stages-chips"},ta=["checked","disabled","onChange"],aa={class:"stage-chip-label"},sa={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:c=>c.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(c,{emit:t}){const e=c,a=t;function o(s,n){const l={...e.selected};l[s]=n,a("update:selected",l),a("change",s,n)}return(s,n)=>(S(),E("div",Qt,[n[0]||(n[0]=i("h4",{class:"stages-title"},"Ð­Ñ‚Ð°Ð¿Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:",-1)),i("div",ea,[(S(!0),E(re,null,ie(c.stages,l=>(S(),E("label",{key:l.id,class:Z(["stage-chip",{"stage-chip--active":c.selected[l.id],"stage-chip--disabled":c.disabled}])},[i("input",{type:"checkbox",checked:c.selected[l.id],disabled:c.disabled,onChange:r=>o(l.id,r.target.checked)},null,40,ta),i("span",{class:"stage-chip-color",style:me({backgroundColor:l.color})},null,4),i("span",aa,x(l.name),1)],2))),128))])]))}},na=he(sa,[["__scopeId","data-v-fe03c03c"]]),Dt=140,Ie=new Map;class oa{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await st.call("crm.item.list",{entityTypeId:Dt,filter:{id:t},select:["id","title","stageId","UF_CRM_7_DEPARTMENT_HEAD","createdTime","assignedById"],useOriginalUfNames:"Y"});if(!e.result||e.result.length===0)return console.warn(`Ticket with ID ${t} not found`),null;const a=e.result[0],o=kt(a),s=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||null;let n=null;if(s){const l=String(s).trim();l.length>0&&(n=l)}return{...o,departmentHeadFull:n}}catch(e){return console.error(`Error loading ticket details for ID ${t}:`,e),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(o=>{Ie.has(o)?e.push(Ie.get(o)):a.push(o)}),a.length===0)return e;try{const o=await st.call("crm.item.list",{entityTypeId:Dt,filter:{id:a},select:["id","title","stageId","UF_CRM_7_DEPARTMENT_HEAD","createdTime","assignedById"],useOriginalUfNames:"Y"});if(!o.result||!Array.isArray(o.result))return console.warn("Invalid response from Bitrix24 API"),e;const s=o.result.map(n=>{const l=kt(n),r=n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||null;let u=null;if(r){const f=String(r).trim();f.length>0&&(u=f)}const d={...l,departmentHeadFull:u};return d.id&&Ie.set(d.id,d),d});return[...e,...s]}catch(o){return console.error("Error loading tickets details batch:",o),e}}static clearCache(t=1e3){Ie.size>t&&Ie.clear()}static getCacheSize(){return Ie.size}}async function la(c,t,e,a=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:c,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!c||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const o=e.tickets.filter(d=>{const f=d.assignedTo;return f?(typeof f=="object"?f.id:f)===c:!1});if(o.length===0)return[];const s=!o[0].stageId||!o[0].departmentHead;let n=null;if(s){const d=o.map(f=>f.id);if(a&&typeof a=="object")n=a;else try{const f=await oa.getTicketsDetails(d);n=new Map,f.forEach(p=>{p&&p.id&&n.set(p.id,p)})}catch(f){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",f),n=null}}return o.map(d=>{const f=d.id,p={id:f,title:d.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:d.assignedTo,createdAt:d.createdAt,updatedAt:d.updatedAt};if(n){const k=n instanceof Map?n.get(f):n[f];k?(p.stageId=k.stageId||null,p.departmentHead=k.departmentHead||null,p.departmentHeadFull=k.departmentHeadFull||k.departmentHead||null):(p.stageId=null,p.departmentHead=null)}else p.stageId=d.stageId||null,p.departmentHead=d.departmentHead||null,p.departmentHeadFull=d.departmentHeadFull||d.departmentHead||null;return p}).filter(d=>d.stageId?Vt(d.stageId)===t:!0)}function Et(c,t=new Date){if(!c||c.length===0)return[];const e=c.length,a={};return Object.values(te).forEach(s=>{a[s]={category:s,label:St[s].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:St[s].color}}),c.forEach(s=>{if(!s.createdAt){a[te.MORE_THAN_YEAR].count++,a[te.MORE_THAN_YEAR].tickets.push(s);return}const n=Gt(s.createdAt,t);a[n]&&(a[n].count++,a[n].tickets.push(s))}),Object.values(a).filter(s=>s.count>0).map(s=>{const n=e>0?parseFloat((s.count/e*100).toFixed(1)):0;return{...s,percentage:n,progressBarWidth:n}}).sort((s,n)=>{const l=[te.TODAY,te.YESTERDAY,te.THIS_WEEK,te.LAST_WEEK,te.MORE_THAN_TWO_WEEKS,te.UP_TO_ONE_MONTH,te.MORE_THAN_TWO_MONTHS,te.MORE_THAN_HALF_YEAR,te.MORE_THAN_YEAR];return l.indexOf(s.category)-l.indexOf(n.category)})}function _t(c){if(!c||c.length===0)return[];const t={};c.forEach(a=>{let o=a.departmentHeadFull||a.departmentHead;o?(o=String(o).trim(),o.length===0&&(o="Ð‘ÐµÐ· Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°")):o="Ð‘ÐµÐ· Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°",t[o]||(t[o]={departmentName:o,count:0}),t[o].count++});const e=Object.values(t);return e.sort((a,o)=>o.count!==a.count?o.count-a.count:a.departmentName.localeCompare(o.departmentName,"ru")),e}const ra={class:"modal-content"},ia={key:"level-1",class:"level-1"},ca={class:"modal-header"},ua={class:"modal-total"},da={class:"view-switcher"},pa={class:"modal-body"},fa={key:0},ga={key:0,class:"no-employees"},ma={key:1,class:"employees-list"},ha=["onClick"],va={class:"employee-name"},ya={class:"employee-progress"},wa={class:"employee-count"},ka={key:0,class:"employee-item employee-others"},Sa={class:"employee-name"},ba={class:"employee-progress"},Da={class:"employee-count"},Ea={key:1,class:"view-time"},_a={key:0,class:"no-data"},Ca={key:1,class:"date-categories-list"},Ta=["onClick"],Aa={class:"category-label"},$a={class:"category-progress"},Ia={class:"category-count"},Ma={key:2,class:"view-departments"},Na={key:0,class:"no-data"},Ra={key:1,class:"departments-table-container"},Oa={class:"departments-table"},xa={class:"col-department"},Ba={class:"department-name"},Fa={class:"col-count"},Pa={class:"count-value"},La={key:"level-2",class:"level-2"},Ua={class:"modal-header"},Wa={class:"modal-total"},ja={class:"modal-body"},Ha={class:"stage-info"},za={class:"stage-badge"},Va={key:0,class:"no-data"},Ga={key:1,class:"date-categories-list"},Ka=["onClick"],Ya={class:"category-label"},qa={class:"category-progress"},Xa={class:"category-count"},Ja={key:"level-3",class:"level-3"},Za={class:"modal-header"},Qa={class:"header-info"},es={class:"header-badges"},ts={class:"date-badge"},as={class:"stage-badge"},ss={class:"modal-total"},ns={class:"modal-body"},os={key:0,class:"no-data"},ls={key:1,class:"departments-table-container"},rs={class:"departments-table"},is={class:"col-department"},cs={class:"department-name"},us={class:"col-count"},ds={class:"count-value"},ps={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null}},emits:["close"],setup(c,{emit:t}){const e=c,a=t,o=Pe(),s=A(1),n=A("employees"),l=A(null),r=A([]),u=A([]),d=A(null),f=A(null);K(()=>s.value>1),K(()=>{var C,R,M,$;switch(s.value){case 1:return((C=l.value)==null?void 0:C.stageName)||e.stageName;case 2:return((R=d.value)==null?void 0:R.employeeName)||"";case 3:return`${((M=d.value)==null?void 0:M.employeeName)||""} â€” ${(($=f.value)==null?void 0:$.dateCategoryLabel)||""}`;default:return""}});function p(){var C,R,M;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employeesCount:((C=e.employees)==null?void 0:C.length)||0,hasSnapshot:!!e.snapshot,snapshotTicketIds:((M=(R=e.snapshot)==null?void 0:R.ticketIds)==null?void 0:M.length)||0,hasTicketDetails:!!e.ticketDetails,snapshotKeys:e.snapshot?Object.keys(e.snapshot):[]}),l.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:l.value.stageId,hasSnapshot:!!l.value.snapshot,employeesCount:l.value.employees.length,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null"}),d.value=null,f.value=null,s.value=1,n.value="employees",k(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function k(){if(!(!l.value||!l.value.snapshot||!l.value.stageId))try{const C=l.value.snapshot.tickets||[],R=Et(C);r.value=R;const M=_t(C);u.value=M,console.log("[EmployeeDetailsModal] Level 1 view data loaded:",{timeCategoriesCount:R.length,departmentsCount:M.length})}catch(C){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",C)}}function w(C){if(!C||C.count===0){o.info(`Ð’ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ "${(C==null?void 0:C.label)||"Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ"}" Ð½ÐµÑ‚ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`);return}o.info(`Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ "${C.label}" Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸`)}xe(()=>e.isVisible,C=>{C?p():T()}),De(()=>{e.isVisible&&p()});async function h(C,R=null){var M,$,F;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",C),console.log("[EmployeeDetailsModal] Current popup level:",s.value),R&&R.currentTarget&&(R.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{R.currentTarget&&(R.currentTarget.style.transform="")},150)),!C||!C.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",C);return}if(l.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),l.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:l.value.stageId,stageName:l.value.stageName,hasSnapshot:!!l.value.snapshot,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null",snapshotKeys:l.value.snapshot?Object.keys(l.value.snapshot):[]}),!l.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID ÑÑ‚Ð°Ð´Ð¸Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"),o.warning("ID ÑÑ‚Ð°Ð´Ð¸Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½");return}if(!l.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Ð¡Ð»ÐµÐ¿Ð¾Ðº Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½"),console.error("[EmployeeDetailsModal] Props snapshot:",e.snapshot),o.warning("Ð¡Ð»ÐµÐ¿Ð¾Ðº Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",C.id,"stage:",l.value.stageId);const z=await la(C.id,l.value.stageId,l.value.snapshot,l.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(z==null?void 0:z.length)||0,z),!z||z.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),o.info(`Ð£ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ° "${C.name}" Ð½ÐµÑ‚ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð½Ð° ÑÑ‚Ð°Ð´Ð¸Ð¸ "${l.value.stageName}"`);return}const X=Et(z);console.log("[EmployeeDetailsModal] Date categories:",(X==null?void 0:X.length)||0,X),d.value={employeeId:C.id,employeeName:C.name,stageId:l.value.stageId,stageName:l.value.stageName,totalCount:z.length,dateCategories:X,snapshot:l.value.snapshot,ticketDetails:l.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:d.value.employeeName,totalCount:d.value.totalCount,dateCategoriesCount:d.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",d.value),s.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",s.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",d.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!d.value,employeeName:(M=d.value)==null?void 0:M.employeeName,dateCategoriesCount:((F=($=d.value)==null?void 0:$.dateCategories)==null?void 0:F.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",s.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",d.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(z){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",z),console.error("[EmployeeDetailsModal] Error stack:",z.stack),o.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ñ‚Ð¸ÐºÐµÑ‚Ð°Ñ…: "+z.message)}}function m(C){if(!C||C.count===0){o.info(`Ð’ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ "${(C==null?void 0:C.label)||"Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ"}" Ð½ÐµÑ‚ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`);return}if(!C.tickets||C.tickets.length===0){o.info(`Ð’ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ "${C.label}" Ð½ÐµÑ‚ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`);return}if(!d.value){console.error("Level 2 data not found");return}const R=_t(C.tickets);f.value={employeeId:d.value.employeeId,employeeName:d.value.employeeName,stageId:d.value.stageId,stageName:d.value.stageName,dateCategory:C.category,dateCategoryLabel:C.label,totalCount:C.count,departments:R,snapshot:d.value.snapshot,ticketDetails:d.value.ticketDetails},s.value=3}function y(){s.value===3?(s.value=2,f.value=null):s.value===2&&(s.value=1,d.value=null,f.value=null)}function T(){s.value=1,l.value=null,d.value=null,f.value=null}function j(){T(),a("close")}return(C,R)=>(S(),Me(Tt,{to:"body"},[c.isVisible?(S(),E("div",{key:0,class:"employee-details-modal",onClick:se(j,["self"]),onKeydown:Ot(j,["esc"])},[i("div",ra,[ae(Ge,{name:"level",mode:"out-in"},{default:Fe(()=>{var M,$,F,z,X,Q,Ee,_e,ce,Ce,ne,ve,Te;return[s.value===1?(S(),E("div",ia,[i("div",ca,[i("h3",null,x(((M=l.value)==null?void 0:M.stageName)||c.stageName),1),i("span",ua,"Ð’ÑÐµÐ³Ð¾: "+x((($=l.value)==null?void 0:$.totalCount)||c.totalCount)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",1),i("button",{class:"modal-close",onClick:j,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"Ã—")]),i("div",da,[i("button",{class:Z(["view-switch-btn",{active:n.value==="employees"}]),onClick:R[0]||(R[0]=L=>n.value="employees"),title:"ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼"}," ðŸ‘¥ ÐŸÐ¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼ ",2),i("button",{class:Z(["view-switch-btn",{active:n.value==="time"}]),onClick:R[1]||(R[1]=L=>n.value="time"),title:"ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼ Ð³Ñ€Ð°Ð´Ð°Ñ†Ð¸ÑÐ¼"}," ðŸ“… ÐŸÐ¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ",2),i("button",{class:Z(["view-switch-btn",{active:n.value==="departments"}]),onClick:R[2]||(R[2]=L=>n.value="departments"),title:"ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°Ð¼"}," ðŸ¢ ÐŸÐ¾ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°Ð¼ ",2)]),i("div",pa,[n.value==="employees"?(S(),E("div",fa,[(((F=l.value)==null?void 0:F.employees)||c.employees).length===0&&(!((z=l.value)!=null&&z.others||c.others)||(((X=l.value)==null?void 0:X.others)||c.others).count===0)?(S(),E("div",ga," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… ")):(S(),E("div",ma,[(S(!0),E(re,null,ie(((Q=l.value)==null?void 0:Q.employees)||c.employees,L=>(S(),E("div",{key:L.id,class:Z(["employee-item",{"employee-keeper":L.isKeeper}]),onClick:se(ee=>h(L,ee),["stop"]),title:"ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼ Ð³Ñ€Ð°Ð´Ð°Ñ†Ð¸ÑÐ¼"},[i("span",va,x(L.name),1),i("div",ya,[i("div",{class:"progress-bar",style:me({width:L.progressBarWidth+"%",backgroundColor:L.progressBarColor})},null,4)]),i("span",wa,x(L.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+x(L.percentage)+"%) ",1),R[3]||(R[3]=i("span",{class:"employee-arrow"},"â†’",-1))],10,ha))),128)),((Ee=l.value)!=null&&Ee.others||c.others)&&(((_e=l.value)==null?void 0:_e.others)||c.others).count>0?(S(),E("div",ka,[i("span",Sa,"Ð”Ñ€ÑƒÐ³Ð¸Ðµ ("+x((((ce=l.value)==null?void 0:ce.others)||c.others).employeeCount)+")",1),i("div",ba,[i("div",{class:"progress-bar",style:me({width:(((Ce=l.value)==null?void 0:Ce.others)||c.others).progressBarWidth+"%",backgroundColor:(((ne=l.value)==null?void 0:ne.others)||c.others).progressBarColor})},null,4)]),i("span",Da,x((((ve=l.value)==null?void 0:ve.others)||c.others).count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+x((((Te=l.value)==null?void 0:Te.others)||c.others).percentage)+"%) ",1)])):Y("",!0)]))])):n.value==="time"?(S(),E("div",Ea,[r.value.length===0?(S(),E("div",_a," Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…... ")):(S(),E("div",Ca,[(S(!0),E(re,null,ie(r.value,L=>(S(),E("div",{key:L.category,class:"category-item",onClick:se(ee=>w(L),["stop"])},[i("span",Aa,x(L.label),1),i("div",$a,[i("div",{class:"progress-bar",style:me({width:L.progressBarWidth+"%",backgroundColor:L.progressBarColor})},null,4)]),i("span",Ia,x(L.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+x(L.percentage)+"%) ",1),R[4]||(R[4]=i("span",{class:"category-arrow"},"â†’",-1))],8,Ta))),128))]))])):n.value==="departments"?(S(),E("div",Ma,[u.value.length===0?(S(),E("div",Na," Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…... ")):(S(),E("div",Ra,[i("table",Oa,[R[5]||(R[5]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº"),i("th",{class:"col-count"},"ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²")])],-1)),i("tbody",null,[(S(!0),E(re,null,ie(u.value,(L,ee)=>(S(),E("tr",{key:ee,class:"department-row"},[i("td",xa,[i("span",Ba,x(L.departmentName),1)]),i("td",Fa,[i("span",Pa,x(L.count),1)])]))),128))])])]))])):Y("",!0)])])):s.value===2&&d.value?(S(),E("div",La,[i("div",Ua,[i("button",{class:"btn-back",onClick:y,"aria-label":"ÐÐ°Ð·Ð°Ð´"}," â† "),i("h3",null,x(d.value.employeeName),1),i("span",Wa,"Ð’ÑÐµÐ³Ð¾: "+x(d.value.totalCount)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",1),i("button",{class:"modal-close",onClick:j,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"Ã—")]),i("div",ja,[i("div",Ha,[i("span",za,x(d.value.stageName),1)]),d.value.dateCategories.length===0?(S(),E("div",Va," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ñ‚Ð¸ÐºÐµÑ‚Ð°Ñ… ")):(S(),E("div",Ga,[(S(!0),E(re,null,ie(d.value.dateCategories,L=>(S(),E("div",{key:L.category,class:"category-item",onClick:se(ee=>m(L),["stop"])},[i("span",Ya,x(L.label),1),i("div",qa,[i("div",{class:"progress-bar",style:me({width:L.progressBarWidth+"%",backgroundColor:L.progressBarColor})},null,4)]),i("span",Xa,x(L.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+x(L.percentage)+"%) ",1)],8,Ka))),128))]))])])):s.value===3&&f.value?(S(),E("div",Ja,[i("div",Za,[i("button",{class:"btn-back",onClick:y,"aria-label":"ÐÐ°Ð·Ð°Ð´"}," â† "),i("div",Qa,[i("h3",null,x(f.value.employeeName),1),i("div",es,[i("span",ts,x(f.value.dateCategoryLabel),1),i("span",as,x(f.value.stageName),1)])]),i("span",ss,"Ð’ÑÐµÐ³Ð¾: "+x(f.value.totalCount)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",1),i("button",{class:"modal-close",onClick:j,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"Ã—")]),i("div",ns,[f.value.departments.length===0?(S(),E("div",os," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°Ñ… ")):(S(),E("div",ls,[i("table",rs,[R[6]||(R[6]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº"),i("th",{class:"col-count"},"ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²")])],-1)),i("tbody",null,[(S(!0),E(re,null,ie(f.value.departments,(L,ee)=>(S(),E("tr",{key:ee,class:"department-row"},[i("td",is,[i("span",cs,x(L.departmentName),1)]),i("td",us,[i("span",ds,x(L.count),1)])]))),128))])])]))])])):Y("",!0)]}),_:1})])],32)):Y("",!0)]))}},fs=he(ps,[["__scopeId","data-v-05bb5d6d"]]),Ne=10;function ze(c,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(o=>o.ticketsByStage&&o.ticketsByStage[c]>0).forEach(o=>{e.push({id:o.id,name:o.name,count:o.ticketsByStage[c]||0})});const a=gs(c,t);return a>0&&e.push({id:1051,name:"Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² (ÐÐµÑ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ)",count:a,isKeeper:!0}),e.sort((o,s)=>s.count-o.count)}function gs(c,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[c])return t.statistics.zeroPointByStage[c].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function It(c,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[c])==null?void 0:e.count)||0}function Ve(c,t=Ne){if(!c||c.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...c].sort((n,l)=>l.count-n.count),a=e.slice(0,t),o=e.slice(t),s=o.reduce((n,l)=>n+l.count,0);return{visible:a,others:{employees:o,count:s,employeeCount:o.length}}}function Mt(c,t){return!c||c.length===0?[]:t===0?c.map(e=>({...e,percentage:0})):c.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Nt(c,t,e="#007bff",a=Ne){if(!c||c.length===0)return{employees:[],others:null};const{visible:o,others:s}=Ve(c,a),n=Mt(o,t).map(r=>({...r,progressBarWidth:r.percentage,progressBarColor:r.isKeeper?"#f59e0b":e}));let l=null;if(s.count>0){const r=parseFloat((s.count/t*100).toFixed(1));l={...s,percentage:r,progressBarWidth:r,progressBarColor:"#6c757d"}}return{employees:n,others:l}}function ms(c,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(o=>{const s=t[o];if(!s)return;const n=ze(c,s),l=It(c,s);if(n.length===0)return;const{visible:r,others:u}=Ve(n,Ne),d=Mt(r,l);e[o]=d,u.count>0&&(e.others[o]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/l*100).toFixed(1))})}),e}function hs(c,t="current",e=[]){const a=c[t];if(!a)return{labels:[],datasets:[]};const o=new Map;e.forEach(f=>{ze(f.id,a).forEach(k=>{o.has(k.id)||o.set(k.id,{id:k.id,name:k.name,isKeeper:k.isKeeper||!1,ticketsByStage:{}}),o.get(k.id).ticketsByStage[f.id]=k.count})});const s=Array.from(o.values()).map(f=>{const p=Object.values(f.ticketsByStage).reduce((k,w)=>k+w,0);return{...f,totalTickets:p}});s.sort((f,p)=>p.totalTickets-f.totalTickets);const{visible:n,others:l}=Ve(s,Ne),r=e.map(()=>""),u={};e.forEach(f=>{const p=ze(f.id,a),{visible:k}=Ve(p,Ne);u[f.id]=k.map(w=>({id:w.id,name:w.name,count:w.count}))});const d=n.map((f,p)=>{const k=e.map(h=>f.ticketsByStage[h.id]||0),w=e.map(h=>{if((f.ticketsByStage[h.id]||0)===0)return"transparent";const T=h.color.replace("#",""),j=parseInt(T.substring(0,2),16),C=parseInt(T.substring(2,4),16),R=parseInt(T.substring(4,6),16),M=.6+p*.05;return`rgba(${j}, ${C}, ${R}, ${Math.min(M,.95)})`});return{label:f.name,data:k,backgroundColor:w,borderColor:e.map(h=>{const m=h.color.replace("#",""),y=parseInt(m.substring(0,2),16),T=parseInt(m.substring(2,4),16),j=parseInt(m.substring(4,6),16);return`rgba(${y}, ${T}, ${j}, 0.8)`}),borderWidth:1,meta:{employeeId:f.id,employeeName:f.name}}});if(l.count>0){const f=e.map(p=>l.employees.reduce((k,w)=>k+(w.ticketsByStage[p.id]||0),0));d.push({label:`Ð”Ñ€ÑƒÐ³Ð¸Ðµ (${l.employeeCount})`,data:f,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:r,datasets:d,meta:{employeesByStage:u}}}function vs(c,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(u=>u.id===c),o=a?a.name:"",s=a?a.color:"#007bff",n=ze(c,t),l=It(c,t);if(n.length===0)return{stageName:o,totalCount:0,employees:[],others:null};const r=Nt(n,l,s,Ne);return{stageName:o,totalCount:l,employees:r.employees,others:r.others}}function ys(c,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof c!="number"||c<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ 0.5"),e=.5);const a=[];if(t.forEach((n,l)=>{if(!n||!n.data||!Array.isArray(n.data))return;const r=n.data[c];r!=null&&!isNaN(r)&&a.push({datasetIndex:l,value:Number(r),y:Number(r)})}),a.length<2)return 0;const o=[];return a.forEach(n=>{let l=!1;for(const r of o){const u=r.y;if(Math.abs(n.y-u)<e){r.points.push(n),r.y=r.points.reduce((f,p)=>f+p.y,0)/r.points.length,l=!0;break}}l||o.push({points:[n],y:n.y})}),o.length===0?0:o.reduce((n,l)=>l.points.length>n.points.length?l:n,o[0]).points.length}function ws(c,t){const e=[];return c.forEach(a=>{let o=!1;for(const s of e){const n=s.y;if(Math.abs(a.value-n)<t){s.points.push(a),s.y=s.points.reduce((l,r)=>l+r.value,0)/s.points.length,o=!0;break}}o||e.push({points:[a],y:a.value})}),e}function ks(c,t=.5){var s,n;if(!c)return console.warn("findOverlappingPoints: chart Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½"),[];if(!c.config||c.config.type!=="line")return[];const e=(s=c.data)==null?void 0:s.datasets,a=((n=c.data)==null?void 0:n.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ 0.5"),t=.5);const o=[];return a.forEach((l,r)=>{try{if(ys(r,e,t)<2)return;const d=[];if(e.forEach((h,m)=>{if(!h||!h.data||!Array.isArray(h.data))return;const y=h.data[r];y==null||isNaN(y)||d.push({datasetIndex:m,value:Number(y),label:h.label||`Dataset ${m}`})}),d.length<2)return;const f=ws(d,t);if(f.length===0)return;const p=f.reduce((h,m)=>m.points.length>h.points.length?m:h,f[0]);if(p.points.length<2)return;let k=null,w=null;for(let h=0;h<e.length;h++)try{const m=c.getDatasetMeta(h);if(m&&m.data&&m.data[r]){k=m,w=m.data[r];break}}catch{continue}if(!w||typeof w.x!="number"||typeof w.y!="number")return;o.push({position:r,count:p.points.length,x:w.x,y:w.y,value:p.y,points:p.points.map(h=>({datasetIndex:h.datasetIndex,value:h.value,label:h.label}))})}catch(u){console.warn(`findOverlappingPoints: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ ${r}:`,u)}}),o}const Ss=.5,Ct=6,bs=2;function Ds(c){return typeof c!="number"||c<2?Ct:Ct+(c-1)*bs}function Es(c,t){if(!c||!c.ctx){console.warn("drawEnlargedPoint: chart Ð¸Ð»Ð¸ ctx Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=c.ctx,{x:o,y:s,points:n}=t,l=Ds(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(o,s,l,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&c.data&&c.data.datasets){const d=n[0].datasetIndex,f=c.data.datasets[d];if(f&&f.pointBackgroundColor){const p=Array.isArray(f.pointBackgroundColor)?f.pointBackgroundColor[t.position]||f.pointBackgroundColor[0]:f.pointBackgroundColor;if(p)if(p.startsWith("#")){const k=parseInt(p.slice(1,3),16),w=parseInt(p.slice(3,5),16),h=parseInt(p.slice(5,7),16);u=`rgba(${k}, ${w}, ${h}, 0.4)`}else p.startsWith("rgba")?u=p.replace(/rgba?\(([^)]+)\)/,(k,w)=>{const h=w.split(",").map(m=>m.trim());return`rgba(${h[0]}, ${h[1]}, ${h[2]}, 0.4)`}):u=p+"66"}}a.fillStyle=u,a.fill(),a.strokeStyle=u.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(u){console.warn("drawEnlargedPoint: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸:",u)}finally{a.restore()}}}const _s={id:"overlappingPointsPlugin",afterDatasetsDraw:c=>{if(!(!c||!c.config||c.config.type!=="line")&&c.ctx)try{const t=ks(c,Ss);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{Es(c,a)}catch(o){console.warn(`overlappingPointsPlugin: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ ${a.position}:`,o)}})}catch(t){console.warn("overlappingPointsPlugin: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² afterDatasetsDraw:",t)}}},Cs={class:"graph-state-chart"},Ts={class:"chart-header"},As={class:"chart-type-selector"},$s=["onClick","title"],Is={class:"chart-type-icon"},Ms={class:"chart-type-label"},Ns={key:0,class:"comparison-type-selector"},Rs={class:"radio-group"},Os={key:0},xs={key:1},Bs={key:2,class:"graph-legend"},Fs={key:4,class:"error-container"},Ps={class:"error-message"},Ls={key:5,class:"chart-container"},Us={class:"chart-wrapper"},Ws={class:"chart-canvas-container"},js={key:0,class:"bar-chart-stage-labels"},Hs={key:6,class:"no-data"},zs={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(c,{emit:t}){const e=(b,g)=>typeof window>"u"?g:getComputedStyle(document.documentElement).getPropertyValue(b).trim()||g,a=c,o=t,s=A(!1),n=A(null),l=A(null),r=A({weekStart:null,weekEnd:null,current:null}),u=A(null),d=A("weekStartToWeekEnd"),f=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],p=A("line"),k=A(!1),w=A(""),h=A(""),m=A(0),y=A([]),T=A(null),j=A(null),C=A(null),R=A([]),M=K(()=>{switch(p.value){case"line":return yt;case"bar":return Ht;case"doughnut":return jt;default:return yt}}),$={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},F=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:$.formed},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:$.review},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:$.execution}],z=["circle","triangle","rect","rectRot","star","cross","crossRot"],X=A({formed:!0,review:!0,execution:!0}),Q=Pe(),Ee={id:"employeeLabelsPlugin",afterDatasetsDraw:b=>{if(b.config.type==="bar")try{const g=b.ctx;if(!b.data||!b.data.datasets)return;const v=b.data.datasets,D=b.scales.y;v.forEach((_,N)=>{const I=b.getDatasetMeta(N);if(!I||I.hidden)return;const W=_.label||"";if(!W||W.includes("Ð”Ñ€ÑƒÐ³Ð¸Ðµ"))return;const U=W.trim().split(/\s+/);let B="";if(U.length===1)B=U[0];else{const P=U[0],G=U.slice(1).join(" ");B=`${P}
${G}`}const V=B.split(`
`);_.data.forEach((P,G)=>{if(P===0||!P)return;const q=I.data[G];if(!q||typeof q.x!="number"||typeof q.y!="number")return;const le=q.x,we=q.y+q.height+25;g.save(),g.font="bold 9px Arial, sans-serif",g.fillStyle="#6b7280",g.textAlign="center",g.textBaseline="top",g.translate(le,we),g.rotate(-12*Math.PI/180),V.forEach((de,ke)=>{const Se=de.trim();Se&&g.fillText(Se,0,ke*11)}),g.restore()})})}catch(g){console.error("Error in employeeLabelsPlugin:",g)}}};vt.register(Ee);function _e(){const b=new Map;[r.value.weekStart,r.value.weekEnd,r.value.current].forEach(g=>{!g||!g.statistics||!g.statistics.employees||g.statistics.employees.forEach(v=>{b.has(v.id)||b.set(v.id,{id:v.id,name:v.name})})}),R.value=Array.from(b.values()).sort((g,v)=>g.name.localeCompare(v.name))}function ce(b,g="background"){var D;return((D={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[b])==null?void 0:D[g])||e("--b24-text-secondary","#6c757d")}function Ce(){if(!(!r.value.weekStart||!r.value.weekEnd))try{const b=at.compareTwoSnapshots(r.value.weekStart,r.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let g=null,v=null;r.value.current&&(g=at.compareTwoSnapshots(r.value.weekEnd,r.value.current,{includeTickets:!1,includeEmployees:!0}),v=at.compareTwoSnapshots(r.value.weekStart,r.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:b,weekEndToCurrent:g,weekStartToCurrent:v}}catch(b){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ¾Ð²:",b),Q.warning("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ ÑÐ»ÐµÐ¿ÐºÐ¾Ð²: "+b.message)}}function ne(b){return{"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ":"formed","Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—":"review",Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ:"execution"}[b]||"formed"}function ve(b){return ne(b)}function Te(b){return b===0?"weekStart":b===1?"weekEnd":b===2?"current":"weekEnd"}function L(b){return r.value[b]||null}function ee(b,g,v,D,_=null,N=null,I=null){var W;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:b,stageId:g,totalCount:v,employeesCount:(D==null?void 0:D.length)||0,hasSnapshot:!!N,snapshotTicketIds:((W=N==null?void 0:N.ticketIds)==null?void 0:W.length)||0}),w.value=b,h.value=g||"",m.value=v,y.value=D||[],T.value=_&&_.count>0?_:null,j.value=N,C.value=I,k.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:h.value,hasCurrentSnapshot:!!j.value})}function Le(b,g,v){var W,U,B,V,P,G;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:b,timePoint:g,employeeDataCount:v==null?void 0:v.length});const D=F.find(q=>q.id===b);if(!D){console.warn("[GraphStateChart] Stage not found:",b);return}const _=L(g);if(console.log("[GraphStateChart] Snapshot for timePoint:",g,_?"found":"not found"),!_){console.warn("[GraphStateChart] Snapshot not found for timePoint:",g),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!r.value.weekStart,weekEnd:!!r.value.weekEnd,current:!!r.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!_.tickets,ticketsIsArray:Array.isArray(_.tickets),ticketsLength:((W=_.tickets)==null?void 0:W.length)||0,hasTicketIds:!!_.ticketIds,ticketIdsLength:((U=_.ticketIds)==null?void 0:U.length)||0,hasMetadata:!!_.metadata,hasStatistics:!!_.statistics,snapshotKeys:Object.keys(_),snapshotType:typeof _}),!_.tickets||!Array.isArray(_.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",_),Q.warning("Ð¡Ð»ÐµÐ¿Ð¾Ðº Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ñ‚Ð¸ÐºÐµÑ‚Ð°Ñ…");return}const N=((P=(V=(B=_.statistics)==null?void 0:B.stages)==null?void 0:V[b])==null?void 0:P.count)||0;console.log("[GraphStateChart] Total count for stage:",N);const I=Nt(v,N,D.color,10);console.log("[GraphStateChart] Opening modal with:",{stageName:D.name,stageId:b,totalCount:N,employeesCount:((G=I.employees)==null?void 0:G.length)||0,hasSnapshot:!!_,snapshotHasTickets:!!_.tickets}),ee(D.name,b,N,I.employees,I.others,_,null)}function Ye(b,g){if(!g||!g.employees||g.employees.length===0){Q.warning("ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð°");return}const v=r.value.current||r.value.weekEnd||r.value.weekStart;ee(g.stageName,b,g.totalCount,g.employees,g.others,v,null)}function O(){k.value=!1,w.value="",h.value="",m.value=0,y.value=[],T.value=null,j.value=null,C.value=null}function H(b,g,v){var V,P;if(p.value!=="line"||g.length===0)return;const D=g[0],_=D.datasetIndex,N=D.index,I=v.data.datasets[_];if(!I||!I.meta)return;const W=ve(I.label),U=Te(N),B=(P=(V=I.meta)==null?void 0:V.employees)==null?void 0:P[U];!B||B.length===0||Le(W,U,B)}function ue(b,g,v){var V,P;if(p.value!=="doughnut"||g.length===0)return;const _=g[0].index,N=v.data,I=N.labels[_],W=ve(I),U=(P=(V=N.datasets[0])==null?void 0:V.meta)==null?void 0:P.employees,B=U==null?void 0:U[W];if(!B){console.warn("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÑ‚Ð°Ð¿Ð°:",W);return}Ye(W,B)}function Ue(b){var D;const g=F[b];if(!g)return 0;const v=r.value.current||r.value.weekEnd||r.value.weekStart;return!v||!v.statistics||!v.statistics.stages?0:((D=v.statistics.stages[g.id])==null?void 0:D.count)||0}function oe(b){var _;const g=F.find(N=>N.id===b);if(!g)return"";const v=r.value.current||r.value.weekEnd||r.value.weekStart;if(!v||!v.statistics||!v.statistics.stages)return g.name;const D=((_=v.statistics.stages[b])==null?void 0:_.count)||0;return`${g.name} (${D})`}const Re=K(()=>{if(!l.value)return null;if(p.value==="doughnut"||p.value==="bar")return l.value;const b=l.value.datasets.filter(g=>{const v=F.find(D=>D.name===g.label);return v?X.value[v.id]:!0});return{...l.value,datasets:b}});K(()=>p.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const qe=K(()=>{const b={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:p.value==="bar"?{bottom:80}:{}},onClick:(g,v,D)=>{p.value==="line"?H(g,v,D):p.value==="doughnut"&&ue(g,v,D)},onHover:(g,v,D)=>{p.value==="doughnut"&&(g.native.target.style.cursor=v.length>0?"pointer":"default")},plugins:{legend:{display:p.value!=="bar",position:p.value==="doughnut"?"right":"top",onClick:(g,v,D)=>{if(p.value==="bar"){const N=v.datasetIndex;if(N!==void 0){const I=D.chart.getDatasetMeta(N);I.hidden=!I.hidden,D.chart.update()}return}const _=v.datasetIndex;if(_!==void 0){const N=D.chart.getDatasetMeta(_);N.hidden=!N.hidden,D.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:g=>{if(p.value==="bar"){const v=g[0].dataIndex,D=F[v];return D?D.name:""}return g[0].label||""},label:g=>{var N,I,W,U,B,V;const v=g.dataset.label||"",D=g.parsed.y||g.parsed||0,_=g.dataIndex;if(p.value==="bar"){const P=g.dataset,G=g.dataIndex,q=F[G],le=q?q.name:"";return`${P.label}: ${D} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ "${le}"`}if(p.value==="doughnut"){const P=g.dataset.data.reduce((q,le)=>q+le,0),G=P>0?(D/P*100).toFixed(1):0;return`${v}: ${D} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² (${G}%)`}else{if(!u.value||_===0)return`${v}: ${D} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;let P=null;const G=ne(v);if(d.value==="weekStartToWeekEnd"&&_===1?P=(I=(N=u.value.weekStartToWeekEnd)==null?void 0:N.stages)==null?void 0:I[G]:d.value==="weekEndToCurrent"&&_===2&&r.value.current?P=(U=(W=u.value.weekEndToCurrent)==null?void 0:W.stages)==null?void 0:U[G]:d.value==="weekStartToCurrent"&&_===2&&r.value.current&&(P=(V=(B=u.value.weekStartToCurrent)==null?void 0:B.stages)==null?void 0:V[G]),!P)return`${v}: ${D} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;const q=P.delta,le=P.deltaPercent,we=P.trend;let de=`${v}: ${D} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;if(q!==0){const ke=q>0?"+":"",Se=we==="increase"?"â†‘":we==="decrease"?"â†“":"â†’";de+=` (${ke}${q}, ${ke}${le.toFixed(1)}%) ${Se}`}else de+=" (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)";return de}},afterBody:g=>{if(p.value==="bar"&&g.length>0){const N=g[0];N.dataset;const I=N.parsed.y||0,W=N.dataIndex,U=Ue(W);return[`${U>0?(I/U*100).toFixed(1):0}% Ð¾Ñ‚ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÑ‚Ð°Ð¿Ð°`]}if(p.value==="doughnut"&&g.length>0)return["ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼"];if(p.value==="line"){const N=[];if(u.value){const I=g[0].dataIndex;if(I!==0){let W=null;if(ne(g[0].dataset.label||""),d.value==="weekStartToWeekEnd"&&I===1?W=u.value.weekStartToWeekEnd:d.value==="weekEndToCurrent"&&I===2?W=u.value.weekEndToCurrent:d.value==="weekStartToCurrent"&&I===2&&(W=u.value.weekStartToCurrent),W&&W.metadata){const U=W.metadata.timeDiff;N.push(`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${U.days} Ð´Ð½. ${U.hours} Ñ‡. ${U.minutes} Ð¼Ð¸Ð½.`)}}}return N.push("ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼"),N}if(!u.value)return[];const v=g[0].dataIndex;if(v===0)return[];let D=null;if(ne(g[0].dataset.label||""),d.value==="weekStartToWeekEnd"&&v===1?D=u.value.weekStartToWeekEnd:d.value==="weekEndToCurrent"&&v===2?D=u.value.weekEndToCurrent:d.value==="weekStartToCurrent"&&v===2&&(D=u.value.weekStartToCurrent),!D||!D.metadata)return[];const _=D.metadata.timeDiff;return[`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${_.days} Ð´Ð½. ${_.hours} Ñ‡. ${_.minutes} Ð¼Ð¸Ð½.`]}}},title:{display:!1}}};return p.value==="line"||p.value==="bar"?{...b,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:p.value==="doughnut"?{...b,cutout:"60%"}:b});function Ae(b){const g=new Date(b),v=g.getFullYear(),D=String(g.getMonth()+1).padStart(2,"0"),_=String(g.getDate()).padStart(2,"0");return`${v}-${D}-${_}`}function Xe(b){const{current:g,weekEnd:v}=b,D=g||v;if(!D||!D.statistics||!D.statistics.stages)return null;const _=[],N=[],I=[],W=[],U={};return F.forEach(B=>{var P;const V=((P=D.statistics.stages[B.id])==null?void 0:P.count)||0;if(V>0){_.push(B.name),N.push(V),I.push(B.color+"80"),W.push(B.color);const G=vs(B.id,D,F);G&&G.employees&&(U[B.id]=G)}}),N.length===0?null:{labels:_,datasets:[{label:"Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÑ‚Ð°Ð¿Ð°Ð¼",data:N,backgroundColor:I,borderColor:W,borderWidth:2,meta:{employees:U}}]}}function Je(b){if(p.value==="doughnut")return Xe(b);if(p.value==="bar"){const I=a.showCurrentState&&b.current?"current":b.weekEnd?"weekEnd":"weekStart";return hs(b,I,F)}const{weekStart:g,weekEnd:v,current:D}=b,_=[],N=[];return F.forEach((I,W)=>{var le,we,de,ke,Se,ot,lt,rt,it,ct,ut,dt,pt,ft,gt,mt,ht;const U=[];if(g&&g.statistics&&g.statistics.stages){const J=g.statistics.stages[I.id];if(_.length===0){const Oe=(le=g.metadata)!=null&&le.createdAt?new Date(g.metadata.createdAt):null;_.push(Oe?Ae(Oe):"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸")}U.push((J==null?void 0:J.count)||0)}else _.length===0&&_.push("ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸"),U.push(0);if(v&&v.statistics&&v.statistics.stages){const J=v.statistics.stages[I.id];if(_.length===1){const Oe=(we=v.metadata)!=null&&we.createdAt?new Date(v.metadata.createdAt):null;_.push(Oe?Ae(Oe):"ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸")}U.push((J==null?void 0:J.count)||0)}else _.length===1&&_.push("ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸"),U.push(0);if(D&&a.showCurrentState&&D.statistics&&D.statistics.stages){const J=D.statistics.stages[I.id];_.length===2&&_.push("Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ"),U.push((J==null?void 0:J.count)||0)}const B=["stable"];u.value?d.value==="weekStartToWeekEnd"?(B.push(((Se=(ke=(de=u.value.weekStartToWeekEnd)==null?void 0:de.stages)==null?void 0:ke[I.id])==null?void 0:Se.trend)||"stable"),D&&B.push(((rt=(lt=(ot=u.value.weekStartToCurrent)==null?void 0:ot.stages)==null?void 0:lt[I.id])==null?void 0:rt.trend)||"stable")):d.value==="weekEndToCurrent"&&D?(B.push("stable"),B.push(((ut=(ct=(it=u.value.weekEndToCurrent)==null?void 0:it.stages)==null?void 0:ct[I.id])==null?void 0:ut.trend)||"stable")):d.value==="weekStartToCurrent"&&D?(B.push(((ft=(pt=(dt=u.value.weekStartToWeekEnd)==null?void 0:dt.stages)==null?void 0:pt[I.id])==null?void 0:ft.trend)||"stable"),B.push(((ht=(mt=(gt=u.value.weekStartToCurrent)==null?void 0:gt.stages)==null?void 0:mt[I.id])==null?void 0:ht.trend)||"stable")):(B.push("stable"),D&&B.push("stable")):(B.push("stable"),D&&B.push("stable"));let V,P,G;u.value&&p.value!=="doughnut"?(V=B.map(J=>ce(J,"background")+"40"),P=B.map(J=>ce(J,"border")),G=B.map(J=>ce(J,"point"))):(V=I.color+"40",P=I.color,G=I.color);let q=null;p.value==="line"&&(q={employees:ms(I.id,b)}),N.push({label:I.name,data:U,backgroundColor:(Array.isArray(V),V),borderColor:(Array.isArray(P),P),borderWidth:2,...p.value==="line"&&{pointStyle:z[W%z.length]},pointBackgroundColor:(Array.isArray(G),G),pointBorderColor:(Array.isArray(P),P),pointRadius:6,pointHoverRadius:8,fill:p.value!=="line",tension:p.value==="line"?.4:0,meta:q})}),_.length===0&&(_.push("ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸","ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸"),a.showCurrentState&&_.push("Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ")),{labels:_,datasets:N}}const Ze=async()=>{var b,g,v;s.value=!0,n.value=null;try{const D=(b=a.period)!=null&&b.endDate?new Date(a.period.endDate):new Date,_=(g=a.period)!=null&&g.startDate?new Date(a.period.startDate):ge.getWeekStartDate(D),N=(v=a.period)!=null&&v.endDate?new Date(a.period.endDate):ge.getWeekEndDate(D),I=ge.formatDate(_),W=ge.formatDate(N),[U,B]=await Promise.all([ge.getSnapshot(I,"week_start"),ge.getSnapshot(W,"week_end")]);let V=null;a.showCurrentState&&(V=await nt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),r.value={weekStart:U,weekEnd:B,current:V},_e(),Ce(),ye(),o("data-loaded",{weekStart:U,weekEnd:B,current:V})}catch(D){console.error("Error loading chart data:",D),n.value=D.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",Q.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°: "+n.value),o("error",n.value)}finally{s.value=!1}};De(()=>{vt.register(_s),Ze()});function Rt(b){X.value=b}const ye=()=>{var g;const b=Je({weekStart:r.value.weekStart,weekEnd:r.value.weekEnd,current:r.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==((g=b==null?void 0:b.labels)==null?void 0:g.length))l.value=b;else if(b){const v=JSON.stringify(l.value),D=JSON.stringify(b);v!==D&&(l.value=b)}};return xe(()=>[a.period,a.showCurrentState],()=>{Ze()},{deep:!0}),xe(p,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&ye()}),xe(d,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&ye()}),(b,g)=>(S(),E("div",Cs,[i("div",Ts,[g[3]||(g[3]=i("h3",{class:"chart-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),i("div",As,[(S(),E(re,null,ie(f,v=>i("button",{key:v.value,onClick:D=>p.value=v.value,class:Z(["chart-type-btn",{active:p.value===v.value}]),title:v.label},[i("span",Is,x(v.icon),1),i("span",Ms,x(v.label),1)],10,$s)),64))])]),!s.value&&!n.value&&u.value&&p.value!=="doughnut"?(S(),E("div",Ns,[g[7]||(g[7]=i("h4",{class:"comparison-title"},"Ð¢Ð¸Ð¿ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ:",-1)),i("div",Rs,[i("label",null,[je(i("input",{type:"radio","onUpdate:modelValue":g[0]||(g[0]=v=>d.value=v),value:"weekStartToWeekEnd",onChange:ye},null,544),[[Qe,d.value]]),g[4]||(g[4]=i("span",null,"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸",-1))]),r.value.current?(S(),E("label",Os,[je(i("input",{type:"radio","onUpdate:modelValue":g[1]||(g[1]=v=>d.value=v),value:"weekEndToCurrent",onChange:ye},null,544),[[Qe,d.value]]),g[5]||(g[5]=i("span",null,"ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ",-1))])):Y("",!0),r.value.current?(S(),E("label",xs,[je(i("input",{type:"radio","onUpdate:modelValue":g[2]||(g[2]=v=>d.value=v),value:"weekStartToCurrent",onChange:ye},null,544),[[Qe,d.value]]),g[6]||(g[6]=i("span",null,"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ",-1))])):Y("",!0)])])):Y("",!0),!s.value&&!n.value&&l.value?(S(),Me(na,{key:1,stages:F,selected:X.value,"onUpdate:selected":Rt,onChange:ye},null,8,["selected"])):Y("",!0),!s.value&&!n.value&&u.value&&p.value!=="doughnut"?(S(),E("div",Bs,[...g[8]||(g[8]=[xt('<h4 class="legend-title" data-v-8956dc9f>Ð›ÐµÐ³ÐµÐ½Ð´Ð°:</h4><div class="legend-items" data-v-8956dc9f><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-increase" data-v-8956dc9f></span><span data-v-8956dc9f>Ð—ÐµÐ»Ñ‘Ð½Ñ‹Ð¹ â€” Ñ€Ð¾ÑÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-decrease" data-v-8956dc9f></span><span data-v-8956dc9f>ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹ â€” ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-stable" data-v-8956dc9f></span><span data-v-8956dc9f>Ð¡ÐµÑ€Ñ‹Ð¹ â€” Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹</span></div></div>',2)])])):Y("",!0),s.value?(S(),Me(At,{key:3,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°..."})):n.value?(S(),E("div",Fs,[i("p",Ps,"âŒ "+x(n.value),1),i("button",{onClick:Ze,class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ")])):Re.value?(S(),E("div",Ls,[i("div",Us,[i("div",Ws,[(S(),Me(Bt(M.value),{data:Re.value,options:qe.value},null,8,["data","options"]))]),p.value==="bar"?(S(),E("div",js,[(S(),E(re,null,ie(F,v=>i("div",{key:v.id,class:"stage-label-item"},x(oe(v.id)),1)),64))])):Y("",!0)])])):(S(),E("div",Hs,[...g[9]||(g[9]=[i("p",null,"ðŸ“Š ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",-1),i("p",{class:"no-data-hint"},"Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ»ÐµÐ¿ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",-1)])])),ae(fs,{"is-visible":k.value,"stage-name":w.value,"stage-id":h.value,"total-count":m.value,employees:y.value,others:T.value,snapshot:j.value,"ticket-details":C.value,onClose:O},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details"])]))}},Vs=he(zs,[["__scopeId","data-v-8956dc9f"]]),Gs={key:0,class:"create-snapshot-button-container"},Ks=["disabled"],Ys={class:"modal-content"},qs={class:"modal-header"},Xs=["disabled"],Js={class:"modal-body"},Zs={key:0,class:"progress-container"},Qs={class:"progress-bar-wrapper"},en={class:"progress-text"},tn={class:"progress-percent"},an={class:"progress-description"},sn={key:1},nn={class:"modal-footer"},on=["disabled"],ln=["disabled"],rn={key:0},cn={key:0},un={key:1},dn={key:2},pn={key:1},fn={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(c,{emit:t}){const e=c,a=t,o=A(e.user),s=A(!1),n=A(!1),l=A(0),r=A("idle"),u=A(""),d=Pe(),f=K(()=>o.value?Ft(o.value):!1);De(async()=>{if(!e.user)try{const m=await $t.checkAccess();m.allowed&&(o.value=m.user)}catch(m){console.error("Error loading user:",m)}});const p=()=>{if(!f.value){d.warning("Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿ÐºÐ¸");return}s.value=!0},k=()=>{n.value||(s.value=!1,r.value="idle",l.value=0,u.value="")},w=async()=>{if(!n.value){if(!f.value){d.warning("Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿ÐºÐ¸");return}n.value=!0,r.value="loading_data",l.value=0,u.value="Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…...";try{u.value="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ð¸Ð· Bitrix24...";const m=await nt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:j=>{var R;const C=Math.min(80,(j.progress||0)*.8);l.value=C,r.value="loading_data",u.value=j.description||((R=j.details)==null?void 0:R.description)||"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°..."}});r.value="creating_snapshot",l.value=85,u.value="Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ¿ÐºÐ°...";const y=o.value;if(!y)throw new Error("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½");const T=await ge.createSnapshot(m,"manual",{createdBy:{id:y.ID,name:`${y.NAME||""} ${y.LAST_NAME||""}`.trim()||y.EMAIL||`User ${y.ID}`},sectorId:"1C"});r.value="success",l.value=100,u.value="Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!",d.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"),a("snapshot-created",T),setTimeout(()=>{k()},1500)}catch(m){r.value="error",l.value=0,u.value="ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°",console.error("Error creating snapshot:",m);let y="ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°";m.message&&(m.message.includes("Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…")||m.message.includes("sector data")?y="ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Bitrix24.":m.message.includes("ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°")||m.message.includes("snapshot")?y="ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.":m.message.includes("Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†")||m.message.includes("validation")?y="ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð°.":y=m.message),d.error(y)}finally{n.value=!1}}},h=m=>{m.key==="Escape"&&s.value&&!n.value&&k()};return De(()=>{window.addEventListener("keydown",h)}),Ke(()=>{window.removeEventListener("keydown",h)}),(m,y)=>f.value?(S(),E("div",Gs,[i("button",{class:"create-snapshot-btn",onClick:p,disabled:n.value,title:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð°"},[...y[1]||(y[1]=[i("span",{class:"btn-icon"},"ðŸ“¸",-1),i("span",{class:"btn-text"},"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº",-1)])],8,Ks),(S(),Me(Tt,{to:"body"},[ae(Ge,{name:"modal"},{default:Fe(()=>[s.value?(S(),E("div",{key:0,class:"modal-overlay",onClick:y[0]||(y[0]=se(T=>!n.value&&k(),["self"]))},[i("div",Ys,[i("div",qs,[y[2]||(y[2]=i("h3",{class:"modal-title"},"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð°",-1)),i("button",{class:"modal-close",onClick:k,disabled:n.value,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ",8,Xs)]),i("div",Js,[r.value!=="idle"?(S(),E("div",Zs,[i("div",Qs,[i("div",{class:"progress-bar",style:me({width:`${l.value}%`})},null,4)]),i("div",en,[i("span",tn,x(Math.round(l.value))+"%",1),i("span",an,x(u.value),1)])])):(S(),E("div",sn,[...y[3]||(y[3]=[i("p",{class:"modal-description"},' Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ ÑÐ»ÐµÐ¿Ð¾Ðº Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡. Ð¡Ð»ÐµÐ¿Ð¾Ðº Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼ "manual" (Ñ€ÑƒÑ‡Ð½Ð¾Ð¹). ',-1),i("p",{class:"modal-warning"}," âš ï¸ ÐŸÑ€Ð¾Ñ†ÐµÑÑ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ° Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ. ",-1)])]))]),i("div",nn,[i("button",{class:"btn btn-secondary",onClick:k,disabled:n.value}," ÐžÑ‚Ð¼ÐµÐ½Ð° ",8,on),i("button",{class:"btn btn-primary",onClick:w,disabled:n.value},[n.value?(S(),E("span",rn,[r.value==="loading_data"?(S(),E("span",cn,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…...")):r.value==="creating_snapshot"?(S(),E("span",un,"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...")):(S(),E("span",dn,"ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°..."))])):(S(),E("span",pn,"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"))],8,ln)])])])):Y("",!0)]),_:1})]))])):Y("",!0)}},gn=he(fn,[["__scopeId","data-v-09bccee2"]]),mn=20,hn=5*60*1e3;async function vn({search:c="",limit:t=mn,sectorDepartmentId:e=bt.SECTOR_1C}={}){const a=`sector1c_employees_${c}_${t}_${e||"all"}`,o=sessionStorage.getItem(a);if(o)try{const{data:s,timestamp:n}=JSON.parse(o);if(Date.now()-n<hn)return s}catch(s){console.warn("[sector1cEmployees] Cache parse error:",s)}try{const s={ACTIVE:"Y"};e?Array.isArray(e)?s.UF_DEPARTMENT=e:s.UF_DEPARTMENT=[e]:s.UF_DEPARTMENT=[bt.SECTOR_1C],c&&c.length>=2&&(s["%NAME"]=c,s["%LAST_NAME"]=c,s["%WORK_POSITION"]=c);const r=((await st.call("user.get",{filter:s,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:yn(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:r,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return r}catch(s){throw console.error("[sector1cEmployees] ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²:",s),new Error(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²: ${s.message}`)}}function yn(c){const t=[c.LAST_NAME,c.NAME,c.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):c.NAME||"Ð‘ÐµÐ· Ð¸Ð¼ÐµÐ½Ð¸"}const wn={class:"employee-select-field-text"},kn={key:0,class:"employee-select-dropdown"},Sn={class:"employee-select-dropdown-search"},bn={key:0,class:"employee-select-state"},Dn={key:1,class:"employee-select-state employee-select-state--error"},En={key:2,class:"employee-select-state"},_n=["checked"],Cn=["checked","onChange"],Tn={class:"employee-select-item-content"},An={class:"employee-select-item-name"},$n={key:0,class:"employee-select-item-position"},In={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(c,{emit:t}){const e=c,a=t,o=A(null),s=A(null),n=A(""),l=A([]),r=A(!1),u=A(null),d=A(!1),f=K(()=>{if(!n.value)return l.value;const M=n.value.toLowerCase();return l.value.filter($=>$.name.toLowerCase().includes(M)||$.position&&$.position.toLowerCase().includes(M))}),p=K(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const M=l.value.find($=>$.id===e.selected[0]);return M?M.name:e.placeholder}return`Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: ${e.selected.length} ${C(e.selected.length,"ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°","ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²","ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²")}`});async function k(M=""){r.value=!0,u.value=null;try{l.value=await vn({search:M})}catch($){u.value=$,a("error",$)}finally{r.value=!1}}function w(){a("search",n.value)}function h(){r.value||(d.value=!d.value,d.value?(l.value.length===0&&k(),Lt(()=>{s.value&&s.value.focus()})):n.value="")}function m(M){o.value&&!o.value.contains(M.target)&&(d.value=!1,n.value="")}function y(M){const $=[...e.selected],F=$.indexOf(M);if(M==="all")if(F>-1)$.splice(F,1);else return a("update:selected",["all"]);else if(F>-1)$.splice(F,1);else{const z=$.indexOf("all");z>-1&&$.splice(z,1),$.push(M)}a("update:selected",$)}function T(M){return M==="all"?e.selected.includes("all"):e.selected.includes(M)||e.selected.includes("all")}const j=K(()=>n.value?`ÐÐµÑ‚ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ "${n.value}"`:"ÐÐµÑ‚ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡");function C(M,$,F,z){const X=M%10,Q=M%100;return Q>=11&&Q<=19?z:X===1?$:X>=2&&X<=4?F:z}function R(){k(n.value)}return xe(()=>e.selected,M=>{(!M||M.length===0)&&a("update:selected",["all"])},{immediate:!0}),De(()=>{document.addEventListener("click",m),(!e.selected||e.selected.length===0)&&a("update:selected",["all"])}),Ke(()=>{document.removeEventListener("click",m)}),(M,$)=>(S(),E("div",{class:"employee-select",ref_key:"selectContainer",ref:o},[i("div",{class:Z(["employee-select-field",{"employee-select-field--open":d.value,"employee-select-field--disabled":r.value}]),onClick:h},[i("span",wn,x(p.value),1),i("span",{class:Z(["employee-select-field-icon",{open:d.value}])},"â–¼",2)],2),ae(Ge,{name:"dropdown-fade"},{default:Fe(()=>[d.value?(S(),E("div",kn,[i("div",Sn,[je(i("input",{"onUpdate:modelValue":$[0]||($[0]=F=>n.value=F),type:"text",placeholder:"ðŸ” ÐŸÐ¾Ð¸ÑÐº ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°...",class:"employee-select-search-input",onInput:w,onClick:$[1]||($[1]=se(()=>{},["stop"])),ref_key:"searchInput",ref:s},null,544),[[Pt,n.value]])]),r.value?(S(),E("div",bn,[...$[6]||($[6]=[i("span",{class:"spinner"},"â³",-1),i("span",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡...",-1)])])):u.value?(S(),E("div",Dn,[i("span",null,"âŒ "+x(u.value.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²"),1),i("button",{onClick:[R,$[2]||($[2]=se(()=>{},["stop"]))],class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ")])):!r.value&&f.value.length===0&&!u.value?(S(),E("div",En,[i("span",null,"ðŸ“­ "+x(j.value),1)])):(S(),E("div",{key:3,class:"employee-select-list",style:me({maxHeight:`${c.maxHeight}px`})},[i("label",{class:Z(["employee-select-item",{"employee-select-item--selected":T("all")}]),onClick:$[4]||($[4]=se(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T("all"),onChange:$[3]||($[3]=F=>y("all"))},null,40,_n),$[7]||($[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"Ð’ÑÐµ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸")],-1))],2),(S(!0),E(re,null,ie(f.value,F=>(S(),E("label",{key:F.id,class:Z(["employee-select-item",{"employee-select-item--selected":T(F.id)}]),onClick:$[5]||($[5]=se(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T(F.id),onChange:z=>y(F.id)},null,40,Cn),i("div",Tn,[i("span",An,x(F.name),1),F.position?(S(),E("span",$n,x(F.position),1)):Y("",!0)])],2))),128))],4))])):Y("",!0)]),_:1})],512))}},Mn=he(In,[["__scopeId","data-v-6b8c949b"]]),Nn={class:"stage-select-field-text"},Rn={key:0,class:"stage-select-dropdown"},On={class:"stage-select-list"},xn=["checked"],Bn=["checked","onChange"],Fn={class:"stage-select-item-content"},Pn={class:"stage-select-item-name"},Ln={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff"},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107"},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745"}]},placeholder:{type:String,default:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð¿Ñ‹"}},emits:["update:selected","change"],setup(c,{emit:t}){const e=c,a=t,o=A(null),s=A(!1),n=K(()=>Object.values(e.selected).every(p=>p===!0)),l=K(()=>{if(n.value)return e.placeholder;const p=e.stages.filter(k=>e.selected[k.id]);return p.length===0?"Ð­Ñ‚Ð°Ð¿Ñ‹ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹":p.length===1?p[0].name:`Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: ${p.length} ÑÑ‚Ð°Ð¿Ð°(Ð¾Ð²)`});function r(){s.value=!s.value,s.value}function u(p){o.value&&!o.value.contains(p.target)&&(s.value=!1)}function d(p,k){const w={...e.selected};w[p]=k,a("update:selected",w),a("change",p,k)}function f(){const p=n.value,k={};e.stages.forEach(w=>{k[w.id]=!p}),a("update:selected",k),a("change","all",!p)}return De(()=>{document.addEventListener("click",u)}),Ke(()=>{document.removeEventListener("click",u)}),(p,k)=>(S(),E("div",{class:"stage-select",ref_key:"selectContainer",ref:o},[i("div",{class:Z(["stage-select-field",{"stage-select-field--open":s.value,"stage-select-field--disabled":!1}]),onClick:r},[i("span",Nn,x(l.value),1),i("span",{class:Z(["stage-select-field-icon",{open:s.value}])},"â–¼",2)],2),ae(Ge,{name:"dropdown-fade"},{default:Fe(()=>[s.value?(S(),E("div",Rn,[i("div",On,[i("label",{class:Z(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:k[0]||(k[0]=se(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:n.value,onChange:f},null,40,xn),k[2]||(k[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"Ð’ÑÐµ ÑÑ‚Ð°Ð¿Ñ‹")],-1))],2),(S(!0),E(re,null,ie(c.stages,w=>(S(),E("label",{key:w.id,class:Z(["stage-select-item",{"stage-select-item--selected":c.selected[w.id]}]),onClick:k[1]||(k[1]=se(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:c.selected[w.id],onChange:h=>d(w.id,h.target.checked)},null,40,Bn),i("div",Fn,[i("span",{class:"stage-select-item-color",style:me({backgroundColor:w.color})},null,4),i("span",Pn,x(w.name),1)])],2))),128))])])):Y("",!0)]),_:1})],512))}},Un=he(Ln,[["__scopeId","data-v-ce2229b2"]]),Wn={class:"filters-panel"},jn={class:"filters-header"},Hn=["disabled"],zn={class:"filters-content"},Vn={class:"filter-section"},Gn={class:"section-content"},Kn={class:"filter-section"},Yn={class:"section-content"},qn={class:"filter-section"},Xn={class:"section-content"},Jn=["value"],Zn={key:0,class:"custom-date-range"},Qn={class:"date-range-inputs"},eo={class:"date-input-group"},to=["value","max"],ao={class:"date-input-group"},so=["value","min","max"],no={key:0,class:"filter-error"},oo={key:1,class:"filter-hint"},lo={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(c,{emit:t}){const e=c,a=t,o=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"var(--b24-success, #28a745)"}],s=A(null),n=K(()=>{const w=new Date;return w.setFullYear(w.getFullYear()-1),w.toISOString().split("T")[0]}),l=K(()=>new Date().toISOString().split("T")[0]);function r(w){a("update:stages",w),a("apply")}function u(w,h){a("apply")}function d(w){a("update:employees",w),a("apply")}function f(w){a("update:dateRange",w),s.value=null,a("apply")}function p(w,h){const m={...e.customDateRange};if(m[w]=h,m.startDate&&m.endDate){const y=new Date(m.startDate),T=new Date(m.endDate);if(y>T){s.value="ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð°Ñ‚Ð° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ð¹";return}if(Math.ceil((T-y)/(1e3*60*60*24))>365){s.value="ÐŸÐµÑ€Ð¸Ð¾Ð´ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 365 Ð´Ð½ÐµÐ¹";return}}s.value=null,a("update:customDateRange",m),a("apply")}function k(){s.value=null,a("reset")}return(w,h)=>(S(),E("div",Wn,[i("div",jn,[h[3]||(h[3]=i("h2",null,"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹",-1)),i("button",{onClick:k,class:"btn-reset-filters",disabled:!c.hasActiveFilters}," Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ",8,Hn)]),i("div",zn,[i("div",Vn,[h[4]||(h[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"ðŸ“Š"),He(" Ð­Ñ‚Ð°Ð¿Ñ‹ ")],-1)),i("div",Gn,[ae(Un,{selected:c.stages,stages:o,placeholder:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð¿Ñ‹","onUpdate:selected":r,onChange:u},null,8,["selected"])])]),i("div",Kn,[h[5]||(h[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"ðŸ‘¥"),He(" Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡ ")],-1)),i("div",Yn,[ae(Mn,{selected:c.employees,"onUpdate:selected":d},null,8,["selected"])])]),i("div",qn,[h[9]||(h[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"ðŸ“…"),He(" ÐŸÐµÑ€Ð¸Ð¾Ð´ ")],-1)),i("div",Xn,[i("select",{value:c.dateRange,onChange:h[0]||(h[0]=m=>f(m.target.value)),class:"date-range-select"},[...h[6]||(h[6]=[i("option",{value:"last-week"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð½ÐµÐ´ÐµÐ»Ñ",-1),i("option",{value:"last-2-weeks"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 2 Ð½ÐµÐ´ÐµÐ»Ð¸",-1),i("option",{value:"last-month"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†",-1),i("option",{value:"custom"},"ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´",-1)])],40,Jn),c.dateRange==="custom"?(S(),E("div",Zn,[i("div",Qn,[i("div",eo,[h[7]||(h[7]=i("label",null,"Ð¡:",-1)),i("input",{type:"date",value:c.customDateRange.startDate,onChange:h[1]||(h[1]=m=>p("startDate",m.target.value)),max:c.customDateRange.endDate||l.value,class:"date-input"},null,40,to)]),i("div",ao,[h[8]||(h[8]=i("label",null,"ÐŸÐ¾:",-1)),i("input",{type:"date",value:c.customDateRange.endDate,onChange:h[2]||(h[2]=m=>p("endDate",m.target.value)),min:c.customDateRange.startDate||n.value,max:l.value,class:"date-input"},null,40,so)])]),s.value?(S(),E("small",no,x(s.value),1)):(S(),E("small",oo," Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… "))])):Y("",!0)])])])]))}},ro=he(lo,[["__scopeId","data-v-4b7456a2"]]);function io(){const c=A(!1),t=A(null),e=A(null),a=A(0),o=Pe(),s=async(m=!0,y=null)=>{c.value=!0,t.value=null,a.value=0;try{const T=await nt.getSectorDataForSnapshot({useCache:m,onProgress:j=>{j&&typeof j.progress=="number"&&(a.value=j.progress),y&&y(j)},normalize:!0});return e.value=T,T}catch(T){throw t.value=T.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°",o.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°: "+t.value),T}finally{c.value=!1,a.value=100}},n=async(m,y={})=>{if(!e.value){const T="Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ñ‡ÐµÑ€ÐµÐ· loadSectorDataForSnapshot()";throw t.value=T,o.error(T),new Error(T)}c.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(m))throw new Error(`ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ»ÐµÐ¿ÐºÐ°: ${m}. Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ: week_start, week_end, manual, current`);const T=await ge.createSnapshot(e.value,m,y);return o.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"),T}catch(T){throw t.value=T.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°",o.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°: "+t.value),T}finally{c.value=!1}},l=()=>{c.value=!1,t.value=null,e.value=null,a.value=0},r=K(()=>e.value!==null&&e.value!==void 0),u=A({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),d=K(()=>{const m=new Date;let y,T;switch(u.value.dateRange){case"last-week":y=new Date(m),y.setDate(m.getDate()-7),T=m;break;case"last-2-weeks":y=new Date(m),y.setDate(m.getDate()-14),T=m;break;case"last-month":y=new Date(m),y.setMonth(m.getMonth()-1),T=m;break;case"custom":y=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,T=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:y=new Date(m),y.setDate(m.getDate()-7),T=m}return{startDate:y?y.toISOString().split("T")[0]:null,endDate:T?T.toISOString().split("T")[0]:null}}),f=()=>{k()},p=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},k()},k=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(m){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð² Ð² localStorage:",m)}},w=()=>{try{const m=localStorage.getItem("graphStateFilters");if(m){const y=JSON.parse(m);y&&typeof y=="object"&&(u.value={stages:y.stages||{formed:!0,review:!0,execution:!0},employees:y.employees||["all"],dateRange:y.dateRange||"last-week",customDateRange:y.customDateRange||{startDate:null,endDate:null}})}}catch(m){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð² Ð¸Ð· localStorage:",m)}},h=K(()=>{const m=Object.values(u.value.stages).some(j=>!j),y=!u.value.employees.includes("all"),T=u.value.dateRange!=="last-week";return m||y||T});return{isLoading:c,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:r,filters:u,selectedPeriod:d,hasActiveFilters:h,loadSectorDataForSnapshot:s,createSnapshot:n,resetState:l,applyFilters:f,resetFilters:p,saveFiltersToLocalStorage:k,loadFiltersFromLocalStorage:w}}const co={class:"graph-state-dashboard"},uo={key:1,class:"error-message-container"},po={class:"error-message"},fo={class:"error-text"},go={key:0,class:"error-details"},mo={class:"dashboard-header"},ho={class:"header-content"},vo={class:"breadcrumbs-row"},yo=["aria-disabled","data-fallback","disabled"],wo={class:"breadcrumbs","aria-label":"ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ"},ko={class:"header-actions"},So=["disabled"],bo={key:0},Do={key:1},Eo={key:3,class:"dashboard-content"},_o={class:"chart-container"},Co="ÐÐ°Ð·Ð°Ð´",To={__name:"GraphStateDashboard",setup(c){const t=(O,H)=>typeof window>"u"?H:getComputedStyle(document.documentElement).getPropertyValue(O).trim()||H,e=Pe(),a=Ut(),o={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:n,hasActiveFilters:l,applyFilters:r,resetFilters:u,loadFiltersFromLocalStorage:d}=io(),f=A(null),p=A(!0),k=A(!1),w=A("Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."),h=A(null),m=A(!1),y=A(!1),T=A(typeof window<"u"?window.innerWidth:1024),j=A(null),C=A(!1),R=K(()=>T.value<768);K(()=>T.value>=768&&T.value<1024),K(()=>T.value>=1024);const M=K(()=>typeof window>"u"?!1:window.history.length>1);K(()=>{const O=new Date;return O.setFullYear(O.getFullYear()-1),O.toISOString().split("T")[0]}),K(()=>new Date().toISOString().split("T")[0]);function $(O){s.value.stages=O}function F(O){s.value.employees=O}function z(O){s.value.dateRange=O}function X(O){s.value.customDateRange=O}function Q(){r()}function Ee(){u(),j.value=null,Q(),e.info("Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹")}function _e(O){e.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½")}function ce(O){k.value=!1,w.value="",console.log("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹:",O)}function Ce(O){k.value=!1,ne({message:O||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",details:null,type:"error"})}function ne(O){h.value={message:O.message||"ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°",details:O.details||null,type:O.type||"error",timestamp:new Date},console.error("Dashboard error:",h.value),e.error(h.value.message)}function ve(){h.value=null}function Te(){h.value=null,k.value=!0,w.value="ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."}async function L(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² PDF Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ jspdf Ð¸ html2canvas."),console.warn("Ð”Ð»Ñ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: npm install jspdf html2canvas");return}m.value=!0;try{const O=document.querySelector(".chart-container");if(!O)throw new Error("Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");const H=window.html2canvas,ue=await H(O,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Ue=window.jsPDF,oe=new Ue("landscape","mm","a4"),Re=297,qe=ue.height*Re/ue.width;oe.setFontSize(18),oe.text("Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",148.5,15,{align:"center"});const Ae=new Date().toLocaleDateString("ru-RU");oe.setFontSize(10);const Xe=n.value.startDate&&n.value.endDate?`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${n.value.startDate} - ${n.value.endDate}`:"ÐŸÐµÑ€Ð¸Ð¾Ð´: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½";oe.text(Xe,148.5,25,{align:"center"}),oe.text(`Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚ ${Ae}`,148.5,30,{align:"center"}),oe.addImage(ue.toDataURL("image/png"),"PNG",10,35,Re-20,qe-20),oe.setProperties({title:"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",subject:`Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚ ${Ae}`,author:"Bitrix24 Dashboard"});const Je=`graph-state-${Ae.replace(/\//g,"-")}.pdf`;oe.save(Je),e.success("Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² PDF")}catch(O){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF:",O),ne({message:"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF: "+(O.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"),details:O.stack,type:"error"})}finally{m.value=!1}}function ee(O){var H;if((H=O==null?void 0:O.preventDefault)==null||H.call(O),!C.value){C.value=!0;try{if(M.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(o)}finally{C.value=!1}}}function Le(){typeof window<"u"&&(T.value=window.innerWidth)}async function Ye(){try{const O=await $t.checkAccess();O.allowed&&(f.value=O.user)}catch(O){console.error("Error loading user:",O)}}return De(()=>{d(),Ye(),typeof window<"u"&&(T.value=window.innerWidth,window.addEventListener("resize",Le))}),Ke(()=>{typeof window<"u"&&window.removeEventListener("resize",Le)}),(O,H)=>{const ue=Wt("router-link");return S(),E("div",co,[k.value?(S(),Me(At,{key:0,message:w.value},null,8,["message"])):Y("",!0),h.value?(S(),E("div",uo,[i("div",po,[i("div",{class:"error-header"},[H[1]||(H[1]=i("span",{class:"error-icon"},"âŒ",-1)),H[2]||(H[2]=i("h3",null,"ÐžÑˆÐ¸Ð±ÐºÐ°",-1)),i("button",{onClick:ve,class:"error-close","aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"âœ•")]),i("p",fo,x(h.value.message),1),h.value.details?(S(),E("div",go,[i("details",null,[H[3]||(H[3]=i("summary",null,"Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸",-1)),i("pre",null,x(h.value.details),1)])])):Y("",!0),i("div",{class:"error-actions"},[i("button",{onClick:Te,class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ")])])])):Y("",!0),i("div",mo,[i("div",ho,[i("div",vo,[i("button",{class:"btn-back-link",type:"button",onClick:ee,"aria-label":Co,"aria-disabled":!M.value,"data-fallback":!M.value,disabled:C.value,title:"ÐÐ°Ð·Ð°Ð´"}," â† ",8,yo),i("nav",wo,[ae(ue,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Fe(()=>[...H[4]||(H[4]=[He(" Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡ ",-1)])]),_:1}),H[5]||(H[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),H[6]||(H[6]=i("span",{class:"breadcrumb-current"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ",-1))])]),H[7]||(H[7]=i("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),H[8]||(H[8]=i("p",{class:"dashboard-subtitle"}," Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ",-1))]),i("div",ko,[i("button",{onClick:L,class:"btn-export-pdf",disabled:m.value||k.value,title:"Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€Ð°Ñ„Ð¸Ðº Ð² PDF"},[m.value?(S(),E("span",Do,"â³ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚...")):(S(),E("span",bo,"ðŸ“„ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² PDF"))],8,So),ae(gn,{user:f.value,onSnapshotCreated:_e},null,8,["user"])])]),R.value?(S(),E("button",{key:2,class:"mobile-filters-toggle",onClick:H[0]||(H[0]=Ue=>y.value=!y.value)},[H[9]||(H[9]=i("span",null,"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹",-1)),i("span",{class:Z(["toggle-icon",{open:y.value}])},"â–¼",2)])):Y("",!0),i("div",{class:Z({"mobile-open":y.value&&R.value,"mobile-closed":!y.value&&R.value})},[ae(ro,{stages:$e(s).stages,employees:$e(s).employees,dateRange:$e(s).dateRange,customDateRange:$e(s).customDateRange,hasActiveFilters:$e(l),"onUpdate:stages":$,"onUpdate:employees":F,"onUpdate:dateRange":z,"onUpdate:customDateRange":X,onReset:Ee,onApply:Q},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!k.value&&!h.value?(S(),E("div",Eo,[i("div",_o,[ae(Vs,{period:$e(n),"show-current-state":p.value,onDataLoaded:ce,onError:Ce},null,8,["period","show-current-state"])])])):Y("",!0)])}}},Mo=he(To,[["__scopeId","data-v-e995acfd"]]);export{Mo as default};
