var te=Object.defineProperty;var se=(s,e,t)=>e in s?te(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var w=(s,e,t)=>se(s,typeof e!="symbol"?e+"":e,t);import{_ as C,c as y,a as g,b as k,t as m,n as L,o as f,F as P,r as x,d as A,e as B,f as D,g as H,w as ne,T as ie,h as ae,i as S,j as F,k as re}from"./main-CDgMut_V.js";const oe={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(s,{emit:e}){return{getPriorityLabel:l=>({high:"–í—ã—Å–æ–∫–∏–π",medium:"–°—Ä–µ–¥–Ω–∏–π",low:"–ù–∏–∑–∫–∏–π"})[l]||l,getStatusLabel:l=>({in_progress:"–í —Ä–∞–±–æ—Ç–µ",new:"–ù–æ–≤—ã–π",done:"–í—ã–ø–æ–ª–Ω–µ–Ω–æ",pending:"–û–∂–∏–¥–∞–Ω–∏–µ"})[l]||l,handleDragStart:l=>{l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("application/json",JSON.stringify(s.ticket)),l.dataTransfer.setDragImage(l.target,0,0),e("drag-start",s.ticket)},handleDragEnd:()=>{e("drag-end")}}}},ce=["draggable"],le={class:"ticket-header"},de={class:"ticket-id"},ue={class:"ticket-title"},ge={class:"ticket-meta"},pe={class:"ticket-status"},fe={key:0,class:"ticket-description"};function ye(s,e,t,n,i,c){return f(),y("div",{class:L(["ticket-card",{"priority-high":t.ticket.priority==="high","priority-medium":t.ticket.priority==="medium","priority-low":t.ticket.priority==="low"}]),draggable:t.draggable,onClick:e[0]||(e[0]=l=>s.$emit("click",t.ticket)),onDragstart:e[1]||(e[1]=(...l)=>n.handleDragStart&&n.handleDragStart(...l)),onDragend:e[2]||(e[2]=(...l)=>n.handleDragEnd&&n.handleDragEnd(...l))},[g("div",le,[e[3]||(e[3]=g("span",{class:"ticket-icon"},"üé´",-1)),g("span",de,"#"+m(t.ticket.id),1)]),g("div",ue,m(t.ticket.title),1),g("div",ge,[g("span",{class:L(["ticket-priority",`priority-${t.ticket.priority}`])},m(n.getPriorityLabel(t.ticket.priority)),3),g("span",pe,m(n.getStatusLabel(t.ticket.status)),1)]),t.ticket.description?(f(),y("div",fe,m(t.ticket.description),1)):k("",!0)],42,ce)}const Z=C(oe,[["render",ye],["__scopeId","data-v-b255f359"]]),me={name:"ZeroPoint",components:{TicketCard:Z},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(s,{emit:e}){return{handleTicketDragStart:n=>{e("ticket-dragged",n)}}}},he={class:"zero-point"},Te={class:"zero-point-header"},ke={class:"tickets-count"},_e={class:"zero-point-tickets"},ve={key:0,class:"empty-state"};function De(s,e,t,n,i,c){const l=A("TicketCard");return f(),y("div",he,[g("div",Te,[e[0]||(e[0]=g("span",{class:"zero-point-icon"},"üì•",-1)),e[1]||(e[1]=g("h3",null,"[0] –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞",-1)),g("span",ke,"("+m(t.tickets.length)+")",1)]),e[3]||(e[3]=g("div",{class:"zero-point-description"},[g("p",null,"–í—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã"),g("p",{class:"hint"},"–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–∏–∫–µ—Ç –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")],-1)),g("div",_e,[(f(!0),y(P,null,x(t.tickets,p=>(f(),B(l,{key:p.id,ticket:p,draggable:!0,onDragStart:r=>n.handleTicketDragStart(p),onClick:r=>s.$emit("ticket-clicked",p)},null,8,["ticket","onDragStart","onClick"]))),128)),t.tickets.length===0?(f(),y("div",ve,[...e[2]||(e[2]=[g("p",null,"–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤",-1)])])):k("",!0)])])}const Ee=C(me,[["render",De],["__scopeId","data-v-252e877d"]]);function Se(s){return typeof s=="number"&&s>0&&!isNaN(s)}function q(s){return typeof s=="number"&&s>0&&!isNaN(s)}function J(s){return typeof s=="string"&&["formed","review","execution"].includes(s)}function Ie(s){return!s||typeof s!="object"?!1:Se(s.id)&&typeof s.title=="string"&&s.title.trim().length>0}function Q(s,e,t){return!(!Ie(s)||!q(e)||!J(t)||s.assigneeId===e&&s.stageId===t)}function Ae(s){const e=[];return!s||typeof s!="object"?(e.push("–î–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{valid:!1,errors:e}):((!s.title||typeof s.title!="string"||s.title.trim().length===0)&&e.push("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),s.stageId&&!J(s.stageId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å—Ç–∞–¥–∏–∏"),s.employeeId&&!q(s.employeeId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"),{valid:e.length===0,errors:e})}function ee(){const s=(c,l="info",p=5e3)=>{typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:c,autoHideDelay:p}):console.log(`[${l.toUpperCase()}] ${c}`)};return{notify:s,success:(c,l=3e3)=>{s(c,"success",l)},error:(c,l=5e3)=>{s(c,"error",l)},info:(c,l=4e3)=>{s(c,"info",l)},warning:(c,l=4e3)=>{s(c,"warning",l)}}}function Ce(s){const e=ee(),t=D(!1);return{isDropZoneActive:t,handleDragStart:(r,d)=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("application/json",JSON.stringify(d)),r.dataTransfer.setDragImage(r.target,0,0)},handleDragOver:r=>{r.preventDefault(),r.dataTransfer.dropEffect="move",t.value=!0},handleDragLeave:r=>{const d=r.currentTarget.getBoundingClientRect(),a=r.clientX,o=r.clientY;(a<d.left||a>d.right||o<d.top||o>d.bottom)&&(t.value=!1)},handleDrop:async(r,d,a)=>{r.preventDefault(),t.value=!1;const o=r.dataTransfer.getData("application/json");if(o)try{const u=JSON.parse(o);if(!Q(u,d,a)){e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞");return}s&&typeof s=="function"&&await s(u,d,a)}catch(u){console.error("Error parsing ticket data:",u),e.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞")}},handleDragEnd:r=>{t.value=!1}}}const we={name:"EmployeeColumn",components:{TicketCard:Z},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(s,{emit:e}){const n=Ce(async(p,r,d)=>{e("ticket-dropped",p,r)}),i=p=>{n.handleDrop(p,s.employee.id,s.stageId)},c=p=>{},l=()=>{console.log("Add ticket for employee:",s.employee.id)};return{isDropZoneActive:n.isDropZoneActive,handleDragOver:n.handleDragOver,handleDragLeave:n.handleDragLeave,handleDrop:i,handleTicketDragStart:c,handleAddTicket:l}}},Ne={class:"employee-header"},Le={class:"employee-info"},Be={class:"employee-details"},be={class:"employee-name"},Re={key:0,class:"employee-position"},Oe={class:"tickets-count"},Me={class:"tickets-list"},Pe={key:0,class:"empty-state"};function xe(s,e,t,n,i,c){var p;const l=A("TicketCard");return f(),y("div",{class:L(["employee-column",{"drop-zone-active":n.isDropZoneActive}]),onDragover:e[1]||(e[1]=ae((...r)=>n.handleDragOver&&n.handleDragOver(...r),["prevent"])),onDragleave:e[2]||(e[2]=(...r)=>n.handleDragLeave&&n.handleDragLeave(...r)),onDrop:e[3]||(e[3]=(...r)=>n.handleDrop&&n.handleDrop(...r))},[g("div",Ne,[g("div",Le,[e[4]||(e[4]=g("span",{class:"employee-icon"},"üë§",-1)),g("div",Be,[g("div",be,m(t.employee.name),1),t.employee.position?(f(),y("div",Re,m(t.employee.position),1)):k("",!0)])]),g("div",Oe," üìä –¢–∏–∫–µ—Ç–æ–≤: "+m(((p=t.employee.tickets)==null?void 0:p.length)||0),1)]),g("div",Me,[H(ie,{name:"ticket",tag:"div"},{default:ne(()=>[(f(!0),y(P,null,x(t.employee.tickets,r=>(f(),B(l,{key:r.id,ticket:r,draggable:!0,onClick:d=>s.$emit("ticket-clicked",r),onDragStart:n.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1}),!t.employee.tickets||t.employee.tickets.length===0?(f(),y("div",Pe,[e[5]||(e[5]=g("p",null,"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤",-1)),g("button",{class:"add-ticket-btn",onClick:e[0]||(e[0]=(...r)=>n.handleAddTicket&&n.handleAddTicket(...r))}," + –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç ")])):k("",!0)])],34)}const $e=C(we,[["render",xe],["__scopeId","data-v-6120ff13"]]),ze={name:"DashboardStage",components:{ZeroPoint:Ee,EmployeeColumn:$e},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(s,{emit:e}){const t=D(!1),n=S(()=>{const d=Array.isArray(s.zeroPointTickets)?s.zeroPointTickets.length:0,a=Array.isArray(s.stage.employees)?s.stage.employees.reduce((o,u)=>{const T=Array.isArray(u.tickets)?u.tickets.length:0;return o+T},0):0;return d+a}),i=S(()=>{var o;const d=((o=s.stage)==null?void 0:o.name)||"–°—Ç–∞–¥–∏—è",a=n.value;return`${d} (${a})`});return{isDragging:t,totalTicketsCount:n,stageNameWithCount:i,handleTicketDragged:d=>{t.value=!0},handleTicketAssigned:(d,a)=>{e("ticket-assigned",d,a)},handleTicketDropped:(d,a)=>{e("ticket-moved",d,a,s.stage.id),t.value=!1},handleTicketClicked:d=>{console.log("Ticket clicked:",d),e("ticket-clicked",d)}}}},Ke={class:"stage-header"},Ue={class:"stage-content"},je={class:"employees-container"};function Ye(s,e,t,n,i,c){const l=A("ZeroPoint"),p=A("EmployeeColumn");return f(),y("div",{class:"dashboard-stage",style:F({borderLeftColor:t.stage.color})},[g("div",Ke,[g("h2",null,m(n.stageNameWithCount),1)]),g("div",Ue,[H(l,{tickets:t.zeroPointTickets,"stage-id":t.stage.id,onTicketDragged:n.handleTicketDragged,onTicketAssigned:n.handleTicketAssigned,onTicketClicked:n.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),g("div",je,[(f(!0),y(P,null,x(t.stage.employees,r=>(f(),B(p,{key:r.id,employee:r,"stage-id":t.stage.id,onTicketClicked:n.handleTicketClicked,onTicketDropped:n.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const Ve=C(ze,[["render",Ye],["__scopeId","data-v-8c32af0d"]]),$={cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},Xe={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(s,{emit:e}){const t=S(()=>{var o;if(s.stepDetails&&typeof s.stepDetails=="object"&&s.stepDetails.description)return{title:s.currentStep?((o=$[s.currentStep])==null?void 0:o.title)||s.currentStep:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:s.stepDetails.description};if(!s.currentStep)return{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."};if($[s.currentStep])return $[s.currentStep];const d=s.currentStep;return{loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}}[d]||{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."}}),n=S(()=>t.value.title),i=S(()=>t.value.description),c=S(()=>s.stepDetails),l=S(()=>{const d=s.progress;return d==null||isNaN(d)?0:Math.round(Math.max(0,Math.min(100,d)))});return{stepTitle:n,stepDescription:i,details:c,displayProgress:l,getStageDisplayName:d=>d?{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ","–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[d]||d:"",handleRetry:()=>{e("retry")}}}},We={class:"preloader-backdrop"},Ge={class:"preloader-container"},He={class:"preloader-content-scrollable"},Fe={key:0,class:"spinner-container"},Ze={class:"preloader-content"},qe={class:"step-title"},Je={key:0,class:"step-description"},Qe={key:1,class:"progress-container"},et={class:"progress-bar"},tt={class:"progress-text"},st={key:2,class:"step-details"},nt={key:0,class:"detail-description"},it={key:1,class:"detail-item"},at={class:"detail-value"},rt={key:0,class:"detail-total"},ot={key:2,class:"detail-item"},ct={class:"detail-value"},lt={key:0,class:"detail-total"},dt={key:3,class:"detail-item"},ut={class:"detail-value"},gt={key:0,class:"detail-total"},pt={key:4,class:"detail-item"},ft={class:"detail-value"},yt={key:5,class:"detail-warning"},mt={key:0,class:"error-container"},ht={class:"error-content"},Tt={class:"error-message"};function kt(s,e,t,n,i,c){return f(),y("div",{class:L(["loading-preloader",{"has-error":t.error}])},[g("div",We,[g("div",Ge,[g("div",He,[t.error?k("",!0):(f(),y("div",Fe,[...e[1]||(e[1]=[g("div",{class:"spinner"},null,-1)])])),g("div",Ze,[g("h3",qe,m(n.stepTitle),1),n.stepDescription?(f(),y("p",Je,m(n.stepDescription),1)):k("",!0),t.error?k("",!0):(f(),y("div",Qe,[g("div",et,[g("div",{class:"progress-fill",style:F({width:n.displayProgress+"%"})},null,4)]),g("span",tt,m(n.displayProgress)+"%",1)])),t.error?k("",!0):(f(),y("div",st,[n.details.description?(f(),y("div",nt,m(n.details.description),1)):k("",!0),n.details.count!==void 0?(f(),y("div",it,[e[2]||(e[2]=g("span",{class:"detail-label"},"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",at,m(n.details.count),1),n.details.total!==void 0?(f(),y("span",rt," –∏–∑ "+m(n.details.total),1)):k("",!0)])):k("",!0),n.details.filteredTickets!==void 0?(f(),y("div",ot,[e[3]||(e[3]=g("span",{class:"detail-label"},"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",ct,m(n.details.filteredTickets),1),n.details.totalTickets!==void 0?(f(),y("span",lt," –∏–∑ "+m(n.details.totalTickets),1)):k("",!0)])):k("",!0),n.details.stage?(f(),y("div",dt,[e[4]||(e[4]=g("span",{class:"detail-label"},"–°—Ç–∞–¥–∏—è:",-1)),g("span",ut,m(n.getStageDisplayName(n.details.stage)),1),n.details.stageIndex&&n.details.totalStages?(f(),y("span",gt," ("+m(n.details.stageIndex)+"/"+m(n.details.totalStages)+") ",1)):k("",!0)])):k("",!0),n.details.employeeCount!==void 0?(f(),y("div",pt,[e[5]||(e[5]=g("span",{class:"detail-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",-1)),g("span",ft,m(n.details.employeeCount),1)])):k("",!0),n.details.warning?(f(),y("div",yt,[g("span",null,"‚ö†Ô∏è "+m(n.details.warning),1)])):k("",!0)]))])])])]),t.error?(f(),y("div",mt,[g("div",ht,[e[6]||(e[6]=g("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),g("p",Tt,m(t.error),1),g("button",{onClick:e[0]||(e[0]=(...l)=>n.handleRetry&&n.handleRetry(...l)),class:"retry-button"}," –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É ")])])):k("",!0)],2)}const _t=C(Xe,[["render",kt],["__scopeId","data-v-ae797a85"]]);function vt(){const s=D(!1),e=D(null),t=D([{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}]),n=D({formed:[],review:[],execution:[]}),i=D([]),c=D(null);return{isLoading:s,error:e,stages:t,zeroPointTickets:n,employees:i,draggedTicket:c,updateState:a=>{a.stages&&(t.value=a.stages),a.employees&&(i.value=a.employees),a.zeroPointTickets&&(n.value=a.zeroPointTickets)},resetState:()=>{s.value=!1,e.value=null,t.value=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}],n.value={formed:[],review:[],execution:[]},i.value=[],c.value=null},updateLocalStateAfterMove:(a,o,u)=>{const T=t.value.find(_=>_.employees.some(v=>v.tickets.some(b=>b.id===a.id)));if(T){const _=T.employees.find(v=>v.tickets.some(b=>b.id===a.id));_&&(_.tickets=_.tickets.filter(v=>v.id!==a.id))}const E=t.value.find(_=>_.id===u);if(E){const _=E.employees.find(v=>v.id===o);if(_){const v={...a,assigneeId:o,stageId:u};_.tickets.push(v)}}Object.keys(n.value).forEach(_=>{n.value[_]=n.value[_].filter(v=>v.id!==a.id)})},getEmployeeTickets:(a,o)=>{const u=t.value.find(E=>E.id===o);if(!u)return[];const T=u.employees.find(E=>E.id===a);return T?T.tickets||[]:[]}}}class Dt{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,t={}){try{const n=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:t})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.json();if(i.error)throw new Error(i.error_description||i.error);return i}catch(n){throw console.error("Bitrix24 API error:",n),n}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},t=["ID","NAME","EMAIL","PHONE"],n={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:t,order:n})).result||[]}}class I{static async call(e,t={}){return await Dt.call(e,t)}}class h{static get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}static set(e,t,n=this.DEFAULT_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:n})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const t=[];for(const n of this.cache.keys())n.startsWith(e)&&t.push(n);t.forEach(n=>this.cache.delete(n))}static cleanExpired(){const e=Date.now(),t=[];for(const[n,i]of this.cache.entries())e-i.timestamp>i.ttl&&t.push(n);t.forEach(n=>this.cache.delete(n))}static getStats(){const e=Date.now();let t=0,n=0;for(const i of this.cache.values())e-i.timestamp>i.ttl?t++:n++;return{total:this.cache.size,valid:n,expired:t}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((n,i)=>n-i).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}w(h,"cache",new Map),w(h,"DEFAULT_TTL",5*60*1e3),w(h,"EMPLOYEES_TTL",30*60*1e3),w(h,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{h.cleanExpired()},5*60*1e3);const R=140;class O{static async getAllTickets(e,t=null){const n=[],i=e.length;try{for(let c=0;c<e.length;c++){const l=e[c],p=this.getStageName(l);console.log(`Loading tickets for stage: ${l}`),t&&t({step:"loading_tickets",stage:l,stageName:p,stageIndex:c+1,totalStages:i,percent:c/i*100,details:{stage:l,stageName:p,stageIndex:c+1,totalStages:i,description:`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${p}" (${c+1}/${i})...`}});try{const r=await this.getTicketsByStage(l,!0,t?d=>{const a=c/i+d.percent/100/i;t({step:"loading_tickets",stage:l,stageName:p,stageIndex:c+1,totalStages:i,percent:a*100,count:d.count,total:d.total,details:{stage:l,stageName:p,stageIndex:c+1,totalStages:i,count:d.count,total:d.total,description:`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${p}" (${c+1}/${i}). –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${d.count}${d.total?` –∏–∑ ${d.total}`:""}...`}})}:null);n.push(...r),console.log(`Loaded ${r.length} tickets for stage ${l}`)}catch(r){console.error(`Error loading tickets for stage ${l}:`,r);let d=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${p}"`;throw r.message&&(r.message.includes("HTTP error")||r.message.includes("network")?d=`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${p}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`:r.message.includes("timeout")?d=`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${p}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`:r.message.includes("403")||r.message.includes("401")?d=`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${p}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.`:d=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${p}": ${r.message}`),new Error(d)}}}catch(c){throw console.error("Error in getAllTickets:",c),c}return n}static getStageName(e){return{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[e]||e}static async getTicketsByStage(e,t=!0,n=null){if(t){const a=h.getTicketsCacheKey(e),o=h.get(a);if(o!==null)return console.log(`Cache hit for stage ${e}`),n&&n({percent:100,count:o.length,total:o.length}),o}const i=[];let c=0;const l=50;let p=!0,r=0,d=null;for(;p;)try{const a=await I.call("crm.item.list",{entityTypeId:R,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:c,useOriginalUfNames:"Y"});let o=[];if(a&&a.result&&(Array.isArray(a.result)?o=a.result:a.result.items&&Array.isArray(a.result.items)?o=a.result.items:a.result.data&&Array.isArray(a.result.data)&&(o=a.result.data)),o.length>0){if(i.push(...o),c+=o.length,p=o.length===l,p?r=c+l:r=i.length,n){const u=r>0?Math.min(100,i.length/r*100):0;n({percent:u,count:i.length,total:r})}d=null}else p=!1}catch(a){if(console.error(`Error loading tickets batch for stage ${e} (start: ${c}):`,a),c===0)throw d=a,new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç—ã –¥–ª—è —Å—Ç–∞–¥–∏–∏ ${e}: ${a.message||a}`);p=!1,n&&i.length>0&&n({percent:100,count:i.length,total:i.length,warning:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ${i.length} —Ç–∏–∫–µ—Ç–æ–≤. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.`})}if(d&&i.length===0)throw d;if(t){const a=h.getTicketsCacheKey(e);h.set(a,i,h.TICKETS_TTL)}return i}static async getTicket(e){return(await I.call("crm.item.get",{entityTypeId:R,id:e})).result||null}static async updateTicket(e,t){const i=(await I.call("crm.item.update",{entityTypeId:R,id:e,fields:t})).result===!0;return i&&h.invalidateTicketsCache(),i}static async createTicket(e){const t=await I.call("crm.item.add",{entityTypeId:R,fields:e}),n=t.result?parseInt(t.result):0;return n>0&&h.invalidateTicketsCache(),n}static async assignTicket(e,t,n){return await this.updateTicket(e,{assignedById:t,stageId:n})}}class Et{static async getEmployeesByIds(e,t=!0){if(!Array.isArray(e)||e.length===0)return[];if(t){const n=h.getEmployeesCacheKey(e),i=h.get(n);if(i!==null)return console.log(`Cache hit for employees: ${e.length} employees`),i}try{const n=await I.call("user.get",{filter:{ID:e}});let i=[];if(n&&n.result&&(Array.isArray(n.result)?i=n.result:console.warn("Unexpected user.get result format:",n)),t){const c=h.getEmployeesCacheKey(e);h.set(c,i,h.EMPLOYEES_TTL)}return i}catch(n){return console.error("Error getting employees by IDs:",n),[]}}}const St=140,z={FORMED:{bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{bitrixId:"DT140_12:PREPARATION"},EXECUTION:{bitrixId:"DT140_12:CLIENT"}},It={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},At={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},Ct={3:"high",2:"medium",1:"low"};function wt(){return[z.FORMED.bitrixId,z.REVIEW.bitrixId,z.EXECUTION.bitrixId]}function Y(s){return It[s]||"formed"}function W(s){return At[s]||"DT140_12:UC_0VHWE2"}function Nt(){return wt()}function V(s){const e=parseInt(s.id||s.ID||0),t=s.title||s.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",n=s.stageId||s.STAGE_ID||"",i=s.assignedById||s.ASSIGNED_BY_ID||null,c=s.createdTime||s.CREATED_DATE||s.CREATED_TIME||"",l=s.updatedTime||s.MODIFY_DATE||s.UPDATED_TIME||"";return{id:e,title:t,priority:Lt(s.priority||s.PRIORITY),status:Bt(),assigneeId:i?parseInt(i):null,stageId:Y(n),createdAt:c,modifiedAt:l,amount:s.opportunity||s.OPPORTUNITY||0,currency:s.currencyId||s.CURRENCY_ID||"RUB",description:s.comments||s.COMMENTS||""}}function Lt(s){return Ct[s]||"medium"}function Bt(s){return"in_progress"}function bt(s){return{id:parseInt(s.ID||s.id||0),name:`${s.NAME||s.name||""} ${s.LAST_NAME||s.lastName||""}`.trim()||s.EMAIL||s.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:s.WORK_POSITION||s.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:s.EMAIL||s.email||"",tickets:[]}}function Rt(s){return Array.isArray(s)?s.map(e=>bt(e)):[]}const M="1C",N=new Map,G=100;function Ot(s){return s.UF_CRM_7_TYPE_PRODUCT||s.uf_crm_7_type_product||s.ufCrm7TypeProduct||s.UF_CRM_7_TYPE_PRODUCT||s.uf_crm_7_type_product||null}function Mt(s){const e=Ot(s);return e?Array.isArray(e)?e.includes(M):typeof e=="object"&&e!==null&&e.value===M||e===M:!1}function Pt(s){return`filter:${s.map(t=>t.id||t.ID||"").sort().join(",")}`}function xt(){N.size>G&&Array.from(N.keys()).slice(0,Math.floor(G*.2)).forEach(e=>N.delete(e))}function $t(s){if(!Array.isArray(s))return[];const e=Pt(s),t=N.get(e);if(t!==void 0)return t;const n=s.filter(Mt);return N.set(e,n),xt(),n}const j=1051;function zt(s,e){Array.isArray(s)||(console.warn("Tickets is not an array:",s),s=[]),Array.isArray(e)||(console.warn("Employees is not an array:",e),e=[]);const t=e.filter(i=>(i.id?parseInt(i.id):null)!==j),n=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:t.map(i=>({...i,tickets:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:t.map(i=>({...i,tickets:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:t.map(i=>({...i,tickets:[]}))}];return s.forEach(i=>{const c=Y(i.stageId||i.STAGE_ID||""),l=n.find(p=>p.id===c);if(l){const p=i.assignedById||i.ASSIGNED_BY_ID||null,r=p?parseInt(p):null;if(r===j)return;if(r){let d=l.employees.find(a=>a.id===r);d||(d={id:r,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${r}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",tickets:[]},l.employees.push(d)),d.tickets.push(V(i))}}}),n}function Kt(s){const e={formed:[],review:[],execution:[]};return Array.isArray(s)?(s.filter(t=>{const n=t.assignedById||t.ASSIGNED_BY_ID,i=n?parseInt(n):null;return!i||i===j}).forEach(t=>{const n=Y(t.stageId||t.STAGE_ID||"");e[n]&&e[n].push(V(t))}),e):(console.warn("Tickets is not an array in getZeroPointTickets:",s),e)}function Ut(s){if(!Array.isArray(s))return[];const e=new Set;return s.forEach(t=>{const n=t.assignedById||t.assignedByIdId||t.ASSIGNED_BY_ID||t.assignedById||t.assignedById&&typeof t.assignedById=="object"&&(t.assignedById.id||t.assignedById.ID)||t.assignedById&&typeof t.assignedById=="object"&&t.assignedById.value;if(n){const i=parseInt(n);i&&!isNaN(i)&&i>0&&e.add(i)}}),Array.from(e)}class K{static async getSectorData(e=!0,t=null){if(t&&t({step:"cache_check",progress:0,details:{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."}}),e){const n=h.getSectorDataCacheKey(),i=h.get(n);if(i!==null)return console.log("Cache hit for sector data"),t&&t({step:"cache_hit",progress:100,details:{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫–µ—à–∞"}}),i}try{t&&t({step:"loading_tickets",progress:10,details:{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}});const n=Nt(),i=await O.getAllTickets(n,o=>{var u;if(t){console.log("TicketRepository progress callback:",o);const T=10,E=40,_=o.percent||0,v=T+_*E/100,X={step:o.step||"loading_tickets",progress:Math.min(50,v),details:{stage:o.stageName||o.stage,stageIndex:o.stageIndex,totalStages:o.totalStages,count:o.count,total:o.total,description:((u=o.details)==null?void 0:u.description)||`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${o.stageName||o.stage}"${o.stageIndex&&o.totalStages?` (${o.stageIndex}/${o.totalStages})`:""}${o.count!==void 0?`. –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${o.count}`:""}...`,warning:o.warning}};console.log("Calling onProgress from TicketRepository:",X),t(X)}});console.log("Total tickets loaded:",i.length),t&&t({step:"filtering",progress:50,details:{totalTickets:i.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${i.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}});const c=$t(i);console.log(`Filtered ${c.length} tickets from ${i.length} (sector tag: 1C)`),t&&t({step:"filtering",progress:50,details:{totalTickets:i.length,filteredTickets:c.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${i.length}`}}),t&&t({step:"extracting_employees",progress:60,details:{filteredTickets:c.length,description:`–ê–Ω–∞–ª–∏–∑ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}});const l=Ut(c);console.log("Unique employee IDs:",l),t&&t({step:"extracting_employees",progress:60,details:{employeeCount:l.length,description:`–ù–∞–π–¥–µ–Ω–æ ${l.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`}}),t&&t({step:"loading_employees",progress:65,details:{employeeCount:l.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${l.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}});const p=await Et.getEmployeesByIds(l),r=Rt(p);console.log("Loaded employees:",r.length),t&&t({step:"loading_employees",progress:90,details:{employeeCount:r.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${r.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`}}),t&&t({step:"grouping",progress:90,details:{filteredTickets:c.length,employees:r.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${r.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}});const a={stages:zt(c,r),employees:r,zeroPointTickets:Kt(c)};if(t&&t({step:"caching",progress:95,details:{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."}}),e){const o=h.getSectorDataCacheKey();h.set(o,a,h.TICKETS_TTL)}return t&&t({step:"complete",progress:100}),a}catch(n){throw console.error("Error getting sector data:",n),t&&t({step:"error",progress:0,error:n.message}),n}}static async assignTicket(e,t,n){try{const i=W(n),c=await O.assignTicket(e,t,i);return c&&h.invalidateTicketsCache(),c}catch(i){throw console.error("Error assigning ticket:",i),i}}static async createTicket(e){try{const t=W(e.stageId||"formed"),n={title:e.title,stageId:t};e.employeeId&&(n.assignedById=e.employeeId);const i=await O.createTicket(n);return i>0&&h.invalidateTicketsCache(),i}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const t=await O.getTicket(e);return V(t)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await I.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+St,comment:t}})).result!==void 0}catch(n){throw console.error("Error adding comment:",n),n}}}function jt(){const s=D(null),e=D(0),t=D(null),n=D(null),i=D({}),c=(u,T={})=>{console.log("useLoadingProgress.updateStep called:",u,T),s.value=u,i.value=T,console.log("useLoadingProgress: currentStep.value =",s.value),console.log("useLoadingProgress: stepDetails.value =",i.value)},l=u=>{console.log("useLoadingProgress.updateProgress called:",u);const T=typeof u=="number"&&!isNaN(u)?u:0;e.value=Math.min(100,Math.max(0,T)),console.log("useLoadingProgress: progress.value =",e.value)},p=u=>{t.value=u,n.value=null},r=u=>{n.value=u},d=()=>{n.value=null},a=()=>{s.value=null,e.value=0,t.value=null,n.value=null,i.value={}},o=S(()=>t.value||n.value);return{currentStep:s,progress:e,error:t,temporaryError:n,displayError:o,stepDetails:i,updateStep:c,updateProgress:l,setError:p,setTemporaryError:r,clearTemporaryError:d,reset:a}}function Yt(s,e=""){if(console.error(`API Error ${e?`(${e})`:""}:`,s),s.message){if(s.message.includes("HTTP error"))return"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";if(s.message.includes("timeout"))return"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";if(s.message.includes("403")||s.message.includes("401"))return"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";if(s.message.includes("500"))return"–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."}return s.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}function Vt(s,e="",t={}){const n={message:s.message,stack:s.stack,context:e,...t,timestamp:new Date().toISOString()};console.error("Error logged:",n)}function U(s,e="",t=null){const n=Yt(s,e);Vt(s,e),t&&typeof t=="function"?t(n,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:n,autoHideDelay:5e3})}function Xt(s){const e=ee(),t=jt(),n=async(a=!0)=>{s.isLoading.value=!0,s.error.value=null,t.reset(),t.updateStep("cache_check",{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö..."}),t.updateProgress(0);try{const o=await K.getSectorData(a,u=>{console.log("Progress callback received:",u),u.step?(console.log("Updating step to:",u.step),t.updateStep(u.step,u.details||{})):console.warn("Progress info without step:",u),u.progress!==void 0&&u.progress!==null?(console.log("Updating progress to:",u.progress),t.updateProgress(u.progress),t.clearTemporaryError()):u.percent!==void 0&&u.percent!==null&&(console.log("Updating progress from percent to:",u.percent),t.updateProgress(u.percent),t.clearTemporaryError())});s.updateState(o)}catch(o){s.error.value=o.message,t.setError(o.message),U(o,"loading sector data",e.error)}finally{s.error.value?s.isLoading.value=!1:setTimeout(()=>{s.isLoading.value=!1,setTimeout(()=>{t.reset()},200)},800)}},i=async(a,o,u)=>{if(!Q(a,o,u))return e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞"),!1;try{const T=await K.assignTicket(a.id,o,u);return T&&(s.updateLocalStateAfterMove(a,o,u),e.success("–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω")),T}catch(T){return U(T,"assigning ticket",e.error),!1}finally{s.draggedTicket.value=null}};return{loadSectorData:n,assignTicket:i,moveTicketToStage:async(a,o)=>await i(a,a.assigneeId,o),assignTicketToEmployee:async(a,o)=>await i(a,o,a.stageId),createTicket:async a=>{const o=Ae(a);if(!o.valid){const u=o.errors.join(", ");return e.error(u),0}try{const u=await K.createTicket(a);return u>0&&(await n(!1),e.success("–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω")),u}catch(u){return U(u,"creating ticket",e.error),0}},handleTicketDragStart:a=>{s.draggedTicket.value=a},handleTicketDrop:async(a,o,u)=>{await i(a,o,u)},loadingProgress:t}}const Wt={name:"DashboardSector1C",components:{DashboardStage:Ve,LoadingPreloader:_t},setup(){const s=vt(),e=Xt(s);re(()=>{e.loadSectorData()});const t=()=>{e.loadSectorData(!1)},n=e.loadingProgress;return{isLoading:s.isLoading,error:s.error,stages:s.stages,zeroPointTickets:s.zeroPointTickets,employees:s.employees,draggedTicket:s.draggedTicket,currentStep:n.currentStep,progress:n.progress,stepDetails:n.stepDetails,loadingProgress:n,loadSectorData:e.loadSectorData,handleTicketDragStart:e.handleTicketDragStart,handleTicketDrop:e.handleTicketDrop,assignTicketToEmployee:e.assignTicketToEmployee,moveTicketToStage:e.moveTicketToStage,createTicket:e.createTicket,getEmployeeTickets:s.getEmployeeTickets,handleRetry:t}}},Gt={key:1,class:"dashboard-content"},Ht={class:"stages-container"};function Ft(s,e,t,n,i,c){const l=A("LoadingPreloader"),p=A("DashboardStage");return f(),y("div",{class:L(["dashboard-sector-1c",{"is-dragging":n.draggedTicket}])},[e[0]||(e[0]=g("div",{class:"dashboard-header"},[g("h1",null,"–î–∞—à–±–æ—Ä–¥ - –°–µ–∫—Ç–æ—Ä 1–°")],-1)),n.isLoading||n.error||n.currentStep?(f(),B(l,{key:0,"current-step":n.currentStep,progress:n.progress,"step-details":n.stepDetails,error:n.error||null,onRetry:n.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):(f(),y("div",Gt,[g("div",Ht,[(f(!0),y(P,null,x(n.stages,r=>(f(),B(p,{key:r.id,stage:r,"zero-point-tickets":n.zeroPointTickets[r.id]||[],onTicketMoved:n.handleTicketDrop,onTicketAssigned:n.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])]))],2)}const Jt=C(Wt,[["render",Ft],["__scopeId","data-v-78d3c2bb"]]);export{Jt as default};
