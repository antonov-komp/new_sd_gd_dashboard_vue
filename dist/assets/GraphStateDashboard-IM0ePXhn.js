const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ticketListUtils-DkLssXzA.js","assets/index-6tmEtBfz.js","assets/main-BZ9iOZN1.js","assets/main-hkNOQW78.css","assets/index-Bxxce_5E.css","assets/index-DYb9GAfV.js"])))=>i.map(i=>d[i]);
import{_ as Re,a as A,o as C,b as i,F as pe,e as ge,n as oe,l as he,t as O,g as N,c as ee,G as Ue,m as Le,f as Ne,d as Z,j as ue,k as Me,H as Xe,i as ne,B as Ze,T as $t,I as Pt,u as Qe,J as Be,K as qe,p as at,L as it,x as Vt,M as Kt,N as Lt,C as Bt,O as rt,D as Yt,P as Gt,Q as Xt,y as st,R as je,z as qt,r as Jt}from"./main-BZ9iOZN1.js";import{L as It,D as Zt,B as Qt}from"./index-DYb9GAfV.js";import{S as ct,d as ut,K as ea,D as Mt,B as gt,m as Nt,e as nt,f as me,h as Rt,j as ta,T as Ft,k as aa,l as xt}from"./index-6tmEtBfz.js";const Ae={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Ie{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new Pe("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new Pe("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const s=this.validateSectorData(t);if(!s.isValid)throw new Pe(`Ошибка валидации данных сектора: ${s.errors.join(", ")}`,"VALIDATION_ERROR",{validation:s});const n=this.normalizeSectorData(t),c={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||Ae.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},o=this.validateSnapshot(c);if(!o.isValid)throw new Pe(`Ошибка валидации слепка: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",o.warnings);const u=this.getApiBaseUrl(),f=await fetch(`${u}${Ae.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:e,date:this.formatDate(new Date)})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const p=await f.json();if(!p.success)throw new Error(p.message||"Ошибка создания слепка");return p.data.snapshot}catch(s){throw console.error("SnapshotService.createSnapshot error:",s),s instanceof Pe?s:new Pe(`Ошибка создания слепка: ${s.message}`,"API_ERROR",{originalError:s})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ae.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,l=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ae.defaultSectorId);const s=`${this.getApiBaseUrl()}${Ae.snapshotsEndpoint}?${e.toString()}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка получения списка слепков");return(await Promise.all(l.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(u){return console.warn(`Ошибка загрузки слепка ${o.date}/${o.type}:`,u),null}}))).filter(o=>o!==null).sort((o,u)=>new Date(o.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:s={}}=t,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},l=[],c=[],o=[];e.forEach(p=>{const d=p.id;if(n[d]){let g=0;p.employees.forEach(S=>{const k=S.tickets||[];g+=k.length;let w=l.find(D=>D.id===S.id);w||(w={id:S.id,name:S.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(w)),k.forEach(D=>{c.push(D.id),o.push({id:D.id,title:D.title||"Без названия",assignedTo:{id:S.id,name:S.name},createdAt:D.createdAt||"",updatedAt:D.modifiedAt||D.updatedAt||""}),w.ticketsByStage[d]=(w.ticketsByStage[d]||0)+1,w.totalTickets+=1})}),n[d].count=g}});const u={unassigned:0,keeper:0,total:0};Object.values(s).forEach(p=>{Array.isArray(p)&&p.forEach(d=>{u.total+=1,d.assigneeId===1051||d.assignedById===1051?u.keeper+=1:u.unassigned+=1,c.push(d.id),o.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const f=Object.values(n).reduce((p,d)=>p+d.count,0)+u.total;return{statistics:{stages:{...n,total:f},employees:l,zeroPoint:u},ticketIds:[...new Set(c)],tickets:o}}static generateSnapshotMetadata(t,e,a){const s=new Date,n=-s.getTimezoneOffset(),l=Math.floor(n/60),c=n%60,o=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`,u=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${o}`;return{version:Ae.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${s}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,s=a.getFullYear(),n=this.getWeekNumber(a),l=this.formatDate(t);let c;if(e==="current"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`current-state-${l}-${u}.json`}else if(e==="manual"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`manual-${l}-${u}.json`}else c=`${e}-${l}.json`;return e==="current"?`current/${c}`:`${s}/week-${n}/${c}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const s=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-s)/864e5+1)/7)}static validateSnapshot(t){var s,n,l;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const c=t.statistics.stages,o=(((s=c.formed)==null?void 0:s.count)||0)+(((n=c.review)==null?void 0:n.count)||0)+(((l=c.execution)==null?void 0:l.count)||0);c.total!==o&&a.push(`Несоответствие общего количества тикетов: ожидается ${o}, указано ${c.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const c=t.statistics.zeroPoint,o=(c.unassigned||0)+(c.keeper||0);c.total!==o&&a.push(`Несоответствие статистики нулевой точки: ожидается ${o}, указано ${c.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const c=new Set(t.ticketIds),o=new Set(t.tickets.map(u=>u.id));c.size!==o.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((u,f)=>{u.id||e.push(`Тикет #${f}: отсутствует ID`),u.title||e.push(`Тикет #${f}: отсутствует заголовок`),(!u.assignedTo||!u.assignedTo.id)&&a.push(`Тикет #${f}: отсутствует ответственный (может быть в нулевой точке)`),u.createdAt||e.push(`Тикет #${f}: отсутствует дата создания`),u.updatedAt||e.push(`Тикет #${f}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ae.snapshotsEndpoint}`,l=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const s of e)try{await this.deleteSnapshot(s.metadata.createdAt.split("T")[0],s.metadata.type)&&a++}catch(n){console.warn(`Ошибка удаления слепка ${s.metadata.createdAt}:`,n)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ae.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,s=(e.getDay()||7)-1,n=new Date(e);return n.setDate(e.getDate()-s),n.setHours(0,0,0,0),n}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,s=7-(e.getDay()||7),n=new Date(e);return n.setDate(e.getDate()+s),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),s=this.getWeekNumberInfo(t),n=await this.getAllSnapshots({startDate:e,endDate:a}),l=n.find(u=>u.metadata.type==="week_start")||null,c=n.find(u=>u.metadata.type==="week_end")||null,o=n.filter(u=>u.metadata.type==="manual");return{weekStart:l,weekEnd:c,manual:o,weekInfo:s}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof Pe)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},s=new Map;let n=null,l=null;e.forEach(o=>{const u=o.metadata.type;a.hasOwnProperty(u)&&a[u]++;const f=this.getWeekNumberInfo(o.metadata.createdAt),p=`${f.year}-W${f.week}`;s.set(p,(s.get(p)||0)+1);const d=new Date(o.metadata.createdAt);(!n||d<new Date(n.metadata.createdAt))&&(n=o),(!l||d>new Date(l.metadata.createdAt))&&(l=o)});const c=Array.from(s.entries()).map(([o,u])=>{const[f,p]=o.split("-W");return{year:parseInt(f),week:parseInt(p),count:u}}).sort((o,u)=>o.year!==u.year?o.year-u.year:o.week-u.week);return{total:e.length,byType:a,byWeek:c,oldest:n,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class Pe extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const $e={formed:{bitrixId:ut.formed,name:ct.FORMED.name},review:{bitrixId:ut.review,name:ct.REVIEW.name},execution:{bitrixId:ut.execution,name:ct.EXECUTION.name}},Je=ea;function sa(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=na(r.stages),e=oa(r.stages),a=la(r.zeroPointTickets||{}),s=ra(r.zeroPointTickets||{}),n=ia(r.stages,r.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:s},ticketIds:n.ticketIds,tickets:n.tickets}}function na(r){const t={formed:{count:0,stageId:$e.formed.bitrixId,stageName:$e.formed.name},review:{count:0,stageId:$e.review.bitrixId,stageName:$e.review.name},execution:{count:0,stageId:$e.execution.bitrixId,stageName:$e.execution.name},total:0};return r.forEach(e=>{if(!$e[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(s=>{s.tickets&&Array.isArray(s.tickets)&&(a+=s.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function oa(r){const t=new Map;return r.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const s=t.get(a.id),n=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;$e[e.id]&&(s.ticketsByStage[e.id]=(s.ticketsByStage[e.id]||0)+n),s.totalTickets+=n})}),Array.from(t.values())}function la(r){let t=0,e=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t++:(typeof n=="object"?n.id:n)===Je?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function ra(r){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(t).forEach(e=>{const a=r[e];Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t[e].unassigned++:(typeof n=="object"?n.id:n)===Je?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function ia(r,t){const e=new Set,a=new Map;return Array.isArray(r)&&r.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const c=parseInt(l.id);if(isNaN(c)){console.warn("Invalid ticket ID:",l.id);return}e.add(c);let o=l.assignedTo;!o&&n.id&&(o={id:n.id,name:n.name||`Сотрудник #${n.id}`}),a.set(c,{id:c,title:l.title||"Без названия",assignedTo:o||null,createdAt:tt(l.createdAt||l.createdTime),updatedAt:tt(l.updatedAt||l.modifiedAt||l.updatedTime),stageId:l.stageId||s.id||null,departmentHead:l.departmentHead||null,departmentHeadFull:l.departmentHeadFull||l.departmentHead||null,priorityId:l.priorityId||null,priorityLabel:l.priorityLabel||null,service:l.service||null,serviceLabel:l.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",n.id);return}e.add(l);let c=n.assignedTo;if(!c&&n.assignedById){const o=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;o&&o!==Je?c={id:o,name:"Неизвестный"}:o===Je&&(c={id:Je,name:"Хранитель объектов"})}a.set(l,{id:l,title:n.title||"Без названия",assignedTo:c||null,createdAt:tt(n.createdAt||n.createdTime),updatedAt:tt(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((s,n)=>s-n),tickets:Array.from(a.values())}}function tt(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const t=new Date(r);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",r),null}class ft{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:s=!0,includeTicketDetails:n=!1}=t;try{const l=await Mt.getSectorData(e,a);return s?sa(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await Mt.getSectorData(!0);return t!=null}catch{return!1}}}class dt{static compareTwoSnapshots(t,e,a={}){const{includeTickets:s=!1,includeEmployees:n=!0}=a,l=this.validateSnapshot(t),c=this.validateSnapshot(e);if(!l.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...c.errors].join(", "));const o=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),f=n?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],p=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=s?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,g=this.buildSummary(u,f,p,d);return{metadata:o,stages:u,employees:f,zeroPoint:p,tickets:d,summary:g}}static calculateDelta(t,e){const a=this.normalizeValue(t),s=this.normalizeValue(e),n=s-a;let l=0;a!==0?l=n/a*100:s!==0&&(l=s>0?1/0:-1/0);const c=this.getTrend(n);return{value1:a,value2:s,delta:n,deltaPercent:Math.round(l*100)/100,trend:c}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var c,o;const a=["formed","review","execution"],s={};for(const u of a){const f=((c=t[u])==null?void 0:c.count)||0,p=((o=e[u])==null?void 0:o.count)||0;s[u]=this.calculateDelta(f,p)}const n=t.total||0,l=e.total||0;return s.total=this.calculateDelta(n,l),s}static compareEmployees(t,e){var c,o;const a=new Map(t.map(u=>[u.id,u])),s=new Map(e.map(u=>[u.id,u])),n=new Set([...a.keys(),...s.keys()]),l=[];for(const u of n){const f=a.get(u)||null,p=s.get(u)||null;if(!f||!p){l.push({id:u,name:(f==null?void 0:f.name)||(p==null?void 0:p.name)||"Неизвестный",snapshot1:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,snapshot2:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,delta:this.calculateEmployeeDelta(f,p),trend:f?"removed":"new"});continue}const d={},g=["formed","review","execution"];for(const k of g){const w=((c=f.ticketsByStage)==null?void 0:c[k])||0,D=((o=p.ticketsByStage)==null?void 0:o[k])||0;d[k]=this.calculateDelta(w,D)}const S=this.calculateDelta(f.totalTickets||0,p.totalTickets||0);l.push({id:u,name:f.name,snapshot1:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},snapshot2:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},delta:{ticketsByStage:d,totalTickets:S},trend:S.trend})}return l}static calculateEmployeeDelta(t,e){var l,c;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},s=["formed","review","execution"];for(const o of s){const u=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[o])||0,f=((c=e==null?void 0:e.ticketsByStage)==null?void 0:c[o])||0;a[o]=this.calculateDelta(u,f)}const n=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:n}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,s){var g,S;const n=new Set(t),l=new Set(e),c=e.filter(k=>!n.has(k)),o=t.filter(k=>!l.has(k)),u=[],f=[],p=new Map(a.map(k=>[k.id,k])),d=new Map(s.map(k=>[k.id,k]));for(const k of t){if(!l.has(k))continue;const w=p.get(k),D=d.get(k);if(!w||!D)continue;const T=(((g=w.assignedTo)==null?void 0:g.id)||null)!==(((S=D.assignedTo)==null?void 0:S.id)||null),V=(w.stageId||null)!==(D.stageId||null);T||V?u.push(k):f.push(k)}return{new:c,removed:o,changed:u,unchanged:f}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),s=new Date(e.metadata.createdAt),n=new Date,l=s.getTime()-a.getTime(),c=Math.floor(l/(1e3*60*60*24)),o=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:n.toISOString(),timeDiff:{days:c,hours:o,minutes:u,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,a,s){var u,f,p;const n=t.total.delta,l=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,c=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,o=n!==0||l>0||c>0;return{totalDelta:n,stagesChanged:l,employeesChanged:c,hasChanges:o,newTicketsCount:((u=s==null?void 0:s.new)==null?void 0:u.length)||0,removedTicketsCount:((f=s==null?void 0:s.removed)==null?void 0:f.length)||0,changedTicketsCount:((p=s==null?void 0:s.changed)==null?void 0:p.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const s=["formed","review","execution"];for(const n of s)t.statistics.stages[n]||a.push(`Missing stage: ${n}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const c=this.validateSnapshot(l);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...t].sort((l,c)=>{const o=new Date(l.metadata.createdAt),u=new Date(c.metadata.createdAt);return o-u}),s=[];for(let l=0;l<a.length-1;l++)s.push({from:l,to:l+1,result:this.compareTwoSnapshots(a[l],a[l+1],e)});const n=this.buildTrends(a);return{snapshots:a.map((l,c)=>({index:c,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:s,trends:n}}static buildTrends(t){var a,s,n,l,c,o,u,f,p,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const g of t){const S=g.statistics;e.stages.formed.push(((s=(a=S.stages)==null?void 0:a.formed)==null?void 0:s.count)||0),e.stages.review.push(((l=(n=S.stages)==null?void 0:n.review)==null?void 0:l.count)||0),e.stages.execution.push(((o=(c=S.stages)==null?void 0:c.execution)==null?void 0:o.count)||0),e.stages.total.push(((u=S.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((f=S.zeroPoint)==null?void 0:f.unassigned)||0),e.zeroPoint.keeper.push(((p=S.zeroPoint)==null?void 0:p.keeper)||0),e.zeroPoint.total.push(((d=S.zeroPoint)==null?void 0:d.total)||0)}return e}}const ca={class:"stages-container"},ua={class:"stages-chips"},da=["checked","disabled","onChange"],pa={class:"stage-chip-label"},ga={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:r=>r.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t;function s(n,l){const c={...e.selected};c[n]=l,a("update:selected",c),a("change",n,l)}return(n,l)=>(C(),A("div",ca,[l[0]||(l[0]=i("h4",{class:"stages-title"},"Этапы для отображения:",-1)),i("div",ua,[(C(!0),A(pe,null,ge(r.stages,c=>(C(),A("label",{key:c.id,class:oe(["stage-chip",{"stage-chip--active":r.selected[c.id],"stage-chip--disabled":r.disabled}])},[i("input",{type:"checkbox",checked:r.selected[c.id],disabled:r.disabled,onChange:o=>s(c.id,o.target.checked)},null,40,da),i("span",{class:"stage-chip-color",style:he({backgroundColor:c.color})},null,4),i("span",pa,O(c.name),1)],2))),128))])]))}},fa=Re(ga,[["__scopeId","data-v-fe03c03c"]]),pt=140,We=new Map;class jt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await gt.call("crm.item.list",{entityTypeId:pt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let a=[];if(e&&e.result&&(Array.isArray(e.result)?a=e.result:e.result.items&&Array.isArray(e.result.items)?a=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(a=e.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const s=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s),ticketSample:JSON.stringify(s).substring(0,500)});const n=Nt(s),l=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:n.departmentHead,departmentHeadFull:l?String(l).trim():null});let c=null;if(l){const o=String(l).trim();o.length>0&&(c=o)}return{...n,departmentHeadFull:c}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(s=>{We.has(s)?e.push(We.get(s)):a.push(s)}),a.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:pt});const s=await gt.call("crm.item.list",{entityTypeId:pt,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!s,resultType:typeof s,resultKeys:s?Object.keys(s):[],hasResultResult:!!(s!=null&&s.result),resultResultType:typeof(s==null?void 0:s.result),isArray:Array.isArray(s==null?void 0:s.result),resultResultLength:Array.isArray(s==null?void 0:s.result)?s.result.length:"not array",fullResult:s});let n=[];if(s&&s.result&&(Array.isArray(s.result)?n=s.result:s.result.items&&Array.isArray(s.result.items)?n=s.result.items:s.result.data&&Array.isArray(s.result.data)&&(n=s.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!s,hasResultResult:!!(s!=null&&s.result),resultType:typeof(s==null?void 0:s.result),result:s,resultKeys:s?Object.keys(s):[]}),e;const l=n.map((c,o)=>{o===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const u=Nt(c);o===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:u.id,hasDepartmentHead:!!u.departmentHead,departmentHead:u.departmentHead,mappedTicketKeys:Object.keys(u).filter(g=>g.toLowerCase().includes("department"))});const f=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;o===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:f,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm"))});let p=null;if(f){const g=String(f).trim();g.length>0&&(p=g)}!p&&u.departmentHead&&(p=u.departmentHead);const d={...u,departmentHeadFull:p||u.departmentHead||null};return o===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&We.set(d.id,d),d});return[...e,...l]}catch(s){return console.error("[TicketDetailsService] Error loading tickets details batch:",s),console.error("[TicketDetailsService] Error details:",{message:s.message,stack:s.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){We.size>t&&We.clear()}static getCacheSize(){return We.size}}async function ma(r,t,e,a=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:r,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!r||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const s=e.tickets.filter(f=>{const p=f.assignedTo;return p?(typeof p=="object"?p.id:p)===r:!1});if(s.length===0)return[];const n=!s[0].stageId||!s[0].departmentHead;let l=null;if(n){const f=s.map(p=>p.id);if(a&&typeof a=="object")l=a;else try{const p=await jt.getTicketsDetails(f);l=new Map,p.forEach(d=>{d&&d.id&&l.set(d.id,d)})}catch(p){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",p),l=null}}return s.map(f=>{const p=f.id,d={id:p,title:f.title||"Без названия",assignedTo:f.assignedTo,createdAt:f.createdAt,updatedAt:f.updatedAt};if(l){const g=l instanceof Map?l.get(p):l[p];g?(d.stageId=g.stageId||null,d.departmentHead=g.departmentHead||null,d.departmentHeadFull=g.departmentHeadFull||g.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=f.stageId||null,d.departmentHead=f.departmentHead||null,d.departmentHeadFull=f.departmentHeadFull||f.departmentHead||null;return d}).filter(f=>f.stageId?nt(f.stageId)===t:!0)}function Ht(r,t=new Date){if(!r||r.length===0)return[];const e=r.length,a={};return Object.values(me).forEach(n=>{a[n]={category:n,label:Rt[n].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:Rt[n].color}}),r.forEach(n=>{if(!n.createdAt){a[me.MORE_THAN_YEAR].count++,a[me.MORE_THAN_YEAR].tickets.push(n);return}const l=ta(n.createdAt,t);a[l]&&(a[l].count++,a[l].tickets.push(n))}),Object.values(a).filter(n=>n.count>0).map(n=>{const l=e>0?parseFloat((n.count/e*100).toFixed(1)):0;return{...n,percentage:l,progressBarWidth:l}}).sort((n,l)=>{const c=[me.TODAY,me.YESTERDAY,me.THIS_WEEK,me.LAST_WEEK,me.MORE_THAN_TWO_WEEKS,me.UP_TO_ONE_MONTH,me.MORE_THAN_TWO_MONTHS,me.MORE_THAN_HALF_YEAR,me.MORE_THAN_YEAR];return c.indexOf(n.category)-c.indexOf(l.category)})}function ha(r){if(!r||r.length===0)return[];const t={};r.forEach(a=>{let s=a.departmentHeadFull||a.departmentHead;r.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(n=>n.toLowerCase().includes("department"))}),s?(s=String(s).trim(),s.length===0&&(s="Без заказчика")):s="Без заказчика",t[s]||(t[s]={departmentName:s,count:0}),t[s].count++});const e=Object.values(t);return e.sort((a,s)=>s.count!==a.count?s.count-a.count:a.departmentName.localeCompare(s.departmentName,"ru")),e}const ze=10;function ot(r,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(s=>s.ticketsByStage&&s.ticketsByStage[r]>0).forEach(s=>{e.push({id:s.id,name:s.name,count:s.ticketsByStage[r]||0})});const a=va(r,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((s,n)=>n.count-s.count)}function va(r,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[r])return t.statistics.zeroPointByStage[r].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Wt(r,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[r])==null?void 0:e.count)||0}function lt(r,t=ze){if(!r||r.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...r].sort((l,c)=>c.count-l.count),a=e.slice(0,t),s=e.slice(t),n=s.reduce((l,c)=>l+c.count,0);return{visible:a,others:{employees:s,count:n,employeeCount:s.length}}}function Ut(r,t){return!r||r.length===0?[]:t===0?r.map(e=>({...e,percentage:0})):r.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function et(r,t,e="#007bff",a=ze){if(!r||r.length===0)return{employees:[],others:null};const{visible:s,others:n}=lt(r,a),l=Ut(s,t).map(o=>({...o,progressBarWidth:o.percentage,progressBarColor:o.isKeeper?"#f59e0b":e}));let c=null;if(n.count>0){const o=parseFloat((n.count/t*100).toFixed(1));c={...n,percentage:o,progressBarWidth:o,progressBarColor:"#6c757d"}}return{employees:l,others:c}}function ya(r,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(s=>{const n=t[s];if(!n)return;const l=ot(r,n),c=Wt(r,n);if(l.length===0)return;const{visible:o,others:u}=lt(l,ze),f=Ut(o,c);e[s]=f,u.count>0&&(e.others[s]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/c*100).toFixed(1))})}),e}function ka(r,t="current",e=[]){const a=r[t];if(!a)return{labels:[],datasets:[]};const s=new Map;e.forEach(p=>{ot(p.id,a).forEach(g=>{s.has(g.id)||s.set(g.id,{id:g.id,name:g.name,isKeeper:g.isKeeper||!1,ticketsByStage:{}}),s.get(g.id).ticketsByStage[p.id]=g.count})});const n=Array.from(s.values()).map(p=>{const d=Object.values(p.ticketsByStage).reduce((g,S)=>g+S,0);return{...p,totalTickets:d}});n.sort((p,d)=>d.totalTickets-p.totalTickets);const{visible:l,others:c}=lt(n,ze),o=e.map(()=>""),u={};e.forEach(p=>{const d=ot(p.id,a),{visible:g}=lt(d,ze);u[p.id]=g.map(S=>({id:S.id,name:S.name,count:S.count}))});const f=l.map((p,d)=>{const g=e.map(k=>p.ticketsByStage[k.id]||0),S=e.map(k=>{if((p.ticketsByStage[k.id]||0)===0)return"transparent";const T=k.color.replace("#",""),V=parseInt(T.substring(0,2),16),Q=parseInt(T.substring(2,4),16),ae=parseInt(T.substring(4,6),16),B=.6+d*.05;return`rgba(${V}, ${Q}, ${ae}, ${Math.min(B,.95)})`});return{label:p.name,data:g,backgroundColor:S,borderColor:e.map(k=>{const w=k.color.replace("#",""),D=parseInt(w.substring(0,2),16),T=parseInt(w.substring(2,4),16),V=parseInt(w.substring(4,6),16);return`rgba(${D}, ${T}, ${V}, 0.8)`}),borderWidth:1,meta:{employeeId:p.id,employeeName:p.name}}});if(c.count>0){const p=e.map(d=>c.employees.reduce((g,S)=>g+(S.ticketsByStage[d.id]||0),0));f.push({label:`Другие (${c.employeeCount})`,data:p,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:o,datasets:f,meta:{employeesByStage:u}}}function wa(r,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(u=>u.id===r),s=a?a.name:"",n=a?a.color:"#007bff",l=ot(r,t),c=Wt(r,t);if(l.length===0)return{stageName:s,totalCount:0,employees:[],others:null};const o=et(l,c,n,ze);return{stageName:s,totalCount:c,employees:o.employees,others:o.others}}function ba(r,t){return(t==null?void 0:t[r])||r}function Da(r,t){return(t==null?void 0:t[r])||"#007bff"}function mt({snapshots:r,graphType:t,timePoint:e,snapshotType:a}){return r?t==="line"&&e?r[e]||null:t==="bar"&&a?r[a]||null:r.current||r.weekEnd||r.weekStart||null:null}function ht(r,t){var e,a,s;return((s=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[r])==null?void 0:s.count)||0}function Sa({stageId:r,timePoint:t,meta:e,snapshots:a,stageColor:s,maxVisible:n}){if(!(e!=null&&e.employees)||!t)return null;const l=e.employees[t];if(!l||l.length===0)return null;const c=(a==null?void 0:a[t])||null,o=ht(r,c)||l.reduce((f,p)=>f+(p.count||0),0),u=et(l,o,s,n);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}function Ea({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s}){var u;const n=(u=t==null?void 0:t.employees)==null?void 0:u[r];if(!n||!n.employees||n.employees.length===0)return null;const l=mt({snapshots:e,graphType:"doughnut"}),c=n.totalCount??ht(r,l)??n.employees.reduce((f,p)=>f+(p.count||0),0),o=et(n.employees,c,a,s);return{stageId:r,totalCount:c,employees:o.employees,others:o.others,snapshot:l}}function _a({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s,snapshotType:n}){var f;const l=(f=t==null?void 0:t.employeesByStage)==null?void 0:f[r];if(!l||l.length===0)return null;const c=mt({snapshots:e,graphType:"bar",snapshotType:n}),o=ht(r,c)||l.reduce((p,d)=>p+(d.count||0),0),u=et(l,o,a,s);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}async function zt({stageId:r,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:s=null,meta:n=null,stageColorMap:l=null,stageNameMap:c=null,maxVisible:o=10,restLoader:u=null}){if(!r)throw new Error("stageId обязателен для загрузки данных уровня 1");const f=ba(r,c),p=Da(r,l);let d=null;if(t==="line"?d=Sa({stageId:r,timePoint:e,meta:n==null?void 0:n.line,snapshots:s,stageColor:p,maxVisible:o}):t==="doughnut"?d=Ea({stageId:r,meta:n==null?void 0:n.doughnut,snapshots:s,stageColor:p,maxVisible:o}):t==="bar"&&(d=_a({stageId:r,meta:n==null?void 0:n.bar,snapshots:s,stageColor:p,maxVisible:o,snapshotType:a})),d)return{stageId:r,stageName:f,color:p,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot};if(typeof u=="function"){const g=await u({stageId:r,graphType:t,timePoint:e,snapshotType:a,snapshots:s});if(g&&Array.isArray(g.employees)){const S=g.totalCount??g.employees.reduce((w,D)=>w+(D.count||0),0),k=et(g.employees,S,p,o);return{stageId:r,stageName:f,color:p,totalCount:S,employees:k.employees,others:k.others,snapshot:g.snapshot||mt({snapshots:s,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const Ca={key:"level-1",class:"level-1"},Ta={class:"modal-header"},Aa={class:"stage-header"},$a=["aria-expanded","onKeydown"],Ia={class:"stage-title"},Ma=["aria-selected","onClick","onKeydown"],Na={class:"stage-name"},Ra={class:"modal-total"},Fa={class:"view-switcher"},xa={class:"modal-body"},Ha={key:0,class:"load-error"},Oa={key:1,class:"stage-loader"},Pa={key:2},La={key:0,class:"no-employees"},Ba={key:1,class:"employees-list"},ja=["onClick"],Wa={class:"employee-name"},Ua={class:"employee-progress"},za={class:"employee-count"},Va={key:0,class:"employee-item employee-others"},Ka={class:"employee-name"},Ya={class:"employee-progress"},Ga={class:"employee-count"},Xa={key:3,class:"view-time"},qa={key:0,class:"no-data"},Ja={key:1,class:"date-categories-list"},Za=["onClick"],Qa={class:"category-label"},es={class:"category-progress"},ts={class:"category-count"},as={key:4,class:"view-departments"},ss={key:0,class:"no-data"},ns={key:1,class:"departments-table-container"},os={class:"departments-table"},ls=["onClick"],rs={class:"col-department"},is={class:"department-name"},cs={class:"col-count"},us={class:"count-value"},ds={key:"level-2",class:"level-2"},ps={class:"modal-header"},gs={class:"modal-total"},fs={class:"modal-body"},ms={class:"stage-info"},hs={class:"stage-badge"},vs={key:0,class:"no-data"},ys={key:1,class:"date-categories-list"},ks=["onClick"],ws={class:"category-label"},bs={class:"category-progress"},Ds={class:"category-count"},Ss={key:"level-3",class:"level-3"},Es={class:"modal-header"},_s={class:"header-info"},Cs={class:"header-badges"},Ts={class:"date-badge"},As={class:"stage-badge"},$s={class:"modal-total"},Is={class:"modal-body"},Ms={key:0,class:"no-data"},Ns={key:1,class:"departments-table-container"},Rs={class:"departments-table"},Fs=["onClick"],xs={class:"col-department"},Hs={class:"department-name"},Os={class:"col-count"},Ps={class:"count-value"},Ls={key:"level-4",class:"level-4"},Bs={class:"modal-header"},js={class:"header-info"},Ws={key:0,class:"header-badges"},Us={key:0,class:"date-badge"},zs={key:1,class:"department-badge"},Vs={class:"stage-badge"},Ks={class:"modal-total"},Ys={class:"modal-body"},Gs={key:"loading",class:"loading-state"},Xs={key:"error-fallback",class:"error-state-with-fallback"},qs={class:"tickets-list-container"},Js={key:"error",class:"error-state"},Zs={class:"error-message"},Qs={key:"empty",class:"empty-state"},en={class:"empty-state-title"},tn={class:"empty-state-message"},an={key:"tickets",class:"tickets-list-container"},sn={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(r,{expose:t,emit:e}){const a=r,s=e,n=Qe(),l=N(1),c=N("employees"),o=N(null),u=N([]),f=N([]),p=N(null),d=N(null),g=N(null),S=N(a.stageSwitchContext||null),k=N(!1),w=N(null),D=N(null),T=N(!1),V=N(null),Q=N(null),ae=ee(()=>{var y,I;const v=((y=S.value)==null?void 0:y.stageNameMap)||{},b=((I=S.value)==null?void 0:I.stageColorMap)||{};return Object.keys(v).map(Y=>{var U;return{id:Y,name:v[Y],color:b[Y]||"#007bff",disabled:Y===(((U=o.value)==null?void 0:U.stageId)||a.stageId)}})});ee(()=>l.value>1);const B=ee(()=>{var v,b,y,I,Y;switch(l.value){case 1:return((v=o.value)==null?void 0:v.stageName)||a.stageName;case 2:return((b=p.value)==null?void 0:b.employeeName)||"";case 3:return`${((y=p.value)==null?void 0:y.employeeName)||""} — ${((I=d.value)==null?void 0:I.dateCategoryLabel)||""}`;case 4:if(!((Y=g.value)!=null&&Y.context))return"Список тикетов";const U=g.value.context,se=[];return U.employeeName&&se.push(U.employeeName),U.dateCategoryLabel&&se.push(U.dateCategoryLabel),U.departmentName&&se.push(U.departmentName),U.stageName&&se.push(U.stageName),se.length>0?se.join(" — "):"Список тикетов";default:return""}});function P(){var v,b,y;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((v=a.employees)==null?void 0:v.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((y=(b=a.snapshot)==null?void 0:b.ticketIds)==null?void 0:y.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",G(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function G(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const v=o.value.snapshot.tickets||[],b=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:v.length,currentStageId:b,sampleTicket:v[0]?{id:v[0].id,stageId:v[0].stageId,hasDepartmentHead:!!v[0].departmentHead,departmentHead:v[0].departmentHead,hasDepartmentHeadFull:!!v[0].departmentHeadFull,departmentHeadFull:v[0].departmentHeadFull,allKeys:Object.keys(v[0])}:null});let y=v.filter(H=>H.stageId?nt(H.stageId)===b:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:v.length,afterFilter:y.length,stageId:b,ticketsWithStageId:y.filter(H=>H.stageId).length,ticketsWithoutStageId:y.filter(H=>!H.stageId).length});const I=y.filter(H=>!H.departmentHead&&!H.departmentHeadFull);if(I.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:I.length,totalTickets:y.length,ticketsWithDepartment:y.filter(J=>J.departmentHead||J.departmentHeadFull).length});const H=I.map(J=>J.id).filter(J=>J);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:H.length,ticketIdsSample:H.slice(0,10)});const J=await jt.getTicketsDetails(H),ce=new Map;J.forEach(h=>{h&&h.id&&ce.set(h.id,h)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:J.length,detailsMapSize:ce.size,sampleDetail:J[0]?{id:J[0].id,departmentHead:J[0].departmentHead,departmentHeadFull:J[0].departmentHeadFull}:null}),y=y.map(h=>{const M=ce.get(h.id);return M?{...h,stageId:M.stageId||h.stageId||null,departmentHead:M.departmentHead||h.departmentHead||null,departmentHeadFull:M.departmentHeadFull||M.departmentHead||h.departmentHead||null}:h}),y=y.filter(h=>h.stageId?nt(h.stageId)===b:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:y.length,ticketsWithDepartment:y.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,ticketsWithStageId:y.filter(h=>h.stageId).length,ticketsWithoutStageId:y.filter(h=>!h.stageId).length});const _=y.length,m=y.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));y=y.filter(h=>h.stageId?nt(h.stageId)===b:!0);const E=y.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:_,afterStageFilter:y.length,filteredOut:_-y.length,currentStageId:b,ticketsWithDepartment:y.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,sampleBeforeFilter:m,sampleAfterFilter:E,sampleWithDepartment:y.find(h=>h.departmentHead||h.departmentHeadFull)?{id:y.find(h=>h.departmentHead||h.departmentHeadFull).id,departmentHead:y.find(h=>h.departmentHead||h.departmentHeadFull).departmentHead,departmentHeadFull:y.find(h=>h.departmentHead||h.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(y.find(h=>h.departmentHead||h.departmentHeadFull)).filter(h=>h.toLowerCase().includes("department"))}:null})}catch(J){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",J),console.error("[EmployeeDetailsModal] Error details:",{message:J.message,stack:J.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:y.length,currentStageId:b,ticketsWithStageId:y.filter(H=>H.stageId).length,ticketsWithoutStageId:y.filter(H=>!H.stageId).length,ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length});const Y=Ht(y);u.value=Y,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:y.length,sampleTickets:y.slice(0,5).map(H=>({id:H.id,departmentHead:H.departmentHead,departmentHeadFull:H.departmentHeadFull,hasDepartmentHead:!!H.departmentHead,hasDepartmentHeadFull:!!H.departmentHeadFull,allKeys:Object.keys(H).filter(J=>J.toLowerCase().includes("department"))})),ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length});const U=ha(y);f.value=U;const se=Y.reduce((H,J)=>H+J.count,0),Ce=U.reduce((H,J)=>H+J.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:b,totalTicketsForGrouping:y.length,timeCategoriesCount:Y.length,totalTicketsInTimeCategories:se,departmentsCount:U.length,totalTicketsInDepartments:Ce,departmentsSample:U.slice(0,5),ticketsWithDepartment:y.filter(H=>H.departmentHead||H.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(H=>!H.departmentHead&&!H.departmentHeadFull).length,consistencyCheck:{totalTickets:y.length,timeCategoriesTotal:se,departmentsTotal:Ce,isConsistent:y.length===se&&y.length===Ce}})}catch(v){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",v),console.error("[EmployeeDetailsModal] Error stack:",v.stack)}}async function q(v){var y;if(!v){n.error("Не указан stageId для загрузки данных");return}if(((y=o.value)==null?void 0:y.stageId)===v)return;if(!S.value){n.error("Нет контекста для смены стадии (stageSwitchContext)");return}k.value=!0,w.value=null;const b=o.value?{...o.value}:null;D.value=(b==null?void 0:b.stageId)||null;try{const I=await zt({...S.value,stageId:v});o.value={stageId:I.stageId,stageName:I.stageName,stageColor:I.color,totalCount:I.totalCount,employees:I.employees,others:I.others,snapshot:I.snapshot||(b==null?void 0:b.snapshot)||null,ticketDetails:I.ticketDetails||null},p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",await G()}catch(I){console.error("[EmployeeDetailsModal] Failed to reload stage data:",I),w.value=(I==null?void 0:I.message)||"Не удалось загрузить данные стадии",b&&(o.value=b),n.error(w.value)}finally{k.value=!1}}async function ie(v){if(!v||v.count===0){n.info(`У заказчика "${(v==null?void 0:v.departmentName)||"неизвестный"}" нет тикетов`);return}if(!d.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),n.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:b}=await Be(async()=>{const{createContextFromLevel3:I}=await import("./ticketListUtils-DkLssXzA.js");return{createContextFromLevel3:I}},__vite__mapDeps([0,1,2,3,4,5])),y=await b(d.value,v);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function de(v){if(!v||v.count===0){n.info(`У заказчика "${(v==null?void 0:v.departmentName)||"неизвестный"}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:b}=await Be(async()=>{const{createContextFromLevel1Department:I}=await import("./ticketListUtils-DkLssXzA.js");return{createContextFromLevel1Department:I}},__vite__mapDeps([0,1,2,3,4,5])),y=b(o.value,v);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:y.stageName,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function Fe(v){if(!v||v.count===0){n.info(`В категории "${(v==null?void 0:v.label)||"неизвестная"}" нет тикетов`);return}if(!v.tickets||v.tickets.length===0){n.info(`В категории "${v.label}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:b}=await Be(async()=>{const{createContextFromLevel1Time:I}=await import("./ticketListUtils-DkLssXzA.js");return{createContextFromLevel1Time:I}},__vite__mapDeps([0,1,2,3,4,5])),y=b(o.value,v);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:y.stageName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}Ue(()=>a.isVisible,v=>{v?P():(Se(),X())}),Ue(()=>a.stageSwitchContext,v=>{S.value=v},{deep:!0}),Le(()=>{a.isVisible&&P()});async function De(v,b=null){var y,I,Y;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",v),console.log("[EmployeeDetailsModal] Current popup level:",l.value),b&&b.currentTarget&&(b.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{b.currentTarget&&(b.currentTarget.style.transform="")},150)),!v||!v.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",v);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),n.warning("ID стадии не указан");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),n.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",v.id,"stage:",o.value.stageId);const U=await ma(v.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(U==null?void 0:U.length)||0,U),!U||U.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),n.info(`У сотрудника "${v.name}" нет тикетов на стадии "${o.value.stageName}"`);return}const se=Ht(U);console.log("[EmployeeDetailsModal] Date categories:",(se==null?void 0:se.length)||0,se),p.value={employeeId:v.id,employeeName:v.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:U.length,dateCategories:se,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),l.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",l.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(y=p.value)==null?void 0:y.employeeName,dateCategoriesCount:((Y=(I=p.value)==null?void 0:I.dateCategories)==null?void 0:Y.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",l.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(U){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",U),console.error("[EmployeeDetailsModal] Error stack:",U.stack),n.error("Ошибка загрузки данных о тикетах: "+U.message)}}async function Ve(v){if(!v||v.count===0){n.info(`В категории "${(v==null?void 0:v.label)||"неизвестная"}" нет тикетов`);return}if(!v.tickets||v.tickets.length===0){n.info(`В категории "${v.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),n.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:b}=await Be(async()=>{const{createContextFromLevel2:I}=await import("./ticketListUtils-DkLssXzA.js");return{createContextFromLevel2:I}},__vite__mapDeps([0,1,2,3,4,5])),y=b(p.value,v);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await we(y)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function we(v){var b;if(console.time("[Performance] goToLevel4"),!v){console.error("[EmployeeDetailsModal] Context is required for level 4"),n.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:v.sourceLevel,employeeId:v.employeeId,stageId:v.stageId,dateCategory:v.dateCategory,departmentName:v.departmentName,ticketsCount:((b=v.tickets)==null?void 0:b.length)||0});try{g.value={context:v,tickets:[],totalCount:0,isLoading:!0,error:null};let y=v.tickets||[];if(y.length===0&&v.snapshot){const{filterTicketsByContext:Y}=await Be(async()=>{const{filterTicketsByContext:U}=await import("./ticketListUtils-DkLssXzA.js");return{filterTicketsByContext:U}},__vite__mapDeps([0,1,2,3,4,5]));y=await Y(v)}(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),y=v.tickets||[]),(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),v.snapshot&&v.snapshot.tickets&&(y=v.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",y.length)));let I=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:Y}=await Be(async()=>{const{prepareTicketsForDisplay:U}=await import("./ticketListUtils-DkLssXzA.js");return{prepareTicketsForDisplay:U}},__vite__mapDeps([0,1,2,3,4,5]));I=await Y(y,v.snapshot,v.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(Y){console.error("[EmployeeDetailsModal] Error preparing tickets:",Y),console.timeEnd("[Performance] prepareTicketsForDisplay"),I=y||[],n.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:y.length,preparedCount:I.length}),g.value={context:v,tickets:I,totalCount:I.length,isLoading:!1,error:null},l.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:g.value.totalCount,ticketsCount:g.value.tickets.length,isLoading:g.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",y),console.error("[EmployeeDetailsModal] Error details:",{message:y.message,stack:y.stack,context:v});let I=[];if(v.snapshot&&v.snapshot.tickets)try{const Y=v.stageId;Y?I=(v.snapshot.tickets||[]).filter(U=>U.stageId===Y):I=v.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",I.length)}catch(Y){console.error("[EmployeeDetailsModal] Error using fallback tickets:",Y)}g.value={context:v,tickets:I,totalCount:I.length,isLoading:!1,error:{message:y.message,hasFallback:I.length>0}},I.length>0?(n.warning("Ошибка загрузки данных. Отображаются данные из кеша."),l.value=4):(n.error("Ошибка загрузки тикетов: "+y.message),be()),console.timeEnd("[Performance] goToLevel4")}}function be(){if(l.value===4){if(g.value&&g.value.context){const v=g.value.context.sourceLevel;l.value=v}else l.value=1;g.value=null}else l.value===3?(l.value=2,d.value=null,g.value=null):l.value===2&&(l.value=1,p.value=null,d.value=null,g.value=null)}function Se(){l.value=1,o.value=null,p.value=null,d.value=null,g.value=null}function Ke(){var Y;if(!((Y=g.value)!=null&&Y.context))return"Нет тикетов";const{sourceLevel:v,employeeName:b,dateCategoryLabel:y,departmentName:I}=g.value.context;return v===2&&b&&y?`Нет тикетов у ${b} в категории "${y}"`:v===3&&b&&I?`Нет тикетов у ${b} у заказчика "${I}"`:v===1&&y?`Нет тикетов в категории "${y}"`:v===1&&I?`Нет тикетов у заказчика "${I}"`:"Нет тикетов для отображения"}function Ye(){var b;if(!((b=g.value)!=null&&b.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:v}=g.value.context;return v?`На стадии "${v}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function Ee(){var b;if(!((b=g.value)!=null&&b.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const v=g.value.context;await we(v)}function _e(v){if(!v){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),n.warning("Ошибка: тикет не найден");return}if(!v.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",v),n.error("Ошибка: ID тикета не указан");return}try{const b=aa(v.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:v.id,iframeUrl:b}),!b||typeof b!="string"||b.length===0)throw new Error("Не удалось сформировать URL для тикета");const y=window.open(b,"_blank","noopener,noreferrer");if(!y||y.closed||typeof y.closed>"u")try{const I=document.createElement("a");I.href=b,I.target="_blank",I.rel="noopener noreferrer",I.style.display="none",document.body.appendChild(I),I.click(),document.body.removeChild(I),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:v.id,iframeUrl:b})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:v.id,iframeUrl:b})}catch(b){console.error("[EmployeeDetailsModal] Error opening ticket:",b),console.error("[EmployeeDetailsModal] Error details:",{message:b.message,stack:b.stack,ticket:v}),n.error("Ошибка открытия тикета: "+b.message)}}function ve(){Se(),s("close")}t({reloadLevel1ForStage:q});function L(v){v&&v.stopPropagation(),T.value=!T.value}function X(){T.value&&(T.value=!1)}function ye(v){if(!T.value)return;const b=V.value,y=Q.value;b&&b.contains(v.target)||y&&y.contains(v.target)||(T.value=!1)}async function xe(v){if(v.disabled){T.value=!1;return}T.value=!1,await q(v.id)}function fe(v){if(T.value){v.stopPropagation(),X();return}ve()}return(v,b)=>(C(),Ne(Pt,{to:"body"},[r.isVisible?(C(),A("div",{key:0,class:"employee-details-modal",onClick:ne(ve,["self"]),onKeydown:Xe(fe,["esc"])},[i("div",{class:"modal-content",onClick:ye},[ue(Ze,{name:"level",mode:"out-in"},{default:Me(()=>{var y,I,Y,U,se,Ce,H,J,ce,_,m,E,h,M,x,F,z,j,K;return[l.value===1?(C(),A("div",Ca,[i("div",Ta,[i("div",Aa,[i("button",{ref_key:"stageTriggerRef",ref:Q,class:"stage-trigger","aria-expanded":T.value,"aria-haspopup":"listbox",onClick:ne(L,["stop"]),onKeydown:[Xe(ne(L,["prevent"]),["enter"]),Xe(ne(L,["prevent"]),["space"]),Xe(ne(X,["stop","prevent"]),["esc"])]},[i("span",{class:"stage-color",style:he({backgroundColor:((y=o.value)==null?void 0:y.stageColor)||((U=(I=S.value)==null?void 0:I.stageColorMap)==null?void 0:U[(Y=o.value)==null?void 0:Y.stageId])||((Ce=(se=S.value)==null?void 0:se.stageColorMap)==null?void 0:Ce[r.stageId])||"#007bff"})},null,4),i("span",Ia,O(((H=o.value)==null?void 0:H.stageName)||r.stageName),1),i("span",{class:oe(["stage-caret",{open:T.value}])},"▾",2)],40,$a),T.value?(C(),A("div",{key:0,ref_key:"stageDropdownRef",ref:V,class:"stage-dropdown",role:"listbox"},[(C(!0),A(pe,null,ge(ae.value,$=>(C(),A("div",{key:$.id,class:oe(["stage-option",{disabled:$.disabled}]),role:"option","aria-selected":$.disabled,onClick:ne(R=>xe($),["stop"]),onKeydown:Xe(ne(R=>xe($),["prevent"]),["enter"])},[i("span",{class:"stage-color",style:he({backgroundColor:$.color})},null,4),i("span",Na,O($.name),1)],42,Ma))),128))],512)):Z("",!0)]),i("span",Ra,"Всего: "+O(((J=o.value)==null?void 0:J.totalCount)||r.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Fa,[i("button",{class:oe(["view-switch-btn",{active:c.value==="employees"}]),onClick:b[0]||(b[0]=$=>c.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="time"}]),onClick:b[1]||(b[1]=$=>c.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="departments"}]),onClick:b[2]||(b[2]=$=>c.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),i("div",xa,[w.value?(C(),A("div",Ha,[i("span",null,"Ошибка: "+O(w.value),1),i("button",{class:"btn-retry-stage",onClick:b[3]||(b[3]=$=>{var R;return q(((R=o.value)==null?void 0:R.stageId)||r.stageId)})}," Повторить ")])):Z("",!0),k.value?(C(),A("div",Oa,[...b[4]||(b[4]=[i("div",{class:"loading-spinner small"},null,-1),i("span",null,"Загрузка стадии...",-1)])])):Z("",!0),c.value==="employees"?(C(),A("div",Pa,[(((ce=o.value)==null?void 0:ce.employees)||r.employees).length===0&&(!((_=o.value)!=null&&_.others||r.others)||(((m=o.value)==null?void 0:m.others)||r.others).count===0)?(C(),A("div",La," Нет данных о сотрудниках ")):(C(),A("div",Ba,[(C(!0),A(pe,null,ge(((E=o.value)==null?void 0:E.employees)||r.employees,$=>(C(),A("div",{key:$.id,class:oe(["employee-item",{"employee-keeper":$.isKeeper}]),onClick:ne(R=>De($,R),["stop"]),title:"Кликните для детализации по временным градациям"},[i("span",Wa,O($.name),1),i("div",Ua,[i("div",{class:"progress-bar",style:he({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",za,O($.count)+" тикетов ("+O($.percentage)+"%) ",1),b[5]||(b[5]=i("span",{class:"employee-arrow"},"→",-1))],10,ja))),128)),((h=o.value)!=null&&h.others||r.others)&&(((M=o.value)==null?void 0:M.others)||r.others).count>0?(C(),A("div",Va,[i("span",Ka,"Другие ("+O((((x=o.value)==null?void 0:x.others)||r.others).employeeCount)+")",1),i("div",Ya,[i("div",{class:"progress-bar",style:he({width:(((F=o.value)==null?void 0:F.others)||r.others).progressBarWidth+"%",backgroundColor:(((z=o.value)==null?void 0:z.others)||r.others).progressBarColor})},null,4)]),i("span",Ga,O((((j=o.value)==null?void 0:j.others)||r.others).count)+" тикетов ("+O((((K=o.value)==null?void 0:K.others)||r.others).percentage)+"%) ",1)])):Z("",!0)]))])):c.value==="time"?(C(),A("div",Xa,[u.value.length===0?(C(),A("div",qa," Загрузка данных... ")):(C(),A("div",Ja,[(C(!0),A(pe,null,ge(u.value,$=>(C(),A("div",{key:$.category,class:"category-item",onClick:ne(R=>Fe($),["stop"])},[i("span",Qa,O($.label),1),i("div",es,[i("div",{class:"progress-bar",style:he({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",ts,O($.count)+" тикетов ("+O($.percentage)+"%) ",1),b[6]||(b[6]=i("span",{class:"category-arrow"},"→",-1))],8,Za))),128))]))])):c.value==="departments"?(C(),A("div",as,[f.value.length===0?(C(),A("div",ss," Загрузка данных... ")):(C(),A("div",ns,[i("table",os,[b[8]||(b[8]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(C(!0),A(pe,null,ge(f.value,($,R)=>(C(),A("tr",{key:R,class:"department-row",onClick:ne(W=>de($),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",rs,[i("span",is,O($.departmentName),1)]),i("td",cs,[i("span",us,O($.count),1)]),b[7]||(b[7]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,ls))),128))])])]))])):Z("",!0)])])):l.value===2&&p.value?(C(),A("div",ds,[i("div",ps,[i("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),i("h3",null,O(p.value.employeeName),1),i("span",gs,"Всего: "+O(p.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",fs,[i("div",ms,[i("span",hs,O(p.value.stageName),1)]),p.value.dateCategories.length===0?(C(),A("div",vs," Нет данных о тикетах ")):(C(),A("div",ys,[(C(!0),A(pe,null,ge(p.value.dateCategories,$=>(C(),A("div",{key:$.category,class:"category-item",onClick:ne(R=>Ve($),["stop"])},[i("span",ws,O($.label),1),i("div",bs,[i("div",{class:"progress-bar",style:he({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",Ds,O($.count)+" тикетов ("+O($.percentage)+"%) ",1)],8,ks))),128))]))])])):l.value===3&&d.value?(C(),A("div",Ss,[i("div",Es,[i("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),i("div",_s,[i("h3",null,O(d.value.employeeName),1),i("div",Cs,[i("span",Ts,O(d.value.dateCategoryLabel),1),i("span",As,O(d.value.stageName),1)])]),i("span",$s,"Всего: "+O(d.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Is,[d.value.departments.length===0?(C(),A("div",Ms," Нет данных о заказчиках ")):(C(),A("div",Ns,[i("table",Rs,[b[10]||(b[10]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(C(!0),A(pe,null,ge(d.value.departments,($,R)=>(C(),A("tr",{key:R,class:"department-row",onClick:ne(W=>ie($),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",xs,[i("span",Hs,O($.departmentName),1)]),i("td",Os,[i("span",Ps,O($.count),1)]),b[9]||(b[9]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,Fs))),128))])])]))])])):l.value===4&&g.value?(C(),A("div",Ls,[i("div",Bs,[i("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),i("div",js,[i("h3",null,O(B.value),1),g.value.context?(C(),A("div",Ws,[g.value.context.dateCategoryLabel?(C(),A("span",Us,O(g.value.context.dateCategoryLabel),1)):Z("",!0),g.value.context.departmentName?(C(),A("span",zs,O(g.value.context.departmentName),1)):Z("",!0),i("span",Vs,O(g.value.context.stageName),1)])):Z("",!0)]),i("span",Ks,"Всего: "+O(g.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Ys,[ue(Ze,{name:"loading",mode:"out-in"},{default:Me(()=>[g.value.isLoading?(C(),A("div",Gs,[...b[11]||(b[11]=[i("div",{class:"loading-spinner"},null,-1),i("p",null,"Загрузка тикетов...",-1)])])):g.value.error&&g.value.error.hasFallback?(C(),A("div",Xs,[b[12]||(b[12]=i("div",{class:"error-banner"},[i("span",{class:"error-icon"},"⚠️"),i("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),i("div",qs,[ue($t,{name:"ticket",tag:"div",class:"tickets-list"},{default:Me(()=>[(C(!0),A(pe,null,ge(g.value.tickets,($,R)=>(C(),Ne(Ft,{key:$.id,ticket:$,draggable:!1,style:he({"--ticket-index":R}),onClick:W=>_e($)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):g.value.error&&!g.value.error.hasFallback?(C(),A("div",Js,[b[13]||(b[13]=i("div",{class:"error-icon"},"❌",-1)),b[14]||(b[14]=i("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),i("p",Zs,O(g.value.error.message),1),i("button",{class:"btn-retry",onClick:Ee},"Повторить попытку")])):!g.value.tickets||g.value.tickets.length===0?(C(),A("div",Qs,[b[15]||(b[15]=i("div",{class:"empty-state-icon"},"📭",-1)),i("h3",en,O(Ke()),1),i("p",tn,O(Ye()),1)])):(C(),A("div",an,[ue($t,{name:"ticket",tag:"div",class:"tickets-list"},{default:Me(()=>[(C(!0),A(pe,null,ge(g.value.tickets,($,R)=>(C(),Ne(Ft,{key:$.id,ticket:$,draggable:!1,style:he({"--ticket-index":R}),onClick:W=>_e($)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):Z("",!0)]}),_:1})])],32)):Z("",!0)]))}},nn=Re(sn,[["__scopeId","data-v-6ac66e72"]]);function on(r,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof r!="number"||r<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((l,c)=>{if(!l||!l.data||!Array.isArray(l.data))return;const o=l.data[r];o!=null&&!isNaN(o)&&a.push({datasetIndex:c,value:Number(o),y:Number(o)})}),a.length<2)return 0;const s=[];return a.forEach(l=>{let c=!1;for(const o of s){const u=o.y;if(Math.abs(l.y-u)<e){o.points.push(l),o.y=o.points.reduce((p,d)=>p+d.y,0)/o.points.length,c=!0;break}}c||s.push({points:[l],y:l.y})}),s.length===0?0:s.reduce((l,c)=>c.points.length>l.points.length?c:l,s[0]).points.length}function ln(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.value-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.value,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.value})}),e}function rn(r,t=.5){var n,l;if(!r)return console.warn("findOverlappingPoints: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];const e=(n=r.data)==null?void 0:n.datasets,a=((l=r.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const s=[];return a.forEach((c,o)=>{try{if(on(o,e,t)<2)return;const f=[];if(e.forEach((k,w)=>{if(!k||!k.data||!Array.isArray(k.data))return;const D=k.data[o];D==null||isNaN(D)||f.push({datasetIndex:w,value:Number(D),label:k.label||`Dataset ${w}`})}),f.length<2)return;const p=ln(f,t);if(p.length===0)return;const d=p.reduce((k,w)=>w.points.length>k.points.length?w:k,p[0]);if(d.points.length<2)return;let g=null,S=null;for(let k=0;k<e.length;k++)try{const w=r.getDatasetMeta(k);if(w&&w.data&&w.data[o]){g=w,S=w.data[o];break}}catch{continue}if(!S||typeof S.x!="number"||typeof S.y!="number")return;s.push({position:o,count:d.points.length,x:S.x,y:S.y,value:d.y,points:d.points.map(k=>({datasetIndex:k.datasetIndex,value:k.value,label:k.label}))})}catch(u){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${o}:`,u)}}),s}function cn(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.y-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.y,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.y})}),e}function un(r,t,e=.5){var u,f;if(!r)return console.warn("calculatePointJitter: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(u=r.data)==null?void 0:u.datasets,s=((f=r.data)==null?void 0:f.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(s)||t>=s.length)return[];const n=[];if(a.forEach((p,d)=>{if(!p||!p.data||!Array.isArray(p.data))return;const g=p.data[t];if(!(g==null||isNaN(g)))try{const S=r.getDatasetMeta(d);if(S&&S.data&&S.data[t]){const k=S.data[t];k&&typeof k.x=="number"&&typeof k.y=="number"&&n.push({datasetIndex:d,value:Number(g),x:k.x,y:k.y})}}catch(S){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,S)}}),n.length===0)return[];const l=cn(n,e),c=[];l.forEach(p=>{const d=p.points||[];d.length>1?d.forEach((S,k)=>{const w=(k-(d.length-1)/2)*4;c.push({datasetIndex:S.datasetIndex,jitterX:w,value:S.value})}):d.length===1&&c.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const o=new Set(c.map(p=>p.datasetIndex));return n.forEach(p=>{o.has(p.datasetIndex)||c.push({datasetIndex:p.datasetIndex,jitterX:0,value:p.value})}),c}const dn=.5,Ot=6,pn=2;function gn(r){return typeof r!="number"||r<2?Ot:Ot+(r-1)*pn}function fn(r,t){if(!r||!r.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=r.ctx,{x:s,y:n,points:l}=t,c=gn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(s,n,c,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&r.data&&r.data.datasets){const f=l[0].datasetIndex,p=r.data.datasets[f];if(p&&p.pointBackgroundColor){const d=Array.isArray(p.pointBackgroundColor)?p.pointBackgroundColor[t.position]||p.pointBackgroundColor[0]:p.pointBackgroundColor;if(d)if(d.startsWith("#")){const g=parseInt(d.slice(1,3),16),S=parseInt(d.slice(3,5),16),k=parseInt(d.slice(5,7),16);u=`rgba(${g}, ${S}, ${k}, 0.4)`}else d.startsWith("rgba")?u=d.replace(/rgba?\(([^)]+)\)/,(g,S)=>{const k=S.split(",").map(w=>w.trim());return`rgba(${k[0]}, ${k[1]}, ${k[2]}, 0.4)`}):u=d+"66"}}a.fillStyle=u,a.fill(),a.strokeStyle=u.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(u){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",u)}finally{a.restore()}}}const mn={id:"overlappingPointsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const t=rn(r,dn);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{fn(r,a)}catch(s){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,s)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},hn=.5,vn={id:"pointJitterPlugin",beforeDatasetsDraw:r=>{var t,e;if(!(!r||!r.config||r.config.type!=="line")){r._jitterData||(r._jitterData={});try{const a=(t=r.data)==null?void 0:t.datasets,s=((e=r.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(s)||s.length===0)return;r._jitterData={},s.forEach((n,l)=>{const c=un(r,l,hn);c&&c.length>0&&c.forEach(o=>{const u=`${o.datasetIndex}_${l}`;r._jitterData[u]=o.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx&&!(!r._jitterData||Object.keys(r._jitterData).length===0))try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);!l||l.hidden||!s.data||!Array.isArray(s.data)||s.data.forEach((c,o)=>{const u=l.data[o];if(!u||typeof u.x!="number"||typeof u.y!="number"||c==null||isNaN(c))return;const f=`${n}_${o}`,p=r._jitterData[f];if(!(p===void 0||p===0)){e.save();try{const d=s.pointStyle||"circle",g=(s.pointRadius||7)+1,S=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[o]||s.pointBackgroundColor[0]:s.pointBackgroundColor,k=Array.isArray(s.pointBorderColor)?s.pointBorderColor[o]||s.pointBorderColor[0]:s.pointBorderColor,w=s.pointBorderWidth||1,D=u.x+p,T=u.y;switch(e.fillStyle=S||"#007bff",e.strokeStyle=k||"#ffffff",e.lineWidth=w,e.beginPath(),d){case"circle":e.arc(D,T,g,0,2*Math.PI);break;case"triangle":e.moveTo(D,T-g),e.lineTo(D-g,T+g),e.lineTo(D+g,T+g),e.closePath();break;case"rect":case"rectRounded":const V=g*1.4;e.rect(D-V/2,T-V/2,V,V);break;case"rectRot":const Q=g*1.4;e.moveTo(D,T-Q/2),e.lineTo(D+Q/2,T),e.lineTo(D,T+Q/2),e.lineTo(D-Q/2,T),e.closePath();break;case"star":const ae=g;for(let G=0;G<5;G++){const q=G*4*Math.PI/5-Math.PI/2,ie=D+ae*Math.cos(q),de=T+ae*Math.sin(q);G===0?e.moveTo(ie,de):e.lineTo(ie,de)}e.closePath();break;case"cross":const B=g;e.moveTo(D-B,T-B),e.lineTo(D+B,T+B),e.moveTo(D+B,T-B),e.lineTo(D-B,T+B);break;case"crossRot":const P=g;e.moveTo(D-P,T),e.lineTo(D+P,T),e.moveTo(D,T-P),e.lineTo(D,T+P);break;default:e.arc(D,T,g,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),u._originalX||(u._originalX=u.x,u._originalY=u.y),u._jitterX=p,u._jitteredX=D,u._jitteredY=T}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${n}_${o}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:r=>{r._jitterData}},yn={id:"pointLabelsPlugin",afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);if(!l||l.hidden||!s.data||!Array.isArray(s.data))return;const c=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[0]||"#6b7280":s.pointBackgroundColor||"#6b7280";s.data.forEach((o,u)=>{const f=l.data[u];if(!f||typeof f.x!="number"||typeof f.y!="number"||o==null||isNaN(o))return;const p=f._jitteredX!==void 0?f._jitteredX:f.x,d=f._jitteredY!==void 0?f._jitteredY:f.y,g=p+8,S=d-5,k=String(Math.round(o));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const D=e.measureText(k).width,T=11,V=3,Q=g-V,ae=S-T/2-V,B=D+V*2,P=T+V*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Q,ae,B,P),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Q,ae,B,P),e.fillStyle=c,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(k,g,S)}catch(w){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${n}_${u}:`,w)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},kn={class:"graph-state-chart"},wn={class:"chart-header"},bn={class:"chart-type-selector"},Dn=["onClick","title"],Sn={class:"chart-type-icon"},En={class:"chart-type-label"},_n={key:0,class:"comparison-type-selector"},Cn={class:"radio-group"},Tn={key:0},An={key:1},$n={key:2,class:"graph-legend"},In={key:4,class:"error-container"},Mn={class:"error-message"},Nn={class:"chart-wrapper"},Rn={class:"chart-canvas-container"},Fn={key:0,class:"bar-chart-stage-labels"},xn={key:6,class:"no-data"},Hn={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(r,{emit:t}){const e=(_,m)=>typeof window>"u"?m:getComputedStyle(document.documentElement).getPropertyValue(_).trim()||m,a=r,s=t,n=N(!1),l=N(null),c=N(null),o=N({weekStart:null,weekEnd:null,current:null}),u=N(null),f=N("weekStartToWeekEnd"),p=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=N("line"),g=N(!1),S=N(""),k=N(""),w=N(0),D=N([]),T=N(null),V=N(null),Q=N(null),ae=N(null),B=N([]),P=ee(()=>{switch(d.value){case"line":return It;case"bar":return Qt;case"doughnut":return Zt;default:return It}}),G={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},q=[{id:"formed",name:"Сформировано обращение",color:G.formed},{id:"review",name:"Рассмотрение ТЗ",color:G.review},{id:"execution",name:"Исполнение",color:G.execution}],ie=ee(()=>q.reduce((_,m)=>(_[m.id]=m.name,_),{})),de=["circle","triangle","rect","rectRot","star","cross","crossRot"],Fe=N({formed:!0,review:!0,execution:!0}),De=Qe(),Ve={id:"employeeLabelsPlugin",afterDatasetsDraw:_=>{if(_.config.type==="bar")try{const m=_.ctx;if(!_.data||!_.data.datasets)return;const E=_.data.datasets,h=_.scales.y;E.forEach((M,x)=>{const F=_.getDatasetMeta(x);if(!F||F.hidden)return;const z=M.label||"";if(!z||z.includes("Другие"))return;const j=z.trim().split(/\s+/);let K="";if(j.length===1)K=j[0];else{const R=j[0],W=j.slice(1).join(" ");K=`${R}
${W}`}const $=K.split(`
`);M.data.forEach((R,W)=>{if(R===0||!R)return;const te=F.data[W];if(!te||typeof te.x!="number"||typeof te.y!="number")return;const re=te.x,ke=te.y+te.height+25;m.save(),m.font="bold 9px Arial, sans-serif",m.fillStyle="#6b7280",m.textAlign="center",m.textBaseline="top",m.translate(re,ke),m.rotate(-12*Math.PI/180),$.forEach((Te,He)=>{const Oe=Te.trim();Oe&&m.fillText(Oe,0,He*11)}),m.restore()})})}catch(m){console.error("Error in employeeLabelsPlugin:",m)}}},we={id:"doughnutCenterTextPlugin",afterDraw:_=>{var te;if(_.config.type!=="doughnut")return;const{ctx:m,chartArea:E,width:h,height:M}=_;if(!_.data||!_.data.datasets||_.data.datasets.length===0)return;const x=_.data.datasets[0].meta,F=((te=x==null?void 0:x.totals)==null?void 0:te.overall)??null;if(F===null||typeof F>"u")return;const z=["Всего в секторе 1С","тикетов в работе:",`${F}`];m.save(),m.font='600 16px "Roboto", sans-serif',m.fillStyle=e("--b24-text-primary","#1f2937"),m.textAlign="center",m.textBaseline="middle";const j=(E.left+E.right)/2,K=(E.top+E.bottom)/2,$=18,R=$*z.length,W=K-R/2+4;z.forEach((re,ke)=>{ke===z.length-1&&`${re}`.length>4?m.font='700 18px "Roboto", sans-serif':m.font='600 16px "Roboto", sans-serif',m.fillText(re,j,W+ke*$)}),m.restore()}};qe.register(Ve),qe.register(we);function be(){const _=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(m=>{!m||!m.statistics||!m.statistics.employees||m.statistics.employees.forEach(E=>{_.has(E.id)||_.set(E.id,{id:E.id,name:E.name})})}),B.value=Array.from(_.values()).sort((m,E)=>m.name.localeCompare(E.name))}function Se(_,m="background"){var h;return((h={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[_])==null?void 0:h[m])||e("--b24-text-secondary","#6c757d")}function Ke(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const _=dt.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let m=null,E=null;o.value.current&&(m=dt.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),E=dt.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:_,weekEndToCurrent:m,weekStartToCurrent:E}}catch(_){console.error("Ошибка сравнения слепков:",_),De.warning("Не удалось выполнить сравнение слепков: "+_.message)}}function Ye(_){return _?_.replace(/\s*\(\d+\)\s*$/,"").trim():""}function Ee(_){const m=Ye(_);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[m]||"formed"}function _e(_){return Ee(_)}function ve(_){return _===0?"weekStart":_===1?"weekEnd":_===2?"current":"weekEnd"}function L(_,m,E,h,M=null,x=null,F=null,z=null){var j;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:_,stageId:m,totalCount:E,employeesCount:(h==null?void 0:h.length)||0,hasSnapshot:!!x,snapshotTicketIds:((j=x==null?void 0:x.ticketIds)==null?void 0:j.length)||0}),S.value=_,k.value=m||"",w.value=E,D.value=h||[],T.value=M&&M.count>0?M:null,V.value=x,Q.value=F,ae.value=z,g.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:k.value,hasCurrentSnapshot:!!V.value})}async function X(_,m,E){var x,F,z,j,K,$,R;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:_,timePoint:m,hasMeta:!!E});const h=q.find(W=>W.id===_);if(!h){console.warn("[GraphStateChart] Stage not found:",_);return}const M={graphType:"line",stageId:_,stageName:h.name,timePoint:m,snapshots:o.value,meta:{line:E||null,doughnut:((z=(F=(x=c.value)==null?void 0:x.datasets)==null?void 0:F[0])==null?void 0:z.meta)||null},stageColorMap:G,stageNameMap:ie.value};try{const W=await zt({stageId:_,graphType:"line",timePoint:m,snapshots:o.value,meta:{line:E||null,doughnut:(($=(K=(j=c.value)==null?void 0:j.datasets)==null?void 0:K[0])==null?void 0:$.meta)||null},stageColorMap:G,stageNameMap:ie.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:W.stageName,stageId:_,totalCount:W.totalCount,employeesCount:((R=W.employees)==null?void 0:R.length)||0,hasSnapshot:!!W.snapshot}),L(W.stageName,_,W.totalCount,W.employees,W.others,W.snapshot,null,M)}catch(W){console.error("[GraphStateChart] Failed to open modal for line point:",W),De.error("Не удалось открыть попап для выбранной точки графика")}}function ye(_,m){var M,x,F;if(!m||!m.employees||m.employees.length===0){De.warning("Нет данных о сотрудниках для этого этапа");return}const E=o.value.current||o.value.weekEnd||o.value.weekStart,h={graphType:"doughnut",stageId:_,stageName:m.stageName,snapshots:o.value,meta:{doughnut:((F=(x=(M=c.value)==null?void 0:M.datasets)==null?void 0:x[0])==null?void 0:F.meta)||null},stageColorMap:G,stageNameMap:ie.value};L(m.stageName,_,m.totalCount,m.employees,m.others,E,null,h)}function xe(){g.value=!1,S.value="",k.value="",w.value=0,D.value=[],T.value=null,V.value=null,Q.value=null}async function fe(_,m,E){if(d.value!=="line"||m.length===0)return;const h=m[0],M=h.datasetIndex,x=h.index,F=E.data.datasets[M];if(!F)return;const z=_e(F.label),j=ve(x);await X(z,j,F.meta||null)}function v(_,m,E){var $,R;if(d.value!=="doughnut"||m.length===0)return;const M=m[0].index,x=E.data,F=x.labels[M],z=_e(F),j=(R=($=x.datasets[0])==null?void 0:$.meta)==null?void 0:R.employees,K=j==null?void 0:j[z];if(!K){console.warn("Данные о сотрудниках не найдены для этапа:",z);return}ye(z,K)}function b(_){var h;const m=q[_];if(!m)return 0;const E=o.value.current||o.value.weekEnd||o.value.weekStart;return!E||!E.statistics||!E.statistics.stages?0:((h=E.statistics.stages[m.id])==null?void 0:h.count)||0}function y(_){var M;const m=q.find(x=>x.id===_);if(!m)return"";const E=o.value.current||o.value.weekEnd||o.value.weekStart;if(!E||!E.statistics||!E.statistics.stages)return m.name;const h=((M=E.statistics.stages[_])==null?void 0:M.count)||0;return`${m.name} (${h})`}const I=ee(()=>{if(!c.value)return null;if(d.value==="doughnut"||d.value==="bar")return c.value;const _=c.value.datasets.filter(m=>{const E=q.find(h=>h.name===m.label);return E?Fe.value[E.id]:!0});return{...c.value,datasets:_}});ee(()=>d.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const Y=ee(()=>{const _={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(m,E,h)=>{d.value==="line"?fe(m,E,h):d.value==="doughnut"&&v(m,E,h)},onHover:(m,E,h)=>{d.value==="doughnut"&&(m.native.target.style.cursor=E.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",labels:{font:{size:d.value==="doughnut"?14:12,weight:d.value==="doughnut"?"600":"500"},boxWidth:d.value==="doughnut"?18:12,boxHeight:d.value==="doughnut"?18:12,padding:d.value==="doughnut"?14:10},onClick:(m,E,h)=>{if(d.value==="bar"){const x=E.datasetIndex;if(x!==void 0){const F=h.chart.getDatasetMeta(x);F.hidden=!F.hidden,h.chart.update()}return}const M=E.datasetIndex;if(M!==void 0){const x=h.chart.getDatasetMeta(M);x.hidden=!x.hidden,h.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:m=>{if(d.value==="bar"){const E=m[0].dataIndex,h=q[E];return h?h.name:""}return m[0].label||""},label:m=>{var x,F,z,j,K,$;const E=m.dataset.label||"",h=m.parsed.y||m.parsed||0,M=m.dataIndex;if(d.value==="bar"){const R=m.dataset,W=m.dataIndex,te=q[W],re=te?te.name:"";return`${R.label}: ${h} тикетов на этапе "${re}"`}if(d.value==="doughnut"){const R=m.dataset.data.reduce((te,re)=>te+re,0),W=R>0?(h/R*100).toFixed(1):0;return`${E}: ${h} тикетов (${W}%)`}else{if(!u.value||M===0)return`${E}: ${h} тикетов`;let R=null;const W=Ee(E);if(f.value==="weekStartToWeekEnd"&&M===1?R=(F=(x=u.value.weekStartToWeekEnd)==null?void 0:x.stages)==null?void 0:F[W]:f.value==="weekEndToCurrent"&&M===2&&o.value.current?R=(j=(z=u.value.weekEndToCurrent)==null?void 0:z.stages)==null?void 0:j[W]:f.value==="weekStartToCurrent"&&M===2&&o.value.current&&(R=($=(K=u.value.weekStartToCurrent)==null?void 0:K.stages)==null?void 0:$[W]),!R)return`${E}: ${h} тикетов`;const te=R.delta,re=R.deltaPercent,ke=R.trend;let Te=`${E}: ${h} тикетов`;if(te!==0){const He=te>0?"+":"",Oe=ke==="increase"?"↑":ke==="decrease"?"↓":"→";Te+=` (${He}${te}, ${He}${re.toFixed(1)}%) ${Oe}`}else Te+=" (без изменений)";return Te}},afterBody:m=>{if(d.value==="bar"&&m.length>0){const x=m[0];x.dataset;const F=x.parsed.y||0,z=x.dataIndex,j=b(z);return[`${j>0?(F/j*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&m.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const x=[];if(u.value){const F=m[0].dataIndex;if(F!==0){let z=null;if(Ee(m[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&F===1?z=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&F===2?z=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&F===2&&(z=u.value.weekStartToCurrent),z&&z.metadata){const j=z.metadata.timeDiff;x.push(`Период: ${j.days} дн. ${j.hours} ч. ${j.minutes} мин.`)}}}return x.push("Кликните для детализации по сотрудникам"),x}if(!u.value)return[];const E=m[0].dataIndex;if(E===0)return[];let h=null;if(Ee(m[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&E===1?h=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&E===2?h=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&E===2&&(h=u.value.weekStartToCurrent),!h||!h.metadata)return[];const M=h.metadata.timeDiff;return[`Период: ${M.days} дн. ${M.hours} ч. ${M.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{..._,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{..._,cutout:"60%"}:_});function U(_){const m=new Date(_),E=m.getFullYear(),h=String(m.getMonth()+1).padStart(2,"0"),M=String(m.getDate()).padStart(2,"0");return`${E}-${h}-${M}`}function se(_){const{current:m,weekEnd:E}=_,h=m||E;if(!h||!h.statistics||!h.statistics.stages)return null;const M=[],x=[],F=[],z=[],j={},K={};if(q.forEach(R=>{var te;const W=((te=h.statistics.stages[R.id])==null?void 0:te.count)||0;if(W>0){M.push(`${R.name} (${W})`),x.push(W),F.push(R.color+"80"),z.push(R.color),K[R.id]=W;const re=wa(R.id,h,q);re&&re.employees&&(j[R.id]=re)}}),x.length===0)return null;const $=x.reduce((R,W)=>R+W,0);return{labels:M,datasets:[{label:"Распределение по этапам",data:x,backgroundColor:F,borderColor:z,borderWidth:2,meta:{employees:j,totals:{overall:$,stages:K}}}]}}function Ce(_){if(d.value==="doughnut")return se(_);if(d.value==="bar"){const F=a.showCurrentState&&_.current?"current":_.weekEnd?"weekEnd":"weekStart";return ka(_,F,q)}const{weekStart:m,weekEnd:E,current:h}=_,M=[],x=[];return q.forEach((F,z)=>{var re,ke,Te,He,Oe,vt,yt,kt,wt,bt,Dt,St,Et,_t,Ct,Tt,At;const j=[];if(m&&m.statistics&&m.statistics.stages){const le=m.statistics.stages[F.id];if(M.length===0){const Ge=(re=m.metadata)!=null&&re.createdAt?new Date(m.metadata.createdAt):null;M.push(Ge?U(Ge):"Начало недели")}j.push((le==null?void 0:le.count)||0)}else M.length===0&&M.push("Начало недели"),j.push(0);if(E&&E.statistics&&E.statistics.stages){const le=E.statistics.stages[F.id];if(M.length===1){const Ge=(ke=E.metadata)!=null&&ke.createdAt?new Date(E.metadata.createdAt):null;M.push(Ge?U(Ge):"Конец недели")}j.push((le==null?void 0:le.count)||0)}else M.length===1&&M.push("Конец недели"),j.push(0);if(h&&a.showCurrentState&&h.statistics&&h.statistics.stages){const le=h.statistics.stages[F.id];M.length===2&&M.push("Текущее состояние"),j.push((le==null?void 0:le.count)||0)}const K=["stable"];u.value?f.value==="weekStartToWeekEnd"?(K.push(((Oe=(He=(Te=u.value.weekStartToWeekEnd)==null?void 0:Te.stages)==null?void 0:He[F.id])==null?void 0:Oe.trend)||"stable"),h&&K.push(((kt=(yt=(vt=u.value.weekStartToCurrent)==null?void 0:vt.stages)==null?void 0:yt[F.id])==null?void 0:kt.trend)||"stable")):f.value==="weekEndToCurrent"&&h?(K.push("stable"),K.push(((Dt=(bt=(wt=u.value.weekEndToCurrent)==null?void 0:wt.stages)==null?void 0:bt[F.id])==null?void 0:Dt.trend)||"stable")):f.value==="weekStartToCurrent"&&h?(K.push(((_t=(Et=(St=u.value.weekStartToWeekEnd)==null?void 0:St.stages)==null?void 0:Et[F.id])==null?void 0:_t.trend)||"stable"),K.push(((At=(Tt=(Ct=u.value.weekStartToCurrent)==null?void 0:Ct.stages)==null?void 0:Tt[F.id])==null?void 0:At.trend)||"stable")):(K.push("stable"),h&&K.push("stable")):(K.push("stable"),h&&K.push("stable"));let $,R,W;u.value&&d.value!=="doughnut"?($=K.map(le=>Se(le,"background")+"40"),R=K.map(le=>Se(le,"border")),W=K.map(le=>Se(le,"point"))):($=F.color+"40",R=F.color,W=F.color);let te=null;d.value==="line"&&(te={employees:ya(F.id,_)}),x.push({label:F.name,data:j,backgroundColor:(Array.isArray($),$),borderColor:(Array.isArray(R),R),borderWidth:2,...d.value==="line"&&{pointStyle:de[z%de.length]},pointBackgroundColor:(Array.isArray(W),W),pointBorderColor:(Array.isArray(R),R),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:te})}),M.length===0&&(M.push("Начало недели","Конец недели"),a.showCurrentState&&M.push("Текущее состояние")),{labels:M,datasets:x}}const H=async()=>{var _,m,E;n.value=!0,l.value=null;try{const h=(_=a.period)!=null&&_.endDate?new Date(a.period.endDate):new Date,M=(m=a.period)!=null&&m.startDate?new Date(a.period.startDate):Ie.getWeekStartDate(h),x=(E=a.period)!=null&&E.endDate?new Date(a.period.endDate):Ie.getWeekEndDate(h),F=Ie.formatDate(M),z=Ie.formatDate(x),[j,K]=await Promise.all([Ie.getSnapshot(F,"week_start"),Ie.getSnapshot(z,"week_end")]);let $=null;a.showCurrentState&&($=await ft.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:j,weekEnd:K,current:$},be(),Ke(),ce(),s("data-loaded",{weekStart:j,weekEnd:K,current:$})}catch(h){console.error("Error loading chart data:",h),l.value=h.message||"Ошибка загрузки данных графика",De.error("Ошибка загрузки данных графика: "+l.value),s("error",l.value)}finally{n.value=!1}};Le(()=>{qe.register(mn),qe.register(vn),qe.register(yn),H()});function J(_){Fe.value=_}const ce=()=>{var m;const _=Ce({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==((m=_==null?void 0:_.labels)==null?void 0:m.length))c.value=_;else if(_){const E=JSON.stringify(c.value),h=JSON.stringify(_);E!==h&&(c.value=_)}};return Ue(()=>[a.period,a.showCurrentState],()=>{H()},{deep:!0}),Ue(d,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&ce()}),Ue(f,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&ce()}),(_,m)=>(C(),A("div",kn,[i("div",wn,[m[3]||(m[3]=i("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),i("div",bn,[(C(),A(pe,null,ge(p,E=>i("button",{key:E.value,onClick:h=>d.value=E.value,class:oe(["chart-type-btn",{active:d.value===E.value}]),title:E.label},[i("span",Sn,O(E.icon),1),i("span",En,O(E.label),1)],10,Dn)),64))])]),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(C(),A("div",_n,[m[7]||(m[7]=i("h4",{class:"comparison-title"},"Тип сравнения:",-1)),i("div",Cn,[i("label",null,[at(i("input",{type:"radio","onUpdate:modelValue":m[0]||(m[0]=E=>f.value=E),value:"weekStartToWeekEnd",onChange:ce},null,544),[[it,f.value]]),m[4]||(m[4]=i("span",null,"Начало недели → Конец недели",-1))]),o.value.current?(C(),A("label",Tn,[at(i("input",{type:"radio","onUpdate:modelValue":m[1]||(m[1]=E=>f.value=E),value:"weekEndToCurrent",onChange:ce},null,544),[[it,f.value]]),m[5]||(m[5]=i("span",null,"Конец недели → Текущее состояние",-1))])):Z("",!0),o.value.current?(C(),A("label",An,[at(i("input",{type:"radio","onUpdate:modelValue":m[2]||(m[2]=E=>f.value=E),value:"weekStartToCurrent",onChange:ce},null,544),[[it,f.value]]),m[6]||(m[6]=i("span",null,"Начало недели → Текущее состояние",-1))])):Z("",!0)])])):Z("",!0),!n.value&&!l.value&&c.value?(C(),Ne(fa,{key:1,stages:q,selected:Fe.value,"onUpdate:selected":J,onChange:ce},null,8,["selected"])):Z("",!0),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(C(),A("div",$n,[...m[8]||(m[8]=[Vt('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):Z("",!0),n.value?(C(),Ne(Lt,{key:3,message:"Загрузка данных графика..."})):l.value?(C(),A("div",In,[i("p",Mn,"❌ "+O(l.value),1),i("button",{onClick:H,class:"btn-retry"},"Повторить загрузку")])):I.value?(C(),A("div",{key:5,class:oe(["chart-container",`chart-type-${d.value}`])},[i("div",Nn,[i("div",Rn,[(C(),Ne(Kt(P.value),{data:I.value,options:Y.value},null,8,["data","options"]))]),d.value==="bar"?(C(),A("div",Fn,[(C(),A(pe,null,ge(q,E=>i("div",{key:E.id,class:"stage-label-item"},O(y(E.id)),1)),64))])):Z("",!0)])],2)):(C(),A("div",xn,[...m[9]||(m[9]=[i("p",null,"📊 Нет данных для отображения",-1),i("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ue(nn,{"is-visible":g.value,"stage-name":S.value,"stage-id":k.value,"total-count":w.value,employees:D.value,others:T.value,snapshot:V.value,"ticket-details":Q.value,"stage-switch-context":ae.value,onClose:xe},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},On=Re(Hn,[["__scopeId","data-v-cbba196a"]]),Pn={key:0,class:"create-snapshot-button-container"},Ln=["disabled"],Bn={class:"modal-content"},jn={class:"modal-header"},Wn=["disabled"],Un={class:"modal-body"},zn={key:0,class:"progress-container"},Vn={class:"progress-bar-wrapper"},Kn={class:"progress-text"},Yn={class:"progress-percent"},Gn={class:"progress-description"},Xn={key:1},qn={class:"modal-footer"},Jn=["disabled"],Zn=["disabled"],Qn={key:0},eo={key:0},to={key:1},ao={key:2},so={key:1},no={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(r,{emit:t}){const e=r,a=t,s=N(e.user),n=N(!1),l=N(!1),c=N(0),o=N("idle"),u=N(""),f=Qe(),p=ee(()=>s.value?Yt(s.value):!1);Le(async()=>{if(!e.user)try{const w=await Bt.checkAccess();w.allowed&&(s.value=w.user)}catch(w){console.error("Error loading user:",w)}});const d=()=>{if(!p.value){f.warning("Только администраторы могут создавать слепки");return}n.value=!0},g=()=>{l.value||(n.value=!1,o.value="idle",c.value=0,u.value="")},S=async()=>{if(!l.value){if(!p.value){f.warning("Только администраторы могут создавать слепки");return}l.value=!0,o.value="loading_data",c.value=0,u.value="Инициализация загрузки данных...";try{u.value="Загрузка данных сектора из Bitrix24...";const w=await ft.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:V=>{var ae;const Q=Math.min(80,(V.progress||0)*.8);c.value=Q,o.value="loading_data",u.value=V.description||((ae=V.details)==null?void 0:ae.description)||"Загрузка данных сектора..."}});o.value="creating_snapshot",c.value=85,u.value="Создание слепка...";const D=s.value;if(!D)throw new Error("Пользователь не определён");const T=await Ie.createSnapshot(w,"manual",{createdBy:{id:D.ID,name:`${D.NAME||""} ${D.LAST_NAME||""}`.trim()||D.EMAIL||`User ${D.ID}`},sectorId:"1C"});o.value="success",c.value=100,u.value="Слепок успешно создан!",f.success("Слепок состояния сектора успешно создан"),a("snapshot-created",T),setTimeout(()=>{g()},1500)}catch(w){o.value="error",c.value=0,u.value="Ошибка создания слепка",console.error("Error creating snapshot:",w);let D="Ошибка создания слепка";w.message&&(w.message.includes("загрузки данных")||w.message.includes("sector data")?D="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":w.message.includes("создания слепка")||w.message.includes("snapshot")?D="Не удалось создать слепок. Обратитесь в поддержку.":w.message.includes("валидац")||w.message.includes("validation")?D="Ошибка валидации данных. Проверьте данные сектора.":D=w.message),f.error(D)}finally{l.value=!1}}},k=w=>{w.key==="Escape"&&n.value&&!l.value&&g()};return Le(()=>{window.addEventListener("keydown",k)}),rt(()=>{window.removeEventListener("keydown",k)}),(w,D)=>p.value?(C(),A("div",Pn,[i("button",{class:"create-snapshot-btn",onClick:d,disabled:l.value,title:"Создать слепок состояния сектора"},[...D[1]||(D[1]=[i("span",{class:"btn-icon"},"📸",-1),i("span",{class:"btn-text"},"Создать слепок",-1)])],8,Ln),(C(),Ne(Pt,{to:"body"},[ue(Ze,{name:"modal"},{default:Me(()=>[n.value?(C(),A("div",{key:0,class:"modal-overlay",onClick:D[0]||(D[0]=ne(T=>!l.value&&g(),["self"]))},[i("div",Bn,[i("div",jn,[D[2]||(D[2]=i("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),i("button",{class:"modal-close",onClick:g,disabled:l.value,"aria-label":"Закрыть"}," ✕ ",8,Wn)]),i("div",Un,[o.value!=="idle"?(C(),A("div",zn,[i("div",Vn,[i("div",{class:"progress-bar",style:he({width:`${c.value}%`})},null,4)]),i("div",Kn,[i("span",Yn,O(Math.round(c.value))+"%",1),i("span",Gn,O(u.value),1)])])):(C(),A("div",Xn,[...D[3]||(D[3]=[i("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),i("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),i("div",qn,[i("button",{class:"btn btn-secondary",onClick:g,disabled:l.value}," Отмена ",8,Jn),i("button",{class:"btn btn-primary",onClick:S,disabled:l.value},[l.value?(C(),A("span",Qn,[o.value==="loading_data"?(C(),A("span",eo,"Загрузка данных...")):o.value==="creating_snapshot"?(C(),A("span",to,"Создание...")):(C(),A("span",ao,"Обработка..."))])):(C(),A("span",so,"Создать"))],8,Zn)])])])):Z("",!0)]),_:1})]))])):Z("",!0)}},oo=Re(no,[["__scopeId","data-v-09bccee2"]]),lo=20,ro=5*60*1e3;async function io({search:r="",limit:t=lo,sectorDepartmentId:e=xt.SECTOR_1C}={}){const a=`sector1c_employees_${r}_${t}_${e||"all"}`,s=sessionStorage.getItem(a);if(s)try{const{data:n,timestamp:l}=JSON.parse(s);if(Date.now()-l<ro)return n}catch(n){console.warn("[sector1cEmployees] Cache parse error:",n)}try{const n={ACTIVE:"Y"};e?Array.isArray(e)?n.UF_DEPARTMENT=e:n.UF_DEPARTMENT=[e]:n.UF_DEPARTMENT=[xt.SECTOR_1C],r&&r.length>=2&&(n["%NAME"]=r,n["%LAST_NAME"]=r,n["%WORK_POSITION"]=r);const o=((await gt.call("user.get",{filter:n,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:co(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:o,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return o}catch(n){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",n),new Error(`Не удалось загрузить сотрудников: ${n.message}`)}}function co(r){const t=[r.LAST_NAME,r.NAME,r.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):r.NAME||"Без имени"}const uo={class:"employee-select-field-text"},po={key:0,class:"employee-select-dropdown"},go={class:"employee-select-dropdown-search"},fo={key:0,class:"employee-select-state"},mo={key:1,class:"employee-select-state employee-select-state--error"},ho={key:2,class:"employee-select-state"},vo=["checked"],yo=["checked","onChange"],ko={class:"employee-select-item-content"},wo={class:"employee-select-item-name"},bo={key:0,class:"employee-select-item-position"},Do={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(null),l=N(""),c=N([]),o=N(!1),u=N(null),f=N(!1),p=ee(()=>{if(!l.value)return c.value;const B=l.value.toLowerCase();return c.value.filter(P=>P.name.toLowerCase().includes(B)||P.position&&P.position.toLowerCase().includes(B))}),d=ee(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const B=c.value.find(P=>P.id===e.selected[0]);return B?B.name:e.placeholder}return`Выбрано: ${e.selected.length} ${Q(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function g(B=""){o.value=!0,u.value=null;try{c.value=await io({search:B})}catch(P){u.value=P,a("error",P)}finally{o.value=!1}}function S(){a("search",l.value)}function k(){o.value||(f.value=!f.value,f.value?(c.value.length===0&&g(),Xt(()=>{n.value&&n.value.focus()})):l.value="")}function w(B){s.value&&!s.value.contains(B.target)&&(f.value=!1,l.value="")}function D(B){const P=[...e.selected],G=P.indexOf(B);if(B==="all")if(G>-1)P.splice(G,1);else return a("update:selected",["all"]);else if(G>-1)P.splice(G,1);else{const q=P.indexOf("all");q>-1&&P.splice(q,1),P.push(B)}a("update:selected",P)}function T(B){return B==="all"?e.selected.includes("all"):e.selected.includes(B)||e.selected.includes("all")}const V=ee(()=>l.value?`Нет сотрудников по запросу "${l.value}"`:"Нет сотрудников сектора 1С");function Q(B,P,G,q){const ie=B%10,de=B%100;return de>=11&&de<=19?q:ie===1?P:ie>=2&&ie<=4?G:q}function ae(){g(l.value)}return Ue(()=>e.selected,B=>{(!B||B.length===0)&&a("update:selected",["all"])},{immediate:!0}),Le(()=>{document.addEventListener("click",w),(!e.selected||e.selected.length===0)&&a("update:selected",["all"])}),rt(()=>{document.removeEventListener("click",w)}),(B,P)=>(C(),A("div",{class:"employee-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["employee-select-field",{"employee-select-field--open":f.value,"employee-select-field--disabled":o.value}]),onClick:k},[i("span",uo,O(d.value),1),i("span",{class:oe(["employee-select-field-icon",{open:f.value}])},"▼",2)],2),ue(Ze,{name:"dropdown-fade"},{default:Me(()=>[f.value?(C(),A("div",po,[i("div",go,[at(i("input",{"onUpdate:modelValue":P[0]||(P[0]=G=>l.value=G),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:S,onClick:P[1]||(P[1]=ne(()=>{},["stop"])),ref_key:"searchInput",ref:n},null,544),[[Gt,l.value]])]),o.value?(C(),A("div",fo,[...P[6]||(P[6]=[i("span",{class:"spinner"},"⏳",-1),i("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):u.value?(C(),A("div",mo,[i("span",null,"❌ "+O(u.value.message||"Ошибка загрузки сотрудников"),1),i("button",{onClick:[ae,P[2]||(P[2]=ne(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!o.value&&p.value.length===0&&!u.value?(C(),A("div",ho,[i("span",null,"📭 "+O(V.value),1)])):(C(),A("div",{key:3,class:"employee-select-list",style:he({maxHeight:`${r.maxHeight}px`})},[i("label",{class:oe(["employee-select-item",{"employee-select-item--selected":T("all")}]),onClick:P[4]||(P[4]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T("all"),onChange:P[3]||(P[3]=G=>D("all"))},null,40,vo),P[7]||(P[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(C(!0),A(pe,null,ge(p.value,G=>(C(),A("label",{key:G.id,class:oe(["employee-select-item",{"employee-select-item--selected":T(G.id)}]),onClick:P[5]||(P[5]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T(G.id),onChange:q=>D(G.id)},null,40,yo),i("div",ko,[i("span",wo,O(G.name),1),G.position?(C(),A("span",bo,O(G.position),1)):Z("",!0)])],2))),128))],4))])):Z("",!0)]),_:1})],512))}},So=Re(Do,[["__scopeId","data-v-6b8c949b"]]),Eo={class:"stage-select-field-text"},_o={key:0,class:"stage-select-dropdown"},Co={class:"stage-select-list"},To=["checked"],Ao=["checked","onChange"],$o={class:"stage-select-item-content"},Io={class:"stage-select-item-name"},Mo={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(!1),l=ee(()=>Object.values(e.selected).every(d=>d===!0)),c=ee(()=>{if(l.value)return e.placeholder;const d=e.stages.filter(g=>e.selected[g.id]);return d.length===0?"Этапы не выбраны":d.length===1?d[0].name:`Выбрано: ${d.length} этапа(ов)`});function o(){n.value=!n.value,n.value}function u(d){s.value&&!s.value.contains(d.target)&&(n.value=!1)}function f(d,g){const S={...e.selected};S[d]=g,a("update:selected",S),a("change",d,g)}function p(){const d=l.value,g={};e.stages.forEach(S=>{g[S.id]=!d}),a("update:selected",g),a("change","all",!d)}return Le(()=>{document.addEventListener("click",u)}),rt(()=>{document.removeEventListener("click",u)}),(d,g)=>(C(),A("div",{class:"stage-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["stage-select-field",{"stage-select-field--open":n.value,"stage-select-field--disabled":!1}]),onClick:o},[i("span",Eo,O(c.value),1),i("span",{class:oe(["stage-select-field-icon",{open:n.value}])},"▼",2)],2),ue(Ze,{name:"dropdown-fade"},{default:Me(()=>[n.value?(C(),A("div",_o,[i("div",Co,[i("label",{class:oe(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:g[0]||(g[0]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:l.value,onChange:p},null,40,To),g[2]||(g[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(C(!0),A(pe,null,ge(r.stages,S=>(C(),A("label",{key:S.id,class:oe(["stage-select-item",{"stage-select-item--selected":r.selected[S.id]}]),onClick:g[1]||(g[1]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:r.selected[S.id],onChange:k=>f(S.id,k.target.checked)},null,40,Ao),i("div",$o,[i("span",{class:"stage-select-item-color",style:he({backgroundColor:S.color})},null,4),i("span",Io,O(S.name),1)])],2))),128))])])):Z("",!0)]),_:1})],512))}},No=Re(Mo,[["__scopeId","data-v-ce2229b2"]]),Ro={class:"filters-panel"},Fo={class:"filters-header"},xo=["disabled"],Ho={class:"filters-content"},Oo={class:"filter-section"},Po={class:"section-content"},Lo={class:"filter-section"},Bo={class:"section-content"},jo={class:"filter-section"},Wo={class:"section-content"},Uo=["value"],zo={key:0,class:"custom-date-range"},Vo={class:"date-range-inputs"},Ko={class:"date-input-group"},Yo=["value","max"],Go={class:"date-input-group"},Xo=["value","min","max"],qo={key:0,class:"filter-error"},Jo={key:1,class:"filter-hint"},Zo={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(r,{emit:t}){const e=r,a=t,s=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],n=N(null),l=ee(()=>{const S=new Date;return S.setFullYear(S.getFullYear()-1),S.toISOString().split("T")[0]}),c=ee(()=>new Date().toISOString().split("T")[0]);function o(S){a("update:stages",S),a("apply")}function u(S,k){a("apply")}function f(S){a("update:employees",S),a("apply")}function p(S){a("update:dateRange",S),n.value=null,a("apply")}function d(S,k){const w={...e.customDateRange};if(w[S]=k,w.startDate&&w.endDate){const D=new Date(w.startDate),T=new Date(w.endDate);if(D>T){n.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((T-D)/(1e3*60*60*24))>365){n.value="Период не может превышать 365 дней";return}}n.value=null,a("update:customDateRange",w),a("apply")}function g(){n.value=null,a("reset")}return(S,k)=>(C(),A("div",Ro,[i("div",Fo,[k[3]||(k[3]=i("h2",null,"Фильтры",-1)),i("button",{onClick:g,class:"btn-reset-filters",disabled:!r.hasActiveFilters}," Сбросить фильтры ",8,xo)]),i("div",Ho,[i("div",Oo,[k[4]||(k[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📊"),st(" Этапы ")],-1)),i("div",Po,[ue(No,{selected:r.stages,stages:s,placeholder:"Выберите этапы","onUpdate:selected":o,onChange:u},null,8,["selected"])])]),i("div",Lo,[k[5]||(k[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"👥"),st(" Сотрудники сектора 1С ")],-1)),i("div",Bo,[ue(So,{selected:r.employees,"onUpdate:selected":f},null,8,["selected"])])]),i("div",jo,[k[9]||(k[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📅"),st(" Период ")],-1)),i("div",Wo,[i("select",{value:r.dateRange,onChange:k[0]||(k[0]=w=>p(w.target.value)),class:"date-range-select"},[...k[6]||(k[6]=[i("option",{value:"last-week"},"Последняя неделя",-1),i("option",{value:"last-2-weeks"},"Последние 2 недели",-1),i("option",{value:"last-month"},"Последний месяц",-1),i("option",{value:"custom"},"Произвольный период",-1)])],40,Uo),r.dateRange==="custom"?(C(),A("div",zo,[i("div",Vo,[i("div",Ko,[k[7]||(k[7]=i("label",null,"С:",-1)),i("input",{type:"date",value:r.customDateRange.startDate,onChange:k[1]||(k[1]=w=>d("startDate",w.target.value)),max:r.customDateRange.endDate||c.value,class:"date-input"},null,40,Yo)]),i("div",Go,[k[8]||(k[8]=i("label",null,"По:",-1)),i("input",{type:"date",value:r.customDateRange.endDate,onChange:k[2]||(k[2]=w=>d("endDate",w.target.value)),min:r.customDateRange.startDate||l.value,max:c.value,class:"date-input"},null,40,Xo)])]),n.value?(C(),A("small",qo,O(n.value),1)):(C(),A("small",Jo," Выберите начальную и конечную дату для отображения данных "))])):Z("",!0)])])])]))}},Qo=Re(Zo,[["__scopeId","data-v-4b7456a2"]]);function el(){const r=N(!1),t=N(null),e=N(null),a=N(0),s=Qe(),n=async(w=!0,D=null)=>{r.value=!0,t.value=null,a.value=0;try{const T=await ft.getSectorDataForSnapshot({useCache:w,onProgress:V=>{V&&typeof V.progress=="number"&&(a.value=V.progress),D&&D(V)},normalize:!0});return e.value=T,T}catch(T){throw t.value=T.message||"Ошибка загрузки данных сектора",s.error("Ошибка загрузки данных сектора: "+t.value),T}finally{r.value=!1,a.value=100}},l=async(w,D={})=>{if(!e.value){const T="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=T,s.error(T),new Error(T)}r.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(w))throw new Error(`Неверный тип слепка: ${w}. Допустимые значения: week_start, week_end, manual, current`);const T=await Ie.createSnapshot(e.value,w,D);return s.success("Слепок успешно создан"),T}catch(T){throw t.value=T.message||"Ошибка создания слепка",s.error("Ошибка создания слепка: "+t.value),T}finally{r.value=!1}},c=()=>{r.value=!1,t.value=null,e.value=null,a.value=0},o=ee(()=>e.value!==null&&e.value!==void 0),u=N({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),f=ee(()=>{const w=new Date;let D,T;switch(u.value.dateRange){case"last-week":D=new Date(w),D.setDate(w.getDate()-7),T=w;break;case"last-2-weeks":D=new Date(w),D.setDate(w.getDate()-14),T=w;break;case"last-month":D=new Date(w),D.setMonth(w.getMonth()-1),T=w;break;case"custom":D=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,T=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:D=new Date(w),D.setDate(w.getDate()-7),T=w}return{startDate:D?D.toISOString().split("T")[0]:null,endDate:T?T.toISOString().split("T")[0]:null}}),p=()=>{g()},d=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},g()},g=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(w){console.error("Ошибка сохранения фильтров в localStorage:",w)}},S=()=>{try{const w=localStorage.getItem("graphStateFilters");if(w){const D=JSON.parse(w);D&&typeof D=="object"&&(u.value={stages:D.stages||{formed:!0,review:!0,execution:!0},employees:D.employees||["all"],dateRange:D.dateRange||"last-week",customDateRange:D.customDateRange||{startDate:null,endDate:null}})}}catch(w){console.error("Ошибка загрузки фильтров из localStorage:",w)}},k=ee(()=>{const w=Object.values(u.value.stages).some(V=>!V),D=!u.value.employees.includes("all"),T=u.value.dateRange!=="last-week";return w||D||T});return{isLoading:r,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:o,filters:u,selectedPeriod:f,hasActiveFilters:k,loadSectorDataForSnapshot:n,createSnapshot:l,resetState:c,applyFilters:p,resetFilters:d,saveFiltersToLocalStorage:g,loadFiltersFromLocalStorage:S}}const tl={class:"graph-state-dashboard"},al={key:1,class:"error-message-container"},sl={class:"error-message"},nl={class:"error-text"},ol={key:0,class:"error-details"},ll={class:"dashboard-header"},rl={class:"header-content"},il={class:"breadcrumbs-row"},cl=["aria-disabled","data-fallback","disabled"],ul={class:"breadcrumbs","aria-label":"Навигация"},dl={class:"header-actions"},pl=["disabled"],gl={key:0},fl={key:1},ml={key:3,class:"dashboard-content"},hl={class:"chart-container"},vl="Назад",yl={__name:"GraphStateDashboard",setup(r){const t=(L,X)=>typeof window>"u"?X:getComputedStyle(document.documentElement).getPropertyValue(L).trim()||X,e=Qe(),a=qt(),s={name:"dashboard-sector-1c"},{filters:n,selectedPeriod:l,hasActiveFilters:c,applyFilters:o,resetFilters:u,loadFiltersFromLocalStorage:f}=el(),p=N(null),d=N(!0),g=N(!1),S=N("Загрузка данных..."),k=N(null),w=N(!1),D=N(!1),T=N(typeof window<"u"?window.innerWidth:1024),V=N(null),Q=N(!1),ae=ee(()=>T.value<768);ee(()=>T.value>=768&&T.value<1024),ee(()=>T.value>=1024);const B=ee(()=>typeof window>"u"?!1:window.history.length>1);ee(()=>{const L=new Date;return L.setFullYear(L.getFullYear()-1),L.toISOString().split("T")[0]}),ee(()=>new Date().toISOString().split("T")[0]);function P(L){n.value.stages=L}function G(L){n.value.employees=L}function q(L){n.value.dateRange=L}function ie(L){n.value.customDateRange=L}function de(){o()}function Fe(){u(),V.value=null,de(),e.info("Фильтры сброшены")}function De(L){e.success("Слепок успешно создан")}function Ve(L){g.value=!1,S.value="",console.log("Данные графика загружены:",L)}function we(L){g.value=!1,be({message:L||"Ошибка загрузки графика",details:null,type:"error"})}function be(L){k.value={message:L.message||"Произошла ошибка",details:L.details||null,type:L.type||"error",timestamp:new Date},console.error("Dashboard error:",k.value),e.error(k.value.message)}function Se(){k.value=null}function Ke(){k.value=null,g.value=!0,S.value="Повторная загрузка данных..."}async function Ye(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}w.value=!0;try{const L=document.querySelector(".chart-container");if(!L)throw new Error("График не найден");const X=window.html2canvas,ye=await X(L,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),xe=window.jsPDF,fe=new xe("landscape","mm","a4"),v=297,b=ye.height*v/ye.width;fe.setFontSize(18),fe.text("График состояния сектора 1С",148.5,15,{align:"center"});const y=new Date().toLocaleDateString("ru-RU");fe.setFontSize(10);const I=l.value.startDate&&l.value.endDate?`Период: ${l.value.startDate} - ${l.value.endDate}`:"Период: не указан";fe.text(I,148.5,25,{align:"center"}),fe.text(`Экспорт от ${y}`,148.5,30,{align:"center"}),fe.addImage(ye.toDataURL("image/png"),"PNG",10,35,v-20,b-20),fe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${y}`,author:"Bitrix24 Dashboard"});const Y=`graph-state-${y.replace(/\//g,"-")}.pdf`;fe.save(Y),e.success("График успешно экспортирован в PDF")}catch(L){console.error("Ошибка экспорта в PDF:",L),be({message:"Ошибка экспорта в PDF: "+(L.message||"Неизвестная ошибка"),details:L.stack,type:"error"})}finally{w.value=!1}}function Ee(L){var X;if((X=L==null?void 0:L.preventDefault)==null||X.call(L),!Q.value){Q.value=!0;try{if(B.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(s)}finally{Q.value=!1}}}function _e(){typeof window<"u"&&(T.value=window.innerWidth)}async function ve(){try{const L=await Bt.checkAccess();L.allowed&&(p.value=L.user)}catch(L){console.error("Error loading user:",L)}}return Le(()=>{f(),ve(),typeof window<"u"&&(T.value=window.innerWidth,window.addEventListener("resize",_e))}),rt(()=>{typeof window<"u"&&window.removeEventListener("resize",_e)}),(L,X)=>{const ye=Jt("router-link");return C(),A("div",tl,[g.value?(C(),Ne(Lt,{key:0,message:S.value},null,8,["message"])):Z("",!0),k.value?(C(),A("div",al,[i("div",sl,[i("div",{class:"error-header"},[X[1]||(X[1]=i("span",{class:"error-icon"},"❌",-1)),X[2]||(X[2]=i("h3",null,"Ошибка",-1)),i("button",{onClick:Se,class:"error-close","aria-label":"Закрыть"},"✕")]),i("p",nl,O(k.value.message),1),k.value.details?(C(),A("div",ol,[i("details",null,[X[3]||(X[3]=i("summary",null,"Детали ошибки",-1)),i("pre",null,O(k.value.details),1)])])):Z("",!0),i("div",{class:"error-actions"},[i("button",{onClick:Ke,class:"btn-retry"},"Повторить попытку")])])])):Z("",!0),i("div",ll,[i("div",rl,[i("div",il,[i("button",{class:"btn-back-link",type:"button",onClick:Ee,"aria-label":vl,"aria-disabled":!B.value,"data-fallback":!B.value,disabled:Q.value,title:"Назад"}," ← ",8,cl),i("nav",ul,[ue(ye,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Me(()=>[...X[4]||(X[4]=[st(" Дашборд сектора 1С ",-1)])]),_:1}),X[5]||(X[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),X[6]||(X[6]=i("span",{class:"breadcrumb-current"},"График состояния",-1))])]),X[7]||(X[7]=i("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),X[8]||(X[8]=i("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),i("div",dl,[i("button",{onClick:Ye,class:"btn-export-pdf",disabled:w.value||g.value,title:"Экспортировать график в PDF"},[w.value?(C(),A("span",fl,"⏳ Экспорт...")):(C(),A("span",gl,"📄 Экспорт в PDF"))],8,pl),ue(oo,{user:p.value,onSnapshotCreated:De},null,8,["user"])])]),ae.value?(C(),A("button",{key:2,class:"mobile-filters-toggle",onClick:X[0]||(X[0]=xe=>D.value=!D.value)},[X[9]||(X[9]=i("span",null,"Фильтры",-1)),i("span",{class:oe(["toggle-icon",{open:D.value}])},"▼",2)])):Z("",!0),i("div",{class:oe({"mobile-open":D.value&&ae.value,"mobile-closed":!D.value&&ae.value})},[ue(Qo,{stages:je(n).stages,employees:je(n).employees,dateRange:je(n).dateRange,customDateRange:je(n).customDateRange,hasActiveFilters:je(c),"onUpdate:stages":P,"onUpdate:employees":G,"onUpdate:dateRange":q,"onUpdate:customDateRange":ie,onReset:Fe,onApply:de},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!g.value&&!k.value?(C(),A("div",ml,[i("div",hl,[ue(On,{period:je(l),"show-current-state":d.value,onDataLoaded:Ve,onError:we},null,8,["period","show-current-state"])])])):Z("",!0)])}}},kl=Re(yl,[["__scopeId","data-v-e995acfd"]]),Sl=Object.freeze(Object.defineProperty({__proto__:null,default:kl},Symbol.toStringTag,{value:"Module"}));export{Sl as G,jt as T,ma as g};
