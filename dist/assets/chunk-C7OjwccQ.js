import{L as s,g as A}from"./main-Be6oDF_i.js";let p=null;class l{static initialize(){typeof window<"u"&&window.BX24?(p=window.BX24,s.info("Using BX24 API directly","ApiClient")):(p={call:async(e,t)=>{switch(s.info(`Mock API call: ${e}`,"ApiClient",t),await new Promise(r=>setTimeout(r,100)),e){case"bizproc.smartprocess.list":return{result:[{ID:"1",TITLE:"Test Ticket 1",CREATED_TIME:"2026-01-12T10:00:00Z",STAGE_ID:"DT140_12:NEW",ASSIGNED_BY_ID:"1013",UF_CRM_7_TYPE_PRODUCT:"PDM"},{ID:"2",TITLE:"Test Ticket 2",CREATED_TIME:"2026-01-12T11:00:00Z",STAGE_ID:"DT140_12:ANALYSIS",ASSIGNED_BY_ID:"1014",UF_CRM_7_TYPE_PRODUCT:"PDM"}],total:2};case"user.get":return{result:[{ID:"1013",NAME:"ÐœÐ°Ñ€Ðº",LAST_NAME:"Ð¢ÐµÑÑ‚Ð¾Ð²",DEPARTMENT:[369]},{ID:"1014",NAME:"Ð˜Ð²Ð°Ð½",LAST_NAME:"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº",DEPARTMENT:[369]}]};default:return s.warn(`Unknown method ${e}, returning empty result`,"ApiClient"),{result:[]}}}},s.info("Using mock API for development","ApiClient"))}static async call(e,t={}){p||this.initialize();try{s.debug(`Calling ${e}`,"ApiClient",{params:t});const r=await p.call(e,t);return s.debug(`Call ${e} completed`,"ApiClient"),r}catch(r){throw s.error(`Call ${e} failed`,"ApiClient",r),r}}static async getSmartProcessItems(e){const{entityTypeId:t,select:r=["*"],filter:a={},order:c={},limit:n=50}=e,E={entityTypeId:t,select:r,filter:a,order:c,limit:n},d=await this.call("bizproc.smartprocess.list",E);return d.items||d.result||[]}static async getSmartProcessItem(e,t){const{entityTypeId:r,select:a=["*"]}=t,c={entityTypeId:r,id:e,select:a},n=await this.call("bizproc.smartprocess.get",c);return n.item||n.result||null}static async updateSmartProcessItem(e,t,r={}){const{entityTypeId:a}=r,c={entityTypeId:a,id:e,fields:t};return await this.call("bizproc.smartprocess.update",c)}}l.initialize();class N{static async getAllTickets(e={}){try{s.info("Loading all tickets from Bitrix24","TicketRepository");const t=await l.getSmartProcessItems({entityTypeId:e.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e.filter||{},order:{CREATED_TIME:"DESC"}});return s.info(`Loaded ${t.length} tickets`,"TicketRepository"),t}catch(t){throw s.error("Failed to load tickets","TicketRepository",t),t}}static async getTicketsByFilter(e,t={}){try{s.info("Loading filtered tickets","TicketRepository",{filter:e});const r=await l.getSmartProcessItems({entityTypeId:t.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e,order:{CREATED_TIME:"DESC"}});return s.info(`Loaded ${r.length} filtered tickets`,"TicketRepository"),r}catch(r){throw s.error("Failed to load filtered tickets","TicketRepository",r),r}}static async getTicketById(e){try{return s.info(`Loading ticket ${e}`,"TicketRepository"),await l.getSmartProcessItem(e,{entityTypeId:140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"]})}catch(t){throw s.error(`Failed to load ticket ${e}`,"TicketRepository",t),t}}}class C{static async getAllEmployees(e={}){try{s.info("Loading all employees from Bitrix24","EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y"},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return s.info(`Loaded ${t.length} employees`,"EmployeeRepository"),t}catch(t){throw s.error("Failed to load employees","EmployeeRepository",t),t}}static async getEmployeeById(e){try{return s.info(`Loading employee ${e}`,"EmployeeRepository"),(await l.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]}))[0]||null}catch(t){throw s.error(`Failed to load employee ${e}`,"EmployeeRepository",t),t}}static async getEmployeesByDepartment(e){try{s.info(`Loading employees for department ${e}`,"EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y",UF_DEPARTMENT:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return s.info(`Loaded ${t.length} employees for department ${e}`,"EmployeeRepository"),t}catch(t){throw s.error(`Failed to load employees for department ${e}`,"EmployeeRepository",t),t}}}class y{constructor(e){this.sectorId=e,this.cache=new Map,this.cacheTimestamps=new Map,this.defaultTtl=5*60*1e3}get(e){const t=`${this.sectorId}:${e}`;if(!this.cache.has(t))return null;const r=this.cacheTimestamps.get(t);return Date.now()-r>this.defaultTtl?(s.debug(`Cache expired for key: ${t}`,"CacheManager"),this.cache.delete(t),this.cacheTimestamps.delete(t),null):(s.debug(`Cache hit for key: ${t}`,"CacheManager"),this.cache.get(t))}set(e,t,r=this.defaultTtl){const a=`${this.sectorId}:${e}`,c=Date.now();this.cache.set(a,t),this.cacheTimestamps.set(a,c),s.debug(`Cache set for key: ${a}, TTL: ${r}ms`,"CacheManager")}clear(){const e=[];for(const t of this.cache.keys())t.startsWith(`${this.sectorId}:`)&&e.push(t);e.forEach(t=>{this.cache.delete(t),this.cacheTimestamps.delete(t)}),s.info(`Cache cleared for sector: ${this.sectorId}, ${e.length} entries`,"CacheManager")}clearAll(){const e=this.cache.size;this.cache.clear(),this.cacheTimestamps.clear(),s.info(`All cache cleared, ${e} entries removed`,"CacheManager")}getStats(){const e=Array.from(this.cache.keys()).filter(t=>t.startsWith(`${this.sectorId}:`));return{totalEntries:this.cache.size,sectorEntries:e.length,otherEntries:this.cache.size-e.length}}}const S=140,o={NEW:"DT140_12:NEW",ANALYSIS:"DT140_12:ANALYSIS",DEVELOPMENT:"DT140_12:DEVELOPMENT",TESTING:"DT140_12:TESTING",DEPLOYMENT:"DT140_12:DEPLOYMENT",CLOSED:"DT140_12:CLOSED"},f={[o.NEW]:"ÐÐ¾Ð²Ñ‹Ð¹",[o.ANALYSIS]:"ÐÐ½Ð°Ð»Ð¸Ð·",[o.DEVELOPMENT]:"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°",[o.TESTING]:"Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ",[o.DEPLOYMENT]:"Ð’Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ",[o.CLOSED]:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚"},h={[o.NEW]:"#007bff",[o.ANALYSIS]:"#ffc107",[o.DEVELOPMENT]:"#28a745",[o.TESTING]:"#17a2b8",[o.DEPLOYMENT]:"#6f42c1",[o.CLOSED]:"#6c757d"};function $(){return[{id:o.NEW,name:f[o.NEW],color:h[o.NEW],order:1},{id:o.ANALYSIS,name:f[o.ANALYSIS],color:h[o.ANALYSIS],order:2},{id:o.DEVELOPMENT,name:f[o.DEVELOPMENT],color:h[o.DEVELOPMENT],order:3},{id:o.TESTING,name:f[o.TESTING],color:h[o.TESTING],order:4},{id:o.DEPLOYMENT,name:f[o.DEPLOYMENT],color:h[o.DEPLOYMENT],order:5},{id:o.CLOSED,name:f[o.CLOSED],color:h[o.CLOSED],order:6}]}function L(i){try{if(!i)return s.warn("getSectorFilterValues: sectorConfig is null or undefined","sector-config-helper"),[];const{filterValue:e,filterValues:t,id:r,name:a}=i;let c=null;if(Array.isArray(e)?c=e:Array.isArray(t)?c=t:e!=null&&(c=[e]),!c||c.length===0)return s.warn(`Sector ${r||"unknown"} has no filter values`,"sector-config-helper"),[];const n=c.filter(E=>E!=null&&E!=="");return s.debug(`Sector ${r} filter values: ${n.join(", ")}`,"sector-config-helper"),n}catch(e){return s.error(`Error getting filter values for sector ${i?.id||"unknown"}`,"sector-config-helper",e),[]}}function M(i){try{const e=L(i),t=i.filterField||"UF_CRM_7_TYPE_PRODUCT";return e.length===0?`${t} = (no filter)`:e.length===1?`${t} = '${e[0]}'`:`${t} IN (${e.map(r=>`'${r}'`).join(", ")})`}catch(e){return s.error("Error getting sector filter description","sector-config-helper",e),"Error generating description"}}function R(i){const e={};return Object.values(o).forEach(t=>{e[t]=[]}),i.forEach(t=>{const r=t.STAGE_ID||t.stageId||o.NEW;e[r]?e[r].push(t):e[o.NEW].push(t)}),s.debug("Tickets grouped by stages","TicketGrouper",{totalTickets:i.length,stagesWithTickets:Object.values(e).filter(t=>t.length>0).length}),e}function w(i){const e=new Set;return i.forEach(t=>{t.ASSIGNED_BY_ID&&e.add(t.ASSIGNED_BY_ID),t.CREATED_BY_ID&&e.add(t.CREATED_BY_ID),t.UF_RESPONSIBLE&&(Array.isArray(t.UF_RESPONSIBLE)?t.UF_RESPONSIBLE.forEach(r=>e.add(r)):e.add(t.UF_RESPONSIBLE))}),Array.from(e)}function D(i){try{Object.keys(localStorage).forEach(r=>{r.startsWith(`sector-${i}-`)&&localStorage.removeItem(r)}),Object.keys(sessionStorage).forEach(r=>{r.startsWith(`sector-${i}-`)&&sessionStorage.removeItem(r)}),s.info(`Sector cache cleared for: ${i}`,"SectorHelper")}catch(e){s.error(`Failed to clear sector cache for: ${i}`,"SectorHelper",e)}}function T(){try{return localStorage.getItem("sector-dashboard-diagnostics")==="true"}catch{return!1}}function P(){return{log:(i,e={})=>{T()&&(s.info(`[DIAGNOSTICS] ${i}`,"DiagnosticsService",e),console.log(`ðŸ” [DIAGNOSTICS] ${i}`,e))},measureTime:i=>{if(!T())return()=>{};const e=performance.now();return()=>{const r=performance.now()-e;s.info(`[DIAGNOSTICS] ${i} took ${r.toFixed(2)}ms`,"DiagnosticsService"),console.log(`â±ï¸ [DIAGNOSTICS] ${i}: ${r.toFixed(2)}ms`)}},checkServicesStatus:async i=>{if(!T())return{};const e={sectorId:i,timestamp:new Date().toISOString(),services:{}};try{const t=["TicketRepository","EmployeeRepository","ApiClient"];for(const r of t)try{e.services[r]={available:!0,lastCheck:new Date().toISOString()}}catch(a){e.services[r]={available:!1,error:a.message,lastCheck:new Date().toISOString()}}}catch(t){s.error("Failed to check services status","DiagnosticsService",t)}return s.info("Services status checked","DiagnosticsService",e),e},getPerformanceInfo:()=>{if(!T())return{};const i={timestamp:new Date().toISOString(),memory:{},timing:{}};try{performance.memory&&(i.memory={usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}),performance.timing&&(i.timing={navigationStart:performance.timing.navigationStart,loadEventEnd:performance.timing.loadEventEnd,domContentLoadedEventEnd:performance.timing.domContentLoadedEventEnd,totalLoadTime:performance.timing.loadEventEnd-performance.timing.navigationStart})}catch(e){s.error("Failed to get performance info","DiagnosticsService",e)}return i}}}class O{constructor(e,t){this.sectorId=e,this.config={name:t.name,filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:t.filterValue,...t},s.info(`DashboardSectorBaseService initialized for sector: ${e}`,"DashboardSectorBaseService")}async getSectorData(e={}){const t=e.useCache!==!1;e.useBackendCache;const r=e.onProgress||null;try{if(T()){const a=P();a&&a.reset()}}catch(a){s.warn("Error resetting diagnostics","DashboardSectorBaseService",a)}r&&r({step:"initialization",progress:0,details:{description:`Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name}...`}});try{r&&r({step:"loading_tickets",progress:10,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð¸Ð· Bitrix24...`}});const a={};a[this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"]=this.config.filterValue;const c=await N.getTicketsByFilter(a,{entityTypeId:S}),n=A(c,{id:this.sectorId,name:this.config.name,filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"});s.info(`Sector filtering completed for ${this.config.name}`,"DashboardSectorBaseService",{sectorId:this.sectorId,totalTickets:c.length,filteredTickets:n.length,filterDescription:M({filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"})}),r&&r({step:"extracting_employees",progress:55,details:{description:"Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²..."}});const E=w(n),d=await C.getEmployeesByIds(E,g=>{r&&r({step:"loading_employees",progress:55+(g.progress||0)*.3,details:g.details||{}})});r&&r({step:"grouping_tickets",progress:85,details:{description:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼..."}});const I=$(),{stages:m,zeroPointTickets:_}=R(n,d,I),u={stages:m,employees:d,zeroPointTickets:_,metadata:{sectorId:this.sectorId,sectorName:this.config.name,filterValue:this.config.filterValue,totalTickets:n.length,totalEmployees:d.length,lastUpdated:new Date().toISOString()}};if(t){const g=y.getSectorDataCacheKey(this.sectorId);y.set(g,u),s.info(`Sector data cached for ${this.sectorId}`,"DashboardSectorBaseService")}return r&&r({step:"completed",progress:100,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°`,totalTickets:n.length,totalEmployees:d.length}}),s.info(`Sector data loaded successfully for ${this.sectorId}`,"DashboardSectorBaseService",{totalTickets:n.length,totalEmployees:d.length,stagesCount:m.length}),u}catch(a){throw s.error(`Error loading sector data for ${this.sectorId}`,"DashboardSectorBaseService",a),r&&r({step:"error",progress:0,details:{description:`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ${a.message}`,error:!0}}),a}}async updateTicketAssignment(e,t,r){try{s.info(`Updating ticket assignment: ${e} -> ${t} -> ${r}`,"DashboardSectorBaseService");const a=await l.call("crm.item.update",{entityTypeId:S,id:e,fields:{stageId:t,assignedById:r}});return D(this.sectorId),s.info(`Ticket assignment updated successfully: ${e}`,"DashboardSectorBaseService"),a}catch(a){throw s.error(`Error updating ticket assignment: ${e}`,"DashboardSectorBaseService",a),a}}async createTicket(e){try{s.info("Creating new ticket","DashboardSectorBaseService",e);const t=await l.call("crm.item.add",{entityTypeId:S,fields:{...e,[this.config.filterField]:this.config.filterValue}});return D(this.sectorId),s.info(`Ticket created successfully: ${t.result}`,"DashboardSectorBaseService"),{id:t.result,...e}}catch(t){throw s.error("Error creating ticket","DashboardSectorBaseService",t),t}}}export{O as D};
