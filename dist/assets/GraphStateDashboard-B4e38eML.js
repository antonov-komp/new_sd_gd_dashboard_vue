import{_ as Se,a as _,o as b,d as i,F as ue,f as pe,j as ae,n as we,t as P,r as $,c as J,G as He,m as Ce,g as Me,b as Z,k as re,l as Be,i as ie,B as Ge,H as Ot,I as At,u as xe,J as kt,p as Ue,K as et,x as Bt,L as xt,M as It,C as $t,N as Ye,D as Pt,O as Lt,P as Wt,y as je,Q as Ie,z as Ut,e as jt}from"./main-B2bvBbpI.js";import{L as wt,D as zt,B as Kt}from"./index-DnDyQppz.js";import{S as tt,h as at,K as Vt,d as St,B as lt,m as bt,j as ze,k as oe,D as Dt,a as Gt,l as Et}from"./index-Ds5MlP32.js";const ve={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class ke{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,s={}){try{if(!t||typeof t!="object")throw new Te("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new Te("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const a=this.validateSectorData(t);if(!a.isValid)throw new Te(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${a.errors.join(", ")}`,"VALIDATION_ERROR",{validation:a});const n=this.normalizeSectorData(t),o={metadata:this.generateSnapshotMetadata(e,s.createdBy,s.sectorId||ve.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},r=this.validateSnapshot(o);if(!r.isValid)throw new Te(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});r.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",r.warnings);const d=this.getApiBaseUrl(),p=await fetch(`${d}${ve.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:o,type:e,date:this.formatDate(new Date)})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const g=await p.json();if(!g.success)throw new Error(g.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return g.data.snapshot}catch(a){throw console.error("SnapshotService.createSnapshot error:",a),a instanceof Te?a:new Te(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${a.message}`,"API_ERROR",{originalError:a})}}static async getSnapshot(t,e){try{const s=this.formatDate(t),n=`${this.getApiBaseUrl()}${ve.snapshotsEndpoint}?action=get&date=${s}&type=${e}`,l=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const o=await l.json();if(!o.success){if(o.message&&o.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω"))return null;throw new Error(o.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞")}return o.data.snapshot}catch(s){throw console.error("SnapshotService.getSnapshot error:",s),s}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",ve.defaultSectorId);const a=`${this.getApiBaseUrl()}${ve.snapshotsEndpoint}?${e.toString()}`,n=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(l.data.snapshots.map(async r=>{try{return await this.getSnapshot(r.date,r.type)}catch(d){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${r.date}/${r.type}:`,d),null}}))).filter(r=>r!==null).sort((r,d)=>new Date(r.metadata.createdAt)-new Date(d.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:s=[],zeroPointTickets:a={}}=t,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},l=[],o=[],r=[];e.forEach(g=>{const u=g.id;if(n[u]){let y=0;g.employees.forEach(S=>{const h=S.tickets||[];y+=h.length;let f=l.find(w=>w.id===S.id);f||(f={id:S.id,name:S.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(f)),h.forEach(w=>{o.push(w.id),r.push({id:w.id,title:w.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:S.id,name:S.name},createdAt:w.createdAt||"",updatedAt:w.modifiedAt||w.updatedAt||""}),f.ticketsByStage[u]=(f.ticketsByStage[u]||0)+1,f.totalTickets+=1})}),n[u].count=y}});const d={unassigned:0,keeper:0,total:0};Object.values(a).forEach(g=>{Array.isArray(g)&&g.forEach(u=>{d.total+=1,u.assigneeId===1051||u.assignedById===1051?d.keeper+=1:d.unassigned+=1,o.push(u.id),r.push({id:u.id,title:u.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:u.assignedTo||u.assignedById?{id:u.assignedById||u.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:u.createdAt||"",updatedAt:u.modifiedAt||u.updatedAt||""})})});const p=Object.values(n).reduce((g,u)=>g+u.count,0)+d.total;return{statistics:{stages:{...n,total:p},employees:l,zeroPoint:d},ticketIds:[...new Set(o)],tickets:r}}static generateSnapshotMetadata(t,e,s){const a=new Date,n=-a.getTimezoneOffset(),l=Math.floor(n/60),o=n%60,r=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(o).padStart(2,"0")}`,d=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}T${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}${r}`;return{version:ve.snapshotVersion,createdAt:d,createdBy:e||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:t,sectorId:s,sectorName:s==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${s}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${a}`}static buildFilePath(t,e){const s=typeof t=="string"?new Date(t):t,a=s.getFullYear(),n=this.getWeekNumber(s),l=this.formatDate(t);let o;if(e==="current"){const r=new Date,d=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;o=`current-state-${l}-${d}.json`}else if(e==="manual"){const r=new Date,d=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;o=`manual-${l}-${d}.json`}else o=`${e}-${l}.json`;return e==="current"?`current/${o}`:`${a}/week-${n}/${o}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),s=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-s);const a=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-a)/864e5+1)/7)}static validateSnapshot(t){var a,n,l;const e=[],s=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):e.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!t.statistics)e.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!t.statistics.stages)e.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const o=t.statistics.stages,r=(((a=o.formed)==null?void 0:a.count)||0)+(((n=o.review)==null?void 0:n.count)||0)+(((l=o.execution)==null?void 0:l.count)||0);o.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}if(Array.isArray(t.statistics.employees)||e.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!t.statistics.zeroPoint)e.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const o=t.statistics.zeroPoint,r=(o.unassigned||0)+(o.keeper||0);o.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(t.tickets))e.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const o=new Set(t.ticketIds),r=new Set(t.tickets.map(d=>d.id));o.size!==r.size&&s.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),t.tickets.forEach((d,p)=>{d.id||e.push(`–¢–∏–∫–µ—Ç #${p}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),d.title||e.push(`–¢–∏–∫–µ—Ç #${p}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!d.assignedTo||!d.assignedTo.id)&&s.push(`–¢–∏–∫–µ—Ç #${p}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),d.createdAt||e.push(`–¢–∏–∫–µ—Ç #${p}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),d.updatedAt||e.push(`–¢–∏–∫–µ—Ç #${p}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:e.length===0,errors:e,warnings:s}}static validateSectorData(t){const e=[],s=[];return!t||typeof t!="object"?(e.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:e,warnings:s}):(Array.isArray(t.stages)||e.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(t.employees)||e.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:e.length===0,errors:e,warnings:s})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const s=this.formatDate(t),n=`${this.getApiBaseUrl()}${ve.snapshotsEndpoint}`,l=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:s,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const o=await l.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(s){throw console.error("SnapshotService.deleteSnapshot error:",s),s}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let s=0;for(const a of e)try{await this.deleteSnapshot(a.metadata.createdAt.split("T")[0],a.metadata.type)&&s++}catch(n){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${a.metadata.createdAt}:`,n)}return s}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=ve.snapshotVersion){const s=this.getSnapshotVersion(t);return s===e||s==="1.0"&&e==="1.0"?t:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${s} –Ω–∞ ${e} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,s=this.getWeekNumber(e);return{year:e.getFullYear(),week:s}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,a=(e.getDay()||7)-1,n=new Date(e);return n.setDate(e.getDate()-a),n.setHours(0,0,0,0),n}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,a=7-(e.getDay()||7),n=new Date(e);return n.setDate(e.getDate()+a),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),s=this.getWeekEndDate(t),a=this.getWeekNumberInfo(t),n=await this.getAllSnapshots({startDate:e,endDate:s}),l=n.find(d=>d.metadata.type==="week_start")||null,o=n.find(d=>d.metadata.type==="week_end")||null,r=n.filter(d=>d.metadata.type==="manual");return{weekStart:l,weekEnd:o,manual:r,weekInfo:a}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof Te)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("–≤–µ—Ä—Å–∏—è")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("–¥–æ—Å—Ç—É–ø")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),s={week_start:0,week_end:0,manual:0,current:0},a=new Map;let n=null,l=null;e.forEach(r=>{const d=r.metadata.type;s.hasOwnProperty(d)&&s[d]++;const p=this.getWeekNumberInfo(r.metadata.createdAt),g=`${p.year}-W${p.week}`;a.set(g,(a.get(g)||0)+1);const u=new Date(r.metadata.createdAt);(!n||u<new Date(n.metadata.createdAt))&&(n=r),(!l||u>new Date(l.metadata.createdAt))&&(l=r)});const o=Array.from(a.entries()).map(([r,d])=>{const[p,g]=r.split("-W");return{year:parseInt(p),week:parseInt(g),count:d}}).sort((r,d)=>r.year!==d.year?r.year-d.year:r.week-d.week);return{total:e.length,byType:s,byWeek:o,oldest:n,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class Te extends Error{constructor(t,e,s={}){super(t),this.name="SnapshotError",this.code=e,this.details=s}}const ye={formed:{bitrixId:at.formed,name:tt.FORMED.name},review:{bitrixId:at.review,name:tt.REVIEW.name},execution:{bitrixId:at.execution,name:tt.EXECUTION.name}},Oe=Vt;function Yt(c){if(!c||typeof c!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!c.stages||!Array.isArray(c.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=qt(c.stages),e=Jt(c.stages),s=Xt(c.zeroPointTickets||{}),a=Zt(c.zeroPointTickets||{}),n=Qt(c.stages,c.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:s,zeroPointByStage:a},ticketIds:n.ticketIds,tickets:n.tickets}}function qt(c){const t={formed:{count:0,stageId:ye.formed.bitrixId,stageName:ye.formed.name},review:{count:0,stageId:ye.review.bitrixId,stageName:ye.review.name},execution:{count:0,stageId:ye.execution.bitrixId,stageName:ye.execution.name},total:0};return c.forEach(e=>{if(!ye[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let s=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(a=>{a.tickets&&Array.isArray(a.tickets)&&(s+=a.tickets.length)}),t[e.id].count=s,t.total+=s}),t}function Jt(c){const t=new Map;return c.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(s=>{if(!s||!s.id)return;t.has(s.id)||t.set(s.id,{id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const a=t.get(s.id),n=s.tickets&&Array.isArray(s.tickets)?s.tickets.length:0;ye[e.id]&&(a.ticketsByStage[e.id]=(a.ticketsByStage[e.id]||0)+n),a.totalTickets+=n})}),Array.from(t.values())}function Xt(c){let t=0,e=0;return!c||typeof c!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(c).forEach(s=>{Array.isArray(s)&&s.forEach(a=>{if(!a)return;const n=a.assignedTo||a.assignedById;!n||n===null?t++:(typeof n=="object"?n.id:n)===Oe?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function Zt(c){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!c||typeof c!="object"||Object.keys(t).forEach(e=>{const s=c[e];Array.isArray(s)&&s.forEach(a=>{if(!a)return;const n=a.assignedTo||a.assignedById;!n||n===null?t[e].unassigned++:(typeof n=="object"?n.id:n)===Oe?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function Qt(c,t){const e=new Set,s=new Map;return Array.isArray(c)&&c.forEach(a=>{!a.employees||!Array.isArray(a.employees)||a.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const o=parseInt(l.id);if(isNaN(o)){console.warn("Invalid ticket ID:",l.id);return}e.add(o);let r=l.assignedTo;!r&&n.id&&(r={id:n.id,name:n.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${n.id}`}),s.set(o,{id:o,title:l.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:r||null,createdAt:We(l.createdAt||l.createdTime),updatedAt:We(l.updatedAt||l.modifiedAt||l.updatedTime)})})})}),t&&typeof t=="object"&&Object.values(t).forEach(a=>{Array.isArray(a)&&a.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",n.id);return}e.add(l);let o=n.assignedTo;if(!o&&n.assignedById){const r=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;r&&r!==Oe?o={id:r,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:r===Oe&&(o={id:Oe,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}s.set(l,{id:l,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o||null,createdAt:We(n.createdAt||n.createdTime),updatedAt:We(n.updatedAt||n.modifiedAt||n.updatedTime)})})}),{ticketIds:Array.from(e).sort((a,n)=>a-n),tickets:Array.from(s.values())}}function We(c){if(!c)return null;if(c instanceof Date)return c.toISOString();if(typeof c=="string"){if(c.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return c;const t=new Date(c);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",c),null}class ot{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:s=null,normalize:a=!0,includeTicketDetails:n=!1}=t;try{const l=await St.getSectorData(e,s);return a?Yt(l):(n&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await St.getSectorData(!0);return t!=null}catch{return!1}}}class st{static compareTwoSnapshots(t,e,s={}){const{includeTickets:a=!1,includeEmployees:n=!0}=s,l=this.validateSnapshot(t),o=this.validateSnapshot(e);if(!l.valid||!o.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...o.errors].join(", "));const r=this.buildComparisonMetadata(t,e),d=this.compareStages(t.statistics.stages,e.statistics.stages),p=n?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],g=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),u=a?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,y=this.buildSummary(d,p,g,u);return{metadata:r,stages:d,employees:p,zeroPoint:g,tickets:u,summary:y}}static calculateDelta(t,e){const s=this.normalizeValue(t),a=this.normalizeValue(e),n=a-s;let l=0;s!==0?l=n/s*100:a!==0&&(l=a>0?1/0:-1/0);const o=this.getTrend(n);return{value1:s,value2:a,delta:n,deltaPercent:Math.round(l*100)/100,trend:o}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var o,r;const s=["formed","review","execution"],a={};for(const d of s){const p=((o=t[d])==null?void 0:o.count)||0,g=((r=e[d])==null?void 0:r.count)||0;a[d]=this.calculateDelta(p,g)}const n=t.total||0,l=e.total||0;return a.total=this.calculateDelta(n,l),a}static compareEmployees(t,e){var o,r;const s=new Map(t.map(d=>[d.id,d])),a=new Map(e.map(d=>[d.id,d])),n=new Set([...s.keys(),...a.keys()]),l=[];for(const d of n){const p=s.get(d)||null,g=a.get(d)||null;if(!p||!g){l.push({id:d,name:(p==null?void 0:p.name)||(g==null?void 0:g.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(p,g),trend:p?"removed":"new"});continue}const u={},y=["formed","review","execution"];for(const h of y){const f=((o=p.ticketsByStage)==null?void 0:o[h])||0,w=((r=g.ticketsByStage)==null?void 0:r[h])||0;u[h]=this.calculateDelta(f,w)}const S=this.calculateDelta(p.totalTickets||0,g.totalTickets||0);l.push({id:d,name:p.name,snapshot1:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:u,totalTickets:S},trend:S.trend})}return l}static calculateEmployeeDelta(t,e){var l,o;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const s={},a=["formed","review","execution"];for(const r of a){const d=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[r])||0,p=((o=e==null?void 0:e.ticketsByStage)==null?void 0:o[r])||0;s[r]=this.calculateDelta(d,p)}const n=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:s,totalTickets:n}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,s,a){var y,S;const n=new Set(t),l=new Set(e),o=e.filter(h=>!n.has(h)),r=t.filter(h=>!l.has(h)),d=[],p=[],g=new Map(s.map(h=>[h.id,h])),u=new Map(a.map(h=>[h.id,h]));for(const h of t){if(!l.has(h))continue;const f=g.get(h),w=u.get(h);if(!f||!w)continue;const I=(((y=f.assignedTo)==null?void 0:y.id)||null)!==(((S=w.assignedTo)==null?void 0:S.id)||null),z=(f.stageId||null)!==(w.stageId||null);I||z?d.push(h):p.push(h)}return{new:o,removed:r,changed:d,unchanged:p}}static buildComparisonMetadata(t,e){const s=new Date(t.metadata.createdAt),a=new Date(e.metadata.createdAt),n=new Date,l=a.getTime()-s.getTime(),o=Math.floor(l/(1e3*60*60*24)),r=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),d=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:n.toISOString(),timeDiff:{days:o,hours:r,minutes:d,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,s,a){var d,p,g;const n=t.total.delta,l=Object.keys(t).filter(u=>u==="total"?!1:t[u].delta!==0).length,o=e.filter(u=>u.trend==="new"||u.trend==="removed"?!0:u.delta.totalTickets.delta!==0).length,r=n!==0||l>0||o>0;return{totalDelta:n,stagesChanged:l,employeesChanged:o,hasChanges:r,newTicketsCount:((d=a==null?void 0:a.new)==null?void 0:d.length)||0,removedTicketsCount:((p=a==null?void 0:a.removed)==null?void 0:p.length)||0,changedTicketsCount:((g=a==null?void 0:a.changed)==null?void 0:g.length)||0}}static validateSnapshot(t){const e=[],s=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:s};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const a=["formed","review","execution"];for(const n of a)t.statistics.stages[n]||s.push(`Missing stage: ${n}`)}t.statistics.employees||s.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||s.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:s}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const o=this.validateSnapshot(l);if(!o.valid)throw new Error("Invalid snapshot: "+o.errors.join(", "))}const s=[...t].sort((l,o)=>{const r=new Date(l.metadata.createdAt),d=new Date(o.metadata.createdAt);return r-d}),a=[];for(let l=0;l<s.length-1;l++)a.push({from:l,to:l+1,result:this.compareTwoSnapshots(s[l],s[l+1],e)});const n=this.buildTrends(s);return{snapshots:s.map((l,o)=>({index:o,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:a,trends:n}}static buildTrends(t){var s,a,n,l,o,r,d,p,g,u;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const y of t){const S=y.statistics;e.stages.formed.push(((a=(s=S.stages)==null?void 0:s.formed)==null?void 0:a.count)||0),e.stages.review.push(((l=(n=S.stages)==null?void 0:n.review)==null?void 0:l.count)||0),e.stages.execution.push(((r=(o=S.stages)==null?void 0:o.execution)==null?void 0:r.count)||0),e.stages.total.push(((d=S.stages)==null?void 0:d.total)||0),e.zeroPoint.unassigned.push(((p=S.zeroPoint)==null?void 0:p.unassigned)||0),e.zeroPoint.keeper.push(((g=S.zeroPoint)==null?void 0:g.keeper)||0),e.zeroPoint.total.push(((u=S.zeroPoint)==null?void 0:u.total)||0)}return e}}const ea={class:"stages-container"},ta={class:"stages-chips"},aa=["checked","disabled","onChange"],sa={class:"stage-chip-label"},na={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:c=>c.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(c,{emit:t}){const e=c,s=t;function a(n,l){const o={...e.selected};o[n]=l,s("update:selected",o),s("change",n,l)}return(n,l)=>(b(),_("div",ea,[l[0]||(l[0]=i("h4",{class:"stages-title"},"–≠—Ç–∞–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:",-1)),i("div",ta,[(b(!0),_(ue,null,pe(c.stages,o=>(b(),_("label",{key:o.id,class:ae(["stage-chip",{"stage-chip--active":c.selected[o.id],"stage-chip--disabled":c.disabled}])},[i("input",{type:"checkbox",checked:c.selected[o.id],disabled:c.disabled,onChange:r=>a(o.id,r.target.checked)},null,40,aa),i("span",{class:"stage-chip-color",style:we({backgroundColor:o.color})},null,4),i("span",sa,P(o.name),1)],2))),128))])]))}},la=Se(na,[["__scopeId","data-v-fe03c03c"]]),nt=140,$e=new Map;class Mt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await lt.call("crm.item.list",{entityTypeId:nt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let s=[];if(e&&e.result&&(Array.isArray(e.result)?s=e.result:e.result.items&&Array.isArray(e.result.items)?s=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(s=e.result.data)),!s||s.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const a=s[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:a.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!a.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:a.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(a),ticketSample:JSON.stringify(a).substring(0,500)});const n=bt(a),l=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:n.departmentHead,departmentHeadFull:l?String(l).trim():null});let o=null;if(l){const r=String(l).trim();r.length>0&&(o=r)}return{...n,departmentHeadFull:o}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],s=[];if(t.forEach(a=>{$e.has(a)?e.push($e.get(a)):s.push(a)}),s.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:s.length,ticketIdsSample:s.slice(0,5),entityTypeId:nt});const a=await lt.call("crm.item.list",{entityTypeId:nt,filter:{id:s},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!a,resultType:typeof a,resultKeys:a?Object.keys(a):[],hasResultResult:!!(a!=null&&a.result),resultResultType:typeof(a==null?void 0:a.result),isArray:Array.isArray(a==null?void 0:a.result),resultResultLength:Array.isArray(a==null?void 0:a.result)?a.result.length:"not array",fullResult:a});let n=[];if(a&&a.result&&(Array.isArray(a.result)?n=a.result:a.result.items&&Array.isArray(a.result.items)?n=a.result.items:a.result.data&&Array.isArray(a.result.data)&&(n=a.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!a,hasResultResult:!!(a!=null&&a.result),resultType:typeof(a==null?void 0:a.result),result:a,resultKeys:a?Object.keys(a):[]}),e;const l=n.map((o,r)=>{r===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:o.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:o.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(o).filter(y=>y.toLowerCase().includes("department")||y.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(o).slice(0,20)});const d=bt(o);r===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:d.id,hasDepartmentHead:!!d.departmentHead,departmentHead:d.departmentHead,mappedTicketKeys:Object.keys(d).filter(y=>y.toLowerCase().includes("department"))});const p=o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||null;r===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:p,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(o).filter(y=>y.toLowerCase().includes("department")||y.toLowerCase().includes("uf_crm"))});let g=null;if(p){const y=String(p).trim();y.length>0&&(g=y)}!g&&d.departmentHead&&(g=d.departmentHead);const u={...d,departmentHeadFull:g||d.departmentHead||null};return r===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:u.id,departmentHead:u.departmentHead,departmentHeadFull:u.departmentHeadFull}),u.id&&$e.set(u.id,u),u});return[...e,...l]}catch(a){return console.error("[TicketDetailsService] Error loading tickets details batch:",a),console.error("[TicketDetailsService] Error details:",{message:a.message,stack:a.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){$e.size>t&&$e.clear()}static getCacheSize(){return $e.size}}async function oa(c,t,e,s=null){var d;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:c,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((d=e==null?void 0:e.tickets)==null?void 0:d.length)||0}),!c||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const a=e.tickets.filter(p=>{const g=p.assignedTo;return g?(typeof g=="object"?g.id:g)===c:!1});if(a.length===0)return[];const n=!a[0].stageId||!a[0].departmentHead;let l=null;if(n){const p=a.map(g=>g.id);if(s&&typeof s=="object")l=s;else try{const g=await Mt.getTicketsDetails(p);l=new Map,g.forEach(u=>{u&&u.id&&l.set(u.id,u)})}catch(g){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",g),l=null}}return a.map(p=>{const g=p.id,u={id:g,title:p.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:p.assignedTo,createdAt:p.createdAt,updatedAt:p.updatedAt};if(l){const y=l instanceof Map?l.get(g):l[g];y?(u.stageId=y.stageId||null,u.departmentHead=y.departmentHead||null,u.departmentHeadFull=y.departmentHeadFull||y.departmentHead||null):(u.stageId=null,u.departmentHead=null)}else u.stageId=p.stageId||null,u.departmentHead=p.departmentHead||null,u.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null;return u}).filter(p=>p.stageId?ze(p.stageId)===t:!0)}function _t(c,t=new Date){if(!c||c.length===0)return[];const e=c.length,s={};return Object.values(oe).forEach(n=>{s[n]={category:n,label:Dt[n].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:Dt[n].color}}),c.forEach(n=>{if(!n.createdAt){s[oe.MORE_THAN_YEAR].count++,s[oe.MORE_THAN_YEAR].tickets.push(n);return}const l=Gt(n.createdAt,t);s[l]&&(s[l].count++,s[l].tickets.push(n))}),Object.values(s).filter(n=>n.count>0).map(n=>{const l=e>0?parseFloat((n.count/e*100).toFixed(1)):0;return{...n,percentage:l,progressBarWidth:l}}).sort((n,l)=>{const o=[oe.TODAY,oe.YESTERDAY,oe.THIS_WEEK,oe.LAST_WEEK,oe.MORE_THAN_TWO_WEEKS,oe.UP_TO_ONE_MONTH,oe.MORE_THAN_TWO_MONTHS,oe.MORE_THAN_HALF_YEAR,oe.MORE_THAN_YEAR];return o.indexOf(n.category)-o.indexOf(l.category)})}function Tt(c){if(!c||c.length===0)return[];const t={};c.forEach(s=>{let a=s.departmentHeadFull||s.departmentHead;c.indexOf(s)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:s.id,departmentHead:s.departmentHead,departmentHeadFull:s.departmentHeadFull,allKeys:Object.keys(s).filter(n=>n.toLowerCase().includes("department"))}),a?(a=String(a).trim(),a.length===0&&(a="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞")):a="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞",t[a]||(t[a]={departmentName:a,count:0}),t[a].count++});const e=Object.values(t);return e.sort((s,a)=>a.count!==s.count?a.count-s.count:s.departmentName.localeCompare(a.departmentName,"ru")),e}const ra={class:"modal-content"},ia={key:"level-1",class:"level-1"},ca={class:"modal-header"},da={class:"modal-total"},ua={class:"view-switcher"},pa={class:"modal-body"},ga={key:0},ma={key:0,class:"no-employees"},fa={key:1,class:"employees-list"},ha=["onClick"],va={class:"employee-name"},ya={class:"employee-progress"},ka={class:"employee-count"},wa={key:0,class:"employee-item employee-others"},Sa={class:"employee-name"},ba={class:"employee-progress"},Da={class:"employee-count"},Ea={key:1,class:"view-time"},_a={key:0,class:"no-data"},Ta={key:1,class:"date-categories-list"},Ca=["onClick"],Aa={class:"category-label"},Ia={class:"category-progress"},$a={class:"category-count"},Ma={key:2,class:"view-departments"},Na={key:0,class:"no-data"},Ra={key:1,class:"departments-table-container"},Fa={class:"departments-table"},Ha={class:"col-department"},Oa={class:"department-name"},Ba={class:"col-count"},xa={class:"count-value"},Pa={key:"level-2",class:"level-2"},La={class:"modal-header"},Wa={class:"modal-total"},Ua={class:"modal-body"},ja={class:"stage-info"},za={class:"stage-badge"},Ka={key:0,class:"no-data"},Va={key:1,class:"date-categories-list"},Ga=["onClick"],Ya={class:"category-label"},qa={class:"category-progress"},Ja={class:"category-count"},Xa={key:"level-3",class:"level-3"},Za={class:"modal-header"},Qa={class:"header-info"},es={class:"header-badges"},ts={class:"date-badge"},as={class:"stage-badge"},ss={class:"modal-total"},ns={class:"modal-body"},ls={key:0,class:"no-data"},os={key:1,class:"departments-table-container"},rs={class:"departments-table"},is={class:"col-department"},cs={class:"department-name"},ds={class:"col-count"},us={class:"count-value"},ps={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null}},emits:["close"],setup(c,{emit:t}){const e=c,s=t,a=xe(),n=$(1),l=$("employees"),o=$(null),r=$([]),d=$([]),p=$(null),g=$(null);J(()=>n.value>1),J(()=>{var T,R,k,M;switch(n.value){case 1:return((T=o.value)==null?void 0:T.stageName)||e.stageName;case 2:return((R=p.value)==null?void 0:R.employeeName)||"";case 3:return`${((k=p.value)==null?void 0:k.employeeName)||""} ‚Äî ${((M=g.value)==null?void 0:M.dateCategoryLabel)||""}`;default:return""}});function u(){var T,R,k;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employeesCount:((T=e.employees)==null?void 0:T.length)||0,hasSnapshot:!!e.snapshot,snapshotTicketIds:((k=(R=e.snapshot)==null?void 0:R.ticketIds)==null?void 0:k.length)||0,hasTicketDetails:!!e.ticketDetails,snapshotKeys:e.snapshot?Object.keys(e.snapshot):[]}),o.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,g.value=null,n.value=1,l.value="employees",y(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function y(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const T=o.value.snapshot.tickets||[],R=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:T.length,currentStageId:R,sampleTicket:T[0]?{id:T[0].id,stageId:T[0].stageId,hasDepartmentHead:!!T[0].departmentHead,departmentHead:T[0].departmentHead,hasDepartmentHeadFull:!!T[0].departmentHeadFull,departmentHeadFull:T[0].departmentHeadFull,allKeys:Object.keys(T[0])}:null});let k=T.filter(N=>N.stageId?ze(N.stageId)===R:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:T.length,afterFilter:k.length,stageId:R,ticketsWithStageId:k.filter(N=>N.stageId).length,ticketsWithoutStageId:k.filter(N=>!N.stageId).length});const M=k.filter(N=>!N.departmentHead&&!N.departmentHeadFull);if(M.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:M.length,totalTickets:k.length,ticketsWithDepartment:k.filter(V=>V.departmentHead||V.departmentHeadFull).length});const N=M.map(V=>V.id).filter(V=>V);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:N.length,ticketIdsSample:N.slice(0,10)});const V=await Mt.getTicketsDetails(N),se=new Map;V.forEach(C=>{C&&C.id&&se.set(C.id,C)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:V.length,detailsMapSize:se.size,sampleDetail:V[0]?{id:V[0].id,departmentHead:V[0].departmentHead,departmentHeadFull:V[0].departmentHeadFull}:null}),k=k.map(C=>{const H=se.get(C.id);return H?{...C,stageId:H.stageId||C.stageId||null,departmentHead:H.departmentHead||C.departmentHead||null,departmentHeadFull:H.departmentHeadFull||H.departmentHead||C.departmentHead||null}:C}),k=k.filter(C=>C.stageId?ze(C.stageId)===R:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:k.length,ticketsWithDepartment:k.filter(C=>C.departmentHead||C.departmentHeadFull).length,ticketsWithoutDepartment:k.filter(C=>!C.departmentHead&&!C.departmentHeadFull).length,ticketsWithStageId:k.filter(C=>C.stageId).length,ticketsWithoutStageId:k.filter(C=>!C.stageId).length});const ge=k.length,ne=k.slice(0,3).map(C=>({id:C.id,departmentHead:C.departmentHead,departmentHeadFull:C.departmentHeadFull,stageId:C.stageId}));k=k.filter(C=>C.stageId?ze(C.stageId)===R:!0);const me=k.slice(0,3).map(C=>({id:C.id,departmentHead:C.departmentHead,departmentHeadFull:C.departmentHeadFull,stageId:C.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:ge,afterStageFilter:k.length,filteredOut:ge-k.length,currentStageId:R,ticketsWithDepartment:k.filter(C=>C.departmentHead||C.departmentHeadFull).length,ticketsWithoutDepartment:k.filter(C=>!C.departmentHead&&!C.departmentHeadFull).length,sampleBeforeFilter:ne,sampleAfterFilter:me,sampleWithDepartment:k.find(C=>C.departmentHead||C.departmentHeadFull)?{id:k.find(C=>C.departmentHead||C.departmentHeadFull).id,departmentHead:k.find(C=>C.departmentHead||C.departmentHeadFull).departmentHead,departmentHeadFull:k.find(C=>C.departmentHead||C.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(k.find(C=>C.departmentHead||C.departmentHeadFull)).filter(C=>C.toLowerCase().includes("department"))}:null})}catch(V){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",V),console.error("[EmployeeDetailsModal] Error details:",{message:V.message,stack:V.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:k.length,currentStageId:R,ticketsWithStageId:k.filter(N=>N.stageId).length,ticketsWithoutStageId:k.filter(N=>!N.stageId).length,ticketsWithDepartment:k.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:k.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length});const x=_t(k);r.value=x,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:k.length,sampleTickets:k.slice(0,5).map(N=>({id:N.id,departmentHead:N.departmentHead,departmentHeadFull:N.departmentHeadFull,hasDepartmentHead:!!N.departmentHead,hasDepartmentHeadFull:!!N.departmentHeadFull,allKeys:Object.keys(N).filter(V=>V.toLowerCase().includes("department"))})),ticketsWithDepartment:k.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:k.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length});const K=Tt(k);d.value=K;const X=x.reduce((N,V)=>N+V.count,0),te=K.reduce((N,V)=>N+V.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:R,totalTicketsForGrouping:k.length,timeCategoriesCount:x.length,totalTicketsInTimeCategories:X,departmentsCount:K.length,totalTicketsInDepartments:te,departmentsSample:K.slice(0,5),ticketsWithDepartment:k.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:k.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length,consistencyCheck:{totalTickets:k.length,timeCategoriesTotal:X,departmentsTotal:te,isConsistent:k.length===X&&k.length===te}})}catch(T){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",T),console.error("[EmployeeDetailsModal] Error stack:",T.stack)}}function S(T){if(!T||T.count===0){a.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${(T==null?void 0:T.label)||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}a.info(`–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${T.label}" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏`)}He(()=>e.isVisible,T=>{T?u():I()}),Ce(()=>{e.isVisible&&u()});async function h(T,R=null){var k,M,x;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",T),console.log("[EmployeeDetailsModal] Current popup level:",n.value),R&&R.currentTarget&&(R.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{R.currentTarget&&(R.currentTarget.style.transform="")},150)),!T||!T.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",T);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID —Å—Ç–∞–¥–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω"),a.warning("ID —Å—Ç–∞–¥–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: –°–ª–µ–ø–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω"),console.error("[EmployeeDetailsModal] Props snapshot:",e.snapshot),a.warning("–°–ª–µ–ø–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",T.id,"stage:",o.value.stageId);const K=await oa(T.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(K==null?void 0:K.length)||0,K),!K||K.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),a.info(`–£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${T.name}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ —Å—Ç–∞–¥–∏–∏ "${o.value.stageName}"`);return}const X=_t(K);console.log("[EmployeeDetailsModal] Date categories:",(X==null?void 0:X.length)||0,X),p.value={employeeId:T.id,employeeName:T.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:K.length,dateCategories:X,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),n.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",n.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(k=p.value)==null?void 0:k.employeeName,dateCategoriesCount:((x=(M=p.value)==null?void 0:M.dateCategories)==null?void 0:x.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",n.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(K){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",K),console.error("[EmployeeDetailsModal] Error stack:",K.stack),a.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–∫–µ—Ç–∞—Ö: "+K.message)}}function f(T){if(!T||T.count===0){a.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${(T==null?void 0:T.label)||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!T.tickets||T.tickets.length===0){a.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${T.label}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!p.value){console.error("Level 2 data not found");return}const R=Tt(T.tickets);g.value={employeeId:p.value.employeeId,employeeName:p.value.employeeName,stageId:p.value.stageId,stageName:p.value.stageName,dateCategory:T.category,dateCategoryLabel:T.label,totalCount:T.count,departments:R,snapshot:p.value.snapshot,ticketDetails:p.value.ticketDetails},n.value=3}function w(){n.value===3?(n.value=2,g.value=null):n.value===2&&(n.value=1,p.value=null,g.value=null)}function I(){n.value=1,o.value=null,p.value=null,g.value=null}function z(){I(),s("close")}return(T,R)=>(b(),Me(At,{to:"body"},[c.isVisible?(b(),_("div",{key:0,class:"employee-details-modal",onClick:ie(z,["self"]),onKeydown:Ot(z,["esc"])},[i("div",ra,[re(Ge,{name:"level",mode:"out-in"},{default:Be(()=>{var k,M,x,K,X,te,N,V,se,ge,ne,me,C;return[n.value===1?(b(),_("div",ia,[i("div",ca,[i("h3",null,P(((k=o.value)==null?void 0:k.stageName)||c.stageName),1),i("span",da,"–í—Å–µ–≥–æ: "+P(((M=o.value)==null?void 0:M.totalCount)||c.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),i("button",{class:"modal-close",onClick:z,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),i("div",ua,[i("button",{class:ae(["view-switch-btn",{active:l.value==="employees"}]),onClick:R[0]||(R[0]=H=>l.value="employees"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"}," üë• –ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º ",2),i("button",{class:ae(["view-switch-btn",{active:l.value==="time"}]),onClick:R[1]||(R[1]=H=>l.value="time"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º"}," üìÖ –ü–æ –≤—Ä–µ–º–µ–Ω–∏ ",2),i("button",{class:ae(["view-switch-btn",{active:l.value==="departments"}]),onClick:R[2]||(R[2]=H=>l.value="departments"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º"}," üè¢ –ü–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º ",2)]),i("div",pa,[l.value==="employees"?(b(),_("div",ga,[(((x=o.value)==null?void 0:x.employees)||c.employees).length===0&&(!((K=o.value)!=null&&K.others||c.others)||(((X=o.value)==null?void 0:X.others)||c.others).count===0)?(b(),_("div",ma," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö ")):(b(),_("div",fa,[(b(!0),_(ue,null,pe(((te=o.value)==null?void 0:te.employees)||c.employees,H=>(b(),_("div",{key:H.id,class:ae(["employee-item",{"employee-keeper":H.isKeeper}]),onClick:ie(le=>h(H,le),["stop"]),title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º"},[i("span",va,P(H.name),1),i("div",ya,[i("div",{class:"progress-bar",style:we({width:H.progressBarWidth+"%",backgroundColor:H.progressBarColor})},null,4)]),i("span",ka,P(H.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+P(H.percentage)+"%) ",1),R[3]||(R[3]=i("span",{class:"employee-arrow"},"‚Üí",-1))],10,ha))),128)),((N=o.value)!=null&&N.others||c.others)&&(((V=o.value)==null?void 0:V.others)||c.others).count>0?(b(),_("div",wa,[i("span",Sa,"–î—Ä—É–≥–∏–µ ("+P((((se=o.value)==null?void 0:se.others)||c.others).employeeCount)+")",1),i("div",ba,[i("div",{class:"progress-bar",style:we({width:(((ge=o.value)==null?void 0:ge.others)||c.others).progressBarWidth+"%",backgroundColor:(((ne=o.value)==null?void 0:ne.others)||c.others).progressBarColor})},null,4)]),i("span",Da,P((((me=o.value)==null?void 0:me.others)||c.others).count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+P((((C=o.value)==null?void 0:C.others)||c.others).percentage)+"%) ",1)])):Z("",!0)]))])):l.value==="time"?(b(),_("div",Ea,[r.value.length===0?(b(),_("div",_a," –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ")):(b(),_("div",Ta,[(b(!0),_(ue,null,pe(r.value,H=>(b(),_("div",{key:H.category,class:"category-item",onClick:ie(le=>S(H),["stop"])},[i("span",Aa,P(H.label),1),i("div",Ia,[i("div",{class:"progress-bar",style:we({width:H.progressBarWidth+"%",backgroundColor:H.progressBarColor})},null,4)]),i("span",$a,P(H.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+P(H.percentage)+"%) ",1),R[4]||(R[4]=i("span",{class:"category-arrow"},"‚Üí",-1))],8,Ca))),128))]))])):l.value==="departments"?(b(),_("div",Ma,[d.value.length===0?(b(),_("div",Na," –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ")):(b(),_("div",Ra,[i("table",Fa,[R[5]||(R[5]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"–ó–∞–∫–∞–∑—á–∏–∫"),i("th",{class:"col-count"},"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤")])],-1)),i("tbody",null,[(b(!0),_(ue,null,pe(d.value,(H,le)=>(b(),_("tr",{key:le,class:"department-row"},[i("td",Ha,[i("span",Oa,P(H.departmentName),1)]),i("td",Ba,[i("span",xa,P(H.count),1)])]))),128))])])]))])):Z("",!0)])])):n.value===2&&p.value?(b(),_("div",Pa,[i("div",La,[i("button",{class:"btn-back",onClick:w,"aria-label":"–ù–∞–∑–∞–¥"}," ‚Üê "),i("h3",null,P(p.value.employeeName),1),i("span",Wa,"–í—Å–µ–≥–æ: "+P(p.value.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),i("button",{class:"modal-close",onClick:z,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),i("div",Ua,[i("div",ja,[i("span",za,P(p.value.stageName),1)]),p.value.dateCategories.length===0?(b(),_("div",Ka," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–∫–µ—Ç–∞—Ö ")):(b(),_("div",Va,[(b(!0),_(ue,null,pe(p.value.dateCategories,H=>(b(),_("div",{key:H.category,class:"category-item",onClick:ie(le=>f(H),["stop"])},[i("span",Ya,P(H.label),1),i("div",qa,[i("div",{class:"progress-bar",style:we({width:H.progressBarWidth+"%",backgroundColor:H.progressBarColor})},null,4)]),i("span",Ja,P(H.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+P(H.percentage)+"%) ",1)],8,Ga))),128))]))])])):n.value===3&&g.value?(b(),_("div",Xa,[i("div",Za,[i("button",{class:"btn-back",onClick:w,"aria-label":"–ù–∞–∑–∞–¥"}," ‚Üê "),i("div",Qa,[i("h3",null,P(g.value.employeeName),1),i("div",es,[i("span",ts,P(g.value.dateCategoryLabel),1),i("span",as,P(g.value.stageName),1)])]),i("span",ss,"–í—Å–µ–≥–æ: "+P(g.value.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),i("button",{class:"modal-close",onClick:z,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),i("div",ns,[g.value.departments.length===0?(b(),_("div",ls," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑—á–∏–∫–∞—Ö ")):(b(),_("div",os,[i("table",rs,[R[6]||(R[6]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"–ó–∞–∫–∞–∑—á–∏–∫"),i("th",{class:"col-count"},"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤")])],-1)),i("tbody",null,[(b(!0),_(ue,null,pe(g.value.departments,(H,le)=>(b(),_("tr",{key:le,class:"department-row"},[i("td",is,[i("span",cs,P(H.departmentName),1)]),i("td",ds,[i("span",us,P(H.count),1)])]))),128))])])]))])])):Z("",!0)]}),_:1})])],32)):Z("",!0)]))}},gs=Se(ps,[["__scopeId","data-v-a9c16482"]]),Ne=10;function Ke(c,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(a=>a.ticketsByStage&&a.ticketsByStage[c]>0).forEach(a=>{e.push({id:a.id,name:a.name,count:a.ticketsByStage[c]||0})});const s=ms(c,t);return s>0&&e.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:s,isKeeper:!0}),e.sort((a,n)=>n.count-a.count)}function ms(c,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[c])return t.statistics.zeroPointByStage[c].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Nt(c,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[c])==null?void 0:e.count)||0}function Ve(c,t=Ne){if(!c||c.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...c].sort((l,o)=>o.count-l.count),s=e.slice(0,t),a=e.slice(t),n=a.reduce((l,o)=>l+o.count,0);return{visible:s,others:{employees:a,count:n,employeeCount:a.length}}}function Rt(c,t){return!c||c.length===0?[]:t===0?c.map(e=>({...e,percentage:0})):c.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Ft(c,t,e="#007bff",s=Ne){if(!c||c.length===0)return{employees:[],others:null};const{visible:a,others:n}=Ve(c,s),l=Rt(a,t).map(r=>({...r,progressBarWidth:r.percentage,progressBarColor:r.isKeeper?"#f59e0b":e}));let o=null;if(n.count>0){const r=parseFloat((n.count/t*100).toFixed(1));o={...n,percentage:r,progressBarWidth:r,progressBarColor:"#6c757d"}}return{employees:l,others:o}}function fs(c,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(a=>{const n=t[a];if(!n)return;const l=Ke(c,n),o=Nt(c,n);if(l.length===0)return;const{visible:r,others:d}=Ve(l,Ne),p=Rt(r,o);e[a]=p,d.count>0&&(e.others[a]={count:d.count,employeeCount:d.employeeCount,percentage:parseFloat((d.count/o*100).toFixed(1))})}),e}function hs(c,t="current",e=[]){const s=c[t];if(!s)return{labels:[],datasets:[]};const a=new Map;e.forEach(g=>{Ke(g.id,s).forEach(y=>{a.has(y.id)||a.set(y.id,{id:y.id,name:y.name,isKeeper:y.isKeeper||!1,ticketsByStage:{}}),a.get(y.id).ticketsByStage[g.id]=y.count})});const n=Array.from(a.values()).map(g=>{const u=Object.values(g.ticketsByStage).reduce((y,S)=>y+S,0);return{...g,totalTickets:u}});n.sort((g,u)=>u.totalTickets-g.totalTickets);const{visible:l,others:o}=Ve(n,Ne),r=e.map(()=>""),d={};e.forEach(g=>{const u=Ke(g.id,s),{visible:y}=Ve(u,Ne);d[g.id]=y.map(S=>({id:S.id,name:S.name,count:S.count}))});const p=l.map((g,u)=>{const y=e.map(h=>g.ticketsByStage[h.id]||0),S=e.map(h=>{if((g.ticketsByStage[h.id]||0)===0)return"transparent";const I=h.color.replace("#",""),z=parseInt(I.substring(0,2),16),T=parseInt(I.substring(2,4),16),R=parseInt(I.substring(4,6),16),k=.6+u*.05;return`rgba(${z}, ${T}, ${R}, ${Math.min(k,.95)})`});return{label:g.name,data:y,backgroundColor:S,borderColor:e.map(h=>{const f=h.color.replace("#",""),w=parseInt(f.substring(0,2),16),I=parseInt(f.substring(2,4),16),z=parseInt(f.substring(4,6),16);return`rgba(${w}, ${I}, ${z}, 0.8)`}),borderWidth:1,meta:{employeeId:g.id,employeeName:g.name}}});if(o.count>0){const g=e.map(u=>o.employees.reduce((y,S)=>y+(S.ticketsByStage[u.id]||0),0));p.push({label:`–î—Ä—É–≥–∏–µ (${o.employeeCount})`,data:g,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:r,datasets:p,meta:{employeesByStage:d}}}function vs(c,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const s=e.find(d=>d.id===c),a=s?s.name:"",n=s?s.color:"#007bff",l=Ke(c,t),o=Nt(c,t);if(l.length===0)return{stageName:a,totalCount:0,employees:[],others:null};const r=Ft(l,o,n,Ne);return{stageName:a,totalCount:o,employees:r.employees,others:r.others}}function ys(c,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof c!="number"||c<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 0.5"),e=.5);const s=[];if(t.forEach((l,o)=>{if(!l||!l.data||!Array.isArray(l.data))return;const r=l.data[c];r!=null&&!isNaN(r)&&s.push({datasetIndex:o,value:Number(r),y:Number(r)})}),s.length<2)return 0;const a=[];return s.forEach(l=>{let o=!1;for(const r of a){const d=r.y;if(Math.abs(l.y-d)<e){r.points.push(l),r.y=r.points.reduce((g,u)=>g+u.y,0)/r.points.length,o=!0;break}}o||a.push({points:[l],y:l.y})}),a.length===0?0:a.reduce((l,o)=>o.points.length>l.points.length?o:l,a[0]).points.length}function ks(c,t){const e=[];return c.forEach(s=>{let a=!1;for(const n of e){const l=n.y;if(Math.abs(s.value-l)<t){n.points.push(s),n.y=n.points.reduce((o,r)=>o+r.value,0)/n.points.length,a=!0;break}}a||e.push({points:[s],y:s.value})}),e}function ws(c,t=.5){var n,l;if(!c)return console.warn("findOverlappingPoints: chart –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω"),[];if(!c.config||c.config.type!=="line")return[];const e=(n=c.data)==null?void 0:n.datasets,s=((l=c.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(s)||s.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 0.5"),t=.5);const a=[];return s.forEach((o,r)=>{try{if(ys(r,e,t)<2)return;const p=[];if(e.forEach((h,f)=>{if(!h||!h.data||!Array.isArray(h.data))return;const w=h.data[r];w==null||isNaN(w)||p.push({datasetIndex:f,value:Number(w),label:h.label||`Dataset ${f}`})}),p.length<2)return;const g=ks(p,t);if(g.length===0)return;const u=g.reduce((h,f)=>f.points.length>h.points.length?f:h,g[0]);if(u.points.length<2)return;let y=null,S=null;for(let h=0;h<e.length;h++)try{const f=c.getDatasetMeta(h);if(f&&f.data&&f.data[r]){y=f,S=f.data[r];break}}catch{continue}if(!S||typeof S.x!="number"||typeof S.y!="number")return;a.push({position:r,count:u.points.length,x:S.x,y:S.y,value:u.y,points:u.points.map(h=>({datasetIndex:h.datasetIndex,value:h.value,label:h.label}))})}catch(d){console.warn(`findOverlappingPoints: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–∑–∏—Ü–∏–∏ ${r}:`,d)}}),a}const Ss=.5,Ct=6,bs=2;function Ds(c){return typeof c!="number"||c<2?Ct:Ct+(c-1)*bs}function Es(c,t){if(!c||!c.ctx){console.warn("drawEnlargedPoint: chart –∏–ª–∏ ctx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const s=c.ctx,{x:a,y:n,points:l}=t,o=Ds(e);if(s.canvas){s.save();try{s.beginPath(),s.arc(a,n,o,0,2*Math.PI);let d="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&c.data&&c.data.datasets){const p=l[0].datasetIndex,g=c.data.datasets[p];if(g&&g.pointBackgroundColor){const u=Array.isArray(g.pointBackgroundColor)?g.pointBackgroundColor[t.position]||g.pointBackgroundColor[0]:g.pointBackgroundColor;if(u)if(u.startsWith("#")){const y=parseInt(u.slice(1,3),16),S=parseInt(u.slice(3,5),16),h=parseInt(u.slice(5,7),16);d=`rgba(${y}, ${S}, ${h}, 0.4)`}else u.startsWith("rgba")?d=u.replace(/rgba?\(([^)]+)\)/,(y,S)=>{const h=S.split(",").map(f=>f.trim());return`rgba(${h[0]}, ${h[1]}, ${h[2]}, 0.4)`}):d=u+"66"}}s.fillStyle=d,s.fill(),s.strokeStyle=d.replace("0.4","0.6").replace("66","99"),s.lineWidth=1,s.stroke()}catch(d){console.warn("drawEnlargedPoint: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏:",d)}finally{s.restore()}}}const _s={id:"overlappingPointsPlugin",afterDatasetsDraw:c=>{if(!(!c||!c.config||c.config.type!=="line")&&c.ctx)try{const t=ws(c,Ss);if(!Array.isArray(t)||t.length===0)return;t.filter(s=>!(!s||typeof s!="object"||typeof s.count!="number"||s.count<2||typeof s.x!="number"||typeof s.y!="number"||!isFinite(s.x)||!isFinite(s.y))).forEach(s=>{try{Es(c,s)}catch(a){console.warn(`overlappingPointsPlugin: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ ${s.position}:`,a)}})}catch(t){console.warn("overlappingPointsPlugin: –æ—à–∏–±–∫–∞ –≤ afterDatasetsDraw:",t)}}},Ts={class:"graph-state-chart"},Cs={class:"chart-header"},As={class:"chart-type-selector"},Is=["onClick","title"],$s={class:"chart-type-icon"},Ms={class:"chart-type-label"},Ns={key:0,class:"comparison-type-selector"},Rs={class:"radio-group"},Fs={key:0},Hs={key:1},Os={key:2,class:"graph-legend"},Bs={key:4,class:"error-container"},xs={class:"error-message"},Ps={key:5,class:"chart-container"},Ls={class:"chart-wrapper"},Ws={class:"chart-canvas-container"},Us={key:0,class:"bar-chart-stage-labels"},js={key:6,class:"no-data"},zs={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(c,{emit:t}){const e=(D,m)=>typeof window>"u"?m:getComputedStyle(document.documentElement).getPropertyValue(D).trim()||m,s=c,a=t,n=$(!1),l=$(null),o=$(null),r=$({weekStart:null,weekEnd:null,current:null}),d=$(null),p=$("weekStartToWeekEnd"),g=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],u=$("line"),y=$(!1),S=$(""),h=$(""),f=$(0),w=$([]),I=$(null),z=$(null),T=$(null),R=$([]),k=J(()=>{switch(u.value){case"line":return wt;case"bar":return Kt;case"doughnut":return zt;default:return wt}}),M={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},x=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:M.formed},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:M.review},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:M.execution}],K=["circle","triangle","rect","rectRot","star","cross","crossRot"],X=$({formed:!0,review:!0,execution:!0}),te=xe(),N={id:"employeeLabelsPlugin",afterDatasetsDraw:D=>{if(D.config.type==="bar")try{const m=D.ctx;if(!D.data||!D.data.datasets)return;const v=D.data.datasets,E=D.scales.y;v.forEach((A,O)=>{const F=D.getDatasetMeta(O);if(!F||F.hidden)return;const j=A.label||"";if(!j||j.includes("–î—Ä—É–≥–∏–µ"))return;const U=j.trim().split(/\s+/);let L="";if(U.length===1)L=U[0];else{const W=U[0],q=U.slice(1).join(" ");L=`${W}
${q}`}const Y=L.split(`
`);A.data.forEach((W,q)=>{if(W===0||!W)return;const Q=F.data[q];if(!Q||typeof Q.x!="number"||typeof Q.y!="number")return;const de=Q.x,De=Q.y+Q.height+25;m.save(),m.font="bold 9px Arial, sans-serif",m.fillStyle="#6b7280",m.textAlign="center",m.textBaseline="top",m.translate(de,De),m.rotate(-12*Math.PI/180),Y.forEach((he,Ee)=>{const _e=he.trim();_e&&m.fillText(_e,0,Ee*11)}),m.restore()})})}catch(m){console.error("Error in employeeLabelsPlugin:",m)}}};kt.register(N);function V(){const D=new Map;[r.value.weekStart,r.value.weekEnd,r.value.current].forEach(m=>{!m||!m.statistics||!m.statistics.employees||m.statistics.employees.forEach(v=>{D.has(v.id)||D.set(v.id,{id:v.id,name:v.name})})}),R.value=Array.from(D.values()).sort((m,v)=>m.name.localeCompare(v.name))}function se(D,m="background"){var E;return((E={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[D])==null?void 0:E[m])||e("--b24-text-secondary","#6c757d")}function ge(){if(!(!r.value.weekStart||!r.value.weekEnd))try{const D=st.compareTwoSnapshots(r.value.weekStart,r.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let m=null,v=null;r.value.current&&(m=st.compareTwoSnapshots(r.value.weekEnd,r.value.current,{includeTickets:!1,includeEmployees:!0}),v=st.compareTwoSnapshots(r.value.weekStart,r.value.current,{includeTickets:!1,includeEmployees:!0})),d.value={weekStartToWeekEnd:D,weekEndToCurrent:m,weekStartToCurrent:v}}catch(D){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",D),te.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+D.message)}}function ne(D){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[D]||"formed"}function me(D){return ne(D)}function C(D){return D===0?"weekStart":D===1?"weekEnd":D===2?"current":"weekEnd"}function H(D){return r.value[D]||null}function le(D,m,v,E,A=null,O=null,F=null){var j;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:D,stageId:m,totalCount:v,employeesCount:(E==null?void 0:E.length)||0,hasSnapshot:!!O,snapshotTicketIds:((j=O==null?void 0:O.ticketIds)==null?void 0:j.length)||0}),S.value=D,h.value=m||"",f.value=v,w.value=E||[],I.value=A&&A.count>0?A:null,z.value=O,T.value=F,y.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:h.value,hasCurrentSnapshot:!!z.value})}function Pe(D,m,v){var j,U,L,Y,W,q;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:D,timePoint:m,employeeDataCount:v==null?void 0:v.length});const E=x.find(Q=>Q.id===D);if(!E){console.warn("[GraphStateChart] Stage not found:",D);return}const A=H(m);if(console.log("[GraphStateChart] Snapshot for timePoint:",m,A?"found":"not found"),!A){console.warn("[GraphStateChart] Snapshot not found for timePoint:",m),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!r.value.weekStart,weekEnd:!!r.value.weekEnd,current:!!r.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!A.tickets,ticketsIsArray:Array.isArray(A.tickets),ticketsLength:((j=A.tickets)==null?void 0:j.length)||0,hasTicketIds:!!A.ticketIds,ticketIdsLength:((U=A.ticketIds)==null?void 0:U.length)||0,hasMetadata:!!A.metadata,hasStatistics:!!A.statistics,snapshotKeys:Object.keys(A),snapshotType:typeof A}),!A.tickets||!Array.isArray(A.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",A),te.warning("–°–ª–µ–ø–æ–∫ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–∫–µ—Ç–∞—Ö");return}const O=((W=(Y=(L=A.statistics)==null?void 0:L.stages)==null?void 0:Y[D])==null?void 0:W.count)||0;console.log("[GraphStateChart] Total count for stage:",O);const F=Ft(v,O,E.color,10);console.log("[GraphStateChart] Opening modal with:",{stageName:E.name,stageId:D,totalCount:O,employeesCount:((q=F.employees)==null?void 0:q.length)||0,hasSnapshot:!!A,snapshotHasTickets:!!A.tickets}),le(E.name,D,O,F.employees,F.others,A,null)}function qe(D,m){if(!m||!m.employees||m.employees.length===0){te.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞");return}const v=r.value.current||r.value.weekEnd||r.value.weekStart;le(m.stageName,D,m.totalCount,m.employees,m.others,v,null)}function B(){y.value=!1,S.value="",h.value="",f.value=0,w.value=[],I.value=null,z.value=null,T.value=null}function G(D,m,v){var Y,W;if(u.value!=="line"||m.length===0)return;const E=m[0],A=E.datasetIndex,O=E.index,F=v.data.datasets[A];if(!F||!F.meta)return;const j=me(F.label),U=C(O),L=(W=(Y=F.meta)==null?void 0:Y.employees)==null?void 0:W[U];!L||L.length===0||Pe(j,U,L)}function fe(D,m,v){var Y,W;if(u.value!=="doughnut"||m.length===0)return;const A=m[0].index,O=v.data,F=O.labels[A],j=me(F),U=(W=(Y=O.datasets[0])==null?void 0:Y.meta)==null?void 0:W.employees,L=U==null?void 0:U[j];if(!L){console.warn("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–∞–ø–∞:",j);return}qe(j,L)}function Le(D){var E;const m=x[D];if(!m)return 0;const v=r.value.current||r.value.weekEnd||r.value.weekStart;return!v||!v.statistics||!v.statistics.stages?0:((E=v.statistics.stages[m.id])==null?void 0:E.count)||0}function ce(D){var A;const m=x.find(O=>O.id===D);if(!m)return"";const v=r.value.current||r.value.weekEnd||r.value.weekStart;if(!v||!v.statistics||!v.statistics.stages)return m.name;const E=((A=v.statistics.stages[D])==null?void 0:A.count)||0;return`${m.name} (${E})`}const Re=J(()=>{if(!o.value)return null;if(u.value==="doughnut"||u.value==="bar")return o.value;const D=o.value.datasets.filter(m=>{const v=x.find(E=>E.name===m.label);return v?X.value[v.id]:!0});return{...o.value,datasets:D}});J(()=>u.value!=="bar"||!o.value||!o.value.meta?null:o.value.meta.employeesByStage||null);const Je=J(()=>{const D={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:u.value==="bar"?{bottom:80}:{}},onClick:(m,v,E)=>{u.value==="line"?G(m,v,E):u.value==="doughnut"&&fe(m,v,E)},onHover:(m,v,E)=>{u.value==="doughnut"&&(m.native.target.style.cursor=v.length>0?"pointer":"default")},plugins:{legend:{display:u.value!=="bar",position:u.value==="doughnut"?"right":"top",onClick:(m,v,E)=>{if(u.value==="bar"){const O=v.datasetIndex;if(O!==void 0){const F=E.chart.getDatasetMeta(O);F.hidden=!F.hidden,E.chart.update()}return}const A=v.datasetIndex;if(A!==void 0){const O=E.chart.getDatasetMeta(A);O.hidden=!O.hidden,E.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:m=>{if(u.value==="bar"){const v=m[0].dataIndex,E=x[v];return E?E.name:""}return m[0].label||""},label:m=>{var O,F,j,U,L,Y;const v=m.dataset.label||"",E=m.parsed.y||m.parsed||0,A=m.dataIndex;if(u.value==="bar"){const W=m.dataset,q=m.dataIndex,Q=x[q],de=Q?Q.name:"";return`${W.label}: ${E} —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ "${de}"`}if(u.value==="doughnut"){const W=m.dataset.data.reduce((Q,de)=>Q+de,0),q=W>0?(E/W*100).toFixed(1):0;return`${v}: ${E} —Ç–∏–∫–µ—Ç–æ–≤ (${q}%)`}else{if(!d.value||A===0)return`${v}: ${E} —Ç–∏–∫–µ—Ç–æ–≤`;let W=null;const q=ne(v);if(p.value==="weekStartToWeekEnd"&&A===1?W=(F=(O=d.value.weekStartToWeekEnd)==null?void 0:O.stages)==null?void 0:F[q]:p.value==="weekEndToCurrent"&&A===2&&r.value.current?W=(U=(j=d.value.weekEndToCurrent)==null?void 0:j.stages)==null?void 0:U[q]:p.value==="weekStartToCurrent"&&A===2&&r.value.current&&(W=(Y=(L=d.value.weekStartToCurrent)==null?void 0:L.stages)==null?void 0:Y[q]),!W)return`${v}: ${E} —Ç–∏–∫–µ—Ç–æ–≤`;const Q=W.delta,de=W.deltaPercent,De=W.trend;let he=`${v}: ${E} —Ç–∏–∫–µ—Ç–æ–≤`;if(Q!==0){const Ee=Q>0?"+":"",_e=De==="increase"?"‚Üë":De==="decrease"?"‚Üì":"‚Üí";he+=` (${Ee}${Q}, ${Ee}${de.toFixed(1)}%) ${_e}`}else he+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return he}},afterBody:m=>{if(u.value==="bar"&&m.length>0){const O=m[0];O.dataset;const F=O.parsed.y||0,j=O.dataIndex,U=Le(j);return[`${U>0?(F/U*100).toFixed(1):0}% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç—Ç–∞–ø–∞`]}if(u.value==="doughnut"&&m.length>0)return["–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"];if(u.value==="line"){const O=[];if(d.value){const F=m[0].dataIndex;if(F!==0){let j=null;if(ne(m[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&F===1?j=d.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&F===2?j=d.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&F===2&&(j=d.value.weekStartToCurrent),j&&j.metadata){const U=j.metadata.timeDiff;O.push(`–ü–µ—Ä–∏–æ–¥: ${U.days} –¥–Ω. ${U.hours} —á. ${U.minutes} –º–∏–Ω.`)}}}return O.push("–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"),O}if(!d.value)return[];const v=m[0].dataIndex;if(v===0)return[];let E=null;if(ne(m[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&v===1?E=d.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&v===2?E=d.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&v===2&&(E=d.value.weekStartToCurrent),!E||!E.metadata)return[];const A=E.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${A.days} –¥–Ω. ${A.hours} —á. ${A.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return u.value==="line"||u.value==="bar"?{...D,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:u.value==="doughnut"?{...D,cutout:"60%"}:D});function Ae(D){const m=new Date(D),v=m.getFullYear(),E=String(m.getMonth()+1).padStart(2,"0"),A=String(m.getDate()).padStart(2,"0");return`${v}-${E}-${A}`}function Xe(D){const{current:m,weekEnd:v}=D,E=m||v;if(!E||!E.statistics||!E.statistics.stages)return null;const A=[],O=[],F=[],j=[],U={};return x.forEach(L=>{var W;const Y=((W=E.statistics.stages[L.id])==null?void 0:W.count)||0;if(Y>0){A.push(L.name),O.push(Y),F.push(L.color+"80"),j.push(L.color);const q=vs(L.id,E,x);q&&q.employees&&(U[L.id]=q)}}),O.length===0?null:{labels:A,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:O,backgroundColor:F,borderColor:j,borderWidth:2,meta:{employees:U}}]}}function Ze(D){if(u.value==="doughnut")return Xe(D);if(u.value==="bar"){const F=s.showCurrentState&&D.current?"current":D.weekEnd?"weekEnd":"weekStart";return hs(D,F,x)}const{weekStart:m,weekEnd:v,current:E}=D,A=[],O=[];return x.forEach((F,j)=>{var de,De,he,Ee,_e,rt,it,ct,dt,ut,pt,gt,mt,ft,ht,vt,yt;const U=[];if(m&&m.statistics&&m.statistics.stages){const ee=m.statistics.stages[F.id];if(A.length===0){const Fe=(de=m.metadata)!=null&&de.createdAt?new Date(m.metadata.createdAt):null;A.push(Fe?Ae(Fe):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}U.push((ee==null?void 0:ee.count)||0)}else A.length===0&&A.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),U.push(0);if(v&&v.statistics&&v.statistics.stages){const ee=v.statistics.stages[F.id];if(A.length===1){const Fe=(De=v.metadata)!=null&&De.createdAt?new Date(v.metadata.createdAt):null;A.push(Fe?Ae(Fe):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}U.push((ee==null?void 0:ee.count)||0)}else A.length===1&&A.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),U.push(0);if(E&&s.showCurrentState&&E.statistics&&E.statistics.stages){const ee=E.statistics.stages[F.id];A.length===2&&A.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),U.push((ee==null?void 0:ee.count)||0)}const L=["stable"];d.value?p.value==="weekStartToWeekEnd"?(L.push(((_e=(Ee=(he=d.value.weekStartToWeekEnd)==null?void 0:he.stages)==null?void 0:Ee[F.id])==null?void 0:_e.trend)||"stable"),E&&L.push(((ct=(it=(rt=d.value.weekStartToCurrent)==null?void 0:rt.stages)==null?void 0:it[F.id])==null?void 0:ct.trend)||"stable")):p.value==="weekEndToCurrent"&&E?(L.push("stable"),L.push(((pt=(ut=(dt=d.value.weekEndToCurrent)==null?void 0:dt.stages)==null?void 0:ut[F.id])==null?void 0:pt.trend)||"stable")):p.value==="weekStartToCurrent"&&E?(L.push(((ft=(mt=(gt=d.value.weekStartToWeekEnd)==null?void 0:gt.stages)==null?void 0:mt[F.id])==null?void 0:ft.trend)||"stable"),L.push(((yt=(vt=(ht=d.value.weekStartToCurrent)==null?void 0:ht.stages)==null?void 0:vt[F.id])==null?void 0:yt.trend)||"stable")):(L.push("stable"),E&&L.push("stable")):(L.push("stable"),E&&L.push("stable"));let Y,W,q;d.value&&u.value!=="doughnut"?(Y=L.map(ee=>se(ee,"background")+"40"),W=L.map(ee=>se(ee,"border")),q=L.map(ee=>se(ee,"point"))):(Y=F.color+"40",W=F.color,q=F.color);let Q=null;u.value==="line"&&(Q={employees:fs(F.id,D)}),O.push({label:F.name,data:U,backgroundColor:(Array.isArray(Y),Y),borderColor:(Array.isArray(W),W),borderWidth:2,...u.value==="line"&&{pointStyle:K[j%K.length]},pointBackgroundColor:(Array.isArray(q),q),pointBorderColor:(Array.isArray(W),W),pointRadius:6,pointHoverRadius:8,fill:u.value!=="line",tension:u.value==="line"?.4:0,meta:Q})}),A.length===0&&(A.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),s.showCurrentState&&A.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:A,datasets:O}}const Qe=async()=>{var D,m,v;n.value=!0,l.value=null;try{const E=(D=s.period)!=null&&D.endDate?new Date(s.period.endDate):new Date,A=(m=s.period)!=null&&m.startDate?new Date(s.period.startDate):ke.getWeekStartDate(E),O=(v=s.period)!=null&&v.endDate?new Date(s.period.endDate):ke.getWeekEndDate(E),F=ke.formatDate(A),j=ke.formatDate(O),[U,L]=await Promise.all([ke.getSnapshot(F,"week_start"),ke.getSnapshot(j,"week_end")]);let Y=null;s.showCurrentState&&(Y=await ot.getSectorDataForSnapshot({useCache:!1,normalize:!0})),r.value={weekStart:U,weekEnd:L,current:Y},V(),ge(),be(),a("data-loaded",{weekStart:U,weekEnd:L,current:Y})}catch(E){console.error("Error loading chart data:",E),l.value=E.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",te.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+l.value),a("error",l.value)}finally{n.value=!1}};Ce(()=>{kt.register(_s),Qe()});function Ht(D){X.value=D}const be=()=>{var m;const D=Ze({weekStart:r.value.weekStart,weekEnd:r.value.weekEnd,current:r.value.current});if(!o.value||!o.value.labels||o.value.labels.length!==((m=D==null?void 0:D.labels)==null?void 0:m.length))o.value=D;else if(D){const v=JSON.stringify(o.value),E=JSON.stringify(D);v!==E&&(o.value=D)}};return He(()=>[s.period,s.showCurrentState],()=>{Qe()},{deep:!0}),He(u,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&be()}),He(p,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&be()}),(D,m)=>(b(),_("div",Ts,[i("div",Cs,[m[3]||(m[3]=i("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),i("div",As,[(b(),_(ue,null,pe(g,v=>i("button",{key:v.value,onClick:E=>u.value=v.value,class:ae(["chart-type-btn",{active:u.value===v.value}]),title:v.label},[i("span",$s,P(v.icon),1),i("span",Ms,P(v.label),1)],10,Is)),64))])]),!n.value&&!l.value&&d.value&&u.value!=="doughnut"?(b(),_("div",Ns,[m[7]||(m[7]=i("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),i("div",Rs,[i("label",null,[Ue(i("input",{type:"radio","onUpdate:modelValue":m[0]||(m[0]=v=>p.value=v),value:"weekStartToWeekEnd",onChange:be},null,544),[[et,p.value]]),m[4]||(m[4]=i("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),r.value.current?(b(),_("label",Fs,[Ue(i("input",{type:"radio","onUpdate:modelValue":m[1]||(m[1]=v=>p.value=v),value:"weekEndToCurrent",onChange:be},null,544),[[et,p.value]]),m[5]||(m[5]=i("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):Z("",!0),r.value.current?(b(),_("label",Hs,[Ue(i("input",{type:"radio","onUpdate:modelValue":m[2]||(m[2]=v=>p.value=v),value:"weekStartToCurrent",onChange:be},null,544),[[et,p.value]]),m[6]||(m[6]=i("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):Z("",!0)])])):Z("",!0),!n.value&&!l.value&&o.value?(b(),Me(la,{key:1,stages:x,selected:X.value,"onUpdate:selected":Ht,onChange:be},null,8,["selected"])):Z("",!0),!n.value&&!l.value&&d.value&&u.value!=="doughnut"?(b(),_("div",Os,[...m[8]||(m[8]=[Bt('<h4 class="legend-title" data-v-8956dc9f>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-8956dc9f><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-increase" data-v-8956dc9f></span><span data-v-8956dc9f>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-decrease" data-v-8956dc9f></span><span data-v-8956dc9f>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-stable" data-v-8956dc9f></span><span data-v-8956dc9f>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):Z("",!0),n.value?(b(),Me(It,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):l.value?(b(),_("div",Bs,[i("p",xs,"‚ùå "+P(l.value),1),i("button",{onClick:Qe,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):Re.value?(b(),_("div",Ps,[i("div",Ls,[i("div",Ws,[(b(),Me(xt(k.value),{data:Re.value,options:Je.value},null,8,["data","options"]))]),u.value==="bar"?(b(),_("div",Us,[(b(),_(ue,null,pe(x,v=>i("div",{key:v.id,class:"stage-label-item"},P(ce(v.id)),1)),64))])):Z("",!0)])])):(b(),_("div",js,[...m[9]||(m[9]=[i("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),i("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),re(gs,{"is-visible":y.value,"stage-name":S.value,"stage-id":h.value,"total-count":f.value,employees:w.value,others:I.value,snapshot:z.value,"ticket-details":T.value,onClose:B},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details"])]))}},Ks=Se(zs,[["__scopeId","data-v-8956dc9f"]]),Vs={key:0,class:"create-snapshot-button-container"},Gs=["disabled"],Ys={class:"modal-content"},qs={class:"modal-header"},Js=["disabled"],Xs={class:"modal-body"},Zs={key:0,class:"progress-container"},Qs={class:"progress-bar-wrapper"},en={class:"progress-text"},tn={class:"progress-percent"},an={class:"progress-description"},sn={key:1},nn={class:"modal-footer"},ln=["disabled"],on=["disabled"],rn={key:0},cn={key:0},dn={key:1},un={key:2},pn={key:1},gn={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(c,{emit:t}){const e=c,s=t,a=$(e.user),n=$(!1),l=$(!1),o=$(0),r=$("idle"),d=$(""),p=xe(),g=J(()=>a.value?Pt(a.value):!1);Ce(async()=>{if(!e.user)try{const f=await $t.checkAccess();f.allowed&&(a.value=f.user)}catch(f){console.error("Error loading user:",f)}});const u=()=>{if(!g.value){p.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}n.value=!0},y=()=>{l.value||(n.value=!1,r.value="idle",o.value=0,d.value="")},S=async()=>{if(!l.value){if(!g.value){p.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}l.value=!0,r.value="loading_data",o.value=0,d.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{d.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const f=await ot.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:z=>{var R;const T=Math.min(80,(z.progress||0)*.8);o.value=T,r.value="loading_data",d.value=z.description||((R=z.details)==null?void 0:R.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});r.value="creating_snapshot",o.value=85,d.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const w=a.value;if(!w)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const I=await ke.createSnapshot(f,"manual",{createdBy:{id:w.ID,name:`${w.NAME||""} ${w.LAST_NAME||""}`.trim()||w.EMAIL||`User ${w.ID}`},sectorId:"1C"});r.value="success",o.value=100,d.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",p.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),s("snapshot-created",I),setTimeout(()=>{y()},1500)}catch(f){r.value="error",o.value=0,d.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",f);let w="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";f.message&&(f.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||f.message.includes("sector data")?w="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":f.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||f.message.includes("snapshot")?w="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":f.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||f.message.includes("validation")?w="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":w=f.message),p.error(w)}finally{l.value=!1}}},h=f=>{f.key==="Escape"&&n.value&&!l.value&&y()};return Ce(()=>{window.addEventListener("keydown",h)}),Ye(()=>{window.removeEventListener("keydown",h)}),(f,w)=>g.value?(b(),_("div",Vs,[i("button",{class:"create-snapshot-btn",onClick:u,disabled:l.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...w[1]||(w[1]=[i("span",{class:"btn-icon"},"üì∏",-1),i("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,Gs),(b(),Me(At,{to:"body"},[re(Ge,{name:"modal"},{default:Be(()=>[n.value?(b(),_("div",{key:0,class:"modal-overlay",onClick:w[0]||(w[0]=ie(I=>!l.value&&y(),["self"]))},[i("div",Ys,[i("div",qs,[w[2]||(w[2]=i("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),i("button",{class:"modal-close",onClick:y,disabled:l.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,Js)]),i("div",Xs,[r.value!=="idle"?(b(),_("div",Zs,[i("div",Qs,[i("div",{class:"progress-bar",style:we({width:`${o.value}%`})},null,4)]),i("div",en,[i("span",tn,P(Math.round(o.value))+"%",1),i("span",an,P(d.value),1)])])):(b(),_("div",sn,[...w[3]||(w[3]=[i("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),i("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),i("div",nn,[i("button",{class:"btn btn-secondary",onClick:y,disabled:l.value}," –û—Ç–º–µ–Ω–∞ ",8,ln),i("button",{class:"btn btn-primary",onClick:S,disabled:l.value},[l.value?(b(),_("span",rn,[r.value==="loading_data"?(b(),_("span",cn,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):r.value==="creating_snapshot"?(b(),_("span",dn,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(b(),_("span",un,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(b(),_("span",pn,"–°–æ–∑–¥–∞—Ç—å"))],8,on)])])])):Z("",!0)]),_:1})]))])):Z("",!0)}},mn=Se(gn,[["__scopeId","data-v-09bccee2"]]),fn=20,hn=5*60*1e3;async function vn({search:c="",limit:t=fn,sectorDepartmentId:e=Et.SECTOR_1C}={}){const s=`sector1c_employees_${c}_${t}_${e||"all"}`,a=sessionStorage.getItem(s);if(a)try{const{data:n,timestamp:l}=JSON.parse(a);if(Date.now()-l<hn)return n}catch(n){console.warn("[sector1cEmployees] Cache parse error:",n)}try{const n={ACTIVE:"Y"};e?Array.isArray(e)?n.UF_DEPARTMENT=e:n.UF_DEPARTMENT=[e]:n.UF_DEPARTMENT=[Et.SECTOR_1C],c&&c.length>=2&&(n["%NAME"]=c,n["%LAST_NAME"]=c,n["%WORK_POSITION"]=c);const r=((await lt.call("user.get",{filter:n,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(d=>({id:parseInt(d.ID),name:yn(d),position:d.WORK_POSITION||"",department:d.UF_DEPARTMENT||null}));try{sessionStorage.setItem(s,JSON.stringify({data:r,timestamp:Date.now()}))}catch(d){console.warn("[sector1cEmployees] Cache write error:",d)}return r}catch(n){throw console.error("[sector1cEmployees] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",n),new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${n.message}`)}}function yn(c){const t=[c.LAST_NAME,c.NAME,c.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):c.NAME||"–ë–µ–∑ –∏–º–µ–Ω–∏"}const kn={class:"employee-select-field-text"},wn={key:0,class:"employee-select-dropdown"},Sn={class:"employee-select-dropdown-search"},bn={key:0,class:"employee-select-state"},Dn={key:1,class:"employee-select-state employee-select-state--error"},En={key:2,class:"employee-select-state"},_n=["checked"],Tn=["checked","onChange"],Cn={class:"employee-select-item-content"},An={class:"employee-select-item-name"},In={key:0,class:"employee-select-item-position"},$n={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(c,{emit:t}){const e=c,s=t,a=$(null),n=$(null),l=$(""),o=$([]),r=$(!1),d=$(null),p=$(!1),g=J(()=>{if(!l.value)return o.value;const k=l.value.toLowerCase();return o.value.filter(M=>M.name.toLowerCase().includes(k)||M.position&&M.position.toLowerCase().includes(k))}),u=J(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const k=o.value.find(M=>M.id===e.selected[0]);return k?k.name:e.placeholder}return`–í—ã–±—Ä–∞–Ω–æ: ${e.selected.length} ${T(e.selected.length,"—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")}`});async function y(k=""){r.value=!0,d.value=null;try{o.value=await vn({search:k})}catch(M){d.value=M,s("error",M)}finally{r.value=!1}}function S(){s("search",l.value)}function h(){r.value||(p.value=!p.value,p.value?(o.value.length===0&&y(),Wt(()=>{n.value&&n.value.focus()})):l.value="")}function f(k){a.value&&!a.value.contains(k.target)&&(p.value=!1,l.value="")}function w(k){const M=[...e.selected],x=M.indexOf(k);if(k==="all")if(x>-1)M.splice(x,1);else return s("update:selected",["all"]);else if(x>-1)M.splice(x,1);else{const K=M.indexOf("all");K>-1&&M.splice(K,1),M.push(k)}s("update:selected",M)}function I(k){return k==="all"?e.selected.includes("all"):e.selected.includes(k)||e.selected.includes("all")}const z=J(()=>l.value?`–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${l.value}"`:"–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°");function T(k,M,x,K){const X=k%10,te=k%100;return te>=11&&te<=19?K:X===1?M:X>=2&&X<=4?x:K}function R(){y(l.value)}return He(()=>e.selected,k=>{(!k||k.length===0)&&s("update:selected",["all"])},{immediate:!0}),Ce(()=>{document.addEventListener("click",f),(!e.selected||e.selected.length===0)&&s("update:selected",["all"])}),Ye(()=>{document.removeEventListener("click",f)}),(k,M)=>(b(),_("div",{class:"employee-select",ref_key:"selectContainer",ref:a},[i("div",{class:ae(["employee-select-field",{"employee-select-field--open":p.value,"employee-select-field--disabled":r.value}]),onClick:h},[i("span",kn,P(u.value),1),i("span",{class:ae(["employee-select-field-icon",{open:p.value}])},"‚ñº",2)],2),re(Ge,{name:"dropdown-fade"},{default:Be(()=>[p.value?(b(),_("div",wn,[i("div",Sn,[Ue(i("input",{"onUpdate:modelValue":M[0]||(M[0]=x=>l.value=x),type:"text",placeholder:"üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...",class:"employee-select-search-input",onInput:S,onClick:M[1]||(M[1]=ie(()=>{},["stop"])),ref_key:"searchInput",ref:n},null,544),[[Lt,l.value]])]),r.value?(b(),_("div",bn,[...M[6]||(M[6]=[i("span",{class:"spinner"},"‚è≥",-1),i("span",null,"–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°...",-1)])])):d.value?(b(),_("div",Dn,[i("span",null,"‚ùå "+P(d.value.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"),1),i("button",{onClick:[R,M[2]||(M[2]=ie(()=>{},["stop"]))],class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å")])):!r.value&&g.value.length===0&&!d.value?(b(),_("div",En,[i("span",null,"üì≠ "+P(z.value),1)])):(b(),_("div",{key:3,class:"employee-select-list",style:we({maxHeight:`${c.maxHeight}px`})},[i("label",{class:ae(["employee-select-item",{"employee-select-item--selected":I("all")}]),onClick:M[4]||(M[4]=ie(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:I("all"),onChange:M[3]||(M[3]=x=>w("all"))},null,40,_n),M[7]||(M[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏")],-1))],2),(b(!0),_(ue,null,pe(g.value,x=>(b(),_("label",{key:x.id,class:ae(["employee-select-item",{"employee-select-item--selected":I(x.id)}]),onClick:M[5]||(M[5]=ie(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:I(x.id),onChange:K=>w(x.id)},null,40,Tn),i("div",Cn,[i("span",An,P(x.name),1),x.position?(b(),_("span",In,P(x.position),1)):Z("",!0)])],2))),128))],4))])):Z("",!0)]),_:1})],512))}},Mn=Se($n,[["__scopeId","data-v-6b8c949b"]]),Nn={class:"stage-select-field-text"},Rn={key:0,class:"stage-select-dropdown"},Fn={class:"stage-select-list"},Hn=["checked"],On=["checked","onChange"],Bn={class:"stage-select-item-content"},xn={class:"stage-select-item-name"},Pn={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745"}]},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã"}},emits:["update:selected","change"],setup(c,{emit:t}){const e=c,s=t,a=$(null),n=$(!1),l=J(()=>Object.values(e.selected).every(u=>u===!0)),o=J(()=>{if(l.value)return e.placeholder;const u=e.stages.filter(y=>e.selected[y.id]);return u.length===0?"–≠—Ç–∞–ø—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã":u.length===1?u[0].name:`–í—ã–±—Ä–∞–Ω–æ: ${u.length} —ç—Ç–∞–ø–∞(–æ–≤)`});function r(){n.value=!n.value,n.value}function d(u){a.value&&!a.value.contains(u.target)&&(n.value=!1)}function p(u,y){const S={...e.selected};S[u]=y,s("update:selected",S),s("change",u,y)}function g(){const u=l.value,y={};e.stages.forEach(S=>{y[S.id]=!u}),s("update:selected",y),s("change","all",!u)}return Ce(()=>{document.addEventListener("click",d)}),Ye(()=>{document.removeEventListener("click",d)}),(u,y)=>(b(),_("div",{class:"stage-select",ref_key:"selectContainer",ref:a},[i("div",{class:ae(["stage-select-field",{"stage-select-field--open":n.value,"stage-select-field--disabled":!1}]),onClick:r},[i("span",Nn,P(o.value),1),i("span",{class:ae(["stage-select-field-icon",{open:n.value}])},"‚ñº",2)],2),re(Ge,{name:"dropdown-fade"},{default:Be(()=>[n.value?(b(),_("div",Rn,[i("div",Fn,[i("label",{class:ae(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:y[0]||(y[0]=ie(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:l.value,onChange:g},null,40,Hn),y[2]||(y[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"–í—Å–µ —ç—Ç–∞–ø—ã")],-1))],2),(b(!0),_(ue,null,pe(c.stages,S=>(b(),_("label",{key:S.id,class:ae(["stage-select-item",{"stage-select-item--selected":c.selected[S.id]}]),onClick:y[1]||(y[1]=ie(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:c.selected[S.id],onChange:h=>p(S.id,h.target.checked)},null,40,On),i("div",Bn,[i("span",{class:"stage-select-item-color",style:we({backgroundColor:S.color})},null,4),i("span",xn,P(S.name),1)])],2))),128))])])):Z("",!0)]),_:1})],512))}},Ln=Se(Pn,[["__scopeId","data-v-ce2229b2"]]),Wn={class:"filters-panel"},Un={class:"filters-header"},jn=["disabled"],zn={class:"filters-content"},Kn={class:"filter-section"},Vn={class:"section-content"},Gn={class:"filter-section"},Yn={class:"section-content"},qn={class:"filter-section"},Jn={class:"section-content"},Xn=["value"],Zn={key:0,class:"custom-date-range"},Qn={class:"date-range-inputs"},el={class:"date-input-group"},tl=["value","max"],al={class:"date-input-group"},sl=["value","min","max"],nl={key:0,class:"filter-error"},ll={key:1,class:"filter-hint"},ol={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(c,{emit:t}){const e=c,s=t,a=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"var(--b24-primary, #007bff)"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"var(--b24-success, #28a745)"}],n=$(null),l=J(()=>{const S=new Date;return S.setFullYear(S.getFullYear()-1),S.toISOString().split("T")[0]}),o=J(()=>new Date().toISOString().split("T")[0]);function r(S){s("update:stages",S),s("apply")}function d(S,h){s("apply")}function p(S){s("update:employees",S),s("apply")}function g(S){s("update:dateRange",S),n.value=null,s("apply")}function u(S,h){const f={...e.customDateRange};if(f[S]=h,f.startDate&&f.endDate){const w=new Date(f.startDate),I=new Date(f.endDate);if(w>I){n.value="–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π";return}if(Math.ceil((I-w)/(1e3*60*60*24))>365){n.value="–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π";return}}n.value=null,s("update:customDateRange",f),s("apply")}function y(){n.value=null,s("reset")}return(S,h)=>(b(),_("div",Wn,[i("div",Un,[h[3]||(h[3]=i("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),i("button",{onClick:y,class:"btn-reset-filters",disabled:!c.hasActiveFilters}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,jn)]),i("div",zn,[i("div",Kn,[h[4]||(h[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"üìä"),je(" –≠—Ç–∞–ø—ã ")],-1)),i("div",Vn,[re(Ln,{selected:c.stages,stages:a,placeholder:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã","onUpdate:selected":r,onChange:d},null,8,["selected"])])]),i("div",Gn,[h[5]||(h[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"üë•"),je(" –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ")],-1)),i("div",Yn,[re(Mn,{selected:c.employees,"onUpdate:selected":p},null,8,["selected"])])]),i("div",qn,[h[9]||(h[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"üìÖ"),je(" –ü–µ—Ä–∏–æ–¥ ")],-1)),i("div",Jn,[i("select",{value:c.dateRange,onChange:h[0]||(h[0]=f=>g(f.target.value)),class:"date-range-select"},[...h[6]||(h[6]=[i("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),i("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),i("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),i("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],40,Xn),c.dateRange==="custom"?(b(),_("div",Zn,[i("div",Qn,[i("div",el,[h[7]||(h[7]=i("label",null,"–°:",-1)),i("input",{type:"date",value:c.customDateRange.startDate,onChange:h[1]||(h[1]=f=>u("startDate",f.target.value)),max:c.customDateRange.endDate||o.value,class:"date-input"},null,40,tl)]),i("div",al,[h[8]||(h[8]=i("label",null,"–ü–æ:",-1)),i("input",{type:"date",value:c.customDateRange.endDate,onChange:h[2]||(h[2]=f=>u("endDate",f.target.value)),min:c.customDateRange.startDate||l.value,max:o.value,class:"date-input"},null,40,sl)])]),n.value?(b(),_("small",nl,P(n.value),1)):(b(),_("small",ll," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):Z("",!0)])])])]))}},rl=Se(ol,[["__scopeId","data-v-4b7456a2"]]);function il(){const c=$(!1),t=$(null),e=$(null),s=$(0),a=xe(),n=async(f=!0,w=null)=>{c.value=!0,t.value=null,s.value=0;try{const I=await ot.getSectorDataForSnapshot({useCache:f,onProgress:z=>{z&&typeof z.progress=="number"&&(s.value=z.progress),w&&w(z)},normalize:!0});return e.value=I,I}catch(I){throw t.value=I.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",a.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+t.value),I}finally{c.value=!1,s.value=100}},l=async(f,w={})=>{if(!e.value){const I="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw t.value=I,a.error(I),new Error(I)}c.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(f))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${f}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const I=await ke.createSnapshot(e.value,f,w);return a.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),I}catch(I){throw t.value=I.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",a.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+t.value),I}finally{c.value=!1}},o=()=>{c.value=!1,t.value=null,e.value=null,s.value=0},r=J(()=>e.value!==null&&e.value!==void 0),d=$({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),p=J(()=>{const f=new Date;let w,I;switch(d.value.dateRange){case"last-week":w=new Date(f),w.setDate(f.getDate()-7),I=f;break;case"last-2-weeks":w=new Date(f),w.setDate(f.getDate()-14),I=f;break;case"last-month":w=new Date(f),w.setMonth(f.getMonth()-1),I=f;break;case"custom":w=d.value.customDateRange.startDate?new Date(d.value.customDateRange.startDate):null,I=d.value.customDateRange.endDate?new Date(d.value.customDateRange.endDate):null;break;default:w=new Date(f),w.setDate(f.getDate()-7),I=f}return{startDate:w?w.toISOString().split("T")[0]:null,endDate:I?I.toISOString().split("T")[0]:null}}),g=()=>{y()},u=()=>{d.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},y()},y=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(d.value))}catch(f){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",f)}},S=()=>{try{const f=localStorage.getItem("graphStateFilters");if(f){const w=JSON.parse(f);w&&typeof w=="object"&&(d.value={stages:w.stages||{formed:!0,review:!0,execution:!0},employees:w.employees||["all"],dateRange:w.dateRange||"last-week",customDateRange:w.customDateRange||{startDate:null,endDate:null}})}}catch(f){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",f)}},h=J(()=>{const f=Object.values(d.value.stages).some(z=>!z),w=!d.value.employees.includes("all"),I=d.value.dateRange!=="last-week";return f||w||I});return{isLoading:c,error:t,currentSectorData:e,loadingProgress:s,hasSectorData:r,filters:d,selectedPeriod:p,hasActiveFilters:h,loadSectorDataForSnapshot:n,createSnapshot:l,resetState:o,applyFilters:g,resetFilters:u,saveFiltersToLocalStorage:y,loadFiltersFromLocalStorage:S}}const cl={class:"graph-state-dashboard"},dl={key:1,class:"error-message-container"},ul={class:"error-message"},pl={class:"error-text"},gl={key:0,class:"error-details"},ml={class:"dashboard-header"},fl={class:"header-content"},hl={class:"breadcrumbs-row"},vl=["aria-disabled","data-fallback","disabled"],yl={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},kl={class:"header-actions"},wl=["disabled"],Sl={key:0},bl={key:1},Dl={key:3,class:"dashboard-content"},El={class:"chart-container"},_l="–ù–∞–∑–∞–¥",Tl={__name:"GraphStateDashboard",setup(c){const t=(B,G)=>typeof window>"u"?G:getComputedStyle(document.documentElement).getPropertyValue(B).trim()||G,e=xe(),s=Ut(),a={name:"dashboard-sector-1c"},{filters:n,selectedPeriod:l,hasActiveFilters:o,applyFilters:r,resetFilters:d,loadFiltersFromLocalStorage:p}=il(),g=$(null),u=$(!0),y=$(!1),S=$("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),h=$(null),f=$(!1),w=$(!1),I=$(typeof window<"u"?window.innerWidth:1024),z=$(null),T=$(!1),R=J(()=>I.value<768);J(()=>I.value>=768&&I.value<1024),J(()=>I.value>=1024);const k=J(()=>typeof window>"u"?!1:window.history.length>1);J(()=>{const B=new Date;return B.setFullYear(B.getFullYear()-1),B.toISOString().split("T")[0]}),J(()=>new Date().toISOString().split("T")[0]);function M(B){n.value.stages=B}function x(B){n.value.employees=B}function K(B){n.value.dateRange=B}function X(B){n.value.customDateRange=B}function te(){r()}function N(){d(),z.value=null,te(),e.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function V(B){e.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function se(B){y.value=!1,S.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",B)}function ge(B){y.value=!1,ne({message:B||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function ne(B){h.value={message:B.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:B.details||null,type:B.type||"error",timestamp:new Date},console.error("Dashboard error:",h.value),e.error(h.value.message)}function me(){h.value=null}function C(){h.value=null,y.value=!0,S.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function H(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}f.value=!0;try{const B=document.querySelector(".chart-container");if(!B)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const G=window.html2canvas,fe=await G(B,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Le=window.jsPDF,ce=new Le("landscape","mm","a4"),Re=297,Je=fe.height*Re/fe.width;ce.setFontSize(18),ce.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const Ae=new Date().toLocaleDateString("ru-RU");ce.setFontSize(10);const Xe=l.value.startDate&&l.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${l.value.startDate} - ${l.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";ce.text(Xe,148.5,25,{align:"center"}),ce.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${Ae}`,148.5,30,{align:"center"}),ce.addImage(fe.toDataURL("image/png"),"PNG",10,35,Re-20,Je-20),ce.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${Ae}`,author:"Bitrix24 Dashboard"});const Ze=`graph-state-${Ae.replace(/\//g,"-")}.pdf`;ce.save(Ze),e.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(B){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",B),ne({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(B.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:B.stack,type:"error"})}finally{f.value=!1}}function le(B){var G;if((G=B==null?void 0:B.preventDefault)==null||G.call(B),!T.value){T.value=!0;try{if(k.value){s.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),s.push(a)}finally{T.value=!1}}}function Pe(){typeof window<"u"&&(I.value=window.innerWidth)}async function qe(){try{const B=await $t.checkAccess();B.allowed&&(g.value=B.user)}catch(B){console.error("Error loading user:",B)}}return Ce(()=>{p(),qe(),typeof window<"u"&&(I.value=window.innerWidth,window.addEventListener("resize",Pe))}),Ye(()=>{typeof window<"u"&&window.removeEventListener("resize",Pe)}),(B,G)=>{const fe=jt("router-link");return b(),_("div",cl,[y.value?(b(),Me(It,{key:0,message:S.value},null,8,["message"])):Z("",!0),h.value?(b(),_("div",dl,[i("div",ul,[i("div",{class:"error-header"},[G[1]||(G[1]=i("span",{class:"error-icon"},"‚ùå",-1)),G[2]||(G[2]=i("h3",null,"–û—à–∏–±–∫–∞",-1)),i("button",{onClick:me,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),i("p",pl,P(h.value.message),1),h.value.details?(b(),_("div",gl,[i("details",null,[G[3]||(G[3]=i("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),i("pre",null,P(h.value.details),1)])])):Z("",!0),i("div",{class:"error-actions"},[i("button",{onClick:C,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):Z("",!0),i("div",ml,[i("div",fl,[i("div",hl,[i("button",{class:"btn-back-link",type:"button",onClick:le,"aria-label":_l,"aria-disabled":!k.value,"data-fallback":!k.value,disabled:T.value,title:"–ù–∞–∑–∞–¥"}," ‚Üê ",8,vl),i("nav",yl,[re(fe,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Be(()=>[...G[4]||(G[4]=[je(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),G[5]||(G[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),G[6]||(G[6]=i("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))])]),G[7]||(G[7]=i("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),G[8]||(G[8]=i("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),i("div",kl,[i("button",{onClick:H,class:"btn-export-pdf",disabled:f.value||y.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[f.value?(b(),_("span",bl,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(b(),_("span",Sl,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,wl),re(mn,{user:g.value,onSnapshotCreated:V},null,8,["user"])])]),R.value?(b(),_("button",{key:2,class:"mobile-filters-toggle",onClick:G[0]||(G[0]=Le=>w.value=!w.value)},[G[9]||(G[9]=i("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),i("span",{class:ae(["toggle-icon",{open:w.value}])},"‚ñº",2)])):Z("",!0),i("div",{class:ae({"mobile-open":w.value&&R.value,"mobile-closed":!w.value&&R.value})},[re(rl,{stages:Ie(n).stages,employees:Ie(n).employees,dateRange:Ie(n).dateRange,customDateRange:Ie(n).customDateRange,hasActiveFilters:Ie(o),"onUpdate:stages":M,"onUpdate:employees":x,"onUpdate:dateRange":K,"onUpdate:customDateRange":X,onReset:N,onApply:te},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!y.value&&!h.value?(b(),_("div",Dl,[i("div",El,[re(Ks,{period:Ie(l),"show-current-state":u.value,onDataLoaded:se,onError:ge},null,8,["period","show-current-state"])])])):Z("",!0)])}}},$l=Se(Tl,[["__scopeId","data-v-e995acfd"]]);export{$l as default};
