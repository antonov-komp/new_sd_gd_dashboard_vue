import{L as h}from"./chunk-Day_h0lQ.js";class m{constructor(e,t=5*60*1e3){this.domain=e,this.cache=new Map,this.cacheTimeout=t,this.metrics={apiCalls:0,cacheHits:0,cacheMisses:0,errors:0,avgResponseTime:0,totalResponseTime:0}}async getApi(){const e="api",t=this.cache.get(e);if(t&&Date.now()-t.timestamp<(t.timeout||this.cacheTimeout))return this.metrics.cacheHits++,t.data;this.metrics.cacheMisses++;const s=performance.now();try{const{Bitrix24ApiService:r}=await h.loadBitrix24Api(),i=performance.now()-s;this.updateAverageResponseTime(i);const a=60*1e3;return this.cache.set(e,{data:r,timestamp:Date.now(),timeout:a}),r}catch(r){throw this.metrics.errors++,console.error(`[${this.domain}] Failed to load Bitrix24ApiService:`,r),r}}async call(e,t={}){const s=performance.now();this.metrics.apiCalls++;try{if(this.isCacheableMethod(e)){const o=this.getCachedResult(e,t);if(o)return this.metrics.cacheHits++,o}const i=await(await this.getApi()).call(e,t),a=performance.now()-s;return this.updateAverageResponseTime(a),this.isCacheableMethod(e)&&this.setCachedResult(e,t,i),i}catch(r){this.metrics.errors++;const i=performance.now()-s;throw console.error(`[${this.domain}] API call failed:`,{method:e,params:t,error:r.message,responseTime:`${i.toFixed(2)}ms`,domain:this.domain}),this.wrapError(r,e,t)}}isCacheableMethod(e){return["user.get","department.get","crm.status.list","user.current","crm.contact.list","crm.company.list"].includes(e)}getCachedResult(e,t){const s=this.getCacheKey(e,t),r=this.cache.get(s);return r&&Date.now()-r.timestamp<(r.timeout||this.cacheTimeout)?r.data:null}setCachedResult(e,t,s){const r=this.getCacheKey(e,t);this.cache.set(r,{data:JSON.parse(JSON.stringify(s)),timestamp:Date.now(),timeout:this.cacheTimeout,method:e,params:t})}getCacheKey(e,t){const s=Object.keys(t).sort().reduce((r,i)=>(r[i]=t[i],r),{});return`${e}_${JSON.stringify(s)}`}updateAverageResponseTime(e){this.metrics.totalResponseTime+=e,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.apiCalls}clearCache(e=null){if(e)for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}getMetrics(){const e=this.metrics.cacheHits+this.metrics.cacheMisses,t=e>0?this.metrics.cacheHits/e:0;return{domain:this.domain,cache:{size:this.cache.size,hitRate:Math.round(t*100)/100,hits:this.metrics.cacheHits,misses:this.metrics.cacheMisses,efficiency:t>.8?"excellent":t>.6?"good":"poor"},api:{totalCalls:this.metrics.apiCalls,errors:this.metrics.errors,errorRate:this.metrics.apiCalls>0?Math.round(this.metrics.errors/this.metrics.apiCalls*100)/100:0,avgResponseTime:Math.round(this.metrics.avgResponseTime),totalResponseTime:Math.round(this.metrics.totalResponseTime),performance:this.metrics.avgResponseTime<500?"fast":this.metrics.avgResponseTime<2e3?"normal":"slow"},cacheEntries:Array.from(this.cache.keys()).map(s=>{const r=this.cache.get(s);return{key:s,age:Date.now()-r.timestamp,ageFormatted:this.formatAge(Date.now()-r.timestamp),method:r.method,expiresIn:(r.timeout||this.cacheTimeout)-(Date.now()-r.timestamp)}}).sort((s,r)=>s.age-r.age)}}formatAge(e){const t=Math.floor(e/1e3),s=Math.floor(t/60),r=Math.floor(s/60);return r>0?`${r}h ${s%60}m`:s>0?`${s}m ${t%60}s`:`${t}s`}wrapError(e,t,s){return e.code==="NETWORK_ERROR"||e.message?.includes("fetch")?new p(`Network error calling ${t}`,e,t,s):e.error&&typeof e.error=="string"?new u(e.error_description||e.error,e,t,s):new n(e.message||"Unknown Bitrix24 error",e,t,s)}}class n extends Error{constructor(e,t,s,r){super(e),this.name="Bitrix24FacadeError",this.originalError=t,this.method=s,this.params=r,this.timestamp=new Date().toISOString(),this.domain="facade"}}class u extends n{constructor(e,t,s,r){super(e,t,s,r),this.name="Bitrix24ApiError",this.domain="api"}}class p extends n{constructor(e,t,s,r){super(e,t,s,r),this.name="Bitrix24NetworkError",this.domain="network"}}class g extends m{constructor(){super("core",10*60*1e3)}async getCurrentUser(){try{const t=(await this.call("user.current",{select:["ID","NAME","LAST_NAME","SECOND_NAME","EMAIL","ACTIVE","DATE_REGISTER","TIMESTAMP_X","PERSONAL_PHONE","WORK_PHONE","PERSONAL_PHOTO","WORK_POSITION","WORK_COMPANY","UF_DEPARTMENT","USER_TYPE","EXTERNAL_AUTH_ID"]})).result||null;return t&&(t.fullName=[t.NAME,t.SECOND_NAME,t.LAST_NAME].filter(Boolean).join(" "),t.isAdmin=t.USER_TYPE==="employee"&&t.ID==="1"),t}catch(e){return console.warn("Failed to get current user:",e.message),null}}async getSystemInfo(){try{const[e,t,s]=await Promise.all([this.getCurrentUser(),this.getDepartments({limit:100}),this.getStatusList()]);return{currentUser:e,departments:{total:t.length,active:t.filter(r=>r.ACTIVE!=="N").length},statuses:s,timestamp:new Date().toISOString(),cache:this.getMetrics()}}catch(e){throw console.error("Failed to get system info:",e),e}}async getDepartments(e={}){const{limit:t=100,includeInactive:s=!1}=e,r={select:["ID","NAME","UF_HEAD","PARENT","SORT","ACTIVE"],order:{SORT:"ASC"},start:0},a=(await this.call("department.get",r)).result||[];return(s?a:a.filter(l=>l.ACTIVE!=="N")).slice(0,t)}async getStatusList(e="LEAD"){try{return(await this.call("crm.status.list",{filter:{ENTITY_ID:e},select:["ID","NAME","SORT","COLOR","SEMANTICS"]})).result||[]}catch(t){return console.warn(`Failed to get ${e} statuses:`,t.message),[]}}async getLeadTypes(){try{const e=await this.call("crm.lead.userfield.list",{filter:{FIELD_NAME:"TYPE_ID"}});return e.result&&e.result[0]?.LIST?e.result[0].LIST:[]}catch(e){return console.warn("Failed to get lead types:",e.message),[]}}async getLeadSources(){try{const e=await this.call("crm.lead.userfield.list",{filter:{FIELD_NAME:"SOURCE_ID"}});return e.result&&e.result[0]?.LIST?e.result[0].LIST:[]}catch(e){return console.warn("Failed to get lead sources:",e.message),[]}}async checkApiAvailability(){const e=performance.now();try{await this.call("user.current",{select:["ID"]});const t=performance.now()-e;return{available:!0,responseTime:Math.round(t),timestamp:new Date().toISOString()}}catch(t){const s=performance.now()-e;return{available:!1,error:t.message,responseTime:Math.round(s),timestamp:new Date().toISOString()}}}async getUsersByType(e="employee",t={}){const{limit:s=100,activeOnly:r=!0}=t,i={USER_TYPE:e,...r&&{ACTIVE:"Y"}};return((await this.call("user.get",{filter:i,select:["ID","NAME","LAST_NAME","EMAIL","ACTIVE","WORK_POSITION","UF_DEPARTMENT","USER_TYPE"],order:{NAME:"ASC"},start:0})).result||[]).slice(0,s)}async getAdministrators(){try{return(await this.getUsersByType("employee",{limit:10})).filter(s=>s.ID==="1"||s.WORK_POSITION?.toLowerCase().includes("админ")||s.WORK_POSITION?.toLowerCase().includes("admin"))}catch(e){return console.warn("Failed to get administrators:",e.message),[]}}async getAppSettings(){try{return(await this.call("app.option.get",{})).result||{}}catch(e){return console.warn("Failed to get app settings:",e.message),{}}}async getAvailableMethods(){try{return(await this.call("methods",{})).result||[]}catch(e){return console.warn("Methods list not available:",e.message),[]}}async getLicenseInfo(){try{return(await this.call("app.info",{})).result||{}}catch(e){return console.warn("License info not available:",e.message),{}}}clearCoreCache(){["user.current","department.get","crm.status.list","user.get"].forEach(t=>{super.clearCache(t)})}async getFullSystemDiagnostics(){try{const[e,t,s,r]=await Promise.all([this.checkApiAvailability(),this.getCurrentUser(),this.getSystemInfo(),this.getLicenseInfo()]);return{api:e,user:t,system:s,license:r,diagnostics:{timestamp:new Date().toISOString(),facadeMetrics:this.getMetrics(),cacheSize:this.cache.size,uptime:performance.now()}}}catch(e){throw console.error("Failed to get full system diagnostics:",e),e}}}export{m as B,g as C};
