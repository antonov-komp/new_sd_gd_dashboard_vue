var rt=Object.defineProperty;var it=(e,t,r)=>t in e?rt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var A=(e,t,r)=>it(e,typeof t!="symbol"?t+"":t,r);import{D as nt}from"./main-BeNH-5j6.js";const S={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367},st=[S.SECTOR_1C,S.SECTOR_HARDWARE,S.SECTOR_BITRIX24,S.SECTOR_PDM];function ot(e){return st.includes(e)}const z=140,$={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},at={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},ct={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"};function lt(){return[$.FORMED.bitrixId,$.REVIEW.bitrixId,$.EXECUTION.bitrixId]}const ut="https://bitrix24.kompo.by",dt="servisdeskitotdel";function Vt(e){return`${ut}/page/${dt}/servisdesk/type/${z}/details/${e}/`}const L="dashboard-sector-1c-logger-level",R={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class gt{static getLevel(){if(typeof localStorage<"u"){const t=localStorage.getItem(L);if(t&&R[t]!==void 0)return t}return"ERROR"}static setLevel(t){return R[t]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(L,t),!0):!1}static isEnabled(t,r=null){const i=r||this.getLevel();if(i==="NONE")return!1;const n=R[t]||0,o=R[i]||0;return n<=o}static getLevels(){return{...R}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(L)}}class y{static getLevelColor(t){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[t]||"#6c757d"}static formatMessage(t,r,i=""){const n=new Date().toISOString(),o=this.getLevelColor(t),s=`%c[${n}] %c[${t}] %c[${i||"Unknown"}] %c${r}`,u=["color: #6c757d; font-weight: normal",`color: ${o}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:s,styles:u}}static log(t,r,i="",n=null){if(!gt.isEnabled(t))return;const o=this.formatMessage(t,r,i),s=[o.formatted,...o.styles];switch(n!=null&&s.push(n),t){case"ERROR":console.error(...s);break;case"WARN":console.warn(...s);break;case"INFO":console.info(...s);break;case"DEBUG":console.log(...s);break;default:console.log(...s)}}static error(t,r="",i=null){this.log("ERROR",t,r,i)}static warn(t,r="",i=null){this.log("WARN",t,r,i)}static info(t,r="",i=null){this.log("INFO",t,r,i)}static debug(t,r="",i=null){this.log("DEBUG",t,r,i)}}class ft{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(t,r,i,n=null){this.metrics.ticketsLoading.stages[t]||(this.metrics.ticketsLoading.stages[t]={loaded:0,batches:[],total:0});const o=this.metrics.ticketsLoading.stages[t];o.loaded=i,o.batches.push({count:r,total:i,next:n}),o.total=i,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((s,u)=>s+u.total,0)}logFiltering(t,r,i=[],n=[]){this.metrics.filtering.total=t,this.metrics.filtering.filtered=r,this.metrics.filtering.rejected=i.slice(0,50),this.metrics.filtering.tagValueExamples=n.slice(0,20)}logEmployees(t,r=[],i=[]){this.metrics.employees.uniqueIds=t,this.metrics.employees.totalUnique=t.length,this.metrics.employees.ticketsWithoutAssignedById=r.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=i.slice(0,50)}logGrouping(t,r=[],i=[]){t.forEach(n=>{const o={};let s=0;n.employees.forEach(u=>{const a=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;o[u.id]=a,s+=a}),this.metrics.grouping.distributionByStages[n.id]={employees:o,total:s}}),this.metrics.grouping.ticketsNotInColumn=r.slice(0,50),this.metrics.grouping.unknownStages=i.slice(0,50)}logZeroPoint(t){Object.keys(t).forEach(r=>{this.metrics.zeroPoint.byStage[r]=Array.isArray(t[r])?t[r].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let P=null;function _(){return P||(P=new ft),P}function E(e=null,t=null){if(t&&!nt(t))return!1;if(e&&e.query&&e.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const r=window.location.hash;if(r){const n=r.split("?");if(n.length>1){const o=n[1];if(new URLSearchParams(o).get("diagnostics")==="true")return!0}if(r.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class yt{static getApiUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(t,r={}){try{const i=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:t,params:r})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=await i.json();if(n.error)throw new Error(n.error_description||n.error);return n}catch(i){throw console.error("Bitrix24 API error:",i),i}}static async getProfile(){return this.call("profile",{})}static async getLeads(t={},r=["ID","NAME","EMAIL","PHONE"],i={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:t,select:r,order:i})).result||[]}}class D{static async call(t,r={}){return await yt.call(t,r)}}class h{static get(t){const r=this.cache.get(t);return r?Date.now()-r.timestamp>r.ttl?(this.cache.delete(t),null):r.data:null}static set(t,r,i=this.DEFAULT_TTL){this.cache.set(t,{data:r,timestamp:Date.now(),ttl:i})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const r=[];for(const i of this.cache.keys())i.startsWith(t)&&r.push(i);r.forEach(i=>this.cache.delete(i))}static cleanExpired(){const t=Date.now(),r=[];for(const[i,n]of this.cache.entries())t-n.timestamp>n.ttl&&r.push(i);r.forEach(i=>this.cache.delete(i))}static getStats(){const t=Date.now();let r=0,i=0;for(const n of this.cache.values())t-n.timestamp>n.ttl?r++:i++;return{total:this.cache.size,valid:i,expired:r}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((i,n)=>i-n).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}A(h,"cache",new Map),A(h,"DEFAULT_TTL",5*60*1e3),A(h,"EMPLOYEES_TTL",30*60*1e3),A(h,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{h.cleanExpired()},5*60*1e3);function T(e,t,r={}){if(!e||typeof e!="string")throw new Error("Step must be a non-empty string");const i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let n=r.description;return n||(n=ht(e,r)),{step:e,progress:i,details:{...r,description:n}}}function ht(e,t){return e==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`Загрузка тикетов стадии "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:e==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`Фильтрация тикетов: ${t.filteredTickets} из ${t.totalTickets}...`:e==="grouping"&&t.employeeCount!==void 0?`Группировка тикетов по ${t.employeeCount} сотрудникам...`:t.count!==void 0&&t.total!==void 0?`Обработка: ${t.count} из ${t.total}...`:"Загрузка данных..."}function U(e){if(!e||typeof e!="object")throw new Error("Progress info must be an object");const t=e.step||null;if(!t)throw new Error("Step is required in progress info");const r=e.progress!==void 0&&e.progress!==null?e.progress:e.percent!==void 0&&e.percent!==null?e.percent:void 0,i=e.details||{};return e.stage&&(i.stage=e.stage),e.stageName&&(i.stageName=e.stageName),e.stageIndex!==void 0&&(i.stageIndex=e.stageIndex),e.totalStages!==void 0&&(i.totalStages=e.totalStages),e.count!==void 0&&(i.count=e.count),e.total!==void 0&&(i.total=e.total),e.warning&&(i.warning=e.warning),{step:t,progress:r!=null?Math.max(0,Math.min(100,r)):void 0,details:i}}function H(e,t,r){const i=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,n=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,o=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,s=i+n*o/100;return Math.max(0,Math.min(100,s))}const k=140;class w{static async getAllTickets(t,r=null,i=!0){const n=[],o=t.length;try{for(let s=0;s<t.length;s++){const u=t[s],a=this.getStageName(u);if(r){const c=s/o*100;r(T("loading_tickets",c,{stage:u,stageName:a,stageIndex:s+1,totalStages:o}))}try{const c=await this.getTicketsByStage(u,i,r?d=>{const f=H(s/o*100,1/o*100,d.percent||0);r(T("loading_tickets",f,{stage:u,stageName:a,stageIndex:s+1,totalStages:o,count:d.count,total:d.total}))}:null);n.push(...c)}catch(c){y.error(`Error loading tickets for stage ${u}`,"TicketRepository",c);let d=`Ошибка загрузки стадии "${a}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${a}". Проверьте подключение к интернету.`:c.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${a}". Попробуйте позже.`:c.message.includes("403")||c.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${a}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${a}": ${c.message}`),new Error(d)}}}catch(s){throw y.error("Error in getAllTickets","TicketRepository",s),s}return n}static getStageName(t){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[t]||t}static async getTicketsByStage(t,r=!0,i=null){var d,f,m;if(r){const l=h.getTicketsCacheKey(t),g=h.get(l);if(g!==null){try{const p=_();p&&E()&&p.logTicketsLoading(t,g.length,g.length,null)}catch(p){y.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",p)}return i&&i(U({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}}const n=[];let o=0;const s=50;let u=!0,a=0,c=null;for(;u;)try{const l=await D.call("crm.item.list",{entityTypeId:k,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:o,useOriginalUfNames:"Y"});let g=[];if(l&&l.result&&(Array.isArray(l.result)?g=l.result:l.result.items&&Array.isArray(l.result.items)?g=l.result.items:l.result.data&&Array.isArray(l.result.data)&&(g=l.result.data)),g.length>0){n.push(...g),o+=g.length;const p=((d=l==null?void 0:l.result)==null?void 0:d.next)??(l==null?void 0:l.next),j=p!=null&&p!==""&&String(p)!=="0";u=g.length===s&&j,E()&&y.debug(`[Pagination] Stage: ${t}, Batch: ${g.length}, Total: ${n.length}, Start: ${o}, NextValue: ${p}, HasNext: ${j}, HasMore: ${u}`,"TicketRepository");try{const C=_();C&&E()&&(y.debug(`[Pagination Debug] Stage: ${t}, Batch: ${g.length}, Total: ${n.length}`,"TicketRepository",{resultStructure:{hasResult:!!(l!=null&&l.result),resultIsArray:Array.isArray(l==null?void 0:l.result),hasItems:!!((f=l==null?void 0:l.result)!=null&&f.items),hasData:!!((m=l==null?void 0:l.result)!=null&&m.data),hasNext:!!p,nextValue:p,nextType:typeof p,resultKeys:l!=null&&l.result?Object.keys(l.result):[]}}),C.logTicketsLoading(t,g.length,n.length,p||null))}catch(C){y.warn("Diagnostics logging error","TicketRepository",C)}if(u?a=o+s:a=n.length,i){const C=a>0?Math.min(100,n.length/a*100):0;i(U({step:"loading_tickets",percent:C,count:n.length,total:a}))}c=null}else u=!1}catch(l){if(y.error(`Error loading tickets batch for stage ${t} (start: ${o})`,"TicketRepository",l),o===0)throw c=l,new Error(`Не удалось загрузить тикеты для стадии ${t}: ${l.message||l}`);u=!1,i&&n.length>0&&i(T("loading_tickets",100,{count:n.length,total:n.length,warning:`Загружено частично: ${n.length} тикетов. Ошибка при загрузке остальных.`}))}if(c&&n.length===0)throw c;if(r){const l=h.getTicketsCacheKey(t);h.set(l,n,h.TICKETS_TTL)}return n}static async getTicket(t){return(await D.call("crm.item.get",{entityTypeId:k,id:t})).result||null}static async updateTicket(t,r){const n=(await D.call("crm.item.update",{entityTypeId:k,id:t,fields:r})).result===!0;return n&&h.invalidateTicketsCache(),n}static async createTicket(t){const r=await D.call("crm.item.add",{entityTypeId:k,fields:t}),i=r.result?parseInt(r.result):0;return i>0&&h.invalidateTicketsCache(),i}static async assignTicket(t,r,i){return await this.updateTicket(t,{assignedById:r,stageId:i})}}class mt{static async getEmployeesByIds(t,r=!0){if(!Array.isArray(t)||t.length===0)return[];if(r){const i=h.getEmployeesCacheKey(t),n=h.get(i);if(n!==null)return y.debug(`Cache hit for employees: ${t.length} employees`,"EmployeeRepository"),n}try{const i=await D.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let n=[];if(i&&i.result&&(Array.isArray(i.result)?n=i.result:y.warn("Unexpected user.get result format","EmployeeRepository",i)),r){const o=h.getEmployeesCacheKey(t);h.set(o,n,h.EMPLOYEES_TTL)}return n}catch(i){return y.error("Error getting employees by IDs","EmployeeRepository",i),[]}}}function x(e){return at[e]||"formed"}function G(e){return ct[e]||"DT140_12:UC_0VHWE2"}function pt(){return lt()}function q(e){return e==null?null:String(e).trim().toLowerCase()||null}const X=[{id:"general",label:"Генеральский",bitrixValue:"Генеральский",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"Высший приоритет (генеральский уровень)"},{id:"external",label:"Внешние обстоятельства",bitrixValue:"Внешние обстоятельства",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"Внешние обстоятельства/блокеры"},{id:"board",label:"Задачи правления и совета директоров",bitrixValue:"Задачи правления и совета директоров",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"Задачи правления / совета директоров"},{id:"errors",label:"Ошибки/сбои",bitrixValue:"Ошибки/сбои",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"Инциденты, ошибки и сбои"},{id:"operations",label:"Текущая деятельность",bitrixValue:"Текущая деятельность",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"Операционная деятельность"},{id:"projects",label:"Проекты",bitrixValue:"Проекты",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"Проектные задачи"},{id:"optimization",label:"Оптимизация",bitrixValue:"Оптимизация",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"Оптимизация и улучшения"}],I={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых/неизвестных значений"};I.id;const Z={},J={};[...X,I].forEach(e=>{Z[e.id]=e;const t=q(e.bitrixValue);t&&(J[t]=e)});function Tt(e){if(!e)return I;const t=String(e).trim();return Z[t]||I}function v(e){const t=q(e);if(!t)return I;const r=J[t];return r||I}function Et(){return[...X,I].sort((e,t)=>e.order-t.order)}function Q(e){if(e&&typeof e=="object"&&e.color)return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor};const t=Tt(e)||v(e)||I;return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor}}Et();function V(e){const t=parseInt(e.id||e.ID||0),r=e.title||e.TITLE||"Без названия",i=e.stageId||e.STAGE_ID||"",n=e.assignedById||e.ASSIGNED_BY_ID||null,o=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",s=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",u=e.UF_SUBJECT||e.uf_subject||e.ufSubject||e.UF_SUBJECT||e.uf_subject||null,a=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,c=v(a),d=Q(c);return{id:t,title:r,ufSubject:u,priorityId:c.id,priorityLabel:c.label,priorityColors:d,priority:c.id,priorityBitrixValue:c.bitrixValue||null,status:It(),assigneeId:n?parseInt(n):null,stageId:x(i),createdAt:o,modifiedAt:s,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function It(e){return"in_progress"}const O=new Map;function St(){O.clear()}function _t(e){if(!e)return[];if(Array.isArray(e))return e.filter(r=>typeof r=="number"||!isNaN(parseInt(r))).map(r=>typeof r=="number"?r:parseInt(r));if(typeof e=="number")return[e];const t=parseInt(e);return isNaN(t)?[]:[t]}function Ct(e,t=!0){const r=e.id||e.ID;if(!e||!r)return null;if(t&&O.has(r))return O.get(r);const i=e.UF_DEPARTMENT||e.departmentId,n=_t(i);for(const o of n)if(ot(o)){const u=o;return t&&O.set(r,u),u}return t&&O.set(r,null),null}function Dt(e){const t=Ct(e);return{id:parseInt(e.ID||e.id||0),name:`${e.NAME||e.name||""} ${e.LAST_NAME||e.lastName||""}`.trim()||e.EMAIL||e.email||"Неизвестный",position:e.WORK_POSITION||e.workPosition||"Сотрудник",email:e.EMAIL||e.email||"",sectorId:t,departmentId:e.UF_DEPARTMENT||null,tickets:[]}}function At(e){return Array.isArray(e)?e.map(t=>Dt(t)):[]}const Rt="1C",wt=["1С"],N=new Map,K=100;function tt(e){return e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||e.ufCrm7TypeProduct||e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||null}function F(e){return e==null?null:String(e).trim().toUpperCase().replace(/С/g,"C")||null}function et(e){if(!e)return[];if(Array.isArray(e))return e.map(F).filter(Boolean);if(typeof e=="object"&&e.value!==void 0){const r=F(e.value);return r?[r]:[]}const t=F(e);return t?t.split(/[;,]/).map(r=>r.trim()).filter(Boolean):[]}function W(e){const t=tt(e),r=et(t);return r.length===0?!1:r.some(i=>i===Rt||wt.includes(i))}function Ot(e){return`filter:${e.map(r=>r.id||r.ID||"").sort().join(",")}`}function Nt(){N.size>K&&Array.from(N.keys()).slice(0,Math.floor(K*.2)).forEach(t=>N.delete(t))}function kt(e){if(!Array.isArray(e))return[];const t=Ot(e),r=N.get(t);if(r!==void 0)return r;const i=e.filter(W);try{const n=_();if(n&&E()){const o=e.filter(a=>!W(a)),s=[],u=new Set;e.forEach(a=>{const c=tt(a),d=et(c),f=c==null?"":String(c);c!=null&&!u.has(f)&&(u.add(f),s.push({value:c,normalized:d,type:typeof c,isArray:Array.isArray(c),ticketId:a.id||a.ID}))}),n.logFiltering(e.length,i.length,o,s)}}catch(n){console.warn("Diagnostics logging error in filterBySector:",n)}return N.set(t,i),Nt(),i}const B=1051;function M(e){if(!e||typeof e!="object")return null;let t=e.assignedById||e.ASSIGNED_BY_ID||e.assignedByIdId||e.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function Y(e){if(e==null)return null;typeof e=="object"&&(e=e.id||e.ID||e.value||null);const t=typeof e=="number"?e:parseInt(e);return isNaN(t)||t<=0?null:t}function bt(e,t=B){const r=M(e),i=Y(r);return i===null||i===t}function Bt(e,t){Array.isArray(e)||(y.warn("Tickets is not an array","TicketGrouper",e),e=[]),Array.isArray(t)||(y.warn("Employees is not an array","TicketGrouper",t),t=[]);const r=t.filter(a=>(a.id?parseInt(a.id):null)!==B),i=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],n=new Map(i.map(a=>[a.id,a])),o=new Map;i.forEach(a=>{const c=new Map(a.employees.map(d=>[d.id,d]));o.set(a.id,c)});const s=[],u=[];e.forEach(a=>{const c=x(a.stageId||a.STAGE_ID||""),d=n.get(c);if(!d){u.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID,assignedById:M(a)});return}const f=M(a),m=Y(f);if(m!==B)if(m){const l=o.get(c);let g=l.get(m);g||(g={id:m,name:`Сотрудник #${m}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},d.employees.push(g),l.set(m,g));const p=V(a);g.tickets.push(p),g.isFromSector1C?g.ticketsInsideSector.push(p):g.ticketsOutsideSector.push(p)}else s.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:c,assignedById:f})}),i.forEach(a=>{a.employees.sort((c,d)=>c.isFromSector1C&&!d.isFromSector1C?-1:!c.isFromSector1C&&d.isFromSector1C?1:(c.id||0)-(d.id||0))});try{const a=_();if(a&&E()){const c={};i.forEach(f=>{let m=0,l=0;f.employees.forEach(g=>{m+=(g.ticketsInsideSector||[]).length,l+=(g.ticketsOutsideSector||[]).length}),c[f.id]={insideSector:m,outsideSector:l,total:m+l}});const d=a.metrics.grouping;Object.keys(c).forEach(f=>{d.distributionByStages[f]||(d.distributionByStages[f]={employees:{},total:0}),d.distributionByStages[f].insideSector=c[f].insideSector,d.distributionByStages[f].outsideSector=c[f].outsideSector,d.distributionByStages[f].total=c[f].total}),a.logGrouping(i,s,u)}}catch(a){y.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",a)}return i}function Mt(e){const t={formed:[],review:[],execution:[]};if(!Array.isArray(e))return y.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",e),t;e.filter(r=>bt(r)).forEach(r=>{const i=x(r.stageId||r.STAGE_ID||"");t[i]&&t[i].push(V(r))});try{const r=_();r&&E()&&r.logZeroPoint(t)}catch(r){y.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",r)}return t}function $t(e){if(!Array.isArray(e))return[];const t=new Set,r=[],i=[];e.forEach(o=>{const s=M(o),u=Y(s);!s||s===null||s===void 0?r.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:o.stageId||o.STAGE_ID}):u===B&&i.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:o.stageId||o.STAGE_ID}),u&&t.add(u)});const n=Array.from(t);try{const o=_();o&&E()&&o.logEmployees(n,r,i)}catch(o){y.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",o)}return n}const b=new Map,Lt=10*60*1e3;function Pt(e){if(!e||typeof e!="object")return{};const t={},r=Object.keys(e);for(const i of r)i.toUpperCase().startsWith("UF_")&&(t[i]=e[i]);return t}function Ft(e,t=null,r=!0){if(r&&t&&b.has(t)){const o=b.get(t),s=Date.now();if(o.timestamp&&s-o.timestamp<Lt)return o.data;b.delete(t)}const i=Pt(e),n={typeProduct:i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product||i.ufCrm7TypeProduct||null,all:i};return r&&t&&b.set(t,{data:n,timestamp:Date.now()}),n}class Ut{static async getTicketDetails(t,r={}){const{select:i=["*"],useOriginalUfNames:n=!0,useCache:o=!0}=r;try{const s=await w.getTicket(t);if(!s)throw new Error(`Тикет с ID ${t} не найден`);const u=Ft(s,t,o),a=s.UF_CRM_7_UF_PRIORITY||s.uf_crm_7_uf_priority||s.ufCrm7UfPriority||s.UF_CRM_7_UF_PRIORITY||s.uf_crm_7_uf_priority||s.priority||s.PRIORITY||null,c=v(a),d=Q(c);return{id:s.id||s.ID,title:s.title||s.TITLE,stageId:s.stageId||s.STAGE_ID,assignedById:s.assignedById||s.ASSIGNED_BY_ID,createdAt:s.createdTime||s.CREATED_TIME||s.CREATED_DATE,updatedAt:s.updatedTime||s.UPDATED_TIME||s.MODIFY_DATE,priorityId:c.id,priorityLabel:c.label,priorityColors:d,priority:c.id,priorityBitrixValue:c.bitrixValue||null,opportunity:s.opportunity||s.OPPORTUNITY,currencyId:s.currencyId||s.CURRENCY_ID,comments:s.comments||s.COMMENTS,additionalFields:u,rawData:s}}catch(s){throw y.error("Error getting ticket details","TicketDetailsService",s),s}}}class Yt{static async getSectorData(t=!0,r=null){try{if(E()){const i=_();i&&i.reset()}}catch(i){y.warn("Error resetting diagnostics","DashboardSector1CService",i)}if(r&&r(T("cache_check",0,{description:"Инициализация загрузки..."})),t){const i=h.getSectorDataCacheKey(),n=h.get(i);if(n!==null)return r&&r(T("cache_hit",100,{description:"Данные загружены из кеша"})),n}try{r&&r(T("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const i=pt(),n=await w.getAllTickets(i,f=>{if(r){const m=U(f),l=H(10,40,m.progress||0);r(T(m.step||"loading_tickets",l,{...m.details,warning:m.details.warning}))}},t);r&&r(T("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const o=kt(n);r&&r(T("filtering",50,{totalTickets:n.length,filteredTickets:o.length,description:`Отфильтровано ${o.length} тикетов из ${n.length}`})),r&&r(T("extracting_employees",60,{filteredTickets:o.length,description:`Анализ ${o.length} тикетов для определения сотрудников...`}));const s=$t(o);r&&r(T("extracting_employees",60,{employeeCount:s.length,description:`Найдено ${s.length} уникальных сотрудников`})),r&&r(T("loading_employees",65,{employeeCount:s.length,description:`Загрузка данных ${s.length} сотрудников...`})),St();const u=await mt.getEmployeesByIds(s),a=At(u);r&&r(T("loading_employees",90,{employeeCount:a.length,description:`Загружено данных ${a.length} сотрудников`})),r&&r(T("grouping",90,{filteredTickets:o.length,employeeCount:a.length,description:`Группировка ${o.length} тикетов по этапам и ${a.length} сотрудникам...`}));const d={stages:Bt(o,a),employees:a,zeroPointTickets:Mt(o)};if(r&&r(T("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),t){const f=h.getSectorDataCacheKey();h.set(f,d,h.TICKETS_TTL)}return r&&r(T("complete",100,{description:"Загрузка завершена"})),d}catch(i){throw y.error("Error getting sector data","DashboardSector1CService",i),r&&r({step:"error",progress:0,error:i.message}),i}}static async assignTicket(t,r,i){try{const n=G(i),o=await w.assignTicket(t,r,n);return o&&h.invalidateTicketsCache(),o}catch(n){throw y.error("Error assigning ticket","DashboardSector1CService",n),n}}static async createTicket(t){try{const r=G(t.stageId||"formed"),i={title:t.title,stageId:r};t.employeeId&&(i.assignedById=t.employeeId);const n=await w.createTicket(i);return n>0&&h.invalidateTicketsCache(),n}catch(r){throw y.error("Error creating ticket","DashboardSector1CService",r),r}}static async getTicket(t){try{const r=await w.getTicket(t);return V(r)}catch(r){throw y.error("Error getting ticket","DashboardSector1CService",r),r}}static async getTicketDetails(t,r={}){try{return await Ut.getTicketDetails(t,r)}catch(i){throw y.error("Error getting ticket details","DashboardSector1CService",i),i}}static async addComment(t,r){try{return(await D.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+z,comment:r}})).result!==void 0}catch(i){throw y.error("Error adding comment","DashboardSector1CService",i),i}}}export{h as C,Yt as D,B as K,y as L,$ as S,w as T,gt as a,_ as b,St as c,ct as d,Vt as g,E as i,U as n};
