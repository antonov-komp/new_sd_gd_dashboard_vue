var q=Object.defineProperty;var z=(i,t,e)=>t in i?q(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var A=(i,t,e)=>z(i,typeof t!="symbol"?t+"":t,e);import{D as X}from"./main-CnoYsZAg.js";const L="dashboard-sector-1c-logger-level",w={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class Z{static getLevel(){if(typeof localStorage<"u"){const t=localStorage.getItem(L);if(t&&w[t]!==void 0)return t}return"ERROR"}static setLevel(t){return w[t]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(L,t),!0):!1}static isEnabled(t,e=null){const r=e||this.getLevel();if(r==="NONE")return!1;const s=w[t]||0,n=w[r]||0;return s<=n}static getLevels(){return{...w}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(L)}}class h{static getLevelColor(t){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[t]||"#6c757d"}static formatMessage(t,e,r=""){const s=new Date().toISOString(),n=this.getLevelColor(t),a=`%c[${s}] %c[${t}] %c[${r||"Unknown"}] %c${e}`,u=["color: #6c757d; font-weight: normal",`color: ${n}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:a,styles:u}}static log(t,e,r="",s=null){if(!Z.isEnabled(t))return;const n=this.formatMessage(t,e,r),a=[n.formatted,...n.styles];switch(s!=null&&a.push(s),t){case"ERROR":console.error(...a);break;case"WARN":console.warn(...a);break;case"INFO":console.info(...a);break;case"DEBUG":console.log(...a);break;default:console.log(...a)}}static error(t,e="",r=null){this.log("ERROR",t,e,r)}static warn(t,e="",r=null){this.log("WARN",t,e,r)}static info(t,e="",r=null){this.log("INFO",t,e,r)}static debug(t,e="",r=null){this.log("DEBUG",t,e,r)}}class J{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(t,e,r,s=null){this.metrics.ticketsLoading.stages[t]||(this.metrics.ticketsLoading.stages[t]={loaded:0,batches:[],total:0});const n=this.metrics.ticketsLoading.stages[t];n.loaded=r,n.batches.push({count:e,total:r,next:s}),n.total=r,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((a,u)=>a+u.total,0)}logFiltering(t,e,r=[],s=[]){this.metrics.filtering.total=t,this.metrics.filtering.filtered=e,this.metrics.filtering.rejected=r.slice(0,50),this.metrics.filtering.tagValueExamples=s.slice(0,20)}logEmployees(t,e=[],r=[]){this.metrics.employees.uniqueIds=t,this.metrics.employees.totalUnique=t.length,this.metrics.employees.ticketsWithoutAssignedById=e.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=r.slice(0,50)}logGrouping(t,e=[],r=[]){t.forEach(s=>{const n={};let a=0;s.employees.forEach(u=>{const o=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;n[u.id]=o,a+=o}),this.metrics.grouping.distributionByStages[s.id]={employees:n,total:a}}),this.metrics.grouping.ticketsNotInColumn=e.slice(0,50),this.metrics.grouping.unknownStages=r.slice(0,50)}logZeroPoint(t){Object.keys(t).forEach(e=>{this.metrics.zeroPoint.byStage[e]=Array.isArray(t[e])?t[e].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let $=null;function I(){return $||($=new J),$}function E(i=null,t=null){if(t&&!X(t))return!1;if(i&&i.query&&i.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const e=window.location.hash;if(e){const s=e.split("?");if(s.length>1){const n=s[1];if(new URLSearchParams(n).get("diagnostics")==="true")return!0}if(e.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class Q{static getApiUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(t,e={}){try{const r=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:t,params:e})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();if(s.error)throw new Error(s.error_description||s.error);return s}catch(r){throw console.error("Bitrix24 API error:",r),r}}static async getProfile(){return this.call("profile",{})}static async getLeads(t={},e=["ID","NAME","EMAIL","PHONE"],r={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:t,select:e,order:r})).result||[]}}class _{static async call(t,e={}){return await Q.call(t,e)}}class m{static get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>e.ttl?(this.cache.delete(t),null):e.data:null}static set(t,e,r=this.DEFAULT_TTL){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:r})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const e=[];for(const r of this.cache.keys())r.startsWith(t)&&e.push(r);e.forEach(r=>this.cache.delete(r))}static cleanExpired(){const t=Date.now(),e=[];for(const[r,s]of this.cache.entries())t-s.timestamp>s.ttl&&e.push(r);e.forEach(r=>this.cache.delete(r))}static getStats(){const t=Date.now();let e=0,r=0;for(const s of this.cache.values())t-s.timestamp>s.ttl?e++:r++;return{total:this.cache.size,valid:r,expired:e}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((r,s)=>r-s).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}A(m,"cache",new Map),A(m,"DEFAULT_TTL",5*60*1e3),A(m,"EMPLOYEES_TTL",30*60*1e3),A(m,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{m.cleanExpired()},5*60*1e3);function T(i,t,e={}){if(!i||typeof i!="string")throw new Error("Step must be a non-empty string");const r=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let s=e.description;return s||(s=tt(i,e)),{step:i,progress:r,details:{...e,description:s}}}function tt(i,t){return i==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`Загрузка тикетов стадии "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:i==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`Фильтрация тикетов: ${t.filteredTickets} из ${t.totalTickets}...`:i==="grouping"&&t.employeeCount!==void 0?`Группировка тикетов по ${t.employeeCount} сотрудникам...`:t.count!==void 0&&t.total!==void 0?`Обработка: ${t.count} из ${t.total}...`:"Загрузка данных..."}function v(i){if(!i||typeof i!="object")throw new Error("Progress info must be an object");const t=i.step||null;if(!t)throw new Error("Step is required in progress info");const e=i.progress!==void 0&&i.progress!==null?i.progress:i.percent!==void 0&&i.percent!==null?i.percent:void 0,r=i.details||{};return i.stage&&(r.stage=i.stage),i.stageName&&(r.stageName=i.stageName),i.stageIndex!==void 0&&(r.stageIndex=i.stageIndex),i.totalStages!==void 0&&(r.totalStages=i.totalStages),i.count!==void 0&&(r.count=i.count),i.total!==void 0&&(r.total=i.total),i.warning&&(r.warning=i.warning),{step:t,progress:e!=null?Math.max(0,Math.min(100,e)):void 0,details:r}}function j(i,t,e){const r=typeof i=="number"&&!isNaN(i)?Math.max(0,Math.min(100,i)):0,s=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,n=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,a=r+s*n/100;return Math.max(0,Math.min(100,a))}const k=140;class C{static async getAllTickets(t,e=null,r=!0){const s=[],n=t.length;try{for(let a=0;a<t.length;a++){const u=t[a],o=this.getStageName(u);if(e){const l=a/n*100;e(T("loading_tickets",l,{stage:u,stageName:o,stageIndex:a+1,totalStages:n}))}try{const l=await this.getTicketsByStage(u,r,e?d=>{const f=j(a/n*100,1/n*100,d.percent||0);e(T("loading_tickets",f,{stage:u,stageName:o,stageIndex:a+1,totalStages:n,count:d.count,total:d.total}))}:null);s.push(...l)}catch(l){h.error(`Error loading tickets for stage ${u}`,"TicketRepository",l);let d=`Ошибка загрузки стадии "${o}"`;throw l.message&&(l.message.includes("HTTP error")||l.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${o}". Проверьте подключение к интернету.`:l.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${o}". Попробуйте позже.`:l.message.includes("403")||l.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${o}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${o}": ${l.message}`),new Error(d)}}}catch(a){throw h.error("Error in getAllTickets","TicketRepository",a),a}return s}static getStageName(t){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[t]||t}static async getTicketsByStage(t,e=!0,r=null){var d,f,y;if(e){const c=m.getTicketsCacheKey(t),g=m.get(c);if(g!==null){try{const p=I();p&&E()&&p.logTicketsLoading(t,g.length,g.length,null)}catch(p){h.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",p)}return r&&r(v({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}}const s=[];let n=0;const a=50;let u=!0,o=0,l=null;for(;u;)try{const c=await _.call("crm.item.list",{entityTypeId:k,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:n,useOriginalUfNames:"Y"});let g=[];if(c&&c.result&&(Array.isArray(c.result)?g=c.result:c.result.items&&Array.isArray(c.result.items)?g=c.result.items:c.result.data&&Array.isArray(c.result.data)&&(g=c.result.data)),g.length>0){s.push(...g),n+=g.length;const p=((d=c==null?void 0:c.result)==null?void 0:d.next)??(c==null?void 0:c.next),x=p!=null&&p!==""&&String(p)!=="0";u=g.length===a&&x,E()&&h.debug(`[Pagination] Stage: ${t}, Batch: ${g.length}, Total: ${s.length}, Start: ${n}, NextValue: ${p}, HasNext: ${x}, HasMore: ${u}`,"TicketRepository");try{const D=I();D&&E()&&(h.debug(`[Pagination Debug] Stage: ${t}, Batch: ${g.length}, Total: ${s.length}`,"TicketRepository",{resultStructure:{hasResult:!!(c!=null&&c.result),resultIsArray:Array.isArray(c==null?void 0:c.result),hasItems:!!((f=c==null?void 0:c.result)!=null&&f.items),hasData:!!((y=c==null?void 0:c.result)!=null&&y.data),hasNext:!!p,nextValue:p,nextType:typeof p,resultKeys:c!=null&&c.result?Object.keys(c.result):[]}}),D.logTicketsLoading(t,g.length,s.length,p||null))}catch(D){h.warn("Diagnostics logging error","TicketRepository",D)}if(u?o=n+a:o=s.length,r){const D=o>0?Math.min(100,s.length/o*100):0;r(v({step:"loading_tickets",percent:D,count:s.length,total:o}))}l=null}else u=!1}catch(c){if(h.error(`Error loading tickets batch for stage ${t} (start: ${n})`,"TicketRepository",c),n===0)throw l=c,new Error(`Не удалось загрузить тикеты для стадии ${t}: ${c.message||c}`);u=!1,r&&s.length>0&&r(T("loading_tickets",100,{count:s.length,total:s.length,warning:`Загружено частично: ${s.length} тикетов. Ошибка при загрузке остальных.`}))}if(l&&s.length===0)throw l;if(e){const c=m.getTicketsCacheKey(t);m.set(c,s,m.TICKETS_TTL)}return s}static async getTicket(t){return(await _.call("crm.item.get",{entityTypeId:k,id:t})).result||null}static async updateTicket(t,e){const s=(await _.call("crm.item.update",{entityTypeId:k,id:t,fields:e})).result===!0;return s&&m.invalidateTicketsCache(),s}static async createTicket(t){const e=await _.call("crm.item.add",{entityTypeId:k,fields:t}),r=e.result?parseInt(e.result):0;return r>0&&m.invalidateTicketsCache(),r}static async assignTicket(t,e,r){return await this.updateTicket(t,{assignedById:e,stageId:r})}}class et{static async getEmployeesByIds(t,e=!0){if(!Array.isArray(t)||t.length===0)return[];if(e){const r=m.getEmployeesCacheKey(t),s=m.get(r);if(s!==null)return h.debug(`Cache hit for employees: ${t.length} employees`,"EmployeeRepository"),s}try{const r=await _.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(r&&r.result&&(Array.isArray(r.result)?s=r.result:h.warn("Unexpected user.get result format","EmployeeRepository",r)),e){const n=m.getEmployeesCacheKey(t);m.set(n,s,m.EMPLOYEES_TTL)}return s}catch(r){return h.error("Error getting employees by IDs","EmployeeRepository",r),[]}}}const S={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367},it=[S.SECTOR_1C,S.SECTOR_HARDWARE,S.SECTOR_BITRIX24,S.SECTOR_PDM];function rt(i){return it.includes(i)}const st=140,b={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},nt={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},at={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},ot={3:"high",2:"medium",1:"low"};function ct(){return[b.FORMED.bitrixId,b.REVIEW.bitrixId,b.EXECUTION.bitrixId]}function F(i){return nt[i]||"formed"}function K(i){return at[i]||"DT140_12:UC_0VHWE2"}function lt(){return ct()}function U(i){const t=parseInt(i.id||i.ID||0),e=i.title||i.TITLE||"Без названия",r=i.stageId||i.STAGE_ID||"",s=i.assignedById||i.ASSIGNED_BY_ID||null,n=i.createdTime||i.CREATED_DATE||i.CREATED_TIME||"",a=i.updatedTime||i.MODIFY_DATE||i.UPDATED_TIME||"";return{id:t,title:e,priority:ut(i.priority||i.PRIORITY),status:dt(),assigneeId:s?parseInt(s):null,stageId:F(r),createdAt:n,modifiedAt:a,amount:i.opportunity||i.OPPORTUNITY||0,currency:i.currencyId||i.CURRENCY_ID||"RUB",description:i.comments||i.COMMENTS||""}}function ut(i){return ot[i]||"medium"}function dt(i){return"in_progress"}const R=new Map;function gt(){R.clear()}function ft(i){if(!i)return[];if(Array.isArray(i))return i.filter(e=>typeof e=="number"||!isNaN(parseInt(e))).map(e=>typeof e=="number"?e:parseInt(e));if(typeof i=="number")return[i];const t=parseInt(i);return isNaN(t)?[]:[t]}function ht(i,t=!0){const e=i.id||i.ID;if(!i||!e)return null;if(t&&R.has(e))return R.get(e);const r=i.UF_DEPARTMENT||i.departmentId,s=ft(r);for(const n of s)if(rt(n)){const u=n;return t&&R.set(e,u),u}return t&&R.set(e,null),null}function mt(i){const t=ht(i);return{id:parseInt(i.ID||i.id||0),name:`${i.NAME||i.name||""} ${i.LAST_NAME||i.lastName||""}`.trim()||i.EMAIL||i.email||"Неизвестный",position:i.WORK_POSITION||i.workPosition||"Сотрудник",email:i.EMAIL||i.email||"",sectorId:t,departmentId:i.UF_DEPARTMENT||null,tickets:[]}}function yt(i){return Array.isArray(i)?i.map(t=>mt(t)):[]}const pt="1C",Tt=["1С"],N=new Map,W=100;function V(i){return i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product||i.ufCrm7TypeProduct||i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product||null}function P(i){return i==null?null:String(i).trim().toUpperCase().replace(/С/g,"C")||null}function H(i){if(!i)return[];if(Array.isArray(i))return i.map(P).filter(Boolean);if(typeof i=="object"&&i.value!==void 0){const e=P(i.value);return e?[e]:[]}const t=P(i);return t?t.split(/[;,]/).map(e=>e.trim()).filter(Boolean):[]}function Y(i){const t=V(i),e=H(t);return e.length===0?!1:e.some(r=>r===pt||Tt.includes(r))}function Et(i){return`filter:${i.map(e=>e.id||e.ID||"").sort().join(",")}`}function St(){N.size>W&&Array.from(N.keys()).slice(0,Math.floor(W*.2)).forEach(t=>N.delete(t))}function It(i){if(!Array.isArray(i))return[];const t=Et(i),e=N.get(t);if(e!==void 0)return e;const r=i.filter(Y);try{const s=I();if(s&&E()){const n=i.filter(o=>!Y(o)),a=[],u=new Set;i.forEach(o=>{const l=V(o),d=H(l),f=l==null?"":String(l);l!=null&&!u.has(f)&&(u.add(f),a.push({value:l,normalized:d,type:typeof l,isArray:Array.isArray(l),ticketId:o.id||o.ID}))}),s.logFiltering(i.length,r.length,n,a)}}catch(s){console.warn("Diagnostics logging error in filterBySector:",s)}return N.set(t,r),St(),r}const M=1051;function B(i){if(!i||typeof i!="object")return null;let t=i.assignedById||i.ASSIGNED_BY_ID||i.assignedByIdId||i.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function G(i){if(i==null)return null;typeof i=="object"&&(i=i.id||i.ID||i.value||null);const t=typeof i=="number"?i:parseInt(i);return isNaN(t)||t<=0?null:t}function Dt(i,t=M){const e=B(i),r=G(e);return r===null||r===t}function _t(i,t){Array.isArray(i)||(h.warn("Tickets is not an array","TicketGrouper",i),i=[]),Array.isArray(t)||(h.warn("Employees is not an array","TicketGrouper",t),t=[]);const e=t.filter(o=>(o.id?parseInt(o.id):null)!==M),r=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:e.map(o=>({...o,isFromSector1C:o.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:e.map(o=>({...o,isFromSector1C:o.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:e.map(o=>({...o,isFromSector1C:o.sectorId===S.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(r.map(o=>[o.id,o])),n=new Map;r.forEach(o=>{const l=new Map(o.employees.map(d=>[d.id,d]));n.set(o.id,l)});const a=[],u=[];i.forEach(o=>{const l=F(o.stageId||o.STAGE_ID||""),d=s.get(l);if(!d){u.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:o.stageId||o.STAGE_ID,assignedById:B(o)});return}const f=B(o),y=G(f);if(y!==M)if(y){const c=n.get(l);let g=c.get(y);g||(g={id:y,name:`Сотрудник #${y}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},d.employees.push(g),c.set(y,g));const p=U(o);g.tickets.push(p),g.isFromSector1C?g.ticketsInsideSector.push(p):g.ticketsOutsideSector.push(p)}else a.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:l,assignedById:f})}),r.forEach(o=>{o.employees.sort((l,d)=>l.isFromSector1C&&!d.isFromSector1C?-1:!l.isFromSector1C&&d.isFromSector1C?1:(l.id||0)-(d.id||0))});try{const o=I();if(o&&E()){const l={};r.forEach(f=>{let y=0,c=0;f.employees.forEach(g=>{y+=(g.ticketsInsideSector||[]).length,c+=(g.ticketsOutsideSector||[]).length}),l[f.id]={insideSector:y,outsideSector:c,total:y+c}});const d=o.metrics.grouping;Object.keys(l).forEach(f=>{d.distributionByStages[f]||(d.distributionByStages[f]={employees:{},total:0}),d.distributionByStages[f].insideSector=l[f].insideSector,d.distributionByStages[f].outsideSector=l[f].outsideSector,d.distributionByStages[f].total=l[f].total}),o.logGrouping(r,a,u)}}catch(o){h.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",o)}return r}function At(i){const t={formed:[],review:[],execution:[]};if(!Array.isArray(i))return h.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",i),t;i.filter(e=>Dt(e)).forEach(e=>{const r=F(e.stageId||e.STAGE_ID||"");t[r]&&t[r].push(U(e))});try{const e=I();e&&E()&&e.logZeroPoint(t)}catch(e){h.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",e)}return t}function wt(i){if(!Array.isArray(i))return[];const t=new Set,e=[],r=[];i.forEach(n=>{const a=B(n),u=G(a);!a||a===null||a===void 0?e.push({id:n.id||n.ID,title:n.title||n.TITLE||"Без названия",stageId:n.stageId||n.STAGE_ID}):u===M&&r.push({id:n.id||n.ID,title:n.title||n.TITLE||"Без названия",stageId:n.stageId||n.STAGE_ID}),u&&t.add(u)});const s=Array.from(t);try{const n=I();n&&E()&&n.logEmployees(s,e,r)}catch(n){h.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",n)}return s}const O=new Map,Ct=10*60*1e3;function Rt(i){if(!i||typeof i!="object")return{};const t={},e=Object.keys(i);for(const r of e)r.toUpperCase().startsWith("UF_")&&(t[r]=i[r]);return t}function Nt(i,t=null,e=!0){if(e&&t&&O.has(t)){const n=O.get(t),a=Date.now();if(n.timestamp&&a-n.timestamp<Ct)return n.data;O.delete(t)}const r=Rt(i),s={typeProduct:r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||null,all:r};return e&&t&&O.set(t,{data:s,timestamp:Date.now()}),s}class kt{static async getTicketDetails(t,e={}){const{select:r=["*"],useOriginalUfNames:s=!0,useCache:n=!0}=e;try{const a=await C.getTicket(t);if(!a)throw new Error(`Тикет с ID ${t} не найден`);const u=Nt(a,t,n);return{id:a.id||a.ID,title:a.title||a.TITLE,stageId:a.stageId||a.STAGE_ID,assignedById:a.assignedById||a.ASSIGNED_BY_ID,createdAt:a.createdTime||a.CREATED_TIME||a.CREATED_DATE,updatedAt:a.updatedTime||a.UPDATED_TIME||a.MODIFY_DATE,priority:a.priority||a.PRIORITY,opportunity:a.opportunity||a.OPPORTUNITY,currencyId:a.currencyId||a.CURRENCY_ID,comments:a.comments||a.COMMENTS,additionalFields:u,rawData:a}}catch(a){throw h.error("Error getting ticket details","TicketDetailsService",a),a}}}class Bt{static async getSectorData(t=!0,e=null){try{if(E()){const r=I();r&&r.reset()}}catch(r){h.warn("Error resetting diagnostics","DashboardSector1CService",r)}if(e&&e(T("cache_check",0,{description:"Инициализация загрузки..."})),t){const r=m.getSectorDataCacheKey(),s=m.get(r);if(s!==null)return e&&e(T("cache_hit",100,{description:"Данные загружены из кеша"})),s}try{e&&e(T("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const r=lt(),s=await C.getAllTickets(r,f=>{if(e){const y=v(f),c=j(10,40,y.progress||0);e(T(y.step||"loading_tickets",c,{...y.details,warning:y.details.warning}))}},t);e&&e(T("filtering",50,{totalTickets:s.length,description:`Фильтрация ${s.length} тикетов по сектору 1С...`}));const n=It(s);e&&e(T("filtering",50,{totalTickets:s.length,filteredTickets:n.length,description:`Отфильтровано ${n.length} тикетов из ${s.length}`})),e&&e(T("extracting_employees",60,{filteredTickets:n.length,description:`Анализ ${n.length} тикетов для определения сотрудников...`}));const a=wt(n);e&&e(T("extracting_employees",60,{employeeCount:a.length,description:`Найдено ${a.length} уникальных сотрудников`})),e&&e(T("loading_employees",65,{employeeCount:a.length,description:`Загрузка данных ${a.length} сотрудников...`})),gt();const u=await et.getEmployeesByIds(a),o=yt(u);e&&e(T("loading_employees",90,{employeeCount:o.length,description:`Загружено данных ${o.length} сотрудников`})),e&&e(T("grouping",90,{filteredTickets:n.length,employeeCount:o.length,description:`Группировка ${n.length} тикетов по этапам и ${o.length} сотрудникам...`}));const d={stages:_t(n,o),employees:o,zeroPointTickets:At(n)};if(e&&e(T("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),t){const f=m.getSectorDataCacheKey();m.set(f,d,m.TICKETS_TTL)}return e&&e(T("complete",100,{description:"Загрузка завершена"})),d}catch(r){throw h.error("Error getting sector data","DashboardSector1CService",r),e&&e({step:"error",progress:0,error:r.message}),r}}static async assignTicket(t,e,r){try{const s=K(r),n=await C.assignTicket(t,e,s);return n&&m.invalidateTicketsCache(),n}catch(s){throw h.error("Error assigning ticket","DashboardSector1CService",s),s}}static async createTicket(t){try{const e=K(t.stageId||"formed"),r={title:t.title,stageId:e};t.employeeId&&(r.assignedById=t.employeeId);const s=await C.createTicket(r);return s>0&&m.invalidateTicketsCache(),s}catch(e){throw h.error("Error creating ticket","DashboardSector1CService",e),e}}static async getTicket(t){try{const e=await C.getTicket(t);return U(e)}catch(e){throw h.error("Error getting ticket","DashboardSector1CService",e),e}}static async getTicketDetails(t,e={}){try{return await kt.getTicketDetails(t,e)}catch(r){throw h.error("Error getting ticket details","DashboardSector1CService",r),r}}static async addComment(t,e){try{return(await _.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+st,comment:e}})).result!==void 0}catch(r){throw h.error("Error adding comment","DashboardSector1CService",r),r}}}export{m as C,Bt as D,M as K,h as L,b as S,C as T,Z as a,at as b,gt as c,I as g,E as i,v as n};
