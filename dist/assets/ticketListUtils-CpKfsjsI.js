import{D as u,d as g}from"./chunk-rKmNpCr3.js";import{b as f,m as c}from"./chunk-DVSMqPZp.js";import{T as y,g as I,b as h,c as C}from"./chunk-Bwkg0lDb.js";import"./chunk-IDUYkvJI.js";import"./chunk-BTnG7_Rn.js";import"./chunk-B5yqeUNo.js";import"./chunk-DLgBCjTL.js";import"./chunk-UTsEWqhV.js";function B(e,r){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:r.category,dateCategoryLabel:r.label,departmentName:null,tickets:r.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function M(e,r){if(!e||!r)return{sourceLevel:2,employeeId:e?.employeeId||null,employeeName:e?.employeeName||null,stageId:e?.stageId||null,stageName:e?.stageName||null,dateCategory:null,dateCategoryLabel:null,departmentName:r?.departmentName||null,tickets:[],snapshot:e?.snapshot||null,ticketDetails:e?.ticketDetails||null};const n=d(e.tickets||[],r.departmentName);return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:r.departmentName,tickets:n,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function _(e,r){const n=await f(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),t=p(n,e.dateCategory),s=d(t,r.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:r.departmentName,tickets:s,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function O(e,r){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:r.category,dateCategoryLabel:r.label,departmentName:null,tickets:r.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function R(e,r){const n=(e.snapshot?.tickets||[]).filter(s=>s.stageId?c(s.stageId)===e.stageId:!1),t=d(n,r.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:r.departmentName,tickets:t,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function N(e,r){return!e||e.length===0?[]:e.filter(n=>n.stageId?c(n.stageId)===r:!1)}function T(e,r){return!e||e.length===0?[]:e.filter(n=>{const t=n.assignedTo;return t?(typeof t=="object"?t.id:t)===r:!1})}function p(e,r){if(!e||e.length===0)return[];const n=new Date;return e.filter(t=>t.createdAt?g(t.createdAt,n)===r:r===u.MORE_THAN_YEAR)}function d(e,r){return!e||e.length===0?[]:e.filter(n=>{let t=n.departmentHeadFull||n.departmentHead;return t?(t=String(t).trim(),t.length===0&&(t="Без заказчика")):t="Без заказчика",t===r})}async function x(e){if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let o=e.tickets;return e.departmentName&&(o=d(o,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:o.length,departmentFilter:e.departmentName}),o}const{snapshot:r,stageId:n,employeeId:t,dateCategory:s,departmentName:l}=e;let i=r.tickets||[];return n&&(i=N(i,n)),t&&(i=T(i,t)),s&&(i=p(i,s)),l&&(i=d(i,l)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:r.tickets?.length||0,filteredCount:i.length,filters:{stageId:n,employeeId:t,dateCategory:s,departmentName:l}}),i}function S(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function L(e){return e.filter(r=>{const n=!r.ufSubject||r.ufSubject==="",t=r.actionStr===null||r.actionStr===void 0,s=!r.description||r.description==="";return n||t||s})}function b(e){const r=new Map;return e&&(Array.isArray(e)?e.forEach(n=>{n&&n.id&&r.set(n.id,n)}):typeof e=="object"&&Object.keys(e).forEach(n=>{const t=e[n];t&&t.id&&r.set(t.id,t)})),r}function k(e,r){const n=r.get(e.id)||null,t={id:e.id,title:e.title||"Без названия",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};t.ufSubject=n?.ufSubject||e.ufSubject||null;const s=n?.priorityId||e.priorityId||"unknown",l=n?.priorityLabel||e.priorityLabel||"Не указано",i=I(s);t.priorityId=s,t.priorityLabel=l,t.priorityColors=i,t.priority=s;const o=n?.service||e.service||h(),a=n?.serviceLabel||e.serviceLabel||o.label||"Не указано",m=C(o);return t.service=o,t.serviceLabel=a,t.serviceColors=m,t.actionStr=n?.actionStr||e.actionStr||e.ufActionStr||null,t.ufActionStr=t.actionStr,t.departmentHead=n?.departmentHead||e.departmentHead||null,t.departmentHeadFull=n?.departmentHeadFull||e.departmentHeadFull||e.departmentHead||null,t.description=n?.description||e.description||e.comments||"",t.assignedTo=e.assignedTo||null,t.assigneeId=e.assigneeId||e.assignedTo?.id||null,t.stageId=e.stageId||null,!t.status&&t.stageId?t.status=S(t.stageId):t.status=e.status||"new",t}async function G(e,r=null,n=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const t=L(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:t.length,alreadyHaveDetails:e.length-t.length});let s=n||null;if(t.length>0&&!n){const o=t.map(a=>a.id).filter(a=>a);if(o.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:o.length,ticketIdsSample:o.slice(0,5)}),s=await y.getTicketsDetails(o),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:s?.length||0,sampleTicket:s?.[0]?{id:s[0].id,hasUfSubject:!!s[0].ufSubject,hasActionStr:!!s[0].actionStr,hasDescription:!!s[0].description}:null})}catch(a){console.warn("[ticketListUtils] Failed to load ticket details:",a),console.error("[ticketListUtils] Error details:",{message:a.message,stack:a.stack,ticketIdsCount:o.length}),s=null}}const l=b(s),i=e.map(o=>k(o,l));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:i.length,sampleTicket:i[0]?{id:i[0].id,hasUfSubject:!!i[0].ufSubject,hasPriorityColors:!!i[0].priorityColors,hasServiceColors:!!i[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),i}export{R as createContextFromLevel1Department,O as createContextFromLevel1Time,B as createContextFromLevel2,M as createContextFromLevel2Department,_ as createContextFromLevel3,x as filterTicketsByContext,d as filterTicketsByDepartment,G as prepareTicketsForDisplay};
