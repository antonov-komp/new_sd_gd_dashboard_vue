import{f as g,h as A,j as N,a as S}from"./priority-config-CDloJjLp.js";import{a as E,m as _,c as I,d as k}from"./ticket-mapper-Pg5VmoCP.js";import{a2 as h}from"./main-DyynEk-q.js";const T=140,f=new Map;class C{static async getTicketDetails(n){if(!n)return console.warn("Ticket ID is required"),null;try{const r=await h.call("crm.item.list",{entityTypeId:T,filter:{id:n},select:["*"],useOriginalUfNames:"Y"});let s=[];if(r&&r.result&&(Array.isArray(r.result)?s=r.result:r.result.items&&Array.isArray(r.result.items)?s=r.result.items:r.result.data&&Array.isArray(r.result.data)&&(s=r.result.data)),!s||s.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${n} not found`),null;const t=s[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:t.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!t.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:t.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(t),ticketSample:JSON.stringify(t).substring(0,500)});const i=E(t),a=t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||t.ufCrm7DepartmentHead||t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||t.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:a,mappedDepartmentHead:i.departmentHead,departmentHeadFull:a?String(a).trim():null});let o=null;if(a){const l=String(a).trim();l.length>0&&(o=l)}return{...i,departmentHeadFull:o}}catch(r){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${n}:`,r),console.error("[TicketDetailsService] Error details:",{message:r.message,stack:r.stack,ticketId:n}),null}}static async getTicketsDetails(n){if(!n||!Array.isArray(n)||n.length===0)return[];const r=[],s=[];if(n.forEach(t=>{f.has(t)?r.push(f.get(t)):s.push(t)}),s.length===0)return r;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:s.length,ticketIdsSample:s.slice(0,5),entityTypeId:T});const t=await h.call("crm.item.list",{entityTypeId:T,filter:{id:s},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!t,resultType:typeof t,resultKeys:t?Object.keys(t):[],hasResultResult:!!(t!=null&&t.result),resultResultType:typeof(t==null?void 0:t.result),isArray:Array.isArray(t==null?void 0:t.result),resultResultLength:Array.isArray(t==null?void 0:t.result)?t.result.length:"not array",fullResult:t});let i=[];if(t&&t.result&&(Array.isArray(t.result)?i=t.result:t.result.items&&Array.isArray(t.result.items)?i=t.result.items:t.result.data&&Array.isArray(t.result.data)&&(i=t.result.data)),!i||i.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!t,hasResultResult:!!(t!=null&&t.result),resultType:typeof(t==null?void 0:t.result),result:t,resultKeys:t?Object.keys(t):[]}),r;const a=i.map((o,l)=>{l===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:o.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:o.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(o).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(o).slice(0,20)});const m=E(o);l===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:m.id,hasDepartmentHead:!!m.departmentHead,departmentHead:m.departmentHead,mappedTicketKeys:Object.keys(m).filter(p=>p.toLowerCase().includes("department"))});const c=o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||null;l===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:c,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(o).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm"))});let u=null;if(c){const p=String(c).trim();p.length>0&&(u=p)}!u&&m.departmentHead&&(u=m.departmentHead);const d={...m,departmentHeadFull:u||m.departmentHead||null};return l===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&f.set(d.id,d),d});return[...r,...a]}catch(t){return console.error("[TicketDetailsService] Error loading tickets details batch:",t),console.error("[TicketDetailsService] Error details:",{message:t.message,stack:t.stack,ticketIdsCount:n.length,ticketIdsSample:n.slice(0,5)}),r}}static clearCache(n=1e3){f.size>n&&f.clear()}static getCacheSize(){return f.size}}async function F(e,n,r,s=null){var m;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:e,stageId:n,hasSnapshot:!!r,snapshotType:r?typeof r:"null",snapshotKeys:r?Object.keys(r):[],hasTickets:!!(r!=null&&r.tickets),ticketsIsArray:Array.isArray(r==null?void 0:r.tickets),ticketsLength:((m=r==null?void 0:r.tickets)==null?void 0:m.length)||0}),!e||!n)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!r)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!r.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(r)),[];if(!Array.isArray(r.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof r.tickets),[];const t=r.tickets.filter(c=>{const u=c.assignedTo;return u?(typeof u=="object"?u.id:u)===e:!1});if(t.length===0)return[];const i=!t[0].stageId||!t[0].departmentHead;let a=null;if(i){const c=t.map(u=>u.id);if(s&&typeof s=="object")a=s;else try{const u=await C.getTicketsDetails(c);a=new Map,u.forEach(d=>{d&&d.id&&a.set(d.id,d)})}catch(u){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",u),a=null}}return t.map(c=>{const u=c.id,d={id:u,title:c.title||"Без названия",assignedTo:c.assignedTo,createdAt:c.createdAt,updatedAt:c.updatedAt};if(a){const p=a instanceof Map?a.get(u):a[u];p?(d.stageId=p.stageId||null,d.departmentHead=p.departmentHead||null,d.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=c.stageId||null,d.departmentHead=c.departmentHead||null,d.departmentHeadFull=c.departmentHeadFull||c.departmentHead||null;return d}).filter(c=>c.stageId?_(c.stageId)===n:!0)}function G(e,n=new Date){if(!e||e.length===0)return[];const r=e.length,s={};return Object.values(g).forEach(i=>{s[i]={category:i,label:A[i].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:A[i].color}}),e.forEach(i=>{if(!i.createdAt){s[g.MORE_THAN_YEAR].count++,s[g.MORE_THAN_YEAR].tickets.push(i);return}const a=N(i.createdAt,n);s[a]&&(s[a].count++,s[a].tickets.push(i))}),Object.values(s).filter(i=>i.count>0).map(i=>{const a=r>0?parseFloat((i.count/r*100).toFixed(1)):0;return{...i,percentage:a,progressBarWidth:a}}).sort((i,a)=>{const o=[g.TODAY,g.YESTERDAY,g.THIS_WEEK,g.LAST_WEEK,g.MORE_THAN_TWO_WEEKS,g.UP_TO_ONE_MONTH,g.MORE_THAN_TWO_MONTHS,g.MORE_THAN_HALF_YEAR,g.MORE_THAN_YEAR];return o.indexOf(i.category)-o.indexOf(a.category)})}function $(e){if(!e||e.length===0)return[];const n={};e.forEach(s=>{let t=s.departmentHeadFull||s.departmentHead;e.indexOf(s)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:s.id,departmentHead:s.departmentHead,departmentHeadFull:s.departmentHeadFull,allKeys:Object.keys(s).filter(i=>i.toLowerCase().includes("department"))}),t?(t=String(t).trim(),t.length===0&&(t="Без заказчика")):t="Без заказчика",n[t]||(n[t]={departmentName:t,count:0}),n[t].count++});const r=Object.values(n);return r.sort((s,t)=>t.count!==s.count?t.count-s.count:s.departmentName.localeCompare(t.departmentName,"ru")),r}function R(e,n){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:n.category,dateCategoryLabel:n.label,departmentName:null,tickets:n.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function L(e,n){if(!e||!n)return{sourceLevel:2,employeeId:(e==null?void 0:e.employeeId)||null,employeeName:(e==null?void 0:e.employeeName)||null,stageId:(e==null?void 0:e.stageId)||null,stageName:(e==null?void 0:e.stageName)||null,dateCategory:null,dateCategoryLabel:null,departmentName:(n==null?void 0:n.departmentName)||null,tickets:[],snapshot:(e==null?void 0:e.snapshot)||null,ticketDetails:(e==null?void 0:e.ticketDetails)||null};const r=y(e.tickets||[],n.departmentName);return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:n.departmentName,tickets:r,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function M(e,n){const r=await F(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),s=H(r,e.dateCategory),t=y(s,n.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:n.departmentName,tickets:t,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function b(e,n){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:n.category,dateCategoryLabel:n.label,departmentName:null,tickets:n.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function O(e,n){var t;const r=(((t=e.snapshot)==null?void 0:t.tickets)||[]).filter(i=>i.stageId?_(i.stageId)===e.stageId:!1),s=y(r,n.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:n.departmentName,tickets:s,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function U(e,n){return!e||e.length===0?[]:e.filter(r=>r.stageId?_(r.stageId)===n:!1)}function w(e,n){return!e||e.length===0?[]:e.filter(r=>{const s=r.assignedTo;return s?(typeof s=="object"?s.id:s)===n:!1})}function H(e,n){if(!e||e.length===0)return[];const r=new Date;return e.filter(s=>s.createdAt?N(s.createdAt,r)===n:n===g.MORE_THAN_YEAR)}function y(e,n){return!e||e.length===0?[]:e.filter(r=>{let s=r.departmentHeadFull||r.departmentHead;return s?(s=String(s).trim(),s.length===0&&(s="Без заказчика")):s="Без заказчика",s===n})}async function j(e){var o;if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let l=e.tickets;return e.departmentName&&(l=y(l,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:l.length,departmentFilter:e.departmentName}),l}const{snapshot:n,stageId:r,employeeId:s,dateCategory:t,departmentName:i}=e;let a=n.tickets||[];return r&&(a=U(a,r)),s&&(a=w(a,s)),t&&(a=H(a,t)),i&&(a=y(a,i)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:((o=n.tickets)==null?void 0:o.length)||0,filteredCount:a.length,filters:{stageId:r,employeeId:s,dateCategory:t,departmentName:i}}),a}function D(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function P(e){return e.filter(n=>{const r=!n.ufSubject||n.ufSubject==="",s=n.actionStr===null||n.actionStr===void 0,t=!n.description||n.description==="";return r||s||t})}function B(e){const n=new Map;return e&&(Array.isArray(e)?e.forEach(r=>{r&&r.id&&n.set(r.id,r)}):typeof e=="object"&&Object.keys(e).forEach(r=>{const s=e[r];s&&s.id&&n.set(s.id,s)})),n}function Y(e,n){var c;const r=n.get(e.id)||null,s={id:e.id,title:e.title||"Без названия",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};s.ufSubject=(r==null?void 0:r.ufSubject)||e.ufSubject||null;const t=(r==null?void 0:r.priorityId)||e.priorityId||"unknown",i=(r==null?void 0:r.priorityLabel)||e.priorityLabel||"Не указано",a=S(t);s.priorityId=t,s.priorityLabel=i,s.priorityColors=a,s.priority=t;const o=(r==null?void 0:r.service)||e.service||I(),l=(r==null?void 0:r.serviceLabel)||e.serviceLabel||o.label||"Не указано",m=k(o);return s.service=o,s.serviceLabel=l,s.serviceColors=m,s.actionStr=(r==null?void 0:r.actionStr)||e.actionStr||e.ufActionStr||null,s.ufActionStr=s.actionStr,s.departmentHead=(r==null?void 0:r.departmentHead)||e.departmentHead||null,s.departmentHeadFull=(r==null?void 0:r.departmentHeadFull)||e.departmentHeadFull||e.departmentHead||null,s.description=(r==null?void 0:r.description)||e.description||e.comments||"",s.assignedTo=e.assignedTo||null,s.assigneeId=e.assigneeId||((c=e.assignedTo)==null?void 0:c.id)||null,s.stageId=e.stageId||null,!s.status&&s.stageId?s.status=D(s.stageId):s.status=e.status||"new",s}async function K(e,n=null,r=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const s=P(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:s.length,alreadyHaveDetails:e.length-s.length});let t=r||null;if(s.length>0&&!r){const o=s.map(l=>l.id).filter(l=>l);if(o.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:o.length,ticketIdsSample:o.slice(0,5)}),t=await C.getTicketsDetails(o),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:(t==null?void 0:t.length)||0,sampleTicket:t!=null&&t[0]?{id:t[0].id,hasUfSubject:!!t[0].ufSubject,hasActionStr:!!t[0].actionStr,hasDescription:!!t[0].description}:null})}catch(l){console.warn("[ticketListUtils] Failed to load ticket details:",l),console.error("[ticketListUtils] Error details:",{message:l.message,stack:l.stack,ticketIdsCount:o.length}),t=null}}const i=B(t),a=e.map(o=>Y(o,i));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:a.length,sampleTicket:a[0]?{id:a[0].id,hasUfSubject:!!a[0].ufSubject,hasPriorityColors:!!a[0].priorityColors,hasServiceColors:!!a[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),a}const J=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:O,createContextFromLevel1Time:b,createContextFromLevel2:R,createContextFromLevel2Department:L,createContextFromLevel3:M,filterTicketsByContext:j,filterTicketsByDepartment:y,prepareTicketsForDisplay:K},Symbol.toStringTag,{value:"Module"}));export{C as T,G as a,$ as b,y as f,F as g,J as t};
