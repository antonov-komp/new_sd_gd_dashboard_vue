import{D as $}from"./chunk-D15Haoqg.js";const c={TODAY:"today",YESTERDAY:"yesterday",THIS_WEEK:"this_week",LAST_WEEK:"last_week",MORE_THAN_TWO_WEEKS:"more_than_two_weeks",UP_TO_ONE_MONTH:"up_to_one_month",MORE_THAN_TWO_MONTHS:"more_than_two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},O={[c.TODAY]:{label:"СЕГОДНЯ",color:"#28a745",backgroundColor:"#d4edda",textColor:"#155724"},[c.YESTERDAY]:{label:"ВЧЕРА",color:"#20c997",backgroundColor:"#d1f2eb",textColor:"#0c5460"},[c.THIS_WEEK]:{label:"НА ЭТОЙ НЕДЕЛЕ",color:"#17a2b8",backgroundColor:"#d1ecf1",textColor:"#0c5460"},[c.LAST_WEEK]:{label:"НА ПРОШЛОЙ НЕДЕЛЕ",color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},[c.MORE_THAN_TWO_WEEKS]:{label:"БОЛЕЕ ДВУХ НЕДЕЛЬ",color:"#fd7e14",backgroundColor:"#ffe5d0",textColor:"#7d3f00"},[c.UP_TO_ONE_MONTH]:{label:"ДО 1 МЕСЯЦА",color:"#dc3545",backgroundColor:"#f8d7da",textColor:"#721c24"},[c.MORE_THAN_TWO_MONTHS]:{label:"БОЛЕЕ 2 МЕСЯЦЕВ",color:"#6c757d",backgroundColor:"#e2e3e5",textColor:"#383d41"},[c.MORE_THAN_HALF_YEAR]:{label:"БОЛЕЕ ПОЛУГОДА",color:"#6c757d",backgroundColor:"#d6d8db",textColor:"#212529"},[c.MORE_THAN_YEAR]:{label:"БОЛЕЕ ГОДА",color:"#343a40",backgroundColor:"#c6c8ca",textColor:"#000000"}};function Ie(e){if(!e)return null;const t=String(e).trim();if(t.length===0)return null;try{const n=new Date(t);return isNaN(n.getTime())?(console.warn("Invalid date format:",e),null):n}catch(n){return console.error("Error parsing date:",e,n),null}}function N(e){if(!e)return"";let t;if(e instanceof Date?t=e:t=new Date(e),isNaN(t.getTime()))return"";const n=t.getDate(),r=t.getMonth()+1,o=t.getFullYear(),a=String(n).padStart(2,"0"),l=String(r).padStart(2,"0"),s=String(o);return`${a}.${l}.${s}`}function Se(e,t=new Date){if(!e)return"";const n=e instanceof Date?e:new Date(e),r=t instanceof Date?t:new Date(t);if(isNaN(n.getTime())||isNaN(r.getTime()))return N(n);const o=new Date(n.getFullYear(),n.getMonth(),n.getDate()),l=new Date(r.getFullYear(),r.getMonth(),r.getDate())-o,s=Math.floor(l/(1e3*60*60*24));return s===0?"Сегодня":N(n)}function M(e,t=new Date){if(!e)return c.MORE_THAN_YEAR;const n=e instanceof Date?e:new Date(e),r=t instanceof Date?t:new Date(t);if(isNaN(n.getTime())||isNaN(r.getTime()))return c.MORE_THAN_YEAR;const o=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=new Date(r.getFullYear(),r.getMonth(),r.getDate()),l=a-o;if(l<0)return c.TODAY;const s=Math.floor(l/(1e3*60*60*24)),f=Math.floor(s/7),i=Math.floor(s/30),u=Math.floor(s/365);if(s===0)return c.TODAY;if(s===1)return c.YESTERDAY;const d=new Date(a),p=a.getDay(),m=p===0?6:p-1;if(d.setDate(a.getDate()-m),d.setHours(0,0,0,0),o>=d&&s<7)return c.THIS_WEEK;const C=new Date(d);return C.setDate(d.getDate()-7),o>=C&&o<d?c.LAST_WEEK:f>=2&&i<1?c.MORE_THAN_TWO_WEEKS:i>=1&&i<2?c.UP_TO_ONE_MONTH:i>=2&&i<6?c.MORE_THAN_TWO_MONTHS:i>=6&&u<1?c.MORE_THAN_HALF_YEAR:c.MORE_THAN_YEAR}const I={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367,KEEPER:1051},G=[I.SECTOR_1C,I.SECTOR_HARDWARE,I.SECTOR_BITRIX24,I.SECTOR_PDM];function Re(e){return G.includes(e)}const X=140,D={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},q={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},J={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"};function Q(){return[D.FORMED.bitrixId,D.REVIEW.bitrixId,D.EXECUTION.bitrixId]}const Z="https://bitrix24.kompo.by",ee="servisdeskitotdel";function Ne(e){return`${Z}/page/${ee}/servisdesk/type/${X}/details/${e}/`}function S(e){return q[e]||"formed"}function De(e){return J[e]||"DT140_12:UC_0VHWE2"}function he(){return Q()}function F(e){return e==null?null:String(e).trim().toLowerCase()||null}const U=[{id:"general",label:"Генеральский",bitrixValue:"Генеральский",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"Высший приоритет (генеральский уровень)"},{id:"external",label:"Внешние обстоятельства",bitrixValue:"Внешние обстоятельства",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"Внешние обстоятельства/блокеры"},{id:"board",label:"Задачи правления и совета директоров",bitrixValue:"Задачи правления и совета директоров",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"Задачи правления / совета директоров"},{id:"errors",label:"Ошибки/сбои",bitrixValue:"Ошибки/сбои",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"Инциденты, ошибки и сбои"},{id:"operations",label:"Текущая деятельность",bitrixValue:"Текущая деятельность",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"Операционная деятельность"},{id:"projects",label:"Проекты",bitrixValue:"Проекты",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"Проектные задачи"},{id:"optimization",label:"Оптимизация",bitrixValue:"Оптимизация",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"Оптимизация и улучшения"}],_={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых/неизвестных значений"},He=_.id,L={},k={};[...U,_].forEach(e=>{L[e.id]=e;const t=F(e.bitrixValue);t&&(k[t]=e)});function te(e){if(!e)return _;const t=String(e).trim();return L[t]||_}function w(e){const t=F(e);if(!t)return _;const n=k[t];return n||_}function re(){return[...U,_].sort((e,t)=>e.order-t.order)}function P(e){if(e&&typeof e=="object"&&e.color)return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor};const t=te(e)||w(e)||_;return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor}}re();function Y(e){return e==null?null:String(e).trim().toLowerCase()||null}const j=[{id:"1c-accounting",label:"1С.Бухгалтерия",bitrixValue:"1С.Бухгалтерия",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"Бухгалтерский контур 1С"},{id:"1c-tickets",label:"1С.Талоны",bitrixValue:"1С.Талоны",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"Работа с талонами 1С"},{id:"1c-zup",label:"1С.ЗУП",bitrixValue:"1С.ЗУП",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"Зарплата и управление персоналом"},{id:"1c-docflow",label:"1С.Документооборот",bitrixValue:"1С.Документооборот",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"Документооборот 1С"},{id:"1c-integrations",label:"1С.Интеграции",bitrixValue:"1С.Интеграции",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"Интеграции и сопряжения 1С"}],g={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых или неидентифицированных значений"},oe={},B={};[...j,g].forEach(e=>{oe[e.id]=e;const t=Y(e.bitrixValue);t&&(B[t]=e)});function ne(e){const t=Y(e);if(!t)return g;const n=B[t];return n||g}function V(){return g}function ae(){return[...j,g].sort((e,t)=>e.order-t.order)}function W(e){const t=e&&typeof e=="object"?e:g;return{color:t.color||g.color,backgroundColor:t.backgroundColor||g.backgroundColor,textColor:t.textColor||g.textColor}}ae();function b(e){const t=parseInt(e.id||e.ID||0),n=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",o=e.assignedById||e.ASSIGNED_BY_ID||null,a=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",l=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",s=e.UF_SUBJECT||e.uf_subject||e.ufSubject||e.UF_SUBJECT||e.uf_subject||null,f=e.UF_CRM_7_DEPARTMENT_HEAD||e.uf_crm_7_department_head||e.ufCrm7DepartmentHead||e.UF_CRM_7_DEPARTMENT_HEAD||e.uf_crm_7_department_head||null;let i=null,u=null;if(f){const y=String(f).trim();y.length>0&&(u=y,i=y.length>17?y.substring(0,17):y)}const d=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,p=w(d),m=P(p),C=e.UF_SLA_SERVICE_STR||e.uf_sla_service_str||e.UfSlaServiceStr||e.ufSlaServiceStr||e.service||null,A=ne(C),z=W(A),H=e.UF_ACTION_STR||e.uf_action_str||e.UfActionStr||e.ufActionStr||e.UF_ACTION_STR||e.uf_action_str||null,R=H?String(H).trim():null,x=R&&R.length>0?R:null;return{id:t,title:n,ufSubject:s,departmentHead:i,departmentHeadFull:u,priorityId:p.id,priorityLabel:p.label,priorityColors:m,priority:p.id,priorityBitrixValue:p.bitrixValue||null,service:A,serviceLabel:A.label,serviceColors:z,serviceBitrixValue:A.bitrixValue||V().bitrixValue,actionStr:x,status:se(),assigneeId:o?parseInt(o):null,stageId:S(r),createdAt:a,modifiedAt:l,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function se(e){return"in_progress"}const h=140,E=new Map;class v{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const r=await new $().call("crm.item.list",{entityTypeId:h,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let o=[];if(r&&r.result&&(Array.isArray(r.result)?o=r.result:r.result.items&&Array.isArray(r.result.items)?o=r.result.items:r.result.data&&Array.isArray(r.result.data)&&(o=r.result.data)),!o||o.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const a=o[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:a.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!a.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:a.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(a),ticketSample:JSON.stringify(a).substring(0,500)});const l=b(a),s=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:s,mappedDepartmentHead:l.departmentHead,departmentHeadFull:s?String(s).trim():null});let f=null;if(s){const i=String(s).trim();i.length>0&&(f=i)}return{...l,departmentHeadFull:f}}catch(n){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,n),console.error("[TicketDetailsService] Error details:",{message:n.message,stack:n.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const n=[],r=[];if(t.forEach(o=>{E.has(o)?n.push(E.get(o)):r.push(o)}),r.length===0)return n;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:r.length,ticketIdsSample:r.slice(0,5),entityTypeId:h});const o=await facade.call("crm.item.list",{entityTypeId:h,filter:{id:r},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!o,resultType:typeof o,resultKeys:o?Object.keys(o):[],hasResultResult:!!o?.result,resultResultType:typeof o?.result,isArray:Array.isArray(o?.result),resultResultLength:Array.isArray(o?.result)?o.result.length:"not array",fullResult:o});let a=[];if(o&&o.result&&(Array.isArray(o.result)?a=o.result:o.result.items&&Array.isArray(o.result.items)?a=o.result.items:o.result.data&&Array.isArray(o.result.data)&&(a=o.result.data)),!a||a.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!o,hasResultResult:!!o?.result,resultType:typeof o?.result,result:o,resultKeys:o?Object.keys(o):[]}),n;const l=a.map((s,f)=>{f===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s).filter(m=>m.toLowerCase().includes("department")||m.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(s).slice(0,20)});const i=b(s);f===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:i.id,hasDepartmentHead:!!i.departmentHead,departmentHead:i.departmentHead,mappedTicketKeys:Object.keys(i).filter(m=>m.toLowerCase().includes("department"))});const u=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;f===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:u,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(s).filter(m=>m.toLowerCase().includes("department")||m.toLowerCase().includes("uf_crm"))});let d=null;if(u){const m=String(u).trim();m.length>0&&(d=m)}!d&&i.departmentHead&&(d=i.departmentHead);const p={...i,departmentHeadFull:d||i.departmentHead||null};return f===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:p.id,departmentHead:p.departmentHead,departmentHeadFull:p.departmentHeadFull}),p.id&&E.set(p.id,p),p});return[...n,...l]}catch(o){return console.error("[TicketDetailsService] Error loading tickets details batch:",o),console.error("[TicketDetailsService] Error details:",{message:o.message,stack:o.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),n}}static clearCache(t=1e3){E.size>t&&E.clear()}static getCacheSize(){return E.size}}async function le(e,t,n,r=null){if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:e,stageId:t,hasSnapshot:!!n,snapshotType:n?typeof n:"null",snapshotKeys:n?Object.keys(n):[],hasTickets:!!n?.tickets,ticketsIsArray:Array.isArray(n?.tickets),ticketsLength:n?.tickets?.length||0}),!e||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!n)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!n.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(n)),[];if(!Array.isArray(n.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof n.tickets),[];const o=n.tickets.filter(i=>{const u=i.assignedTo;return u?(typeof u=="object"?u.id:u)===e:!1});if(o.length===0)return[];const a=!o[0].stageId||!o[0].departmentHead;let l=null;if(a){const i=o.map(u=>u.id);if(r&&typeof r=="object")l=r;else try{const u=await v.getTicketsDetails(i);l=new Map,u.forEach(d=>{d&&d.id&&l.set(d.id,d)})}catch(u){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",u),l=null}}return o.map(i=>{const u=i.id,d={id:u,title:i.title||"Без названия",assignedTo:i.assignedTo,createdAt:i.createdAt,updatedAt:i.updatedAt};if(l){const p=l instanceof Map?l.get(u):l[u];p?(d.stageId=p.stageId||null,d.departmentHead=p.departmentHead||null,d.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=i.stageId||null,d.departmentHead=i.departmentHead||null,d.departmentHeadFull=i.departmentHeadFull||i.departmentHead||null;return d}).filter(i=>i.stageId?S(i.stageId)===t:!0)}function Oe(e,t=new Date){if(!e||e.length===0)return[];const n=e.length,r={};return Object.values(c).forEach(a=>{r[a]={category:a,label:O[a].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:O[a].color}}),e.forEach(a=>{if(!a.createdAt){r[c.MORE_THAN_YEAR].count++,r[c.MORE_THAN_YEAR].tickets.push(a);return}const l=M(a.createdAt,t);r[l]&&(r[l].count++,r[l].tickets.push(a))}),Object.values(r).filter(a=>a.count>0).map(a=>{const l=n>0?parseFloat((a.count/n*100).toFixed(1)):0;return{...a,percentage:l,progressBarWidth:l}}).sort((a,l)=>{const s=[c.TODAY,c.YESTERDAY,c.THIS_WEEK,c.LAST_WEEK,c.MORE_THAN_TWO_WEEKS,c.UP_TO_ONE_MONTH,c.MORE_THAN_TWO_MONTHS,c.MORE_THAN_HALF_YEAR,c.MORE_THAN_YEAR];return s.indexOf(a.category)-s.indexOf(l.category)})}function be(e){if(!e||e.length===0)return[];const t={};e.forEach(r=>{let o=r.departmentHeadFull||r.departmentHead;e.indexOf(r)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:r.id,departmentHead:r.departmentHead,departmentHeadFull:r.departmentHeadFull,allKeys:Object.keys(r).filter(a=>a.toLowerCase().includes("department"))}),o?(o=String(o).trim(),o.length===0&&(o="Без заказчика")):o="Без заказчика",t[o]||(t[o]={departmentName:o,count:0}),t[o].count++});const n=Object.values(t);return n.sort((r,o)=>o.count!==r.count?o.count-r.count:r.departmentName.localeCompare(o.departmentName,"ru")),n}function ie(e,t){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function ce(e,t){if(!e||!t)return{sourceLevel:2,employeeId:e?.employeeId||null,employeeName:e?.employeeName||null,stageId:e?.stageId||null,stageName:e?.stageName||null,dateCategory:null,dateCategoryLabel:null,departmentName:t?.departmentName||null,tickets:[],snapshot:e?.snapshot||null,ticketDetails:e?.ticketDetails||null};const n=T(e.tickets||[],t.departmentName);return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:n,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function de(e,t){const n=await le(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),r=K(n,e.dateCategory),o=T(r,t.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:t.departmentName,tickets:o,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function ue(e,t){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function fe(e,t){const n=(e.snapshot?.tickets||[]).filter(o=>o.stageId?S(o.stageId)===e.stageId:!1),r=T(n,t.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:r,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function pe(e,t){return!e||e.length===0?[]:e.filter(n=>n.stageId?S(n.stageId)===t:!1)}function me(e,t){return!e||e.length===0?[]:e.filter(n=>{const r=n.assignedTo;return r?(typeof r=="object"?r.id:r)===t:!1})}function K(e,t){if(!e||e.length===0)return[];const n=new Date;return e.filter(r=>r.createdAt?M(r.createdAt,n)===t:t===c.MORE_THAN_YEAR)}function T(e,t){return!e||e.length===0?[]:e.filter(n=>{let r=n.departmentHeadFull||n.departmentHead;return r?(r=String(r).trim(),r.length===0&&(r="Без заказчика")):r="Без заказчика",r===t})}async function ge(e){if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let s=e.tickets;return e.departmentName&&(s=T(s,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:s.length,departmentFilter:e.departmentName}),s}const{snapshot:t,stageId:n,employeeId:r,dateCategory:o,departmentName:a}=e;let l=t.tickets||[];return n&&(l=pe(l,n)),r&&(l=me(l,r)),o&&(l=K(l,o)),a&&(l=T(l,a)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:t.tickets?.length||0,filteredCount:l.length,filters:{stageId:n,employeeId:r,dateCategory:o,departmentName:a}}),l}function _e(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function Ee(e){return e.filter(t=>{const n=!t.ufSubject||t.ufSubject==="",r=t.actionStr===null||t.actionStr===void 0,o=!t.description||t.description==="";return n||r||o})}function Te(e){const t=new Map;return e&&(Array.isArray(e)?e.forEach(n=>{n&&n.id&&t.set(n.id,n)}):typeof e=="object"&&Object.keys(e).forEach(n=>{const r=e[n];r&&r.id&&t.set(r.id,r)})),t}function ye(e,t){const n=t.get(e.id)||null,r={id:e.id,title:e.title||"Без названия",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};r.ufSubject=n?.ufSubject||e.ufSubject||null;const o=n?.priorityId||e.priorityId||"unknown",a=n?.priorityLabel||e.priorityLabel||"Не указано",l=P(o);r.priorityId=o,r.priorityLabel=a,r.priorityColors=l,r.priority=o;const s=n?.service||e.service||V(),f=n?.serviceLabel||e.serviceLabel||s.label||"Не указано",i=W(s);return r.service=s,r.serviceLabel=f,r.serviceColors=i,r.actionStr=n?.actionStr||e.actionStr||e.ufActionStr||null,r.ufActionStr=r.actionStr,r.departmentHead=n?.departmentHead||e.departmentHead||null,r.departmentHeadFull=n?.departmentHeadFull||e.departmentHeadFull||e.departmentHead||null,r.description=n?.description||e.description||e.comments||"",r.assignedTo=e.assignedTo||null,r.assigneeId=e.assigneeId||e.assignedTo?.id||null,r.stageId=e.stageId||null,!r.status&&r.stageId?r.status=_e(r.stageId):r.status=e.status||"new",r}async function Ce(e,t=null,n=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const r=Ee(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:r.length,alreadyHaveDetails:e.length-r.length});let o=n||null;if(r.length>0&&!n){const s=r.map(f=>f.id).filter(f=>f);if(s.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:s.length,ticketIdsSample:s.slice(0,5)}),o=await v.getTicketsDetails(s),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:o?.length||0,sampleTicket:o?.[0]?{id:o[0].id,hasUfSubject:!!o[0].ufSubject,hasActionStr:!!o[0].actionStr,hasDescription:!!o[0].description}:null})}catch(f){console.warn("[ticketListUtils] Failed to load ticket details:",f),console.error("[ticketListUtils] Error details:",{message:f.message,stack:f.stack,ticketIdsCount:s.length}),o=null}}const a=Te(o),l=e.map(s=>ye(s,a));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:l.length,sampleTicket:l[0]?{id:l[0].id,hasUfSubject:!!l[0].ufSubject,hasPriorityColors:!!l[0].priorityColors,hasServiceColors:!!l[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),l}const Me=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:fe,createContextFromLevel1Time:ue,createContextFromLevel2:ie,createContextFromLevel2Department:ce,createContextFromLevel3:de,filterTicketsByContext:ge,filterTicketsByDepartment:T,prepareTicketsForDisplay:Ce},Symbol.toStringTag,{value:"Module"}));export{O as D,X as E,D as S,v as T,J as a,le as b,Oe as c,be as d,I as e,b as f,Ne as g,w as h,Re as i,P as j,he as k,De as l,S as m,Se as n,M as o,Ie as p,te as q,He as r,Me as t};
