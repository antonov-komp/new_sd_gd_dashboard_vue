import{_ as ie,a as E,o as D,d as u,F as ye,f as we,j as Y,n as Se,t as L,g as ve,b as H,G as Dt,i as le,H as vt,r as _,c as z,I as pt,m as ke,J as Be,k as Q,p as Re,K as Ge,x as Et,L as Ct,u as Pe,M as yt,C as wt,N as Fe,l as Le,B as Ze,D as $t,O as Tt,P as _t,y as Me,Q as he,z as At,e as It}from"./main-CHZA51T1.js";import{L as ft,D as xt,B as Bt}from"./index-DhmgRpKH.js";import{S as Ye,d as Xe,K as Rt,D as gt,e as mt,B as Mt}from"./index-CkabKxnM.js";const ne={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class oe{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,a={}){try{if(!e||typeof e!="object")throw new ge("sectorData Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new ge("type Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð´Ð½Ð¸Ð¼ Ð¸Ð·: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(e);if(!r.isValid)throw new ge(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const s=this.normalizeSectorData(e),i={metadata:this.generateSnapshotMetadata(t,a.createdBy,a.sectorId||ne.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},o=this.validateSnapshot(i);if(!o.isValid)throw new ge(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ ÑÐ»ÐµÐ¿ÐºÐ°: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ ÑÐ»ÐµÐ¿ÐºÐ°:",o.warnings);const c=this.getApiBaseUrl(),g=await fetch(`${c}${ne.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:i,type:t,date:this.formatDate(new Date)})});if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const h=await g.json();if(!h.success)throw new Error(h.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°");return h.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof ge?r:new ge(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}?action=get&date=${a}&type=${t}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.json();if(!i.success){if(i.message&&i.message.includes("Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"))return null;throw new Error(i.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°")}return i.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",ne.defaultSectorId);const r=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}?${t.toString()}`,s=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=await s.json();if(!n.success)throw new Error(n.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÑÐ»ÐµÐ¿ÐºÐ¾Ð²");return(await Promise.all(n.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(c){return console.warn(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ»ÐµÐ¿ÐºÐ° ${o.date}/${o.type}:`,c),null}}))).filter(o=>o!==null).sort((o,c)=>new Date(o.metadata.createdAt)-new Date(c.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:a=[],zeroPointTickets:r={}}=e,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"}},n=[],i=[],o=[];t.forEach(h=>{const d=h.id;if(s[d]){let b=0;h.employees.forEach(w=>{const m=w.tickets||[];b+=m.length;let f=n.find(y=>y.id===w.id);f||(f={id:w.id,name:w.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(f)),m.forEach(y=>{i.push(y.id),o.push({id:y.id,title:y.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:{id:w.id,name:w.name},createdAt:y.createdAt||"",updatedAt:y.modifiedAt||y.updatedAt||""}),f.ticketsByStage[d]=(f.ticketsByStage[d]||0)+1,f.totalTickets+=1})}),s[d].count=b}});const c={unassigned:0,keeper:0,total:0};Object.values(r).forEach(h=>{Array.isArray(h)&&h.forEach(d=>{c.total+=1,d.assigneeId===1051||d.assignedById===1051?c.keeper+=1:c.unassigned+=1,i.push(d.id),o.push({id:d.id,title:d.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const g=Object.values(s).reduce((h,d)=>h+d.count,0)+c.total;return{statistics:{stages:{...s,total:g},employees:n,zeroPoint:c},ticketIds:[...new Set(i)],tickets:o}}static generateSnapshotMetadata(e,t,a){const r=new Date,s=-r.getTimezoneOffset(),n=Math.floor(s/60),i=s%60,o=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(i).padStart(2,"0")}`,c=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${o}`;return{version:ne.snapshotVersion,createdAt:c,createdBy:t||{id:0,name:"Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°"},type:e,sectorId:a,sectorName:a==="1C"?"Ð¡ÐµÐºÑ‚Ð¾Ñ€ 1Ð¡":`Ð¡ÐµÐºÑ‚Ð¾Ñ€ ${a}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ð´Ð°Ñ‚Ð°");const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${r}`}static buildFilePath(e,t){const a=typeof e=="string"?new Date(e):e,r=a.getFullYear(),s=this.getWeekNumber(a),n=this.formatDate(e);let i;if(t==="current"){const o=new Date,c=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;i=`current-state-${n}-${c}.json`}else if(t==="manual"){const o=new Date,c=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;i=`manual-${n}-${c}.json`}else i=`${t}-${n}.json`;return t==="current"?`current/${i}`:`${r}/week-${s}/${i}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);const r=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-r)/864e5+1)/7)}static validateSnapshot(e){var r,s,n;const t=[],a=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð´Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ»ÐµÐ¿ÐºÐ°"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÑÐµÐºÑ‚Ð¾Ñ€Ð°"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¾Ð·Ð´Ð°Ñ‚ÐµÐ»Ðµ")):t.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¿ÐºÐ°"),!e.statistics)t.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°");else{if(!e.statistics.stages)t.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÑ‚Ð°Ð¿Ð°Ð¼");else{const i=e.statistics.stages,o=(((r=i.formed)==null?void 0:r.count)||0)+(((s=i.review)==null?void 0:s.count)||0)+(((n=i.execution)==null?void 0:n.count)||0);i.total!==o&&a.push(`ÐÐµÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²: Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ ${o}, ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ${i.total}`)}if(Array.isArray(e.statistics.employees)||t.push("Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),!e.statistics.zeroPoint)t.push("ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸");else{const i=e.statistics.zeroPoint,o=(i.unassigned||0)+(i.keeper||0);i.total!==o&&a.push(`ÐÐµÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸: Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ ${o}, ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ${i.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),!Array.isArray(e.tickets))t.push("tickets Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼");else{const i=new Set(e.ticketIds),o=new Set(e.tickets.map(c=>c.id));i.size!==o.size&&a.push("ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ID Ð² ticketIds Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²"),e.tickets.forEach((c,g)=>{c.id||t.push(`Ð¢Ð¸ÐºÐµÑ‚ #${g}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ID`),c.title||t.push(`Ð¢Ð¸ÐºÐµÑ‚ #${g}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº`),(!c.assignedTo||!c.assignedTo.id)&&a.push(`Ð¢Ð¸ÐºÐµÑ‚ #${g}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ)`),c.createdAt||t.push(`Ð¢Ð¸ÐºÐµÑ‚ #${g}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ`),c.updatedAt||t.push(`Ð¢Ð¸ÐºÐµÑ‚ #${g}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ`)})}return{isValid:t.length===0,errors:t,warnings:a}}static validateSectorData(e){const t=[],a=[];return!e||typeof e!="object"?(t.push("sectorData Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼"),{isValid:!1,errors:t,warnings:a}):(Array.isArray(e.stages)||t.push("stages Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),Array.isArray(e.employees)||t.push("employees Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼"),{isValid:t.length===0,errors:t,warnings:a})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:t})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.json();if(!i.success)throw new Error(i.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let a=0;for(const r of t)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&a++}catch(s){console.warn(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ° ${r.metadata.createdAt}:`,s)}return a}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=ne.snapshotVersion){const a=this.getSnapshotVersion(e);return a===t||a==="1.0"&&t==="1.0"?e:(console.warn(`ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ ${a} Ð½Ð° ${t} Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð°`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,a=this.getWeekNumber(t);return{year:t.getFullYear(),week:a}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,r=(t.getDay()||7)-1,s=new Date(t);return s.setDate(t.getDate()-r),s.setHours(0,0,0,0),s}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,r=7-(t.getDay()||7),s=new Date(t);return s.setDate(t.getDate()+r),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),a=this.getWeekEndDate(e),r=this.getWeekNumberInfo(e),s=await this.getAllSnapshots({startDate:t,endDate:a}),n=s.find(c=>c.metadata.type==="week_start")||null,i=s.find(c=>c.metadata.type==="week_end")||null,o=s.filter(c=>c.metadata.type==="manual");return{weekStart:n,weekEnd:i,manual:o,weekInfo:r}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof ge)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("Ð²ÐµÑ€ÑÐ¸Ñ")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("Ð´Ð¾ÑÑ‚ÑƒÐ¿")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),a={week_start:0,week_end:0,manual:0,current:0},r=new Map;let s=null,n=null;t.forEach(o=>{const c=o.metadata.type;a.hasOwnProperty(c)&&a[c]++;const g=this.getWeekNumberInfo(o.metadata.createdAt),h=`${g.year}-W${g.week}`;r.set(h,(r.get(h)||0)+1);const d=new Date(o.metadata.createdAt);(!s||d<new Date(s.metadata.createdAt))&&(s=o),(!n||d>new Date(n.metadata.createdAt))&&(n=o)});const i=Array.from(r.entries()).map(([o,c])=>{const[g,h]=o.split("-W");return{year:parseInt(g),week:parseInt(h),count:c}}).sort((o,c)=>o.year!==c.year?o.year-c.year:o.week-c.week);return{total:t.length,byType:a,byWeek:i,oldest:s,newest:n}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class ge extends Error{constructor(e,t,a={}){super(e),this.name="SnapshotError",this.code=t,this.details=a}}const re={formed:{bitrixId:Xe.formed,name:Ye.FORMED.name},review:{bitrixId:Xe.review,name:Ye.REVIEW.name},execution:{bitrixId:Xe.execution,name:Ye.EXECUTION.name}},Ee=Rt;function Ot(l){if(!l||typeof l!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!l.stages||!Array.isArray(l.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Nt(l.stages),t=Pt(l.stages),a=Ft(l.zeroPointTickets||{}),r=Lt(l.zeroPointTickets||{}),s=Wt(l.stages,l.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:a,zeroPointByStage:r},ticketIds:s.ticketIds,tickets:s.tickets}}function Nt(l){const e={formed:{count:0,stageId:re.formed.bitrixId,stageName:re.formed.name},review:{count:0,stageId:re.review.bitrixId,stageName:re.review.name},execution:{count:0,stageId:re.execution.bitrixId,stageName:re.execution.name},total:0};return l.forEach(t=>{if(!re[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let a=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(a+=r.tickets.length)}),e[t.id].count=a,e.total+=a}),e}function Pt(l){const e=new Map;return l.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(a=>{if(!a||!a.id)return;e.has(a.id)||e.set(a.id,{id:a.id,name:a.name||`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=e.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;re[t.id]&&(r.ticketsByStage[t.id]=(r.ticketsByStage[t.id]||0)+s),r.totalTickets+=s})}),Array.from(e.values())}function Ft(l){let e=0,t=0;return!l||typeof l!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(l).forEach(a=>{Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?e++:(typeof s=="object"?s.id:s)===Ee?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function Lt(l){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!l||typeof l!="object"||Object.keys(e).forEach(t=>{const a=l[t];Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?e[t].unassigned++:(typeof s=="object"?s.id:s)===Ee?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function Wt(l,e){const t=new Set,a=new Map;return Array.isArray(l)&&l.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const i=parseInt(n.id);if(isNaN(i)){console.warn("Invalid ticket ID:",n.id);return}t.add(i);let o=n.assignedTo;!o&&s.id&&(o={id:s.id,name:s.name||`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${s.id}`}),a.set(i,{id:i,title:n.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:o||null,createdAt:xe(n.createdAt||n.createdTime),updatedAt:xe(n.updatedAt||n.modifiedAt||n.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(r=>{Array.isArray(r)&&r.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const n=parseInt(s.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",s.id);return}t.add(n);let i=s.assignedTo;if(!i&&s.assignedById){const o=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;o&&o!==Ee?i={id:o,name:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹"}:o===Ee&&(i={id:Ee,name:"Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²"})}a.set(n,{id:n,title:s.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",assignedTo:i||null,createdAt:xe(s.createdAt||s.createdTime),updatedAt:xe(s.updatedAt||s.modifiedAt||s.updatedTime)})})}),{ticketIds:Array.from(t).sort((r,s)=>r-s),tickets:Array.from(a.values())}}function xe(l){if(!l)return null;if(l instanceof Date)return l.toISOString();if(typeof l=="string"){if(l.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return l;const e=new Date(l);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",l),null}class Qe{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:a=null,normalize:r=!0,includeTicketDetails:s=!1}=e;try{const n=await gt.getSectorData(t,a);return r?Ot(n):(s&&console.warn("includeTicketDetails Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾"),n)}catch(n){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",n),n}}static async isDataAvailable(){try{const e=await gt.getSectorData(!0);return e!=null}catch{return!1}}}class Je{static compareTwoSnapshots(e,t,a={}){const{includeTickets:r=!1,includeEmployees:s=!0}=a,n=this.validateSnapshot(e),i=this.validateSnapshot(t);if(!n.valid||!i.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...i.errors].join(", "));const o=this.buildComparisonMetadata(e,t),c=this.compareStages(e.statistics.stages,t.statistics.stages),g=s?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],h=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),d=r?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,b=this.buildSummary(c,g,h,d);return{metadata:o,stages:c,employees:g,zeroPoint:h,tickets:d,summary:b}}static calculateDelta(e,t){const a=this.normalizeValue(e),r=this.normalizeValue(t),s=r-a;let n=0;a!==0?n=s/a*100:r!==0&&(n=r>0?1/0:-1/0);const i=this.getTrend(s);return{value1:a,value2:r,delta:s,deltaPercent:Math.round(n*100)/100,trend:i}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var i,o;const a=["formed","review","execution"],r={};for(const c of a){const g=((i=e[c])==null?void 0:i.count)||0,h=((o=t[c])==null?void 0:o.count)||0;r[c]=this.calculateDelta(g,h)}const s=e.total||0,n=t.total||0;return r.total=this.calculateDelta(s,n),r}static compareEmployees(e,t){var i,o;const a=new Map(e.map(c=>[c.id,c])),r=new Map(t.map(c=>[c.id,c])),s=new Set([...a.keys(),...r.keys()]),n=[];for(const c of s){const g=a.get(c)||null,h=r.get(c)||null;if(!g||!h){n.push({id:c,name:(g==null?void 0:g.name)||(h==null?void 0:h.name)||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",snapshot1:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,snapshot2:h?{ticketsByStage:h.ticketsByStage||{},totalTickets:h.totalTickets||0}:null,delta:this.calculateEmployeeDelta(g,h),trend:g?"removed":"new"});continue}const d={},b=["formed","review","execution"];for(const m of b){const f=((i=g.ticketsByStage)==null?void 0:i[m])||0,y=((o=h.ticketsByStage)==null?void 0:o[m])||0;d[m]=this.calculateDelta(f,y)}const w=this.calculateDelta(g.totalTickets||0,h.totalTickets||0);n.push({id:c,name:g.name,snapshot1:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},snapshot2:{ticketsByStage:h.ticketsByStage||{},totalTickets:h.totalTickets||0},delta:{ticketsByStage:d,totalTickets:w},trend:w.trend})}return n}static calculateEmployeeDelta(e,t){var n,i;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},r=["formed","review","execution"];for(const o of r){const c=((n=e==null?void 0:e.ticketsByStage)==null?void 0:n[o])||0,g=((i=t==null?void 0:t.ticketsByStage)==null?void 0:i[o])||0;a[o]=this.calculateDelta(c,g)}const s=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,a,r){var b,w;const s=new Set(e),n=new Set(t),i=t.filter(m=>!s.has(m)),o=e.filter(m=>!n.has(m)),c=[],g=[],h=new Map(a.map(m=>[m.id,m])),d=new Map(r.map(m=>[m.id,m]));for(const m of e){if(!n.has(m))continue;const f=h.get(m),y=d.get(m);if(!f||!y)continue;const C=(((b=f.assignedTo)==null?void 0:b.id)||null)!==(((w=y.assignedTo)==null?void 0:w.id)||null),W=(f.stageId||null)!==(y.stageId||null);C||W?c.push(m):g.push(m)}return{new:i,removed:o,changed:c,unchanged:g}}static buildComparisonMetadata(e,t){const a=new Date(e.metadata.createdAt),r=new Date(t.metadata.createdAt),s=new Date,n=r.getTime()-a.getTime(),i=Math.floor(n/(1e3*60*60*24)),o=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),c=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:i,hours:o,minutes:c,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,t,a,r){var c,g,h;const s=e.total.delta,n=Object.keys(e).filter(d=>d==="total"?!1:e[d].delta!==0).length,i=t.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,o=s!==0||n>0||i>0;return{totalDelta:s,stagesChanged:n,employeesChanged:i,hasChanges:o,newTicketsCount:((c=r==null?void 0:r.new)==null?void 0:c.length)||0,removedTicketsCount:((g=r==null?void 0:r.removed)==null?void 0:g.length)||0,changedTicketsCount:((h=r==null?void 0:r.changed)==null?void 0:h.length)||0}}static validateSnapshot(e){const t=[],a=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:a};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const s of r)e.statistics.stages[s]||a.push(`Missing stage: ${s}`)}e.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:a}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const i=this.validateSnapshot(n);if(!i.valid)throw new Error("Invalid snapshot: "+i.errors.join(", "))}const a=[...e].sort((n,i)=>{const o=new Date(n.metadata.createdAt),c=new Date(i.metadata.createdAt);return o-c}),r=[];for(let n=0;n<a.length-1;n++)r.push({from:n,to:n+1,result:this.compareTwoSnapshots(a[n],a[n+1],t)});const s=this.buildTrends(a);return{snapshots:a.map((n,i)=>({index:i,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:r,trends:s}}static buildTrends(e){var a,r,s,n,i,o,c,g,h,d;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const b of e){const w=b.statistics;t.stages.formed.push(((r=(a=w.stages)==null?void 0:a.formed)==null?void 0:r.count)||0),t.stages.review.push(((n=(s=w.stages)==null?void 0:s.review)==null?void 0:n.count)||0),t.stages.execution.push(((o=(i=w.stages)==null?void 0:i.execution)==null?void 0:o.count)||0),t.stages.total.push(((c=w.stages)==null?void 0:c.total)||0),t.zeroPoint.unassigned.push(((g=w.zeroPoint)==null?void 0:g.unassigned)||0),t.zeroPoint.keeper.push(((h=w.zeroPoint)==null?void 0:h.keeper)||0),t.zeroPoint.total.push(((d=w.zeroPoint)==null?void 0:d.total)||0)}return t}}const Ut={class:"stages-container"},jt={class:"stages-chips"},Vt=["checked","disabled","onChange"],zt={class:"stage-chip-label"},Ht={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:l=>l.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(l,{emit:e}){const t=l,a=e;function r(s,n){const i={...t.selected};i[s]=n,a("update:selected",i),a("change",s,n)}return(s,n)=>(D(),E("div",Ut,[n[0]||(n[0]=u("h4",{class:"stages-title"},"Ð­Ñ‚Ð°Ð¿Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:",-1)),u("div",jt,[(D(!0),E(ye,null,we(l.stages,i=>(D(),E("label",{key:i.id,class:Y(["stage-chip",{"stage-chip--active":l.selected[i.id],"stage-chip--disabled":l.disabled}])},[u("input",{type:"checkbox",checked:l.selected[i.id],disabled:l.disabled,onChange:o=>r(i.id,o.target.checked)},null,40,Vt),u("span",{class:"stage-chip-color",style:Se({backgroundColor:i.color})},null,4),u("span",zt,L(i.name),1)],2))),128))])]))}},Kt=ie(Ht,[["__scopeId","data-v-fe03c03c"]]),qt={class:"modal-content"},Gt={class:"modal-header"},Yt={class:"modal-total"},Xt={class:"modal-body"},Jt={key:0,class:"no-employees"},Zt={key:1,class:"employees-list"},Qt={class:"employee-name"},ea={class:"employee-progress"},ta={class:"employee-count"},aa={key:0,class:"employee-item employee-others"},sa={class:"employee-name"},na={class:"employee-progress"},ra={class:"employee-count"},oa={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null}},emits:["close"],setup(l,{emit:e}){const t=e;function a(){t("close")}return(r,s)=>(D(),ve(vt,{to:"body"},[l.isVisible?(D(),E("div",{key:0,class:"employee-details-modal",onClick:le(a,["self"]),onKeydown:Dt(a,["esc"])},[u("div",qt,[u("div",Gt,[u("h3",null,L(l.stageName),1),u("span",Yt,"Ð’ÑÐµÐ³Ð¾: "+L(l.totalCount)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",1),u("button",{class:"modal-close",onClick:a,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"Ã—")]),u("div",Xt,[l.employees.length===0&&(!l.others||l.others.count===0)?(D(),E("div",Jt," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… ")):(D(),E("div",Zt,[(D(!0),E(ye,null,we(l.employees,n=>(D(),E("div",{key:n.id,class:Y(["employee-item",{"employee-keeper":n.isKeeper}])},[u("span",Qt,L(n.name),1),u("div",ea,[u("div",{class:"progress-bar",style:Se({width:n.progressBarWidth+"%",backgroundColor:n.progressBarColor})},null,4)]),u("span",ta,L(n.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+L(n.percentage)+"%) ",1)],2))),128)),l.others&&l.others.count>0?(D(),E("div",aa,[u("span",sa,"Ð”Ñ€ÑƒÐ³Ð¸Ðµ ("+L(l.others.employeeCount)+")",1),u("div",na,[u("div",{class:"progress-bar",style:Se({width:l.others.progressBarWidth+"%",backgroundColor:l.others.progressBarColor})},null,4)]),u("span",ra,L(l.others.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ("+L(l.others.percentage)+"%) ",1)])):H("",!0)]))])])],32)):H("",!0)]))}},la=ie(oa,[["__scopeId","data-v-0dca1c25"]]),be=10;function Oe(l,e){if(!e||!e.statistics)return[];const t=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(r=>r.ticketsByStage&&r.ticketsByStage[l]>0).forEach(r=>{t.push({id:r.id,name:r.name,count:r.ticketsByStage[l]||0})});const a=ia(l,e);return a>0&&t.push({id:1051,name:"Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² (ÐÐµÑ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ)",count:a,isKeeper:!0}),t.sort((r,s)=>s.count-r.count)}function ia(l,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[l])return e.statistics.zeroPointByStage[l].keeper||0;if(e.statistics.zeroPoint){const t=e.statistics.zeroPoint.keeper||0;return Math.floor(t/3)}return 0}function St(l,e){var t;return!e||!e.statistics||!e.statistics.stages?0:((t=e.statistics.stages[l])==null?void 0:t.count)||0}function Ne(l,e=be){if(!l||l.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const t=[...l].sort((n,i)=>i.count-n.count),a=t.slice(0,e),r=t.slice(e),s=r.reduce((n,i)=>n+i.count,0);return{visible:a,others:{employees:r,count:s,employeeCount:r.length}}}function kt(l,e){return!l||l.length===0?[]:e===0?l.map(t=>({...t,percentage:0})):l.map(t=>({...t,percentage:parseFloat((t.count/e*100).toFixed(1))}))}function bt(l,e,t="#007bff",a=be){if(!l||l.length===0)return{employees:[],others:null};const{visible:r,others:s}=Ne(l,a),n=kt(r,e).map(o=>({...o,progressBarWidth:o.percentage,progressBarColor:o.isKeeper?"#f59e0b":t}));let i=null;if(s.count>0){const o=parseFloat((s.count/e*100).toFixed(1));i={...s,percentage:o,progressBarWidth:o,progressBarColor:"#6c757d"}}return{employees:n,others:i}}function ca(l,e){const t={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(r=>{const s=e[r];if(!s)return;const n=Oe(l,s),i=St(l,s);if(n.length===0)return;const{visible:o,others:c}=Ne(n,be),g=kt(o,i);t[r]=g,c.count>0&&(t.others[r]={count:c.count,employeeCount:c.employeeCount,percentage:parseFloat((c.count/i*100).toFixed(1))})}),t}function ua(l,e="current",t=[]){const a=l[e];if(!a)return{labels:[],datasets:[]};const r=new Map;t.forEach(h=>{Oe(h.id,a).forEach(b=>{r.has(b.id)||r.set(b.id,{id:b.id,name:b.name,isKeeper:b.isKeeper||!1,ticketsByStage:{}}),r.get(b.id).ticketsByStage[h.id]=b.count})});const s=Array.from(r.values()).map(h=>{const d=Object.values(h.ticketsByStage).reduce((b,w)=>b+w,0);return{...h,totalTickets:d}});s.sort((h,d)=>d.totalTickets-h.totalTickets);const{visible:n,others:i}=Ne(s,be),o=t.map(()=>""),c={};t.forEach(h=>{const d=Oe(h.id,a),{visible:b}=Ne(d,be);c[h.id]=b.map(w=>({id:w.id,name:w.name,count:w.count}))});const g=n.map((h,d)=>{const b=t.map(m=>h.ticketsByStage[m.id]||0),w=t.map(m=>{if((h.ticketsByStage[m.id]||0)===0)return"transparent";const C=m.color.replace("#",""),W=parseInt(C.substring(0,2),16),G=parseInt(C.substring(2,4),16),U=parseInt(C.substring(4,6),16),O=.6+d*.05;return`rgba(${W}, ${G}, ${U}, ${Math.min(O,.95)})`});return{label:h.name,data:b,backgroundColor:w,borderColor:t.map(m=>{const f=m.color.replace("#",""),y=parseInt(f.substring(0,2),16),C=parseInt(f.substring(2,4),16),W=parseInt(f.substring(4,6),16);return`rgba(${y}, ${C}, ${W}, 0.8)`}),borderWidth:1,meta:{employeeId:h.id,employeeName:h.name}}});if(i.count>0){const h=t.map(d=>i.employees.reduce((b,w)=>b+(w.ticketsByStage[d.id]||0),0));g.push({label:`Ð”Ñ€ÑƒÐ³Ð¸Ðµ (${i.employeeCount})`,data:h,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:o,datasets:g,meta:{employeesByStage:c}}}function da(l,e,t=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const a=t.find(c=>c.id===l),r=a?a.name:"",s=a?a.color:"#007bff",n=Oe(l,e),i=St(l,e);if(n.length===0)return{stageName:r,totalCount:0,employees:[],others:null};const o=bt(n,i,s,be);return{stageName:r,totalCount:i,employees:o.employees,others:o.others}}function pa(l,e,t=.5){if(!e||!Array.isArray(e)||e.length===0||typeof l!="number"||l<0)return 0;(typeof t!="number"||t<=0)&&(console.warn("getOverlapCount: threshold Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ 0.5"),t=.5);const a=[];if(e.forEach((n,i)=>{if(!n||!n.data||!Array.isArray(n.data))return;const o=n.data[l];o!=null&&!isNaN(o)&&a.push({datasetIndex:i,value:Number(o),y:Number(o)})}),a.length<2)return 0;const r=[];return a.forEach(n=>{let i=!1;for(const o of r){const c=o.y;if(Math.abs(n.y-c)<t){o.points.push(n),o.y=o.points.reduce((h,d)=>h+d.y,0)/o.points.length,i=!0;break}}i||r.push({points:[n],y:n.y})}),r.length===0?0:r.reduce((n,i)=>i.points.length>n.points.length?i:n,r[0]).points.length}function fa(l,e){const t=[];return l.forEach(a=>{let r=!1;for(const s of t){const n=s.y;if(Math.abs(a.value-n)<e){s.points.push(a),s.y=s.points.reduce((i,o)=>i+o.value,0)/s.points.length,r=!0;break}}r||t.push({points:[a],y:a.value})}),t}function ga(l,e=.5){var s,n;if(!l)return console.warn("findOverlappingPoints: chart Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½"),[];if(!l.config||l.config.type!=="line")return[];const t=(s=l.data)==null?void 0:s.datasets,a=((n=l.data)==null?void 0:n.labels)||[];if(!t||!Array.isArray(t)||t.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof e!="number"||e<=0)&&(console.warn("findOverlappingPoints: threshold Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ 0.5"),e=.5);const r=[];return a.forEach((i,o)=>{try{if(pa(o,t,e)<2)return;const g=[];if(t.forEach((m,f)=>{if(!m||!m.data||!Array.isArray(m.data))return;const y=m.data[o];y==null||isNaN(y)||g.push({datasetIndex:f,value:Number(y),label:m.label||`Dataset ${f}`})}),g.length<2)return;const h=fa(g,e);if(h.length===0)return;const d=h.reduce((m,f)=>f.points.length>m.points.length?f:m,h[0]);if(d.points.length<2)return;let b=null,w=null;for(let m=0;m<t.length;m++)try{const f=l.getDatasetMeta(m);if(f&&f.data&&f.data[o]){b=f,w=f.data[o];break}}catch{continue}if(!w||typeof w.x!="number"||typeof w.y!="number")return;r.push({position:o,count:d.points.length,x:w.x,y:w.y,value:d.y,points:d.points.map(m=>({datasetIndex:m.datasetIndex,value:m.value,label:m.label}))})}catch(c){console.warn(`findOverlappingPoints: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ ${o}:`,c)}}),r}const ma=.5,ht=6,ha=2;function va(l){return typeof l!="number"||l<2?ht:ht+(l-1)*ha}function ya(l,e){if(!l||!l.ctx){console.warn("drawEnlargedPoint: chart Ð¸Ð»Ð¸ ctx Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½");return}if(!e||typeof e.x!="number"||typeof e.y!="number"){console.warn("drawEnlargedPoint: Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ overlap",e);return}const t=e.count;if(typeof t!="number"||t<2)return;const a=l.ctx,{x:r,y:s,points:n}=e,i=va(t);if(a.canvas){a.save();try{a.beginPath(),a.arc(r,s,i,0,2*Math.PI);let c="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&l.data&&l.data.datasets){const g=n[0].datasetIndex,h=l.data.datasets[g];if(h&&h.pointBackgroundColor){const d=Array.isArray(h.pointBackgroundColor)?h.pointBackgroundColor[e.position]||h.pointBackgroundColor[0]:h.pointBackgroundColor;if(d)if(d.startsWith("#")){const b=parseInt(d.slice(1,3),16),w=parseInt(d.slice(3,5),16),m=parseInt(d.slice(5,7),16);c=`rgba(${b}, ${w}, ${m}, 0.4)`}else d.startsWith("rgba")?c=d.replace(/rgba?\(([^)]+)\)/,(b,w)=>{const m=w.split(",").map(f=>f.trim());return`rgba(${m[0]}, ${m[1]}, ${m[2]}, 0.4)`}):c=d+"66"}}a.fillStyle=c,a.fill(),a.strokeStyle=c.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(c){console.warn("drawEnlargedPoint: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸:",c)}finally{a.restore()}}}const wa={id:"overlappingPointsPlugin",afterDatasetsDraw:l=>{if(!(!l||!l.config||l.config.type!=="line")&&l.ctx)try{const e=ga(l,ma);if(!Array.isArray(e)||e.length===0)return;e.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{ya(l,a)}catch(r){console.warn(`overlappingPointsPlugin: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ ${a.position}:`,r)}})}catch(e){console.warn("overlappingPointsPlugin: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² afterDatasetsDraw:",e)}}},Sa={class:"graph-state-chart"},ka={class:"chart-header"},ba={class:"chart-type-selector"},Da=["onClick","title"],Ea={class:"chart-type-icon"},Ca={class:"chart-type-label"},$a={key:0,class:"comparison-type-selector"},Ta={class:"radio-group"},_a={key:0},Aa={key:1},Ia={key:2,class:"graph-legend"},xa={key:4,class:"error-container"},Ba={class:"error-message"},Ra={key:5,class:"chart-container"},Ma={class:"chart-wrapper"},Oa={class:"chart-canvas-container"},Na={key:0,class:"bar-chart-stage-labels"},Pa={key:6,class:"no-data"},Fa={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(l,{emit:e}){const t=(k,p)=>typeof window>"u"?p:getComputedStyle(document.documentElement).getPropertyValue(k).trim()||p,a=l,r=e,s=_(!1),n=_(null),i=_(null),o=_({weekStart:null,weekEnd:null,current:null}),c=_(null),g=_("weekStartToWeekEnd"),h=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],d=_("line"),b=_(!1),w=_(""),m=_(0),f=_([]),y=_(null),C=_([]),W=z(()=>{switch(d.value){case"line":return ft;case"bar":return Bt;case"doughnut":return xt;default:return ft}}),G={formed:t("--b24-primary","#007bff"),review:t("--b24-warning","#ffc107"),execution:t("--b24-success","#28a745")},U=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:G.formed},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:G.review},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:G.execution}],O=["circle","triangle","rect","rectRot","star","cross","crossRot"],I=_({formed:!0,review:!0,execution:!0}),j=Pe(),J={id:"employeeLabelsPlugin",afterDatasetsDraw:k=>{if(k.config.type==="bar")try{const p=k.ctx;if(!k.data||!k.data.datasets)return;const v=k.data.datasets,S=k.scales.y;v.forEach((T,B)=>{const $=k.getDatasetMeta(B);if(!$||$.hidden)return;const N=T.label||"";if(!N||N.includes("Ð”Ñ€ÑƒÐ³Ð¸Ðµ"))return;const R=N.trim().split(/\s+/);let x="";if(R.length===1)x=R[0];else{const M=R[0],V=R.slice(1).join(" ");x=`${M}
${V}`}const F=x.split(`
`);T.data.forEach((M,V)=>{if(M===0||!M)return;const K=$.data[V];if(!K||typeof K.x!="number"||typeof K.y!="number")return;const Z=K.x,de=K.y+K.height+25;p.save(),p.font="bold 9px Arial, sans-serif",p.fillStyle="#6b7280",p.textAlign="center",p.textBaseline="top",p.translate(Z,de),p.rotate(-12*Math.PI/180),F.forEach((se,pe)=>{const fe=se.trim();fe&&p.fillText(fe,0,pe*11)}),p.restore()})})}catch(p){console.error("Error in employeeLabelsPlugin:",p)}}};pt.register(J);function ce(){const k=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(p=>{!p||!p.statistics||!p.statistics.employees||p.statistics.employees.forEach(v=>{k.has(v.id)||k.set(v.id,{id:v.id,name:v.name})})}),C.value=Array.from(k.values()).sort((p,v)=>p.name.localeCompare(v.name))}function ee(k,p="background"){var S;return((S={increase:{background:t("--b24-success","#28a745"),border:t("--b24-success-hover","#218838"),point:t("--b24-success","#28a745")},decrease:{background:t("--b24-danger","#dc3545"),border:t("--b24-danger-hover","#c82333"),point:t("--b24-danger","#dc3545")},stable:{background:t("--b24-text-muted","#9ca3af"),border:t("--b24-text-secondary","#6b7280"),point:t("--b24-text-muted","#9ca3af")}}[k])==null?void 0:S[p])||t("--b24-text-secondary","#6c757d")}function We(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const k=Je.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let p=null,v=null;o.value.current&&(p=Je.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),v=Je.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),c.value={weekStartToWeekEnd:k,weekEndToCurrent:p,weekStartToCurrent:v}}catch(k){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ¾Ð²:",k),j.warning("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ ÑÐ»ÐµÐ¿ÐºÐ¾Ð²: "+k.message)}}function me(k){return{"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ":"formed","Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—":"review",Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ:"execution"}[k]||"formed"}function Ce(k){return me(k)}function Ue(k){return k===0?"weekStart":k===1?"weekEnd":k===2?"current":"weekEnd"}function $e(k){return o.value[k]||null}function Te(k,p,v,S=null){w.value=k,m.value=p,f.value=v||[],y.value=S&&S.count>0?S:null,b.value=!0}function je(k,p,v){var N,R,x;const S=U.find(F=>F.id===k);if(!S)return;const T=$e(p);if(!T)return;const B=((x=(R=(N=T.statistics)==null?void 0:N.stages)==null?void 0:R[k])==null?void 0:x.count)||0,$=bt(v,B,S.color,10);Te(S.name,B,$.employees,$.others)}function Ve(k,p){if(!p||!p.employees||p.employees.length===0){j.warning("ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð°");return}Te(p.stageName,p.totalCount,p.employees,p.others)}function ze(){b.value=!1,w.value="",m.value=0,f.value=[],y.value=null}function _e(k,p,v){var F,M;if(d.value!=="line"||p.length===0)return;const S=p[0],T=S.datasetIndex,B=S.index,$=v.data.datasets[T];if(!$||!$.meta)return;const N=Ce($.label),R=Ue(B),x=(M=(F=$.meta)==null?void 0:F.employees)==null?void 0:M[R];!x||x.length===0||je(N,R,x)}function He(k,p,v){var F,M;if(d.value!=="doughnut"||p.length===0)return;const T=p[0].index,B=v.data,$=B.labels[T],N=Ce($),R=(M=(F=B.datasets[0])==null?void 0:F.meta)==null?void 0:M.employees,x=R==null?void 0:R[N];if(!x){console.warn("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÑ‚Ð°Ð¿Ð°:",N);return}Ve(N,x)}function A(k){var S;const p=U[k];if(!p)return 0;const v=o.value.current||o.value.weekEnd||o.value.weekStart;return!v||!v.statistics||!v.statistics.stages?0:((S=v.statistics.stages[p.id])==null?void 0:S.count)||0}function P(k){var T;const p=U.find(B=>B.id===k);if(!p)return"";const v=o.value.current||o.value.weekEnd||o.value.weekStart;if(!v||!v.statistics||!v.statistics.stages)return p.name;const S=((T=v.statistics.stages[k])==null?void 0:T.count)||0;return`${p.name} (${S})`}const te=z(()=>{if(!i.value)return null;if(d.value==="doughnut"||d.value==="bar")return i.value;const k=i.value.datasets.filter(p=>{const v=U.find(S=>S.name===p.label);return v?I.value[v.id]:!0});return{...i.value,datasets:k}});z(()=>d.value!=="bar"||!i.value||!i.value.meta?null:i.value.meta.employeesByStage||null);const Ae=z(()=>{const k={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(p,v,S)=>{d.value==="line"?_e(p,v,S):d.value==="doughnut"&&He(p,v,S)},onHover:(p,v,S)=>{d.value==="doughnut"&&(p.native.target.style.cursor=v.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",onClick:(p,v,S)=>{if(d.value==="bar"){const B=v.datasetIndex;if(B!==void 0){const $=S.chart.getDatasetMeta(B);$.hidden=!$.hidden,S.chart.update()}return}const T=v.datasetIndex;if(T!==void 0){const B=S.chart.getDatasetMeta(T);B.hidden=!B.hidden,S.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:p=>{if(d.value==="bar"){const v=p[0].dataIndex,S=U[v];return S?S.name:""}return p[0].label||""},label:p=>{var B,$,N,R,x,F;const v=p.dataset.label||"",S=p.parsed.y||p.parsed||0,T=p.dataIndex;if(d.value==="bar"){const M=p.dataset,V=p.dataIndex,K=U[V],Z=K?K.name:"";return`${M.label}: ${S} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ "${Z}"`}if(d.value==="doughnut"){const M=p.dataset.data.reduce((K,Z)=>K+Z,0),V=M>0?(S/M*100).toFixed(1):0;return`${v}: ${S} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² (${V}%)`}else{if(!c.value||T===0)return`${v}: ${S} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;let M=null;const V=me(v);if(g.value==="weekStartToWeekEnd"&&T===1?M=($=(B=c.value.weekStartToWeekEnd)==null?void 0:B.stages)==null?void 0:$[V]:g.value==="weekEndToCurrent"&&T===2&&o.value.current?M=(R=(N=c.value.weekEndToCurrent)==null?void 0:N.stages)==null?void 0:R[V]:g.value==="weekStartToCurrent"&&T===2&&o.value.current&&(M=(F=(x=c.value.weekStartToCurrent)==null?void 0:x.stages)==null?void 0:F[V]),!M)return`${v}: ${S} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;const K=M.delta,Z=M.deltaPercent,de=M.trend;let se=`${v}: ${S} Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²`;if(K!==0){const pe=K>0?"+":"",fe=de==="increase"?"â†‘":de==="decrease"?"â†“":"â†’";se+=` (${pe}${K}, ${pe}${Z.toFixed(1)}%) ${fe}`}else se+=" (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)";return se}},afterBody:p=>{if(d.value==="bar"&&p.length>0){const B=p[0];B.dataset;const $=B.parsed.y||0,N=B.dataIndex,R=A(N);return[`${R>0?($/R*100).toFixed(1):0}% Ð¾Ñ‚ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÑ‚Ð°Ð¿Ð°`]}if(d.value==="doughnut"&&p.length>0)return["ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼"];if(d.value==="line"){const B=[];if(c.value){const $=p[0].dataIndex;if($!==0){let N=null;if(me(p[0].dataset.label||""),g.value==="weekStartToWeekEnd"&&$===1?N=c.value.weekStartToWeekEnd:g.value==="weekEndToCurrent"&&$===2?N=c.value.weekEndToCurrent:g.value==="weekStartToCurrent"&&$===2&&(N=c.value.weekStartToCurrent),N&&N.metadata){const R=N.metadata.timeDiff;B.push(`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${R.days} Ð´Ð½. ${R.hours} Ñ‡. ${R.minutes} Ð¼Ð¸Ð½.`)}}}return B.push("ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°Ð¼"),B}if(!c.value)return[];const v=p[0].dataIndex;if(v===0)return[];let S=null;if(me(p[0].dataset.label||""),g.value==="weekStartToWeekEnd"&&v===1?S=c.value.weekStartToWeekEnd:g.value==="weekEndToCurrent"&&v===2?S=c.value.weekEndToCurrent:g.value==="weekStartToCurrent"&&v===2&&(S=c.value.weekStartToCurrent),!S||!S.metadata)return[];const T=S.metadata.timeDiff;return[`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${T.days} Ð´Ð½. ${T.hours} Ñ‡. ${T.minutes} Ð¼Ð¸Ð½.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...k,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...k,cutout:"60%"}:k});function X(k){const p=new Date(k),v=p.getFullYear(),S=String(p.getMonth()+1).padStart(2,"0"),T=String(p.getDate()).padStart(2,"0");return`${v}-${S}-${T}`}function Ie(k){const{current:p,weekEnd:v}=k,S=p||v;if(!S||!S.statistics||!S.statistics.stages)return null;const T=[],B=[],$=[],N=[],R={};return U.forEach(x=>{var M;const F=((M=S.statistics.stages[x.id])==null?void 0:M.count)||0;if(F>0){T.push(x.name),B.push(F),$.push(x.color+"80"),N.push(x.color);const V=da(x.id,S,U);V&&V.employees&&(R[x.id]=V)}}),B.length===0?null:{labels:T,datasets:[{label:"Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÑ‚Ð°Ð¿Ð°Ð¼",data:B,backgroundColor:$,borderColor:N,borderWidth:2,meta:{employees:R}}]}}function Ke(k){if(d.value==="doughnut")return Ie(k);if(d.value==="bar"){const $=a.showCurrentState&&k.current?"current":k.weekEnd?"weekEnd":"weekStart";return ua(k,$,U)}const{weekStart:p,weekEnd:v,current:S}=k,T=[],B=[];return U.forEach(($,N)=>{var Z,de,se,pe,fe,et,tt,at,st,nt,rt,ot,lt,it,ct,ut,dt;const R=[];if(p&&p.statistics&&p.statistics.stages){const q=p.statistics.stages[$.id];if(T.length===0){const De=(Z=p.metadata)!=null&&Z.createdAt?new Date(p.metadata.createdAt):null;T.push(De?X(De):"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸")}R.push((q==null?void 0:q.count)||0)}else T.length===0&&T.push("ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸"),R.push(0);if(v&&v.statistics&&v.statistics.stages){const q=v.statistics.stages[$.id];if(T.length===1){const De=(de=v.metadata)!=null&&de.createdAt?new Date(v.metadata.createdAt):null;T.push(De?X(De):"ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸")}R.push((q==null?void 0:q.count)||0)}else T.length===1&&T.push("ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸"),R.push(0);if(S&&a.showCurrentState&&S.statistics&&S.statistics.stages){const q=S.statistics.stages[$.id];T.length===2&&T.push("Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ"),R.push((q==null?void 0:q.count)||0)}const x=["stable"];c.value?g.value==="weekStartToWeekEnd"?(x.push(((fe=(pe=(se=c.value.weekStartToWeekEnd)==null?void 0:se.stages)==null?void 0:pe[$.id])==null?void 0:fe.trend)||"stable"),S&&x.push(((at=(tt=(et=c.value.weekStartToCurrent)==null?void 0:et.stages)==null?void 0:tt[$.id])==null?void 0:at.trend)||"stable")):g.value==="weekEndToCurrent"&&S?(x.push("stable"),x.push(((rt=(nt=(st=c.value.weekEndToCurrent)==null?void 0:st.stages)==null?void 0:nt[$.id])==null?void 0:rt.trend)||"stable")):g.value==="weekStartToCurrent"&&S?(x.push(((it=(lt=(ot=c.value.weekStartToWeekEnd)==null?void 0:ot.stages)==null?void 0:lt[$.id])==null?void 0:it.trend)||"stable"),x.push(((dt=(ut=(ct=c.value.weekStartToCurrent)==null?void 0:ct.stages)==null?void 0:ut[$.id])==null?void 0:dt.trend)||"stable")):(x.push("stable"),S&&x.push("stable")):(x.push("stable"),S&&x.push("stable"));let F,M,V;c.value&&d.value!=="doughnut"?(F=x.map(q=>ee(q,"background")+"40"),M=x.map(q=>ee(q,"border")),V=x.map(q=>ee(q,"point"))):(F=$.color+"40",M=$.color,V=$.color);let K=null;d.value==="line"&&(K={employees:ca($.id,k)}),B.push({label:$.name,data:R,backgroundColor:(Array.isArray(F),F),borderColor:(Array.isArray(M),M),borderWidth:2,...d.value==="line"&&{pointStyle:O[N%O.length]},pointBackgroundColor:(Array.isArray(V),V),pointBorderColor:(Array.isArray(M),M),pointRadius:6,pointHoverRadius:8,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:K})}),T.length===0&&(T.push("ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸","ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸"),a.showCurrentState&&T.push("Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ")),{labels:T,datasets:B}}const ue=async()=>{var k,p,v;s.value=!0,n.value=null;try{const S=(k=a.period)!=null&&k.endDate?new Date(a.period.endDate):new Date,T=(p=a.period)!=null&&p.startDate?new Date(a.period.startDate):oe.getWeekStartDate(S),B=(v=a.period)!=null&&v.endDate?new Date(a.period.endDate):oe.getWeekEndDate(S),$=oe.formatDate(T),N=oe.formatDate(B),[R,x]=await Promise.all([oe.getSnapshot($,"week_start"),oe.getSnapshot(N,"week_end")]);let F=null;a.showCurrentState&&(F=await Qe.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:R,weekEnd:x,current:F},ce(),We(),ae(),r("data-loaded",{weekStart:R,weekEnd:x,current:F})}catch(S){console.error("Error loading chart data:",S),n.value=S.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",j.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°: "+n.value),r("error",n.value)}finally{s.value=!1}};ke(()=>{pt.register(wa),ue()});function qe(k){I.value=k}const ae=()=>{var p;const k=Ke({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current});if(!i.value||!i.value.labels||i.value.labels.length!==((p=k==null?void 0:k.labels)==null?void 0:p.length))i.value=k;else if(k){const v=JSON.stringify(i.value),S=JSON.stringify(k);v!==S&&(i.value=k)}};return Be(()=>[a.period,a.showCurrentState],()=>{ue()},{deep:!0}),Be(d,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&ae()}),Be(g,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&ae()}),(k,p)=>(D(),E("div",Sa,[u("div",ka,[p[3]||(p[3]=u("h3",{class:"chart-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),u("div",ba,[(D(),E(ye,null,we(h,v=>u("button",{key:v.value,onClick:S=>d.value=v.value,class:Y(["chart-type-btn",{active:d.value===v.value}]),title:v.label},[u("span",Ea,L(v.icon),1),u("span",Ca,L(v.label),1)],10,Da)),64))])]),!s.value&&!n.value&&c.value&&d.value!=="doughnut"?(D(),E("div",$a,[p[7]||(p[7]=u("h4",{class:"comparison-title"},"Ð¢Ð¸Ð¿ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ:",-1)),u("div",Ta,[u("label",null,[Re(u("input",{type:"radio","onUpdate:modelValue":p[0]||(p[0]=v=>g.value=v),value:"weekStartToWeekEnd",onChange:ae},null,544),[[Ge,g.value]]),p[4]||(p[4]=u("span",null,"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸",-1))]),o.value.current?(D(),E("label",_a,[Re(u("input",{type:"radio","onUpdate:modelValue":p[1]||(p[1]=v=>g.value=v),value:"weekEndToCurrent",onChange:ae},null,544),[[Ge,g.value]]),p[5]||(p[5]=u("span",null,"ÐšÐ¾Ð½ÐµÑ† Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ",-1))])):H("",!0),o.value.current?(D(),E("label",Aa,[Re(u("input",{type:"radio","onUpdate:modelValue":p[2]||(p[2]=v=>g.value=v),value:"weekStartToCurrent",onChange:ae},null,544),[[Ge,g.value]]),p[6]||(p[6]=u("span",null,"ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸ â†’ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ",-1))])):H("",!0)])])):H("",!0),!s.value&&!n.value&&i.value?(D(),ve(Kt,{key:1,stages:U,selected:I.value,"onUpdate:selected":qe,onChange:ae},null,8,["selected"])):H("",!0),!s.value&&!n.value&&c.value&&d.value!=="doughnut"?(D(),E("div",Ia,[...p[8]||(p[8]=[Et('<h4 class="legend-title" data-v-7411ce1e>Ð›ÐµÐ³ÐµÐ½Ð´Ð°:</h4><div class="legend-items" data-v-7411ce1e><div class="legend-item" data-v-7411ce1e><span class="legend-color legend-increase" data-v-7411ce1e></span><span data-v-7411ce1e>Ð—ÐµÐ»Ñ‘Ð½Ñ‹Ð¹ â€” Ñ€Ð¾ÑÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²</span></div><div class="legend-item" data-v-7411ce1e><span class="legend-color legend-decrease" data-v-7411ce1e></span><span data-v-7411ce1e>ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹ â€” ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²</span></div><div class="legend-item" data-v-7411ce1e><span class="legend-color legend-stable" data-v-7411ce1e></span><span data-v-7411ce1e>Ð¡ÐµÑ€Ñ‹Ð¹ â€” Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹</span></div></div>',2)])])):H("",!0),s.value?(D(),ve(yt,{key:3,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°..."})):n.value?(D(),E("div",xa,[u("p",Ba,"âŒ "+L(n.value),1),u("button",{onClick:ue,class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ")])):te.value?(D(),E("div",Ra,[u("div",Ma,[u("div",Oa,[(D(),ve(Ct(W.value),{data:te.value,options:Ae.value},null,8,["data","options"]))]),d.value==="bar"?(D(),E("div",Na,[(D(),E(ye,null,we(U,v=>u("div",{key:v.id,class:"stage-label-item"},L(P(v.id)),1)),64))])):H("",!0)])])):(D(),E("div",Pa,[...p[9]||(p[9]=[u("p",null,"ðŸ“Š ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",-1),u("p",{class:"no-data-hint"},"Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ»ÐµÐ¿ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",-1)])])),Q(la,{"is-visible":b.value,"stage-name":w.value,"total-count":m.value,employees:f.value,others:y.value,onClose:ze},null,8,["is-visible","stage-name","total-count","employees","others"])]))}},La=ie(Fa,[["__scopeId","data-v-7411ce1e"]]),Wa={key:0,class:"create-snapshot-button-container"},Ua=["disabled"],ja={class:"modal-content"},Va={class:"modal-header"},za=["disabled"],Ha={class:"modal-body"},Ka={key:0,class:"progress-container"},qa={class:"progress-bar-wrapper"},Ga={class:"progress-text"},Ya={class:"progress-percent"},Xa={class:"progress-description"},Ja={key:1},Za={class:"modal-footer"},Qa=["disabled"],es=["disabled"],ts={key:0},as={key:0},ss={key:1},ns={key:2},rs={key:1},os={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(l,{emit:e}){const t=l,a=e,r=_(t.user),s=_(!1),n=_(!1),i=_(0),o=_("idle"),c=_(""),g=Pe(),h=z(()=>r.value?$t(r.value):!1);ke(async()=>{if(!t.user)try{const f=await wt.checkAccess();f.allowed&&(r.value=f.user)}catch(f){console.error("Error loading user:",f)}});const d=()=>{if(!h.value){g.warning("Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿ÐºÐ¸");return}s.value=!0},b=()=>{n.value||(s.value=!1,o.value="idle",i.value=0,c.value="")},w=async()=>{if(!n.value){if(!h.value){g.warning("Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿ÐºÐ¸");return}n.value=!0,o.value="loading_data",i.value=0,c.value="Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…...";try{c.value="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ð¸Ð· Bitrix24...";const f=await Qe.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:W=>{var U;const G=Math.min(80,(W.progress||0)*.8);i.value=G,o.value="loading_data",c.value=W.description||((U=W.details)==null?void 0:U.description)||"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°..."}});o.value="creating_snapshot",i.value=85,c.value="Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ¿ÐºÐ°...";const y=r.value;if(!y)throw new Error("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½");const C=await oe.createSnapshot(f,"manual",{createdBy:{id:y.ID,name:`${y.NAME||""} ${y.LAST_NAME||""}`.trim()||y.EMAIL||`User ${y.ID}`},sectorId:"1C"});o.value="success",i.value=100,c.value="Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!",g.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"),a("snapshot-created",C),setTimeout(()=>{b()},1500)}catch(f){o.value="error",i.value=0,c.value="ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°",console.error("Error creating snapshot:",f);let y="ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°";f.message&&(f.message.includes("Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…")||f.message.includes("sector data")?y="ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Bitrix24.":f.message.includes("ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°")||f.message.includes("snapshot")?y="ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.":f.message.includes("Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†")||f.message.includes("validation")?y="ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð°.":y=f.message),g.error(y)}finally{n.value=!1}}},m=f=>{f.key==="Escape"&&s.value&&!n.value&&b()};return ke(()=>{window.addEventListener("keydown",m)}),Fe(()=>{window.removeEventListener("keydown",m)}),(f,y)=>h.value?(D(),E("div",Wa,[u("button",{class:"create-snapshot-btn",onClick:d,disabled:n.value,title:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð°"},[...y[1]||(y[1]=[u("span",{class:"btn-icon"},"ðŸ“¸",-1),u("span",{class:"btn-text"},"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº",-1)])],8,Ua),(D(),ve(vt,{to:"body"},[Q(Ze,{name:"modal"},{default:Le(()=>[s.value?(D(),E("div",{key:0,class:"modal-overlay",onClick:y[0]||(y[0]=le(C=>!n.value&&b(),["self"]))},[u("div",ja,[u("div",Va,[y[2]||(y[2]=u("h3",{class:"modal-title"},"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ¿Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð°",-1)),u("button",{class:"modal-close",onClick:b,disabled:n.value,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ",8,za)]),u("div",Ha,[o.value!=="idle"?(D(),E("div",Ka,[u("div",qa,[u("div",{class:"progress-bar",style:Se({width:`${i.value}%`})},null,4)]),u("div",Ga,[u("span",Ya,L(Math.round(i.value))+"%",1),u("span",Xa,L(c.value),1)])])):(D(),E("div",Ja,[...y[3]||(y[3]=[u("p",{class:"modal-description"},' Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ ÑÐ»ÐµÐ¿Ð¾Ðº Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡. Ð¡Ð»ÐµÐ¿Ð¾Ðº Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼ "manual" (Ñ€ÑƒÑ‡Ð½Ð¾Ð¹). ',-1),u("p",{class:"modal-warning"}," âš ï¸ ÐŸÑ€Ð¾Ñ†ÐµÑÑ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ° Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ. ",-1)])]))]),u("div",Za,[u("button",{class:"btn btn-secondary",onClick:b,disabled:n.value}," ÐžÑ‚Ð¼ÐµÐ½Ð° ",8,Qa),u("button",{class:"btn btn-primary",onClick:w,disabled:n.value},[n.value?(D(),E("span",ts,[o.value==="loading_data"?(D(),E("span",as,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…...")):o.value==="creating_snapshot"?(D(),E("span",ss,"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...")):(D(),E("span",ns,"ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°..."))])):(D(),E("span",rs,"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"))],8,es)])])])):H("",!0)]),_:1})]))])):H("",!0)}},ls=ie(os,[["__scopeId","data-v-09bccee2"]]),is=20,cs=5*60*1e3;async function us({search:l="",limit:e=is,sectorDepartmentId:t=mt.SECTOR_1C}={}){const a=`sector1c_employees_${l}_${e}_${t||"all"}`,r=sessionStorage.getItem(a);if(r)try{const{data:s,timestamp:n}=JSON.parse(r);if(Date.now()-n<cs)return s}catch(s){console.warn("[sector1cEmployees] Cache parse error:",s)}try{const s={ACTIVE:"Y"};t?Array.isArray(t)?s.UF_DEPARTMENT=t:s.UF_DEPARTMENT=[t]:s.UF_DEPARTMENT=[mt.SECTOR_1C],l&&l.length>=2&&(s["%NAME"]=l,s["%LAST_NAME"]=l,s["%WORK_POSITION"]=l);const o=((await Mt.call("user.get",{filter:s,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,e).map(c=>({id:parseInt(c.ID),name:ds(c),position:c.WORK_POSITION||"",department:c.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:o,timestamp:Date.now()}))}catch(c){console.warn("[sector1cEmployees] Cache write error:",c)}return o}catch(s){throw console.error("[sector1cEmployees] ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²:",s),new Error(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²: ${s.message}`)}}function ds(l){const e=[l.LAST_NAME,l.NAME,l.SECOND_NAME].filter(Boolean);return e.length>0?e.join(" "):l.NAME||"Ð‘ÐµÐ· Ð¸Ð¼ÐµÐ½Ð¸"}const ps={class:"employee-select-field-text"},fs={key:0,class:"employee-select-dropdown"},gs={class:"employee-select-dropdown-search"},ms={key:0,class:"employee-select-state"},hs={key:1,class:"employee-select-state employee-select-state--error"},vs={key:2,class:"employee-select-state"},ys=["checked"],ws=["checked","onChange"],Ss={class:"employee-select-item-content"},ks={class:"employee-select-item-name"},bs={key:0,class:"employee-select-item-position"},Ds={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(l,{emit:e}){const t=l,a=e,r=_(null),s=_(null),n=_(""),i=_([]),o=_(!1),c=_(null),g=_(!1),h=z(()=>{if(!n.value)return i.value;const O=n.value.toLowerCase();return i.value.filter(I=>I.name.toLowerCase().includes(O)||I.position&&I.position.toLowerCase().includes(O))}),d=z(()=>{if(t.selected.includes("all")||t.selected.length===0)return t.placeholder;if(t.selected.length===1){const O=i.value.find(I=>I.id===t.selected[0]);return O?O.name:t.placeholder}return`Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: ${t.selected.length} ${G(t.selected.length,"ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°","ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²","ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²")}`});async function b(O=""){o.value=!0,c.value=null;try{i.value=await us({search:O})}catch(I){c.value=I,a("error",I)}finally{o.value=!1}}function w(){a("search",n.value)}function m(){o.value||(g.value=!g.value,g.value?(i.value.length===0&&b(),_t(()=>{s.value&&s.value.focus()})):n.value="")}function f(O){r.value&&!r.value.contains(O.target)&&(g.value=!1,n.value="")}function y(O){const I=[...t.selected],j=I.indexOf(O);if(O==="all")if(j>-1)I.splice(j,1);else return a("update:selected",["all"]);else if(j>-1)I.splice(j,1);else{const J=I.indexOf("all");J>-1&&I.splice(J,1),I.push(O)}a("update:selected",I)}function C(O){return O==="all"?t.selected.includes("all"):t.selected.includes(O)||t.selected.includes("all")}const W=z(()=>n.value?`ÐÐµÑ‚ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ "${n.value}"`:"ÐÐµÑ‚ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡");function G(O,I,j,J){const ce=O%10,ee=O%100;return ee>=11&&ee<=19?J:ce===1?I:ce>=2&&ce<=4?j:J}function U(){b(n.value)}return Be(()=>t.selected,O=>{(!O||O.length===0)&&a("update:selected",["all"])},{immediate:!0}),ke(()=>{document.addEventListener("click",f),(!t.selected||t.selected.length===0)&&a("update:selected",["all"])}),Fe(()=>{document.removeEventListener("click",f)}),(O,I)=>(D(),E("div",{class:"employee-select",ref_key:"selectContainer",ref:r},[u("div",{class:Y(["employee-select-field",{"employee-select-field--open":g.value,"employee-select-field--disabled":o.value}]),onClick:m},[u("span",ps,L(d.value),1),u("span",{class:Y(["employee-select-field-icon",{open:g.value}])},"â–¼",2)],2),Q(Ze,{name:"dropdown-fade"},{default:Le(()=>[g.value?(D(),E("div",fs,[u("div",gs,[Re(u("input",{"onUpdate:modelValue":I[0]||(I[0]=j=>n.value=j),type:"text",placeholder:"ðŸ” ÐŸÐ¾Ð¸ÑÐº ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°...",class:"employee-select-search-input",onInput:w,onClick:I[1]||(I[1]=le(()=>{},["stop"])),ref_key:"searchInput",ref:s},null,544),[[Tt,n.value]])]),o.value?(D(),E("div",ms,[...I[6]||(I[6]=[u("span",{class:"spinner"},"â³",-1),u("span",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡...",-1)])])):c.value?(D(),E("div",hs,[u("span",null,"âŒ "+L(c.value.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²"),1),u("button",{onClick:[U,I[2]||(I[2]=le(()=>{},["stop"]))],class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ")])):!o.value&&h.value.length===0&&!c.value?(D(),E("div",vs,[u("span",null,"ðŸ“­ "+L(W.value),1)])):(D(),E("div",{key:3,class:"employee-select-list",style:Se({maxHeight:`${l.maxHeight}px`})},[u("label",{class:Y(["employee-select-item",{"employee-select-item--selected":C("all")}]),onClick:I[4]||(I[4]=le(()=>{},["stop"]))},[u("input",{type:"checkbox",checked:C("all"),onChange:I[3]||(I[3]=j=>y("all"))},null,40,ys),I[7]||(I[7]=u("div",{class:"employee-select-item-content"},[u("span",{class:"employee-select-item-name"},"Ð’ÑÐµ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸")],-1))],2),(D(!0),E(ye,null,we(h.value,j=>(D(),E("label",{key:j.id,class:Y(["employee-select-item",{"employee-select-item--selected":C(j.id)}]),onClick:I[5]||(I[5]=le(()=>{},["stop"]))},[u("input",{type:"checkbox",checked:C(j.id),onChange:J=>y(j.id)},null,40,ws),u("div",Ss,[u("span",ks,L(j.name),1),j.position?(D(),E("span",bs,L(j.position),1)):H("",!0)])],2))),128))],4))])):H("",!0)]),_:1})],512))}},Es=ie(Ds,[["__scopeId","data-v-6b8c949b"]]),Cs={class:"stage-select-field-text"},$s={key:0,class:"stage-select-dropdown"},Ts={class:"stage-select-list"},_s=["checked"],As=["checked","onChange"],Is={class:"stage-select-item-content"},xs={class:"stage-select-item-name"},Bs={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff"},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107"},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745"}]},placeholder:{type:String,default:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð¿Ñ‹"}},emits:["update:selected","change"],setup(l,{emit:e}){const t=l,a=e,r=_(null),s=_(!1),n=z(()=>Object.values(t.selected).every(d=>d===!0)),i=z(()=>{if(n.value)return t.placeholder;const d=t.stages.filter(b=>t.selected[b.id]);return d.length===0?"Ð­Ñ‚Ð°Ð¿Ñ‹ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹":d.length===1?d[0].name:`Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: ${d.length} ÑÑ‚Ð°Ð¿Ð°(Ð¾Ð²)`});function o(){s.value=!s.value,s.value}function c(d){r.value&&!r.value.contains(d.target)&&(s.value=!1)}function g(d,b){const w={...t.selected};w[d]=b,a("update:selected",w),a("change",d,b)}function h(){const d=n.value,b={};t.stages.forEach(w=>{b[w.id]=!d}),a("update:selected",b),a("change","all",!d)}return ke(()=>{document.addEventListener("click",c)}),Fe(()=>{document.removeEventListener("click",c)}),(d,b)=>(D(),E("div",{class:"stage-select",ref_key:"selectContainer",ref:r},[u("div",{class:Y(["stage-select-field",{"stage-select-field--open":s.value,"stage-select-field--disabled":!1}]),onClick:o},[u("span",Cs,L(i.value),1),u("span",{class:Y(["stage-select-field-icon",{open:s.value}])},"â–¼",2)],2),Q(Ze,{name:"dropdown-fade"},{default:Le(()=>[s.value?(D(),E("div",$s,[u("div",Ts,[u("label",{class:Y(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:b[0]||(b[0]=le(()=>{},["stop"]))},[u("input",{type:"checkbox",checked:n.value,onChange:h},null,40,_s),b[2]||(b[2]=u("div",{class:"stage-select-item-content"},[u("span",{class:"stage-select-item-name"},"Ð’ÑÐµ ÑÑ‚Ð°Ð¿Ñ‹")],-1))],2),(D(!0),E(ye,null,we(l.stages,w=>(D(),E("label",{key:w.id,class:Y(["stage-select-item",{"stage-select-item--selected":l.selected[w.id]}]),onClick:b[1]||(b[1]=le(()=>{},["stop"]))},[u("input",{type:"checkbox",checked:l.selected[w.id],onChange:m=>g(w.id,m.target.checked)},null,40,As),u("div",Is,[u("span",{class:"stage-select-item-color",style:Se({backgroundColor:w.color})},null,4),u("span",xs,L(w.name),1)])],2))),128))])])):H("",!0)]),_:1})],512))}},Rs=ie(Bs,[["__scopeId","data-v-ce2229b2"]]),Ms={class:"filters-panel"},Os={class:"filters-header"},Ns=["disabled"],Ps={class:"filters-content"},Fs={class:"filter-section"},Ls={class:"section-content"},Ws={class:"filter-section"},Us={class:"section-content"},js={class:"filter-section"},Vs={class:"section-content"},zs=["value"],Hs={key:0,class:"custom-date-range"},Ks={class:"date-range-inputs"},qs={class:"date-input-group"},Gs=["value","max"],Ys={class:"date-input-group"},Xs=["value","min","max"],Js={key:0,class:"filter-error"},Zs={key:1,class:"filter-hint"},Qs={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(l,{emit:e}){const t=l,a=e,r=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"var(--b24-success, #28a745)"}],s=_(null),n=z(()=>{const w=new Date;return w.setFullYear(w.getFullYear()-1),w.toISOString().split("T")[0]}),i=z(()=>new Date().toISOString().split("T")[0]);function o(w){a("update:stages",w),a("apply")}function c(w,m){a("apply")}function g(w){a("update:employees",w),a("apply")}function h(w){a("update:dateRange",w),s.value=null,a("apply")}function d(w,m){const f={...t.customDateRange};if(f[w]=m,f.startDate&&f.endDate){const y=new Date(f.startDate),C=new Date(f.endDate);if(y>C){s.value="ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð°Ñ‚Ð° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ð¹";return}if(Math.ceil((C-y)/(1e3*60*60*24))>365){s.value="ÐŸÐµÑ€Ð¸Ð¾Ð´ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 365 Ð´Ð½ÐµÐ¹";return}}s.value=null,a("update:customDateRange",f),a("apply")}function b(){s.value=null,a("reset")}return(w,m)=>(D(),E("div",Ms,[u("div",Os,[m[3]||(m[3]=u("h2",null,"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹",-1)),u("button",{onClick:b,class:"btn-reset-filters",disabled:!l.hasActiveFilters}," Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ",8,Ns)]),u("div",Ps,[u("div",Fs,[m[4]||(m[4]=u("h3",{class:"section-title"},[u("span",{class:"section-icon"},"ðŸ“Š"),Me(" Ð­Ñ‚Ð°Ð¿Ñ‹ ")],-1)),u("div",Ls,[Q(Rs,{selected:l.stages,stages:r,placeholder:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð¿Ñ‹","onUpdate:selected":o,onChange:c},null,8,["selected"])])]),u("div",Ws,[m[5]||(m[5]=u("h3",{class:"section-title"},[u("span",{class:"section-icon"},"ðŸ‘¥"),Me(" Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡ ")],-1)),u("div",Us,[Q(Es,{selected:l.employees,"onUpdate:selected":g},null,8,["selected"])])]),u("div",js,[m[9]||(m[9]=u("h3",{class:"section-title"},[u("span",{class:"section-icon"},"ðŸ“…"),Me(" ÐŸÐµÑ€Ð¸Ð¾Ð´ ")],-1)),u("div",Vs,[u("select",{value:l.dateRange,onChange:m[0]||(m[0]=f=>h(f.target.value)),class:"date-range-select"},[...m[6]||(m[6]=[u("option",{value:"last-week"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð½ÐµÐ´ÐµÐ»Ñ",-1),u("option",{value:"last-2-weeks"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 2 Ð½ÐµÐ´ÐµÐ»Ð¸",-1),u("option",{value:"last-month"},"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†",-1),u("option",{value:"custom"},"ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´",-1)])],40,zs),l.dateRange==="custom"?(D(),E("div",Hs,[u("div",Ks,[u("div",qs,[m[7]||(m[7]=u("label",null,"Ð¡:",-1)),u("input",{type:"date",value:l.customDateRange.startDate,onChange:m[1]||(m[1]=f=>d("startDate",f.target.value)),max:l.customDateRange.endDate||i.value,class:"date-input"},null,40,Gs)]),u("div",Ys,[m[8]||(m[8]=u("label",null,"ÐŸÐ¾:",-1)),u("input",{type:"date",value:l.customDateRange.endDate,onChange:m[2]||(m[2]=f=>d("endDate",f.target.value)),min:l.customDateRange.startDate||n.value,max:i.value,class:"date-input"},null,40,Xs)])]),s.value?(D(),E("small",Js,L(s.value),1)):(D(),E("small",Zs," Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… "))])):H("",!0)])])])]))}},en=ie(Qs,[["__scopeId","data-v-4b7456a2"]]);function tn(){const l=_(!1),e=_(null),t=_(null),a=_(0),r=Pe(),s=async(f=!0,y=null)=>{l.value=!0,e.value=null,a.value=0;try{const C=await Qe.getSectorDataForSnapshot({useCache:f,onProgress:W=>{W&&typeof W.progress=="number"&&(a.value=W.progress),y&&y(W)},normalize:!0});return t.value=C,C}catch(C){throw e.value=C.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°",r.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÐºÑ‚Ð¾Ñ€Ð°: "+e.value),C}finally{l.value=!1,a.value=100}},n=async(f,y={})=>{if(!t.value){const C="Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ñ‡ÐµÑ€ÐµÐ· loadSectorDataForSnapshot()";throw e.value=C,r.error(C),new Error(C)}l.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(f))throw new Error(`ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ»ÐµÐ¿ÐºÐ°: ${f}. Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ: week_start, week_end, manual, current`);const C=await oe.createSnapshot(t.value,f,y);return r.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"),C}catch(C){throw e.value=C.message||"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°",r.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ»ÐµÐ¿ÐºÐ°: "+e.value),C}finally{l.value=!1}},i=()=>{l.value=!1,e.value=null,t.value=null,a.value=0},o=z(()=>t.value!==null&&t.value!==void 0),c=_({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),g=z(()=>{const f=new Date;let y,C;switch(c.value.dateRange){case"last-week":y=new Date(f),y.setDate(f.getDate()-7),C=f;break;case"last-2-weeks":y=new Date(f),y.setDate(f.getDate()-14),C=f;break;case"last-month":y=new Date(f),y.setMonth(f.getMonth()-1),C=f;break;case"custom":y=c.value.customDateRange.startDate?new Date(c.value.customDateRange.startDate):null,C=c.value.customDateRange.endDate?new Date(c.value.customDateRange.endDate):null;break;default:y=new Date(f),y.setDate(f.getDate()-7),C=f}return{startDate:y?y.toISOString().split("T")[0]:null,endDate:C?C.toISOString().split("T")[0]:null}}),h=()=>{b()},d=()=>{c.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},b()},b=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(c.value))}catch(f){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð² Ð² localStorage:",f)}},w=()=>{try{const f=localStorage.getItem("graphStateFilters");if(f){const y=JSON.parse(f);y&&typeof y=="object"&&(c.value={stages:y.stages||{formed:!0,review:!0,execution:!0},employees:y.employees||["all"],dateRange:y.dateRange||"last-week",customDateRange:y.customDateRange||{startDate:null,endDate:null}})}}catch(f){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð² Ð¸Ð· localStorage:",f)}},m=z(()=>{const f=Object.values(c.value.stages).some(W=>!W),y=!c.value.employees.includes("all"),C=c.value.dateRange!=="last-week";return f||y||C});return{isLoading:l,error:e,currentSectorData:t,loadingProgress:a,hasSectorData:o,filters:c,selectedPeriod:g,hasActiveFilters:m,loadSectorDataForSnapshot:s,createSnapshot:n,resetState:i,applyFilters:h,resetFilters:d,saveFiltersToLocalStorage:b,loadFiltersFromLocalStorage:w}}const an={class:"graph-state-dashboard"},sn={key:1,class:"error-message-container"},nn={class:"error-message"},rn={class:"error-text"},on={key:0,class:"error-details"},ln={class:"dashboard-header"},cn={class:"header-content"},un={class:"breadcrumbs-row"},dn=["aria-disabled","data-fallback","disabled"],pn={class:"breadcrumbs","aria-label":"ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ"},fn={class:"header-actions"},gn=["disabled"],mn={key:0},hn={key:1},vn={key:3,class:"dashboard-content"},yn={class:"chart-container"},wn="ÐÐ°Ð·Ð°Ð´",Sn={__name:"GraphStateDashboard",setup(l){const e=(A,P)=>typeof window>"u"?P:getComputedStyle(document.documentElement).getPropertyValue(A).trim()||P,t=Pe(),a=At(),r={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:n,hasActiveFilters:i,applyFilters:o,resetFilters:c,loadFiltersFromLocalStorage:g}=tn(),h=_(null),d=_(!0),b=_(!1),w=_("Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."),m=_(null),f=_(!1),y=_(!1),C=_(typeof window<"u"?window.innerWidth:1024),W=_(null),G=_(!1),U=z(()=>C.value<768);z(()=>C.value>=768&&C.value<1024),z(()=>C.value>=1024);const O=z(()=>typeof window>"u"?!1:window.history.length>1);z(()=>{const A=new Date;return A.setFullYear(A.getFullYear()-1),A.toISOString().split("T")[0]}),z(()=>new Date().toISOString().split("T")[0]);function I(A){s.value.stages=A}function j(A){s.value.employees=A}function J(A){s.value.dateRange=A}function ce(A){s.value.customDateRange=A}function ee(){o()}function We(){c(),W.value=null,ee(),t.info("Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹")}function me(A){t.success("Ð¡Ð»ÐµÐ¿Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½")}function Ce(A){b.value=!1,w.value="",console.log("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹:",A)}function Ue(A){b.value=!1,$e({message:A||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°",details:null,type:"error"})}function $e(A){m.value={message:A.message||"ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°",details:A.details||null,type:A.type||"error",timestamp:new Date},console.error("Dashboard error:",m.value),t.error(m.value.message)}function Te(){m.value=null}function je(){m.value=null,b.value=!0,w.value="ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."}async function Ve(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² PDF Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ jspdf Ð¸ html2canvas."),console.warn("Ð”Ð»Ñ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: npm install jspdf html2canvas");return}f.value=!0;try{const A=document.querySelector(".chart-container");if(!A)throw new Error("Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");const P=window.html2canvas,te=await P(A,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),Ae=window.jsPDF,X=new Ae("landscape","mm","a4"),Ie=297,Ke=te.height*Ie/te.width;X.setFontSize(18),X.text("Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",148.5,15,{align:"center"});const ue=new Date().toLocaleDateString("ru-RU");X.setFontSize(10);const qe=n.value.startDate&&n.value.endDate?`ÐŸÐµÑ€Ð¸Ð¾Ð´: ${n.value.startDate} - ${n.value.endDate}`:"ÐŸÐµÑ€Ð¸Ð¾Ð´: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½";X.text(qe,148.5,25,{align:"center"}),X.text(`Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚ ${ue}`,148.5,30,{align:"center"}),X.addImage(te.toDataURL("image/png"),"PNG",10,35,Ie-20,Ke-20),X.setProperties({title:"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",subject:`Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚ ${ue}`,author:"Bitrix24 Dashboard"});const ae=`graph-state-${ue.replace(/\//g,"-")}.pdf`;X.save(ae),t.success("Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² PDF")}catch(A){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF:",A),$e({message:"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² PDF: "+(A.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"),details:A.stack,type:"error"})}finally{f.value=!1}}function ze(A){var P;if((P=A==null?void 0:A.preventDefault)==null||P.call(A),!G.value){G.value=!0;try{if(O.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(r)}finally{G.value=!1}}}function _e(){typeof window<"u"&&(C.value=window.innerWidth)}async function He(){try{const A=await wt.checkAccess();A.allowed&&(h.value=A.user)}catch(A){console.error("Error loading user:",A)}}return ke(()=>{g(),He(),typeof window<"u"&&(C.value=window.innerWidth,window.addEventListener("resize",_e))}),Fe(()=>{typeof window<"u"&&window.removeEventListener("resize",_e)}),(A,P)=>{const te=It("router-link");return D(),E("div",an,[b.value?(D(),ve(yt,{key:0,message:w.value},null,8,["message"])):H("",!0),m.value?(D(),E("div",sn,[u("div",nn,[u("div",{class:"error-header"},[P[1]||(P[1]=u("span",{class:"error-icon"},"âŒ",-1)),P[2]||(P[2]=u("h3",null,"ÐžÑˆÐ¸Ð±ÐºÐ°",-1)),u("button",{onClick:Te,class:"error-close","aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"},"âœ•")]),u("p",rn,L(m.value.message),1),m.value.details?(D(),E("div",on,[u("details",null,[P[3]||(P[3]=u("summary",null,"Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸",-1)),u("pre",null,L(m.value.details),1)])])):H("",!0),u("div",{class:"error-actions"},[u("button",{onClick:je,class:"btn-retry"},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ")])])])):H("",!0),u("div",ln,[u("div",cn,[u("div",un,[u("button",{class:"btn-back-link",type:"button",onClick:ze,"aria-label":wn,"aria-disabled":!O.value,"data-fallback":!O.value,disabled:G.value,title:"ÐÐ°Ð·Ð°Ð´"}," â† ",8,dn),u("nav",pn,[Q(te,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Le(()=>[...P[4]||(P[4]=[Me(" Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡ ",-1)])]),_:1}),P[5]||(P[5]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),P[6]||(P[6]=u("span",{class:"breadcrumb-current"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ",-1))])]),P[7]||(P[7]=u("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),P[8]||(P[8]=u("p",{class:"dashboard-subtitle"}," Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÐºÑ‚Ð¾Ñ€Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ",-1))]),u("div",fn,[u("button",{onClick:Ve,class:"btn-export-pdf",disabled:f.value||b.value,title:"Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€Ð°Ñ„Ð¸Ðº Ð² PDF"},[f.value?(D(),E("span",hn,"â³ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚...")):(D(),E("span",mn,"ðŸ“„ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² PDF"))],8,gn),Q(ls,{user:h.value,onSnapshotCreated:me},null,8,["user"])])]),U.value?(D(),E("button",{key:2,class:"mobile-filters-toggle",onClick:P[0]||(P[0]=Ae=>y.value=!y.value)},[P[9]||(P[9]=u("span",null,"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹",-1)),u("span",{class:Y(["toggle-icon",{open:y.value}])},"â–¼",2)])):H("",!0),u("div",{class:Y({"mobile-open":y.value&&U.value,"mobile-closed":!y.value&&U.value})},[Q(en,{stages:he(s).stages,employees:he(s).employees,dateRange:he(s).dateRange,customDateRange:he(s).customDateRange,hasActiveFilters:he(i),"onUpdate:stages":I,"onUpdate:employees":j,"onUpdate:dateRange":J,"onUpdate:customDateRange":ce,onReset:We,onApply:ee},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!b.value&&!m.value?(D(),E("div",vn,[u("div",yn,[Q(La,{period:he(n),"show-current-state":d.value,onDataLoaded:Ce,onError:Ue},null,8,["period","show-current-state"])])])):H("",!0)])}}},En=ie(Sn,[["__scopeId","data-v-e995acfd"]]);export{En as default};
