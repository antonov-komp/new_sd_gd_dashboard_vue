import{_ as M,g as y,c as f,a as _,o as d,b as e,t as v,F as E,e as F,n as O,d as N,f as S,G as W,H as U,m as G,j as I,S as V,L as j}from"./main-Cgqd4MV5.js";import{F as x}from"./FiltersPanel-BwSh9Ty8.js";import{L,D as P,B as H}from"./index-BrJSfkue.js";import"./bitrix24-api-Irr5mCDD.js";const q={class:"ac-chart"},z={class:"ac-chart__header"},X={class:"ac-chart__subtitle"},Y={class:"ac-chart__controls"},J={class:"chart-type-selector"},Z=["onClick"],K={class:"chart-type-icon"},Q={class:"chart-type-label"},ee={class:"ac-chart__summary"},se={class:"summary-card summary-card--new"},te={class:"summary-card__value"},ae={class:"summary-card summary-card--closed"},oe={class:"summary-card__value"},ne={class:"summary-card summary-card--stages"},le={class:"summary-card__tags"},re={key:0,class:"stage-tag stage-tag--empty"},ce={class:"ac-chart__body"},ie={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(l,{emit:o}){const n=l,h=o,c=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],t=y("line"),s=f(()=>{var g;return((g=n.meta)==null?void 0:g.weekNumber)??"â€”"}),m=f(()=>{var w,i;const g=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],u=Array.isArray((w=n.data.series)==null?void 0:w.new)?n.data.series.new:[n.data.newTickets||0],T=Array.isArray((i=n.data.series)==null?void 0:i.closed)?n.data.series.closed:[n.data.closedTickets||0];return{labels:g,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:u,backgroundColor:U.primary,borderColor:U.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:T,backgroundColor:U.success,borderColor:U.success,tension:.3,fill:!1}]}}),b=f(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[n.data.newTickets||0,n.data.closedTickets||0],backgroundColor:[U.primary,U.success],borderWidth:1}]})),p=f(()=>{switch(t.value){case"line":return L;case"bar":return H;case"doughnut":return P;default:return L}}),C=f(()=>t.value==="doughnut"?b.value:m.value),D=f(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var g;(((g=n.data)==null?void 0:g.responsible)||[]).length>0&&h("open-responsible")},scales:t.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(g,u)=>{var T,w;return d(),_("div",q,[e("header",z,[e("div",null,[u[1]||(u[1]=e("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),e("p",X," ÐÐµÐ´ÐµÐ»Ñ "+v(s.value)+" Â· "+v(((T=l.meta)==null?void 0:T.weekStartUtc)||"â€”")+" â€” "+v(((w=l.meta)==null?void 0:w.weekEndUtc)||"â€”")+" (UTC) ",1)]),e("div",Y,[e("div",J,[(d(),_(E,null,F(c,i=>e("button",{key:i.value,class:O(["chart-type-btn",{active:t.value===i.value}]),onClick:B=>t.value=i.value},[e("span",K,v(i.icon),1),e("span",Q,v(i.label),1)],10,Z)),64))]),e("button",{class:"btn-link",onClick:u[0]||(u[0]=i=>g.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),e("section",ee,[e("div",se,[u[2]||(u[2]=e("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",te,v(l.data.newTickets??0),1)]),e("div",ae,[u[3]||(u[3]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",oe,v(l.data.closedTickets??0),1)]),e("div",ne,[u[4]||(u[4]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),e("div",le,[(d(!0),_(E,null,F(l.data.stages||[],i=>(d(),_("span",{key:i.stageId,class:"stage-tag"},v(i.stageId)+" â€” "+v(i.count),1))),128)),!l.data.stages||l.data.stages.length===0?(d(),_("span",re," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):N("",!0)])])]),e("div",ce,[(d(),S(W(p.value),{data:C.value,options:D.value},null,8,["data","options"]))])])}}},de=M(ie,[["__scopeId","data-v-9edf003d"]]),ue={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},me={class:"modal"},pe={class:"modal__header"},ve={class:"modal__body"},_e={key:0,class:"modal__empty"},he={key:1,class:"responsible-list"},ge={class:"responsible-list__name"},be={class:"responsible-list__avatar","aria-hidden":"true"},ke={class:"responsible-list__count"},ye={class:"modal__footer"},fe={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]}},setup(l){const o=l,n=f(()=>(o.responsible||[]).length>0);function h(c){if(!c)return"â€”";const t=String(c).trim().split(/\s+/);return t.length===1?t[0].charAt(0).toUpperCase():`${t[0].charAt(0)}${t[1].charAt(0)}`.toUpperCase()}return(c,t)=>l.isVisible?(d(),_("div",ue,[e("div",me,[e("header",pe,[t[2]||(t[2]=e("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("button",{class:"modal__close",onClick:t[0]||(t[0]=s=>c.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),e("section",ve,[n.value?(d(),_("ul",he,[(d(!0),_(E,null,F(l.responsible,s=>(d(),_("li",{key:s.id||s.name,class:"responsible-list__item"},[e("div",ge,[e("span",be,v(h(s.name)),1),e("span",null,v(s.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1)]),e("div",ke,v(s.count??0),1)]))),128))])):(d(),_("p",_e,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),e("footer",ye,[e("button",{class:"btn",onClick:t[1]||(t[1]=s=>c.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])])):N("",!0)}},we=M(fe,[["__scopeId","data-v-ac5a8b81"]]),Ce="/api/graph-1c-admission-closure.php";function De(l){var n,h,c,t,s,m,b,p,C,D;if(!l)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const o=l.data||l.result||l;return{meta:o.meta||l.meta||null,data:{newTickets:((n=o.data)==null?void 0:n.newTickets)??o.newTickets??0,closedTickets:((h=o.data)==null?void 0:h.closedTickets)??o.closedTickets??0,series:{new:((t=(c=o.data)==null?void 0:c.series)==null?void 0:t.new)??((s=o.series)==null?void 0:s.new)??[0],closed:((b=(m=o.data)==null?void 0:m.series)==null?void 0:b.closed)??((p=o.series)==null?void 0:p.closed)??[0]},stages:((C=o.data)==null?void 0:C.stages)??o.stages??[],responsible:((D=o.data)==null?void 0:D.responsible)??o.responsible??[]}}}async function Te(l={}){const{endpoint:o=Ce,product:n="1C",weekStartUtc:h=null,weekEndUtc:c=null,useCache:t=!0,forceRefresh:s=!1}=l,b=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:n,weekStartUtc:h,weekEndUtc:c,useCache:t,forceRefresh:s})});if(!b.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${b.status})`);const p=await b.json();if((p==null?void 0:p.success)===!1)throw new Error(p.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return De(p)}const Ue={class:"ac-dashboard"},$e={key:1},Re={class:"dashboard-layout"},Se={class:"filters-container"},Ae={class:"chart-container"},Ee={__name:"GraphAdmissionClosureDashboard",setup(l){const o=y(!0),n=y(null),h=y(null),c=y({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),t=y(!1),s=y({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),m=y(null),b=f(()=>{const a=s.value.customDateRange.startDate||s.value.customDateRange.endDate,r=s.value.employees.length===1&&s.value.employees.includes("all");return a||!r});async function p(){o.value=!0,n.value=null;try{let a,r;if(m.value)a=m.value.startUtc,r=m.value.endUtc;else{const $=B();a=$.weekStartUtc,r=$.weekEndUtc}const{meta:k,data:A}=await Te({product:"1C",weekStartUtc:a,weekEndUtc:r});h.value=k,c.value=A,!m.value&&k&&(m.value={weekNumber:k.weekNumber,startUtc:k.weekStartUtc,endUtc:k.weekEndUtc})}catch(a){n.value=a instanceof Error?a:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",a)}finally{o.value=!1}}function C(a){s.value.stages=a}function D(a){s.value.employees=a}function g(a){s.value.dateRange=a}function u(a){s.value.customDateRange=a}function T(a){m.value=a}function w(){s.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},i()}function i(){p()}G(()=>{p()});function B(){const a=new Date,r=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),k=r.getUTCDay(),A=r.getUTCDate()-k+(k===0?-6:1),$=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),A,0,0,0)),R=new Date($);return R.setUTCDate(R.getUTCDate()+6),R.setUTCHours(23,59,59,999),{weekStartUtc:$.toISOString(),weekEndUtc:R.toISOString()}}return(a,r)=>(d(),_("div",Ue,[o.value?(d(),S(j,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(d(),_("div",$e,[r[2]||(r[2]=e("div",{class:"dashboard-header"},[e("div",null,[e("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),e("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),e("div",Re,[e("div",Se,[I(x,{stages:s.value.stages,employees:s.value.employees,dateRange:s.value.dateRange,customDateRange:s.value.customDateRange,hasActiveFilters:b.value,hideStages:!0,weekPickerMode:!0,selectedWeek:m.value,weeksCount:52,"onUpdate:stages":C,"onUpdate:employees":D,"onUpdate:dateRange":g,"onUpdate:customDateRange":u,"onUpdate:selectedWeek":T,onReset:w,onApply:i},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","selectedWeek"])]),e("div",Ae,[n.value?(d(),S(V,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:n.value.message},null,8,["message"])):(d(),S(de,{key:1,meta:h.value,data:c.value,onOpenResponsible:r[0]||(r[0]=k=>t.value=!0)},null,8,["meta","data"]))])])])),I(we,{"is-visible":t.value,responsible:c.value.responsible||[],onClose:r[1]||(r[1]=k=>t.value=!1)},null,8,["is-visible","responsible"])]))}},Le=M(Ee,[["__scopeId","data-v-218c6a23"]]);export{Le as default};
