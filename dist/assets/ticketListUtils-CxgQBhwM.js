import{e as p,f as g,j as f,o as y,p as h,q as I}from"./index-BegDOQd9.js";import{g as C,T}from"./GraphStateDashboard-qmonQ2Dx.js";import"./main--f8PYhrq.js";import"./index-Bnmzz93j.js";function w(e,n){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:n.category,dateCategoryLabel:n.label,departmentName:null,tickets:n.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function H(e,n){const r=await C(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),t=u(r,e.dateCategory),s=c(t,n.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:n.departmentName,tickets:s,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function P(e,n){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:n.category,dateCategoryLabel:n.label,departmentName:null,tickets:n.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function B(e,n){var s;const r=(((s=e.snapshot)==null?void 0:s.tickets)||[]).filter(l=>l.stageId?p(l.stageId)===e.stageId:!1),t=c(r,n.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:n.departmentName,tickets:t,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function S(e,n){return!e||e.length===0?[]:e.filter(r=>r.stageId?p(r.stageId)===n:!1)}function L(e,n){return!e||e.length===0?[]:e.filter(r=>{const t=r.assignedTo;return t?(typeof t=="object"?t.id:t)===n:!1})}function u(e,n){if(!e||e.length===0)return[];const r=new Date;return e.filter(t=>t.createdAt?f(t.createdAt,r)===n:n===g.MORE_THAN_YEAR)}function c(e,n){return!e||e.length===0?[]:e.filter(r=>{let t=r.departmentHeadFull||r.departmentHead;return t?(t=String(t).trim(),t.length===0&&(t="Без заказчика")):t="Без заказчика",t===n})}async function M(e){var i;if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let a=e.tickets;return e.departmentName&&(a=c(a,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:a.length,departmentFilter:e.departmentName}),a}const{snapshot:n,stageId:r,employeeId:t,dateCategory:s,departmentName:l}=e;let o=n.tickets||[];return r&&(o=S(o,r)),t&&(o=L(o,t)),s&&(o=u(o,s)),l&&(o=c(o,l)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:((i=n.tickets)==null?void 0:i.length)||0,filteredCount:o.length,filters:{stageId:r,employeeId:t,dateCategory:s,departmentName:l}}),o}function N(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function b(e){return e.filter(n=>{const r=!n.ufSubject||n.ufSubject==="",t=n.actionStr===null||n.actionStr===void 0,s=!n.description||n.description==="";return r||t||s})}function k(e){const n=new Map;return e&&(Array.isArray(e)?e.forEach(r=>{r&&r.id&&n.set(r.id,r)}):typeof e=="object"&&Object.keys(e).forEach(r=>{const t=e[r];t&&t.id&&n.set(t.id,t)})),n}function A(e,n){var d;const r=n.get(e.id)||null,t={id:e.id,title:e.title||"Без названия",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};t.ufSubject=(r==null?void 0:r.ufSubject)||e.ufSubject||null;const s=(r==null?void 0:r.priorityId)||e.priorityId||"unknown",l=(r==null?void 0:r.priorityLabel)||e.priorityLabel||"Не указано",o=y(s);t.priorityId=s,t.priorityLabel=l,t.priorityColors=o,t.priority=s;const i=(r==null?void 0:r.service)||e.service||h(),a=(r==null?void 0:r.serviceLabel)||e.serviceLabel||i.label||"Не указано",m=I(i);return t.service=i,t.serviceLabel=a,t.serviceColors=m,t.actionStr=(r==null?void 0:r.actionStr)||e.actionStr||e.ufActionStr||null,t.ufActionStr=t.actionStr,t.departmentHead=(r==null?void 0:r.departmentHead)||e.departmentHead||null,t.departmentHeadFull=(r==null?void 0:r.departmentHeadFull)||e.departmentHeadFull||e.departmentHead||null,t.description=(r==null?void 0:r.description)||e.description||e.comments||"",t.assignedTo=e.assignedTo||null,t.assigneeId=e.assigneeId||((d=e.assignedTo)==null?void 0:d.id)||null,t.stageId=e.stageId||null,!t.status&&t.stageId?t.status=N(t.stageId):t.status=e.status||"new",t}async function _(e,n=null,r=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const t=b(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:t.length,alreadyHaveDetails:e.length-t.length});let s=r||null;if(t.length>0&&!r){const i=t.map(a=>a.id).filter(a=>a);if(i.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:i.length,ticketIdsSample:i.slice(0,5)}),s=await T.getTicketsDetails(i),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:(s==null?void 0:s.length)||0,sampleTicket:s!=null&&s[0]?{id:s[0].id,hasUfSubject:!!s[0].ufSubject,hasActionStr:!!s[0].actionStr,hasDescription:!!s[0].description}:null})}catch(a){console.warn("[ticketListUtils] Failed to load ticket details:",a),console.error("[ticketListUtils] Error details:",{message:a.message,stack:a.stack,ticketIdsCount:i.length}),s=null}}const l=k(s),o=e.map(i=>A(i,l));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:o.length,sampleTicket:o[0]?{id:o[0].id,hasUfSubject:!!o[0].ufSubject,hasPriorityColors:!!o[0].priorityColors,hasServiceColors:!!o[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),o}export{B as createContextFromLevel1Department,P as createContextFromLevel1Time,w as createContextFromLevel2,H as createContextFromLevel3,M as filterTicketsByContext,_ as prepareTicketsForDisplay};
