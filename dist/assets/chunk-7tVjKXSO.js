import{L as r,g as p}from"./main-wagO0-Aj.js";let D=null;class n{static initialize(){typeof window<"u"&&window.BX24?(D=window.BX24,r.info("Using BX24 API directly","ApiClient")):(D={call:async(t,e)=>{switch(r.info(`Mock API call: ${t}`,"ApiClient",e),await new Promise(o=>setTimeout(o,100)),t){case"bizproc.smartprocess.list":return{items:[{ID:"1",TITLE:"Test Ticket 1",CREATED_TIME:"2026-01-12T10:00:00Z",STAGE_ID:"DT140_12:NEW",ASSIGNED_BY_ID:"1013",UF_CRM_7_TYPE_PRODUCT:"PDM"},{ID:"2",TITLE:"Test Ticket 2",CREATED_TIME:"2026-01-12T11:00:00Z",STAGE_ID:"DT140_12:ANALYSIS",ASSIGNED_BY_ID:"1014",UF_CRM_7_TYPE_PRODUCT:"PDM"}],total:2};case"user.get":const o=[{ID:"1013",NAME:"Марк",LAST_NAME:"Тестов",DEPARTMENT:[369]},{ID:"1014",NAME:"Иван",LAST_NAME:"Разработчик",DEPARTMENT:[369]},{ID:"1015",NAME:"Анна",LAST_NAME:"Менеджер",DEPARTMENT:[369]}];let i=o;return e.filter&&e.filter.ID&&(i=o.filter(a=>a.ID===e.filter.ID)),{result:i};default:return r.warn(`Unknown method ${t}, returning empty result`,"ApiClient"),{result:[]}}}},r.info("Using mock API for development","ApiClient"))}static async call(t,e={}){D||this.initialize();try{r.debug(`Calling ${t}`,"ApiClient",{params:e});const o=await D.call(t,e);return r.debug(`Call ${t} completed`,"ApiClient"),o}catch(o){throw r.error(`Call ${t} failed`,"ApiClient",o),o}}static async getSmartProcessItems(t){const{entityTypeId:e,select:o=["*"],filter:i={},order:a={},limit:c=50}=t,y={entityTypeId:e,select:o,filter:i,order:a,limit:c},d=await this.call("bizproc.smartprocess.list",y);return d.items||d.result||[]}static async getSmartProcessItem(t,e){const{entityTypeId:o,select:i=["*"]}=e,a={entityTypeId:o,id:t,select:i},c=await this.call("bizproc.smartprocess.get",a);return c.item||c.result||null}static async updateSmartProcessItem(t,e,o={}){const{entityTypeId:i}=o,a={entityTypeId:i,id:t,fields:e};return await this.call("bizproc.smartprocess.update",a)}}n.initialize();class A{static async getAllTickets(t={}){try{r.info("Loading all tickets from Bitrix24","TicketRepository");const e=await n.getSmartProcessItems({entityTypeId:t.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:t.filter||{},order:{CREATED_TIME:"DESC"}});return r.info(`Loaded ${e.length} tickets`,"TicketRepository"),e}catch(e){throw r.error("Failed to load tickets","TicketRepository",e),e}}static async getTicketsByFilter(t,e={}){try{r.info("Loading filtered tickets","TicketRepository",{filter:t});const o=await n.getSmartProcessItems({entityTypeId:e.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:t,order:{CREATED_TIME:"DESC"}});return r.info(`Loaded ${o.length} filtered tickets`,"TicketRepository"),o}catch(o){throw r.error("Failed to load filtered tickets","TicketRepository",o),o}}static async getTicketById(t){try{return r.info(`Loading ticket ${t}`,"TicketRepository"),await n.getSmartProcessItem(t,{entityTypeId:140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"]})}catch(e){throw r.error(`Failed to load ticket ${t}`,"TicketRepository",e),e}}}class _{static async getAllEmployees(t={}){try{r.info("Loading all employees from Bitrix24","EmployeeRepository");const o=(await n.call("user.get",{filter:{ACTIVE:"Y"},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]})).result||[];return r.info(`Loaded ${o.length} employees`,"EmployeeRepository"),o}catch(e){throw r.error("Failed to load employees","EmployeeRepository",e),e}}static async getEmployeeById(t){try{return r.info(`Loading employee ${t}`,"EmployeeRepository"),((await n.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]})).result||[])[0]||null}catch(e){throw r.error(`Failed to load employee ${t}`,"EmployeeRepository",e),e}}static async getEmployeesByIds(t){try{if(r.info(`Loading employees by IDs: ${t.join(", ")}`,"EmployeeRepository"),!t||t.length===0)return[];const e=[];for(const o of t)try{const i=await this.getEmployeeById(o);i&&e.push(i)}catch{r.warn(`Failed to load employee ${o}, skipping`,"EmployeeRepository")}return r.info(`Loaded ${e.length} employees out of ${t.length} requested`,"EmployeeRepository"),e}catch(e){throw r.error("Failed to load employees by IDs","EmployeeRepository",e),e}}static async getEmployeesByDepartment(t){try{r.info(`Loading employees for department ${t}`,"EmployeeRepository");const o=(await n.call("user.get",{filter:{ACTIVE:"Y",UF_DEPARTMENT:t},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]})).result||[];return r.info(`Loaded ${o.length} employees for department ${t}`,"EmployeeRepository"),o}catch(e){throw r.error(`Failed to load employees for department ${t}`,"EmployeeRepository",e),e}}}const u=140,s={NEW:"DT140_12:NEW",ANALYSIS:"DT140_12:ANALYSIS",DEVELOPMENT:"DT140_12:DEVELOPMENT",TESTING:"DT140_12:TESTING",DEPLOYMENT:"DT140_12:DEPLOYMENT",CLOSED:"DT140_12:CLOSED"},E={[s.NEW]:"Новый",[s.ANALYSIS]:"Анализ",[s.DEVELOPMENT]:"Разработка",[s.TESTING]:"Тестирование",[s.DEPLOYMENT]:"Внедрение",[s.CLOSED]:"Закрыт"},T={[s.NEW]:"#007bff",[s.ANALYSIS]:"#ffc107",[s.DEVELOPMENT]:"#28a745",[s.TESTING]:"#17a2b8",[s.DEPLOYMENT]:"#6f42c1",[s.CLOSED]:"#6c757d"};function g(){return[{id:s.NEW,name:E[s.NEW],color:T[s.NEW],order:1},{id:s.ANALYSIS,name:E[s.ANALYSIS],color:T[s.ANALYSIS],order:2},{id:s.DEVELOPMENT,name:E[s.DEVELOPMENT],color:T[s.DEVELOPMENT],order:3},{id:s.TESTING,name:E[s.TESTING],color:T[s.TESTING],order:4},{id:s.DEPLOYMENT,name:E[s.DEPLOYMENT],color:T[s.DEPLOYMENT],order:5},{id:s.CLOSED,name:E[s.CLOSED],color:T[s.CLOSED],order:6}]}function m(l){const t={};return Object.values(s).forEach(e=>{t[e]=[]}),l.forEach(e=>{const o=e.STAGE_ID||e.stageId||s.NEW;t[o]?t[o].push(e):t[s.NEW].push(e)}),r.debug("Tickets grouped by stages","TicketGrouper",{totalTickets:l.length,stagesWithTickets:Object.values(t).filter(e=>e.length>0).length}),t}function h(l,t=null){const e={};return t?e[t]=l.filter(o=>(o.STAGE_ID||o.stageId)===t&&!o.PREVIOUS_STAGE_ID):Object.values(s).forEach(o=>{e[o]=l.filter(i=>(i.STAGE_ID||i.stageId)===o&&!i.PREVIOUS_STAGE_ID)}),e}function N(l){const t=new Set;return l.forEach(e=>{e.ASSIGNED_BY_ID&&t.add(e.ASSIGNED_BY_ID),e.CREATED_BY_ID&&t.add(e.CREATED_BY_ID),e.UF_RESPONSIBLE&&(Array.isArray(e.UF_RESPONSIBLE)?e.UF_RESPONSIBLE.forEach(o=>t.add(o)):t.add(e.UF_RESPONSIBLE))}),Array.from(t)}class R{constructor(t,e){this.sectorId=t,this.config={name:e.name,filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:e.filterValue,...e},r.info(`DashboardSectorBaseService initialized for sector: ${t}`,"DashboardSectorBaseService")}async getSectorData(t={}){r.info(`Loading sector data for ${this.sectorId}`,"DashboardSectorBaseService");try{const e={};e[this.config.filterField]=this.config.filterValue,r.info("Getting tickets with filter:","DashboardSectorBaseService",e);const o=await A.getTicketsByFilter(e,{entityTypeId:u});r.info(`Found ${o.length} tickets for sector ${this.sectorId}`,"DashboardSectorBaseService");const i=p(o,{id:this.sectorId,name:this.config.name,filterValue:this.config.filterValue,filterField:this.config.filterField});r.info(`After sector filtering: ${i.length} tickets`,"DashboardSectorBaseService");const a=N(i);r.info("Getting employees for IDs:","DashboardSectorBaseService",a);const c=await _.getEmployeesByIds(a);r.info(`Found ${c.length} employees`,"DashboardSectorBaseService");const y=g(),d=m(i);y.forEach(S=>{const I=d[S.id]||[];S.tickets=I,S.ticketCount=I.length});const f={stages:y,employees:c,zeroPointTickets:h(i),metadata:{sectorId:this.sectorId,sectorName:this.config.name,filterValue:this.config.filterValue,totalTickets:i.length,totalEmployees:c.length,lastUpdated:new Date().toISOString()}};return r.info(`Sector data loaded successfully for ${this.sectorId}`,"DashboardSectorBaseService",{totalTickets:i.length,totalEmployees:c.length,stagesCount:y.length}),f}catch(e){throw r.error(`Error loading sector data for ${this.sectorId}`,"DashboardSectorBaseService",e),e}}}export{R as D};
