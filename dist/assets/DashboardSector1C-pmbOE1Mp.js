var le=Object.defineProperty;var de=(t,e,n)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var M=(t,e,n)=>de(t,typeof e!="symbol"?e+"":e,n);import{_ as O,c as h,a as g,b as _,t as T,n as B,o as m,F as C,r as N,d as b,e as A,f as E,g as v,w as R,T as j,h as F,i as ue,j as ie,k as Q,l as ge,u as fe}from"./main-B6QB_izk.js";const ye={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(t,{emit:e}){return{getPriorityLabel:a=>({high:"–í—ã—Å–æ–∫–∏–π",medium:"–°—Ä–µ–¥–Ω–∏–π",low:"–ù–∏–∑–∫–∏–π"})[a]||a,getStatusLabel:a=>({in_progress:"–í —Ä–∞–±–æ—Ç–µ",new:"–ù–æ–≤—ã–π",done:"–í—ã–ø–æ–ª–Ω–µ–Ω–æ",pending:"–û–∂–∏–¥–∞–Ω–∏–µ"})[a]||a,handleDragStart:a=>{a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(t.ticket)),a.dataTransfer.setDragImage(a.target,0,0),e("drag-start",t.ticket)},handleDragEnd:()=>{e("drag-end")}}}},me=["draggable"],pe={class:"ticket-header"},he={class:"ticket-id"},Te={class:"ticket-title"},ke={class:"ticket-meta"},_e={class:"ticket-status"},De={key:0,class:"ticket-description"};function Se(t,e,n,i,s,r){return m(),h("div",{class:B(["ticket-card",{"priority-high":n.ticket.priority==="high","priority-medium":n.ticket.priority==="medium","priority-low":n.ticket.priority==="low"}]),draggable:n.draggable,onClick:e[0]||(e[0]=a=>t.$emit("click",n.ticket)),onDragstart:e[1]||(e[1]=(...a)=>i.handleDragStart&&i.handleDragStart(...a)),onDragend:e[2]||(e[2]=(...a)=>i.handleDragEnd&&i.handleDragEnd(...a))},[g("div",pe,[e[3]||(e[3]=g("span",{class:"ticket-icon"},"üé´",-1)),g("span",he,"#"+T(n.ticket.id),1)]),g("div",Te,T(n.ticket.title),1),g("div",ke,[g("span",{class:B(["ticket-priority",`priority-${n.ticket.priority}`])},T(i.getPriorityLabel(n.ticket.priority)),3),g("span",_e,T(i.getStatusLabel(n.ticket.status)),1)]),n.ticket.description?(m(),h("div",De,T(n.ticket.description),1)):_("",!0)],42,me)}const ne=O(ye,[["render",Se],["__scopeId","data-v-b255f359"]]),Ee={name:"ZeroPoint",components:{TicketCard:ne},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){return{handleTicketDragStart:i=>{e("ticket-dragged",i)}}}},ve={class:"zero-point"},Ie={class:"zero-point-tickets"},Ae={key:0,class:"empty-state"};function Ce(t,e,n,i,s,r){const a=b("TicketCard");return m(),h("div",ve,[e[1]||(e[1]=g("div",{class:"zero-point-header"},[g("h3",null,"–ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞")],-1)),g("div",Ie,[(m(!0),h(C,null,N(n.tickets,l=>(m(),A(a,{key:l.id,ticket:l,draggable:!0,onDragStart:o=>i.handleTicketDragStart(l),onClick:o=>t.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128)),n.tickets.length===0?(m(),h("div",Ae,[...e[0]||(e[0]=[g("p",null,"–ù–µ—Ç –Ω–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ –≤ —Å—Ç–∞–¥–∏–∏",-1)])])):_("",!0)])])}const we=O(Ee,[["render",Ce],["__scopeId","data-v-73492b14"]]);function Ne(t){return typeof t=="number"&&t>0&&!isNaN(t)}function re(t){return typeof t=="number"&&t>0&&!isNaN(t)}function se(t){return typeof t=="string"&&["formed","review","execution"].includes(t)}function be(t){return!t||typeof t!="object"?!1:Ne(t.id)&&typeof t.title=="string"&&t.title.trim().length>0}function ae(t,e,n){return!(!be(t)||!re(e)||!se(n)||t.assigneeId===e&&t.stageId===n)}function Oe(t){const e=[];return!t||typeof t!="object"?(e.push("–î–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{valid:!1,errors:e}):((!t.title||typeof t.title!="string"||t.title.trim().length===0)&&e.push("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),t.stageId&&!se(t.stageId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å—Ç–∞–¥–∏–∏"),t.employeeId&&!re(t.employeeId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"),{valid:e.length===0,errors:e})}function oe(){const t=(r,a="info",l=5e3)=>{typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:r,autoHideDelay:l}):console.log(`[${a.toUpperCase()}] ${r}`)};return{notify:t,success:(r,a=3e3)=>{t(r,"success",a)},error:(r,a=5e3)=>{t(r,"error",a)},info:(r,a=4e3)=>{t(r,"info",a)},warning:(r,a=4e3)=>{t(r,"warning",a)}}}function Me(t){const e=oe(),n=E(!1);return{isDropZoneActive:n,handleDragStart:(o,f)=>{o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("application/json",JSON.stringify(f)),o.dataTransfer.setDragImage(o.target,0,0)},handleDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move",n.value=!0},handleDragLeave:o=>{const f=o.currentTarget.getBoundingClientRect(),d=o.clientX,u=o.clientY;(d<f.left||d>f.right||u<f.top||u>f.bottom)&&(n.value=!1)},handleDrop:async(o,f,d)=>{o.preventDefault(),n.value=!1;const u=o.dataTransfer.getData("application/json");if(u)try{const c=JSON.parse(u);if(!ae(c,f,d)){e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞");return}t&&typeof t=="function"&&await t(c,f,d)}catch(c){console.error("Error parsing ticket data:",c),e.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞")}},handleDragEnd:o=>{n.value=!1}}}const Pe={name:"EmployeeColumn",components:{TicketCard:ne},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(t,{emit:e}){const i=Me(async(u,c,y)=>{e("ticket-dropped",u,c)}),s=v(()=>t.employee.isFromSector1C?Array.isArray(t.employee.tickets)?t.employee.tickets:[]:Array.isArray(t.employee.ticketsInsideSector)?t.employee.ticketsInsideSector:[]),r=v(()=>t.employee.isFromSector1C?[]:Array.isArray(t.employee.ticketsOutsideSector)?t.employee.ticketsOutsideSector:Array.isArray(t.employee.tickets)?t.employee.tickets:[]),a=v(()=>t.employee.isFromSector1C?Array.isArray(t.employee.tickets)?t.employee.tickets:[]:[]),l=v(()=>s.value.length+r.value.length),o=u=>{i.handleDrop(u,t.employee.id,t.stageId)},f=u=>{},d=()=>{console.log("Add ticket for employee:",t.employee.id)};return{isDropZoneActive:i.isDropZoneActive,handleDragOver:i.handleDragOver,handleDragLeave:i.handleDragLeave,handleDrop:o,ticketsInsideSector:s,ticketsOutsideSector:r,ticketsToDisplay:a,totalTicketsCount:l,handleTicketDragStart:f,handleAddTicket:d}}},Re={class:"employee-header"},Le={class:"employee-info"},Be={class:"employee-details"},Fe={class:"employee-name"},xe={key:0,class:"employee-position"},Ue={class:"tickets-count"},Ke={class:"tickets-list"},ze={key:0,class:"tickets-section tickets-inside-sector"},Ye={key:1,class:"tickets-section tickets-outside-sector"},je={class:"section-header"},Ve={class:"section-count"},We={key:2,class:"empty-state"};function Xe(t,e,n,i,s,r){const a=b("TicketCard");return m(),h("div",{class:B(["employee-column",{"drop-zone-active":i.isDropZoneActive}]),onDragover:e[1]||(e[1]=ue((...l)=>i.handleDragOver&&i.handleDragOver(...l),["prevent"])),onDragleave:e[2]||(e[2]=(...l)=>i.handleDragLeave&&i.handleDragLeave(...l)),onDrop:e[3]||(e[3]=(...l)=>i.handleDrop&&i.handleDrop(...l))},[g("div",Re,[g("div",Le,[e[4]||(e[4]=g("span",{class:"employee-icon"},"üë§",-1)),g("div",Be,[g("div",Fe,T(n.employee.name),1),n.employee.position?(m(),h("div",xe,T(n.employee.position),1)):_("",!0)])]),g("div",Ue," üìä –¢–∏–∫–µ—Ç–æ–≤: "+T(i.totalTicketsCount),1)]),g("div",Ke,[n.employee.isFromSector1C?(m(),A(j,{key:0,name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsToDisplay,l=>(m(),A(a,{key:l.id,ticket:l,draggable:!0,onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})):(m(),h(C,{key:1},[i.ticketsInsideSector.length>0?(m(),h("div",ze,[F(j,{name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsInsideSector,l=>(m(),A(a,{key:l.id,ticket:l,draggable:!0,onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0),i.ticketsOutsideSector.length>0?(m(),h("div",Ye,[g("div",je,[e[5]||(e[5]=g("span",{class:"section-badge"},"–í–Ω–µ —Å–µ–∫—Ç–æ—Ä–∞",-1)),g("span",Ve,T(i.ticketsOutsideSector.length),1)]),F(j,{name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsOutsideSector,l=>(m(),A(a,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0)],64)),i.totalTicketsCount===0?(m(),h("div",We,[e[6]||(e[6]=g("p",null,"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤",-1)),g("button",{class:"add-ticket-btn",onClick:e[0]||(e[0]=(...l)=>i.handleAddTicket&&i.handleAddTicket(...l))}," + –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç ")])):_("",!0)])],34)}const He=O(Pe,[["render",Xe],["__scopeId","data-v-5779d978"]]),Ge={name:"DashboardStage",components:{ZeroPoint:we,EmployeeColumn:He},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){const n=E(!1),i=v(()=>{const u=Array.isArray(t.zeroPointTickets)?t.zeroPointTickets.length:0,c=Array.isArray(t.stage.employees)?t.stage.employees.reduce((y,p)=>Array.isArray(p.ticketsInsideSector)?y+p.ticketsInsideSector.length:p.isFromSector1C&&Array.isArray(p.tickets)?y+p.tickets.length:y,0):0;return u+c}),s=v(()=>Array.isArray(t.stage.employees)?t.stage.employees.reduce((u,c)=>Array.isArray(c.ticketsOutsideSector)?u+c.ticketsOutsideSector.length:!c.isFromSector1C&&Array.isArray(c.tickets)?u+c.tickets.length:u,0):0),r=v(()=>i.value+s.value),a=v(()=>{var p;const u=((p=t.stage)==null?void 0:p.name)||"–°—Ç–∞–¥–∏—è",c=i.value,y=s.value;return y===0?`${u} (${c})`:`${u} (${c} / ${y})`});return{isDragging:n,ticketsCountInsideSector:i,ticketsCountOutsideSector:s,totalTicketsCount:r,stageNameWithCount:a,handleTicketDragged:u=>{n.value=!0},handleTicketAssigned:(u,c)=>{e("ticket-assigned",u,c)},handleTicketDropped:(u,c)=>{e("ticket-moved",u,c,t.stage.id),n.value=!1},handleTicketClicked:u=>{console.log("Ticket clicked:",u),e("ticket-clicked",u)}}}},$e={class:"stage-header"},Ze={class:"stage-content"},qe={class:"employees-container"};function Je(t,e,n,i,s,r){const a=b("ZeroPoint"),l=b("EmployeeColumn");return m(),h("div",{class:"dashboard-stage",style:ie({borderLeftColor:n.stage.color})},[g("div",$e,[g("h2",null,T(i.stageNameWithCount),1)]),g("div",Ze,[F(a,{tickets:n.zeroPointTickets,"stage-id":n.stage.id,onTicketDragged:i.handleTicketDragged,onTicketAssigned:i.handleTicketAssigned,onTicketClicked:i.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),g("div",qe,[(m(!0),h(C,null,N(n.stage.employees,o=>(m(),A(l,{key:o.id,employee:o,"stage-id":n.stage.id,onTicketClicked:i.handleTicketClicked,onTicketDropped:i.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const Qe=O(Ge,[["render",Je],["__scopeId","data-v-3eed4deb"]]),V={cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},et={loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},tt={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(t,{emit:e}){const n=v(()=>{var u;const{currentStep:f,stepDetails:d}=t;return d!=null&&d.description?{title:f?((u=V[f])==null?void 0:u.title)||f:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:d.description}:f?V[f]?V[f]:et[f]||{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."}:{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."}}),i=v(()=>n.value.title),s=v(()=>n.value.description),r=v(()=>t.stepDetails),a=v(()=>{const f=t.progress;return f==null||isNaN(f)?0:Math.round(Math.max(0,Math.min(100,f)))});return{stepTitle:i,stepDescription:s,details:r,displayProgress:a,getStageDisplayName:f=>f?{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ","–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[f]||f:"",handleRetry:()=>{e("retry")}}}},it={class:"preloader-backdrop"},nt={class:"preloader-container"},rt={class:"preloader-content-scrollable"},st={key:0,class:"spinner-container"},at={class:"preloader-content"},ot={class:"step-title"},ct={key:0,class:"step-description"},lt={key:1,class:"progress-container"},dt={class:"progress-bar"},ut={class:"progress-text"},gt={key:2,class:"step-details"},ft={key:0,class:"detail-description"},yt={key:1,class:"detail-item"},mt={class:"detail-value"},pt={key:0,class:"detail-total"},ht={key:2,class:"detail-item"},Tt={class:"detail-value"},kt={key:0,class:"detail-total"},_t={key:3,class:"detail-item"},Dt={class:"detail-value"},St={key:0,class:"detail-total"},Et={key:4,class:"detail-item"},vt={class:"detail-value"},It={key:5,class:"detail-warning"},At={key:0,class:"error-container"},Ct={class:"error-content"},wt={class:"error-message"};function Nt(t,e,n,i,s,r){return m(),h("div",{class:B(["loading-preloader",{"has-error":n.error}])},[g("div",it,[g("div",nt,[g("div",rt,[n.error?_("",!0):(m(),h("div",st,[...e[1]||(e[1]=[g("div",{class:"spinner"},null,-1)])])),g("div",at,[g("h3",ot,T(i.stepTitle),1),i.stepDescription?(m(),h("p",ct,T(i.stepDescription),1)):_("",!0),n.error?_("",!0):(m(),h("div",lt,[g("div",dt,[g("div",{class:"progress-fill",style:ie({width:i.displayProgress+"%"})},null,4)]),g("span",ut,T(i.displayProgress)+"%",1)])),n.error?_("",!0):(m(),h("div",gt,[i.details.description?(m(),h("div",ft,T(i.details.description),1)):_("",!0),i.details.count!==void 0?(m(),h("div",yt,[e[2]||(e[2]=g("span",{class:"detail-label"},"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",mt,T(i.details.count),1),i.details.total!==void 0?(m(),h("span",pt," –∏–∑ "+T(i.details.total),1)):_("",!0)])):_("",!0),i.details.filteredTickets!==void 0?(m(),h("div",ht,[e[3]||(e[3]=g("span",{class:"detail-label"},"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",Tt,T(i.details.filteredTickets),1),i.details.totalTickets!==void 0?(m(),h("span",kt," –∏–∑ "+T(i.details.totalTickets),1)):_("",!0)])):_("",!0),i.details.stage?(m(),h("div",_t,[e[4]||(e[4]=g("span",{class:"detail-label"},"–°—Ç–∞–¥–∏—è:",-1)),g("span",Dt,T(i.getStageDisplayName(i.details.stage)),1),i.details.stageIndex&&i.details.totalStages?(m(),h("span",St," ("+T(i.details.stageIndex)+"/"+T(i.details.totalStages)+") ",1)):_("",!0)])):_("",!0),i.details.employeeCount!==void 0?(m(),h("div",Et,[e[5]||(e[5]=g("span",{class:"detail-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",-1)),g("span",vt,T(i.details.employeeCount),1)])):_("",!0),i.details.warning?(m(),h("div",It,[g("span",null,"‚ö†Ô∏è "+T(i.details.warning),1)])):_("",!0)]))])])])]),n.error?(m(),h("div",At,[g("div",Ct,[e[6]||(e[6]=g("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),g("p",wt,T(n.error),1),g("button",{onClick:e[0]||(e[0]=(...a)=>i.handleRetry&&i.handleRetry(...a)),class:"retry-button"}," –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É ")])])):_("",!0)],2)}const bt=O(tt,[["render",Nt],["__scopeId","data-v-d129ff19"]]);function Ot(){const t=E(!1),e=E(null),n=E([{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}]),i=E({formed:[],review:[],execution:[]}),s=E([]),r=E(null);return{isLoading:t,error:e,stages:n,zeroPointTickets:i,employees:s,draggedTicket:r,updateState:d=>{d.stages&&(n.value=d.stages),d.employees&&(s.value=d.employees),d.zeroPointTickets&&(i.value=d.zeroPointTickets)},resetState:()=>{t.value=!1,e.value=null,n.value=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}],i.value={formed:[],review:[],execution:[]},s.value=[],r.value=null},updateLocalStateAfterMove:(d,u,c)=>{const y=n.value.find(D=>D.employees.some(I=>I.tickets.some(Y=>Y.id===d.id)));if(y){const D=y.employees.find(I=>I.tickets.some(Y=>Y.id===d.id));D&&(D.tickets=D.tickets.filter(I=>I.id!==d.id))}const p=n.value.find(D=>D.id===c);if(p){const D=p.employees.find(I=>I.id===u);if(D){const I={...d,assigneeId:u,stageId:c};D.tickets.push(I)}}Object.keys(i.value).forEach(D=>{i.value[D]=i.value[D].filter(I=>I.id!==d.id)})},getEmployeeTickets:(d,u)=>{const c=n.value.find(p=>p.id===u);if(!c)return[];const y=c.employees.find(p=>p.id===d);return y?y.tickets||[]:[]}}}class Mt{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,n={}){try{const i=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:n})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const s=await i.json();if(s.error)throw new Error(s.error_description||s.error);return s}catch(i){throw console.error("Bitrix24 API error:",i),i}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},n=["ID","NAME","EMAIL","PHONE"],i={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:n,order:i})).result||[]}}class w{static async call(e,n={}){return await Mt.call(e,n)}}class k{static get(e){const n=this.cache.get(e);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(e),null):n.data:null}static set(e,n,i=this.DEFAULT_TTL){this.cache.set(e,{data:n,timestamp:Date.now(),ttl:i})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const n=[];for(const i of this.cache.keys())i.startsWith(e)&&n.push(i);n.forEach(i=>this.cache.delete(i))}static cleanExpired(){const e=Date.now(),n=[];for(const[i,s]of this.cache.entries())e-s.timestamp>s.ttl&&n.push(i);n.forEach(i=>this.cache.delete(i))}static getStats(){const e=Date.now();let n=0,i=0;for(const s of this.cache.values())e-s.timestamp>s.ttl?n++:i++;return{total:this.cache.size,valid:i,expired:n}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((i,s)=>i-s).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}M(k,"cache",new Map),M(k,"DEFAULT_TTL",5*60*1e3),M(k,"EMPLOYEES_TTL",30*60*1e3),M(k,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{k.cleanExpired()},5*60*1e3);function S(t,e,n={}){if(!t||typeof t!="string")throw new Error("Step must be a non-empty string");const i=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let s=n.description;return s||(s=Pt(t,n)),{step:t,progress:i,details:{...n,description:s}}}function Pt(t,e){return t==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:t==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤: ${e.filteredTickets} –∏–∑ ${e.totalTickets}...`:t==="grouping"&&e.employeeCount!==void 0?`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ ${e.employeeCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`:e.count!==void 0&&e.total!==void 0?`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${e.count} –∏–∑ ${e.total}...`:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}function z(t){if(!t||typeof t!="object")throw new Error("Progress info must be an object");const e=t.step||null;if(!e)throw new Error("Step is required in progress info");const n=t.progress!==void 0&&t.progress!==null?t.progress:t.percent!==void 0&&t.percent!==null?t.percent:void 0,i=t.details||{};return t.stage&&(i.stage=t.stage),t.stageName&&(i.stageName=t.stageName),t.stageIndex!==void 0&&(i.stageIndex=t.stageIndex),t.totalStages!==void 0&&(i.totalStages=t.totalStages),t.count!==void 0&&(i.count=t.count),t.total!==void 0&&(i.total=t.total),t.warning&&(i.warning=t.warning),{step:e,progress:n!=null?Math.max(0,Math.min(100,n)):void 0,details:i}}function ce(t,e,n){const i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,s=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,r=typeof n=="number"&&!isNaN(n)?Math.max(0,Math.min(100,n)):0,a=i+s*r/100;return Math.max(0,Math.min(100,a))}const x=140;class P{static async getAllTickets(e,n=null){const i=[],s=e.length;try{for(let r=0;r<e.length;r++){const a=e[r],l=this.getStageName(a);if(n){const o=r/s*100;n(S("loading_tickets",o,{stage:a,stageName:l,stageIndex:r+1,totalStages:s}))}try{const o=await this.getTicketsByStage(a,!0,n?f=>{const d=ce(r/s*100,1/s*100,f.percent||0);n(S("loading_tickets",d,{stage:a,stageName:l,stageIndex:r+1,totalStages:s,count:f.count,total:f.total}))}:null);i.push(...o)}catch(o){console.error(`Error loading tickets for stage ${a}:`,o);let f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}"`;throw o.message&&(o.message.includes("HTTP error")||o.message.includes("network")?f=`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`:o.message.includes("timeout")?f=`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`:o.message.includes("403")||o.message.includes("401")?f=`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.`:f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}": ${o.message}`),new Error(f)}}}catch(r){throw console.error("Error in getAllTickets:",r),r}return i}static getStageName(e){return{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[e]||e}static async getTicketsByStage(e,n=!0,i=null){if(n){const d=k.getTicketsCacheKey(e),u=k.get(d);if(u!==null)return i&&i(z({step:"loading_tickets",percent:100,count:u.length,total:u.length})),u}const s=[];let r=0;const a=50;let l=!0,o=0,f=null;for(;l;)try{const d=await w.call("crm.item.list",{entityTypeId:x,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:r,useOriginalUfNames:"Y"});let u=[];if(d&&d.result&&(Array.isArray(d.result)?u=d.result:d.result.items&&Array.isArray(d.result.items)?u=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(u=d.result.data)),u.length>0){if(s.push(...u),r+=u.length,l=u.length===a,l?o=r+a:o=s.length,i){const c=o>0?Math.min(100,s.length/o*100):0;i(z({step:"loading_tickets",percent:c,count:s.length,total:o}))}f=null}else l=!1}catch(d){if(console.error(`Error loading tickets batch for stage ${e} (start: ${r}):`,d),r===0)throw f=d,new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç—ã –¥–ª—è —Å—Ç–∞–¥–∏–∏ ${e}: ${d.message||d}`);l=!1,i&&s.length>0&&i(S("loading_tickets",100,{count:s.length,total:s.length,warning:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ${s.length} —Ç–∏–∫–µ—Ç–æ–≤. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.`}))}if(f&&s.length===0)throw f;if(n){const d=k.getTicketsCacheKey(e);k.set(d,s,k.TICKETS_TTL)}return s}static async getTicket(e){return(await w.call("crm.item.get",{entityTypeId:x,id:e})).result||null}static async updateTicket(e,n){const s=(await w.call("crm.item.update",{entityTypeId:x,id:e,fields:n})).result===!0;return s&&k.invalidateTicketsCache(),s}static async createTicket(e){const n=await w.call("crm.item.add",{entityTypeId:x,fields:e}),i=n.result?parseInt(n.result):0;return i>0&&k.invalidateTicketsCache(),i}static async assignTicket(e,n,i){return await this.updateTicket(e,{assignedById:n,stageId:i})}}class Rt{static async getEmployeesByIds(e,n=!0){if(!Array.isArray(e)||e.length===0)return[];if(n){const i=k.getEmployeesCacheKey(e),s=k.get(i);if(s!==null)return console.log(`Cache hit for employees: ${e.length} employees`),s}try{const i=await w.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(i&&i.result&&(Array.isArray(i.result)?s=i.result:console.warn("Unexpected user.get result format:",i)),n){const r=k.getEmployeesCacheKey(e);k.set(r,s,k.EMPLOYEES_TTL)}return s}catch(i){return console.error("Error getting employees by IDs:",i),[]}}}const K=366,Lt=368,Bt=369,Ft=367,xt=[K,Lt,Bt,Ft],Ut=140,W={FORMED:{bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{bitrixId:"DT140_12:PREPARATION"},EXECUTION:{bitrixId:"DT140_12:CLIENT"}},Kt={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},zt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},Yt={3:"high",2:"medium",1:"low"};function jt(){return[W.FORMED.bitrixId,W.REVIEW.bitrixId,W.EXECUTION.bitrixId]}function $(t){return Kt[t]||"formed"}function ee(t){return zt[t]||"DT140_12:UC_0VHWE2"}function Vt(){return jt()}function Z(t){const e=parseInt(t.id||t.ID||0),n=t.title||t.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",i=t.stageId||t.STAGE_ID||"",s=t.assignedById||t.ASSIGNED_BY_ID||null,r=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",a=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"";return{id:e,title:n,priority:Wt(t.priority||t.PRIORITY),status:Xt(),assigneeId:s?parseInt(s):null,stageId:$(i),createdAt:r,modifiedAt:a,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function Wt(t){return Yt[t]||"medium"}function Xt(t){return"in_progress"}function Ht(t){if(!t||!t.UF_DEPARTMENT)return null;const e=Array.isArray(t.UF_DEPARTMENT)?t.UF_DEPARTMENT:[t.UF_DEPARTMENT];for(const n of e){const i=typeof n=="number"?n:parseInt(n);if(!isNaN(i)&&xt.includes(i))return i}return null}function Gt(t){const e=Ht(t);return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:t.WORK_POSITION||t.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:t.EMAIL||t.email||"",sectorId:e,departmentId:t.UF_DEPARTMENT||null,tickets:[]}}function $t(t){return Array.isArray(t)?t.map(e=>Gt(e)):[]}const U="1C",L=new Map,te=100;function Zt(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function qt(t){const e=Zt(t);return e?Array.isArray(e)?e.includes(U):typeof e=="object"&&e!==null&&e.value===U||e===U:!1}function Jt(t){return`filter:${t.map(n=>n.id||n.ID||"").sort().join(",")}`}function Qt(){L.size>te&&Array.from(L.keys()).slice(0,Math.floor(te*.2)).forEach(e=>L.delete(e))}function ei(t){if(!Array.isArray(t))return[];const e=Jt(t),n=L.get(e);if(n!==void 0)return n;const i=t.filter(qt);return L.set(e,i),Qt(),i}const G=1051;function q(t){if(!t||typeof t!="object")return null;let e=t.assignedById||t.ASSIGNED_BY_ID||t.assignedByIdId||t.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function J(t){if(t==null)return null;typeof t=="object"&&(t=t.id||t.ID||t.value||null);const e=typeof t=="number"?t:parseInt(t);return isNaN(e)||e<=0?null:e}function ti(t,e=G){const n=q(t),i=J(n);return i===null||i===e}function ii(t,e){Array.isArray(t)||(console.warn("Tickets is not an array:",t),t=[]),Array.isArray(e)||(console.warn("Employees is not an array:",e),e=[]);const n=e.filter(a=>(a.id?parseInt(a.id):null)!==G),i=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:n.map(a=>({...a,isFromSector1C:a.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:n.map(a=>({...a,isFromSector1C:a.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:n.map(a=>({...a,isFromSector1C:a.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(i.map(a=>[a.id,a])),r=new Map;return i.forEach(a=>{const l=new Map(a.employees.map(o=>[o.id,o]));r.set(a.id,l)}),t.forEach(a=>{const l=$(a.stageId||a.STAGE_ID||""),o=s.get(l);if(o){const f=q(a),d=J(f);if(d===G)return;if(d){const u=r.get(l);let c=u.get(d);c||(c={id:d,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${d}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},o.employees.push(c),u.set(d,c));const y=Z(a);c.tickets.push(y),c.isFromSector1C?c.ticketsInsideSector.push(y):c.ticketsOutsideSector.push(y)}}}),i.forEach(a=>{a.employees.sort((l,o)=>l.isFromSector1C&&!o.isFromSector1C?-1:!l.isFromSector1C&&o.isFromSector1C?1:(l.id||0)-(o.id||0))}),i}function ni(t){const e={formed:[],review:[],execution:[]};return Array.isArray(t)?(t.filter(n=>ti(n)).forEach(n=>{const i=$(n.stageId||n.STAGE_ID||"");e[i]&&e[i].push(Z(n))}),e):(console.warn("Tickets is not an array in getZeroPointTickets:",t),e)}function ri(t){if(!Array.isArray(t))return[];const e=new Set;return t.forEach(n=>{const i=q(n),s=J(i);s&&e.add(s)}),Array.from(e)}class si{static async getTicketDetails(e,n={}){const{select:i=["*"],useOriginalUfNames:s=!0}=n;try{const r=await P.getTicket(e);if(!r)throw new Error(`–¢–∏–∫–µ—Ç —Å ID ${e} –Ω–µ –Ω–∞–π–¥–µ–Ω`);const a=this.processAdditionalFields(r);return{id:r.id||r.ID,title:r.title||r.TITLE,stageId:r.stageId||r.STAGE_ID,assignedById:r.assignedById||r.ASSIGNED_BY_ID,createdAt:r.createdTime||r.CREATED_TIME||r.CREATED_DATE,updatedAt:r.updatedTime||r.UPDATED_TIME||r.MODIFY_DATE,priority:r.priority||r.PRIORITY,opportunity:r.opportunity||r.OPPORTUNITY,currencyId:r.currencyId||r.CURRENCY_ID,comments:r.comments||r.COMMENTS,additionalFields:a,rawData:r}}catch(r){throw console.error("Error getting ticket details:",r),r}}static processAdditionalFields(e){const n=this.extractUserFields(e);return{typeProduct:n.UF_CRM_7_TYPE_PRODUCT||n.uf_crm_7_type_product||n.ufCrm7TypeProduct||null,all:n}}static extractUserFields(e){const n={};for(const i in e)e.hasOwnProperty(i)&&i.toLowerCase().startsWith("uf_")&&(n[i]=e[i]);return n}}class X{static async getSectorData(e=!0,n=null){if(n&&n(S("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),e){const i=k.getSectorDataCacheKey(),s=k.get(i);if(s!==null)return n&&n(S("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫–µ—à–∞"})),s}try{n&&n(S("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const i=Vt(),s=await P.getAllTickets(i,u=>{if(n){const c=z(u),y=ce(10,40,c.progress||0);n(S(c.step||"loading_tickets",y,{...c.details,warning:c.details.warning}))}});n&&n(S("filtering",50,{totalTickets:s.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${s.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const r=ei(s);n&&n(S("filtering",50,{totalTickets:s.length,filteredTickets:r.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${r.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${s.length}`})),n&&n(S("extracting_employees",60,{filteredTickets:r.length,description:`–ê–Ω–∞–ª–∏–∑ ${r.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const a=ri(r);n&&n(S("extracting_employees",60,{employeeCount:a.length,description:`–ù–∞–π–¥–µ–Ω–æ ${a.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(S("loading_employees",65,{employeeCount:a.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${a.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const l=await Rt.getEmployeesByIds(a),o=$t(l);n&&n(S("loading_employees",90,{employeeCount:o.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${o.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(S("grouping",90,{filteredTickets:r.length,employeeCount:o.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${r.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${o.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const d={stages:ii(r,o),employees:o,zeroPointTickets:ni(r)};if(n&&n(S("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),e){const u=k.getSectorDataCacheKey();k.set(u,d,k.TICKETS_TTL)}return n&&n(S("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),d}catch(i){throw console.error("Error getting sector data:",i),n&&n({step:"error",progress:0,error:i.message}),i}}static async assignTicket(e,n,i){try{const s=ee(i),r=await P.assignTicket(e,n,s);return r&&k.invalidateTicketsCache(),r}catch(s){throw console.error("Error assigning ticket:",s),s}}static async createTicket(e){try{const n=ee(e.stageId||"formed"),i={title:e.title,stageId:n};e.employeeId&&(i.assignedById=e.employeeId);const s=await P.createTicket(i);return s>0&&k.invalidateTicketsCache(),s}catch(n){throw console.error("Error creating ticket:",n),n}}static async getTicket(e){try{const n=await P.getTicket(e);return Z(n)}catch(n){throw console.error("Error getting ticket:",n),n}}static async getTicketDetails(e,n={}){try{return await si.getTicketDetails(e,n)}catch(i){throw console.error("Error getting ticket details:",i),i}}static async addComment(e,n){try{return(await w.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+Ut,comment:n}})).result!==void 0}catch(i){throw console.error("Error adding comment:",i),i}}}function ai(){const t=E(null),e=E(0),n=E(null),i=E(null),s=E({}),r=(c,y={})=>{t.value=c,s.value=y},a=c=>{const y=typeof c=="number"&&!isNaN(c)?c:0;e.value=Math.min(100,Math.max(0,y))},l=c=>{n.value=c,i.value=null},o=c=>{i.value=c},f=()=>{i.value=null},d=()=>{t.value=null,e.value=0,n.value=null,i.value=null,s.value={}},u=v(()=>n.value||i.value);return{currentStep:t,progress:e,error:n,temporaryError:i,displayError:u,stepDetails:s,updateStep:r,updateProgress:a,setError:l,setTemporaryError:o,clearTemporaryError:f,reset:d}}function oi(t,e=""){if(console.error(`API Error ${e?`(${e})`:""}:`,t),t.message){if(t.message.includes("HTTP error"))return"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";if(t.message.includes("timeout"))return"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";if(t.message.includes("403")||t.message.includes("401"))return"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";if(t.message.includes("500"))return"–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."}return t.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}function ci(t,e="",n={}){const i={message:t.message,stack:t.stack,context:e,...n,timestamp:new Date().toISOString()};console.error("Error logged:",i)}function H(t,e="",n=null){const i=oi(t,e);ci(t,e),n&&typeof n=="function"?n(i,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:i,autoHideDelay:5e3})}function li(t){const e=oe(),n=ai(),i=E(!1);function s(c,y){const p=z(c);p.step&&y.updateStep(p.step,p.details||{}),p.progress!==void 0&&p.progress!==null&&(y.updateProgress(p.progress),y.clearTemporaryError())}const r=async(c=!0)=>{t.isLoading.value=!0,t.error.value=null,n.reset(),n.updateStep("cache_check",{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö..."}),n.updateProgress(0);try{const y=await X.getSectorData(c,p=>{s(p,n)});t.updateState(y)}catch(y){t.error.value=y.message,n.setError(y.message),H(y,"loading sector data",e.error)}finally{t.error.value?t.isLoading.value=!1:(n.updateStep("complete",{description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"}),n.updateProgress(100),setTimeout(()=>{i.value=!0,setTimeout(()=>{t.isLoading.value=!1},150),setTimeout(()=>{n.reset(),i.value=!1},400)},800))}},a=async(c,y,p)=>{if(!ae(c,y,p))return e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞"),!1;try{const D=await X.assignTicket(c.id,y,p);return D&&(t.updateLocalStateAfterMove(c,y,p),e.success("–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω")),D}catch(D){return H(D,"assigning ticket",e.error),!1}finally{t.draggedTicket.value=null}};return{loadSectorData:r,assignTicket:a,moveTicketToStage:async(c,y)=>await a(c,c.assigneeId,y),assignTicketToEmployee:async(c,y)=>await a(c,y,c.stageId),createTicket:async c=>{const y=Oe(c);if(!y.valid){const p=y.errors.join(", ");return e.error(p),0}try{const p=await X.createTicket(c);return p>0&&(await r(!1),e.success("–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω")),p}catch(p){return H(p,"creating ticket",e.error),0}},handleTicketDragStart:c=>{t.draggedTicket.value=c},handleTicketDrop:async(c,y,p)=>{await a(c,y,p)},loadingProgress:n,isTransitioning:i}}const di={name:"DashboardSector1C",components:{DashboardStage:Qe,LoadingPreloader:bt},setup(){const t=fe(),e=Ot(),n=li(e);ge(()=>{n.loadSectorData()});const i=()=>{t.push("/")},s=()=>{n.loadSectorData(!1)},r=n.loadingProgress;return{isLoading:e.isLoading,error:e.error,stages:e.stages,zeroPointTickets:e.zeroPointTickets,employees:e.employees,draggedTicket:e.draggedTicket,currentStep:r.currentStep,progress:r.progress,stepDetails:r.stepDetails,loadingProgress:r,loadSectorData:n.loadSectorData,handleTicketDragStart:n.handleTicketDragStart,handleTicketDrop:n.handleTicketDrop,assignTicketToEmployee:n.assignTicketToEmployee,moveTicketToStage:n.moveTicketToStage,createTicket:n.createTicket,getEmployeeTickets:e.getEmployeeTickets,handleRetry:s,isTransitioning:n.isTransitioning,goBack:i}}},ui={class:"dashboard-header"},gi={key:0,class:"dashboard-content"},fi={class:"stages-container"};function yi(t,e,n,i,s,r){const a=b("LoadingPreloader"),l=b("DashboardStage");return m(),h("div",{class:B(["dashboard-sector-1c",{"is-dragging":i.draggedTicket}])},[g("div",ui,[g("button",{class:"back-button",onClick:e[0]||(e[0]=(...o)=>i.goBack&&i.goBack(...o)),"aria-label":"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é"},[...e[2]||(e[2]=[g("span",{class:"back-button-icon"},"‚Üê",-1),g("span",{class:"back-button-text"},"–ù–ê–ó–ê–î",-1)])]),e[3]||(e[3]=g("h1",null,"–î–∞—à–±–æ—Ä–¥ - –°–µ–∫—Ç–æ—Ä 1–°",-1))]),F(Q,{name:"preloader-fade"},{default:R(()=>[i.isLoading||i.error||i.currentStep?(m(),A(a,{key:0,"current-step":i.currentStep,progress:i.progress,"step-details":i.stepDetails,error:i.error||null,onRetry:i.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):_("",!0)]),_:1}),F(Q,{name:"dashboard-fade"},{default:R(()=>[!i.isLoading&&!i.error&&!i.currentStep?(m(),h("div",gi,[g("div",fi,[(m(!0),h(C,null,N(i.stages,o=>(m(),A(l,{key:o.id,stage:o,"zero-point-tickets":i.zeroPointTickets[o.id]||[],onTicketMoved:i.handleTicketDrop,onTicketAssigned:i.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):_("",!0)]),_:1}),g("button",{class:"floating-back-button",onClick:e[1]||(e[1]=(...o)=>i.goBack&&i.goBack(...o)),"aria-label":"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é",title:"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é"},[...e[4]||(e[4]=[g("span",{class:"floating-back-button-icon"},"‚Üê",-1)])])],2)}const hi=O(di,[["render",yi],["__scopeId","data-v-a3fb73fb"]]);export{hi as default};
