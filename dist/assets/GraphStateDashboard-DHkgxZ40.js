const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ticketListUtils-CCKAM7tn.js","assets/index-DvHM_Yh3.js","assets/main-BJrEnPef.js","assets/main-hkNOQW78.css","assets/index-Bxxce_5E.css","assets/index-IWKOldOk.js"])))=>i.map(i=>d[i]);
import{_ as Ie,a as E,o as w,b as r,F as ge,e as fe,n as oe,l as Se,t as L,g as F,c as te,G as We,m as He,f as Ae,d as Q,j as ie,k as Te,i as pe,B as je,T as wt,H as xt,I as $t,u as Ve,J as Oe,K as St,p as Ke,L as tt,x as Pt,M as Bt,N as Mt,C as Nt,O as Xe,D as Wt,P as Ut,Q as jt,y as Ge,R as Le,z as Vt,r as zt}from"./main-BJrEnPef.js";import{L as bt,D as Kt,B as Gt}from"./index-IWKOldOk.js";import{S as at,d as st,K as Yt,D as Dt,B as ot,m as Et,e as Ye,f as me,h as _t,j as qt,T as Ct,k as Jt,l as Tt}from"./index-DvHM_Yh3.js";const Ee={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Ce{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,n={}){try{if(!t||typeof t!="object")throw new Re("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new Re("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const a=this.validateSectorData(t);if(!a.isValid)throw new Re(`Ошибка валидации данных сектора: ${a.errors.join(", ")}`,"VALIDATION_ERROR",{validation:a});const s=this.normalizeSectorData(t),o={metadata:this.generateSnapshotMetadata(e,n.createdBy,n.sectorId||Ee.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},i=this.validateSnapshot(o);if(!i.isValid)throw new Re(`Ошибка валидации слепка: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",i.warnings);const u=this.getApiBaseUrl(),p=await fetch(`${u}${Ee.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:o,type:e,date:this.formatDate(new Date)})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const m=await p.json();if(!m.success)throw new Error(m.message||"Ошибка создания слепка");return m.data.snapshot}catch(a){throw console.error("SnapshotService.createSnapshot error:",a),a instanceof Re?a:new Re(`Ошибка создания слепка: ${a.message}`,"API_ERROR",{originalError:a})}}static async getSnapshot(t,e){try{const n=this.formatDate(t),s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?action=get&date=${n}&type=${e}`,l=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const o=await l.json();if(!o.success){if(o.message&&o.message.includes("не найден"))return null;throw new Error(o.message||"Ошибка получения слепка")}return o.data.snapshot}catch(n){throw console.error("SnapshotService.getSnapshot error:",n),n}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ee.defaultSectorId);const a=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?${e.toString()}`,s=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const l=await s.json();if(!l.success)throw new Error(l.message||"Ошибка получения списка слепков");return(await Promise.all(l.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(u){return console.warn(`Ошибка загрузки слепка ${i.date}/${i.type}:`,u),null}}))).filter(i=>i!==null).sort((i,u)=>new Date(i.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:n=[],zeroPointTickets:a={}}=t,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},l=[],o=[],i=[];e.forEach(m=>{const c=m.id;if(s[c]){let b=0;m.employees.forEach(_=>{const y=_.tickets||[];b+=y.length;let v=l.find(D=>D.id===_.id);v||(v={id:_.id,name:_.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(v)),y.forEach(D=>{o.push(D.id),i.push({id:D.id,title:D.title||"Без названия",assignedTo:{id:_.id,name:_.name},createdAt:D.createdAt||"",updatedAt:D.modifiedAt||D.updatedAt||""}),v.ticketsByStage[c]=(v.ticketsByStage[c]||0)+1,v.totalTickets+=1})}),s[c].count=b}});const u={unassigned:0,keeper:0,total:0};Object.values(a).forEach(m=>{Array.isArray(m)&&m.forEach(c=>{u.total+=1,c.assigneeId===1051||c.assignedById===1051?u.keeper+=1:u.unassigned+=1,o.push(c.id),i.push({id:c.id,title:c.title||"Без названия",assignedTo:c.assignedTo||c.assignedById?{id:c.assignedById||c.assigneeId,name:"Неизвестный"}:null,createdAt:c.createdAt||"",updatedAt:c.modifiedAt||c.updatedAt||""})})});const p=Object.values(s).reduce((m,c)=>m+c.count,0)+u.total;return{statistics:{stages:{...s,total:p},employees:l,zeroPoint:u},ticketIds:[...new Set(o)],tickets:i}}static generateSnapshotMetadata(t,e,n){const a=new Date,s=-a.getTimezoneOffset(),l=Math.floor(s/60),o=s%60,i=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(o).padStart(2,"0")}`,u=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}T${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}${i}`;return{version:Ee.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Система"},type:t,sectorId:n,sectorName:n==="1C"?"Сектор 1С":`Сектор ${n}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${a}`}static buildFilePath(t,e){const n=typeof t=="string"?new Date(t):t,a=n.getFullYear(),s=this.getWeekNumber(n),l=this.formatDate(t);let o;if(e==="current"){const i=new Date,u=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;o=`current-state-${l}-${u}.json`}else if(e==="manual"){const i=new Date,u=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;o=`manual-${l}-${u}.json`}else o=`${e}-${l}.json`;return e==="current"?`current/${o}`:`${a}/week-${s}/${o}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);const a=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-a)/864e5+1)/7)}static validateSnapshot(t){var a,s,l;const e=[],n=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const o=t.statistics.stages,i=(((a=o.formed)==null?void 0:a.count)||0)+(((s=o.review)==null?void 0:s.count)||0)+(((l=o.execution)==null?void 0:l.count)||0);o.total!==i&&n.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${o.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const o=t.statistics.zeroPoint,i=(o.unassigned||0)+(o.keeper||0);o.total!==i&&n.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${o.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const o=new Set(t.ticketIds),i=new Set(t.tickets.map(u=>u.id));o.size!==i.size&&n.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((u,p)=>{u.id||e.push(`Тикет #${p}: отсутствует ID`),u.title||e.push(`Тикет #${p}: отсутствует заголовок`),(!u.assignedTo||!u.assignedTo.id)&&n.push(`Тикет #${p}: отсутствует ответственный (может быть в нулевой точке)`),u.createdAt||e.push(`Тикет #${p}: отсутствует дата создания`),u.updatedAt||e.push(`Тикет #${p}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:n}}static validateSectorData(t){const e=[],n=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:n}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:n})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const n=this.formatDate(t),s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}`,l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:n,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const o=await l.json();if(!o.success)throw new Error(o.message||"Ошибка удаления слепка");return!0}catch(n){throw console.error("SnapshotService.deleteSnapshot error:",n),n}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let n=0;for(const a of e)try{await this.deleteSnapshot(a.metadata.createdAt.split("T")[0],a.metadata.type)&&n++}catch(s){console.warn(`Ошибка удаления слепка ${a.metadata.createdAt}:`,s)}return n}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ee.snapshotVersion){const n=this.getSnapshotVersion(t);return n===e||n==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${n} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,n=this.getWeekNumber(e);return{year:e.getFullYear(),week:n}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,a=(e.getDay()||7)-1,s=new Date(e);return s.setDate(e.getDate()-a),s.setHours(0,0,0,0),s}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,a=7-(e.getDay()||7),s=new Date(e);return s.setDate(e.getDate()+a),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),n=this.getWeekEndDate(t),a=this.getWeekNumberInfo(t),s=await this.getAllSnapshots({startDate:e,endDate:n}),l=s.find(u=>u.metadata.type==="week_start")||null,o=s.find(u=>u.metadata.type==="week_end")||null,i=s.filter(u=>u.metadata.type==="manual");return{weekStart:l,weekEnd:o,manual:i,weekInfo:a}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof Re)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),n={week_start:0,week_end:0,manual:0,current:0},a=new Map;let s=null,l=null;e.forEach(i=>{const u=i.metadata.type;n.hasOwnProperty(u)&&n[u]++;const p=this.getWeekNumberInfo(i.metadata.createdAt),m=`${p.year}-W${p.week}`;a.set(m,(a.get(m)||0)+1);const c=new Date(i.metadata.createdAt);(!s||c<new Date(s.metadata.createdAt))&&(s=i),(!l||c>new Date(l.metadata.createdAt))&&(l=i)});const o=Array.from(a.entries()).map(([i,u])=>{const[p,m]=i.split("-W");return{year:parseInt(p),week:parseInt(m),count:u}}).sort((i,u)=>i.year!==u.year?i.year-u.year:i.week-u.week);return{total:e.length,byType:n,byWeek:o,oldest:s,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class Re extends Error{constructor(t,e,n={}){super(t),this.name="SnapshotError",this.code=e,this.details=n}}const _e={formed:{bitrixId:st.formed,name:at.FORMED.name},review:{bitrixId:st.review,name:at.REVIEW.name},execution:{bitrixId:st.execution,name:at.EXECUTION.name}},Ue=Yt;function Xt(d){if(!d||typeof d!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!d.stages||!Array.isArray(d.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=Zt(d.stages),e=Qt(d.stages),n=ea(d.zeroPointTickets||{}),a=ta(d.zeroPointTickets||{}),s=aa(d.stages,d.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:n,zeroPointByStage:a},ticketIds:s.ticketIds,tickets:s.tickets}}function Zt(d){const t={formed:{count:0,stageId:_e.formed.bitrixId,stageName:_e.formed.name},review:{count:0,stageId:_e.review.bitrixId,stageName:_e.review.name},execution:{count:0,stageId:_e.execution.bitrixId,stageName:_e.execution.name},total:0};return d.forEach(e=>{if(!_e[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let n=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(a=>{a.tickets&&Array.isArray(a.tickets)&&(n+=a.tickets.length)}),t[e.id].count=n,t.total+=n}),t}function Qt(d){const t=new Map;return d.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(n=>{if(!n||!n.id)return;t.has(n.id)||t.set(n.id,{id:n.id,name:n.name||`Сотрудник #${n.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const a=t.get(n.id),s=n.tickets&&Array.isArray(n.tickets)?n.tickets.length:0;_e[e.id]&&(a.ticketsByStage[e.id]=(a.ticketsByStage[e.id]||0)+s),a.totalTickets+=s})}),Array.from(t.values())}function ea(d){let t=0,e=0;return!d||typeof d!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(d).forEach(n=>{Array.isArray(n)&&n.forEach(a=>{if(!a)return;const s=a.assignedTo||a.assignedById;!s||s===null?t++:(typeof s=="object"?s.id:s)===Ue?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function ta(d){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!d||typeof d!="object"||Object.keys(t).forEach(e=>{const n=d[e];Array.isArray(n)&&n.forEach(a=>{if(!a)return;const s=a.assignedTo||a.assignedById;!s||s===null?t[e].unassigned++:(typeof s=="object"?s.id:s)===Ue?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function aa(d,t){const e=new Set,n=new Map;return Array.isArray(d)&&d.forEach(a=>{!a.employees||!Array.isArray(a.employees)||a.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const o=parseInt(l.id);if(isNaN(o)){console.warn("Invalid ticket ID:",l.id);return}e.add(o);let i=l.assignedTo;!i&&s.id&&(i={id:s.id,name:s.name||`Сотрудник #${s.id}`}),n.set(o,{id:o,title:l.title||"Без названия",assignedTo:i||null,createdAt:ze(l.createdAt||l.createdTime),updatedAt:ze(l.updatedAt||l.modifiedAt||l.updatedTime),stageId:l.stageId||a.id||null,departmentHead:l.departmentHead||null,departmentHeadFull:l.departmentHeadFull||l.departmentHead||null,priorityId:l.priorityId||null,priorityLabel:l.priorityLabel||null,service:l.service||null,serviceLabel:l.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const l=parseInt(s.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",s.id);return}e.add(l);let o=s.assignedTo;if(!o&&s.assignedById){const i=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;i&&i!==Ue?o={id:i,name:"Неизвестный"}:i===Ue&&(o={id:Ue,name:"Хранитель объектов"})}n.set(l,{id:l,title:s.title||"Без названия",assignedTo:o||null,createdAt:ze(s.createdAt||s.createdTime),updatedAt:ze(s.updatedAt||s.modifiedAt||s.updatedTime),stageId:s.stageId||null,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null,priorityId:s.priorityId||null,priorityLabel:s.priorityLabel||null,service:s.service||null,serviceLabel:s.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((a,s)=>a-s),tickets:Array.from(n.values())}}function ze(d){if(!d)return null;if(d instanceof Date)return d.toISOString();if(typeof d=="string"){if(d.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return d;const t=new Date(d);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",d),null}class rt{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:n=null,normalize:a=!0,includeTicketDetails:s=!1}=t;try{const l=await Dt.getSectorData(e,n);return a?Xt(l):(s&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await Dt.getSectorData(!0);return t!=null}catch{return!1}}}class nt{static compareTwoSnapshots(t,e,n={}){const{includeTickets:a=!1,includeEmployees:s=!0}=n,l=this.validateSnapshot(t),o=this.validateSnapshot(e);if(!l.valid||!o.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...o.errors].join(", "));const i=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),p=s?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],m=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),c=a?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,b=this.buildSummary(u,p,m,c);return{metadata:i,stages:u,employees:p,zeroPoint:m,tickets:c,summary:b}}static calculateDelta(t,e){const n=this.normalizeValue(t),a=this.normalizeValue(e),s=a-n;let l=0;n!==0?l=s/n*100:a!==0&&(l=a>0?1/0:-1/0);const o=this.getTrend(s);return{value1:n,value2:a,delta:s,deltaPercent:Math.round(l*100)/100,trend:o}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var o,i;const n=["formed","review","execution"],a={};for(const u of n){const p=((o=t[u])==null?void 0:o.count)||0,m=((i=e[u])==null?void 0:i.count)||0;a[u]=this.calculateDelta(p,m)}const s=t.total||0,l=e.total||0;return a.total=this.calculateDelta(s,l),a}static compareEmployees(t,e){var o,i;const n=new Map(t.map(u=>[u.id,u])),a=new Map(e.map(u=>[u.id,u])),s=new Set([...n.keys(),...a.keys()]),l=[];for(const u of s){const p=n.get(u)||null,m=a.get(u)||null;if(!p||!m){l.push({id:u,name:(p==null?void 0:p.name)||(m==null?void 0:m.name)||"Неизвестный",snapshot1:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,snapshot2:m?{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0}:null,delta:this.calculateEmployeeDelta(p,m),trend:p?"removed":"new"});continue}const c={},b=["formed","review","execution"];for(const y of b){const v=((o=p.ticketsByStage)==null?void 0:o[y])||0,D=((i=m.ticketsByStage)==null?void 0:i[y])||0;c[y]=this.calculateDelta(v,D)}const _=this.calculateDelta(p.totalTickets||0,m.totalTickets||0);l.push({id:u,name:p.name,snapshot1:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},snapshot2:{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0},delta:{ticketsByStage:c,totalTickets:_},trend:_.trend})}return l}static calculateEmployeeDelta(t,e){var l,o;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const n={},a=["formed","review","execution"];for(const i of a){const u=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[i])||0,p=((o=e==null?void 0:e.ticketsByStage)==null?void 0:o[i])||0;n[i]=this.calculateDelta(u,p)}const s=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:n,totalTickets:s}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,n,a){var b,_;const s=new Set(t),l=new Set(e),o=e.filter(y=>!s.has(y)),i=t.filter(y=>!l.has(y)),u=[],p=[],m=new Map(n.map(y=>[y.id,y])),c=new Map(a.map(y=>[y.id,y]));for(const y of t){if(!l.has(y))continue;const v=m.get(y),D=c.get(y);if(!v||!D)continue;const M=(((b=v.assignedTo)==null?void 0:b.id)||null)!==(((_=D.assignedTo)==null?void 0:_.id)||null),J=(v.stageId||null)!==(D.stageId||null);M||J?u.push(y):p.push(y)}return{new:o,removed:i,changed:u,unchanged:p}}static buildComparisonMetadata(t,e){const n=new Date(t.metadata.createdAt),a=new Date(e.metadata.createdAt),s=new Date,l=a.getTime()-n.getTime(),o=Math.floor(l/(1e3*60*60*24)),i=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:o,hours:i,minutes:u,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,n,a){var u,p,m;const s=t.total.delta,l=Object.keys(t).filter(c=>c==="total"?!1:t[c].delta!==0).length,o=e.filter(c=>c.trend==="new"||c.trend==="removed"?!0:c.delta.totalTickets.delta!==0).length,i=s!==0||l>0||o>0;return{totalDelta:s,stagesChanged:l,employeesChanged:o,hasChanges:i,newTicketsCount:((u=a==null?void 0:a.new)==null?void 0:u.length)||0,removedTicketsCount:((p=a==null?void 0:a.removed)==null?void 0:p.length)||0,changedTicketsCount:((m=a==null?void 0:a.changed)==null?void 0:m.length)||0}}static validateSnapshot(t){const e=[],n=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:n};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const a=["formed","review","execution"];for(const s of a)t.statistics.stages[s]||n.push(`Missing stage: ${s}`)}t.statistics.employees||n.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||n.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:n}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const o=this.validateSnapshot(l);if(!o.valid)throw new Error("Invalid snapshot: "+o.errors.join(", "))}const n=[...t].sort((l,o)=>{const i=new Date(l.metadata.createdAt),u=new Date(o.metadata.createdAt);return i-u}),a=[];for(let l=0;l<n.length-1;l++)a.push({from:l,to:l+1,result:this.compareTwoSnapshots(n[l],n[l+1],e)});const s=this.buildTrends(n);return{snapshots:n.map((l,o)=>({index:o,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:a,trends:s}}static buildTrends(t){var n,a,s,l,o,i,u,p,m,c;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const b of t){const _=b.statistics;e.stages.formed.push(((a=(n=_.stages)==null?void 0:n.formed)==null?void 0:a.count)||0),e.stages.review.push(((l=(s=_.stages)==null?void 0:s.review)==null?void 0:l.count)||0),e.stages.execution.push(((i=(o=_.stages)==null?void 0:o.execution)==null?void 0:i.count)||0),e.stages.total.push(((u=_.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((p=_.zeroPoint)==null?void 0:p.unassigned)||0),e.zeroPoint.keeper.push(((m=_.zeroPoint)==null?void 0:m.keeper)||0),e.zeroPoint.total.push(((c=_.zeroPoint)==null?void 0:c.total)||0)}return e}}const sa={class:"stages-container"},na={class:"stages-chips"},la=["checked","disabled","onChange"],oa={class:"stage-chip-label"},ra={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:d=>d.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(d,{emit:t}){const e=d,n=t;function a(s,l){const o={...e.selected};o[s]=l,n("update:selected",o),n("change",s,l)}return(s,l)=>(w(),E("div",sa,[l[0]||(l[0]=r("h4",{class:"stages-title"},"Этапы для отображения:",-1)),r("div",na,[(w(!0),E(ge,null,fe(d.stages,o=>(w(),E("label",{key:o.id,class:oe(["stage-chip",{"stage-chip--active":d.selected[o.id],"stage-chip--disabled":d.disabled}])},[r("input",{type:"checkbox",checked:d.selected[o.id],disabled:d.disabled,onChange:i=>a(o.id,i.target.checked)},null,40,la),r("span",{class:"stage-chip-color",style:Se({backgroundColor:o.color})},null,4),r("span",oa,L(o.name),1)],2))),128))])]))}},ia=Ie(ra,[["__scopeId","data-v-fe03c03c"]]),lt=140,xe=new Map;class Ft{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await ot.call("crm.item.list",{entityTypeId:lt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let n=[];if(e&&e.result&&(Array.isArray(e.result)?n=e.result:e.result.items&&Array.isArray(e.result.items)?n=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(n=e.result.data)),!n||n.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const a=n[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:a.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!a.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:a.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(a),ticketSample:JSON.stringify(a).substring(0,500)});const s=Et(a),l=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:s.departmentHead,departmentHeadFull:l?String(l).trim():null});let o=null;if(l){const i=String(l).trim();i.length>0&&(o=i)}return{...s,departmentHeadFull:o}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],n=[];if(t.forEach(a=>{xe.has(a)?e.push(xe.get(a)):n.push(a)}),n.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:n.length,ticketIdsSample:n.slice(0,5),entityTypeId:lt});const a=await ot.call("crm.item.list",{entityTypeId:lt,filter:{id:n},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!a,resultType:typeof a,resultKeys:a?Object.keys(a):[],hasResultResult:!!(a!=null&&a.result),resultResultType:typeof(a==null?void 0:a.result),isArray:Array.isArray(a==null?void 0:a.result),resultResultLength:Array.isArray(a==null?void 0:a.result)?a.result.length:"not array",fullResult:a});let s=[];if(a&&a.result&&(Array.isArray(a.result)?s=a.result:a.result.items&&Array.isArray(a.result.items)?s=a.result.items:a.result.data&&Array.isArray(a.result.data)&&(s=a.result.data)),!s||s.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!a,hasResultResult:!!(a!=null&&a.result),resultType:typeof(a==null?void 0:a.result),result:a,resultKeys:a?Object.keys(a):[]}),e;const l=s.map((o,i)=>{i===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:o.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:o.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(o).filter(b=>b.toLowerCase().includes("department")||b.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(o).slice(0,20)});const u=Et(o);i===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:u.id,hasDepartmentHead:!!u.departmentHead,departmentHead:u.departmentHead,mappedTicketKeys:Object.keys(u).filter(b=>b.toLowerCase().includes("department"))});const p=o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||o.UF_CRM_7_DEPARTMENT_HEAD||o.uf_crm_7_department_head||o.ufCrm7DepartmentHead||null;i===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:p,hasUF_CRM_7_DEPARTMENT_HEAD:!!o.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(o).filter(b=>b.toLowerCase().includes("department")||b.toLowerCase().includes("uf_crm"))});let m=null;if(p){const b=String(p).trim();b.length>0&&(m=b)}!m&&u.departmentHead&&(m=u.departmentHead);const c={...u,departmentHeadFull:m||u.departmentHead||null};return i===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:c.id,departmentHead:c.departmentHead,departmentHeadFull:c.departmentHeadFull}),c.id&&xe.set(c.id,c),c});return[...e,...l]}catch(a){return console.error("[TicketDetailsService] Error loading tickets details batch:",a),console.error("[TicketDetailsService] Error details:",{message:a.message,stack:a.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){xe.size>t&&xe.clear()}static getCacheSize(){return xe.size}}async function ca(d,t,e,n=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:d,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!d||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const a=e.tickets.filter(p=>{const m=p.assignedTo;return m?(typeof m=="object"?m.id:m)===d:!1});if(a.length===0)return[];const s=!a[0].stageId||!a[0].departmentHead;let l=null;if(s){const p=a.map(m=>m.id);if(n&&typeof n=="object")l=n;else try{const m=await Ft.getTicketsDetails(p);l=new Map,m.forEach(c=>{c&&c.id&&l.set(c.id,c)})}catch(m){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",m),l=null}}return a.map(p=>{const m=p.id,c={id:m,title:p.title||"Без названия",assignedTo:p.assignedTo,createdAt:p.createdAt,updatedAt:p.updatedAt};if(l){const b=l instanceof Map?l.get(m):l[m];b?(c.stageId=b.stageId||null,c.departmentHead=b.departmentHead||null,c.departmentHeadFull=b.departmentHeadFull||b.departmentHead||null):(c.stageId=null,c.departmentHead=null)}else c.stageId=p.stageId||null,c.departmentHead=p.departmentHead||null,c.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null;return c}).filter(p=>p.stageId?Ye(p.stageId)===t:!0)}function At(d,t=new Date){if(!d||d.length===0)return[];const e=d.length,n={};return Object.values(me).forEach(s=>{n[s]={category:s,label:_t[s].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:_t[s].color}}),d.forEach(s=>{if(!s.createdAt){n[me.MORE_THAN_YEAR].count++,n[me.MORE_THAN_YEAR].tickets.push(s);return}const l=qt(s.createdAt,t);n[l]&&(n[l].count++,n[l].tickets.push(s))}),Object.values(n).filter(s=>s.count>0).map(s=>{const l=e>0?parseFloat((s.count/e*100).toFixed(1)):0;return{...s,percentage:l,progressBarWidth:l}}).sort((s,l)=>{const o=[me.TODAY,me.YESTERDAY,me.THIS_WEEK,me.LAST_WEEK,me.MORE_THAN_TWO_WEEKS,me.UP_TO_ONE_MONTH,me.MORE_THAN_TWO_MONTHS,me.MORE_THAN_HALF_YEAR,me.MORE_THAN_YEAR];return o.indexOf(s.category)-o.indexOf(l.category)})}function da(d){if(!d||d.length===0)return[];const t={};d.forEach(n=>{let a=n.departmentHeadFull||n.departmentHead;d.indexOf(n)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:n.id,departmentHead:n.departmentHead,departmentHeadFull:n.departmentHeadFull,allKeys:Object.keys(n).filter(s=>s.toLowerCase().includes("department"))}),a?(a=String(a).trim(),a.length===0&&(a="Без заказчика")):a="Без заказчика",t[a]||(t[a]={departmentName:a,count:0}),t[a].count++});const e=Object.values(t);return e.sort((n,a)=>a.count!==n.count?a.count-n.count:n.departmentName.localeCompare(a.departmentName,"ru")),e}const ua={class:"modal-content"},pa={key:"level-1",class:"level-1"},ma={class:"modal-header"},ga={class:"modal-total"},fa={class:"view-switcher"},ha={class:"modal-body"},va={key:0},ya={key:0,class:"no-employees"},ka={key:1,class:"employees-list"},wa=["onClick"],Sa={class:"employee-name"},ba={class:"employee-progress"},Da={class:"employee-count"},Ea={key:0,class:"employee-item employee-others"},_a={class:"employee-name"},Ca={class:"employee-progress"},Ta={class:"employee-count"},Aa={key:1,class:"view-time"},Ia={key:0,class:"no-data"},$a={key:1,class:"date-categories-list"},Ma=["onClick"],Na={class:"category-label"},Fa={class:"category-progress"},Ra={class:"category-count"},Ha={key:2,class:"view-departments"},Oa={key:0,class:"no-data"},La={key:1,class:"departments-table-container"},xa={class:"departments-table"},Pa=["onClick"],Ba={class:"col-department"},Wa={class:"department-name"},Ua={class:"col-count"},ja={class:"count-value"},Va={key:"level-2",class:"level-2"},za={class:"modal-header"},Ka={class:"modal-total"},Ga={class:"modal-body"},Ya={class:"stage-info"},qa={class:"stage-badge"},Ja={key:0,class:"no-data"},Xa={key:1,class:"date-categories-list"},Za=["onClick"],Qa={class:"category-label"},es={class:"category-progress"},ts={class:"category-count"},as={key:"level-3",class:"level-3"},ss={class:"modal-header"},ns={class:"header-info"},ls={class:"header-badges"},os={class:"date-badge"},rs={class:"stage-badge"},is={class:"modal-total"},cs={class:"modal-body"},ds={key:0,class:"no-data"},us={key:1,class:"departments-table-container"},ps={class:"departments-table"},ms=["onClick"],gs={class:"col-department"},fs={class:"department-name"},hs={class:"col-count"},vs={class:"count-value"},ys={key:"level-4",class:"level-4"},ks={class:"modal-header"},ws={class:"header-info"},Ss={key:0,class:"header-badges"},bs={key:0,class:"date-badge"},Ds={key:1,class:"department-badge"},Es={class:"stage-badge"},_s={class:"modal-total"},Cs={class:"modal-body"},Ts={key:"loading",class:"loading-state"},As={key:"error-fallback",class:"error-state-with-fallback"},Is={class:"tickets-list-container"},$s={key:"error",class:"error-state"},Ms={class:"error-message"},Ns={key:"empty",class:"empty-state"},Fs={class:"empty-state-title"},Rs={class:"empty-state-message"},Hs={key:"tickets",class:"tickets-list-container"},Os={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null}},emits:["close"],setup(d,{emit:t}){const e=d,n=t,a=Ve(),s=F(1),l=F("employees"),o=F(null),i=F([]),u=F([]),p=F(null),m=F(null),c=F(null);te(()=>s.value>1);const b=te(()=>{var f,k,h,N,Y;switch(s.value){case 1:return((f=o.value)==null?void 0:f.stageName)||e.stageName;case 2:return((k=p.value)==null?void 0:k.employeeName)||"";case 3:return`${((h=p.value)==null?void 0:h.employeeName)||""} — ${((N=m.value)==null?void 0:N.dateCategoryLabel)||""}`;case 4:if(!((Y=c.value)!=null&&Y.context))return"Список тикетов";const W=c.value.context,ee=[];return W.employeeName&&ee.push(W.employeeName),W.dateCategoryLabel&&ee.push(W.dateCategoryLabel),W.departmentName&&ee.push(W.departmentName),W.stageName&&ee.push(W.stageName),ee.length>0?ee.join(" — "):"Список тикетов";default:return""}});function _(){var f,k,h;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employeesCount:((f=e.employees)==null?void 0:f.length)||0,hasSnapshot:!!e.snapshot,snapshotTicketIds:((h=(k=e.snapshot)==null?void 0:k.ticketIds)==null?void 0:h.length)||0,hasTicketDetails:!!e.ticketDetails,snapshotKeys:e.snapshot?Object.keys(e.snapshot):[]}),o.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,m.value=null,c.value=null,s.value=1,l.value="employees",y(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function y(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const f=o.value.snapshot.tickets||[],k=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:f.length,currentStageId:k,sampleTicket:f[0]?{id:f[0].id,stageId:f[0].stageId,hasDepartmentHead:!!f[0].departmentHead,departmentHead:f[0].departmentHead,hasDepartmentHeadFull:!!f[0].departmentHeadFull,departmentHeadFull:f[0].departmentHeadFull,allKeys:Object.keys(f[0])}:null});let h=f.filter(R=>R.stageId?Ye(R.stageId)===k:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:f.length,afterFilter:h.length,stageId:k,ticketsWithStageId:h.filter(R=>R.stageId).length,ticketsWithoutStageId:h.filter(R=>!R.stageId).length});const N=h.filter(R=>!R.departmentHead&&!R.departmentHeadFull);if(N.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:N.length,totalTickets:h.length,ticketsWithDepartment:h.filter(q=>q.departmentHead||q.departmentHeadFull).length});const R=N.map(q=>q.id).filter(q=>q);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:R.length,ticketIdsSample:R.slice(0,10)});const q=await Ft.getTicketsDetails(R),H=new Map;q.forEach(A=>{A&&A.id&&H.set(A.id,A)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:q.length,detailsMapSize:H.size,sampleDetail:q[0]?{id:q[0].id,departmentHead:q[0].departmentHead,departmentHeadFull:q[0].departmentHeadFull}:null}),h=h.map(A=>{const $=H.get(A.id);return $?{...A,stageId:$.stageId||A.stageId||null,departmentHead:$.departmentHead||A.departmentHead||null,departmentHeadFull:$.departmentHeadFull||$.departmentHead||A.departmentHead||null}:A}),h=h.filter(A=>A.stageId?Ye(A.stageId)===k:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:h.length,ticketsWithDepartment:h.filter(A=>A.departmentHead||A.departmentHeadFull).length,ticketsWithoutDepartment:h.filter(A=>!A.departmentHead&&!A.departmentHeadFull).length,ticketsWithStageId:h.filter(A=>A.stageId).length,ticketsWithoutStageId:h.filter(A=>!A.stageId).length});const z=h.length,ue=h.slice(0,3).map(A=>({id:A.id,departmentHead:A.departmentHead,departmentHeadFull:A.departmentHeadFull,stageId:A.stageId}));h=h.filter(A=>A.stageId?Ye(A.stageId)===k:!0);const be=h.slice(0,3).map(A=>({id:A.id,departmentHead:A.departmentHead,departmentHeadFull:A.departmentHeadFull,stageId:A.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:z,afterStageFilter:h.length,filteredOut:z-h.length,currentStageId:k,ticketsWithDepartment:h.filter(A=>A.departmentHead||A.departmentHeadFull).length,ticketsWithoutDepartment:h.filter(A=>!A.departmentHead&&!A.departmentHeadFull).length,sampleBeforeFilter:ue,sampleAfterFilter:be,sampleWithDepartment:h.find(A=>A.departmentHead||A.departmentHeadFull)?{id:h.find(A=>A.departmentHead||A.departmentHeadFull).id,departmentHead:h.find(A=>A.departmentHead||A.departmentHeadFull).departmentHead,departmentHeadFull:h.find(A=>A.departmentHead||A.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(h.find(A=>A.departmentHead||A.departmentHeadFull)).filter(A=>A.toLowerCase().includes("department"))}:null})}catch(q){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",q),console.error("[EmployeeDetailsModal] Error details:",{message:q.message,stack:q.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:h.length,currentStageId:k,ticketsWithStageId:h.filter(R=>R.stageId).length,ticketsWithoutStageId:h.filter(R=>!R.stageId).length,ticketsWithDepartment:h.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:h.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length});const Y=At(h);i.value=Y,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:h.length,sampleTickets:h.slice(0,5).map(R=>({id:R.id,departmentHead:R.departmentHead,departmentHeadFull:R.departmentHeadFull,hasDepartmentHead:!!R.departmentHead,hasDepartmentHeadFull:!!R.departmentHeadFull,allKeys:Object.keys(R).filter(q=>q.toLowerCase().includes("department"))})),ticketsWithDepartment:h.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:h.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length});const W=da(h);u.value=W;const ee=Y.reduce((R,q)=>R+q.count,0),ve=W.reduce((R,q)=>R+q.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:k,totalTicketsForGrouping:h.length,timeCategoriesCount:Y.length,totalTicketsInTimeCategories:ee,departmentsCount:W.length,totalTicketsInDepartments:ve,departmentsSample:W.slice(0,5),ticketsWithDepartment:h.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:h.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length,consistencyCheck:{totalTickets:h.length,timeCategoriesTotal:ee,departmentsTotal:ve,isConsistent:h.length===ee&&h.length===ve}})}catch(f){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",f),console.error("[EmployeeDetailsModal] Error stack:",f.stack)}}async function v(f){if(!f||f.count===0){a.info(`У заказчика "${(f==null?void 0:f.departmentName)||"неизвестный"}" нет тикетов`);return}if(!m.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),a.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:k}=await Oe(async()=>{const{createContextFromLevel3:N}=await import("./ticketListUtils-CCKAM7tn.js");return{createContextFromLevel3:N}},__vite__mapDeps([0,1,2,3,4,5])),h=await k(m.value,f);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:h.employeeName,dateCategory:h.dateCategoryLabel,departmentName:h.departmentName,ticketsCount:h.tickets.length}),await se(h)}catch(k){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",k),a.error("Ошибка перехода на список тикетов: "+k.message)}}async function D(f){if(!f||f.count===0){a.info(`У заказчика "${(f==null?void 0:f.departmentName)||"неизвестный"}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),a.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:k}=await Oe(async()=>{const{createContextFromLevel1Department:N}=await import("./ticketListUtils-CCKAM7tn.js");return{createContextFromLevel1Department:N}},__vite__mapDeps([0,1,2,3,4,5])),h=k(o.value,f);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:h.stageName,departmentName:h.departmentName,ticketsCount:h.tickets.length}),await se(h)}catch(k){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",k),a.error("Ошибка перехода на список тикетов: "+k.message)}}async function M(f){if(!f||f.count===0){a.info(`В категории "${(f==null?void 0:f.label)||"неизвестная"}" нет тикетов`);return}if(!f.tickets||f.tickets.length===0){a.info(`В категории "${f.label}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),a.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:k}=await Oe(async()=>{const{createContextFromLevel1Time:N}=await import("./ticketListUtils-CCKAM7tn.js");return{createContextFromLevel1Time:N}},__vite__mapDeps([0,1,2,3,4,5])),h=k(o.value,f);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:h.stageName,dateCategory:h.dateCategoryLabel,ticketsCount:h.tickets.length}),await se(h)}catch(k){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",k),a.error("Ошибка перехода на список тикетов: "+k.message)}}We(()=>e.isVisible,f=>{f?_():P()}),He(()=>{e.isVisible&&_()});async function J(f,k=null){var h,N,Y;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",f),console.log("[EmployeeDetailsModal] Current popup level:",s.value),k&&k.currentTarget&&(k.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{k.currentTarget&&(k.currentTarget.style.transform="")},150)),!f||!f.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",f);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),a.warning("ID стадии не указан");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",e.snapshot),a.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",f.id,"stage:",o.value.stageId);const W=await ca(f.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(W==null?void 0:W.length)||0,W),!W||W.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),a.info(`У сотрудника "${f.name}" нет тикетов на стадии "${o.value.stageName}"`);return}const ee=At(W);console.log("[EmployeeDetailsModal] Date categories:",(ee==null?void 0:ee.length)||0,ee),p.value={employeeId:f.id,employeeName:f.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:W.length,dateCategories:ee,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),s.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",s.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(h=p.value)==null?void 0:h.employeeName,dateCategoriesCount:((Y=(N=p.value)==null?void 0:N.dateCategories)==null?void 0:Y.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",s.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(W){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",W),console.error("[EmployeeDetailsModal] Error stack:",W.stack),a.error("Ошибка загрузки данных о тикетах: "+W.message)}}async function le(f){if(!f||f.count===0){a.info(`В категории "${(f==null?void 0:f.label)||"неизвестная"}" нет тикетов`);return}if(!f.tickets||f.tickets.length===0){a.info(`В категории "${f.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),a.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:k}=await Oe(async()=>{const{createContextFromLevel2:N}=await import("./ticketListUtils-CCKAM7tn.js");return{createContextFromLevel2:N}},__vite__mapDeps([0,1,2,3,4,5])),h=k(p.value,f);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:h.employeeName,dateCategory:h.dateCategoryLabel,ticketsCount:h.tickets.length}),await se(h)}catch(k){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",k),a.error("Ошибка перехода на список тикетов: "+k.message)}}async function se(f){var k;if(console.time("[Performance] goToLevel4"),!f){console.error("[EmployeeDetailsModal] Context is required for level 4"),a.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:f.sourceLevel,employeeId:f.employeeId,stageId:f.stageId,dateCategory:f.dateCategory,departmentName:f.departmentName,ticketsCount:((k=f.tickets)==null?void 0:k.length)||0});try{c.value={context:f,tickets:[],totalCount:0,isLoading:!0,error:null};let h=f.tickets||[];if(h.length===0&&f.snapshot){const{filterTicketsByContext:Y}=await Oe(async()=>{const{filterTicketsByContext:W}=await import("./ticketListUtils-CCKAM7tn.js");return{filterTicketsByContext:W}},__vite__mapDeps([0,1,2,3,4,5]));h=await Y(f)}(!h||h.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),h=f.tickets||[]),(!h||h.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),f.snapshot&&f.snapshot.tickets&&(h=f.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",h.length)));let N=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:Y}=await Oe(async()=>{const{prepareTicketsForDisplay:W}=await import("./ticketListUtils-CCKAM7tn.js");return{prepareTicketsForDisplay:W}},__vite__mapDeps([0,1,2,3,4,5]));N=await Y(h,f.snapshot,f.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(Y){console.error("[EmployeeDetailsModal] Error preparing tickets:",Y),console.timeEnd("[Performance] prepareTicketsForDisplay"),N=h||[],a.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:h.length,preparedCount:N.length}),c.value={context:f,tickets:N,totalCount:N.length,isLoading:!1,error:null},s.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:c.value.totalCount,ticketsCount:c.value.tickets.length,isLoading:c.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",h),console.error("[EmployeeDetailsModal] Error details:",{message:h.message,stack:h.stack,context:f});let N=[];if(f.snapshot&&f.snapshot.tickets)try{const Y=f.stageId;Y?N=(f.snapshot.tickets||[]).filter(W=>W.stageId===Y):N=f.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",N.length)}catch(Y){console.error("[EmployeeDetailsModal] Error using fallback tickets:",Y)}c.value={context:f,tickets:N,totalCount:N.length,isLoading:!1,error:{message:h.message,hasFallback:N.length>0}},N.length>0?(a.warning("Ошибка загрузки данных. Отображаются данные из кеша."),s.value=4):(a.error("Ошибка загрузки тикетов: "+h.message),V()),console.timeEnd("[Performance] goToLevel4")}}function V(){if(s.value===4){if(c.value&&c.value.context){const f=c.value.context.sourceLevel;s.value=f}else s.value=1;c.value=null}else s.value===3?(s.value=2,m.value=null,c.value=null):s.value===2&&(s.value=1,p.value=null,m.value=null,c.value=null)}function P(){s.value=1,o.value=null,p.value=null,m.value=null,c.value=null}function K(){var Y;if(!((Y=c.value)!=null&&Y.context))return"Нет тикетов";const{sourceLevel:f,employeeName:k,dateCategoryLabel:h,departmentName:N}=c.value.context;return f===2&&k&&h?`Нет тикетов у ${k} в категории "${h}"`:f===3&&k&&N?`Нет тикетов у ${k} у заказчика "${N}"`:f===1&&h?`Нет тикетов в категории "${h}"`:f===1&&N?`Нет тикетов у заказчика "${N}"`:"Нет тикетов для отображения"}function ce(){var k;if(!((k=c.value)!=null&&k.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:f}=c.value.context;return f?`На стадии "${f}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function he(){var k;if(!((k=c.value)!=null&&k.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const f=c.value.context;await se(f)}function de(f){if(!f){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),a.warning("Ошибка: тикет не найден");return}if(!f.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",f),a.error("Ошибка: ID тикета не указан");return}try{const k=Jt(f.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:f.id,iframeUrl:k}),!k||typeof k!="string"||k.length===0)throw new Error("Не удалось сформировать URL для тикета");const h=window.open(k,"_blank","noopener,noreferrer");if(!h||h.closed||typeof h.closed>"u")try{const N=document.createElement("a");N.href=k,N.target="_blank",N.rel="noopener noreferrer",N.style.display="none",document.body.appendChild(N),N.click(),document.body.removeChild(N),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:f.id,iframeUrl:k})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:f.id,iframeUrl:k})}catch(k){console.error("[EmployeeDetailsModal] Error opening ticket:",k),console.error("[EmployeeDetailsModal] Error details:",{message:k.message,stack:k.stack,ticket:f}),a.error("Ошибка открытия тикета: "+k.message)}}function ye(){P(),n("close")}return(f,k)=>(w(),Ae($t,{to:"body"},[d.isVisible?(w(),E("div",{key:0,class:"employee-details-modal",onClick:pe(ye,["self"]),onKeydown:xt(ye,["esc"])},[r("div",ua,[ie(je,{name:"level",mode:"out-in"},{default:Te(()=>{var h,N,Y,W,ee,ve,R,q,H,z,ue,be,A;return[s.value===1?(w(),E("div",pa,[r("div",ma,[r("h3",null,L(((h=o.value)==null?void 0:h.stageName)||d.stageName),1),r("span",ga,"Всего: "+L(((N=o.value)==null?void 0:N.totalCount)||d.totalCount)+" тикетов",1),r("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),r("div",fa,[r("button",{class:oe(["view-switch-btn",{active:l.value==="employees"}]),onClick:k[0]||(k[0]=$=>l.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),r("button",{class:oe(["view-switch-btn",{active:l.value==="time"}]),onClick:k[1]||(k[1]=$=>l.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),r("button",{class:oe(["view-switch-btn",{active:l.value==="departments"}]),onClick:k[2]||(k[2]=$=>l.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),r("div",ha,[l.value==="employees"?(w(),E("div",va,[(((Y=o.value)==null?void 0:Y.employees)||d.employees).length===0&&(!((W=o.value)!=null&&W.others||d.others)||(((ee=o.value)==null?void 0:ee.others)||d.others).count===0)?(w(),E("div",ya," Нет данных о сотрудниках ")):(w(),E("div",ka,[(w(!0),E(ge,null,fe(((ve=o.value)==null?void 0:ve.employees)||d.employees,$=>(w(),E("div",{key:$.id,class:oe(["employee-item",{"employee-keeper":$.isKeeper}]),onClick:pe(re=>J($,re),["stop"]),title:"Кликните для детализации по временным градациям"},[r("span",Sa,L($.name),1),r("div",ba,[r("div",{class:"progress-bar",style:Se({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),r("span",Da,L($.count)+" тикетов ("+L($.percentage)+"%) ",1),k[3]||(k[3]=r("span",{class:"employee-arrow"},"→",-1))],10,wa))),128)),((R=o.value)!=null&&R.others||d.others)&&(((q=o.value)==null?void 0:q.others)||d.others).count>0?(w(),E("div",Ea,[r("span",_a,"Другие ("+L((((H=o.value)==null?void 0:H.others)||d.others).employeeCount)+")",1),r("div",Ca,[r("div",{class:"progress-bar",style:Se({width:(((z=o.value)==null?void 0:z.others)||d.others).progressBarWidth+"%",backgroundColor:(((ue=o.value)==null?void 0:ue.others)||d.others).progressBarColor})},null,4)]),r("span",Ta,L((((be=o.value)==null?void 0:be.others)||d.others).count)+" тикетов ("+L((((A=o.value)==null?void 0:A.others)||d.others).percentage)+"%) ",1)])):Q("",!0)]))])):l.value==="time"?(w(),E("div",Aa,[i.value.length===0?(w(),E("div",Ia," Загрузка данных... ")):(w(),E("div",$a,[(w(!0),E(ge,null,fe(i.value,$=>(w(),E("div",{key:$.category,class:"category-item",onClick:pe(re=>M($),["stop"])},[r("span",Na,L($.label),1),r("div",Fa,[r("div",{class:"progress-bar",style:Se({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),r("span",Ra,L($.count)+" тикетов ("+L($.percentage)+"%) ",1),k[4]||(k[4]=r("span",{class:"category-arrow"},"→",-1))],8,Ma))),128))]))])):l.value==="departments"?(w(),E("div",Ha,[u.value.length===0?(w(),E("div",Oa," Загрузка данных... ")):(w(),E("div",La,[r("table",xa,[k[6]||(k[6]=r("thead",null,[r("tr",null,[r("th",{class:"col-department"},"Заказчик"),r("th",{class:"col-count"},"Количество тикетов"),r("th",{class:"col-action"})])],-1)),r("tbody",null,[(w(!0),E(ge,null,fe(u.value,($,re)=>(w(),E("tr",{key:re,class:"department-row",onClick:pe(ke=>D($),["stop"]),title:"Кликните для просмотра тикетов"},[r("td",Ba,[r("span",Wa,L($.departmentName),1)]),r("td",Ua,[r("span",ja,L($.count),1)]),k[5]||(k[5]=r("td",{class:"col-action"},[r("span",{class:"department-arrow"},"→")],-1))],8,Pa))),128))])])]))])):Q("",!0)])])):s.value===2&&p.value?(w(),E("div",Va,[r("div",za,[r("button",{class:"btn-back",onClick:V,"aria-label":"Назад"}," ← "),r("h3",null,L(p.value.employeeName),1),r("span",Ka,"Всего: "+L(p.value.totalCount)+" тикетов",1),r("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),r("div",Ga,[r("div",Ya,[r("span",qa,L(p.value.stageName),1)]),p.value.dateCategories.length===0?(w(),E("div",Ja," Нет данных о тикетах ")):(w(),E("div",Xa,[(w(!0),E(ge,null,fe(p.value.dateCategories,$=>(w(),E("div",{key:$.category,class:"category-item",onClick:pe(re=>le($),["stop"])},[r("span",Qa,L($.label),1),r("div",es,[r("div",{class:"progress-bar",style:Se({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),r("span",ts,L($.count)+" тикетов ("+L($.percentage)+"%) ",1)],8,Za))),128))]))])])):s.value===3&&m.value?(w(),E("div",as,[r("div",ss,[r("button",{class:"btn-back",onClick:V,"aria-label":"Назад"}," ← "),r("div",ns,[r("h3",null,L(m.value.employeeName),1),r("div",ls,[r("span",os,L(m.value.dateCategoryLabel),1),r("span",rs,L(m.value.stageName),1)])]),r("span",is,"Всего: "+L(m.value.totalCount)+" тикетов",1),r("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),r("div",cs,[m.value.departments.length===0?(w(),E("div",ds," Нет данных о заказчиках ")):(w(),E("div",us,[r("table",ps,[k[8]||(k[8]=r("thead",null,[r("tr",null,[r("th",{class:"col-department"},"Заказчик"),r("th",{class:"col-count"},"Количество тикетов"),r("th",{class:"col-action"})])],-1)),r("tbody",null,[(w(!0),E(ge,null,fe(m.value.departments,($,re)=>(w(),E("tr",{key:re,class:"department-row",onClick:pe(ke=>v($),["stop"]),title:"Кликните для просмотра тикетов"},[r("td",gs,[r("span",fs,L($.departmentName),1)]),r("td",hs,[r("span",vs,L($.count),1)]),k[7]||(k[7]=r("td",{class:"col-action"},[r("span",{class:"department-arrow"},"→")],-1))],8,ms))),128))])])]))])])):s.value===4&&c.value?(w(),E("div",ys,[r("div",ks,[r("button",{class:"btn-back",onClick:V,"aria-label":"Назад"}," ← "),r("div",ws,[r("h3",null,L(b.value),1),c.value.context?(w(),E("div",Ss,[c.value.context.dateCategoryLabel?(w(),E("span",bs,L(c.value.context.dateCategoryLabel),1)):Q("",!0),c.value.context.departmentName?(w(),E("span",Ds,L(c.value.context.departmentName),1)):Q("",!0),r("span",Es,L(c.value.context.stageName),1)])):Q("",!0)]),r("span",_s,"Всего: "+L(c.value.totalCount)+" тикетов",1),r("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),r("div",Cs,[ie(je,{name:"loading",mode:"out-in"},{default:Te(()=>[c.value.isLoading?(w(),E("div",Ts,[...k[9]||(k[9]=[r("div",{class:"loading-spinner"},null,-1),r("p",null,"Загрузка тикетов...",-1)])])):c.value.error&&c.value.error.hasFallback?(w(),E("div",As,[k[10]||(k[10]=r("div",{class:"error-banner"},[r("span",{class:"error-icon"},"⚠️"),r("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),r("div",Is,[ie(wt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(w(!0),E(ge,null,fe(c.value.tickets,($,re)=>(w(),Ae(Ct,{key:$.id,ticket:$,draggable:!1,style:Se({"--ticket-index":re}),onClick:ke=>de($)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):c.value.error&&!c.value.error.hasFallback?(w(),E("div",$s,[k[11]||(k[11]=r("div",{class:"error-icon"},"❌",-1)),k[12]||(k[12]=r("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),r("p",Ms,L(c.value.error.message),1),r("button",{class:"btn-retry",onClick:he},"Повторить попытку")])):!c.value.tickets||c.value.tickets.length===0?(w(),E("div",Ns,[k[13]||(k[13]=r("div",{class:"empty-state-icon"},"📭",-1)),r("h3",Fs,L(K()),1),r("p",Rs,L(ce()),1)])):(w(),E("div",Hs,[ie(wt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(w(!0),E(ge,null,fe(c.value.tickets,($,re)=>(w(),Ae(Ct,{key:$.id,ticket:$,draggable:!1,style:Se({"--ticket-index":re}),onClick:ke=>de($)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):Q("",!0)]}),_:1})])],32)):Q("",!0)]))}},Ls=Ie(Os,[["__scopeId","data-v-d8e1ab60"]]),Pe=10;function qe(d,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(a=>a.ticketsByStage&&a.ticketsByStage[d]>0).forEach(a=>{e.push({id:a.id,name:a.name,count:a.ticketsByStage[d]||0})});const n=xs(d,t);return n>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:n,isKeeper:!0}),e.sort((a,s)=>s.count-a.count)}function xs(d,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[d])return t.statistics.zeroPointByStage[d].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Rt(d,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[d])==null?void 0:e.count)||0}function Je(d,t=Pe){if(!d||d.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...d].sort((l,o)=>o.count-l.count),n=e.slice(0,t),a=e.slice(t),s=a.reduce((l,o)=>l+o.count,0);return{visible:n,others:{employees:a,count:s,employeeCount:a.length}}}function Ht(d,t){return!d||d.length===0?[]:t===0?d.map(e=>({...e,percentage:0})):d.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Ot(d,t,e="#007bff",n=Pe){if(!d||d.length===0)return{employees:[],others:null};const{visible:a,others:s}=Je(d,n),l=Ht(a,t).map(i=>({...i,progressBarWidth:i.percentage,progressBarColor:i.isKeeper?"#f59e0b":e}));let o=null;if(s.count>0){const i=parseFloat((s.count/t*100).toFixed(1));o={...s,percentage:i,progressBarWidth:i,progressBarColor:"#6c757d"}}return{employees:l,others:o}}function Ps(d,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(a=>{const s=t[a];if(!s)return;const l=qe(d,s),o=Rt(d,s);if(l.length===0)return;const{visible:i,others:u}=Je(l,Pe),p=Ht(i,o);e[a]=p,u.count>0&&(e.others[a]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/o*100).toFixed(1))})}),e}function Bs(d,t="current",e=[]){const n=d[t];if(!n)return{labels:[],datasets:[]};const a=new Map;e.forEach(m=>{qe(m.id,n).forEach(b=>{a.has(b.id)||a.set(b.id,{id:b.id,name:b.name,isKeeper:b.isKeeper||!1,ticketsByStage:{}}),a.get(b.id).ticketsByStage[m.id]=b.count})});const s=Array.from(a.values()).map(m=>{const c=Object.values(m.ticketsByStage).reduce((b,_)=>b+_,0);return{...m,totalTickets:c}});s.sort((m,c)=>c.totalTickets-m.totalTickets);const{visible:l,others:o}=Je(s,Pe),i=e.map(()=>""),u={};e.forEach(m=>{const c=qe(m.id,n),{visible:b}=Je(c,Pe);u[m.id]=b.map(_=>({id:_.id,name:_.name,count:_.count}))});const p=l.map((m,c)=>{const b=e.map(y=>m.ticketsByStage[y.id]||0),_=e.map(y=>{if((m.ticketsByStage[y.id]||0)===0)return"transparent";const M=y.color.replace("#",""),J=parseInt(M.substring(0,2),16),le=parseInt(M.substring(2,4),16),se=parseInt(M.substring(4,6),16),V=.6+c*.05;return`rgba(${J}, ${le}, ${se}, ${Math.min(V,.95)})`});return{label:m.name,data:b,backgroundColor:_,borderColor:e.map(y=>{const v=y.color.replace("#",""),D=parseInt(v.substring(0,2),16),M=parseInt(v.substring(2,4),16),J=parseInt(v.substring(4,6),16);return`rgba(${D}, ${M}, ${J}, 0.8)`}),borderWidth:1,meta:{employeeId:m.id,employeeName:m.name}}});if(o.count>0){const m=e.map(c=>o.employees.reduce((b,_)=>b+(_.ticketsByStage[c.id]||0),0));p.push({label:`Другие (${o.employeeCount})`,data:m,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:i,datasets:p,meta:{employeesByStage:u}}}function Ws(d,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const n=e.find(u=>u.id===d),a=n?n.name:"",s=n?n.color:"#007bff",l=qe(d,t),o=Rt(d,t);if(l.length===0)return{stageName:a,totalCount:0,employees:[],others:null};const i=Ot(l,o,s,Pe);return{stageName:a,totalCount:o,employees:i.employees,others:i.others}}function Us(d,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof d!="number"||d<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const n=[];if(t.forEach((l,o)=>{if(!l||!l.data||!Array.isArray(l.data))return;const i=l.data[d];i!=null&&!isNaN(i)&&n.push({datasetIndex:o,value:Number(i),y:Number(i)})}),n.length<2)return 0;const a=[];return n.forEach(l=>{let o=!1;for(const i of a){const u=i.y;if(Math.abs(l.y-u)<e){i.points.push(l),i.y=i.points.reduce((m,c)=>m+c.y,0)/i.points.length,o=!0;break}}o||a.push({points:[l],y:l.y})}),a.length===0?0:a.reduce((l,o)=>o.points.length>l.points.length?o:l,a[0]).points.length}function js(d,t){const e=[];return d.forEach(n=>{let a=!1;for(const s of e){const l=s.y;if(Math.abs(n.value-l)<t){s.points.push(n),s.y=s.points.reduce((o,i)=>o+i.value,0)/s.points.length,a=!0;break}}a||e.push({points:[n],y:n.value})}),e}function Vs(d,t=.5){var s,l;if(!d)return console.warn("findOverlappingPoints: chart не передан"),[];if(!d.config||d.config.type!=="line")return[];const e=(s=d.data)==null?void 0:s.datasets,n=((l=d.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(n)||n.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const a=[];return n.forEach((o,i)=>{try{if(Us(i,e,t)<2)return;const p=[];if(e.forEach((y,v)=>{if(!y||!y.data||!Array.isArray(y.data))return;const D=y.data[i];D==null||isNaN(D)||p.push({datasetIndex:v,value:Number(D),label:y.label||`Dataset ${v}`})}),p.length<2)return;const m=js(p,t);if(m.length===0)return;const c=m.reduce((y,v)=>v.points.length>y.points.length?v:y,m[0]);if(c.points.length<2)return;let b=null,_=null;for(let y=0;y<e.length;y++)try{const v=d.getDatasetMeta(y);if(v&&v.data&&v.data[i]){b=v,_=v.data[i];break}}catch{continue}if(!_||typeof _.x!="number"||typeof _.y!="number")return;a.push({position:i,count:c.points.length,x:_.x,y:_.y,value:c.y,points:c.points.map(y=>({datasetIndex:y.datasetIndex,value:y.value,label:y.label}))})}catch(u){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${i}:`,u)}}),a}const zs=.5,It=6,Ks=2;function Gs(d){return typeof d!="number"||d<2?It:It+(d-1)*Ks}function Ys(d,t){if(!d||!d.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const n=d.ctx,{x:a,y:s,points:l}=t,o=Gs(e);if(n.canvas){n.save();try{n.beginPath(),n.arc(a,s,o,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&d.data&&d.data.datasets){const p=l[0].datasetIndex,m=d.data.datasets[p];if(m&&m.pointBackgroundColor){const c=Array.isArray(m.pointBackgroundColor)?m.pointBackgroundColor[t.position]||m.pointBackgroundColor[0]:m.pointBackgroundColor;if(c)if(c.startsWith("#")){const b=parseInt(c.slice(1,3),16),_=parseInt(c.slice(3,5),16),y=parseInt(c.slice(5,7),16);u=`rgba(${b}, ${_}, ${y}, 0.4)`}else c.startsWith("rgba")?u=c.replace(/rgba?\(([^)]+)\)/,(b,_)=>{const y=_.split(",").map(v=>v.trim());return`rgba(${y[0]}, ${y[1]}, ${y[2]}, 0.4)`}):u=c+"66"}}n.fillStyle=u,n.fill(),n.strokeStyle=u.replace("0.4","0.6").replace("66","99"),n.lineWidth=1,n.stroke()}catch(u){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",u)}finally{n.restore()}}}const qs={id:"overlappingPointsPlugin",afterDatasetsDraw:d=>{if(!(!d||!d.config||d.config.type!=="line")&&d.ctx)try{const t=Vs(d,zs);if(!Array.isArray(t)||t.length===0)return;t.filter(n=>!(!n||typeof n!="object"||typeof n.count!="number"||n.count<2||typeof n.x!="number"||typeof n.y!="number"||!isFinite(n.x)||!isFinite(n.y))).forEach(n=>{try{Ys(d,n)}catch(a){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${n.position}:`,a)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},Js={class:"graph-state-chart"},Xs={class:"chart-header"},Zs={class:"chart-type-selector"},Qs=["onClick","title"],en={class:"chart-type-icon"},tn={class:"chart-type-label"},an={key:0,class:"comparison-type-selector"},sn={class:"radio-group"},nn={key:0},ln={key:1},on={key:2,class:"graph-legend"},rn={key:4,class:"error-container"},cn={class:"error-message"},dn={key:5,class:"chart-container"},un={class:"chart-wrapper"},pn={class:"chart-canvas-container"},mn={key:0,class:"bar-chart-stage-labels"},gn={key:6,class:"no-data"},fn={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(d,{emit:t}){const e=(C,g)=>typeof window>"u"?g:getComputedStyle(document.documentElement).getPropertyValue(C).trim()||g,n=d,a=t,s=F(!1),l=F(null),o=F(null),i=F({weekStart:null,weekEnd:null,current:null}),u=F(null),p=F("weekStartToWeekEnd"),m=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],c=F("line"),b=F(!1),_=F(""),y=F(""),v=F(0),D=F([]),M=F(null),J=F(null),le=F(null),se=F([]),V=te(()=>{switch(c.value){case"line":return bt;case"bar":return Gt;case"doughnut":return Kt;default:return bt}}),P={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},K=[{id:"formed",name:"Сформировано обращение",color:P.formed},{id:"review",name:"Рассмотрение ТЗ",color:P.review},{id:"execution",name:"Исполнение",color:P.execution}],ce=["circle","triangle","rect","rectRot","star","cross","crossRot"],he=F({formed:!0,review:!0,execution:!0}),de=Ve(),ye={id:"employeeLabelsPlugin",afterDatasetsDraw:C=>{if(C.config.type==="bar")try{const g=C.ctx;if(!C.data||!C.data.datasets)return;const S=C.data.datasets,T=C.scales.y;S.forEach((I,x)=>{const O=C.getDatasetMeta(x);if(!O||O.hidden)return;const G=I.label||"";if(!G||G.includes("Другие"))return;const j=G.trim().split(/\s+/);let B="";if(j.length===1)B=j[0];else{const U=j[0],Z=j.slice(1).join(" ");B=`${U}
${Z}`}const X=B.split(`
`);I.data.forEach((U,Z)=>{if(U===0||!U)return;const ae=O.data[Z];if(!ae||typeof ae.x!="number"||typeof ae.y!="number")return;const we=ae.x,Me=ae.y+ae.height+25;g.save(),g.font="bold 9px Arial, sans-serif",g.fillStyle="#6b7280",g.textAlign="center",g.textBaseline="top",g.translate(we,Me),g.rotate(-12*Math.PI/180),X.forEach((De,Ne)=>{const Fe=De.trim();Fe&&g.fillText(Fe,0,Ne*11)}),g.restore()})})}catch(g){console.error("Error in employeeLabelsPlugin:",g)}}};St.register(ye);function f(){const C=new Map;[i.value.weekStart,i.value.weekEnd,i.value.current].forEach(g=>{!g||!g.statistics||!g.statistics.employees||g.statistics.employees.forEach(S=>{C.has(S.id)||C.set(S.id,{id:S.id,name:S.name})})}),se.value=Array.from(C.values()).sort((g,S)=>g.name.localeCompare(S.name))}function k(C,g="background"){var T;return((T={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[C])==null?void 0:T[g])||e("--b24-text-secondary","#6c757d")}function h(){if(!(!i.value.weekStart||!i.value.weekEnd))try{const C=nt.compareTwoSnapshots(i.value.weekStart,i.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let g=null,S=null;i.value.current&&(g=nt.compareTwoSnapshots(i.value.weekEnd,i.value.current,{includeTickets:!1,includeEmployees:!0}),S=nt.compareTwoSnapshots(i.value.weekStart,i.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:C,weekEndToCurrent:g,weekStartToCurrent:S}}catch(C){console.error("Ошибка сравнения слепков:",C),de.warning("Не удалось выполнить сравнение слепков: "+C.message)}}function N(C){return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[C]||"formed"}function Y(C){return N(C)}function W(C){return C===0?"weekStart":C===1?"weekEnd":C===2?"current":"weekEnd"}function ee(C){return i.value[C]||null}function ve(C,g,S,T,I=null,x=null,O=null){var G;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:C,stageId:g,totalCount:S,employeesCount:(T==null?void 0:T.length)||0,hasSnapshot:!!x,snapshotTicketIds:((G=x==null?void 0:x.ticketIds)==null?void 0:G.length)||0}),_.value=C,y.value=g||"",v.value=S,D.value=T||[],M.value=I&&I.count>0?I:null,J.value=x,le.value=O,b.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:y.value,hasCurrentSnapshot:!!J.value})}function R(C,g,S){var G,j,B,X,U,Z;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:C,timePoint:g,employeeDataCount:S==null?void 0:S.length});const T=K.find(ae=>ae.id===C);if(!T){console.warn("[GraphStateChart] Stage not found:",C);return}const I=ee(g);if(console.log("[GraphStateChart] Snapshot for timePoint:",g,I?"found":"not found"),!I){console.warn("[GraphStateChart] Snapshot not found for timePoint:",g),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!i.value.weekStart,weekEnd:!!i.value.weekEnd,current:!!i.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!I.tickets,ticketsIsArray:Array.isArray(I.tickets),ticketsLength:((G=I.tickets)==null?void 0:G.length)||0,hasTicketIds:!!I.ticketIds,ticketIdsLength:((j=I.ticketIds)==null?void 0:j.length)||0,hasMetadata:!!I.metadata,hasStatistics:!!I.statistics,snapshotKeys:Object.keys(I),snapshotType:typeof I}),!I.tickets||!Array.isArray(I.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",I),de.warning("Слепок не содержит данных о тикетах");return}const x=((U=(X=(B=I.statistics)==null?void 0:B.stages)==null?void 0:X[C])==null?void 0:U.count)||0;console.log("[GraphStateChart] Total count for stage:",x);const O=Ot(S,x,T.color,10);console.log("[GraphStateChart] Opening modal with:",{stageName:T.name,stageId:C,totalCount:x,employeesCount:((Z=O.employees)==null?void 0:Z.length)||0,hasSnapshot:!!I,snapshotHasTickets:!!I.tickets}),ve(T.name,C,x,O.employees,O.others,I,null)}function q(C,g){if(!g||!g.employees||g.employees.length===0){de.warning("Нет данных о сотрудниках для этого этапа");return}const S=i.value.current||i.value.weekEnd||i.value.weekStart;ve(g.stageName,C,g.totalCount,g.employees,g.others,S,null)}function H(){b.value=!1,_.value="",y.value="",v.value=0,D.value=[],M.value=null,J.value=null,le.value=null}function z(C,g,S){var X,U;if(c.value!=="line"||g.length===0)return;const T=g[0],I=T.datasetIndex,x=T.index,O=S.data.datasets[I];if(!O||!O.meta)return;const G=Y(O.label),j=W(x),B=(U=(X=O.meta)==null?void 0:X.employees)==null?void 0:U[j];!B||B.length===0||R(G,j,B)}function ue(C,g,S){var X,U;if(c.value!=="doughnut"||g.length===0)return;const I=g[0].index,x=S.data,O=x.labels[I],G=Y(O),j=(U=(X=x.datasets[0])==null?void 0:X.meta)==null?void 0:U.employees,B=j==null?void 0:j[G];if(!B){console.warn("Данные о сотрудниках не найдены для этапа:",G);return}q(G,B)}function be(C){var T;const g=K[C];if(!g)return 0;const S=i.value.current||i.value.weekEnd||i.value.weekStart;return!S||!S.statistics||!S.statistics.stages?0:((T=S.statistics.stages[g.id])==null?void 0:T.count)||0}function A(C){var I;const g=K.find(x=>x.id===C);if(!g)return"";const S=i.value.current||i.value.weekEnd||i.value.weekStart;if(!S||!S.statistics||!S.statistics.stages)return g.name;const T=((I=S.statistics.stages[C])==null?void 0:I.count)||0;return`${g.name} (${T})`}const $=te(()=>{if(!o.value)return null;if(c.value==="doughnut"||c.value==="bar")return o.value;const C=o.value.datasets.filter(g=>{const S=K.find(T=>T.name===g.label);return S?he.value[S.id]:!0});return{...o.value,datasets:C}});te(()=>c.value!=="bar"||!o.value||!o.value.meta?null:o.value.meta.employeesByStage||null);const re=te(()=>{const C={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:c.value==="bar"?{bottom:80}:{}},onClick:(g,S,T)=>{c.value==="line"?z(g,S,T):c.value==="doughnut"&&ue(g,S,T)},onHover:(g,S,T)=>{c.value==="doughnut"&&(g.native.target.style.cursor=S.length>0?"pointer":"default")},plugins:{legend:{display:c.value!=="bar",position:c.value==="doughnut"?"right":"top",onClick:(g,S,T)=>{if(c.value==="bar"){const x=S.datasetIndex;if(x!==void 0){const O=T.chart.getDatasetMeta(x);O.hidden=!O.hidden,T.chart.update()}return}const I=S.datasetIndex;if(I!==void 0){const x=T.chart.getDatasetMeta(I);x.hidden=!x.hidden,T.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:g=>{if(c.value==="bar"){const S=g[0].dataIndex,T=K[S];return T?T.name:""}return g[0].label||""},label:g=>{var x,O,G,j,B,X;const S=g.dataset.label||"",T=g.parsed.y||g.parsed||0,I=g.dataIndex;if(c.value==="bar"){const U=g.dataset,Z=g.dataIndex,ae=K[Z],we=ae?ae.name:"";return`${U.label}: ${T} тикетов на этапе "${we}"`}if(c.value==="doughnut"){const U=g.dataset.data.reduce((ae,we)=>ae+we,0),Z=U>0?(T/U*100).toFixed(1):0;return`${S}: ${T} тикетов (${Z}%)`}else{if(!u.value||I===0)return`${S}: ${T} тикетов`;let U=null;const Z=N(S);if(p.value==="weekStartToWeekEnd"&&I===1?U=(O=(x=u.value.weekStartToWeekEnd)==null?void 0:x.stages)==null?void 0:O[Z]:p.value==="weekEndToCurrent"&&I===2&&i.value.current?U=(j=(G=u.value.weekEndToCurrent)==null?void 0:G.stages)==null?void 0:j[Z]:p.value==="weekStartToCurrent"&&I===2&&i.value.current&&(U=(X=(B=u.value.weekStartToCurrent)==null?void 0:B.stages)==null?void 0:X[Z]),!U)return`${S}: ${T} тикетов`;const ae=U.delta,we=U.deltaPercent,Me=U.trend;let De=`${S}: ${T} тикетов`;if(ae!==0){const Ne=ae>0?"+":"",Fe=Me==="increase"?"↑":Me==="decrease"?"↓":"→";De+=` (${Ne}${ae}, ${Ne}${we.toFixed(1)}%) ${Fe}`}else De+=" (без изменений)";return De}},afterBody:g=>{if(c.value==="bar"&&g.length>0){const x=g[0];x.dataset;const O=x.parsed.y||0,G=x.dataIndex,j=be(G);return[`${j>0?(O/j*100).toFixed(1):0}% от общего количества этапа`]}if(c.value==="doughnut"&&g.length>0)return["Кликните для детализации по сотрудникам"];if(c.value==="line"){const x=[];if(u.value){const O=g[0].dataIndex;if(O!==0){let G=null;if(N(g[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&O===1?G=u.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&O===2?G=u.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&O===2&&(G=u.value.weekStartToCurrent),G&&G.metadata){const j=G.metadata.timeDiff;x.push(`Период: ${j.days} дн. ${j.hours} ч. ${j.minutes} мин.`)}}}return x.push("Кликните для детализации по сотрудникам"),x}if(!u.value)return[];const S=g[0].dataIndex;if(S===0)return[];let T=null;if(N(g[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&S===1?T=u.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&S===2?T=u.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&S===2&&(T=u.value.weekStartToCurrent),!T||!T.metadata)return[];const I=T.metadata.timeDiff;return[`Период: ${I.days} дн. ${I.hours} ч. ${I.minutes} мин.`]}}},title:{display:!1}}};return c.value==="line"||c.value==="bar"?{...C,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:c.value==="doughnut"?{...C,cutout:"60%"}:C});function ke(C){const g=new Date(C),S=g.getFullYear(),T=String(g.getMonth()+1).padStart(2,"0"),I=String(g.getDate()).padStart(2,"0");return`${S}-${T}-${I}`}function Ze(C){const{current:g,weekEnd:S}=C,T=g||S;if(!T||!T.statistics||!T.statistics.stages)return null;const I=[],x=[],O=[],G=[],j={};return K.forEach(B=>{var U;const X=((U=T.statistics.stages[B.id])==null?void 0:U.count)||0;if(X>0){I.push(B.name),x.push(X),O.push(B.color+"80"),G.push(B.color);const Z=Ws(B.id,T,K);Z&&Z.employees&&(j[B.id]=Z)}}),x.length===0?null:{labels:I,datasets:[{label:"Распределение по этапам",data:x,backgroundColor:O,borderColor:G,borderWidth:2,meta:{employees:j}}]}}function Qe(C){if(c.value==="doughnut")return Ze(C);if(c.value==="bar"){const O=n.showCurrentState&&C.current?"current":C.weekEnd?"weekEnd":"weekStart";return Bs(C,O,K)}const{weekStart:g,weekEnd:S,current:T}=C,I=[],x=[];return K.forEach((O,G)=>{var we,Me,De,Ne,Fe,it,ct,dt,ut,pt,mt,gt,ft,ht,vt,yt,kt;const j=[];if(g&&g.statistics&&g.statistics.stages){const ne=g.statistics.stages[O.id];if(I.length===0){const Be=(we=g.metadata)!=null&&we.createdAt?new Date(g.metadata.createdAt):null;I.push(Be?ke(Be):"Начало недели")}j.push((ne==null?void 0:ne.count)||0)}else I.length===0&&I.push("Начало недели"),j.push(0);if(S&&S.statistics&&S.statistics.stages){const ne=S.statistics.stages[O.id];if(I.length===1){const Be=(Me=S.metadata)!=null&&Me.createdAt?new Date(S.metadata.createdAt):null;I.push(Be?ke(Be):"Конец недели")}j.push((ne==null?void 0:ne.count)||0)}else I.length===1&&I.push("Конец недели"),j.push(0);if(T&&n.showCurrentState&&T.statistics&&T.statistics.stages){const ne=T.statistics.stages[O.id];I.length===2&&I.push("Текущее состояние"),j.push((ne==null?void 0:ne.count)||0)}const B=["stable"];u.value?p.value==="weekStartToWeekEnd"?(B.push(((Fe=(Ne=(De=u.value.weekStartToWeekEnd)==null?void 0:De.stages)==null?void 0:Ne[O.id])==null?void 0:Fe.trend)||"stable"),T&&B.push(((dt=(ct=(it=u.value.weekStartToCurrent)==null?void 0:it.stages)==null?void 0:ct[O.id])==null?void 0:dt.trend)||"stable")):p.value==="weekEndToCurrent"&&T?(B.push("stable"),B.push(((mt=(pt=(ut=u.value.weekEndToCurrent)==null?void 0:ut.stages)==null?void 0:pt[O.id])==null?void 0:mt.trend)||"stable")):p.value==="weekStartToCurrent"&&T?(B.push(((ht=(ft=(gt=u.value.weekStartToWeekEnd)==null?void 0:gt.stages)==null?void 0:ft[O.id])==null?void 0:ht.trend)||"stable"),B.push(((kt=(yt=(vt=u.value.weekStartToCurrent)==null?void 0:vt.stages)==null?void 0:yt[O.id])==null?void 0:kt.trend)||"stable")):(B.push("stable"),T&&B.push("stable")):(B.push("stable"),T&&B.push("stable"));let X,U,Z;u.value&&c.value!=="doughnut"?(X=B.map(ne=>k(ne,"background")+"40"),U=B.map(ne=>k(ne,"border")),Z=B.map(ne=>k(ne,"point"))):(X=O.color+"40",U=O.color,Z=O.color);let ae=null;c.value==="line"&&(ae={employees:Ps(O.id,C)}),x.push({label:O.name,data:j,backgroundColor:(Array.isArray(X),X),borderColor:(Array.isArray(U),U),borderWidth:2,...c.value==="line"&&{pointStyle:ce[G%ce.length]},pointBackgroundColor:(Array.isArray(Z),Z),pointBorderColor:(Array.isArray(U),U),pointRadius:6,pointHoverRadius:8,fill:c.value!=="line",tension:c.value==="line"?.4:0,meta:ae})}),I.length===0&&(I.push("Начало недели","Конец недели"),n.showCurrentState&&I.push("Текущее состояние")),{labels:I,datasets:x}}const et=async()=>{var C,g,S;s.value=!0,l.value=null;try{const T=(C=n.period)!=null&&C.endDate?new Date(n.period.endDate):new Date,I=(g=n.period)!=null&&g.startDate?new Date(n.period.startDate):Ce.getWeekStartDate(T),x=(S=n.period)!=null&&S.endDate?new Date(n.period.endDate):Ce.getWeekEndDate(T),O=Ce.formatDate(I),G=Ce.formatDate(x),[j,B]=await Promise.all([Ce.getSnapshot(O,"week_start"),Ce.getSnapshot(G,"week_end")]);let X=null;n.showCurrentState&&(X=await rt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),i.value={weekStart:j,weekEnd:B,current:X},f(),h(),$e(),a("data-loaded",{weekStart:j,weekEnd:B,current:X})}catch(T){console.error("Error loading chart data:",T),l.value=T.message||"Ошибка загрузки данных графика",de.error("Ошибка загрузки данных графика: "+l.value),a("error",l.value)}finally{s.value=!1}};He(()=>{St.register(qs),et()});function Lt(C){he.value=C}const $e=()=>{var g;const C=Qe({weekStart:i.value.weekStart,weekEnd:i.value.weekEnd,current:i.value.current});if(!o.value||!o.value.labels||o.value.labels.length!==((g=C==null?void 0:C.labels)==null?void 0:g.length))o.value=C;else if(C){const S=JSON.stringify(o.value),T=JSON.stringify(C);S!==T&&(o.value=C)}};return We(()=>[n.period,n.showCurrentState],()=>{et()},{deep:!0}),We(c,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&$e()}),We(p,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&$e()}),(C,g)=>(w(),E("div",Js,[r("div",Xs,[g[3]||(g[3]=r("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),r("div",Zs,[(w(),E(ge,null,fe(m,S=>r("button",{key:S.value,onClick:T=>c.value=S.value,class:oe(["chart-type-btn",{active:c.value===S.value}]),title:S.label},[r("span",en,L(S.icon),1),r("span",tn,L(S.label),1)],10,Qs)),64))])]),!s.value&&!l.value&&u.value&&c.value!=="doughnut"?(w(),E("div",an,[g[7]||(g[7]=r("h4",{class:"comparison-title"},"Тип сравнения:",-1)),r("div",sn,[r("label",null,[Ke(r("input",{type:"radio","onUpdate:modelValue":g[0]||(g[0]=S=>p.value=S),value:"weekStartToWeekEnd",onChange:$e},null,544),[[tt,p.value]]),g[4]||(g[4]=r("span",null,"Начало недели → Конец недели",-1))]),i.value.current?(w(),E("label",nn,[Ke(r("input",{type:"radio","onUpdate:modelValue":g[1]||(g[1]=S=>p.value=S),value:"weekEndToCurrent",onChange:$e},null,544),[[tt,p.value]]),g[5]||(g[5]=r("span",null,"Конец недели → Текущее состояние",-1))])):Q("",!0),i.value.current?(w(),E("label",ln,[Ke(r("input",{type:"radio","onUpdate:modelValue":g[2]||(g[2]=S=>p.value=S),value:"weekStartToCurrent",onChange:$e},null,544),[[tt,p.value]]),g[6]||(g[6]=r("span",null,"Начало недели → Текущее состояние",-1))])):Q("",!0)])])):Q("",!0),!s.value&&!l.value&&o.value?(w(),Ae(ia,{key:1,stages:K,selected:he.value,"onUpdate:selected":Lt,onChange:$e},null,8,["selected"])):Q("",!0),!s.value&&!l.value&&u.value&&c.value!=="doughnut"?(w(),E("div",on,[...g[8]||(g[8]=[Pt('<h4 class="legend-title" data-v-8956dc9f>Легенда:</h4><div class="legend-items" data-v-8956dc9f><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-increase" data-v-8956dc9f></span><span data-v-8956dc9f>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-decrease" data-v-8956dc9f></span><span data-v-8956dc9f>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-8956dc9f><span class="legend-color legend-stable" data-v-8956dc9f></span><span data-v-8956dc9f>Серый — без изменений</span></div></div>',2)])])):Q("",!0),s.value?(w(),Ae(Mt,{key:3,message:"Загрузка данных графика..."})):l.value?(w(),E("div",rn,[r("p",cn,"❌ "+L(l.value),1),r("button",{onClick:et,class:"btn-retry"},"Повторить загрузку")])):$.value?(w(),E("div",dn,[r("div",un,[r("div",pn,[(w(),Ae(Bt(V.value),{data:$.value,options:re.value},null,8,["data","options"]))]),c.value==="bar"?(w(),E("div",mn,[(w(),E(ge,null,fe(K,S=>r("div",{key:S.id,class:"stage-label-item"},L(A(S.id)),1)),64))])):Q("",!0)])])):(w(),E("div",gn,[...g[9]||(g[9]=[r("p",null,"📊 Нет данных для отображения",-1),r("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ie(Ls,{"is-visible":b.value,"stage-name":_.value,"stage-id":y.value,"total-count":v.value,employees:D.value,others:M.value,snapshot:J.value,"ticket-details":le.value,onClose:H},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details"])]))}},hn=Ie(fn,[["__scopeId","data-v-8956dc9f"]]),vn={key:0,class:"create-snapshot-button-container"},yn=["disabled"],kn={class:"modal-content"},wn={class:"modal-header"},Sn=["disabled"],bn={class:"modal-body"},Dn={key:0,class:"progress-container"},En={class:"progress-bar-wrapper"},_n={class:"progress-text"},Cn={class:"progress-percent"},Tn={class:"progress-description"},An={key:1},In={class:"modal-footer"},$n=["disabled"],Mn=["disabled"],Nn={key:0},Fn={key:0},Rn={key:1},Hn={key:2},On={key:1},Ln={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(d,{emit:t}){const e=d,n=t,a=F(e.user),s=F(!1),l=F(!1),o=F(0),i=F("idle"),u=F(""),p=Ve(),m=te(()=>a.value?Wt(a.value):!1);He(async()=>{if(!e.user)try{const v=await Nt.checkAccess();v.allowed&&(a.value=v.user)}catch(v){console.error("Error loading user:",v)}});const c=()=>{if(!m.value){p.warning("Только администраторы могут создавать слепки");return}s.value=!0},b=()=>{l.value||(s.value=!1,i.value="idle",o.value=0,u.value="")},_=async()=>{if(!l.value){if(!m.value){p.warning("Только администраторы могут создавать слепки");return}l.value=!0,i.value="loading_data",o.value=0,u.value="Инициализация загрузки данных...";try{u.value="Загрузка данных сектора из Bitrix24...";const v=await rt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:J=>{var se;const le=Math.min(80,(J.progress||0)*.8);o.value=le,i.value="loading_data",u.value=J.description||((se=J.details)==null?void 0:se.description)||"Загрузка данных сектора..."}});i.value="creating_snapshot",o.value=85,u.value="Создание слепка...";const D=a.value;if(!D)throw new Error("Пользователь не определён");const M=await Ce.createSnapshot(v,"manual",{createdBy:{id:D.ID,name:`${D.NAME||""} ${D.LAST_NAME||""}`.trim()||D.EMAIL||`User ${D.ID}`},sectorId:"1C"});i.value="success",o.value=100,u.value="Слепок успешно создан!",p.success("Слепок состояния сектора успешно создан"),n("snapshot-created",M),setTimeout(()=>{b()},1500)}catch(v){i.value="error",o.value=0,u.value="Ошибка создания слепка",console.error("Error creating snapshot:",v);let D="Ошибка создания слепка";v.message&&(v.message.includes("загрузки данных")||v.message.includes("sector data")?D="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":v.message.includes("создания слепка")||v.message.includes("snapshot")?D="Не удалось создать слепок. Обратитесь в поддержку.":v.message.includes("валидац")||v.message.includes("validation")?D="Ошибка валидации данных. Проверьте данные сектора.":D=v.message),p.error(D)}finally{l.value=!1}}},y=v=>{v.key==="Escape"&&s.value&&!l.value&&b()};return He(()=>{window.addEventListener("keydown",y)}),Xe(()=>{window.removeEventListener("keydown",y)}),(v,D)=>m.value?(w(),E("div",vn,[r("button",{class:"create-snapshot-btn",onClick:c,disabled:l.value,title:"Создать слепок состояния сектора"},[...D[1]||(D[1]=[r("span",{class:"btn-icon"},"📸",-1),r("span",{class:"btn-text"},"Создать слепок",-1)])],8,yn),(w(),Ae($t,{to:"body"},[ie(je,{name:"modal"},{default:Te(()=>[s.value?(w(),E("div",{key:0,class:"modal-overlay",onClick:D[0]||(D[0]=pe(M=>!l.value&&b(),["self"]))},[r("div",kn,[r("div",wn,[D[2]||(D[2]=r("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),r("button",{class:"modal-close",onClick:b,disabled:l.value,"aria-label":"Закрыть"}," ✕ ",8,Sn)]),r("div",bn,[i.value!=="idle"?(w(),E("div",Dn,[r("div",En,[r("div",{class:"progress-bar",style:Se({width:`${o.value}%`})},null,4)]),r("div",_n,[r("span",Cn,L(Math.round(o.value))+"%",1),r("span",Tn,L(u.value),1)])])):(w(),E("div",An,[...D[3]||(D[3]=[r("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),r("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),r("div",In,[r("button",{class:"btn btn-secondary",onClick:b,disabled:l.value}," Отмена ",8,$n),r("button",{class:"btn btn-primary",onClick:_,disabled:l.value},[l.value?(w(),E("span",Nn,[i.value==="loading_data"?(w(),E("span",Fn,"Загрузка данных...")):i.value==="creating_snapshot"?(w(),E("span",Rn,"Создание...")):(w(),E("span",Hn,"Обработка..."))])):(w(),E("span",On,"Создать"))],8,Mn)])])])):Q("",!0)]),_:1})]))])):Q("",!0)}},xn=Ie(Ln,[["__scopeId","data-v-09bccee2"]]),Pn=20,Bn=5*60*1e3;async function Wn({search:d="",limit:t=Pn,sectorDepartmentId:e=Tt.SECTOR_1C}={}){const n=`sector1c_employees_${d}_${t}_${e||"all"}`,a=sessionStorage.getItem(n);if(a)try{const{data:s,timestamp:l}=JSON.parse(a);if(Date.now()-l<Bn)return s}catch(s){console.warn("[sector1cEmployees] Cache parse error:",s)}try{const s={ACTIVE:"Y"};e?Array.isArray(e)?s.UF_DEPARTMENT=e:s.UF_DEPARTMENT=[e]:s.UF_DEPARTMENT=[Tt.SECTOR_1C],d&&d.length>=2&&(s["%NAME"]=d,s["%LAST_NAME"]=d,s["%WORK_POSITION"]=d);const i=((await ot.call("user.get",{filter:s,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:Un(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(n,JSON.stringify({data:i,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return i}catch(s){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",s),new Error(`Не удалось загрузить сотрудников: ${s.message}`)}}function Un(d){const t=[d.LAST_NAME,d.NAME,d.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):d.NAME||"Без имени"}const jn={class:"employee-select-field-text"},Vn={key:0,class:"employee-select-dropdown"},zn={class:"employee-select-dropdown-search"},Kn={key:0,class:"employee-select-state"},Gn={key:1,class:"employee-select-state employee-select-state--error"},Yn={key:2,class:"employee-select-state"},qn=["checked"],Jn=["checked","onChange"],Xn={class:"employee-select-item-content"},Zn={class:"employee-select-item-name"},Qn={key:0,class:"employee-select-item-position"},el={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(d,{emit:t}){const e=d,n=t,a=F(null),s=F(null),l=F(""),o=F([]),i=F(!1),u=F(null),p=F(!1),m=te(()=>{if(!l.value)return o.value;const V=l.value.toLowerCase();return o.value.filter(P=>P.name.toLowerCase().includes(V)||P.position&&P.position.toLowerCase().includes(V))}),c=te(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const V=o.value.find(P=>P.id===e.selected[0]);return V?V.name:e.placeholder}return`Выбрано: ${e.selected.length} ${le(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function b(V=""){i.value=!0,u.value=null;try{o.value=await Wn({search:V})}catch(P){u.value=P,n("error",P)}finally{i.value=!1}}function _(){n("search",l.value)}function y(){i.value||(p.value=!p.value,p.value?(o.value.length===0&&b(),jt(()=>{s.value&&s.value.focus()})):l.value="")}function v(V){a.value&&!a.value.contains(V.target)&&(p.value=!1,l.value="")}function D(V){const P=[...e.selected],K=P.indexOf(V);if(V==="all")if(K>-1)P.splice(K,1);else return n("update:selected",["all"]);else if(K>-1)P.splice(K,1);else{const ce=P.indexOf("all");ce>-1&&P.splice(ce,1),P.push(V)}n("update:selected",P)}function M(V){return V==="all"?e.selected.includes("all"):e.selected.includes(V)||e.selected.includes("all")}const J=te(()=>l.value?`Нет сотрудников по запросу "${l.value}"`:"Нет сотрудников сектора 1С");function le(V,P,K,ce){const he=V%10,de=V%100;return de>=11&&de<=19?ce:he===1?P:he>=2&&he<=4?K:ce}function se(){b(l.value)}return We(()=>e.selected,V=>{(!V||V.length===0)&&n("update:selected",["all"])},{immediate:!0}),He(()=>{document.addEventListener("click",v),(!e.selected||e.selected.length===0)&&n("update:selected",["all"])}),Xe(()=>{document.removeEventListener("click",v)}),(V,P)=>(w(),E("div",{class:"employee-select",ref_key:"selectContainer",ref:a},[r("div",{class:oe(["employee-select-field",{"employee-select-field--open":p.value,"employee-select-field--disabled":i.value}]),onClick:y},[r("span",jn,L(c.value),1),r("span",{class:oe(["employee-select-field-icon",{open:p.value}])},"▼",2)],2),ie(je,{name:"dropdown-fade"},{default:Te(()=>[p.value?(w(),E("div",Vn,[r("div",zn,[Ke(r("input",{"onUpdate:modelValue":P[0]||(P[0]=K=>l.value=K),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:_,onClick:P[1]||(P[1]=pe(()=>{},["stop"])),ref_key:"searchInput",ref:s},null,544),[[Ut,l.value]])]),i.value?(w(),E("div",Kn,[...P[6]||(P[6]=[r("span",{class:"spinner"},"⏳",-1),r("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):u.value?(w(),E("div",Gn,[r("span",null,"❌ "+L(u.value.message||"Ошибка загрузки сотрудников"),1),r("button",{onClick:[se,P[2]||(P[2]=pe(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!i.value&&m.value.length===0&&!u.value?(w(),E("div",Yn,[r("span",null,"📭 "+L(J.value),1)])):(w(),E("div",{key:3,class:"employee-select-list",style:Se({maxHeight:`${d.maxHeight}px`})},[r("label",{class:oe(["employee-select-item",{"employee-select-item--selected":M("all")}]),onClick:P[4]||(P[4]=pe(()=>{},["stop"]))},[r("input",{type:"checkbox",checked:M("all"),onChange:P[3]||(P[3]=K=>D("all"))},null,40,qn),P[7]||(P[7]=r("div",{class:"employee-select-item-content"},[r("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(w(!0),E(ge,null,fe(m.value,K=>(w(),E("label",{key:K.id,class:oe(["employee-select-item",{"employee-select-item--selected":M(K.id)}]),onClick:P[5]||(P[5]=pe(()=>{},["stop"]))},[r("input",{type:"checkbox",checked:M(K.id),onChange:ce=>D(K.id)},null,40,Jn),r("div",Xn,[r("span",Zn,L(K.name),1),K.position?(w(),E("span",Qn,L(K.position),1)):Q("",!0)])],2))),128))],4))])):Q("",!0)]),_:1})],512))}},tl=Ie(el,[["__scopeId","data-v-6b8c949b"]]),al={class:"stage-select-field-text"},sl={key:0,class:"stage-select-dropdown"},nl={class:"stage-select-list"},ll=["checked"],ol=["checked","onChange"],rl={class:"stage-select-item-content"},il={class:"stage-select-item-name"},cl={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(d,{emit:t}){const e=d,n=t,a=F(null),s=F(!1),l=te(()=>Object.values(e.selected).every(c=>c===!0)),o=te(()=>{if(l.value)return e.placeholder;const c=e.stages.filter(b=>e.selected[b.id]);return c.length===0?"Этапы не выбраны":c.length===1?c[0].name:`Выбрано: ${c.length} этапа(ов)`});function i(){s.value=!s.value,s.value}function u(c){a.value&&!a.value.contains(c.target)&&(s.value=!1)}function p(c,b){const _={...e.selected};_[c]=b,n("update:selected",_),n("change",c,b)}function m(){const c=l.value,b={};e.stages.forEach(_=>{b[_.id]=!c}),n("update:selected",b),n("change","all",!c)}return He(()=>{document.addEventListener("click",u)}),Xe(()=>{document.removeEventListener("click",u)}),(c,b)=>(w(),E("div",{class:"stage-select",ref_key:"selectContainer",ref:a},[r("div",{class:oe(["stage-select-field",{"stage-select-field--open":s.value,"stage-select-field--disabled":!1}]),onClick:i},[r("span",al,L(o.value),1),r("span",{class:oe(["stage-select-field-icon",{open:s.value}])},"▼",2)],2),ie(je,{name:"dropdown-fade"},{default:Te(()=>[s.value?(w(),E("div",sl,[r("div",nl,[r("label",{class:oe(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:b[0]||(b[0]=pe(()=>{},["stop"]))},[r("input",{type:"checkbox",checked:l.value,onChange:m},null,40,ll),b[2]||(b[2]=r("div",{class:"stage-select-item-content"},[r("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(w(!0),E(ge,null,fe(d.stages,_=>(w(),E("label",{key:_.id,class:oe(["stage-select-item",{"stage-select-item--selected":d.selected[_.id]}]),onClick:b[1]||(b[1]=pe(()=>{},["stop"]))},[r("input",{type:"checkbox",checked:d.selected[_.id],onChange:y=>p(_.id,y.target.checked)},null,40,ol),r("div",rl,[r("span",{class:"stage-select-item-color",style:Se({backgroundColor:_.color})},null,4),r("span",il,L(_.name),1)])],2))),128))])])):Q("",!0)]),_:1})],512))}},dl=Ie(cl,[["__scopeId","data-v-ce2229b2"]]),ul={class:"filters-panel"},pl={class:"filters-header"},ml=["disabled"],gl={class:"filters-content"},fl={class:"filter-section"},hl={class:"section-content"},vl={class:"filter-section"},yl={class:"section-content"},kl={class:"filter-section"},wl={class:"section-content"},Sl=["value"],bl={key:0,class:"custom-date-range"},Dl={class:"date-range-inputs"},El={class:"date-input-group"},_l=["value","max"],Cl={class:"date-input-group"},Tl=["value","min","max"],Al={key:0,class:"filter-error"},Il={key:1,class:"filter-hint"},$l={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(d,{emit:t}){const e=d,n=t,a=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],s=F(null),l=te(()=>{const _=new Date;return _.setFullYear(_.getFullYear()-1),_.toISOString().split("T")[0]}),o=te(()=>new Date().toISOString().split("T")[0]);function i(_){n("update:stages",_),n("apply")}function u(_,y){n("apply")}function p(_){n("update:employees",_),n("apply")}function m(_){n("update:dateRange",_),s.value=null,n("apply")}function c(_,y){const v={...e.customDateRange};if(v[_]=y,v.startDate&&v.endDate){const D=new Date(v.startDate),M=new Date(v.endDate);if(D>M){s.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((M-D)/(1e3*60*60*24))>365){s.value="Период не может превышать 365 дней";return}}s.value=null,n("update:customDateRange",v),n("apply")}function b(){s.value=null,n("reset")}return(_,y)=>(w(),E("div",ul,[r("div",pl,[y[3]||(y[3]=r("h2",null,"Фильтры",-1)),r("button",{onClick:b,class:"btn-reset-filters",disabled:!d.hasActiveFilters}," Сбросить фильтры ",8,ml)]),r("div",gl,[r("div",fl,[y[4]||(y[4]=r("h3",{class:"section-title"},[r("span",{class:"section-icon"},"📊"),Ge(" Этапы ")],-1)),r("div",hl,[ie(dl,{selected:d.stages,stages:a,placeholder:"Выберите этапы","onUpdate:selected":i,onChange:u},null,8,["selected"])])]),r("div",vl,[y[5]||(y[5]=r("h3",{class:"section-title"},[r("span",{class:"section-icon"},"👥"),Ge(" Сотрудники сектора 1С ")],-1)),r("div",yl,[ie(tl,{selected:d.employees,"onUpdate:selected":p},null,8,["selected"])])]),r("div",kl,[y[9]||(y[9]=r("h3",{class:"section-title"},[r("span",{class:"section-icon"},"📅"),Ge(" Период ")],-1)),r("div",wl,[r("select",{value:d.dateRange,onChange:y[0]||(y[0]=v=>m(v.target.value)),class:"date-range-select"},[...y[6]||(y[6]=[r("option",{value:"last-week"},"Последняя неделя",-1),r("option",{value:"last-2-weeks"},"Последние 2 недели",-1),r("option",{value:"last-month"},"Последний месяц",-1),r("option",{value:"custom"},"Произвольный период",-1)])],40,Sl),d.dateRange==="custom"?(w(),E("div",bl,[r("div",Dl,[r("div",El,[y[7]||(y[7]=r("label",null,"С:",-1)),r("input",{type:"date",value:d.customDateRange.startDate,onChange:y[1]||(y[1]=v=>c("startDate",v.target.value)),max:d.customDateRange.endDate||o.value,class:"date-input"},null,40,_l)]),r("div",Cl,[y[8]||(y[8]=r("label",null,"По:",-1)),r("input",{type:"date",value:d.customDateRange.endDate,onChange:y[2]||(y[2]=v=>c("endDate",v.target.value)),min:d.customDateRange.startDate||l.value,max:o.value,class:"date-input"},null,40,Tl)])]),s.value?(w(),E("small",Al,L(s.value),1)):(w(),E("small",Il," Выберите начальную и конечную дату для отображения данных "))])):Q("",!0)])])])]))}},Ml=Ie($l,[["__scopeId","data-v-4b7456a2"]]);function Nl(){const d=F(!1),t=F(null),e=F(null),n=F(0),a=Ve(),s=async(v=!0,D=null)=>{d.value=!0,t.value=null,n.value=0;try{const M=await rt.getSectorDataForSnapshot({useCache:v,onProgress:J=>{J&&typeof J.progress=="number"&&(n.value=J.progress),D&&D(J)},normalize:!0});return e.value=M,M}catch(M){throw t.value=M.message||"Ошибка загрузки данных сектора",a.error("Ошибка загрузки данных сектора: "+t.value),M}finally{d.value=!1,n.value=100}},l=async(v,D={})=>{if(!e.value){const M="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=M,a.error(M),new Error(M)}d.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(v))throw new Error(`Неверный тип слепка: ${v}. Допустимые значения: week_start, week_end, manual, current`);const M=await Ce.createSnapshot(e.value,v,D);return a.success("Слепок успешно создан"),M}catch(M){throw t.value=M.message||"Ошибка создания слепка",a.error("Ошибка создания слепка: "+t.value),M}finally{d.value=!1}},o=()=>{d.value=!1,t.value=null,e.value=null,n.value=0},i=te(()=>e.value!==null&&e.value!==void 0),u=F({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),p=te(()=>{const v=new Date;let D,M;switch(u.value.dateRange){case"last-week":D=new Date(v),D.setDate(v.getDate()-7),M=v;break;case"last-2-weeks":D=new Date(v),D.setDate(v.getDate()-14),M=v;break;case"last-month":D=new Date(v),D.setMonth(v.getMonth()-1),M=v;break;case"custom":D=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,M=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:D=new Date(v),D.setDate(v.getDate()-7),M=v}return{startDate:D?D.toISOString().split("T")[0]:null,endDate:M?M.toISOString().split("T")[0]:null}}),m=()=>{b()},c=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},b()},b=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(v){console.error("Ошибка сохранения фильтров в localStorage:",v)}},_=()=>{try{const v=localStorage.getItem("graphStateFilters");if(v){const D=JSON.parse(v);D&&typeof D=="object"&&(u.value={stages:D.stages||{formed:!0,review:!0,execution:!0},employees:D.employees||["all"],dateRange:D.dateRange||"last-week",customDateRange:D.customDateRange||{startDate:null,endDate:null}})}}catch(v){console.error("Ошибка загрузки фильтров из localStorage:",v)}},y=te(()=>{const v=Object.values(u.value.stages).some(J=>!J),D=!u.value.employees.includes("all"),M=u.value.dateRange!=="last-week";return v||D||M});return{isLoading:d,error:t,currentSectorData:e,loadingProgress:n,hasSectorData:i,filters:u,selectedPeriod:p,hasActiveFilters:y,loadSectorDataForSnapshot:s,createSnapshot:l,resetState:o,applyFilters:m,resetFilters:c,saveFiltersToLocalStorage:b,loadFiltersFromLocalStorage:_}}const Fl={class:"graph-state-dashboard"},Rl={key:1,class:"error-message-container"},Hl={class:"error-message"},Ol={class:"error-text"},Ll={key:0,class:"error-details"},xl={class:"dashboard-header"},Pl={class:"header-content"},Bl={class:"breadcrumbs-row"},Wl=["aria-disabled","data-fallback","disabled"],Ul={class:"breadcrumbs","aria-label":"Навигация"},jl={class:"header-actions"},Vl=["disabled"],zl={key:0},Kl={key:1},Gl={key:3,class:"dashboard-content"},Yl={class:"chart-container"},ql="Назад",Jl={__name:"GraphStateDashboard",setup(d){const t=(H,z)=>typeof window>"u"?z:getComputedStyle(document.documentElement).getPropertyValue(H).trim()||z,e=Ve(),n=Vt(),a={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:l,hasActiveFilters:o,applyFilters:i,resetFilters:u,loadFiltersFromLocalStorage:p}=Nl(),m=F(null),c=F(!0),b=F(!1),_=F("Загрузка данных..."),y=F(null),v=F(!1),D=F(!1),M=F(typeof window<"u"?window.innerWidth:1024),J=F(null),le=F(!1),se=te(()=>M.value<768);te(()=>M.value>=768&&M.value<1024),te(()=>M.value>=1024);const V=te(()=>typeof window>"u"?!1:window.history.length>1);te(()=>{const H=new Date;return H.setFullYear(H.getFullYear()-1),H.toISOString().split("T")[0]}),te(()=>new Date().toISOString().split("T")[0]);function P(H){s.value.stages=H}function K(H){s.value.employees=H}function ce(H){s.value.dateRange=H}function he(H){s.value.customDateRange=H}function de(){i()}function ye(){u(),J.value=null,de(),e.info("Фильтры сброшены")}function f(H){e.success("Слепок успешно создан")}function k(H){b.value=!1,_.value="",console.log("Данные графика загружены:",H)}function h(H){b.value=!1,N({message:H||"Ошибка загрузки графика",details:null,type:"error"})}function N(H){y.value={message:H.message||"Произошла ошибка",details:H.details||null,type:H.type||"error",timestamp:new Date},console.error("Dashboard error:",y.value),e.error(y.value.message)}function Y(){y.value=null}function W(){y.value=null,b.value=!0,_.value="Повторная загрузка данных..."}async function ee(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}v.value=!0;try{const H=document.querySelector(".chart-container");if(!H)throw new Error("График не найден");const z=window.html2canvas,ue=await z(H,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),be=window.jsPDF,A=new be("landscape","mm","a4"),$=297,re=ue.height*$/ue.width;A.setFontSize(18),A.text("График состояния сектора 1С",148.5,15,{align:"center"});const ke=new Date().toLocaleDateString("ru-RU");A.setFontSize(10);const Ze=l.value.startDate&&l.value.endDate?`Период: ${l.value.startDate} - ${l.value.endDate}`:"Период: не указан";A.text(Ze,148.5,25,{align:"center"}),A.text(`Экспорт от ${ke}`,148.5,30,{align:"center"}),A.addImage(ue.toDataURL("image/png"),"PNG",10,35,$-20,re-20),A.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${ke}`,author:"Bitrix24 Dashboard"});const Qe=`graph-state-${ke.replace(/\//g,"-")}.pdf`;A.save(Qe),e.success("График успешно экспортирован в PDF")}catch(H){console.error("Ошибка экспорта в PDF:",H),N({message:"Ошибка экспорта в PDF: "+(H.message||"Неизвестная ошибка"),details:H.stack,type:"error"})}finally{v.value=!1}}function ve(H){var z;if((z=H==null?void 0:H.preventDefault)==null||z.call(H),!le.value){le.value=!0;try{if(V.value){n.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),n.push(a)}finally{le.value=!1}}}function R(){typeof window<"u"&&(M.value=window.innerWidth)}async function q(){try{const H=await Nt.checkAccess();H.allowed&&(m.value=H.user)}catch(H){console.error("Error loading user:",H)}}return He(()=>{p(),q(),typeof window<"u"&&(M.value=window.innerWidth,window.addEventListener("resize",R))}),Xe(()=>{typeof window<"u"&&window.removeEventListener("resize",R)}),(H,z)=>{const ue=zt("router-link");return w(),E("div",Fl,[b.value?(w(),Ae(Mt,{key:0,message:_.value},null,8,["message"])):Q("",!0),y.value?(w(),E("div",Rl,[r("div",Hl,[r("div",{class:"error-header"},[z[1]||(z[1]=r("span",{class:"error-icon"},"❌",-1)),z[2]||(z[2]=r("h3",null,"Ошибка",-1)),r("button",{onClick:Y,class:"error-close","aria-label":"Закрыть"},"✕")]),r("p",Ol,L(y.value.message),1),y.value.details?(w(),E("div",Ll,[r("details",null,[z[3]||(z[3]=r("summary",null,"Детали ошибки",-1)),r("pre",null,L(y.value.details),1)])])):Q("",!0),r("div",{class:"error-actions"},[r("button",{onClick:W,class:"btn-retry"},"Повторить попытку")])])])):Q("",!0),r("div",xl,[r("div",Pl,[r("div",Bl,[r("button",{class:"btn-back-link",type:"button",onClick:ve,"aria-label":ql,"aria-disabled":!V.value,"data-fallback":!V.value,disabled:le.value,title:"Назад"}," ← ",8,Wl),r("nav",Ul,[ie(ue,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Te(()=>[...z[4]||(z[4]=[Ge(" Дашборд сектора 1С ",-1)])]),_:1}),z[5]||(z[5]=r("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),z[6]||(z[6]=r("span",{class:"breadcrumb-current"},"График состояния",-1))])]),z[7]||(z[7]=r("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),z[8]||(z[8]=r("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),r("div",jl,[r("button",{onClick:ee,class:"btn-export-pdf",disabled:v.value||b.value,title:"Экспортировать график в PDF"},[v.value?(w(),E("span",Kl,"⏳ Экспорт...")):(w(),E("span",zl,"📄 Экспорт в PDF"))],8,Vl),ie(xn,{user:m.value,onSnapshotCreated:f},null,8,["user"])])]),se.value?(w(),E("button",{key:2,class:"mobile-filters-toggle",onClick:z[0]||(z[0]=be=>D.value=!D.value)},[z[9]||(z[9]=r("span",null,"Фильтры",-1)),r("span",{class:oe(["toggle-icon",{open:D.value}])},"▼",2)])):Q("",!0),r("div",{class:oe({"mobile-open":D.value&&se.value,"mobile-closed":!D.value&&se.value})},[ie(Ml,{stages:Le(s).stages,employees:Le(s).employees,dateRange:Le(s).dateRange,customDateRange:Le(s).customDateRange,hasActiveFilters:Le(o),"onUpdate:stages":P,"onUpdate:employees":K,"onUpdate:dateRange":ce,"onUpdate:customDateRange":he,onReset:ye,onApply:de},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!b.value&&!y.value?(w(),E("div",Gl,[r("div",Yl,[ie(hn,{period:Le(l),"show-current-state":c.value,onDataLoaded:k,onError:h},null,8,["period","show-current-state"])])])):Q("",!0)])}}},Xl=Ie(Jl,[["__scopeId","data-v-e995acfd"]]),to=Object.freeze(Object.defineProperty({__proto__:null,default:Xl},Symbol.toStringTag,{value:"Module"}));export{to as G,Ft as T,ca as g};
