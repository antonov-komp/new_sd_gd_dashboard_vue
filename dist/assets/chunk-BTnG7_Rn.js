const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./chunk-UTsEWqhV.js","./chunk-B5yqeUNo.js","./ticketListUtils-CpKfsjsI.js","./chunk-rKmNpCr3.js","./chunk-IDUYkvJI.js","./chunk-DLgBCjTL.js","./dashboard-components-cU3ZvHcC.css","./chunk-DVSMqPZp.js","./chunk-Bwkg0lDb.js","./graph-state-components-q2unGHzB.css"])))=>i.map(i=>d[i]);
var ee=Object.defineProperty;var te=(e,t,n)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var U=(e,t,n)=>te(e,typeof t!="symbol"?t+"":t,n);import{r as p,l as $,M as q,z as B,y as V,c as C,N as ne,_ as se,$ as x}from"./chunk-IDUYkvJI.js";import{L as W,P as b,n as ae}from"./chunk-rKmNpCr3.js";import{D as I,S as oe,a as re}from"./chunk-Bwkg0lDb.js";import{_ as N}from"./chunk-B5yqeUNo.js";const E=p(new Map),A=p({hits:0,misses:0,sets:0,invalidations:0}),M={defaultTTL:5*60*1e3,maxSize:100,enableStats:!0};function Ee(e={}){const{ttl:t=M.defaultTTL,maxSize:n=M.maxSize,enableStats:s=M.enableStats}=e,f=a=>{const i=new WeakSet;return JSON.stringify(a,(h,v)=>{if(typeof v=="object"&&v!==null){if(i.has(v))return"[Circular]";i.add(v)}return typeof v=="function"||v===void 0?null:v})},w=(a,i={})=>{const h=Object.keys(i).sort().reduce((v,R)=>{const L=i[R];if(L==null)v[R]=null;else if(typeof L=="object")try{v[R]=f(L)}catch{v[R]=String(L)}else v[R]=L;return v},{});try{return`${a}_${f(h)}`}catch{const R=Object.keys(h).sort().map(L=>`${L}=${h[L]}`).join("&");return`${a}_${R}`}},r=a=>{const i=E.value.get(a);return i?Date.now()-i.timestamp>i.ttl?(E.value.delete(a),s&&A.value.misses++,null):(i.lastAccessed=Date.now(),s&&A.value.hits++,i.data):(s&&A.value.misses++,null)},d=(a,i,h=null)=>{E.value.size>=n&&l(),E.value.set(a,{data:i,timestamp:Date.now(),lastAccessed:Date.now(),ttl:h||t}),s&&A.value.sets++},l=()=>{let a=null,i=1/0;for(const[h,v]of E.value.entries())v.lastAccessed<i&&(i=v.lastAccessed,a=h);a&&E.value.delete(a)},o=()=>{E.value.clear(),s&&(A.value={hits:0,misses:0,sets:0,invalidations:0})},c=a=>{const i=typeof a=="string"?new RegExp(a):a;let h=0;for(const v of E.value.keys())i.test(v)&&(E.value.delete(v),h++);return s&&(A.value.invalidations+=h),h},y=()=>{const a=Date.now();let i=0;for(const[h,v]of E.value.entries())a-v.timestamp>v.ttl&&(E.value.delete(h),i++);return i},S=()=>{const a=A.value.hits+A.value.misses,i=a>0?(A.value.hits/a*100).toFixed(2):0;return{...A.value,size:E.value.size,hitRate:`${i}%`}};let u=null;const m=(a=5*60*1e3)=>{u&&clearInterval(u),u=setInterval(()=>{y()},a)},g=()=>{u&&(clearInterval(u),u=null)};return m(),{get:r,set:d,clear:o,invalidate:c,cleanup:y,getCacheKey:w,getStats:S,startAutoCleanup:m,stopAutoCleanup:g}}function H(e){if(!e||typeof e!="object"||!e.timestamp||typeof e.timestamp!="string"||!e.event||typeof e.event!="string"||!e.category||typeof e.category!="string"||!["tasks","smart-processes","errors"].includes(e.category))return!1;try{new Date(e.timestamp)}catch{return!1}return!0}function ie(e){if(!e||typeof e!="object")return!1;for(const[t,n]of Object.entries(e))if(typeof n=="function")return!1;return!0}function ce(e){if(!H(e))return null;const t={timestamp:e.timestamp,event:e.event,category:e.category};return e.ip&&typeof e.ip=="string"&&(t.ip=e.ip),e.payload&&typeof e.payload=="object"&&(t.payload=e.payload),e.details&&ie(e.details)&&(t.details=e.details),t}function le(e){return Array.isArray(e)?e.map(t=>ce(t)).filter(t=>t!==null):[]}function Re(){const e=B(),t=V(),n=new Date().toISOString().split("T")[0],s=p({category:null,event:null,dateFrom:n,dateTo:null,hour:null,ip:null,search:null,status:null}),f=()=>{const o=e.query;s.value={category:o.category||null,event:o.event||null,dateFrom:o.dateFrom||o.date||n,dateTo:o.dateTo||null,hour:o.hour?parseInt(o.hour):null,ip:o.ip||null,search:o.search||null,status:o.status||null}},w=o=>{if(l)return;const c={...e.query};Object.keys(o).forEach(S=>{const u=o[S];u!==null&&u!==""&&u!==void 0?c[S]=u.toString():delete c[S]}),JSON.stringify(c)!==JSON.stringify(e.query)&&(l=!0,t.replace({path:e.path,query:c}).finally(()=>{setTimeout(()=>{l=!1},100)}))},r=o=>{const c={...s.value,...o};JSON.stringify(s.value)!==JSON.stringify(c)&&(s.value=c,w(s.value))},d=()=>{s.value={category:null,event:null,dateFrom:n,dateTo:null,hour:null,ip:null,search:null,status:null},w(s.value)};$(()=>{f()});let l=!1;return q(()=>e.query,(o,c)=>{if(l)return;JSON.stringify(o)!==JSON.stringify(c)&&f()},{deep:!0}),{filters:s,updateFilters:r,clearFilters:d,loadFiltersFromUrl:f}}function Ae(e,t=null){const n=()=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.error(`Error loading ${e} from localStorage:`,r),t}},s=r=>{try{localStorage.setItem(e,JSON.stringify(r))}catch(d){console.error(`Error saving ${e} to localStorage:`,d)}},f=()=>{try{localStorage.removeItem(e)}catch(r){console.error(`Error clearing ${e} from localStorage:`,r)}},w=p(n());return q(w,r=>{s(r)},{deep:!0}),{value:w,save:s,load:n,clear:f}}const O=p([]);let ue=0;function P(){const e=(d,l="info",o=3e3)=>{const c=++ue,y={id:c,message:d,type:l,duration:o,timestamp:Date.now()};return O.value.push(y),o>0&&setTimeout(()=>{t(c)},o),c},t=d=>{const l=O.value.findIndex(o=>o.id===d);l>-1&&O.value.splice(l,1)};return{notifications:O,showNotification:e,removeNotification:t,clearNotifications:()=>{O.value=[]},success:(d,l=3e3)=>e(d,"success",l),error:(d,l=5e3)=>e(d,"error",l),warning:(d,l=4e3)=>e(d,"warning",l),info:(d,l=3e3)=>e(d,"info",l)}}class fe{constructor(t,n={}){this.url=t,this.options={reconnectInterval:3e3,maxReconnectAttempts:10,reconnectDelay:1e3,lastTimestamp:null,...n},this.eventSource=null,this.listeners=new Map,this.reconnectAttempts=0,this.reconnectTimer=null,this.isManualDisconnect=!1,this.connectionState="disconnected"}updateOptions(t){this.options={...this.options,...t}}connect(){if(this.connectionState==="connected"||this.connectionState==="connecting"){console.warn("[RealtimeService] Already connected or connecting");return}this.isManualDisconnect=!1,this.connectionState="connecting",this.notifyListeners("state-change",{state:this.connectionState});try{let t=this.url;if(!t.startsWith("http://")&&!t.startsWith("https://")){const n=new URL(t,window.location.origin);this.options.lastTimestamp&&n.searchParams.set("last_timestamp",this.options.lastTimestamp),t=n.toString()}else{const n=new URL(t);this.options.lastTimestamp&&n.searchParams.set("last_timestamp",this.options.lastTimestamp),t=n.toString()}console.log("[RealtimeService] Connecting to:",t),this.eventSource=new EventSource(t),this.eventSource.onopen=()=>{console.log("[RealtimeService] EventSource opened"),this.notifyListeners("open",{timestamp:new Date().toISOString()})},this.eventSource.onmessage=n=>{try{const s=JSON.parse(n.data);this.notifyListeners("message",s)}catch(s){console.error("[RealtimeService] Error parsing message:",s)}},this.eventSource.addEventListener("connected",n=>{try{const s=JSON.parse(n.data);console.log("[RealtimeService] Connected event received:",s),this.connectionState="connected",this.reconnectAttempts=0,this.notifyListeners("connected",s),this.notifyListeners("state-change",{state:this.connectionState})}catch(s){console.error("[RealtimeService] Error parsing connected event:",s)}}),this.eventSource.addEventListener("new_logs",n=>{const s=JSON.parse(n.data);if(s.logs&&s.logs.length>0){const f=s.logs[s.logs.length-1];f.timestamp&&(this.options.lastTimestamp=f.timestamp)}this.notifyListeners("new_logs",s)}),this.eventSource.addEventListener("error",n=>{try{const s=JSON.parse(n.data);this.notifyListeners("error",s)}catch{this.notifyListeners("error",{message:"Server error"})}}),this.eventSource.addEventListener("timeout",n=>{try{const s=JSON.parse(n.data);this.notifyListeners("timeout",s)}catch{this.notifyListeners("timeout",{message:"Connection timeout"})}this.reconnect()}),this.eventSource.addEventListener("closed",n=>{try{const s=JSON.parse(n.data);this.notifyListeners("closed",s)}catch{this.notifyListeners("closed",{message:"Connection closed"})}this.isManualDisconnect||this.reconnect()}),this.eventSource.onerror=n=>{console.error("[RealtimeService] Connection error:",n),console.error("[RealtimeService] EventSource readyState:",this.eventSource?.readyState),this.eventSource?.readyState===EventSource.CLOSED?(console.log("[RealtimeService] EventSource closed by server"),this.connectionState="disconnected",this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()):this.eventSource?.readyState===EventSource.CONNECTING?console.log("[RealtimeService] Still connecting..."):(this.connectionState="error",this.notifyListeners("error",{error:n,type:"connection",message:"Failed to connect to realtime stream",readyState:this.eventSource?.readyState}),this.notifyListeners("state-change",{state:this.connectionState}),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.isManualDisconnect||this.reconnect())}}catch(t){console.error("[RealtimeService] Error creating EventSource:",t),this.connectionState="error",this.notifyListeners("error",{error:t,type:"initialization"}),this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()}}reconnect(){if(this.isManualDisconnect)return;if(this.reconnectAttempts>=this.options.maxReconnectAttempts){console.error("[RealtimeService] Max reconnect attempts reached"),this.notifyListeners("max-reconnect-attempts",{attempts:this.reconnectAttempts});return}this.reconnectAttempts++;const t=Math.min(this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),this.options.reconnectInterval);console.log(`[RealtimeService] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.connect()},t)}disconnect(){this.isManualDisconnect=!0,this.connectionState="disconnected",this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.notifyListeners("disconnected",{timestamp:new Date().toISOString()}),this.notifyListeners("state-change",{state:this.connectionState})}on(t,n){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(n)}off(t,n){if(this.listeners.has(t)){const s=this.listeners.get(t),f=s.indexOf(n);f>-1&&s.splice(f,1)}}notifyListeners(t,n){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>{try{s(n)}catch(f){console.error(`[RealtimeService] Error in listener for ${t}:`,f)}})}getState(){return this.connectionState}isConnected(){return this.connectionState==="connected"}}function Ce(e,t={}){const{autoConnect:n=!1,enableSound:s=!1,onNewLogs:f=null,validateLogs:w=!0}=t,r=new fe(e,t),d=p("disconnected"),l=p([]),o=p(0),c=p(null),y=p(null),S=p(0),u=C(()=>d.value==="connected"),m=C(()=>d.value==="connecting"),g=C(()=>d.value==="error"),a=C(()=>o.value>0),i=D=>{d.value=D.state,D.state==="connected"&&(S.value=0,y.value=null)},h=D=>{let T=D.logs||[];if(w){T=le(T);const k=T.filter(Q=>H(Q));k.length!==T.length&&console.warn("[useRealtime] Filtered out invalid logs:",T.length-k.length),T=k}T.length!==0&&(l.value.push(...T),o.value+=T.length,c.value=new Date().toISOString(),s&&T.length>0&&Z(),f&&f(T))},v=D=>{const T=D.message||D.error?.message||"Connection error";y.value=T,d.value="error",console.error("[useRealtime] Error:",D)},R=D=>{console.warn("[useRealtime] Connection timeout:",D)},L=D=>{y.value=`Max reconnect attempts reached (${D.attempts})`,console.error("[useRealtime] Max reconnect attempts:",D)},_=(D={})=>{y.value=null,D.lastTimestamp!==void 0&&r.updateOptions({lastTimestamp:D.lastTimestamp}),r.on("state-change",i),r.on("new_logs",h),r.on("error",v),r.on("timeout",R),r.on("max-reconnect-attempts",L),r.connect()},z=()=>{r.off("state-change",i),r.off("new_logs",h),r.off("error",v),r.off("timeout",R),r.off("max-reconnect-attempts",L),r.disconnect()},J=()=>{l.value=[],o.value=0},Y=D=>{D&&Array.isArray(D)&&(D.unshift(...l.value),J())},Z=()=>{try{const D=new Audio("/sounds/notification.mp3");D.volume=.3,D.play().catch(T=>{console.warn("[useRealtime] Failed to play sound:",T)})}catch(D){console.warn("[useRealtime] Sound not available:",D)}};return n&&$(()=>{_()}),ne(()=>{z()}),{connectionState:d,isConnected:u,isConnecting:m,hasError:g,newLogs:l,newLogsCount:o,hasNewLogs:a,lastUpdateTime:c,error:y,reconnectAttempts:S,connect:_,disconnect:z,clearNewLogs:J,applyNewLogs:Y}}class j{static async loadAdmissionClosureService(){if(!this.cache.has("admissionClosure")){const t=await N(()=>import("./chunk-B5yqeUNo.js").then(n=>n.c),[],import.meta.url);this.cache.set("admissionClosure",t)}return this.cache.get("admissionClosure")}static async loadBitrix24Api(){if(!this.cache.has("bitrix24Api")){const t=await N(()=>import("./chunk-UTsEWqhV.js").then(n=>n.b),__vite__mapDeps([0,1]),import.meta.url);this.cache.set("bitrix24Api",t)}return this.cache.get("bitrix24Api")}static async loadAccessConfigAsync(){if(!this.cache.has("accessConfigAsync")){const t=await N(()=>import("./chunk-DLgBCjTL.js").then(n=>n.c),[],import.meta.url);this.cache.set("accessConfigAsync",t)}return this.cache.get("accessConfigAsync")}static async loadTicketListUtils(){if(!this.cache.has("ticketListUtils")){const t=await N(()=>import("./ticketListUtils-CpKfsjsI.js"),__vite__mapDeps([2,3,4,5,0,1,6,7,8,9]),import.meta.url);this.cache.set("ticketListUtils",t)}return this.cache.get("ticketListUtils")}static clearCache(t=null){t?this.cache.delete(t):this.cache.clear()}static getCacheStats(){return{size:this.cache.size,services:Array.from(this.cache.keys()),memoryUsage:JSON.stringify(this.cache).length}}}U(j,"cache",new Map);const Oe=Object.freeze(Object.defineProperty({__proto__:null,LazyServiceLoader:j},Symbol.toStringTag,{value:"Module"}));function de(e){return typeof e=="number"&&e>0&&!isNaN(e)}function X(e){return typeof e=="number"&&e>0&&!isNaN(e)}function G(e){return typeof e=="string"&&["formed","review","execution"].includes(e)}function he(e){return!e||typeof e!="object"?!1:de(e.id)&&typeof e.title=="string"&&e.title.trim().length>0}function K(e,t,n){return!(!he(e)||!X(t)||!G(n)||e.assigneeId===t&&e.stageId===n)}function ge(e){const t=[];return!e||typeof e!="object"?(t.push("Данные тикета должны быть объектом"),{valid:!1,errors:t}):((!e.title||typeof e.title!="string"||e.title.trim().length===0)&&t.push("Название тикета обязательно"),e.stageId&&!G(e.stageId)&&t.push("Некорректный ID стадии"),e.employeeId&&!X(e.employeeId)&&t.push("Некорректный ID сотрудника"),{valid:t.length===0,errors:t})}function Ne(e){const t=P(),n=p(!1);return{isDropZoneActive:n,handleDragStart:(l,o)=>{l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("application/json",JSON.stringify(o)),l.dataTransfer.setDragImage(l.target,0,0)},handleDragOver:l=>{l.preventDefault(),l.dataTransfer.dropEffect="move",n.value=!0},handleDragLeave:l=>{const o=l.currentTarget.getBoundingClientRect(),c=l.clientX,y=l.clientY;(c<o.left||c>o.right||y<o.top||y>o.bottom)&&(n.value=!1)},handleDrop:async(l,o,c)=>{l.preventDefault(),n.value=!1;const y=l.dataTransfer.getData("application/json");if(y)try{const S=JSON.parse(y);if(!K(S,o,c)){t.warning("Нельзя переместить тикет сюда");return}e&&typeof e=="function"&&await e(S,o,c)}catch(S){W.error("Error parsing ticket data","useDragAndDrop",S),t.error("Ошибка обработки данных тикета")}},handleDragEnd:l=>{n.value=!1}}}function be(e=null){const t=se(),n=t?.type?.name||t?.type?.__name||null,s=e||n||"Unknown",f=(o,c,y=null)=>{W.log(o,c,s,y)};return{error:(o,c=null)=>{f("ERROR",o,c)},warn:(o,c=null)=>{f("WARN",o,c)},info:(o,c=null)=>{f("INFO",o,c)},debug:(o,c=null)=>{f("DEBUG",o,c)},log:f,context:s}}function _e(){const e=V(),t=B();return{goBack:(r="/")=>{window.history.length>1?e.back():e.push(r)},goTo:(r,d={})=>{e.push({path:r,...d})},goHome:(r={})=>{e.push({path:"/",...r})},isCurrentRoute:r=>t.path===r,router:e,route:t}}function ke(){const e=p(!1),t=p(null),n=p([{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}]),s=p({formed:[],review:[],execution:[]}),f=p([]),w=p(null);return{isLoading:e,error:t,stages:n,zeroPointTickets:s,employees:f,draggedTicket:w,updateState:c=>{c.stages&&(n.value=c.stages),c.employees&&(f.value=c.employees),c.zeroPointTickets&&(s.value=c.zeroPointTickets)},resetState:()=>{e.value=!1,t.value=null,n.value=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}],s.value={formed:[],review:[],execution:[]},f.value=[],w.value=null},updateLocalStateAfterMove:(c,y,S)=>{const u=n.value.find(g=>g.employees.some(a=>a.tickets.some(i=>i.id===c.id)));if(u){const g=u.employees.find(a=>a.tickets.some(i=>i.id===c.id));g&&(g.tickets=g.tickets.filter(a=>a.id!==c.id))}const m=n.value.find(g=>g.id===S);if(m){const g=m.employees.find(a=>a.id===y);if(g){const a={...c,assigneeId:y,stageId:S};g.tickets.push(a)}}Object.keys(s.value).forEach(g=>{s.value[g]=s.value[g].filter(a=>a.id!==c.id)})},getEmployeeTickets:(c,y)=>{const S=n.value.find(m=>m.id===y);if(!S)return[];const u=S.employees.find(m=>m.id===c);return u?u.tickets||[]:[]}}}function me(){const e=p(null),t=p(0),n=p(null),s=p(null),f=p({}),w=(S,u={})=>{e.value=S,f.value=u},r=S=>{const u=typeof S=="number"&&!isNaN(S)?S:0;t.value=Math.min(100,Math.max(0,u))},d=S=>{n.value=S,s.value=null},l=S=>{s.value=S},o=()=>{s.value=null},c=()=>{e.value=null,t.value=0,n.value=null,s.value=null,f.value={}},y=C(()=>n.value||s.value);return{currentStep:e,progress:t,error:n,temporaryError:s,displayError:y,stepDetails:f,updateStep:w,updateProgress:r,setError:d,setTemporaryError:l,clearTemporaryError:o,reset:c}}function ve(){const e=p(!1),t=p(null),n=r=>{e.value=!0,t.value=Date.now(),r&&r()},s=r=>{e.value=!1,t.value=null,r&&r()},f=(r,d,l=b)=>{n(()=>{r&&r(),setTimeout(()=>{d&&d()},l.delayBetween),setTimeout(()=>{s()},l.fadeOutDuration)})},w=C(()=>t.value?Date.now()-t.value:0);return{isTransitioning:C(()=>e.value),startTransition:n,endTransition:s,executeTransition:f,transitionDuration:w}}function pe(e,t=""){if(Logger.error(`API Error ${t?`(${t})`:""}`,"ErrorHandler",e),e.message){if(e.message.includes("HTTP error"))return"Ошибка соединения с сервером. Проверьте подключение к интернету.";if(e.message.includes("timeout"))return"Превышено время ожидания ответа. Попробуйте позже.";if(e.message.includes("403")||e.message.includes("401"))return"Ошибка доступа. Проверьте права доступа.";if(e.message.includes("500"))return"Ошибка на сервере. Обратитесь к администратору."}return e.message||"Произошла неизвестная ошибка"}function Se(e,t="",n={}){const s={message:e.message,stack:e.stack,context:t,...n,timestamp:new Date().toISOString()};Logger.error("Error logged","ErrorHandler",s)}function F(e,t="",n=null){const s=pe(e,t);Se(e,t),n&&typeof n=="function"?n(s,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:s,autoHideDelay:5e3})}function xe(e){const t=P(),n=me(),{isTransitioning:s,executeTransition:f}=ve();function w(u,m){const g=ae(u);g.step&&m.updateStep(g.step,g.details||{}),g.progress!==void 0&&g.progress!==null&&(m.updateProgress(g.progress),m.clearTemporaryError())}const r=async(u=!0)=>{e.isLoading.value=!0,e.error.value=null,n.reset(),n.updateStep("cache_check",{description:"Инициализация загрузки данных..."}),n.updateProgress(0);try{const m=await I.getSectorData(u,g=>{w(g,n)});e.updateState(m)}catch(m){e.error.value=m.message,n.setError(m.message),F(m,"loading sector data",t.error)}finally{if(e.error.value)e.isLoading.value=!1;else{n.updateStep("complete",{description:"Дашборд загружен"}),n.updateProgress(100);const m=b.readyDisplayTime||800;setTimeout(()=>{f(()=>{},()=>{e.isLoading.value=!1},b),setTimeout(()=>{n.reset()},b.fadeOutDuration)},m)}}},d=async(u,m,g)=>{if(!K(u,m,g))return t.warning("Нельзя переместить тикет сюда"),!1;try{const a=await I.assignTicket(u.id,m,g);return a&&(e.updateLocalStateAfterMove(u,m,g),t.success("Тикет перемещён")),a}catch(a){return F(a,"assigning ticket",t.error),!1}finally{e.draggedTicket.value=null}};return{loadSectorData:r,assignTicket:d,moveTicketToStage:async(u,m)=>await d(u,u.assigneeId,m),assignTicketToEmployee:async(u,m)=>await d(u,m,u.stageId),createTicket:async u=>{const m=ge(u);if(!m.valid){const g=m.errors.join(", ");return t.error(g),0}try{const g=await I.createTicket(u);return g>0&&(await r(!1),t.success("Тикет создан")),g}catch(g){return F(g,"creating ticket",t.error),0}},handleTicketDragStart:u=>{e.draggedTicket.value=u},handleTicketDrop:async(u,m,g)=>{await d(u,m,g)},loadingProgress:n,isTransitioning:s}}function Ie(){const e=p(null),t=p(!1),n=p(null),s=async()=>{if(e.value)return e.value;try{t.value=!0,n.value=null;const{fetchAdmissionClosureStats:r,...d}=await j.loadAdmissionClosureService();e.value={fetchAdmissionClosureStats:r,...d}}catch(r){throw n.value=r,console.error("Failed to load admission service:",r),r}finally{t.value=!1}return e.value},f=async(r={})=>(await s()).fetchAdmissionClosureStats(r),w=()=>{e.value=null,n.value=null};return{service:x(e),loading:x(t),error:x(n),loadService:s,fetchStats:f,clearService:w}}function Me(){const e=p(!1),t=p(null),n=p(null),s=p(0),f=P(),w=async(a=!0,i=null)=>{e.value=!0,t.value=null,s.value=0;try{const h=await re.getSectorDataForSnapshot({useCache:a,onProgress:v=>{v&&typeof v.progress=="number"&&(s.value=v.progress),i&&i(v)},normalize:!0});return n.value=h,h}catch(h){throw t.value=h.message||"Ошибка загрузки данных сектора",f.error("Ошибка загрузки данных сектора: "+t.value),h}finally{e.value=!1,s.value=100}},r=async(a,i={})=>{if(!n.value){const h="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=h,f.error(h),new Error(h)}e.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(a))throw new Error(`Неверный тип слепка: ${a}. Допустимые значения: week_start, week_end, manual, current`);const h=await oe.createSnapshot(n.value,a,i);return f.success("Слепок успешно создан"),h}catch(h){throw t.value=h.message||"Ошибка создания слепка",f.error("Ошибка создания слепка: "+t.value),h}finally{e.value=!1}},d=()=>{e.value=!1,t.value=null,n.value=null,s.value=0},l=C(()=>n.value!==null&&n.value!==void 0),o=p({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),c=C(()=>{const a=new Date;let i,h;switch(o.value.dateRange){case"last-week":i=new Date(a),i.setDate(a.getDate()-7),h=a;break;case"last-2-weeks":i=new Date(a),i.setDate(a.getDate()-14),h=a;break;case"last-month":i=new Date(a),i.setMonth(a.getMonth()-1),h=a;break;case"custom":i=o.value.customDateRange.startDate?new Date(o.value.customDateRange.startDate):null,h=o.value.customDateRange.endDate?new Date(o.value.customDateRange.endDate):null;break;default:i=new Date(a),i.setDate(a.getDate()-7),h=a}return{startDate:i?i.toISOString().split("T")[0]:null,endDate:h?h.toISOString().split("T")[0]:null}}),y=()=>{u()},S=()=>{o.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},u()},u=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(o.value))}catch(a){console.error("Ошибка сохранения фильтров в localStorage:",a)}},m=()=>{try{const a=localStorage.getItem("graphStateFilters");if(a){const i=JSON.parse(a);i&&typeof i=="object"&&(o.value={stages:i.stages||{formed:!0,review:!0,execution:!0},employees:i.employees||["all"],dateRange:i.dateRange||"last-week",customDateRange:i.customDateRange||{startDate:null,endDate:null}})}}catch(a){console.error("Ошибка загрузки фильтров из localStorage:",a)}},g=C(()=>{const a=Object.values(o.value.stages).some(v=>!v),i=!o.value.employees.includes("all"),h=o.value.dateRange!=="last-week";return a||i||h});return{isLoading:e,error:t,currentSectorData:n,loadingProgress:s,hasSectorData:l,filters:o,selectedPeriod:c,hasActiveFilters:g,loadSectorDataForSnapshot:w,createSnapshot:r,resetState:d,applyFilters:y,resetFilters:S,saveFiltersToLocalStorage:u,loadFiltersFromLocalStorage:m}}export{j as L,be as a,_e as b,ke as c,xe as d,P as e,Me as f,Ee as g,ce as h,H as i,Ae as j,Ce as k,Re as l,Ie as m,le as n,ie as o,Oe as p,Ne as u};
