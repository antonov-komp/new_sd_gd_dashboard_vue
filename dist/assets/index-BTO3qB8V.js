var H=Object.defineProperty;var z=(e,t,i)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var w=(e,t,i)=>z(e,typeof t!="symbol"?t+"":t,i);const $="dashboard-sector-1c-logger-level",C={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class X{static getLevel(){if(typeof localStorage<"u"){const t=localStorage.getItem($);if(t&&C[t]!==void 0)return t}return"ERROR"}static setLevel(t){return C[t]!==void 0?(typeof localStorage<"u"&&localStorage.setItem($,t),!0):!1}static isEnabled(t,i=null){const r=i||this.getLevel();if(r==="NONE")return!1;const s=C[t]||0,n=C[r]||0;return s<=n}static getLevels(){return{...C}}static reset(){typeof localStorage<"u"&&localStorage.removeItem($)}}class h{static getLevelColor(t){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[t]||"#6c757d"}static formatMessage(t,i,r=""){const s=new Date().toISOString(),n=this.getLevelColor(t),o=`%c[${s}] %c[${t}] %c[${r||"Unknown"}] %c${i}`,u=["color: #6c757d; font-weight: normal",`color: ${n}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:o,styles:u}}static log(t,i,r="",s=null){if(!X.isEnabled(t))return;const n=this.formatMessage(t,i,r),o=[n.formatted,...n.styles];switch(s!=null&&o.push(s),t){case"ERROR":console.error(...o);break;case"WARN":console.warn(...o);break;case"INFO":console.info(...o);break;case"DEBUG":console.log(...o);break;default:console.log(...o)}}static error(t,i="",r=null){this.log("ERROR",t,i,r)}static warn(t,i="",r=null){this.log("WARN",t,i,r)}static info(t,i="",r=null){this.log("INFO",t,i,r)}static debug(t,i="",r=null){this.log("DEBUG",t,i,r)}}class Z{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(t,i,r,s=null){this.metrics.ticketsLoading.stages[t]||(this.metrics.ticketsLoading.stages[t]={loaded:0,batches:[],total:0});const n=this.metrics.ticketsLoading.stages[t];n.loaded=r,n.batches.push({count:i,total:r,next:s}),n.total=r,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((o,u)=>o+u.total,0)}logFiltering(t,i,r=[],s=[]){this.metrics.filtering.total=t,this.metrics.filtering.filtered=i,this.metrics.filtering.rejected=r.slice(0,50),this.metrics.filtering.tagValueExamples=s.slice(0,20)}logEmployees(t,i=[],r=[]){this.metrics.employees.uniqueIds=t,this.metrics.employees.totalUnique=t.length,this.metrics.employees.ticketsWithoutAssignedById=i.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=r.slice(0,50)}logGrouping(t,i=[],r=[]){t.forEach(s=>{const n={};let o=0;s.employees.forEach(u=>{const a=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;n[u.id]=a,o+=a}),this.metrics.grouping.distributionByStages[s.id]={employees:n,total:o}}),this.metrics.grouping.ticketsNotInColumn=i.slice(0,50),this.metrics.grouping.unknownStages=r.slice(0,50)}logZeroPoint(t){Object.keys(t).forEach(i=>{this.metrics.zeroPoint.byStage[i]=Array.isArray(t[i])?t[i].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let v=null;function S(){return v||(v=new Z),v}function I(e=null){if(e&&e.query&&e.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const t=window.location.hash;if(t){const r=t.split("?");if(r.length>1){const s=r[1];if(new URLSearchParams(s).get("diagnostics")==="true")return!0}if(t.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class J{static getApiUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(t,i={}){try{const r=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:t,params:i})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();if(s.error)throw new Error(s.error_description||s.error);return s}catch(r){throw console.error("Bitrix24 API error:",r),r}}static async getProfile(){return this.call("profile",{})}static async getLeads(t={},i=["ID","NAME","EMAIL","PHONE"],r={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:t,select:i,order:r})).result||[]}}class A{static async call(t,i={}){return await J.call(t,i)}}class f{static get(t){const i=this.cache.get(t);return i?Date.now()-i.timestamp>i.ttl?(this.cache.delete(t),null):i.data:null}static set(t,i,r=this.DEFAULT_TTL){this.cache.set(t,{data:i,timestamp:Date.now(),ttl:r})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const i=[];for(const r of this.cache.keys())r.startsWith(t)&&i.push(r);i.forEach(r=>this.cache.delete(r))}static cleanExpired(){const t=Date.now(),i=[];for(const[r,s]of this.cache.entries())t-s.timestamp>s.ttl&&i.push(r);i.forEach(r=>this.cache.delete(r))}static getStats(){const t=Date.now();let i=0,r=0;for(const s of this.cache.values())t-s.timestamp>s.ttl?i++:r++;return{total:this.cache.size,valid:r,expired:i}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((r,s)=>r-s).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}w(f,"cache",new Map),w(f,"DEFAULT_TTL",5*60*1e3),w(f,"EMPLOYEES_TTL",30*60*1e3),w(f,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{f.cleanExpired()},5*60*1e3);function p(e,t,i={}){if(!e||typeof e!="string")throw new Error("Step must be a non-empty string");const r=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let s=i.description;return s||(s=Q(e,i)),{step:e,progress:r,details:{...i,description:s}}}function Q(e,t){return e==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`Загрузка тикетов стадии "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:e==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`Фильтрация тикетов: ${t.filteredTickets} из ${t.totalTickets}...`:e==="grouping"&&t.employeeCount!==void 0?`Группировка тикетов по ${t.employeeCount} сотрудникам...`:t.count!==void 0&&t.total!==void 0?`Обработка: ${t.count} из ${t.total}...`:"Загрузка данных..."}function F(e){if(!e||typeof e!="object")throw new Error("Progress info must be an object");const t=e.step||null;if(!t)throw new Error("Step is required in progress info");const i=e.progress!==void 0&&e.progress!==null?e.progress:e.percent!==void 0&&e.percent!==null?e.percent:void 0,r=e.details||{};return e.stage&&(r.stage=e.stage),e.stageName&&(r.stageName=e.stageName),e.stageIndex!==void 0&&(r.stageIndex=e.stageIndex),e.totalStages!==void 0&&(r.totalStages=e.totalStages),e.count!==void 0&&(r.count=e.count),e.total!==void 0&&(r.total=e.total),e.warning&&(r.warning=e.warning),{step:t,progress:i!=null?Math.max(0,Math.min(100,i)):void 0,details:r}}function j(e,t,i){const r=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,s=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,n=typeof i=="number"&&!isNaN(i)?Math.max(0,Math.min(100,i)):0,o=r+s*n/100;return Math.max(0,Math.min(100,o))}const O=140;class R{static async getAllTickets(t,i=null,r=!0){const s=[],n=t.length;try{for(let o=0;o<t.length;o++){const u=t[o],a=this.getStageName(u);if(i){const c=o/n*100;i(p("loading_tickets",c,{stage:u,stageName:a,stageIndex:o+1,totalStages:n}))}try{const c=await this.getTicketsByStage(u,r,i?d=>{const g=j(o/n*100,1/n*100,d.percent||0);i(p("loading_tickets",g,{stage:u,stageName:a,stageIndex:o+1,totalStages:n,count:d.count,total:d.total}))}:null);s.push(...c)}catch(c){h.error(`Error loading tickets for stage ${u}`,"TicketRepository",c);let d=`Ошибка загрузки стадии "${a}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${a}". Проверьте подключение к интернету.`:c.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${a}". Попробуйте позже.`:c.message.includes("403")||c.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${a}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${a}": ${c.message}`),new Error(d)}}}catch(o){throw h.error("Error in getAllTickets","TicketRepository",o),o}return s}static getStageName(t){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[t]||t}static async getTicketsByStage(t,i=!0,r=null){var d,g,y,T;if(i){const l=f.getTicketsCacheKey(t),m=f.get(l);if(m!==null){try{const _=S();_&&I()&&_.logTicketsLoading(t,m.length,m.length,null)}catch(_){h.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",_)}return r&&r(F({step:"loading_tickets",percent:100,count:m.length,total:m.length})),m}}const s=[];let n=0;const o=50;let u=!0,a=0,c=null;for(;u;)try{const l=await A.call("crm.item.list",{entityTypeId:O,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:n,useOriginalUfNames:"Y"});let m=[];if(l&&l.result&&(Array.isArray(l.result)?m=l.result:l.result.items&&Array.isArray(l.result.items)?m=l.result.items:l.result.data&&Array.isArray(l.result.data)&&(m=l.result.data)),m.length>0){s.push(...m),n+=m.length;const _=((d=l==null?void 0:l.result)==null?void 0:d.next)!==null&&((g=l==null?void 0:l.result)==null?void 0:g.next)!==void 0&&((y=l==null?void 0:l.result)==null?void 0:y.next)!=="";u=m.length===o&&_;try{const D=S();D&&I()&&D.logTicketsLoading(t,m.length,s.length,((T=l==null?void 0:l.result)==null?void 0:T.next)||null)}catch(D){h.warn("Diagnostics logging error","TicketRepository",D)}if(u?a=n+o:a=s.length,r){const D=a>0?Math.min(100,s.length/a*100):0;r(F({step:"loading_tickets",percent:D,count:s.length,total:a}))}c=null}else u=!1}catch(l){if(h.error(`Error loading tickets batch for stage ${t} (start: ${n})`,"TicketRepository",l),n===0)throw c=l,new Error(`Не удалось загрузить тикеты для стадии ${t}: ${l.message||l}`);u=!1,r&&s.length>0&&r(p("loading_tickets",100,{count:s.length,total:s.length,warning:`Загружено частично: ${s.length} тикетов. Ошибка при загрузке остальных.`}))}if(c&&s.length===0)throw c;if(i){const l=f.getTicketsCacheKey(t);f.set(l,s,f.TICKETS_TTL)}return s}static async getTicket(t){return(await A.call("crm.item.get",{entityTypeId:O,id:t})).result||null}static async updateTicket(t,i){const s=(await A.call("crm.item.update",{entityTypeId:O,id:t,fields:i})).result===!0;return s&&f.invalidateTicketsCache(),s}static async createTicket(t){const i=await A.call("crm.item.add",{entityTypeId:O,fields:t}),r=i.result?parseInt(i.result):0;return r>0&&f.invalidateTicketsCache(),r}static async assignTicket(t,i,r){return await this.updateTicket(t,{assignedById:i,stageId:r})}}class tt{static async getEmployeesByIds(t,i=!0){if(!Array.isArray(t)||t.length===0)return[];if(i){const r=f.getEmployeesCacheKey(t),s=f.get(r);if(s!==null)return h.debug(`Cache hit for employees: ${t.length} employees`,"EmployeeRepository"),s}try{const r=await A.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(r&&r.result&&(Array.isArray(r.result)?s=r.result:h.warn("Unexpected user.get result format","EmployeeRepository",r)),i){const n=f.getEmployeesCacheKey(t);f.set(n,s,f.EMPLOYEES_TTL)}return s}catch(r){return h.error("Error getting employees by IDs","EmployeeRepository",r),[]}}}const E={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367},et=[E.SECTOR_1C,E.SECTOR_HARDWARE,E.SECTOR_BITRIX24,E.SECTOR_PDM];function it(e){return et.includes(e)}const rt=140,P={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},st={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},nt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},ot={3:"high",2:"medium",1:"low"};function at(){return[P.FORMED.bitrixId,P.REVIEW.bitrixId,P.EXECUTION.bitrixId]}function U(e){return st[e]||"formed"}function W(e){return nt[e]||"DT140_12:UC_0VHWE2"}function ct(){return at()}function G(e){const t=parseInt(e.id||e.ID||0),i=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",s=e.assignedById||e.ASSIGNED_BY_ID||null,n=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",o=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"";return{id:t,title:i,priority:lt(e.priority||e.PRIORITY),status:ut(),assigneeId:s?parseInt(s):null,stageId:U(r),createdAt:n,modifiedAt:o,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function lt(e){return ot[e]||"medium"}function ut(e){return"in_progress"}const N=new Map;function dt(){N.clear()}function gt(e){if(!e)return[];if(Array.isArray(e))return e.filter(i=>typeof i=="number"||!isNaN(parseInt(i))).map(i=>typeof i=="number"?i:parseInt(i));if(typeof e=="number")return[e];const t=parseInt(e);return isNaN(t)?[]:[t]}function ft(e,t=!0){const i=e.id||e.ID;if(!e||!i)return null;if(t&&N.has(i))return N.get(i);const r=e.UF_DEPARTMENT||e.departmentId,s=gt(r);for(const n of s)if(it(n)){const u=n;return t&&N.set(i,u),u}return t&&N.set(i,null),null}function ht(e){const t=ft(e);return{id:parseInt(e.ID||e.id||0),name:`${e.NAME||e.name||""} ${e.LAST_NAME||e.lastName||""}`.trim()||e.EMAIL||e.email||"Неизвестный",position:e.WORK_POSITION||e.workPosition||"Сотрудник",email:e.EMAIL||e.email||"",sectorId:t,departmentId:e.UF_DEPARTMENT||null,tickets:[]}}function mt(e){return Array.isArray(e)?e.map(t=>ht(t)):[]}const yt="1C",pt=["1С"],k=new Map,x=100;function V(e){return e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||e.ufCrm7TypeProduct||e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||null}function b(e){return e==null?null:String(e).trim().toUpperCase().replace(/С/g,"C")||null}function q(e){if(!e)return[];if(Array.isArray(e))return e.map(b).filter(Boolean);if(typeof e=="object"&&e.value!==void 0){const i=b(e.value);return i?[i]:[]}const t=b(e);return t?t.split(/[;,]/).map(i=>i.trim()).filter(Boolean):[]}function Y(e){const t=V(e),i=q(t);return i.length===0?!1:i.some(r=>r===yt||pt.includes(r))}function Tt(e){return`filter:${e.map(i=>i.id||i.ID||"").sort().join(",")}`}function Et(){k.size>x&&Array.from(k.keys()).slice(0,Math.floor(x*.2)).forEach(t=>k.delete(t))}function St(e){if(!Array.isArray(e))return[];const t=Tt(e),i=k.get(t);if(i!==void 0)return i;const r=e.filter(Y);try{const s=S();if(s&&I()){const n=e.filter(a=>!Y(a)),o=[],u=new Set;e.forEach(a=>{const c=V(a),d=q(c),g=c==null?"":String(c);c!=null&&!u.has(g)&&(u.add(g),o.push({value:c,normalized:d,type:typeof c,isArray:Array.isArray(c),ticketId:a.id||a.ID}))}),s.logFiltering(e.length,r.length,n,o)}}catch(s){console.warn("Diagnostics logging error in filterBySector:",s)}return k.set(t,r),Et(),r}const B=1051;function L(e){if(!e||typeof e!="object")return null;let t=e.assignedById||e.ASSIGNED_BY_ID||e.assignedByIdId||e.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function K(e){if(e==null)return null;typeof e=="object"&&(e=e.id||e.ID||e.value||null);const t=typeof e=="number"?e:parseInt(e);return isNaN(t)||t<=0?null:t}function It(e,t=B){const i=L(e),r=K(i);return r===null||r===t}function _t(e,t){Array.isArray(e)||(h.warn("Tickets is not an array","TicketGrouper",e),e=[]),Array.isArray(t)||(h.warn("Employees is not an array","TicketGrouper",t),t=[]);const i=t.filter(a=>(a.id?parseInt(a.id):null)!==B),r=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:i.map(a=>({...a,isFromSector1C:a.sectorId===E.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:i.map(a=>({...a,isFromSector1C:a.sectorId===E.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:i.map(a=>({...a,isFromSector1C:a.sectorId===E.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(r.map(a=>[a.id,a])),n=new Map;r.forEach(a=>{const c=new Map(a.employees.map(d=>[d.id,d]));n.set(a.id,c)});const o=[],u=[];e.forEach(a=>{const c=U(a.stageId||a.STAGE_ID||""),d=s.get(c);if(!d){u.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID,assignedById:L(a)});return}const g=L(a),y=K(g);if(y!==B)if(y){const T=n.get(c);let l=T.get(y);l||(l={id:y,name:`Сотрудник #${y}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},d.employees.push(l),T.set(y,l));const m=G(a);l.tickets.push(m),l.isFromSector1C?l.ticketsInsideSector.push(m):l.ticketsOutsideSector.push(m)}else o.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:c,assignedById:g})}),r.forEach(a=>{a.employees.sort((c,d)=>c.isFromSector1C&&!d.isFromSector1C?-1:!c.isFromSector1C&&d.isFromSector1C?1:(c.id||0)-(d.id||0))});try{const a=S();if(a&&I()){const c={};r.forEach(g=>{let y=0,T=0;g.employees.forEach(l=>{y+=(l.ticketsInsideSector||[]).length,T+=(l.ticketsOutsideSector||[]).length}),c[g.id]={insideSector:y,outsideSector:T,total:y+T}});const d=a.metrics.grouping;Object.keys(c).forEach(g=>{d.distributionByStages[g]||(d.distributionByStages[g]={employees:{},total:0}),d.distributionByStages[g].insideSector=c[g].insideSector,d.distributionByStages[g].outsideSector=c[g].outsideSector,d.distributionByStages[g].total=c[g].total}),a.logGrouping(r,o,u)}}catch(a){h.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",a)}return r}function Dt(e){const t={formed:[],review:[],execution:[]};if(!Array.isArray(e))return h.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",e),t;e.filter(i=>It(i)).forEach(i=>{const r=U(i.stageId||i.STAGE_ID||"");t[r]&&t[r].push(G(i))});try{const i=S();i&&I()&&i.logZeroPoint(t)}catch(i){h.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",i)}return t}function At(e){if(!Array.isArray(e))return[];const t=new Set,i=[],r=[];e.forEach(n=>{const o=L(n),u=K(o);!o||o===null||o===void 0?i.push({id:n.id||n.ID,title:n.title||n.TITLE||"Без названия",stageId:n.stageId||n.STAGE_ID}):u===B&&r.push({id:n.id||n.ID,title:n.title||n.TITLE||"Без названия",stageId:n.stageId||n.STAGE_ID}),u&&t.add(u)});const s=Array.from(t);try{const n=S();n&&I()&&n.logEmployees(s,i,r)}catch(n){h.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",n)}return s}const M=new Map,wt=10*60*1e3;function Ct(e){if(!e||typeof e!="object")return{};const t={},i=Object.keys(e);for(const r of i)r.toUpperCase().startsWith("UF_")&&(t[r]=e[r]);return t}function Rt(e,t=null,i=!0){if(i&&t&&M.has(t)){const n=M.get(t),o=Date.now();if(n.timestamp&&o-n.timestamp<wt)return n.data;M.delete(t)}const r=Ct(e),s={typeProduct:r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||null,all:r};return i&&t&&M.set(t,{data:s,timestamp:Date.now()}),s}class Nt{static async getTicketDetails(t,i={}){const{select:r=["*"],useOriginalUfNames:s=!0,useCache:n=!0}=i;try{const o=await R.getTicket(t);if(!o)throw new Error(`Тикет с ID ${t} не найден`);const u=Rt(o,t,n);return{id:o.id||o.ID,title:o.title||o.TITLE,stageId:o.stageId||o.STAGE_ID,assignedById:o.assignedById||o.ASSIGNED_BY_ID,createdAt:o.createdTime||o.CREATED_TIME||o.CREATED_DATE,updatedAt:o.updatedTime||o.UPDATED_TIME||o.MODIFY_DATE,priority:o.priority||o.PRIORITY,opportunity:o.opportunity||o.OPPORTUNITY,currencyId:o.currencyId||o.CURRENCY_ID,comments:o.comments||o.COMMENTS,additionalFields:u,rawData:o}}catch(o){throw h.error("Error getting ticket details","TicketDetailsService",o),o}}}class Ot{static async getSectorData(t=!0,i=null){try{if(I()){const r=S();r&&r.reset()}}catch(r){h.warn("Error resetting diagnostics","DashboardSector1CService",r)}if(i&&i(p("cache_check",0,{description:"Инициализация загрузки..."})),t){const r=f.getSectorDataCacheKey(),s=f.get(r);if(s!==null)return i&&i(p("cache_hit",100,{description:"Данные загружены из кеша"})),s}try{i&&i(p("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const r=ct(),s=await R.getAllTickets(r,g=>{if(i){const y=F(g),T=j(10,40,y.progress||0);i(p(y.step||"loading_tickets",T,{...y.details,warning:y.details.warning}))}},t);i&&i(p("filtering",50,{totalTickets:s.length,description:`Фильтрация ${s.length} тикетов по сектору 1С...`}));const n=St(s);i&&i(p("filtering",50,{totalTickets:s.length,filteredTickets:n.length,description:`Отфильтровано ${n.length} тикетов из ${s.length}`})),i&&i(p("extracting_employees",60,{filteredTickets:n.length,description:`Анализ ${n.length} тикетов для определения сотрудников...`}));const o=At(n);i&&i(p("extracting_employees",60,{employeeCount:o.length,description:`Найдено ${o.length} уникальных сотрудников`})),i&&i(p("loading_employees",65,{employeeCount:o.length,description:`Загрузка данных ${o.length} сотрудников...`})),dt();const u=await tt.getEmployeesByIds(o),a=mt(u);i&&i(p("loading_employees",90,{employeeCount:a.length,description:`Загружено данных ${a.length} сотрудников`})),i&&i(p("grouping",90,{filteredTickets:n.length,employeeCount:a.length,description:`Группировка ${n.length} тикетов по этапам и ${a.length} сотрудникам...`}));const d={stages:_t(n,a),employees:a,zeroPointTickets:Dt(n)};if(i&&i(p("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),t){const g=f.getSectorDataCacheKey();f.set(g,d,f.TICKETS_TTL)}return i&&i(p("complete",100,{description:"Загрузка завершена"})),d}catch(r){throw h.error("Error getting sector data","DashboardSector1CService",r),i&&i({step:"error",progress:0,error:r.message}),r}}static async assignTicket(t,i,r){try{const s=W(r),n=await R.assignTicket(t,i,s);return n&&f.invalidateTicketsCache(),n}catch(s){throw h.error("Error assigning ticket","DashboardSector1CService",s),s}}static async createTicket(t){try{const i=W(t.stageId||"formed"),r={title:t.title,stageId:i};t.employeeId&&(r.assignedById=t.employeeId);const s=await R.createTicket(r);return s>0&&f.invalidateTicketsCache(),s}catch(i){throw h.error("Error creating ticket","DashboardSector1CService",i),i}}static async getTicket(t){try{const i=await R.getTicket(t);return G(i)}catch(i){throw h.error("Error getting ticket","DashboardSector1CService",i),i}}static async getTicketDetails(t,i={}){try{return await Nt.getTicketDetails(t,i)}catch(r){throw h.error("Error getting ticket details","DashboardSector1CService",r),r}}static async addComment(t,i){try{return(await A.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+rt,comment:i}})).result!==void 0}catch(r){throw h.error("Error adding comment","DashboardSector1CService",r),r}}}export{f as C,Ot as D,B as K,h as L,P as S,R as T,X as a,nt as b,dt as c,S as g,I as i,F as n};
