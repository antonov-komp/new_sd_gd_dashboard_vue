var G=Object.defineProperty;var b=(e,t,r)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var I=(e,t,r)=>b(e,typeof t!="symbol"?t+"":t,r);const N="dashboard-sector-1c-logger-level",S={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class W{static getLevel(){if(typeof localStorage<"u"){const t=localStorage.getItem(N);if(t&&S[t]!==void 0)return t}return"ERROR"}static setLevel(t){return S[t]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(N,t),!0):!1}static isEnabled(t,r=null){const n=r||this.getLevel();if(n==="NONE")return!1;const i=S[t]||0,s=S[n]||0;return i<=s}static getLevels(){return{...S}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(N)}}class g{static getLevelColor(t){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[t]||"#6c757d"}static formatMessage(t,r,n=""){const i=new Date().toISOString(),s=this.getLevelColor(t),a=`%c[${i}] %c[${t}] %c[${n||"Unknown"}] %c${r}`,l=["color: #6c757d; font-weight: normal",`color: ${s}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:a,styles:l}}static log(t,r,n="",i=null){if(!W.isEnabled(t))return;const s=this.formatMessage(t,r,n),a=[s.formatted,...s.styles];switch(i!=null&&a.push(i),t){case"ERROR":console.error(...a);break;case"WARN":console.warn(...a);break;case"INFO":console.info(...a);break;case"DEBUG":console.log(...a);break;default:console.log(...a)}}static error(t,r="",n=null){this.log("ERROR",t,r,n)}static warn(t,r="",n=null){this.log("WARN",t,r,n)}static info(t,r="",n=null){this.log("INFO",t,r,n)}static debug(t,r="",n=null){this.log("DEBUG",t,r,n)}}class x{static getApiUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(t,r={}){try{const n=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:t,params:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.json();if(i.error)throw new Error(i.error_description||i.error);return i}catch(n){throw console.error("Bitrix24 API error:",n),n}}static async getProfile(){return this.call("profile",{})}static async getLeads(t={},r=["ID","NAME","EMAIL","PHONE"],n={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:t,select:r,order:n})).result||[]}}class E{static async call(t,r={}){return await x.call(t,r)}}class u{static get(t){const r=this.cache.get(t);return r?Date.now()-r.timestamp>r.ttl?(this.cache.delete(t),null):r.data:null}static set(t,r,n=this.DEFAULT_TTL){this.cache.set(t,{data:r,timestamp:Date.now(),ttl:n})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const r=[];for(const n of this.cache.keys())n.startsWith(t)&&r.push(n);r.forEach(n=>this.cache.delete(n))}static cleanExpired(){const t=Date.now(),r=[];for(const[n,i]of this.cache.entries())t-i.timestamp>i.ttl&&r.push(n);r.forEach(n=>this.cache.delete(n))}static getStats(){const t=Date.now();let r=0,n=0;for(const i of this.cache.values())t-i.timestamp>i.ttl?r++:n++;return{total:this.cache.size,valid:n,expired:r}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((n,i)=>n-i).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}I(u,"cache",new Map),I(u,"DEFAULT_TTL",5*60*1e3),I(u,"EMPLOYEES_TTL",30*60*1e3),I(u,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{u.cleanExpired()},5*60*1e3);function m(e,t,r={}){if(!e||typeof e!="string")throw new Error("Step must be a non-empty string");const n=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let i=r.description;return i||(i=V(e,r)),{step:e,progress:n,details:{...r,description:i}}}function V(e,t){return e==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`Загрузка тикетов стадии "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:e==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`Фильтрация тикетов: ${t.filteredTickets} из ${t.totalTickets}...`:e==="grouping"&&t.employeeCount!==void 0?`Группировка тикетов по ${t.employeeCount} сотрудникам...`:t.count!==void 0&&t.total!==void 0?`Обработка: ${t.count} из ${t.total}...`:"Загрузка данных..."}function k(e){if(!e||typeof e!="object")throw new Error("Progress info must be an object");const t=e.step||null;if(!t)throw new Error("Step is required in progress info");const r=e.progress!==void 0&&e.progress!==null?e.progress:e.percent!==void 0&&e.percent!==null?e.percent:void 0,n=e.details||{};return e.stage&&(n.stage=e.stage),e.stageName&&(n.stageName=e.stageName),e.stageIndex!==void 0&&(n.stageIndex=e.stageIndex),e.totalStages!==void 0&&(n.totalStages=e.totalStages),e.count!==void 0&&(n.count=e.count),e.total!==void 0&&(n.total=e.total),e.warning&&(n.warning=e.warning),{step:t,progress:r!=null?Math.max(0,Math.min(100,r)):void 0,details:n}}function K(e,t,r){const n=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,s=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,a=n+i*s/100;return Math.max(0,Math.min(100,a))}const A=140;class _{static async getAllTickets(t,r=null){const n=[],i=t.length;try{for(let s=0;s<t.length;s++){const a=t[s],l=this.getStageName(a);if(r){const c=s/i*100;r(m("loading_tickets",c,{stage:a,stageName:l,stageIndex:s+1,totalStages:i}))}try{const c=await this.getTicketsByStage(a,!0,r?d=>{const y=K(s/i*100,1/i*100,d.percent||0);r(m("loading_tickets",y,{stage:a,stageName:l,stageIndex:s+1,totalStages:i,count:d.count,total:d.total}))}:null);n.push(...c)}catch(c){g.error(`Error loading tickets for stage ${a}`,"TicketRepository",c);let d=`Ошибка загрузки стадии "${l}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${l}". Проверьте подключение к интернету.`:c.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${l}". Попробуйте позже.`:c.message.includes("403")||c.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${l}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${l}": ${c.message}`),new Error(d)}}}catch(s){throw g.error("Error in getAllTickets","TicketRepository",s),s}return n}static getStageName(t){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[t]||t}static async getTicketsByStage(t,r=!0,n=null){var y,p,f;if(r){const o=u.getTicketsCacheKey(t),h=u.get(o);if(h!==null)return n&&n(k({step:"loading_tickets",percent:100,count:h.length,total:h.length})),h}const i=[];let s=0;const a=50;let l=!0,c=0,d=null;for(;l;)try{const o=await E.call("crm.item.list",{entityTypeId:A,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:s,useOriginalUfNames:"Y"});let h=[];if(o&&o.result&&(Array.isArray(o.result)?h=o.result:o.result.items&&Array.isArray(o.result.items)?h=o.result.items:o.result.data&&Array.isArray(o.result.data)&&(h=o.result.data)),h.length>0){i.push(...h),s+=h.length;const U=((y=o==null?void 0:o.result)==null?void 0:y.next)!==null&&((p=o==null?void 0:o.result)==null?void 0:p.next)!==void 0&&((f=o==null?void 0:o.result)==null?void 0:f.next)!=="";if(l=h.length===a&&U,l?c=s+a:c=i.length,n){const Y=c>0?Math.min(100,i.length/c*100):0;n(k({step:"loading_tickets",percent:Y,count:i.length,total:c}))}d=null}else l=!1}catch(o){if(g.error(`Error loading tickets batch for stage ${t} (start: ${s})`,"TicketRepository",o),s===0)throw d=o,new Error(`Не удалось загрузить тикеты для стадии ${t}: ${o.message||o}`);l=!1,n&&i.length>0&&n(m("loading_tickets",100,{count:i.length,total:i.length,warning:`Загружено частично: ${i.length} тикетов. Ошибка при загрузке остальных.`}))}if(d&&i.length===0)throw d;if(r){const o=u.getTicketsCacheKey(t);u.set(o,i,u.TICKETS_TTL)}return i}static async getTicket(t){return(await E.call("crm.item.get",{entityTypeId:A,id:t})).result||null}static async updateTicket(t,r){const i=(await E.call("crm.item.update",{entityTypeId:A,id:t,fields:r})).result===!0;return i&&u.invalidateTicketsCache(),i}static async createTicket(t){const r=await E.call("crm.item.add",{entityTypeId:A,fields:t}),n=r.result?parseInt(r.result):0;return n>0&&u.invalidateTicketsCache(),n}static async assignTicket(t,r,n){return await this.updateTicket(t,{assignedById:r,stageId:n})}}class H{static async getEmployeesByIds(t,r=!0){if(!Array.isArray(t)||t.length===0)return[];if(r){const n=u.getEmployeesCacheKey(t),i=u.get(n);if(i!==null)return g.debug(`Cache hit for employees: ${t.length} employees`,"EmployeeRepository"),i}try{const n=await E.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let i=[];if(n&&n.result&&(Array.isArray(n.result)?i=n.result:g.warn("Unexpected user.get result format","EmployeeRepository",n)),r){const s=u.getEmployeesCacheKey(t);u.set(s,i,u.EMPLOYEES_TTL)}return i}catch(n){return g.error("Error getting employees by IDs","EmployeeRepository",n),[]}}}const T={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367},j=[T.SECTOR_1C,T.SECTOR_HARDWARE,T.SECTOR_BITRIX24,T.SECTOR_PDM];function X(e){return j.includes(e)}const z=140,O={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},q={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},Z={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},J={3:"high",2:"medium",1:"low"};function Q(){return[O.FORMED.bitrixId,O.REVIEW.bitrixId,O.EXECUTION.bitrixId]}function $(e){return q[e]||"formed"}function B(e){return Z[e]||"DT140_12:UC_0VHWE2"}function tt(){return Q()}function L(e){const t=parseInt(e.id||e.ID||0),r=e.title||e.TITLE||"Без названия",n=e.stageId||e.STAGE_ID||"",i=e.assignedById||e.ASSIGNED_BY_ID||null,s=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",a=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"";return{id:t,title:r,priority:et(e.priority||e.PRIORITY),status:rt(),assigneeId:i?parseInt(i):null,stageId:$(n),createdAt:s,modifiedAt:a,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function et(e){return J[e]||"medium"}function rt(e){return"in_progress"}const D=new Map;function nt(){D.clear()}function it(e){if(!e)return[];if(Array.isArray(e))return e.filter(r=>typeof r=="number"||!isNaN(parseInt(r))).map(r=>typeof r=="number"?r:parseInt(r));if(typeof e=="number")return[e];const t=parseInt(e);return isNaN(t)?[]:[t]}function at(e,t=!0){const r=e.id||e.ID;if(!e||!r)return null;if(t&&D.has(r))return D.get(r);const n=e.UF_DEPARTMENT||e.departmentId,i=it(n);for(const s of i)if(X(s)){const l=s;return t&&D.set(r,l),l}return t&&D.set(r,null),null}function st(e){const t=at(e);return{id:parseInt(e.ID||e.id||0),name:`${e.NAME||e.name||""} ${e.LAST_NAME||e.lastName||""}`.trim()||e.EMAIL||e.email||"Неизвестный",position:e.WORK_POSITION||e.workPosition||"Сотрудник",email:e.EMAIL||e.email||"",sectorId:t,departmentId:e.UF_DEPARTMENT||null,tickets:[]}}function ct(e){return Array.isArray(e)?e.map(t=>st(t)):[]}const w="1C",C=new Map,P=100;function ot(e){return e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||e.ufCrm7TypeProduct||e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||null}function lt(e){const t=ot(e);return t?Array.isArray(t)?t.includes(w):typeof t=="object"&&t!==null&&t.value===w||t===w:!1}function ut(e){return`filter:${e.map(r=>r.id||r.ID||"").sort().join(",")}`}function dt(){C.size>P&&Array.from(C.keys()).slice(0,Math.floor(P*.2)).forEach(t=>C.delete(t))}function ft(e){if(!Array.isArray(e))return[];const t=ut(e),r=C.get(t);if(r!==void 0)return r;const n=e.filter(lt);return C.set(t,n),dt(),n}const M=1051;function v(e){if(!e||typeof e!="object")return null;let t=e.assignedById||e.ASSIGNED_BY_ID||e.assignedByIdId||e.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function F(e){if(e==null)return null;typeof e=="object"&&(e=e.id||e.ID||e.value||null);const t=typeof e=="number"?e:parseInt(e);return isNaN(t)||t<=0?null:t}function mt(e,t=M){const r=v(e),n=F(r);return n===null||n===t}function gt(e,t){Array.isArray(e)||(g.warn("Tickets is not an array","TicketGrouper",e),e=[]),Array.isArray(t)||(g.warn("Employees is not an array","TicketGrouper",t),t=[]);const r=t.filter(a=>(a.id?parseInt(a.id):null)!==M),n=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===T.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===T.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===T.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],i=new Map(n.map(a=>[a.id,a])),s=new Map;return n.forEach(a=>{const l=new Map(a.employees.map(c=>[c.id,c]));s.set(a.id,l)}),e.forEach(a=>{const l=$(a.stageId||a.STAGE_ID||""),c=i.get(l);if(c){const d=v(a),y=F(d);if(y===M)return;if(y){const p=s.get(l);let f=p.get(y);f||(f={id:y,name:`Сотрудник #${y}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},c.employees.push(f),p.set(y,f));const o=L(a);f.tickets.push(o),f.isFromSector1C?f.ticketsInsideSector.push(o):f.ticketsOutsideSector.push(o)}}}),n.forEach(a=>{a.employees.sort((l,c)=>l.isFromSector1C&&!c.isFromSector1C?-1:!l.isFromSector1C&&c.isFromSector1C?1:(l.id||0)-(c.id||0))}),n}function yt(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(r=>mt(r)).forEach(r=>{const n=$(r.stageId||r.STAGE_ID||"");t[n]&&t[n].push(L(r))}),t):(g.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",e),t)}function ht(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(r=>{const n=v(r),i=F(n);i&&t.add(i)}),Array.from(t)}const R=new Map,pt=10*60*1e3;function Tt(e){if(!e||typeof e!="object")return{};const t={},r=Object.keys(e);for(const n of r)n.toUpperCase().startsWith("UF_")&&(t[n]=e[n]);return t}function Et(e,t=null,r=!0){if(r&&t&&R.has(t)){const s=R.get(t),a=Date.now();if(s.timestamp&&a-s.timestamp<pt)return s.data;R.delete(t)}const n=Tt(e),i={typeProduct:n.UF_CRM_7_TYPE_PRODUCT||n.uf_crm_7_type_product||n.ufCrm7TypeProduct||null,all:n};return r&&t&&R.set(t,{data:i,timestamp:Date.now()}),i}class It{static async getTicketDetails(t,r={}){const{select:n=["*"],useOriginalUfNames:i=!0,useCache:s=!0}=r;try{const a=await _.getTicket(t);if(!a)throw new Error(`Тикет с ID ${t} не найден`);const l=Et(a,t,s);return{id:a.id||a.ID,title:a.title||a.TITLE,stageId:a.stageId||a.STAGE_ID,assignedById:a.assignedById||a.ASSIGNED_BY_ID,createdAt:a.createdTime||a.CREATED_TIME||a.CREATED_DATE,updatedAt:a.updatedTime||a.UPDATED_TIME||a.MODIFY_DATE,priority:a.priority||a.PRIORITY,opportunity:a.opportunity||a.OPPORTUNITY,currencyId:a.currencyId||a.CURRENCY_ID,comments:a.comments||a.COMMENTS,additionalFields:l,rawData:a}}catch(a){throw g.error("Error getting ticket details","TicketDetailsService",a),a}}}class _t{static async getSectorData(t=!0,r=null){if(r&&r(m("cache_check",0,{description:"Инициализация загрузки..."})),t){const n=u.getSectorDataCacheKey(),i=u.get(n);if(i!==null)return r&&r(m("cache_hit",100,{description:"Данные загружены из кеша"})),i}try{r&&r(m("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const n=tt(),i=await _.getAllTickets(n,p=>{if(r){const f=k(p),o=K(10,40,f.progress||0);r(m(f.step||"loading_tickets",o,{...f.details,warning:f.details.warning}))}});r&&r(m("filtering",50,{totalTickets:i.length,description:`Фильтрация ${i.length} тикетов по сектору 1С...`}));const s=ft(i);r&&r(m("filtering",50,{totalTickets:i.length,filteredTickets:s.length,description:`Отфильтровано ${s.length} тикетов из ${i.length}`})),r&&r(m("extracting_employees",60,{filteredTickets:s.length,description:`Анализ ${s.length} тикетов для определения сотрудников...`}));const a=ht(s);r&&r(m("extracting_employees",60,{employeeCount:a.length,description:`Найдено ${a.length} уникальных сотрудников`})),r&&r(m("loading_employees",65,{employeeCount:a.length,description:`Загрузка данных ${a.length} сотрудников...`})),nt();const l=await H.getEmployeesByIds(a),c=ct(l);r&&r(m("loading_employees",90,{employeeCount:c.length,description:`Загружено данных ${c.length} сотрудников`})),r&&r(m("grouping",90,{filteredTickets:s.length,employeeCount:c.length,description:`Группировка ${s.length} тикетов по этапам и ${c.length} сотрудникам...`}));const y={stages:gt(s,c),employees:c,zeroPointTickets:yt(s)};if(r&&r(m("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),t){const p=u.getSectorDataCacheKey();u.set(p,y,u.TICKETS_TTL)}return r&&r(m("complete",100,{description:"Загрузка завершена"})),y}catch(n){throw g.error("Error getting sector data","DashboardSector1CService",n),r&&r({step:"error",progress:0,error:n.message}),n}}static async assignTicket(t,r,n){try{const i=B(n),s=await _.assignTicket(t,r,i);return s&&u.invalidateTicketsCache(),s}catch(i){throw g.error("Error assigning ticket","DashboardSector1CService",i),i}}static async createTicket(t){try{const r=B(t.stageId||"formed"),n={title:t.title,stageId:r};t.employeeId&&(n.assignedById=t.employeeId);const i=await _.createTicket(n);return i>0&&u.invalidateTicketsCache(),i}catch(r){throw g.error("Error creating ticket","DashboardSector1CService",r),r}}static async getTicket(t){try{const r=await _.getTicket(t);return L(r)}catch(r){throw g.error("Error getting ticket","DashboardSector1CService",r),r}}static async getTicketDetails(t,r={}){try{return await It.getTicketDetails(t,r)}catch(n){throw g.error("Error getting ticket details","DashboardSector1CService",n),n}}static async addComment(t,r){try{return(await E.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+z,comment:r}})).result!==void 0}catch(n){throw g.error("Error adding comment","DashboardSector1CService",n),n}}}export{_t as D,M as K,g as L,O as S,W as a,Z as b,k as n};
