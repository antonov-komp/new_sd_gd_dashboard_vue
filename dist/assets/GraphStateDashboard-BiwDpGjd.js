const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ticketListUtils-XuGHwEFL.js","./priority-config-BlFVckKp.js","./main-DoH-2gzR.js","./main-DgXsRbvu.css","./priority-config-Bxxce_5E.css","./ticket-mapper-DESxIyAn.js"])))=>i.map(i=>d[i]);
import{a5 as Rt,_ as Ye,a as I,o as T,b as u,F as pe,e as ge,n as ce,l as ve,t as H,g as B,c as ae,G as Ke,m as Xe,f as Ee,d as q,j as me,k as xe,a6 as ze,i as oe,y as lt,B as it,T as Ct,I as Mt,u as qe,a1 as Ae,X as Ve,p as tt,a7 as at,x as Ht,$ as Ot,a8 as xt,C as Nt,H as Ft,D as Wt,Z as Oe,z as jt,r as Ut}from"./main-DoH-2gzR.js";import{L as Et,D as zt,B as Vt}from"./index-tOCMjeN3.js";import{K as Kt,D as _t}from"./index-DHm6vmnR.js";import{S as st,d as nt,T as Tt,c as Gt}from"./priority-config-BlFVckKp.js";import{g as Xt,a as $t,b as It,f as Yt,T as qt}from"./ticketListUtils-XuGHwEFL.js";import{m as ot}from"./ticket-mapper-DESxIyAn.js";import{F as Jt}from"./FiltersPanel-DKkKpfhJ.js";const Se={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Ce{static getApiBaseUrl(){return Rt()}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new Me("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new Me("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(t);if(!r.isValid)throw new Me(`Ошибка валидации данных сектора: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const s=this.normalizeSectorData(t),c={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||Se.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},l=this.validateSnapshot(c);if(!l.isValid)throw new Me(`Ошибка валидации слепка: ${l.errors.join(", ")}`,"VALIDATION_ERROR",{validation:l});l.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",l.warnings);const n=this.getApiBaseUrl(),y=await fetch(`${n}${Se.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:e,date:this.formatDate(new Date)})});if(!y.ok)throw new Error(`HTTP error! status: ${y.status}`);const h=await y.json();if(!h.success)throw new Error(h.message||"Ошибка создания слепка");return h.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof Me?r:new Me(`Ошибка создания слепка: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),s=`${this.getApiBaseUrl()}${Se.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,o=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(o.status===404)return null;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const c=await o.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Se.defaultSectorId);const r=`${this.getApiBaseUrl()}${Se.snapshotsEndpoint}?${e.toString()}`,s=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.json();if(!o.success)throw new Error(o.message||"Ошибка получения списка слепков");return(await Promise.all(o.data.snapshots.map(async l=>{try{return await this.getSnapshot(l.date,l.type)}catch(n){return console.warn(`Ошибка загрузки слепка ${l.date}/${l.type}:`,n),null}}))).filter(l=>l!==null).sort((l,n)=>new Date(l.metadata.createdAt)-new Date(n.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:r={}}=t,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},o=[],c=[],l=[];e.forEach(h=>{const d=h.id;if(s[d]){let E=0;h.employees.forEach(b=>{const _=b.tickets||[];E+=_.length;let D=o.find(w=>w.id===b.id);D||(D={id:b.id,name:b.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},o.push(D)),_.forEach(w=>{c.push(w.id),l.push({id:w.id,title:w.title||"Без названия",assignedTo:{id:b.id,name:b.name},createdAt:w.createdAt||"",updatedAt:w.modifiedAt||w.updatedAt||""}),D.ticketsByStage[d]=(D.ticketsByStage[d]||0)+1,D.totalTickets+=1})}),s[d].count=E}});const n={unassigned:0,keeper:0,total:0};Object.values(r).forEach(h=>{Array.isArray(h)&&h.forEach(d=>{n.total+=1,d.assigneeId===1051||d.assignedById===1051?n.keeper+=1:n.unassigned+=1,c.push(d.id),l.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const y=Object.values(s).reduce((h,d)=>h+d.count,0)+n.total;return{statistics:{stages:{...s,total:y},employees:o,zeroPoint:n},ticketIds:[...new Set(c)],tickets:l}}static generateSnapshotMetadata(t,e,a){const r=new Date,s=-r.getTimezoneOffset(),o=Math.floor(s/60),c=s%60,l=`${o>=0?"+":""}${String(o).padStart(2,"0")}:${String(c).padStart(2,"0")}`,n=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${l}`;return{version:Se.snapshotVersion,createdAt:n,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${r}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,r=a.getFullYear(),s=this.getWeekNumber(a),o=this.formatDate(t);let c;if(e==="current"){const l=new Date,n=`${String(l.getHours()).padStart(2,"0")}-${String(l.getMinutes()).padStart(2,"0")}-${String(l.getSeconds()).padStart(2,"0")}`;c=`current-state-${o}-${n}.json`}else if(e==="manual"){const l=new Date,n=`${String(l.getHours()).padStart(2,"0")}-${String(l.getMinutes()).padStart(2,"0")}-${String(l.getSeconds()).padStart(2,"0")}`;c=`manual-${o}-${n}.json`}else c=`${e}-${o}.json`;return e==="current"?`current/${c}`:`${r}/week-${s}/${c}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const r=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-r)/864e5+1)/7)}static validateSnapshot(t){var r,s,o;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const c=t.statistics.stages,l=(((r=c.formed)==null?void 0:r.count)||0)+(((s=c.review)==null?void 0:s.count)||0)+(((o=c.execution)==null?void 0:o.count)||0);c.total!==l&&a.push(`Несоответствие общего количества тикетов: ожидается ${l}, указано ${c.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const c=t.statistics.zeroPoint,l=(c.unassigned||0)+(c.keeper||0);c.total!==l&&a.push(`Несоответствие статистики нулевой точки: ожидается ${l}, указано ${c.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const c=new Set(t.ticketIds),l=new Set(t.tickets.map(n=>n.id));c.size!==l.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((n,y)=>{n.id||e.push(`Тикет #${y}: отсутствует ID`),n.title||e.push(`Тикет #${y}: отсутствует заголовок`),(!n.assignedTo||!n.assignedTo.id)&&a.push(`Тикет #${y}: отсутствует ответственный (может быть в нулевой точке)`),n.createdAt||e.push(`Тикет #${y}: отсутствует дата создания`),n.updatedAt||e.push(`Тикет #${y}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),s=`${this.getApiBaseUrl()}${Se.snapshotsEndpoint}`,o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(o.status===404)return!1;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const c=await o.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const r of e)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&a++}catch(s){console.warn(`Ошибка удаления слепка ${r.metadata.createdAt}:`,s)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Se.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,r=(e.getDay()||7)-1,s=new Date(e);return s.setDate(e.getDate()-r),s.setHours(0,0,0,0),s}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,r=7-(e.getDay()||7),s=new Date(e);return s.setDate(e.getDate()+r),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),r=this.getWeekNumberInfo(t),s=await this.getAllSnapshots({startDate:e,endDate:a}),o=s.find(n=>n.metadata.type==="week_start")||null,c=s.find(n=>n.metadata.type==="week_end")||null,l=s.filter(n=>n.metadata.type==="manual");return{weekStart:o,weekEnd:c,manual:l,weekInfo:r}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof Me)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},r=new Map;let s=null,o=null;e.forEach(l=>{const n=l.metadata.type;a.hasOwnProperty(n)&&a[n]++;const y=this.getWeekNumberInfo(l.metadata.createdAt),h=`${y.year}-W${y.week}`;r.set(h,(r.get(h)||0)+1);const d=new Date(l.metadata.createdAt);(!s||d<new Date(s.metadata.createdAt))&&(s=l),(!o||d>new Date(o.metadata.createdAt))&&(o=l)});const c=Array.from(r.entries()).map(([l,n])=>{const[y,h]=l.split("-W");return{year:parseInt(y),week:parseInt(h),count:n}}).sort((l,n)=>l.year!==n.year?l.year-n.year:l.week-n.week);return{total:e.length,byType:a,byWeek:c,oldest:s,newest:o}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class Me extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const De={formed:{bitrixId:nt.formed,name:st.FORMED.name},review:{bitrixId:nt.review,name:st.REVIEW.name},execution:{bitrixId:nt.execution,name:st.EXECUTION.name}},Ge=Kt;function Zt(i){if(!i||typeof i!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!i.stages||!Array.isArray(i.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=Qt(i.stages),e=ea(i.stages),a=ta(i.zeroPointTickets||{}),r=aa(i.zeroPointTickets||{}),s=sa(i.stages,i.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:r},ticketIds:s.ticketIds,tickets:s.tickets}}function Qt(i){const t={formed:{count:0,stageId:De.formed.bitrixId,stageName:De.formed.name},review:{count:0,stageId:De.review.bitrixId,stageName:De.review.name},execution:{count:0,stageId:De.execution.bitrixId,stageName:De.execution.name},total:0};return i.forEach(e=>{if(!De[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(a+=r.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function ea(i){const t=new Map;return i.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=t.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;De[e.id]&&(r.ticketsByStage[e.id]=(r.ticketsByStage[e.id]||0)+s),r.totalTickets+=s})}),Array.from(t.values())}function ta(i){let t=0,e=0;return!i||typeof i!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(i).forEach(a=>{Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?t++:(typeof s=="object"?s.id:s)===Ge?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function aa(i){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!i||typeof i!="object"||Object.keys(t).forEach(e=>{const a=i[e];Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?t[e].unassigned++:(typeof s=="object"?s.id:s)===Ge?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function sa(i,t){const e=new Set,a=new Map;return Array.isArray(i)&&i.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(o=>{if(!o||!o.id){console.warn("Ticket without ID found:",o);return}const c=parseInt(o.id);if(isNaN(c)){console.warn("Invalid ticket ID:",o.id);return}e.add(c);let l=o.assignedTo;!l&&s.id&&(l={id:s.id,name:s.name||`Сотрудник #${s.id}`}),a.set(c,{id:c,title:o.title||"Без названия",assignedTo:l||null,createdAt:Ze(o.createdAt||o.createdTime),updatedAt:Ze(o.updatedAt||o.modifiedAt||o.updatedTime),stageId:o.stageId||r.id||null,departmentHead:o.departmentHead||null,departmentHeadFull:o.departmentHeadFull||o.departmentHead||null,priorityId:o.priorityId||null,priorityLabel:o.priorityLabel||null,service:o.service||null,serviceLabel:o.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(r=>{Array.isArray(r)&&r.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const o=parseInt(s.id);if(isNaN(o)){console.warn("Invalid ticket ID in zero point:",s.id);return}e.add(o);let c=s.assignedTo;if(!c&&s.assignedById){const l=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;l&&l!==Ge?c={id:l,name:"Неизвестный"}:l===Ge&&(c={id:Ge,name:"Хранитель объектов"})}a.set(o,{id:o,title:s.title||"Без названия",assignedTo:c||null,createdAt:Ze(s.createdAt||s.createdTime),updatedAt:Ze(s.updatedAt||s.modifiedAt||s.updatedTime),stageId:s.stageId||null,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null,priorityId:s.priorityId||null,priorityLabel:s.priorityLabel||null,service:s.service||null,serviceLabel:s.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((r,s)=>r-s),tickets:Array.from(a.values())}}function Ze(i){if(!i)return null;if(i instanceof Date)return i.toISOString();if(typeof i=="string"){if(i.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return i;const t=new Date(i);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",i),null}class ct{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,useBackendCache:a=!1,onProgress:r=null,normalize:s=!0,includeTicketDetails:o=!1}=t;try{const c=await _t.getSectorData(e,a,r);return s?Zt(c):(o&&console.warn("includeTicketDetails пока не реализовано"),c)}catch(c){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",c),c}}static async isDataAvailable(){try{const t=await _t.getSectorData(!0);return t!=null}catch{return!1}}}class rt{static compareTwoSnapshots(t,e,a={}){const{includeTickets:r=!1,includeEmployees:s=!0}=a,o=this.validateSnapshot(t),c=this.validateSnapshot(e);if(!o.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...o.errors,...c.errors].join(", "));const l=this.buildComparisonMetadata(t,e),n=this.compareStages(t.statistics.stages,e.statistics.stages),y=s?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],h=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=r?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,E=this.buildSummary(n,y,h,d);return{metadata:l,stages:n,employees:y,zeroPoint:h,tickets:d,summary:E}}static calculateDelta(t,e){const a=this.normalizeValue(t),r=this.normalizeValue(e),s=r-a;let o=0;a!==0?o=s/a*100:r!==0&&(o=r>0?1/0:-1/0);const c=this.getTrend(s);return{value1:a,value2:r,delta:s,deltaPercent:Math.round(o*100)/100,trend:c}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var c,l;const a=["formed","review","execution"],r={};for(const n of a){const y=((c=t[n])==null?void 0:c.count)||0,h=((l=e[n])==null?void 0:l.count)||0;r[n]=this.calculateDelta(y,h)}const s=t.total||0,o=e.total||0;return r.total=this.calculateDelta(s,o),r}static compareEmployees(t,e){var c,l;const a=new Map(t.map(n=>[n.id,n])),r=new Map(e.map(n=>[n.id,n])),s=new Set([...a.keys(),...r.keys()]),o=[];for(const n of s){const y=a.get(n)||null,h=r.get(n)||null;if(!y||!h){o.push({id:n,name:(y==null?void 0:y.name)||(h==null?void 0:h.name)||"Неизвестный",snapshot1:y?{ticketsByStage:y.ticketsByStage||{},totalTickets:y.totalTickets||0}:null,snapshot2:h?{ticketsByStage:h.ticketsByStage||{},totalTickets:h.totalTickets||0}:null,delta:this.calculateEmployeeDelta(y,h),trend:y?"removed":"new"});continue}const d={},E=["formed","review","execution"];for(const _ of E){const D=((c=y.ticketsByStage)==null?void 0:c[_])||0,w=((l=h.ticketsByStage)==null?void 0:l[_])||0;d[_]=this.calculateDelta(D,w)}const b=this.calculateDelta(y.totalTickets||0,h.totalTickets||0);o.push({id:n,name:y.name,snapshot1:{ticketsByStage:y.ticketsByStage||{},totalTickets:y.totalTickets||0},snapshot2:{ticketsByStage:h.ticketsByStage||{},totalTickets:h.totalTickets||0},delta:{ticketsByStage:d,totalTickets:b},trend:b.trend})}return o}static calculateEmployeeDelta(t,e){var o,c;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},r=["formed","review","execution"];for(const l of r){const n=((o=t==null?void 0:t.ticketsByStage)==null?void 0:o[l])||0,y=((c=e==null?void 0:e.ticketsByStage)==null?void 0:c[l])||0;a[l]=this.calculateDelta(n,y)}const s=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,r){var E,b;const s=new Set(t),o=new Set(e),c=e.filter(_=>!s.has(_)),l=t.filter(_=>!o.has(_)),n=[],y=[],h=new Map(a.map(_=>[_.id,_])),d=new Map(r.map(_=>[_.id,_]));for(const _ of t){if(!o.has(_))continue;const D=h.get(_),w=d.get(_);if(!D||!w)continue;const M=(((E=D.assignedTo)==null?void 0:E.id)||null)!==(((b=w.assignedTo)==null?void 0:b.id)||null),R=(D.stageId||null)!==(w.stageId||null);M||R?n.push(_):y.push(_)}return{new:c,removed:l,changed:n,unchanged:y}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),r=new Date(e.metadata.createdAt),s=new Date,o=r.getTime()-a.getTime(),c=Math.floor(o/(1e3*60*60*24)),l=Math.floor(o%(1e3*60*60*24)/(1e3*60*60)),n=Math.floor(o%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:c,hours:l,minutes:n,totalMinutes:Math.floor(o/(1e3*60))}}}static buildSummary(t,e,a,r){var n,y,h;const s=t.total.delta,o=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,c=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,l=s!==0||o>0||c>0;return{totalDelta:s,stagesChanged:o,employeesChanged:c,hasChanges:l,newTicketsCount:((n=r==null?void 0:r.new)==null?void 0:n.length)||0,removedTicketsCount:((y=r==null?void 0:r.removed)==null?void 0:y.length)||0,changedTicketsCount:((h=r==null?void 0:r.changed)==null?void 0:h.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const s of r)t.statistics.stages[s]||a.push(`Missing stage: ${s}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const o of t){const c=this.validateSnapshot(o);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...t].sort((o,c)=>{const l=new Date(o.metadata.createdAt),n=new Date(c.metadata.createdAt);return l-n}),r=[];for(let o=0;o<a.length-1;o++)r.push({from:o,to:o+1,result:this.compareTwoSnapshots(a[o],a[o+1],e)});const s=this.buildTrends(a);return{snapshots:a.map((o,c)=>({index:c,date:o.metadata.createdAt,type:o.metadata.type,data:o})),comparisons:r,trends:s}}static buildTrends(t){var a,r,s,o,c,l,n,y,h,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const E of t){const b=E.statistics;e.stages.formed.push(((r=(a=b.stages)==null?void 0:a.formed)==null?void 0:r.count)||0),e.stages.review.push(((o=(s=b.stages)==null?void 0:s.review)==null?void 0:o.count)||0),e.stages.execution.push(((l=(c=b.stages)==null?void 0:c.execution)==null?void 0:l.count)||0),e.stages.total.push(((n=b.stages)==null?void 0:n.total)||0),e.zeroPoint.unassigned.push(((y=b.zeroPoint)==null?void 0:y.unassigned)||0),e.zeroPoint.keeper.push(((h=b.zeroPoint)==null?void 0:h.keeper)||0),e.zeroPoint.total.push(((d=b.zeroPoint)==null?void 0:d.total)||0)}return e}}const na={class:"stages-container"},oa={class:"stages-chips"},ra=["checked","disabled","onChange"],la={class:"stage-chip-label"},ia={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:i=>i.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(i,{emit:t}){const e=i,a=t;function r(s,o){const c={...e.selected};c[s]=o,a("update:selected",c),a("change",s,o)}return(s,o)=>(T(),I("div",na,[o[0]||(o[0]=u("h4",{class:"stages-title"},"Этапы для отображения:",-1)),u("div",oa,[(T(!0),I(pe,null,ge(i.stages,c=>(T(),I("label",{key:c.id,class:ce(["stage-chip",{"stage-chip--active":i.selected[c.id],"stage-chip--disabled":i.disabled}])},[u("input",{type:"checkbox",checked:i.selected[c.id],disabled:i.disabled,onChange:l=>r(c.id,l.target.checked)},null,40,ra),u("span",{class:"stage-chip-color",style:ve({backgroundColor:c.color})},null,4),u("span",la,H(c.name),1)],2))),128))])]))}},ca=Ye(ia,[["__scopeId","data-v-fe03c03c"]]),We=10;function Qe(i,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(r=>r.ticketsByStage&&r.ticketsByStage[i]>0).forEach(r=>{e.push({id:r.id,name:r.name,count:r.ticketsByStage[i]||0})});const a=ua(i,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((r,s)=>s.count-r.count)}function ua(i,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[i])return t.statistics.zeroPointByStage[i].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Bt(i,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[i])==null?void 0:e.count)||0}function et(i,t=We){if(!i||i.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...i].sort((o,c)=>c.count-o.count),a=e.slice(0,t),r=e.slice(t),s=r.reduce((o,c)=>o+c.count,0);return{visible:a,others:{employees:r,count:s,employeeCount:r.length}}}function Lt(i,t){return!i||i.length===0?[]:t===0?i.map(e=>({...e,percentage:0})):i.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Je(i,t,e="#007bff",a=We){if(!i||i.length===0)return{employees:[],others:null};const{visible:r,others:s}=et(i,a),o=Lt(r,t).map(l=>({...l,progressBarWidth:l.percentage,progressBarColor:l.isKeeper?"#f59e0b":e}));let c=null;if(s.count>0){const l=parseFloat((s.count/t*100).toFixed(1));c={...s,percentage:l,progressBarWidth:l,progressBarColor:"#6c757d"}}return{employees:o,others:c}}function da(i,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(r=>{const s=t[r];if(!s)return;const o=Qe(i,s),c=Bt(i,s);if(o.length===0)return;const{visible:l,others:n}=et(o,We),y=Lt(l,c);e[r]=y,n.count>0&&(e.others[r]={count:n.count,employeeCount:n.employeeCount,percentage:parseFloat((n.count/c*100).toFixed(1))})}),e}function pa(i,t="current",e=[]){const a=i[t];if(!a)return{labels:[],datasets:[]};const r=new Map;e.forEach(h=>{Qe(h.id,a).forEach(E=>{r.has(E.id)||r.set(E.id,{id:E.id,name:E.name,isKeeper:E.isKeeper||!1,ticketsByStage:{}}),r.get(E.id).ticketsByStage[h.id]=E.count})});const s=Array.from(r.values()).map(h=>{const d=Object.values(h.ticketsByStage).reduce((E,b)=>E+b,0);return{...h,totalTickets:d}});s.sort((h,d)=>d.totalTickets-h.totalTickets);const{visible:o,others:c}=et(s,We),l=e.map(()=>""),n={};e.forEach(h=>{const d=Qe(h.id,a),{visible:E}=et(d,We);n[h.id]=E.map(b=>({id:b.id,name:b.name,count:b.count}))});const y=o.map((h,d)=>{const E=e.map(_=>h.ticketsByStage[_.id]||0),b=e.map(_=>{if((h.ticketsByStage[_.id]||0)===0)return"transparent";const M=_.color.replace("#",""),R=parseInt(M.substring(0,2),16),Y=parseInt(M.substring(2,4),16),ee=parseInt(M.substring(4,6),16),Z=.6+d*.05;return`rgba(${R}, ${Y}, ${ee}, ${Math.min(Z,.95)})`});return{label:h.name,data:E,backgroundColor:b,borderColor:e.map(_=>{const D=_.color.replace("#",""),w=parseInt(D.substring(0,2),16),M=parseInt(D.substring(2,4),16),R=parseInt(D.substring(4,6),16);return`rgba(${w}, ${M}, ${R}, 0.8)`}),borderWidth:1,meta:{employeeId:h.id,employeeName:h.name}}});if(c.count>0){const h=e.map(d=>c.employees.reduce((E,b)=>E+(b.ticketsByStage[d.id]||0),0));y.push({label:`Другие (${c.employeeCount})`,data:h,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:l,datasets:y,meta:{employeesByStage:n}}}function ga(i,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(n=>n.id===i),r=a?a.name:"",s=a?a.color:"#007bff",o=Qe(i,t),c=Bt(i,t);if(o.length===0)return{stageName:r,totalCount:0,employees:[],others:null};const l=Je(o,c,s,We);return{stageName:r,totalCount:c,employees:l.employees,others:l.others}}function ma(i,t){return(t==null?void 0:t[i])||i}function fa(i,t){return(t==null?void 0:t[i])||"#007bff"}function ut({snapshots:i,graphType:t,timePoint:e,snapshotType:a}){return i?t==="line"&&e?i[e]||null:t==="bar"&&a?i[a]||null:i.current||i.weekEnd||i.weekStart||null:null}function dt(i,t){var e,a,r;return((r=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[i])==null?void 0:r.count)||0}function ha({stageId:i,timePoint:t,meta:e,snapshots:a,stageColor:r,maxVisible:s}){if(!(e!=null&&e.employees)||!t)return null;const o=e.employees[t];if(!o||o.length===0)return null;const c=(a==null?void 0:a[t])||null,l=dt(i,c)||o.reduce((y,h)=>y+(h.count||0),0),n=Je(o,l,r,s);return{stageId:i,totalCount:l,employees:n.employees,others:n.others,snapshot:c}}function va({stageId:i,meta:t,snapshots:e,stageColor:a,maxVisible:r}){var n;const s=(n=t==null?void 0:t.employees)==null?void 0:n[i];if(!s||!s.employees||s.employees.length===0)return null;const o=ut({snapshots:e,graphType:"doughnut"}),c=s.totalCount??dt(i,o)??s.employees.reduce((y,h)=>y+(h.count||0),0),l=Je(s.employees,c,a,r);return{stageId:i,totalCount:c,employees:l.employees,others:l.others,snapshot:o}}function ya({stageId:i,meta:t,snapshots:e,stageColor:a,maxVisible:r,snapshotType:s}){var y;const o=(y=t==null?void 0:t.employeesByStage)==null?void 0:y[i];if(!o||o.length===0)return null;const c=ut({snapshots:e,graphType:"bar",snapshotType:s}),l=dt(i,c)||o.reduce((h,d)=>h+(d.count||0),0),n=Je(o,l,a,r);return{stageId:i,totalCount:l,employees:n.employees,others:n.others,snapshot:c}}async function Pt({stageId:i,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:r=null,meta:s=null,stageColorMap:o=null,stageNameMap:c=null,maxVisible:l=10,restLoader:n=null}){if(!i)throw new Error("stageId обязателен для загрузки данных уровня 1");const y=ma(i,c),h=fa(i,o);let d=null;if(t==="line"?d=ha({stageId:i,timePoint:e,meta:s==null?void 0:s.line,snapshots:r,stageColor:h,maxVisible:l}):t==="doughnut"?d=va({stageId:i,meta:s==null?void 0:s.doughnut,snapshots:r,stageColor:h,maxVisible:l}):t==="bar"&&(d=ya({stageId:i,meta:s==null?void 0:s.bar,snapshots:r,stageColor:h,maxVisible:l,snapshotType:a})),d)return{stageId:i,stageName:y,color:h,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot};if(typeof n=="function"){const E=await n({stageId:i,graphType:t,timePoint:e,snapshotType:a,snapshots:r});if(E&&Array.isArray(E.employees)){const b=E.totalCount??E.employees.reduce((D,w)=>D+(w.count||0),0),_=Je(E.employees,b,h,l);return{stageId:i,stageName:y,color:h,totalCount:b,employees:_.employees,others:_.others,snapshot:E.snapshot||ut({snapshots:r,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const ka={key:"level-1",class:"level-1"},ba={class:"modal-header"},wa={class:"stage-header"},Sa=["aria-expanded","onKeydown"],Da={class:"stage-title"},Ca=["aria-selected","onClick","onKeydown"],Ea={class:"stage-name"},_a={class:"modal-total"},Ta={class:"view-switcher"},$a={class:"modal-body"},Ia={key:0,class:"load-error"},Aa={key:1,class:"stage-loader"},Ma={key:2},xa={key:0,class:"no-employees"},Na={key:1,class:"employees-list"},Fa=["onClick"],Ba={class:"employee-name"},La={class:"employee-progress"},Pa={class:"employee-count"},Ra={key:0,class:"employee-item employee-others"},Ha={class:"employee-name"},Oa={class:"employee-progress"},Wa={class:"employee-count"},ja={key:3,class:"view-time"},Ua={key:0,class:"no-data"},za={key:1,class:"date-categories-list"},Va=["onClick"],Ka={class:"category-label"},Ga={class:"category-progress"},Xa={class:"category-count"},Ya={key:4,class:"view-departments"},qa={key:0,class:"no-data"},Ja={key:1,class:"departments-table-container"},Za={class:"departments-table"},Qa=["onClick"],es={class:"col-department"},ts={class:"department-name"},as={class:"col-count"},ss={class:"count-value"},ns={key:"level-2",class:"level-2"},os={class:"modal-header"},rs={class:"modal-total"},ls={class:"modal-body"},is={class:"stage-info level2-stage-row"},cs={class:"stage-badge"},us={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},ds={key:0},ps={key:0,class:"no-data"},gs={key:1,class:"date-categories-list"},ms=["onClick"],fs={class:"category-label"},hs={class:"category-progress"},vs={class:"category-count"},ys={key:1,class:"view-departments"},ks={key:0,class:"no-data"},bs={key:1,class:"departments-table-container"},ws={class:"departments-table"},Ss=["onClick"],Ds={class:"col-department"},Cs={class:"department-name"},Es={class:"col-count"},_s={class:"count-value"},Ts={key:"level-3",class:"level-3"},$s={class:"modal-header"},Is={class:"header-info"},As={class:"header-badges"},Ms={class:"date-badge"},xs={class:"stage-badge"},Ns={class:"modal-total"},Fs={class:"modal-body"},Bs={key:0,class:"no-data"},Ls={key:1,class:"departments-table-container"},Ps={class:"departments-table"},Rs=["onClick"],Hs={class:"col-department"},Os={class:"department-name"},Ws={class:"col-count"},js={class:"count-value"},Us={key:"level-4",class:"level-4"},zs={class:"modal-header"},Vs={class:"header-info"},Ks={key:0,class:"header-badges"},Gs={key:0,class:"date-badge"},Xs={key:1,class:"department-badge"},Ys={class:"stage-badge"},qs={class:"modal-total"},Js={class:"modal-body"},Zs={key:"loading",class:"loading-state"},Qs={key:"error-fallback",class:"error-state-with-fallback"},en={class:"tickets-list-container"},tn={key:"error",class:"error-state"},an={class:"error-message"},sn={key:"empty",class:"empty-state"},nn={class:"empty-state-title"},on={class:"empty-state-message"},rn={key:"tickets",class:"tickets-list-container"},ln={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(i,{expose:t,emit:e}){const a=i,r=e,s=qe(),o=B(1),c=B("time"),l=B("employees"),n=B(null),y=B([]),h=B([]),d=B(null),E=B(null),b=B(null),_=B(a.stageSwitchContext||null),D=B(!1),w=B(null),M=B(null),R=B(!1),Y=B(null),ee=B(null),Z=ae(()=>{var f,A;const p=((f=_.value)==null?void 0:f.stageNameMap)||{},m=((A=_.value)==null?void 0:A.stageColorMap)||{};return Object.keys(p).map(W=>{var j;return{id:W,name:p[W],color:m[W]||"#007bff",disabled:W===(((j=n.value)==null?void 0:j.stageId)||a.stageId)}})});ae(()=>o.value>1);const re=ae(()=>{var p,m,f,A,W;switch(o.value){case 1:return((p=n.value)==null?void 0:p.stageName)||a.stageName;case 2:return((m=d.value)==null?void 0:m.employeeName)||"";case 3:return`${((f=d.value)==null?void 0:f.employeeName)||""} — ${((A=E.value)==null?void 0:A.dateCategoryLabel)||""}`;case 4:if(!((W=b.value)!=null&&W.context))return"Список тикетов";const j=b.value.context,X=[];return j.employeeName&&X.push(j.employeeName),j.dateCategoryLabel&&X.push(j.dateCategoryLabel),j.departmentName&&X.push(j.departmentName),j.stageName&&X.push(j.stageName),X.length>0?X.join(" — "):"Список тикетов";default:return""}});function se(){var p,m,f;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((p=a.employees)==null?void 0:p.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((f=(m=a.snapshot)==null?void 0:m.ticketIds)==null?void 0:f.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),n.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:n.value.stageId,hasSnapshot:!!n.value.snapshot,employeesCount:n.value.employees.length,snapshotType:n.value.snapshot?typeof n.value.snapshot:"null"}),d.value=null,E.value=null,b.value=null,o.value=1,c.value="time",l.value="employees",Q(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function Q(){if(!n.value||!n.value.snapshot||!n.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const p=n.value.snapshot.tickets||[],m=n.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:p.length,currentStageId:m,sampleTicket:p[0]?{id:p[0].id,stageId:p[0].stageId,hasDepartmentHead:!!p[0].departmentHead,departmentHead:p[0].departmentHead,hasDepartmentHeadFull:!!p[0].departmentHeadFull,departmentHeadFull:p[0].departmentHeadFull,allKeys:Object.keys(p[0])}:null});let f=p.filter(N=>N.stageId?ot(N.stageId)===m:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:p.length,afterFilter:f.length,stageId:m,ticketsWithStageId:f.filter(N=>N.stageId).length,ticketsWithoutStageId:f.filter(N=>!N.stageId).length});const A=f.filter(N=>!N.departmentHead&&!N.departmentHeadFull);if(A.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:A.length,totalTickets:f.length,ticketsWithDepartment:f.filter(v=>v.departmentHead||v.departmentHeadFull).length});const N=A.map(v=>v.id).filter(v=>v);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:N.length,ticketIdsSample:N.slice(0,10)});const v=await qt.getTicketsDetails(N),g=new Map;v.forEach(k=>{k&&k.id&&g.set(k.id,k)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:v.length,detailsMapSize:g.size,sampleDetail:v[0]?{id:v[0].id,departmentHead:v[0].departmentHead,departmentHeadFull:v[0].departmentHeadFull}:null}),f=f.map(k=>{const x=g.get(k.id);return x?{...k,stageId:x.stageId||k.stageId||null,departmentHead:x.departmentHead||k.departmentHead||null,departmentHeadFull:x.departmentHeadFull||x.departmentHead||k.departmentHead||null}:k}),f=f.filter(k=>k.stageId?ot(k.stageId)===m:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:f.length,ticketsWithDepartment:f.filter(k=>k.departmentHead||k.departmentHeadFull).length,ticketsWithoutDepartment:f.filter(k=>!k.departmentHead&&!k.departmentHeadFull).length,ticketsWithStageId:f.filter(k=>k.stageId).length,ticketsWithoutStageId:f.filter(k=>!k.stageId).length});const S=f.length,$=f.slice(0,3).map(k=>({id:k.id,departmentHead:k.departmentHead,departmentHeadFull:k.departmentHeadFull,stageId:k.stageId}));f=f.filter(k=>k.stageId?ot(k.stageId)===m:!0);const F=f.slice(0,3).map(k=>({id:k.id,departmentHead:k.departmentHead,departmentHeadFull:k.departmentHeadFull,stageId:k.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:S,afterStageFilter:f.length,filteredOut:S-f.length,currentStageId:m,ticketsWithDepartment:f.filter(k=>k.departmentHead||k.departmentHeadFull).length,ticketsWithoutDepartment:f.filter(k=>!k.departmentHead&&!k.departmentHeadFull).length,sampleBeforeFilter:$,sampleAfterFilter:F,sampleWithDepartment:f.find(k=>k.departmentHead||k.departmentHeadFull)?{id:f.find(k=>k.departmentHead||k.departmentHeadFull).id,departmentHead:f.find(k=>k.departmentHead||k.departmentHeadFull).departmentHead,departmentHeadFull:f.find(k=>k.departmentHead||k.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(f.find(k=>k.departmentHead||k.departmentHeadFull)).filter(k=>k.toLowerCase().includes("department"))}:null})}catch(v){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",v),console.error("[EmployeeDetailsModal] Error details:",{message:v.message,stack:v.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:f.length,currentStageId:m,ticketsWithStageId:f.filter(N=>N.stageId).length,ticketsWithoutStageId:f.filter(N=>!N.stageId).length,ticketsWithDepartment:f.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:f.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length});const W=$t(f);y.value=W,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:f.length,sampleTickets:f.slice(0,5).map(N=>({id:N.id,departmentHead:N.departmentHead,departmentHeadFull:N.departmentHeadFull,hasDepartmentHead:!!N.departmentHead,hasDepartmentHeadFull:!!N.departmentHeadFull,allKeys:Object.keys(N).filter(v=>v.toLowerCase().includes("department"))})),ticketsWithDepartment:f.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:f.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length});const j=It(f);h.value=j;const X=W.reduce((N,v)=>N+v.count,0),ne=j.reduce((N,v)=>N+v.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:m,totalTicketsForGrouping:f.length,timeCategoriesCount:W.length,totalTicketsInTimeCategories:X,departmentsCount:j.length,totalTicketsInDepartments:ne,departmentsSample:j.slice(0,5),ticketsWithDepartment:f.filter(N=>N.departmentHead||N.departmentHeadFull).length,ticketsWithoutDepartment:f.filter(N=>!N.departmentHead&&!N.departmentHeadFull).length,consistencyCheck:{totalTickets:f.length,timeCategoriesTotal:X,departmentsTotal:ne,isConsistent:f.length===X&&f.length===ne}})}catch(p){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",p),console.error("[EmployeeDetailsModal] Error stack:",p.stack)}}async function ue(p){var f;if(!p){s.error("Не указан stageId для загрузки данных");return}if(((f=n.value)==null?void 0:f.stageId)===p)return;if(!_.value){s.error("Нет контекста для смены стадии (stageSwitchContext)");return}D.value=!0,w.value=null;const m=n.value?{...n.value}:null;M.value=(m==null?void 0:m.stageId)||null;try{const A=await Pt({..._.value,stageId:p});n.value={stageId:A.stageId,stageName:A.stageName,stageColor:A.color,totalCount:A.totalCount,employees:A.employees,others:A.others,snapshot:A.snapshot||(m==null?void 0:m.snapshot)||null,ticketDetails:A.ticketDetails||null},d.value=null,E.value=null,b.value=null,o.value=1,c.value="time",l.value="employees",await Q()}catch(A){console.error("[EmployeeDetailsModal] Failed to reload stage data:",A),w.value=(A==null?void 0:A.message)||"Не удалось загрузить данные стадии",m&&(n.value=m),s.error(w.value)}finally{D.value=!1}}async function fe(p){if(!p||p.count===0){s.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!E.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),s.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:m}=await Ae(async()=>{const{createContextFromLevel3:A}=await import("./ticketListUtils-XuGHwEFL.js").then(W=>W.t);return{createContextFromLevel3:A}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),f=await m(E.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:f.employeeName,dateCategory:f.dateCategoryLabel,departmentName:f.departmentName,ticketsCount:f.tickets.length}),await de(f)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function _e(p){if(!p||p.count===0){s.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!n.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),s.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:m}=await Ae(async()=>{const{createContextFromLevel1Department:A}=await import("./ticketListUtils-XuGHwEFL.js").then(W=>W.t);return{createContextFromLevel1Department:A}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),f=m(n.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:f.stageName,departmentName:f.departmentName,ticketsCount:f.tickets.length}),await de(f)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function ye(p){if(!p||p.count===0){s.info(`В категории "${(p==null?void 0:p.label)||"неизвестная"}" нет тикетов`);return}if(!p.tickets||p.tickets.length===0){s.info(`В категории "${p.label}" нет тикетов`);return}if(!n.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),s.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:m}=await Ae(async()=>{const{createContextFromLevel1Time:A}=await import("./ticketListUtils-XuGHwEFL.js").then(W=>W.t);return{createContextFromLevel1Time:A}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),f=m(n.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:f.stageName,dateCategory:f.dateCategoryLabel,ticketsCount:f.tickets.length}),await de(f)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}Ke(()=>a.isVisible,p=>{p?se():(Be(),le())}),Ke(()=>a.stageSwitchContext,p=>{_.value=p},{deep:!0}),Xe(()=>{a.isVisible&&se()});async function Ne(p,m=null){var f,A,W;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",p),console.log("[EmployeeDetailsModal] Current popup level:",o.value),m&&m.currentTarget&&(m.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{m.currentTarget&&(m.currentTarget.style.transform="")},150)),!p||!p.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",p);return}if(n.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),n.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:n.value.stageId,stageName:n.value.stageName,hasSnapshot:!!n.value.snapshot,snapshotType:n.value.snapshot?typeof n.value.snapshot:"null",snapshotKeys:n.value.snapshot?Object.keys(n.value.snapshot):[]}),!n.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),s.warning("ID стадии не указан");return}if(!n.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),s.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",p.id,"stage:",n.value.stageId);const j=await Xt(p.id,n.value.stageId,n.value.snapshot,n.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(j==null?void 0:j.length)||0,j),!j||j.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),s.info(`У сотрудника "${p.name}" нет тикетов на стадии "${n.value.stageName}"`);return}const X=$t(j);console.log("[EmployeeDetailsModal] Date categories:",(X==null?void 0:X.length)||0,X);const ne=It(j).map(N=>({...N,tickets:Yt(j,N.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",(ne==null?void 0:ne.length)||0,ne),d.value={employeeId:p.id,employeeName:p.name,stageId:n.value.stageId,stageName:n.value.stageName,totalCount:j.length,dateCategories:X,departments:ne,tickets:j,snapshot:n.value.snapshot,ticketDetails:n.value.ticketDetails},c.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:d.value.employeeName,totalCount:d.value.totalCount,dateCategoriesCount:d.value.dateCategories.length,departmentsCount:d.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",d.value),o.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",o.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",d.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!d.value,employeeName:(f=d.value)==null?void 0:f.employeeName,dateCategoriesCount:((W=(A=d.value)==null?void 0:A.dateCategories)==null?void 0:W.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",o.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",d.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(j){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",j),console.error("[EmployeeDetailsModal] Error stack:",j.stack),s.error("Ошибка загрузки данных о тикетах: "+j.message)}}async function je(p){if(!p||p.count===0){s.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!d.value){s.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:m}=await Ae(async()=>{const{createContextFromLevel2Department:A}=await import("./ticketListUtils-XuGHwEFL.js").then(W=>W.t);return{createContextFromLevel2Department:A}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),f=m(d.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:f.employeeName,departmentName:f.departmentName,ticketsCount:f.tickets.length}),await de(f)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function Fe(p){if(!p||p.count===0){s.info(`В категории "${(p==null?void 0:p.label)||"неизвестная"}" нет тикетов`);return}if(!p.tickets||p.tickets.length===0){s.info(`В категории "${p.label}" нет тикетов`);return}if(!d.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),s.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:m}=await Ae(async()=>{const{createContextFromLevel2:A}=await import("./ticketListUtils-XuGHwEFL.js").then(W=>W.t);return{createContextFromLevel2:A}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),f=m(d.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:f.employeeName,dateCategory:f.dateCategoryLabel,ticketsCount:f.tickets.length}),await de(f)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function de(p){var m;if(console.time("[Performance] goToLevel4"),!p){console.error("[EmployeeDetailsModal] Context is required for level 4"),s.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:p.sourceLevel,employeeId:p.employeeId,stageId:p.stageId,dateCategory:p.dateCategory,departmentName:p.departmentName,ticketsCount:((m=p.tickets)==null?void 0:m.length)||0});try{b.value={context:p,tickets:[],totalCount:0,isLoading:!0,error:null};let f=p.tickets||[];if(f.length===0&&p.snapshot){const{filterTicketsByContext:W}=await Ae(async()=>{const{filterTicketsByContext:j}=await import("./ticketListUtils-XuGHwEFL.js").then(X=>X.t);return{filterTicketsByContext:j}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);f=await W(p)}(!f||f.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),f=p.tickets||[]),(!f||f.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),p.snapshot&&p.snapshot.tickets&&(f=p.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",f.length)));let A=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:W}=await Ae(async()=>{const{prepareTicketsForDisplay:j}=await import("./ticketListUtils-XuGHwEFL.js").then(X=>X.t);return{prepareTicketsForDisplay:j}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);A=await W(f,p.snapshot,p.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(W){console.error("[EmployeeDetailsModal] Error preparing tickets:",W),console.timeEnd("[Performance] prepareTicketsForDisplay"),A=f||[],s.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:f.length,preparedCount:A.length}),b.value={context:p,tickets:A,totalCount:A.length,isLoading:!1,error:null},o.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:b.value.totalCount,ticketsCount:b.value.tickets.length,isLoading:b.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(f){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",f),console.error("[EmployeeDetailsModal] Error details:",{message:f.message,stack:f.stack,context:p});let A=[];if(p.snapshot&&p.snapshot.tickets)try{const W=p.stageId;W?A=(p.snapshot.tickets||[]).filter(j=>j.stageId===W):A=p.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",A.length)}catch(W){console.error("[EmployeeDetailsModal] Error using fallback tickets:",W)}b.value={context:p,tickets:A,totalCount:A.length,isLoading:!1,error:{message:f.message,hasFallback:A.length>0}},A.length>0?(s.warning("Ошибка загрузки данных. Отображаются данные из кеша."),o.value=4):(s.error("Ошибка загрузки тикетов: "+f.message),ke()),console.timeEnd("[Performance] goToLevel4")}}function ke(){if(o.value===4){if(b.value&&b.value.context){const p=b.value.context.sourceLevel;o.value=p}else o.value=1;b.value=null}else o.value===3?(o.value=2,E.value=null,b.value=null):o.value===2&&(o.value=1,d.value=null,E.value=null,b.value=null)}function Be(){o.value=1,n.value=null,d.value=null,E.value=null,b.value=null,c.value="time"}function be(){var W;if(!((W=b.value)!=null&&W.context))return"Нет тикетов";const{sourceLevel:p,employeeName:m,dateCategoryLabel:f,departmentName:A}=b.value.context;return p===2&&m&&f?`Нет тикетов у ${m} в категории "${f}"`:p===2&&m&&A?`Нет тикетов у ${m} у заказчика "${A}"`:p===3&&m&&A?`Нет тикетов у ${m} у заказчика "${A}"`:p===1&&f?`Нет тикетов в категории "${f}"`:p===1&&A?`Нет тикетов у заказчика "${A}"`:"Нет тикетов для отображения"}function Le(){var m;if(!((m=b.value)!=null&&m.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:p}=b.value.context;return p?`На стадии "${p}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function Pe(){var m;if(!((m=b.value)!=null&&m.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const p=b.value.context;await de(p)}function Te(p){if(!p){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),s.warning("Ошибка: тикет не найден");return}if(!p.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",p),s.error("Ошибка: ID тикета не указан");return}try{const m=Gt(p.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:p.id,iframeUrl:m}),!m||typeof m!="string"||m.length===0)throw new Error("Не удалось сформировать URL для тикета");const f=window.open(m,"_blank","noopener,noreferrer");if(!f||f.closed||typeof f.closed>"u")try{const A=document.createElement("a");A.href=m,A.target="_blank",A.rel="noopener noreferrer",A.style.display="none",document.body.appendChild(A),A.click(),document.body.removeChild(A),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:p.id,iframeUrl:m})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:p.id,iframeUrl:m})}catch(m){console.error("[EmployeeDetailsModal] Error opening ticket:",m),console.error("[EmployeeDetailsModal] Error details:",{message:m.message,stack:m.stack,ticket:p}),s.error("Ошибка открытия тикета: "+m.message)}}function L(){Be(),r("close")}t({reloadLevel1ForStage:ue});function z(p){p&&p.stopPropagation(),R.value=!R.value}function le(){R.value&&(R.value=!1)}function Re(p){if(!R.value)return;const m=Y.value,f=ee.value;m&&m.contains(p.target)||f&&f.contains(p.target)||(R.value=!1)}async function ie(p){if(p.disabled){R.value=!1;return}R.value=!1,await ue(p.id)}function He(p){if(R.value){p.stopPropagation(),le();return}L()}return(p,m)=>(T(),Ee(Mt,{to:"body"},[i.isVisible?(T(),I("div",{key:0,class:"employee-details-modal",onClick:oe(L,["self"]),onKeydown:ze(He,["esc"])},[u("div",{class:"modal-content",onClick:Re},[me(it,{name:"level",mode:"out-in"},{default:xe(()=>{var f,A,W,j,X,ne,N,v,g,S,$,F,k,x,V,O,K,G,P;return[o.value===1?(T(),I("div",ka,[u("div",ba,[u("div",wa,[u("button",{ref_key:"stageTriggerRef",ref:ee,class:"stage-trigger","aria-expanded":R.value,"aria-haspopup":"listbox",onClick:oe(z,["stop"]),onKeydown:[ze(oe(z,["prevent"]),["enter"]),ze(oe(z,["prevent"]),["space"]),ze(oe(le,["stop","prevent"]),["esc"])]},[u("span",{class:"stage-color",style:ve({backgroundColor:((f=n.value)==null?void 0:f.stageColor)||((j=(A=_.value)==null?void 0:A.stageColorMap)==null?void 0:j[(W=n.value)==null?void 0:W.stageId])||((ne=(X=_.value)==null?void 0:X.stageColorMap)==null?void 0:ne[i.stageId])||"#007bff"})},null,4),u("span",Da,H(((N=n.value)==null?void 0:N.stageName)||i.stageName),1),u("span",{class:ce(["stage-caret",{open:R.value}])},"▾",2)],40,Sa),R.value?(T(),I("div",{key:0,ref_key:"stageDropdownRef",ref:Y,class:"stage-dropdown",role:"listbox"},[(T(!0),I(pe,null,ge(Z.value,C=>(T(),I("div",{key:C.id,class:ce(["stage-option",{disabled:C.disabled}]),role:"option","aria-selected":C.disabled,onClick:oe(U=>ie(C),["stop"]),onKeydown:ze(oe(U=>ie(C),["prevent"]),["enter"])},[u("span",{class:"stage-color",style:ve({backgroundColor:C.color})},null,4),u("span",Ea,H(C.name),1)],42,Ca))),128))],512)):q("",!0)]),u("span",_a,"Всего: "+H(((v=n.value)==null?void 0:v.totalCount)||i.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:L,"aria-label":"Закрыть"},"×")]),u("div",Ta,[u("button",{class:ce(["view-switch-btn",{active:l.value==="employees"}]),onClick:m[0]||(m[0]=C=>l.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),u("button",{class:ce(["view-switch-btn",{active:l.value==="time"}]),onClick:m[1]||(m[1]=C=>l.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),u("button",{class:ce(["view-switch-btn",{active:l.value==="departments"}]),onClick:m[2]||(m[2]=C=>l.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),u("div",$a,[w.value?(T(),I("div",Ia,[u("span",null,"Ошибка: "+H(w.value),1),u("button",{class:"btn-retry-stage",onClick:m[3]||(m[3]=C=>{var U;return ue(((U=n.value)==null?void 0:U.stageId)||i.stageId)})}," Повторить ")])):q("",!0),D.value?(T(),I("div",Aa,[...m[7]||(m[7]=[u("div",{class:"loading-spinner small"},null,-1),u("span",null,"Загрузка стадии...",-1)])])):q("",!0),l.value==="employees"?(T(),I("div",Ma,[(((g=n.value)==null?void 0:g.employees)||i.employees).length===0&&(!((S=n.value)!=null&&S.others||i.others)||((($=n.value)==null?void 0:$.others)||i.others).count===0)?(T(),I("div",xa," Нет данных о сотрудниках ")):(T(),I("div",Na,[(T(!0),I(pe,null,ge(((F=n.value)==null?void 0:F.employees)||i.employees,C=>(T(),I("div",{key:C.id,class:ce(["employee-item",{"employee-keeper":C.isKeeper}]),onClick:oe(U=>Ne(C,U),["stop"]),title:"Кликните для детализации по временным градациям"},[u("span",Ba,H(C.name),1),u("div",La,[u("div",{class:"progress-bar",style:ve({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),u("span",Pa,H(C.count)+" тикетов ("+H(C.percentage)+"%) ",1),m[8]||(m[8]=u("span",{class:"employee-arrow"},"→",-1))],10,Fa))),128)),((k=n.value)!=null&&k.others||i.others)&&(((x=n.value)==null?void 0:x.others)||i.others).count>0?(T(),I("div",Ra,[u("span",Ha,"Другие ("+H((((V=n.value)==null?void 0:V.others)||i.others).employeeCount)+")",1),u("div",Oa,[u("div",{class:"progress-bar",style:ve({width:(((O=n.value)==null?void 0:O.others)||i.others).progressBarWidth+"%",backgroundColor:(((K=n.value)==null?void 0:K.others)||i.others).progressBarColor})},null,4)]),u("span",Wa,H((((G=n.value)==null?void 0:G.others)||i.others).count)+" тикетов ("+H((((P=n.value)==null?void 0:P.others)||i.others).percentage)+"%) ",1)])):q("",!0)]))])):l.value==="time"?(T(),I("div",ja,[y.value.length===0?(T(),I("div",Ua," Загрузка данных... ")):(T(),I("div",za,[(T(!0),I(pe,null,ge(y.value,C=>(T(),I("div",{key:C.category,class:"category-item",onClick:oe(U=>ye(C),["stop"])},[u("span",Ka,H(C.label),1),u("div",Ga,[u("div",{class:"progress-bar",style:ve({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),u("span",Xa,H(C.count)+" тикетов ("+H(C.percentage)+"%) ",1),m[9]||(m[9]=u("span",{class:"category-arrow"},"→",-1))],8,Va))),128))]))])):l.value==="departments"?(T(),I("div",Ya,[h.value.length===0?(T(),I("div",qa," Загрузка данных... ")):(T(),I("div",Ja,[u("table",Za,[m[11]||(m[11]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(T(!0),I(pe,null,ge(h.value,(C,U)=>(T(),I("tr",{key:U,class:"department-row",onClick:oe(J=>_e(C),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",es,[u("span",ts,H(C.departmentName),1)]),u("td",as,[u("span",ss,H(C.count),1)]),m[10]||(m[10]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,Qa))),128))])])]))])):q("",!0)])])):o.value===2&&d.value?(T(),I("div",ns,[u("div",os,[u("button",{class:"btn-back",onClick:ke,"aria-label":"Назад"}," ← "),u("h3",null,H(d.value.employeeName),1),u("span",rs,"Всего: "+H(d.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:L,"aria-label":"Закрыть"},"×")]),u("div",ls,[u("div",is,[u("span",cs,H(d.value.stageName),1),u("div",us,[u("button",{class:ce(["level2-sort-btn",{active:c.value==="time"}]),onClick:m[4]||(m[4]=C=>c.value="time"),title:"Сортировка по времени"}," По времени ",2),u("button",{class:ce(["level2-sort-btn",{active:c.value==="departments"}]),onClick:m[5]||(m[5]=C=>c.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),c.value==="time"?(T(),I("div",ds,[d.value.dateCategories.length===0?(T(),I("div",ps," Нет данных о тикетах ")):(T(),I("div",gs,[(T(!0),I(pe,null,ge(d.value.dateCategories,C=>(T(),I("div",{key:C.category,class:"category-item",onClick:oe(U=>Fe(C),["stop"])},[u("span",fs,H(C.label),1),u("div",hs,[u("div",{class:"progress-bar",style:ve({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),u("span",vs,H(C.count)+" тикетов ("+H(C.percentage)+"%) ",1)],8,ms))),128))]))])):(T(),I("div",ys,[!d.value.departments||d.value.departments.length===0?(T(),I("div",ks,[m[12]||(m[12]=lt(" Для выбранного сотрудника заказчики не найдены ",-1)),u("button",{class:"btn-retry-stage",onClick:m[6]||(m[6]=C=>Ne({id:d.value.employeeId,name:d.value.employeeName}))}," Обновить ")])):(T(),I("div",bs,[u("table",ws,[m[14]||(m[14]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(T(!0),I(pe,null,ge(d.value.departments,(C,U)=>(T(),I("tr",{key:U,class:"department-row",onClick:oe(J=>je(C),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",Ds,[u("span",Cs,H(C.departmentName),1)]),u("td",Es,[u("span",_s,H(C.count),1)]),m[13]||(m[13]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,Ss))),128))])])]))]))])])):o.value===3&&E.value?(T(),I("div",Ts,[u("div",$s,[u("button",{class:"btn-back",onClick:ke,"aria-label":"Назад"}," ← "),u("div",Is,[u("h3",null,H(E.value.employeeName),1),u("div",As,[u("span",Ms,H(E.value.dateCategoryLabel),1),u("span",xs,H(E.value.stageName),1)])]),u("span",Ns,"Всего: "+H(E.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:L,"aria-label":"Закрыть"},"×")]),u("div",Fs,[E.value.departments.length===0?(T(),I("div",Bs," Нет данных о заказчиках ")):(T(),I("div",Ls,[u("table",Ps,[m[16]||(m[16]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(T(!0),I(pe,null,ge(E.value.departments,(C,U)=>(T(),I("tr",{key:U,class:"department-row",onClick:oe(J=>fe(C),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",Hs,[u("span",Os,H(C.departmentName),1)]),u("td",Ws,[u("span",js,H(C.count),1)]),m[15]||(m[15]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,Rs))),128))])])]))])])):o.value===4&&b.value?(T(),I("div",Us,[u("div",zs,[u("button",{class:"btn-back",onClick:ke,"aria-label":"Назад"}," ← "),u("div",Vs,[u("h3",null,H(re.value),1),b.value.context?(T(),I("div",Ks,[b.value.context.dateCategoryLabel?(T(),I("span",Gs,H(b.value.context.dateCategoryLabel),1)):q("",!0),b.value.context.departmentName?(T(),I("span",Xs,H(b.value.context.departmentName),1)):q("",!0),u("span",Ys,H(b.value.context.stageName),1)])):q("",!0)]),u("span",qs,"Всего: "+H(b.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:L,"aria-label":"Закрыть"},"×")]),u("div",Js,[me(it,{name:"loading",mode:"out-in"},{default:xe(()=>[b.value.isLoading?(T(),I("div",Zs,[...m[17]||(m[17]=[u("div",{class:"loading-spinner"},null,-1),u("p",null,"Загрузка тикетов...",-1)])])):b.value.error&&b.value.error.hasFallback?(T(),I("div",Qs,[m[18]||(m[18]=u("div",{class:"error-banner"},[u("span",{class:"error-icon"},"⚠️"),u("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),u("div",en,[me(Ct,{name:"ticket",tag:"div",class:"tickets-list"},{default:xe(()=>[(T(!0),I(pe,null,ge(b.value.tickets,(C,U)=>(T(),Ee(Tt,{key:C.id,ticket:C,draggable:!1,style:ve({"--ticket-index":U}),onClick:J=>Te(C)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):b.value.error&&!b.value.error.hasFallback?(T(),I("div",tn,[m[19]||(m[19]=u("div",{class:"error-icon"},"❌",-1)),m[20]||(m[20]=u("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),u("p",an,H(b.value.error.message),1),u("button",{class:"btn-retry",onClick:Pe},"Повторить попытку")])):!b.value.tickets||b.value.tickets.length===0?(T(),I("div",sn,[m[21]||(m[21]=u("div",{class:"empty-state-icon"},"📭",-1)),u("h3",nn,H(be()),1),u("p",on,H(Le()),1)])):(T(),I("div",rn,[me(Ct,{name:"ticket",tag:"div",class:"tickets-list"},{default:xe(()=>[(T(!0),I(pe,null,ge(b.value.tickets,(C,U)=>(T(),Ee(Tt,{key:C.id,ticket:C,draggable:!1,style:ve({"--ticket-index":U}),onClick:J=>Te(C)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):q("",!0)]}),_:1})])],32)):q("",!0)]))}},cn=Ye(ln,[["__scopeId","data-v-65ca978e"]]);function un(i,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof i!="number"||i<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((o,c)=>{if(!o||!o.data||!Array.isArray(o.data))return;const l=o.data[i];l!=null&&!isNaN(l)&&a.push({datasetIndex:c,value:Number(l),y:Number(l)})}),a.length<2)return 0;const r=[];return a.forEach(o=>{let c=!1;for(const l of r){const n=l.y;if(Math.abs(o.y-n)<e){l.points.push(o),l.y=l.points.reduce((h,d)=>h+d.y,0)/l.points.length,c=!0;break}}c||r.push({points:[o],y:o.y})}),r.length===0?0:r.reduce((o,c)=>c.points.length>o.points.length?c:o,r[0]).points.length}function dn(i,t){const e=[];return i.forEach(a=>{let r=!1;for(const s of e){const o=s.y;if(Math.abs(a.value-o)<t){s.points.push(a),s.y=s.points.reduce((c,l)=>c+l.value,0)/s.points.length,r=!0;break}}r||e.push({points:[a],y:a.value})}),e}function pn(i,t=.5){var s,o;if(!i)return console.warn("findOverlappingPoints: chart не передан"),[];if(!i.config||i.config.type!=="line")return[];const e=(s=i.data)==null?void 0:s.datasets,a=((o=i.data)==null?void 0:o.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const r=[];return a.forEach((c,l)=>{try{if(un(l,e,t)<2)return;const y=[];if(e.forEach((_,D)=>{if(!_||!_.data||!Array.isArray(_.data))return;const w=_.data[l];w==null||isNaN(w)||y.push({datasetIndex:D,value:Number(w),label:_.label||`Dataset ${D}`})}),y.length<2)return;const h=dn(y,t);if(h.length===0)return;const d=h.reduce((_,D)=>D.points.length>_.points.length?D:_,h[0]);if(d.points.length<2)return;let E=null,b=null;for(let _=0;_<e.length;_++)try{const D=i.getDatasetMeta(_);if(D&&D.data&&D.data[l]){E=D,b=D.data[l];break}}catch{continue}if(!b||typeof b.x!="number"||typeof b.y!="number")return;r.push({position:l,count:d.points.length,x:b.x,y:b.y,value:d.y,points:d.points.map(_=>({datasetIndex:_.datasetIndex,value:_.value,label:_.label}))})}catch(n){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${l}:`,n)}}),r}function gn(i,t){const e=[];return i.forEach(a=>{let r=!1;for(const s of e){const o=s.y;if(Math.abs(a.y-o)<t){s.points.push(a),s.y=s.points.reduce((c,l)=>c+l.y,0)/s.points.length,r=!0;break}}r||e.push({points:[a],y:a.y})}),e}function mn(i,t,e=.5){var n,y;if(!i)return console.warn("calculatePointJitter: chart не передан"),[];if(!i.config||i.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(n=i.data)==null?void 0:n.datasets,r=((y=i.data)==null?void 0:y.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(r)||t>=r.length)return[];const s=[];if(a.forEach((h,d)=>{if(!h||!h.data||!Array.isArray(h.data))return;const E=h.data[t];if(!(E==null||isNaN(E)))try{const b=i.getDatasetMeta(d);if(b&&b.data&&b.data[t]){const _=b.data[t];_&&typeof _.x=="number"&&typeof _.y=="number"&&s.push({datasetIndex:d,value:Number(E),x:_.x,y:_.y})}}catch(b){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,b)}}),s.length===0)return[];const o=gn(s,e),c=[];o.forEach(h=>{const d=h.points||[];d.length>1?d.forEach((b,_)=>{const D=(_-(d.length-1)/2)*4;c.push({datasetIndex:b.datasetIndex,jitterX:D,value:b.value})}):d.length===1&&c.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const l=new Set(c.map(h=>h.datasetIndex));return s.forEach(h=>{l.has(h.datasetIndex)||c.push({datasetIndex:h.datasetIndex,jitterX:0,value:h.value})}),c}const fn=.5,At=6,hn=2;function vn(i){return typeof i!="number"||i<2?At:At+(i-1)*hn}function yn(i,t){if(!i||!i.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=i.ctx,{x:r,y:s,points:o}=t,c=vn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(r,s,c,0,2*Math.PI);let n="rgba(128, 128, 128, 0.3)";if(o&&o.length>0&&i.data&&i.data.datasets){const y=o[0].datasetIndex,h=i.data.datasets[y];if(h&&h.pointBackgroundColor){const d=Array.isArray(h.pointBackgroundColor)?h.pointBackgroundColor[t.position]||h.pointBackgroundColor[0]:h.pointBackgroundColor;if(d)if(d.startsWith("#")){const E=parseInt(d.slice(1,3),16),b=parseInt(d.slice(3,5),16),_=parseInt(d.slice(5,7),16);n=`rgba(${E}, ${b}, ${_}, 0.4)`}else d.startsWith("rgba")?n=d.replace(/rgba?\(([^)]+)\)/,(E,b)=>{const _=b.split(",").map(D=>D.trim());return`rgba(${_[0]}, ${_[1]}, ${_[2]}, 0.4)`}):n=d+"66"}}a.fillStyle=n,a.fill(),a.strokeStyle=n.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(n){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",n)}finally{a.restore()}}}const kn={id:"overlappingPointsPlugin",afterDatasetsDraw:i=>{if(!(!i||!i.config||i.config.type!=="line")&&i.ctx)try{const t=pn(i,fn);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{yn(i,a)}catch(r){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,r)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},bn=.5,wn={id:"pointJitterPlugin",beforeDatasetsDraw:i=>{var t,e;if(!(!i||!i.config||i.config.type!=="line")){i._jitterData||(i._jitterData={});try{const a=(t=i.data)==null?void 0:t.datasets,r=((e=i.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(r)||r.length===0)return;i._jitterData={},r.forEach((s,o)=>{const c=mn(i,o,bn);c&&c.length>0&&c.forEach(l=>{const n=`${l.datasetIndex}_${o}`;i._jitterData[n]=l.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:i=>{var t;if(!(!i||!i.config||i.config.type!=="line")&&i.ctx&&!(!i._jitterData||Object.keys(i._jitterData).length===0))try{const e=i.ctx,a=(t=i.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((r,s)=>{const o=i.getDatasetMeta(s);!o||o.hidden||!r.data||!Array.isArray(r.data)||r.data.forEach((c,l)=>{const n=o.data[l];if(!n||typeof n.x!="number"||typeof n.y!="number"||c==null||isNaN(c))return;const y=`${s}_${l}`,h=i._jitterData[y];if(!(h===void 0||h===0)){e.save();try{const d=r.pointStyle||"circle",E=(r.pointRadius||7)+1,b=Array.isArray(r.pointBackgroundColor)?r.pointBackgroundColor[l]||r.pointBackgroundColor[0]:r.pointBackgroundColor,_=Array.isArray(r.pointBorderColor)?r.pointBorderColor[l]||r.pointBorderColor[0]:r.pointBorderColor,D=r.pointBorderWidth||1,w=n.x+h,M=n.y;switch(e.fillStyle=b||"#007bff",e.strokeStyle=_||"#ffffff",e.lineWidth=D,e.beginPath(),d){case"circle":e.arc(w,M,E,0,2*Math.PI);break;case"triangle":e.moveTo(w,M-E),e.lineTo(w-E,M+E),e.lineTo(w+E,M+E),e.closePath();break;case"rect":case"rectRounded":const R=E*1.4;e.rect(w-R/2,M-R/2,R,R);break;case"rectRot":const Y=E*1.4;e.moveTo(w,M-Y/2),e.lineTo(w+Y/2,M),e.lineTo(w,M+Y/2),e.lineTo(w-Y/2,M),e.closePath();break;case"star":const ee=E;for(let se=0;se<5;se++){const Q=se*4*Math.PI/5-Math.PI/2,ue=w+ee*Math.cos(Q),fe=M+ee*Math.sin(Q);se===0?e.moveTo(ue,fe):e.lineTo(ue,fe)}e.closePath();break;case"cross":const Z=E;e.moveTo(w-Z,M-Z),e.lineTo(w+Z,M+Z),e.moveTo(w+Z,M-Z),e.lineTo(w-Z,M+Z);break;case"crossRot":const re=E;e.moveTo(w-re,M),e.lineTo(w+re,M),e.moveTo(w,M-re),e.lineTo(w,M+re);break;default:e.arc(w,M,E,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),n._originalX||(n._originalX=n.x,n._originalY=n.y),n._jitterX=h,n._jitteredX=w,n._jitteredY=M}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${s}_${l}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:i=>{i._jitterData}},Sn={id:"pointLabelsPlugin",afterDatasetsDraw:i=>{var t;if(!(!i||!i.config||i.config.type!=="line")&&i.ctx)try{const e=i.ctx,a=(t=i.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((r,s)=>{const o=i.getDatasetMeta(s);if(!o||o.hidden||!r.data||!Array.isArray(r.data))return;const c=Array.isArray(r.pointBackgroundColor)?r.pointBackgroundColor[0]||"#6b7280":r.pointBackgroundColor||"#6b7280";r.data.forEach((l,n)=>{const y=o.data[n];if(!y||typeof y.x!="number"||typeof y.y!="number"||l==null||isNaN(l))return;const h=y._jitteredX!==void 0?y._jitteredX:y.x,d=y._jitteredY!==void 0?y._jitteredY:y.y,E=h+8,b=d-5,_=String(Math.round(l));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const w=e.measureText(_).width,M=11,R=3,Y=E-R,ee=b-M/2-R,Z=w+R*2,re=M+R*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Y,ee,Z,re),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Y,ee,Z,re),e.fillStyle=c,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(_,E,b)}catch(D){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${s}_${n}:`,D)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},Dn={class:"graph-state-chart"},Cn={class:"chart-header"},En={class:"chart-type-selector"},_n=["onClick","title"],Tn={class:"chart-type-icon"},$n={class:"chart-type-label"},In={key:0,class:"comparison-type-selector"},An={class:"radio-group"},Mn={key:0},xn={key:1},Nn={key:2,class:"graph-legend"},Fn={key:4,class:"error-container"},Bn={class:"error-message"},Ln={class:"chart-wrapper"},Pn={class:"chart-canvas-container"},Rn={key:0,class:"bar-chart-stage-labels"},Hn={key:6,class:"no-data"},On={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(i,{emit:t}){const e=(v,g)=>typeof window>"u"?g:getComputedStyle(document.documentElement).getPropertyValue(v).trim()||g,a=i,r=t,s=B(!1),o=B(null),c=B(null),l=B({weekStart:null,weekEnd:null,current:null}),n=B(null),y=B("weekStartToWeekEnd"),h=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=B("line"),E=B(!1),b=B(""),_=B(""),D=B(0),w=B([]),M=B(null),R=B(null),Y=B(null),ee=B(null),Z=B([]),re=ae(()=>{switch(d.value){case"line":return Et;case"bar":return Vt;case"doughnut":return zt;default:return Et}}),se={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},Q=[{id:"formed",name:"Сформировано обращение",color:se.formed},{id:"review",name:"Рассмотрение ТЗ",color:se.review},{id:"execution",name:"Исполнение",color:se.execution}],ue=ae(()=>Q.reduce((v,g)=>(v[g.id]=g.name,v),{})),fe=["circle","triangle","rect","rectRot","star","cross","crossRot"],_e=B({formed:!0,review:!0,execution:!0}),ye=qe(),Ne={id:"employeeLabelsPlugin",afterDatasetsDraw:v=>{if(v.config.type==="bar")try{const g=v.ctx;if(!v.data||!v.data.datasets)return;const S=v.data.datasets,$=v.scales.y;S.forEach((F,k)=>{const x=v.getDatasetMeta(k);if(!x||x.hidden)return;const V=F.label||"";if(!V||V.includes("Другие"))return;const O=V.trim().split(/\s+/);let K="";if(O.length===1)K=O[0];else{const P=O[0],C=O.slice(1).join(" ");K=`${P}
${C}`}const G=K.split(`
`);F.data.forEach((P,C)=>{if(P===0||!P)return;const U=x.data[C];if(!U||typeof U.x!="number"||typeof U.y!="number")return;const J=U.x,he=U.y+U.height+25;g.save(),g.font="bold 9px Arial, sans-serif",g.fillStyle="#6b7280",g.textAlign="center",g.textBaseline="top",g.translate(J,he),g.rotate(-12*Math.PI/180),G.forEach((we,$e)=>{const Ie=we.trim();Ie&&g.fillText(Ie,0,$e*11)}),g.restore()})})}catch(g){console.error("Error in employeeLabelsPlugin:",g)}}},je={id:"doughnutCenterTextPlugin",afterDraw:v=>{var U;if(v.config.type!=="doughnut")return;const{ctx:g,chartArea:S,width:$,height:F}=v;if(!v.data||!v.data.datasets||v.data.datasets.length===0)return;const k=v.data.datasets[0].meta,x=((U=k==null?void 0:k.totals)==null?void 0:U.overall)??null;if(x===null||typeof x>"u")return;const V=["Всего в секторе 1С","тикетов в работе:",`${x}`];g.save(),g.font='600 16px "Roboto", sans-serif',g.fillStyle=e("--b24-text-primary","#1f2937"),g.textAlign="center",g.textBaseline="middle";const O=(S.left+S.right)/2,K=(S.top+S.bottom)/2,G=18,P=G*V.length,C=K-P/2+4;V.forEach((J,he)=>{he===V.length-1&&`${J}`.length>4?g.font='700 18px "Roboto", sans-serif':g.font='600 16px "Roboto", sans-serif',g.fillText(J,O,C+he*G)}),g.restore()}};Ve.register(Ne),Ve.register(je);function Fe(){const v=new Map;[l.value.weekStart,l.value.weekEnd,l.value.current].forEach(g=>{!g||!g.statistics||!g.statistics.employees||g.statistics.employees.forEach(S=>{v.has(S.id)||v.set(S.id,{id:S.id,name:S.name})})}),Z.value=Array.from(v.values()).sort((g,S)=>g.name.localeCompare(S.name))}function de(v,g="background"){var $;return(($={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[v])==null?void 0:$[g])||e("--b24-text-secondary","#6c757d")}function ke(){if(!(!l.value.weekStart||!l.value.weekEnd))try{const v=rt.compareTwoSnapshots(l.value.weekStart,l.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let g=null,S=null;l.value.current&&(g=rt.compareTwoSnapshots(l.value.weekEnd,l.value.current,{includeTickets:!1,includeEmployees:!0}),S=rt.compareTwoSnapshots(l.value.weekStart,l.value.current,{includeTickets:!1,includeEmployees:!0})),n.value={weekStartToWeekEnd:v,weekEndToCurrent:g,weekStartToCurrent:S}}catch(v){console.error("Ошибка сравнения слепков:",v),ye.warning("Не удалось выполнить сравнение слепков: "+v.message)}}function Be(v){return v?v.replace(/\s*\(\d+\)\s*$/,"").trim():""}function be(v){const g=Be(v);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[g]||"formed"}function Le(v){return be(v)}function Pe(v){return v===0?"weekStart":v===1?"weekEnd":v===2?"current":"weekEnd"}function Te(v,g,S,$,F=null,k=null,x=null,V=null){var O;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:v,stageId:g,totalCount:S,employeesCount:($==null?void 0:$.length)||0,hasSnapshot:!!k,snapshotTicketIds:((O=k==null?void 0:k.ticketIds)==null?void 0:O.length)||0}),b.value=v,_.value=g||"",D.value=S,w.value=$||[],M.value=F&&F.count>0?F:null,R.value=k,Y.value=x,ee.value=V,E.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:_.value,hasCurrentSnapshot:!!R.value})}async function L(v,g,S){var k,x,V,O,K,G,P;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:v,timePoint:g,hasMeta:!!S});const $=Q.find(C=>C.id===v);if(!$){console.warn("[GraphStateChart] Stage not found:",v);return}const F={graphType:"line",stageId:v,stageName:$.name,timePoint:g,snapshots:l.value,meta:{line:S||null,doughnut:((V=(x=(k=c.value)==null?void 0:k.datasets)==null?void 0:x[0])==null?void 0:V.meta)||null},stageColorMap:se,stageNameMap:ue.value};try{const C=await Pt({stageId:v,graphType:"line",timePoint:g,snapshots:l.value,meta:{line:S||null,doughnut:((G=(K=(O=c.value)==null?void 0:O.datasets)==null?void 0:K[0])==null?void 0:G.meta)||null},stageColorMap:se,stageNameMap:ue.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:C.stageName,stageId:v,totalCount:C.totalCount,employeesCount:((P=C.employees)==null?void 0:P.length)||0,hasSnapshot:!!C.snapshot}),Te(C.stageName,v,C.totalCount,C.employees,C.others,C.snapshot,null,F)}catch(C){console.error("[GraphStateChart] Failed to open modal for line point:",C),ye.error("Не удалось открыть попап для выбранной точки графика")}}function z(v,g){var F,k,x;if(!g||!g.employees||g.employees.length===0){ye.warning("Нет данных о сотрудниках для этого этапа");return}const S=l.value.current||l.value.weekEnd||l.value.weekStart,$={graphType:"doughnut",stageId:v,stageName:g.stageName,snapshots:l.value,meta:{doughnut:((x=(k=(F=c.value)==null?void 0:F.datasets)==null?void 0:k[0])==null?void 0:x.meta)||null},stageColorMap:se,stageNameMap:ue.value};Te(g.stageName,v,g.totalCount,g.employees,g.others,S,null,$)}function le(){E.value=!1,b.value="",_.value="",D.value=0,w.value=[],M.value=null,R.value=null,Y.value=null}async function Re(v,g,S){if(d.value!=="line"||g.length===0)return;const $=g[0],F=$.datasetIndex,k=$.index,x=S.data.datasets[F];if(!x)return;const V=Le(x.label),O=Pe(k);await L(V,O,x.meta||null)}function ie(v,g,S){var G,P;if(d.value!=="doughnut"||g.length===0)return;const F=g[0].index,k=S.data,x=k.labels[F],V=Le(x),O=(P=(G=k.datasets[0])==null?void 0:G.meta)==null?void 0:P.employees,K=O==null?void 0:O[V];if(!K){console.warn("Данные о сотрудниках не найдены для этапа:",V);return}z(V,K)}function He(v){var $;const g=Q[v];if(!g)return 0;const S=l.value.current||l.value.weekEnd||l.value.weekStart;return!S||!S.statistics||!S.statistics.stages?0:(($=S.statistics.stages[g.id])==null?void 0:$.count)||0}function p(v){var F;const g=Q.find(k=>k.id===v);if(!g)return"";const S=l.value.current||l.value.weekEnd||l.value.weekStart;if(!S||!S.statistics||!S.statistics.stages)return g.name;const $=((F=S.statistics.stages[v])==null?void 0:F.count)||0;return`${g.name} (${$})`}const m=ae(()=>{if(!c.value)return null;if(d.value==="doughnut"||d.value==="bar")return c.value;const v=c.value.datasets.filter(g=>{const S=Q.find($=>$.name===g.label);return S?_e.value[S.id]:!0});return{...c.value,datasets:v}});ae(()=>d.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const f=ae(()=>{const v={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(g,S,$)=>{d.value==="line"?Re(g,S,$):d.value==="doughnut"&&ie(g,S,$)},onHover:(g,S,$)=>{d.value==="doughnut"&&(g.native.target.style.cursor=S.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",labels:{font:{size:d.value==="doughnut"?14:12,weight:d.value==="doughnut"?"600":"500"},boxWidth:d.value==="doughnut"?18:12,boxHeight:d.value==="doughnut"?18:12,padding:d.value==="doughnut"?14:10},onClick:(g,S,$)=>{if(d.value==="bar"){const k=S.datasetIndex;if(k!==void 0){const x=$.chart.getDatasetMeta(k);x.hidden=!x.hidden,$.chart.update()}return}const F=S.datasetIndex;if(F!==void 0){const k=$.chart.getDatasetMeta(F);k.hidden=!k.hidden,$.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:g=>{if(d.value==="bar"){const S=g[0].dataIndex,$=Q[S];return $?$.name:""}return g[0].label||""},label:g=>{var k,x,V,O,K,G;const S=g.dataset.label||"",$=g.parsed.y||g.parsed||0,F=g.dataIndex;if(d.value==="bar"){const P=g.dataset,C=g.dataIndex,U=Q[C],J=U?U.name:"";return`${P.label}: ${$} тикетов на этапе "${J}"`}if(d.value==="doughnut"){const P=g.dataset.data.reduce((U,J)=>U+J,0),C=P>0?($/P*100).toFixed(1):0;return`${S}: ${$} тикетов (${C}%)`}else{if(!n.value||F===0)return`${S}: ${$} тикетов`;let P=null;const C=be(S);if(y.value==="weekStartToWeekEnd"&&F===1?P=(x=(k=n.value.weekStartToWeekEnd)==null?void 0:k.stages)==null?void 0:x[C]:y.value==="weekEndToCurrent"&&F===2&&l.value.current?P=(O=(V=n.value.weekEndToCurrent)==null?void 0:V.stages)==null?void 0:O[C]:y.value==="weekStartToCurrent"&&F===2&&l.value.current&&(P=(G=(K=n.value.weekStartToCurrent)==null?void 0:K.stages)==null?void 0:G[C]),!P)return`${S}: ${$} тикетов`;const U=P.delta,J=P.deltaPercent,he=P.trend;let we=`${S}: ${$} тикетов`;if(U!==0){const $e=U>0?"+":"",Ie=he==="increase"?"↑":he==="decrease"?"↓":"→";we+=` (${$e}${U}, ${$e}${J.toFixed(1)}%) ${Ie}`}else we+=" (без изменений)";return we}},afterBody:g=>{if(d.value==="bar"&&g.length>0){const k=g[0];k.dataset;const x=k.parsed.y||0,V=k.dataIndex,O=He(V);return[`${O>0?(x/O*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&g.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const k=[];if(n.value){const x=g[0].dataIndex;if(x!==0){let V=null;if(be(g[0].dataset.label||""),y.value==="weekStartToWeekEnd"&&x===1?V=n.value.weekStartToWeekEnd:y.value==="weekEndToCurrent"&&x===2?V=n.value.weekEndToCurrent:y.value==="weekStartToCurrent"&&x===2&&(V=n.value.weekStartToCurrent),V&&V.metadata){const O=V.metadata.timeDiff;k.push(`Период: ${O.days} дн. ${O.hours} ч. ${O.minutes} мин.`)}}}return k.push("Кликните для детализации по сотрудникам"),k}if(!n.value)return[];const S=g[0].dataIndex;if(S===0)return[];let $=null;if(be(g[0].dataset.label||""),y.value==="weekStartToWeekEnd"&&S===1?$=n.value.weekStartToWeekEnd:y.value==="weekEndToCurrent"&&S===2?$=n.value.weekEndToCurrent:y.value==="weekStartToCurrent"&&S===2&&($=n.value.weekStartToCurrent),!$||!$.metadata)return[];const F=$.metadata.timeDiff;return[`Период: ${F.days} дн. ${F.hours} ч. ${F.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...v,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...v,cutout:"60%"}:v});function A(v){const g=new Date(v),S=g.getFullYear(),$=String(g.getMonth()+1).padStart(2,"0"),F=String(g.getDate()).padStart(2,"0");return`${S}-${$}-${F}`}function W(v){const{current:g,weekEnd:S}=v,$=g||S;if(!$||!$.statistics||!$.statistics.stages)return null;const F=[],k=[],x=[],V=[],O={},K={};if(Q.forEach(P=>{var U;const C=((U=$.statistics.stages[P.id])==null?void 0:U.count)||0;if(C>0){F.push(`${P.name} (${C})`),k.push(C),x.push(P.color+"80"),V.push(P.color),K[P.id]=C;const J=ga(P.id,$,Q);J&&J.employees&&(O[P.id]=J)}}),k.length===0)return null;const G=k.reduce((P,C)=>P+C,0);return{labels:F,datasets:[{label:"Распределение по этапам",data:k,backgroundColor:x,borderColor:V,borderWidth:2,meta:{employees:O,totals:{overall:G,stages:K}}}]}}function j(v){if(d.value==="doughnut")return W(v);if(d.value==="bar"){const x=a.showCurrentState&&v.current?"current":v.weekEnd?"weekEnd":"weekStart";return pa(v,x,Q)}const{weekStart:g,weekEnd:S,current:$}=v,F=[],k=[];return Q.forEach((x,V)=>{var J,he,we,$e,Ie,pt,gt,mt,ft,ht,vt,yt,kt,bt,wt,St,Dt;const O=[];if(g&&g.statistics&&g.statistics.stages){const te=g.statistics.stages[x.id];if(F.length===0){const Ue=(J=g.metadata)!=null&&J.createdAt?new Date(g.metadata.createdAt):null;F.push(Ue?A(Ue):"Начало недели")}O.push((te==null?void 0:te.count)||0)}else F.length===0&&F.push("Начало недели"),O.push(0);if(S&&S.statistics&&S.statistics.stages){const te=S.statistics.stages[x.id];if(F.length===1){const Ue=(he=S.metadata)!=null&&he.createdAt?new Date(S.metadata.createdAt):null;F.push(Ue?A(Ue):"Конец недели")}O.push((te==null?void 0:te.count)||0)}else F.length===1&&F.push("Конец недели"),O.push(0);if($&&a.showCurrentState&&$.statistics&&$.statistics.stages){const te=$.statistics.stages[x.id];F.length===2&&F.push("Текущее состояние"),O.push((te==null?void 0:te.count)||0)}const K=["stable"];n.value?y.value==="weekStartToWeekEnd"?(K.push(((Ie=($e=(we=n.value.weekStartToWeekEnd)==null?void 0:we.stages)==null?void 0:$e[x.id])==null?void 0:Ie.trend)||"stable"),$&&K.push(((mt=(gt=(pt=n.value.weekStartToCurrent)==null?void 0:pt.stages)==null?void 0:gt[x.id])==null?void 0:mt.trend)||"stable")):y.value==="weekEndToCurrent"&&$?(K.push("stable"),K.push(((vt=(ht=(ft=n.value.weekEndToCurrent)==null?void 0:ft.stages)==null?void 0:ht[x.id])==null?void 0:vt.trend)||"stable")):y.value==="weekStartToCurrent"&&$?(K.push(((bt=(kt=(yt=n.value.weekStartToWeekEnd)==null?void 0:yt.stages)==null?void 0:kt[x.id])==null?void 0:bt.trend)||"stable"),K.push(((Dt=(St=(wt=n.value.weekStartToCurrent)==null?void 0:wt.stages)==null?void 0:St[x.id])==null?void 0:Dt.trend)||"stable")):(K.push("stable"),$&&K.push("stable")):(K.push("stable"),$&&K.push("stable"));let G,P,C;n.value&&d.value!=="doughnut"?(G=K.map(te=>de(te,"background")+"40"),P=K.map(te=>de(te,"border")),C=K.map(te=>de(te,"point"))):(G=x.color+"40",P=x.color,C=x.color);let U=null;d.value==="line"&&(U={employees:da(x.id,v)}),k.push({label:x.name,data:O,backgroundColor:(Array.isArray(G),G),borderColor:(Array.isArray(P),P),borderWidth:2,...d.value==="line"&&{pointStyle:fe[V%fe.length]},pointBackgroundColor:(Array.isArray(C),C),pointBorderColor:(Array.isArray(P),P),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:U})}),F.length===0&&(F.push("Начало недели","Конец недели"),a.showCurrentState&&F.push("Текущее состояние")),{labels:F,datasets:k}}const X=async()=>{var v,g,S;s.value=!0,o.value=null;try{const $=(v=a.period)!=null&&v.endDate?new Date(a.period.endDate):new Date,F=(g=a.period)!=null&&g.startDate?new Date(a.period.startDate):Ce.getWeekStartDate($),k=(S=a.period)!=null&&S.endDate?new Date(a.period.endDate):Ce.getWeekEndDate($),x=Ce.formatDate(F),V=Ce.formatDate(k),[O,K]=await Promise.all([Ce.getSnapshot(x,"week_start"),Ce.getSnapshot(V,"week_end")]);let G=null;a.showCurrentState&&(G=await ct.getSectorDataForSnapshot({useCache:!1,normalize:!0})),l.value={weekStart:O,weekEnd:K,current:G},Fe(),ke(),N(),r("data-loaded",{weekStart:O,weekEnd:K,current:G})}catch($){console.error("Error loading chart data:",$),o.value=$.message||"Ошибка загрузки данных графика",ye.error("Ошибка загрузки данных графика: "+o.value),r("error",o.value)}finally{s.value=!1}};Xe(()=>{Ve.register(kn),Ve.register(wn),Ve.register(Sn),X()});function ne(v){_e.value=v}const N=()=>{var g;const v=j({weekStart:l.value.weekStart,weekEnd:l.value.weekEnd,current:l.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==((g=v==null?void 0:v.labels)==null?void 0:g.length))c.value=v;else if(v){const S=JSON.stringify(c.value),$=JSON.stringify(v);S!==$&&(c.value=v)}};return Ke(()=>[a.period,a.showCurrentState],()=>{X()},{deep:!0}),Ke(d,()=>{(l.value.weekStart||l.value.weekEnd||l.value.current)&&N()}),Ke(y,()=>{(l.value.weekStart||l.value.weekEnd||l.value.current)&&N()}),(v,g)=>(T(),I("div",Dn,[u("div",Cn,[g[3]||(g[3]=u("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),u("div",En,[(T(),I(pe,null,ge(h,S=>u("button",{key:S.value,onClick:$=>d.value=S.value,class:ce(["chart-type-btn",{active:d.value===S.value}]),title:S.label},[u("span",Tn,H(S.icon),1),u("span",$n,H(S.label),1)],10,_n)),64))])]),!s.value&&!o.value&&n.value&&d.value!=="doughnut"?(T(),I("div",In,[g[7]||(g[7]=u("h4",{class:"comparison-title"},"Тип сравнения:",-1)),u("div",An,[u("label",null,[tt(u("input",{type:"radio","onUpdate:modelValue":g[0]||(g[0]=S=>y.value=S),value:"weekStartToWeekEnd",onChange:N},null,544),[[at,y.value]]),g[4]||(g[4]=u("span",null,"Начало недели → Конец недели",-1))]),l.value.current?(T(),I("label",Mn,[tt(u("input",{type:"radio","onUpdate:modelValue":g[1]||(g[1]=S=>y.value=S),value:"weekEndToCurrent",onChange:N},null,544),[[at,y.value]]),g[5]||(g[5]=u("span",null,"Конец недели → Текущее состояние",-1))])):q("",!0),l.value.current?(T(),I("label",xn,[tt(u("input",{type:"radio","onUpdate:modelValue":g[2]||(g[2]=S=>y.value=S),value:"weekStartToCurrent",onChange:N},null,544),[[at,y.value]]),g[6]||(g[6]=u("span",null,"Начало недели → Текущее состояние",-1))])):q("",!0)])])):q("",!0),!s.value&&!o.value&&c.value?(T(),Ee(ca,{key:1,stages:Q,selected:_e.value,"onUpdate:selected":ne,onChange:N},null,8,["selected"])):q("",!0),!s.value&&!o.value&&n.value&&d.value!=="doughnut"?(T(),I("div",Nn,[...g[8]||(g[8]=[Ht('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):q("",!0),s.value?(T(),Ee(xt,{key:3,message:"Загрузка данных графика..."})):o.value?(T(),I("div",Fn,[u("p",Bn,"❌ "+H(o.value),1),u("button",{onClick:X,class:"btn-retry"},"Повторить загрузку")])):m.value?(T(),I("div",{key:5,class:ce(["chart-container",`chart-type-${d.value}`])},[u("div",Ln,[u("div",Pn,[(T(),Ee(Ot(re.value),{data:m.value,options:f.value},null,8,["data","options"]))]),d.value==="bar"?(T(),I("div",Rn,[(T(),I(pe,null,ge(Q,S=>u("div",{key:S.id,class:"stage-label-item"},H(p(S.id)),1)),64))])):q("",!0)])],2)):(T(),I("div",Hn,[...g[9]||(g[9]=[u("p",null,"📊 Нет данных для отображения",-1),u("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),me(cn,{"is-visible":E.value,"stage-name":b.value,"stage-id":_.value,"total-count":D.value,employees:w.value,others:M.value,snapshot:R.value,"ticket-details":Y.value,"stage-switch-context":ee.value,onClose:le},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},Wn=Ye(On,[["__scopeId","data-v-cbba196a"]]),jn={key:0,class:"create-snapshot-button-container"},Un=["disabled"],zn={class:"modal-content"},Vn={class:"modal-header"},Kn=["disabled"],Gn={class:"modal-body"},Xn={key:0,class:"progress-container"},Yn={class:"progress-bar-wrapper"},qn={class:"progress-text"},Jn={class:"progress-percent"},Zn={class:"progress-description"},Qn={key:1},eo={class:"modal-footer"},to=["disabled"],ao=["disabled"],so={key:0},no={key:0},oo={key:1},ro={key:2},lo={key:1},io={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(i,{emit:t}){const e=i,a=t,r=B(e.user),s=B(!1),o=B(!1),c=B(0),l=B("idle"),n=B(""),y=qe(),h=ae(()=>r.value?Wt(r.value):!1);Xe(async()=>{if(!e.user)try{const D=await Nt.checkAccess();D.allowed&&(r.value=D.user)}catch(D){console.error("Error loading user:",D)}});const d=()=>{if(!h.value){y.warning("Только администраторы могут создавать слепки");return}s.value=!0},E=()=>{o.value||(s.value=!1,l.value="idle",c.value=0,n.value="")},b=async()=>{if(!o.value){if(!h.value){y.warning("Только администраторы могут создавать слепки");return}o.value=!0,l.value="loading_data",c.value=0,n.value="Инициализация загрузки данных...";try{n.value="Загрузка данных сектора из Bitrix24...";const D=await ct.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:R=>{var ee;const Y=Math.min(80,(R.progress||0)*.8);c.value=Y,l.value="loading_data",n.value=R.description||((ee=R.details)==null?void 0:ee.description)||"Загрузка данных сектора..."}});l.value="creating_snapshot",c.value=85,n.value="Создание слепка...";const w=r.value;if(!w)throw new Error("Пользователь не определён");const M=await Ce.createSnapshot(D,"manual",{createdBy:{id:w.ID,name:`${w.NAME||""} ${w.LAST_NAME||""}`.trim()||w.EMAIL||`User ${w.ID}`},sectorId:"1C"});l.value="success",c.value=100,n.value="Слепок успешно создан!",y.success("Слепок состояния сектора успешно создан"),a("snapshot-created",M),setTimeout(()=>{E()},1500)}catch(D){l.value="error",c.value=0,n.value="Ошибка создания слепка",console.error("Error creating snapshot:",D);let w="Ошибка создания слепка";D.message&&(D.message.includes("загрузки данных")||D.message.includes("sector data")?w="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":D.message.includes("создания слепка")||D.message.includes("snapshot")?w="Не удалось создать слепок. Обратитесь в поддержку.":D.message.includes("валидац")||D.message.includes("validation")?w="Ошибка валидации данных. Проверьте данные сектора.":w=D.message),y.error(w)}finally{o.value=!1}}},_=D=>{D.key==="Escape"&&s.value&&!o.value&&E()};return Xe(()=>{window.addEventListener("keydown",_)}),Ft(()=>{window.removeEventListener("keydown",_)}),(D,w)=>h.value?(T(),I("div",jn,[u("button",{class:"create-snapshot-btn",onClick:d,disabled:o.value,title:"Создать слепок состояния сектора"},[...w[1]||(w[1]=[u("span",{class:"btn-icon"},"📸",-1),u("span",{class:"btn-text"},"Создать слепок",-1)])],8,Un),(T(),Ee(Mt,{to:"body"},[me(it,{name:"modal"},{default:xe(()=>[s.value?(T(),I("div",{key:0,class:"modal-overlay",onClick:w[0]||(w[0]=oe(M=>!o.value&&E(),["self"]))},[u("div",zn,[u("div",Vn,[w[2]||(w[2]=u("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),u("button",{class:"modal-close",onClick:E,disabled:o.value,"aria-label":"Закрыть"}," ✕ ",8,Kn)]),u("div",Gn,[l.value!=="idle"?(T(),I("div",Xn,[u("div",Yn,[u("div",{class:"progress-bar",style:ve({width:`${c.value}%`})},null,4)]),u("div",qn,[u("span",Jn,H(Math.round(c.value))+"%",1),u("span",Zn,H(n.value),1)])])):(T(),I("div",Qn,[...w[3]||(w[3]=[u("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),u("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),u("div",eo,[u("button",{class:"btn btn-secondary",onClick:E,disabled:o.value}," Отмена ",8,to),u("button",{class:"btn btn-primary",onClick:b,disabled:o.value},[o.value?(T(),I("span",so,[l.value==="loading_data"?(T(),I("span",no,"Загрузка данных...")):l.value==="creating_snapshot"?(T(),I("span",oo,"Создание...")):(T(),I("span",ro,"Обработка..."))])):(T(),I("span",lo,"Создать"))],8,ao)])])])):q("",!0)]),_:1})]))])):q("",!0)}},co=Ye(io,[["__scopeId","data-v-09bccee2"]]);function uo(){const i=B(!1),t=B(null),e=B(null),a=B(0),r=qe(),s=async(D=!0,w=null)=>{i.value=!0,t.value=null,a.value=0;try{const M=await ct.getSectorDataForSnapshot({useCache:D,onProgress:R=>{R&&typeof R.progress=="number"&&(a.value=R.progress),w&&w(R)},normalize:!0});return e.value=M,M}catch(M){throw t.value=M.message||"Ошибка загрузки данных сектора",r.error("Ошибка загрузки данных сектора: "+t.value),M}finally{i.value=!1,a.value=100}},o=async(D,w={})=>{if(!e.value){const M="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=M,r.error(M),new Error(M)}i.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(D))throw new Error(`Неверный тип слепка: ${D}. Допустимые значения: week_start, week_end, manual, current`);const M=await Ce.createSnapshot(e.value,D,w);return r.success("Слепок успешно создан"),M}catch(M){throw t.value=M.message||"Ошибка создания слепка",r.error("Ошибка создания слепка: "+t.value),M}finally{i.value=!1}},c=()=>{i.value=!1,t.value=null,e.value=null,a.value=0},l=ae(()=>e.value!==null&&e.value!==void 0),n=B({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),y=ae(()=>{const D=new Date;let w,M;switch(n.value.dateRange){case"last-week":w=new Date(D),w.setDate(D.getDate()-7),M=D;break;case"last-2-weeks":w=new Date(D),w.setDate(D.getDate()-14),M=D;break;case"last-month":w=new Date(D),w.setMonth(D.getMonth()-1),M=D;break;case"custom":w=n.value.customDateRange.startDate?new Date(n.value.customDateRange.startDate):null,M=n.value.customDateRange.endDate?new Date(n.value.customDateRange.endDate):null;break;default:w=new Date(D),w.setDate(D.getDate()-7),M=D}return{startDate:w?w.toISOString().split("T")[0]:null,endDate:M?M.toISOString().split("T")[0]:null}}),h=()=>{E()},d=()=>{n.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},E()},E=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(n.value))}catch(D){console.error("Ошибка сохранения фильтров в localStorage:",D)}},b=()=>{try{const D=localStorage.getItem("graphStateFilters");if(D){const w=JSON.parse(D);w&&typeof w=="object"&&(n.value={stages:w.stages||{formed:!0,review:!0,execution:!0},employees:w.employees||["all"],dateRange:w.dateRange||"last-week",customDateRange:w.customDateRange||{startDate:null,endDate:null}})}}catch(D){console.error("Ошибка загрузки фильтров из localStorage:",D)}},_=ae(()=>{const D=Object.values(n.value.stages).some(R=>!R),w=!n.value.employees.includes("all"),M=n.value.dateRange!=="last-week";return D||w||M});return{isLoading:i,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:l,filters:n,selectedPeriod:y,hasActiveFilters:_,loadSectorDataForSnapshot:s,createSnapshot:o,resetState:c,applyFilters:h,resetFilters:d,saveFiltersToLocalStorage:E,loadFiltersFromLocalStorage:b}}const po={class:"graph-state-dashboard"},go={key:1,class:"error-message-container"},mo={class:"error-message"},fo={class:"error-text"},ho={key:0,class:"error-details"},vo={class:"dashboard-header"},yo={class:"header-content"},ko={class:"breadcrumbs-row"},bo=["aria-disabled","data-fallback","disabled"],wo={class:"breadcrumbs","aria-label":"Навигация"},So={class:"header-actions"},Do=["disabled"],Co={key:0},Eo={key:1},_o={key:3,class:"dashboard-content"},To={class:"chart-container"},$o="Назад",Io={__name:"GraphStateDashboard",setup(i){const t=(L,z)=>typeof window>"u"?z:getComputedStyle(document.documentElement).getPropertyValue(L).trim()||z,e=qe(),a=jt(),r={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:o,hasActiveFilters:c,applyFilters:l,resetFilters:n,loadFiltersFromLocalStorage:y}=uo(),h=B(null),d=B(!0),E=B(!1),b=B("Загрузка данных..."),_=B(null),D=B(!1),w=B(!1),M=B(typeof window<"u"?window.innerWidth:1024),R=B(null),Y=B(!1),ee=ae(()=>M.value<768);ae(()=>M.value>=768&&M.value<1024),ae(()=>M.value>=1024);const Z=ae(()=>typeof window>"u"?!1:window.history.length>1);ae(()=>{const L=new Date;return L.setFullYear(L.getFullYear()-1),L.toISOString().split("T")[0]}),ae(()=>new Date().toISOString().split("T")[0]);function re(L){s.value.stages=L}function se(L){s.value.employees=L}function Q(L){s.value.dateRange=L}function ue(L){s.value.customDateRange=L}function fe(){l()}function _e(){n(),R.value=null,fe(),e.info("Фильтры сброшены")}function ye(L){e.success("Слепок успешно создан")}function Ne(L){E.value=!1,b.value="",console.log("Данные графика загружены:",L)}function je(L){E.value=!1,Fe({message:L||"Ошибка загрузки графика",details:null,type:"error"})}function Fe(L){_.value={message:L.message||"Произошла ошибка",details:L.details||null,type:L.type||"error",timestamp:new Date},console.error("Dashboard error:",_.value),e.error(_.value.message)}function de(){_.value=null}function ke(){_.value=null,E.value=!0,b.value="Повторная загрузка данных..."}async function Be(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}D.value=!0;try{const L=document.querySelector(".chart-container");if(!L)throw new Error("График не найден");const z=window.html2canvas,le=await z(L,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Re=window.jsPDF,ie=new Re("landscape","mm","a4"),He=297,p=le.height*He/le.width;ie.setFontSize(18),ie.text("График состояния сектора 1С",148.5,15,{align:"center"});const m=new Date().toLocaleDateString("ru-RU");ie.setFontSize(10);const f=o.value.startDate&&o.value.endDate?`Период: ${o.value.startDate} - ${o.value.endDate}`:"Период: не указан";ie.text(f,148.5,25,{align:"center"}),ie.text(`Экспорт от ${m}`,148.5,30,{align:"center"}),ie.addImage(le.toDataURL("image/png"),"PNG",10,35,He-20,p-20),ie.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${m}`,author:"Bitrix24 Dashboard"});const A=`graph-state-${m.replace(/\//g,"-")}.pdf`;ie.save(A),e.success("График успешно экспортирован в PDF")}catch(L){console.error("Ошибка экспорта в PDF:",L),Fe({message:"Ошибка экспорта в PDF: "+(L.message||"Неизвестная ошибка"),details:L.stack,type:"error"})}finally{D.value=!1}}function be(L){var z;if((z=L==null?void 0:L.preventDefault)==null||z.call(L),!Y.value){Y.value=!0;try{if(Z.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(r)}finally{Y.value=!1}}}function Le(){a.push("/")}function Pe(){typeof window<"u"&&(M.value=window.innerWidth)}async function Te(){try{const L=await Nt.checkAccess();L.allowed&&(h.value=L.user)}catch(L){console.error("Error loading user:",L)}}return Xe(()=>{y(),Te(),typeof window<"u"&&(M.value=window.innerWidth,window.addEventListener("resize",Pe))}),Ft(()=>{typeof window<"u"&&window.removeEventListener("resize",Pe)}),(L,z)=>{const le=Ut("router-link");return T(),I("div",po,[E.value?(T(),Ee(xt,{key:0,message:b.value},null,8,["message"])):q("",!0),_.value?(T(),I("div",go,[u("div",mo,[u("div",{class:"error-header"},[z[1]||(z[1]=u("span",{class:"error-icon"},"❌",-1)),z[2]||(z[2]=u("h3",null,"Ошибка",-1)),u("button",{onClick:de,class:"error-close","aria-label":"Закрыть"},"✕")]),u("p",fo,H(_.value.message),1),_.value.details?(T(),I("div",ho,[u("details",null,[z[3]||(z[3]=u("summary",null,"Детали ошибки",-1)),u("pre",null,H(_.value.details),1)])])):q("",!0),u("div",{class:"error-actions"},[u("button",{onClick:ke,class:"btn-retry"},"Повторить попытку")])])])):q("",!0),u("div",vo,[u("div",yo,[u("div",ko,[u("button",{class:"btn-home-link",type:"button",onClick:Le,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),z[9]||(z[9]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),u("button",{class:"btn-back-link",type:"button",onClick:be,"aria-label":$o,"aria-disabled":!Z.value,"data-fallback":!Z.value,disabled:Y.value,title:"Назад"}," ← ",8,bo),u("nav",wo,[me(le,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:xe(()=>[...z[4]||(z[4]=[lt(" Дашборд сектора 1С ",-1)])]),_:1}),z[6]||(z[6]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),z[7]||(z[7]=u("span",{class:"breadcrumb-current"},"График состояния",-1)),z[8]||(z[8]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),me(le,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:xe(()=>[...z[5]||(z[5]=[lt(" График приёма и закрытий ",-1)])]),_:1})])]),z[10]||(z[10]=u("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),z[11]||(z[11]=u("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),u("div",So,[u("button",{onClick:Be,class:"btn-export-pdf",disabled:D.value||E.value,title:"Экспортировать график в PDF"},[D.value?(T(),I("span",Eo,"⏳ Экспорт...")):(T(),I("span",Co,"📄 Экспорт в PDF"))],8,Do),me(co,{user:h.value,onSnapshotCreated:ye},null,8,["user"])])]),ee.value?(T(),I("button",{key:2,class:"mobile-filters-toggle",onClick:z[0]||(z[0]=Re=>w.value=!w.value)},[z[12]||(z[12]=u("span",null,"Фильтры",-1)),u("span",{class:ce(["toggle-icon",{open:w.value}])},"▼",2)])):q("",!0),u("div",{class:ce({"mobile-open":w.value&&ee.value,"mobile-closed":!w.value&&ee.value})},[me(Jt,{stages:Oe(s).stages,employees:Oe(s).employees,dateRange:Oe(s).dateRange,customDateRange:Oe(s).customDateRange,hasActiveFilters:Oe(c),"onUpdate:stages":re,"onUpdate:employees":se,"onUpdate:dateRange":Q,"onUpdate:customDateRange":ue,onReset:_e,onApply:fe},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!E.value&&!_.value?(T(),I("div",_o,[u("div",To,[me(Wn,{period:Oe(o),"show-current-state":d.value,onDataLoaded:Ne,onError:je},null,8,["period","show-current-state"])])])):q("",!0)])}}},Po=Ye(Io,[["__scopeId","data-v-831b0079"]]);export{Po as default};
