var rt=Object.defineProperty;var nt=(t,e,r)=>e in t?rt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var w=(t,e,r)=>nt(t,typeof e!="symbol"?e+"":e,r);import{B as it,i as st,d as ot,j as at,g as x,a as z,k as ct,l as b,E as lt}from"./priority-config-boaGNfvN.js";import{D as ut}from"./main-CTjTZ23-.js";const v="dashboard-sector-1c-logger-level",R={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class dt{static getLevel(){if(typeof localStorage<"u"){const e=localStorage.getItem(v);if(e&&R[e]!==void 0)return e}return"ERROR"}static setLevel(e){return R[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(v,e),!0):!1}static isEnabled(e,r=null){const n=r||this.getLevel();if(n==="NONE")return!1;const i=R[e]||0,o=R[n]||0;return i<=o}static getLevels(){return{...R}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(v)}}class h{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,r,n=""){const i=new Date().toISOString(),o=this.getLevelColor(e),s=`%c[${i}] %c[${e}] %c[${n||"Unknown"}] %c${r}`,u=["color: #6c757d; font-weight: normal",`color: ${o}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:s,styles:u}}static log(e,r,n="",i=null){if(!dt.isEnabled(e))return;const o=this.formatMessage(e,r,n),s=[o.formatted,...o.styles];switch(i!=null&&s.push(i),e){case"ERROR":console.error(...s);break;case"WARN":console.warn(...s);break;case"INFO":console.info(...s);break;case"DEBUG":console.log(...s);break;default:console.log(...s)}}static error(e,r="",n=null){this.log("ERROR",e,r,n)}static warn(e,r="",n=null){this.log("WARN",e,r,n)}static info(e,r="",n=null){this.log("INFO",e,r,n)}static debug(e,r="",n=null){this.log("DEBUG",e,r,n)}}class gt{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,r,n,i=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const o=this.metrics.ticketsLoading.stages[e];o.loaded=n,o.batches.push({count:r,total:n,next:i}),o.total=n,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((s,u)=>s+u.total,0)}logFiltering(e,r,n=[],i=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=r,this.metrics.filtering.rejected=n.slice(0,50),this.metrics.filtering.tagValueExamples=i.slice(0,20)}logEmployees(e,r=[],n=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=r.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=n.slice(0,50)}logGrouping(e,r=[],n=[]){e.forEach(i=>{const o={};let s=0;i.employees.forEach(u=>{const a=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;o[u.id]=a,s+=a}),this.metrics.grouping.distributionByStages[i.id]={employees:o,total:s}}),this.metrics.grouping.ticketsNotInColumn=r.slice(0,50),this.metrics.grouping.unknownStages=n.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(r=>{this.metrics.zeroPoint.byStage[r]=Array.isArray(e[r])?e[r].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let U=null;function C(){return U||(U=new gt),U}function I(t=null,e=null){if(e&&!ut(e))return!1;if(t&&t.query&&t.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const r=window.location.hash;if(r){const i=r.split("?");if(i.length>1){const o=i[1];if(new URLSearchParams(o).get("diagnostics")==="true")return!0}if(r.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class A{static async call(e,r={}){return await it.call(e,r)}}class p{static get(e){const r=this.cache.get(e);return r?Date.now()-r.timestamp>r.ttl?(this.cache.delete(e),null):r.data:null}static set(e,r,n=this.DEFAULT_TTL){this.cache.set(e,{data:r,timestamp:Date.now(),ttl:n})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const r=[];for(const n of this.cache.keys())n.startsWith(e)&&r.push(n);r.forEach(n=>this.cache.delete(n))}static cleanExpired(){const e=Date.now(),r=[];for(const[n,i]of this.cache.entries())e-i.timestamp>i.ttl&&r.push(n);r.forEach(n=>this.cache.delete(n))}static getStats(){const e=Date.now();let r=0,n=0;for(const i of this.cache.values())e-i.timestamp>i.ttl?r++:n++;return{total:this.cache.size,valid:n,expired:r}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((n,i)=>n-i).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}w(p,"cache",new Map),w(p,"DEFAULT_TTL",5*60*1e3),w(p,"EMPLOYEES_TTL",30*60*1e3),w(p,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{p.cleanExpired()},5*60*1e3);function S(t,e,r={}){if(!t||typeof t!="string")throw new Error("Step must be a non-empty string");const n=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let i=r.description;return i||(i=ft(t,r)),{step:t,progress:n,details:{...r,description:i}}}function ft(t,e){return t==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`Загрузка тикетов стадии "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:t==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`Фильтрация тикетов: ${e.filteredTickets} из ${e.totalTickets}...`:t==="grouping"&&e.employeeCount!==void 0?`Группировка тикетов по ${e.employeeCount} сотрудникам...`:e.count!==void 0&&e.total!==void 0?`Обработка: ${e.count} из ${e.total}...`:"Загрузка данных..."}function P(t){if(!t||typeof t!="object")throw new Error("Progress info must be an object");const e=t.step||null;if(!e)throw new Error("Step is required in progress info");const r=t.progress!==void 0&&t.progress!==null?t.progress:t.percent!==void 0&&t.percent!==null?t.percent:void 0,n=t.details||{};return t.stage&&(n.stage=t.stage),t.stageName&&(n.stageName=t.stageName),t.stageIndex!==void 0&&(n.stageIndex=t.stageIndex),t.totalStages!==void 0&&(n.totalStages=t.totalStages),t.count!==void 0&&(n.count=t.count),t.total!==void 0&&(n.total=t.total),t.warning&&(n.warning=t.warning),{step:e,progress:r!=null?Math.max(0,Math.min(100,r)):void 0,details:n}}function q(t,e,r){const n=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,i=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,o=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,s=n+i*o/100;return Math.max(0,Math.min(100,s))}const k=140;class N{static async getAllTickets(e,r=null,n=!0){const i=[],o=e.length;try{for(let s=0;s<e.length;s++){const u=e[s],a=this.getStageName(u);if(r){const c=s/o*100;r(S("loading_tickets",c,{stage:u,stageName:a,stageIndex:s+1,totalStages:o}))}try{const c=await this.getTicketsByStage(u,n,r?d=>{const f=q(s/o*100,1/o*100,d.percent||0);r(S("loading_tickets",f,{stage:u,stageName:a,stageIndex:s+1,totalStages:o,count:d.count,total:d.total}))}:null);i.push(...c)}catch(c){h.error(`Error loading tickets for stage ${u}`,"TicketRepository",c);let d=`Ошибка загрузки стадии "${a}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${a}". Проверьте подключение к интернету.`:c.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${a}". Попробуйте позже.`:c.message.includes("403")||c.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${a}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${a}": ${c.message}`),new Error(d)}}}catch(s){throw h.error("Error in getAllTickets","TicketRepository",s),s}return i}static getStageName(e){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[e]||e}static async getTicketsByStage(e,r=!0,n=null){var d,f,y;if(r){const l=p.getTicketsCacheKey(e),g=p.get(l);if(g!==null){try{const m=C();m&&I()&&m.logTicketsLoading(e,g.length,g.length,null)}catch(m){h.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",m)}return n&&n(P({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}}const i=[];let o=0;const s=50;let u=!0,a=0,c=null;for(;u;)try{const l=await A.call("crm.item.list",{entityTypeId:k,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:o,useOriginalUfNames:"Y"});let g=[];if(l&&l.result&&(Array.isArray(l.result)?g=l.result:l.result.items&&Array.isArray(l.result.items)?g=l.result.items:l.result.data&&Array.isArray(l.result.data)&&(g=l.result.data)),g.length>0){i.push(...g),o+=g.length;const m=((d=l==null?void 0:l.result)==null?void 0:d.next)??(l==null?void 0:l.next),_=m!=null&&m!==""&&String(m)!=="0";u=g.length===s&&_,I()&&h.debug(`[Pagination] Stage: ${e}, Batch: ${g.length}, Total: ${i.length}, Start: ${o}, NextValue: ${m}, HasNext: ${_}, HasMore: ${u}`,"TicketRepository");try{const E=C();E&&I()&&(h.debug(`[Pagination Debug] Stage: ${e}, Batch: ${g.length}, Total: ${i.length}`,"TicketRepository",{resultStructure:{hasResult:!!(l!=null&&l.result),resultIsArray:Array.isArray(l==null?void 0:l.result),hasItems:!!((f=l==null?void 0:l.result)!=null&&f.items),hasData:!!((y=l==null?void 0:l.result)!=null&&y.data),hasNext:!!m,nextValue:m,nextType:typeof m,resultKeys:l!=null&&l.result?Object.keys(l.result):[]}}),E.logTicketsLoading(e,g.length,i.length,m||null))}catch(E){h.warn("Diagnostics logging error","TicketRepository",E)}if(u?a=o+s:a=i.length,n){const E=a>0?Math.min(100,i.length/a*100):0;n(P({step:"loading_tickets",percent:E,count:i.length,total:a}))}c=null}else u=!1}catch(l){if(h.error(`Error loading tickets batch for stage ${e} (start: ${o})`,"TicketRepository",l),o===0)throw c=l,new Error(`Не удалось загрузить тикеты для стадии ${e}: ${l.message||l}`);u=!1,n&&i.length>0&&n(S("loading_tickets",100,{count:i.length,total:i.length,warning:`Загружено частично: ${i.length} тикетов. Ошибка при загрузке остальных.`}))}if(c&&i.length===0)throw c;if(r){const l=p.getTicketsCacheKey(e);p.set(l,i,p.TICKETS_TTL)}return i}static async getTicket(e){return(await A.call("crm.item.get",{entityTypeId:k,id:e})).result||null}static async updateTicket(e,r){const i=(await A.call("crm.item.update",{entityTypeId:k,id:e,fields:r})).result===!0;return i&&p.invalidateTicketsCache(),i}static async createTicket(e){const r=await A.call("crm.item.add",{entityTypeId:k,fields:e}),n=r.result?parseInt(r.result):0;return n>0&&p.invalidateTicketsCache(),n}static async assignTicket(e,r,n){return await this.updateTicket(e,{assignedById:r,stageId:n})}}class mt{static async getEmployeesByIds(e,r=!0){if(!Array.isArray(e)||e.length===0)return[];if(r){const n=p.getEmployeesCacheKey(e),i=p.get(n);if(i!==null)return h.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),i}try{const n=await A.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let i=[];if(n&&n.result&&(Array.isArray(n.result)?i=n.result:h.warn("Unexpected user.get result format","EmployeeRepository",n)),r){const o=p.getEmployeesCacheKey(e);p.set(o,i,p.EMPLOYEES_TTL)}return i}catch(n){return h.error("Error getting employees by IDs","EmployeeRepository",n),[]}}}function G(t){return at[t]||"formed"}function K(t){return ot[t]||"DT140_12:UC_0VHWE2"}function yt(){return st()}function Z(t){return t==null?null:String(t).trim().toLowerCase()||null}const J=[{id:"1c-accounting",label:"1С.Бухгалтерия",bitrixValue:"1С.Бухгалтерия",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"Бухгалтерский контур 1С"},{id:"1c-tickets",label:"1С.Талоны",bitrixValue:"1С.Талоны",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"Работа с талонами 1С"},{id:"1c-zup",label:"1С.ЗУП",bitrixValue:"1С.ЗУП",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"Зарплата и управление персоналом"},{id:"1c-docflow",label:"1С.Документооборот",bitrixValue:"1С.Документооборот",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"Документооборот 1С"},{id:"1c-integrations",label:"1С.Интеграции",bitrixValue:"1С.Интеграции",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"Интеграции и сопряжения 1С"}],T={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых или неидентифицированных значений"},ht={},X={};[...J,T].forEach(t=>{ht[t.id]=t;const e=Z(t.bitrixValue);e&&(X[e]=t)});function pt(t){const e=Z(t);if(!e)return T;const r=X[e];return r||T}function St(){return T}function Et(){return[...J,T].sort((t,e)=>t.order-e.order)}function Tt(t){const e=t&&typeof t=="object"?t:T;return{color:e.color||T.color,backgroundColor:e.backgroundColor||T.backgroundColor,textColor:e.textColor||T.textColor}}Et();function Y(t){const e=parseInt(t.id||t.ID||0),r=t.title||t.TITLE||"Без названия",n=t.stageId||t.STAGE_ID||"",i=t.assignedById||t.ASSIGNED_BY_ID||null,o=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",s=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"",u=t.UF_SUBJECT||t.uf_subject||t.ufSubject||t.UF_SUBJECT||t.uf_subject||null,a=t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||t.ufCrm7DepartmentHead||t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||null;let c=null,d=null;if(a){const D=String(a).trim();D.length>0&&(d=D,c=D.length>17?D.substring(0,17):D)}const f=t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.ufCrm7UfPriority||t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.priority||t.PRIORITY||null,y=x(f),l=z(y),g=t.UF_SLA_SERVICE_STR||t.uf_sla_service_str||t.UfSlaServiceStr||t.ufSlaServiceStr||t.service||null,m=pt(g),_=Tt(m),E=t.UF_ACTION_STR||t.uf_action_str||t.UfActionStr||t.ufActionStr||t.UF_ACTION_STR||t.uf_action_str||null,$=E?String(E).trim():null,et=$&&$.length>0?$:null;return{id:e,title:r,ufSubject:u,departmentHead:c,departmentHeadFull:d,priorityId:y.id,priorityLabel:y.label,priorityColors:l,priority:y.id,priorityBitrixValue:y.bitrixValue||null,service:m,serviceLabel:m.label,serviceColors:_,serviceBitrixValue:m.bitrixValue||St().bitrixValue,actionStr:et,status:_t(),assigneeId:i?parseInt(i):null,stageId:G(n),createdAt:o,modifiedAt:s,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function _t(t){return"in_progress"}const B=new Map;function It(){B.clear()}function Ct(t){if(!t)return[];if(Array.isArray(t))return t.filter(r=>typeof r=="number"||!isNaN(parseInt(r))).map(r=>typeof r=="number"?r:parseInt(r));if(typeof t=="number")return[t];const e=parseInt(t);return isNaN(e)?[]:[e]}function At(t,e=!0){const r=t.id||t.ID;if(!t||!r)return null;if(e&&B.has(r))return B.get(r);const n=t.UF_DEPARTMENT||t.departmentId,i=Ct(n);for(const o of i)if(ct(o)){const u=o;return e&&B.set(r,u),u}return e&&B.set(r,null),null}function Dt(t){const e=At(t);return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"Неизвестный",position:t.WORK_POSITION||t.workPosition||"Сотрудник",email:t.EMAIL||t.email||"",sectorId:e,departmentId:t.UF_DEPARTMENT||null,tickets:[]}}function wt(t){return Array.isArray(t)?t.map(e=>Dt(e)):[]}const Rt="1C",Nt=["1С"],O=new Map,H=100;function Q(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function V(t){return t==null?null:String(t).trim().toUpperCase().replace(/С/g,"C")||null}function tt(t){if(!t)return[];if(Array.isArray(t))return t.map(V).filter(Boolean);if(typeof t=="object"&&t.value!==void 0){const r=V(t.value);return r?[r]:[]}const e=V(t);return e?e.split(/[;,]/).map(r=>r.trim()).filter(Boolean):[]}function W(t){const e=Q(t),r=tt(e);return r.length===0?!1:r.some(n=>n===Rt||Nt.includes(n))}function Bt(t){return`filter:${t.map(r=>r.id||r.ID||"").sort().join(",")}`}function Ot(){O.size>H&&Array.from(O.keys()).slice(0,Math.floor(H*.2)).forEach(e=>O.delete(e))}function kt(t){if(!Array.isArray(t))return[];const e=Bt(t),r=O.get(e);if(r!==void 0)return r;const n=t.filter(W);try{const i=C();if(i&&I()){const o=t.filter(a=>!W(a)),s=[],u=new Set;t.forEach(a=>{const c=Q(a),d=tt(c),f=c==null?"":String(c);c!=null&&!u.has(f)&&(u.add(f),s.push({value:c,normalized:d,type:typeof c,isArray:Array.isArray(c),ticketId:a.id||a.ID}))}),i.logFiltering(t.length,n.length,o,s)}}catch(i){console.warn("Diagnostics logging error in filterBySector:",i)}return O.set(e,n),Ot(),n}const F=1051;function L(t){if(!t||typeof t!="object")return null;let e=t.assignedById||t.ASSIGNED_BY_ID||t.assignedByIdId||t.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function j(t){if(t==null)return null;typeof t=="object"&&(t=t.id||t.ID||t.value||null);const e=typeof t=="number"?t:parseInt(t);return isNaN(e)||e<=0?null:e}function Mt(t,e=F){const r=L(t),n=j(r);return n===null||n===e}function Ft(t,e){Array.isArray(t)||(h.warn("Tickets is not an array","TicketGrouper",t),t=[]),Array.isArray(e)||(h.warn("Employees is not an array","TicketGrouper",e),e=[]);const r=e.filter(a=>(a.id?parseInt(a.id):null)!==F),n=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===b.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===b.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===b.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],i=new Map(n.map(a=>[a.id,a])),o=new Map;n.forEach(a=>{const c=new Map(a.employees.map(d=>[d.id,d]));o.set(a.id,c)});const s=[],u=[];t.forEach(a=>{const c=G(a.stageId||a.STAGE_ID||""),d=i.get(c);if(!d){u.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID,assignedById:L(a)});return}const f=L(a),y=j(f);if(y!==F)if(y){const l=o.get(c);let g=l.get(y);g||(g={id:y,name:`Сотрудник #${y}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},d.employees.push(g),l.set(y,g));const m=Y(a),_={...m,stageId:a.stageId||a.STAGE_ID||m.stageId,departmentHead:m.departmentHead||null,departmentHeadFull:m.departmentHeadFull||m.departmentHead||null};g.tickets.push(_),g.isFromSector1C?g.ticketsInsideSector.push(_):g.ticketsOutsideSector.push(_)}else s.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:c,assignedById:f})}),n.forEach(a=>{a.employees.sort((c,d)=>c.isFromSector1C&&!d.isFromSector1C?-1:!c.isFromSector1C&&d.isFromSector1C?1:(c.id||0)-(d.id||0))});try{const a=C();if(a&&I()){const c={};n.forEach(f=>{let y=0,l=0;f.employees.forEach(g=>{y+=(g.ticketsInsideSector||[]).length,l+=(g.ticketsOutsideSector||[]).length}),c[f.id]={insideSector:y,outsideSector:l,total:y+l}});const d=a.metrics.grouping;Object.keys(c).forEach(f=>{d.distributionByStages[f]||(d.distributionByStages[f]={employees:{},total:0}),d.distributionByStages[f].insideSector=c[f].insideSector,d.distributionByStages[f].outsideSector=c[f].outsideSector,d.distributionByStages[f].total=c[f].total}),a.logGrouping(n,s,u)}}catch(a){h.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",a)}return n}function Lt(t){const e={formed:[],review:[],execution:[]};if(!Array.isArray(t))return h.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",t),e;t.filter(r=>Mt(r)).forEach(r=>{const n=G(r.stageId||r.STAGE_ID||"");if(e[n]){const i=Y(r),o={...i,stageId:r.stageId||r.STAGE_ID||i.stageId,departmentHead:i.departmentHead||null,departmentHeadFull:i.departmentHeadFull||i.departmentHead||null};e[n].push(o)}});try{const r=C();r&&I()&&r.logZeroPoint(e)}catch(r){h.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",r)}return e}function $t(t){if(!Array.isArray(t))return[];const e=new Set,r=[],n=[];t.forEach(o=>{const s=L(o),u=j(s);!s||s===null||s===void 0?r.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:o.stageId||o.STAGE_ID}):u===F&&n.push({id:o.id||o.ID,title:o.title||o.TITLE||"Без названия",stageId:o.stageId||o.STAGE_ID}),u&&e.add(u)});const i=Array.from(e);try{const o=C();o&&I()&&o.logEmployees(i,r,n)}catch(o){h.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",o)}return i}const M=new Map,bt=10*60*1e3;function vt(t){if(!t||typeof t!="object")return{};const e={},r=Object.keys(t);for(const n of r)n.toUpperCase().startsWith("UF_")&&(e[n]=t[n]);return e}function Ut(t,e=null,r=!0){if(r&&e&&M.has(e)){const o=M.get(e),s=Date.now();if(o.timestamp&&s-o.timestamp<bt)return o.data;M.delete(e)}const n=vt(t),i={typeProduct:n.UF_CRM_7_TYPE_PRODUCT||n.uf_crm_7_type_product||n.ufCrm7TypeProduct||null,all:n};return r&&e&&M.set(e,{data:i,timestamp:Date.now()}),i}class Vt{static async getTicketDetails(e,r={}){const{select:n=["*"],useOriginalUfNames:i=!0,useCache:o=!0}=r;try{const s=await N.getTicket(e);if(!s)throw new Error(`Тикет с ID ${e} не найден`);const u=Ut(s,e,o),a=s.UF_CRM_7_UF_PRIORITY||s.uf_crm_7_uf_priority||s.ufCrm7UfPriority||s.UF_CRM_7_UF_PRIORITY||s.uf_crm_7_uf_priority||s.priority||s.PRIORITY||null,c=x(a),d=z(c);return{id:s.id||s.ID,title:s.title||s.TITLE,stageId:s.stageId||s.STAGE_ID,assignedById:s.assignedById||s.ASSIGNED_BY_ID,createdAt:s.createdTime||s.CREATED_TIME||s.CREATED_DATE,updatedAt:s.updatedTime||s.UPDATED_TIME||s.MODIFY_DATE,priorityId:c.id,priorityLabel:c.label,priorityColors:d,priority:c.id,priorityBitrixValue:c.bitrixValue||null,opportunity:s.opportunity||s.OPPORTUNITY,currencyId:s.currencyId||s.CURRENCY_ID,comments:s.comments||s.COMMENTS,additionalFields:u,rawData:s}}catch(s){throw h.error("Error getting ticket details","TicketDetailsService",s),s}}}class jt{static async getSectorData(e=!0,r=null){try{if(I()){const n=C();n&&n.reset()}}catch(n){h.warn("Error resetting diagnostics","DashboardSector1CService",n)}if(r&&r(S("cache_check",0,{description:"Инициализация загрузки..."})),e){const n=p.getSectorDataCacheKey(),i=p.get(n);if(i!==null)return r&&r(S("cache_hit",100,{description:"Данные загружены из кеша"})),i}try{r&&r(S("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const n=yt(),i=await N.getAllTickets(n,f=>{if(r){const y=P(f),l=q(10,40,y.progress||0);r(S(y.step||"loading_tickets",l,{...y.details,warning:y.details.warning}))}},e);r&&r(S("filtering",50,{totalTickets:i.length,description:`Фильтрация ${i.length} тикетов по сектору 1С...`}));const o=kt(i);r&&r(S("filtering",50,{totalTickets:i.length,filteredTickets:o.length,description:`Отфильтровано ${o.length} тикетов из ${i.length}`})),r&&r(S("extracting_employees",60,{filteredTickets:o.length,description:`Анализ ${o.length} тикетов для определения сотрудников...`}));const s=$t(o);r&&r(S("extracting_employees",60,{employeeCount:s.length,description:`Найдено ${s.length} уникальных сотрудников`})),r&&r(S("loading_employees",65,{employeeCount:s.length,description:`Загрузка данных ${s.length} сотрудников...`})),It();const u=await mt.getEmployeesByIds(s),a=wt(u);r&&r(S("loading_employees",90,{employeeCount:a.length,description:`Загружено данных ${a.length} сотрудников`})),r&&r(S("grouping",90,{filteredTickets:o.length,employeeCount:a.length,description:`Группировка ${o.length} тикетов по этапам и ${a.length} сотрудникам...`}));const d={stages:Ft(o,a),employees:a,zeroPointTickets:Lt(o)};if(r&&r(S("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),e){const f=p.getSectorDataCacheKey();p.set(f,d,p.TICKETS_TTL)}return r&&r(S("complete",100,{description:"Загрузка завершена"})),d}catch(n){throw h.error("Error getting sector data","DashboardSector1CService",n),r&&r({step:"error",progress:0,error:n.message}),n}}static async assignTicket(e,r,n){try{const i=K(n),o=await N.assignTicket(e,r,i);return o&&p.invalidateTicketsCache(),o}catch(i){throw h.error("Error assigning ticket","DashboardSector1CService",i),i}}static async createTicket(e){try{const r=K(e.stageId||"formed"),n={title:e.title,stageId:r};e.employeeId&&(n.assignedById=e.employeeId);const i=await N.createTicket(n);return i>0&&p.invalidateTicketsCache(),i}catch(r){throw h.error("Error creating ticket","DashboardSector1CService",r),r}}static async getTicket(e){try{const r=await N.getTicket(e);return Y(r)}catch(r){throw h.error("Error getting ticket","DashboardSector1CService",r),r}}static async getTicketDetails(e,r={}){try{return await Vt.getTicketDetails(e,r)}catch(n){throw h.error("Error getting ticket details","DashboardSector1CService",n),n}}static async addComment(e,r){try{return(await A.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+lt,comment:r}})).result!==void 0}catch(n){throw h.error("Error adding comment","DashboardSector1CService",n),n}}}export{p as C,jt as D,F as K,h as L,N as T,dt as a,G as b,It as c,St as d,Tt as e,C as g,I as i,Y as m,P as n};
