import{_ as A,g as D,c as b,a as p,o as c,b as e,t as m,F as $,e as U,n as I,d as F,f as R,G as L,H as T,m as O,j as S,S as N,L as G}from"./main-BJwoYdk9.js";import{F as V}from"./FiltersPanel-BQDkhcu0.js";import{L as E,D as j,B as x}from"./index-CqpxA4id.js";import"./bitrix24-api-Irr5mCDD.js";const P={class:"ac-chart"},Z={class:"ac-chart__header"},q={class:"ac-chart__subtitle"},z={class:"ac-chart__controls"},H={class:"chart-type-selector"},W=["onClick"],X={class:"chart-type-icon"},Y={class:"chart-type-label"},J={class:"ac-chart__summary"},K={class:"summary-card summary-card--new"},Q={class:"summary-card__value"},ee={class:"summary-card summary-card--closed"},se={class:"summary-card__value"},te={class:"summary-card summary-card--stages"},ae={class:"summary-card__tags"},oe={key:0,class:"stage-tag stage-tag--empty"},ne={class:"ac-chart__body"},le={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(l,{emit:o}){const n=l,v=o,i=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],a=D("line"),t=b(()=>{var g;return((g=n.meta)==null?void 0:g.weekNumber)??"â€”"}),y=b(()=>{var f,s;const g=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],d=Array.isArray((f=n.data.series)==null?void 0:f.new)?n.data.series.new:[n.data.newTickets||0],k=Array.isArray((s=n.data.series)==null?void 0:s.closed)?n.data.series.closed:[n.data.closedTickets||0];return{labels:g,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:d,backgroundColor:T.primary,borderColor:T.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:k,backgroundColor:T.success,borderColor:T.success,tension:.3,fill:!1}]}}),h=b(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[n.data.newTickets||0,n.data.closedTickets||0],backgroundColor:[T.primary,T.success],borderWidth:1}]})),u=b(()=>{switch(a.value){case"line":return E;case"bar":return x;case"doughnut":return j;default:return E}}),w=b(()=>a.value==="doughnut"?h.value:y.value),C=b(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var g;(((g=n.data)==null?void 0:g.responsible)||[]).length>0&&v("open-responsible")},scales:a.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(g,d)=>{var k,f;return c(),p("div",P,[e("header",Z,[e("div",null,[d[1]||(d[1]=e("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),e("p",q," ÐÐµÐ´ÐµÐ»Ñ "+m(t.value)+" Â· "+m(((k=l.meta)==null?void 0:k.weekStartUtc)||"â€”")+" â€” "+m(((f=l.meta)==null?void 0:f.weekEndUtc)||"â€”")+" (UTC) ",1)]),e("div",z,[e("div",H,[(c(),p($,null,U(i,s=>e("button",{key:s.value,class:I(["chart-type-btn",{active:a.value===s.value}]),onClick:r=>a.value=s.value},[e("span",X,m(s.icon),1),e("span",Y,m(s.label),1)],10,W)),64))]),e("button",{class:"btn-link",onClick:d[0]||(d[0]=s=>g.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),e("section",J,[e("div",K,[d[2]||(d[2]=e("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",Q,m(l.data.newTickets??0),1)]),e("div",ee,[d[3]||(d[3]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",se,m(l.data.closedTickets??0),1)]),e("div",te,[d[4]||(d[4]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),e("div",ae,[(c(!0),p($,null,U(l.data.stages||[],s=>(c(),p("span",{key:s.stageId,class:"stage-tag"},m(s.stageId)+" â€” "+m(s.count),1))),128)),!l.data.stages||l.data.stages.length===0?(c(),p("span",oe," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):F("",!0)])])]),e("div",ne,[(c(),R(L(u.value),{data:w.value,options:C.value},null,8,["data","options"]))])])}}},re=A(le,[["__scopeId","data-v-9edf003d"]]),ie={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},ce={class:"modal"},de={class:"modal__header"},ue={class:"modal__body"},me={key:0,class:"modal__empty"},pe={key:1,class:"responsible-list"},ve={class:"responsible-list__name"},he={class:"responsible-list__avatar","aria-hidden":"true"},ge={class:"responsible-list__count"},_e={class:"modal__footer"},be={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]}},setup(l){const o=l,n=b(()=>(o.responsible||[]).length>0);function v(i){if(!i)return"â€”";const a=String(i).trim().split(/\s+/);return a.length===1?a[0].charAt(0).toUpperCase():`${a[0].charAt(0)}${a[1].charAt(0)}`.toUpperCase()}return(i,a)=>l.isVisible?(c(),p("div",ie,[e("div",ce,[e("header",de,[a[2]||(a[2]=e("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("button",{class:"modal__close",onClick:a[0]||(a[0]=t=>i.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),e("section",ue,[n.value?(c(),p("ul",pe,[(c(!0),p($,null,U(l.responsible,t=>(c(),p("li",{key:t.id||t.name,class:"responsible-list__item"},[e("div",ve,[e("span",he,m(v(t.name)),1),e("span",null,m(t.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1)]),e("div",ge,m(t.count??0),1)]))),128))])):(c(),p("p",me,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),e("footer",_e,[e("button",{class:"btn",onClick:a[1]||(a[1]=t=>i.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])])):F("",!0)}},ye=A(be,[["__scopeId","data-v-ac5a8b81"]]),ke="/api/graph-1c-admission-closure.php";function fe(l){var n,v,i,a,t,y,h,u,w,C;if(!l)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const o=l.data||l.result||l;return{meta:o.meta||l.meta||null,data:{newTickets:((n=o.data)==null?void 0:n.newTickets)??o.newTickets??0,closedTickets:((v=o.data)==null?void 0:v.closedTickets)??o.closedTickets??0,series:{new:((a=(i=o.data)==null?void 0:i.series)==null?void 0:a.new)??((t=o.series)==null?void 0:t.new)??[0],closed:((h=(y=o.data)==null?void 0:y.series)==null?void 0:h.closed)??((u=o.series)==null?void 0:u.closed)??[0]},stages:((w=o.data)==null?void 0:w.stages)??o.stages??[],responsible:((C=o.data)==null?void 0:C.responsible)??o.responsible??[]}}}async function De(l={}){const{endpoint:o=ke,product:n="1C",weekStartUtc:v=null,weekEndUtc:i=null,useCache:a=!0,forceRefresh:t=!1}=l,h=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:n,weekStartUtc:v,weekEndUtc:i,useCache:a,forceRefresh:t})});if(!h.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${h.status})`);const u=await h.json();if((u==null?void 0:u.success)===!1)throw new Error(u.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return fe(u)}const we={class:"ac-dashboard"},Ce={key:1},Te={class:"dashboard-grid"},Re={class:"filters-column"},$e={class:"chart-column"},Ue={__name:"GraphAdmissionClosureDashboard",setup(l){const o=D(!0),n=D(null),v=D(null),i=D({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),a=D(!1),t=D({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),y=b(()=>{const s=t.value.customDateRange.startDate||t.value.customDateRange.endDate,r=t.value.employees.length===1&&t.value.employees.includes("all");return s||!r});async function h(){o.value=!0,n.value=null;try{const s=f(),{meta:r,data:_}=await De({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc});v.value=r,i.value=_}catch(s){n.value=s instanceof Error?s:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",s)}finally{o.value=!1}}function u(s){t.value.stages=s}function w(s){t.value.employees=s}function C(s){t.value.dateRange=s}function g(s){t.value.customDateRange=s}function d(){t.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},k()}function k(){h()}O(()=>{h()});function f(){const s=new Date;let r=new Date(s),_=new Date(s);switch(t.value.dateRange){case"last-2-weeks":r.setDate(s.getDate()-14);break;case"last-month":r.setMonth(s.getMonth()-1);break;case"custom":t.value.customDateRange.startDate&&(r=new Date(t.value.customDateRange.startDate+"T00:00:00Z")),t.value.customDateRange.endDate&&(_=new Date(t.value.customDateRange.endDate+"T23:59:59Z"));break;case"last-week":default:r.setDate(s.getDate()-7);break}const M=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0)).toISOString(),B=new Date(Date.UTC(_.getUTCFullYear(),_.getUTCMonth(),_.getUTCDate(),23,59,59)).toISOString();return{weekStartUtc:M,weekEndUtc:B}}return(s,r)=>(c(),p("div",we,[o.value?(c(),R(G,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(c(),p("div",Ce,[r[2]||(r[2]=e("div",{class:"dashboard-header"},[e("div",null,[e("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),e("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),e("div",Te,[e("div",Re,[S(V,{stages:t.value.stages,employees:t.value.employees,dateRange:t.value.dateRange,customDateRange:t.value.customDateRange,hasActiveFilters:y.value,hideStages:!0,"onUpdate:stages":u,"onUpdate:employees":w,"onUpdate:dateRange":C,"onUpdate:customDateRange":g,onReset:d,onApply:k},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),e("div",$e,[n.value?(c(),R(N,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:n.value.message},null,8,["message"])):(c(),R(re,{key:1,meta:v.value,data:i.value,onOpenResponsible:r[0]||(r[0]=_=>a.value=!0)},null,8,["meta","data"]))])])])),S(ye,{"is-visible":a.value,responsible:i.value.responsible||[],onClose:r[1]||(r[1]=_=>a.value=!1)},null,8,["is-visible","responsible"])]))}},Me=A(Ue,[["__scopeId","data-v-92f3df3e"]]);export{Me as default};
