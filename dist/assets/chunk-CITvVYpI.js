import{L as i,g as _}from"./main-BkR2BEYx.js";let g=null;class l{static initialize(){typeof window<"u"&&window.BX24?(g=window.BX24,i.info("Using BX24 API directly","ApiClient")):(g={call:async(e,t)=>{switch(i.info(`Mock API call: ${e}`,"ApiClient",t),await new Promise(r=>setTimeout(r,100)),e){case"bizproc.smartprocess.list":return{result:[{ID:"1",TITLE:"Test Ticket 1",CREATED_TIME:"2026-01-12T10:00:00Z",STAGE_ID:"DT140_12:NEW",ASSIGNED_BY_ID:"1013",UF_CRM_7_TYPE_PRODUCT:"PDM"},{ID:"2",TITLE:"Test Ticket 2",CREATED_TIME:"2026-01-12T11:00:00Z",STAGE_ID:"DT140_12:ANALYSIS",ASSIGNED_BY_ID:"1014",UF_CRM_7_TYPE_PRODUCT:"PDM"}],total:2};case"user.get":const r=[{ID:"1013",NAME:"ÐœÐ°Ñ€Ðº",LAST_NAME:"Ð¢ÐµÑÑ‚Ð¾Ð²",DEPARTMENT:[369]},{ID:"1014",NAME:"Ð˜Ð²Ð°Ð½",LAST_NAME:"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº",DEPARTMENT:[369]},{ID:"1015",NAME:"ÐÐ½Ð½Ð°",LAST_NAME:"ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€",DEPARTMENT:[369]}];let o=r;return t.filter&&t.filter.ID&&(o=r.filter(c=>c.ID===t.filter.ID)),{result:o};default:return i.warn(`Unknown method ${e}, returning empty result`,"ApiClient"),{result:[]}}}},i.info("Using mock API for development","ApiClient"))}static async call(e,t={}){g||this.initialize();try{i.debug(`Calling ${e}`,"ApiClient",{params:t});const r=await g.call(e,t);return i.debug(`Call ${e} completed`,"ApiClient"),r}catch(r){throw i.error(`Call ${e} failed`,"ApiClient",r),r}}static async getSmartProcessItems(e){const{entityTypeId:t,select:r=["*"],filter:o={},order:c={},limit:n=50}=e,E={entityTypeId:t,select:r,filter:o,order:c,limit:n},d=await this.call("bizproc.smartprocess.list",E);return d.items||d.result||[]}static async getSmartProcessItem(e,t){const{entityTypeId:r,select:o=["*"]}=t,c={entityTypeId:r,id:e,select:o},n=await this.call("bizproc.smartprocess.get",c);return n.item||n.result||null}static async updateSmartProcessItem(e,t,r={}){const{entityTypeId:o}=r,c={entityTypeId:o,id:e,fields:t};return await this.call("bizproc.smartprocess.update",c)}}l.initialize();class N{static async getAllTickets(e={}){try{i.info("Loading all tickets from Bitrix24","TicketRepository");const t=await l.getSmartProcessItems({entityTypeId:e.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e.filter||{},order:{CREATED_TIME:"DESC"}});return i.info(`Loaded ${t.length} tickets`,"TicketRepository"),t}catch(t){throw i.error("Failed to load tickets","TicketRepository",t),t}}static async getTicketsByFilter(e,t={}){try{i.info("Loading filtered tickets","TicketRepository",{filter:e});const r=await l.getSmartProcessItems({entityTypeId:t.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e,order:{CREATED_TIME:"DESC"}});return i.info(`Loaded ${r.length} filtered tickets`,"TicketRepository"),r}catch(r){throw i.error("Failed to load filtered tickets","TicketRepository",r),r}}static async getTicketById(e){try{return i.info(`Loading ticket ${e}`,"TicketRepository"),await l.getSmartProcessItem(e,{entityTypeId:140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"]})}catch(t){throw i.error(`Failed to load ticket ${e}`,"TicketRepository",t),t}}}class C{static async getAllEmployees(e={}){try{i.info("Loading all employees from Bitrix24","EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y"},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return i.info(`Loaded ${t.length} employees`,"EmployeeRepository"),t}catch(t){throw i.error("Failed to load employees","EmployeeRepository",t),t}}static async getEmployeeById(e){try{return i.info(`Loading employee ${e}`,"EmployeeRepository"),(await l.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]}))[0]||null}catch(t){throw i.error(`Failed to load employee ${e}`,"EmployeeRepository",t),t}}static async getEmployeesByIds(e){try{if(i.info(`Loading employees by IDs: ${e.join(", ")}`,"EmployeeRepository"),!e||e.length===0)return[];const t=[];for(const r of e)try{const o=await this.getEmployeeById(r);o&&t.push(o)}catch{i.warn(`Failed to load employee ${r}, skipping`,"EmployeeRepository")}return i.info(`Loaded ${t.length} employees out of ${e.length} requested`,"EmployeeRepository"),t}catch(t){throw i.error("Failed to load employees by IDs","EmployeeRepository",t),t}}static async getEmployeesByDepartment(e){try{i.info(`Loading employees for department ${e}`,"EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y",UF_DEPARTMENT:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return i.info(`Loaded ${t.length} employees for department ${e}`,"EmployeeRepository"),t}catch(t){throw i.error(`Failed to load employees for department ${e}`,"EmployeeRepository",t),t}}}class m{constructor(e){this.sectorId=e,this.cache=new Map,this.cacheTimestamps=new Map,this.defaultTtl=5*60*1e3}get(e){const t=`${this.sectorId}:${e}`;if(!this.cache.has(t))return null;const r=this.cacheTimestamps.get(t);return Date.now()-r>this.defaultTtl?(i.debug(`Cache expired for key: ${t}`,"CacheManager"),this.cache.delete(t),this.cacheTimestamps.delete(t),null):(i.debug(`Cache hit for key: ${t}`,"CacheManager"),this.cache.get(t))}set(e,t,r=this.defaultTtl){const o=`${this.sectorId}:${e}`,c=Date.now();this.cache.set(o,t),this.cacheTimestamps.set(o,c),i.debug(`Cache set for key: ${o}, TTL: ${r}ms`,"CacheManager")}clear(){const e=[];for(const t of this.cache.keys())t.startsWith(`${this.sectorId}:`)&&e.push(t);e.forEach(t=>{this.cache.delete(t),this.cacheTimestamps.delete(t)}),i.info(`Cache cleared for sector: ${this.sectorId}, ${e.length} entries`,"CacheManager")}clearAll(){const e=this.cache.size;this.cache.clear(),this.cacheTimestamps.clear(),i.info(`All cache cleared, ${e} entries removed`,"CacheManager")}getStats(){const e=Array.from(this.cache.keys()).filter(t=>t.startsWith(`${this.sectorId}:`));return{totalEntries:this.cache.size,sectorEntries:e.length,otherEntries:this.cache.size-e.length}}}const p=140,a={NEW:"DT140_12:NEW",ANALYSIS:"DT140_12:ANALYSIS",DEVELOPMENT:"DT140_12:DEVELOPMENT",TESTING:"DT140_12:TESTING",DEPLOYMENT:"DT140_12:DEPLOYMENT",CLOSED:"DT140_12:CLOSED"},f={[a.NEW]:"ÐÐ¾Ð²Ñ‹Ð¹",[a.ANALYSIS]:"ÐÐ½Ð°Ð»Ð¸Ð·",[a.DEVELOPMENT]:"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°",[a.TESTING]:"Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ",[a.DEPLOYMENT]:"Ð’Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ",[a.CLOSED]:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚"},h={[a.NEW]:"#007bff",[a.ANALYSIS]:"#ffc107",[a.DEVELOPMENT]:"#28a745",[a.TESTING]:"#17a2b8",[a.DEPLOYMENT]:"#6f42c1",[a.CLOSED]:"#6c757d"};function $(){return[{id:a.NEW,name:f[a.NEW],color:h[a.NEW],order:1},{id:a.ANALYSIS,name:f[a.ANALYSIS],color:h[a.ANALYSIS],order:2},{id:a.DEVELOPMENT,name:f[a.DEVELOPMENT],color:h[a.DEVELOPMENT],order:3},{id:a.TESTING,name:f[a.TESTING],color:h[a.TESTING],order:4},{id:a.DEPLOYMENT,name:f[a.DEPLOYMENT],color:h[a.DEPLOYMENT],order:5},{id:a.CLOSED,name:f[a.CLOSED],color:h[a.CLOSED],order:6}]}function L(s){try{if(!s)return i.warn("getSectorFilterValues: sectorConfig is null or undefined","sector-config-helper"),[];const{filterValue:e,filterValues:t,id:r,name:o}=s;let c=null;if(Array.isArray(e)?c=e:Array.isArray(t)?c=t:e!=null&&(c=[e]),!c||c.length===0)return i.warn(`Sector ${r||"unknown"} has no filter values`,"sector-config-helper"),[];const n=c.filter(E=>E!=null&&E!=="");return i.debug(`Sector ${r} filter values: ${n.join(", ")}`,"sector-config-helper"),n}catch(e){return i.error(`Error getting filter values for sector ${s?.id||"unknown"}`,"sector-config-helper",e),[]}}function M(s){try{const e=L(s),t=s.filterField||"UF_CRM_7_TYPE_PRODUCT";return e.length===0?`${t} = (no filter)`:e.length===1?`${t} = '${e[0]}'`:`${t} IN (${e.map(r=>`'${r}'`).join(", ")})`}catch(e){return i.error("Error getting sector filter description","sector-config-helper",e),"Error generating description"}}function R(s){const e={};return Object.values(a).forEach(t=>{e[t]=[]}),s.forEach(t=>{const r=t.STAGE_ID||t.stageId||a.NEW;e[r]?e[r].push(t):e[a.NEW].push(t)}),i.debug("Tickets grouped by stages","TicketGrouper",{totalTickets:s.length,stagesWithTickets:Object.values(e).filter(t=>t.length>0).length}),e}function w(s){const e=new Set;return s.forEach(t=>{t.ASSIGNED_BY_ID&&e.add(t.ASSIGNED_BY_ID),t.CREATED_BY_ID&&e.add(t.CREATED_BY_ID),t.UF_RESPONSIBLE&&(Array.isArray(t.UF_RESPONSIBLE)?t.UF_RESPONSIBLE.forEach(r=>e.add(r)):e.add(t.UF_RESPONSIBLE))}),Array.from(e)}function u(s){try{Object.keys(localStorage).forEach(r=>{r.startsWith(`sector-${s}-`)&&localStorage.removeItem(r)}),Object.keys(sessionStorage).forEach(r=>{r.startsWith(`sector-${s}-`)&&sessionStorage.removeItem(r)}),i.info(`Sector cache cleared for: ${s}`,"SectorHelper")}catch(e){i.error(`Failed to clear sector cache for: ${s}`,"SectorHelper",e)}}function T(){try{return localStorage.getItem("sector-dashboard-diagnostics")==="true"}catch{return!1}}function P(){return{log:(s,e={})=>{T()&&(i.info(`[DIAGNOSTICS] ${s}`,"DiagnosticsService",e),console.log(`ðŸ” [DIAGNOSTICS] ${s}`,e))},measureTime:s=>{if(!T())return()=>{};const e=performance.now();return()=>{const r=performance.now()-e;i.info(`[DIAGNOSTICS] ${s} took ${r.toFixed(2)}ms`,"DiagnosticsService"),console.log(`â±ï¸ [DIAGNOSTICS] ${s}: ${r.toFixed(2)}ms`)}},checkServicesStatus:async s=>{if(!T())return{};const e={sectorId:s,timestamp:new Date().toISOString(),services:{}};try{const t=["TicketRepository","EmployeeRepository","ApiClient"];for(const r of t)try{e.services[r]={available:!0,lastCheck:new Date().toISOString()}}catch(o){e.services[r]={available:!1,error:o.message,lastCheck:new Date().toISOString()}}}catch(t){i.error("Failed to check services status","DiagnosticsService",t)}return i.info("Services status checked","DiagnosticsService",e),e},getPerformanceInfo:()=>{if(!T())return{};const s={timestamp:new Date().toISOString(),memory:{},timing:{}};try{performance.memory&&(s.memory={usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}),performance.timing&&(s.timing={navigationStart:performance.timing.navigationStart,loadEventEnd:performance.timing.loadEventEnd,domContentLoadedEventEnd:performance.timing.domContentLoadedEventEnd,totalLoadTime:performance.timing.loadEventEnd-performance.timing.navigationStart})}catch(e){i.error("Failed to get performance info","DiagnosticsService",e)}return s}}}class O{constructor(e,t){this.sectorId=e,this.config={name:t.name,filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:t.filterValue,...t},i.info(`DashboardSectorBaseService initialized for sector: ${e}`,"DashboardSectorBaseService")}async getSectorData(e={}){const t=e.useCache!==!1;e.useBackendCache;const r=e.onProgress||null;try{if(T()){const o=P();o&&o.reset()}}catch(o){i.warn("Error resetting diagnostics","DashboardSectorBaseService",o)}r&&r({step:"initialization",progress:0,details:{description:`Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name}...`}});try{r&&r({step:"loading_tickets",progress:10,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð¸Ð· Bitrix24...`}});const o={};o[this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"]=this.config.filterValue;const c=await N.getTicketsByFilter(o,{entityTypeId:p}),n=_(c,{id:this.sectorId,name:this.config.name,filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"});i.info(`Sector filtering completed for ${this.config.name}`,"DashboardSectorBaseService",{sectorId:this.sectorId,totalTickets:c.length,filteredTickets:n.length,filterDescription:M({filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"})}),r&&r({step:"extracting_employees",progress:55,details:{description:"Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²..."}});const E=w(n),d=await C.getEmployeesByIds(E);r&&r({step:"grouping_tickets",progress:85,details:{description:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼..."}});const D=$(),{stages:y,zeroPointTickets:I}=R(n,d,D),S={stages:y,employees:d,zeroPointTickets:I,metadata:{sectorId:this.sectorId,sectorName:this.config.name,filterValue:this.config.filterValue,totalTickets:n.length,totalEmployees:d.length,lastUpdated:new Date().toISOString()}};if(t){const A=m.getSectorDataCacheKey(this.sectorId);m.set(A,S),i.info(`Sector data cached for ${this.sectorId}`,"DashboardSectorBaseService")}return r&&r({step:"completed",progress:100,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°`,totalTickets:n.length,totalEmployees:d.length}}),i.info(`Sector data loaded successfully for ${this.sectorId}`,"DashboardSectorBaseService",{totalTickets:n.length,totalEmployees:d.length,stagesCount:y.length}),S}catch(o){throw i.error(`Error loading sector data for ${this.sectorId}`,"DashboardSectorBaseService",o),r&&r({step:"error",progress:0,details:{description:`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ${o.message}`,error:!0}}),o}}async updateTicketAssignment(e,t,r){try{i.info(`Updating ticket assignment: ${e} -> ${t} -> ${r}`,"DashboardSectorBaseService");const o=await l.call("crm.item.update",{entityTypeId:p,id:e,fields:{stageId:t,assignedById:r}});return u(this.sectorId),i.info(`Ticket assignment updated successfully: ${e}`,"DashboardSectorBaseService"),o}catch(o){throw i.error(`Error updating ticket assignment: ${e}`,"DashboardSectorBaseService",o),o}}async createTicket(e){try{i.info("Creating new ticket","DashboardSectorBaseService",e);const t=await l.call("crm.item.add",{entityTypeId:p,fields:{...e,[this.config.filterField]:this.config.filterValue}});return u(this.sectorId),i.info(`Ticket created successfully: ${t.result}`,"DashboardSectorBaseService"),{id:t.result,...e}}catch(t){throw i.error("Error creating ticket","DashboardSectorBaseService",t),t}}}export{O as D};
