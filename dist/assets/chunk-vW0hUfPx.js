import{L as i,g as A}from"./main-DwVwFveI.js";let S=null;class l{static initialize(){typeof window<"u"&&window.BX24?(S=window.BX24,i.info("Using BX24 API directly","ApiClient")):(S={call:async(e,t)=>{const r=await fetch("/api/bitrix24/proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({method:e,params:t})});if(!r.ok)throw new Error(`API call failed: ${r.status}`);return await r.json()}},i.info("Using proxy API","ApiClient"))}static async call(e,t={}){S||this.initialize();try{i.debug(`Calling ${e}`,"ApiClient",{params:t});const r=await S.call(e,t);return i.debug(`Call ${e} completed`,"ApiClient"),r}catch(r){throw i.error(`Call ${e} failed`,"ApiClient",r),r}}static async getSmartProcessItems(e){const{entityTypeId:t,select:r=["*"],filter:a={},order:c={},limit:n=50}=e,f={entityTypeId:t,select:r,filter:a,order:c,limit:n},d=await this.call("bizproc.smartprocess.list",f);return d.items||d.result||[]}static async getSmartProcessItem(e,t){const{entityTypeId:r,select:a=["*"]}=t,c={entityTypeId:r,id:e,select:a},n=await this.call("bizproc.smartprocess.get",c);return n.item||n.result||null}static async updateSmartProcessItem(e,t,r={}){const{entityTypeId:a}=r,c={entityTypeId:a,id:e,fields:t};return await this.call("bizproc.smartprocess.update",c)}}l.initialize();class C{static async getAllTickets(e={}){try{i.info("Loading all tickets from Bitrix24","TicketRepository");const t=await l.getSmartProcessItems({entityTypeId:e.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e.filter||{},order:{CREATED_TIME:"DESC"}});return i.info(`Loaded ${t.length} tickets`,"TicketRepository"),t}catch(t){throw i.error("Failed to load tickets","TicketRepository",t),t}}static async getTicketsByFilter(e,t={}){try{i.info("Loading filtered tickets","TicketRepository",{filter:e});const r=await l.getSmartProcessItems({entityTypeId:t.entityTypeId||140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"],filter:e,order:{CREATED_TIME:"DESC"}});return i.info(`Loaded ${r.length} filtered tickets`,"TicketRepository"),r}catch(r){throw i.error("Failed to load filtered tickets","TicketRepository",r),r}}static async getTicketById(e){try{return i.info(`Loading ticket ${e}`,"TicketRepository"),await l.getSmartProcessItem(e,{entityTypeId:140,select:["ID","TITLE","CREATED_TIME","MOVED_TIME","UF_*","ASSIGNED_BY_ID","CREATED_BY_ID","STAGE_ID"]})}catch(t){throw i.error(`Failed to load ticket ${e}`,"TicketRepository",t),t}}}class N{static async getAllEmployees(e={}){try{i.info("Loading all employees from Bitrix24","EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y"},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return i.info(`Loaded ${t.length} employees`,"EmployeeRepository"),t}catch(t){throw i.error("Failed to load employees","EmployeeRepository",t),t}}static async getEmployeeById(e){try{return i.info(`Loading employee ${e}`,"EmployeeRepository"),(await l.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]}))[0]||null}catch(t){throw i.error(`Failed to load employee ${e}`,"EmployeeRepository",t),t}}static async getEmployeesByDepartment(e){try{i.info(`Loading employees for department ${e}`,"EmployeeRepository");const t=await l.call("user.get",{filter:{ACTIVE:"Y",UF_DEPARTMENT:e},select:["ID","NAME","LAST_NAME","DEPARTMENT","UF_*"]});return i.info(`Loaded ${t.length} employees for department ${e}`,"EmployeeRepository"),t}catch(t){throw i.error(`Failed to load employees for department ${e}`,"EmployeeRepository",t),t}}}class u{constructor(e){this.sectorId=e,this.cache=new Map,this.cacheTimestamps=new Map,this.defaultTtl=5*60*1e3}get(e){const t=`${this.sectorId}:${e}`;if(!this.cache.has(t))return null;const r=this.cacheTimestamps.get(t);return Date.now()-r>this.defaultTtl?(i.debug(`Cache expired for key: ${t}`,"CacheManager"),this.cache.delete(t),this.cacheTimestamps.delete(t),null):(i.debug(`Cache hit for key: ${t}`,"CacheManager"),this.cache.get(t))}set(e,t,r=this.defaultTtl){const a=`${this.sectorId}:${e}`,c=Date.now();this.cache.set(a,t),this.cacheTimestamps.set(a,c),i.debug(`Cache set for key: ${a}, TTL: ${r}ms`,"CacheManager")}clear(){const e=[];for(const t of this.cache.keys())t.startsWith(`${this.sectorId}:`)&&e.push(t);e.forEach(t=>{this.cache.delete(t),this.cacheTimestamps.delete(t)}),i.info(`Cache cleared for sector: ${this.sectorId}, ${e.length} entries`,"CacheManager")}clearAll(){const e=this.cache.size;this.cache.clear(),this.cacheTimestamps.clear(),i.info(`All cache cleared, ${e} entries removed`,"CacheManager")}getStats(){const e=Array.from(this.cache.keys()).filter(t=>t.startsWith(`${this.sectorId}:`));return{totalEntries:this.cache.size,sectorEntries:e.length,otherEntries:this.cache.size-e.length}}}const m=140,o={NEW:"DT140_12:NEW",ANALYSIS:"DT140_12:ANALYSIS",DEVELOPMENT:"DT140_12:DEVELOPMENT",TESTING:"DT140_12:TESTING",DEPLOYMENT:"DT140_12:DEPLOYMENT",CLOSED:"DT140_12:CLOSED"},h={[o.NEW]:"ÐÐ¾Ð²Ñ‹Ð¹",[o.ANALYSIS]:"ÐÐ½Ð°Ð»Ð¸Ð·",[o.DEVELOPMENT]:"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°",[o.TESTING]:"Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ",[o.DEPLOYMENT]:"Ð’Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ",[o.CLOSED]:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚"},E={[o.NEW]:"#007bff",[o.ANALYSIS]:"#ffc107",[o.DEVELOPMENT]:"#28a745",[o.TESTING]:"#17a2b8",[o.DEPLOYMENT]:"#6f42c1",[o.CLOSED]:"#6c757d"};function $(){return[{id:o.NEW,name:h[o.NEW],color:E[o.NEW],order:1},{id:o.ANALYSIS,name:h[o.ANALYSIS],color:E[o.ANALYSIS],order:2},{id:o.DEVELOPMENT,name:h[o.DEVELOPMENT],color:E[o.DEVELOPMENT],order:3},{id:o.TESTING,name:h[o.TESTING],color:E[o.TESTING],order:4},{id:o.DEPLOYMENT,name:h[o.DEPLOYMENT],color:E[o.DEPLOYMENT],order:5},{id:o.CLOSED,name:h[o.CLOSED],color:E[o.CLOSED],order:6}]}function L(s){try{if(!s)return i.warn("getSectorFilterValues: sectorConfig is null or undefined","sector-config-helper"),[];const{filterValue:e,filterValues:t,id:r,name:a}=s;let c=null;if(Array.isArray(e)?c=e:Array.isArray(t)?c=t:e!=null&&(c=[e]),!c||c.length===0)return i.warn(`Sector ${r||"unknown"} has no filter values`,"sector-config-helper"),[];const n=c.filter(f=>f!=null&&f!=="");return i.debug(`Sector ${r} filter values: ${n.join(", ")}`,"sector-config-helper"),n}catch(e){return i.error(`Error getting filter values for sector ${s?.id||"unknown"}`,"sector-config-helper",e),[]}}function w(s){try{const e=L(s),t=s.filterField||"UF_CRM_7_TYPE_PRODUCT";return e.length===0?`${t} = (no filter)`:e.length===1?`${t} = '${e[0]}'`:`${t} IN (${e.map(r=>`'${r}'`).join(", ")})`}catch(e){return i.error("Error getting sector filter description","sector-config-helper",e),"Error generating description"}}function k(s){const e={};return Object.values(o).forEach(t=>{e[t]=[]}),s.forEach(t=>{const r=t.STAGE_ID||t.stageId||o.NEW;e[r]?e[r].push(t):e[o.NEW].push(t)}),i.debug("Tickets grouped by stages","TicketGrouper",{totalTickets:s.length,stagesWithTickets:Object.values(e).filter(t=>t.length>0).length}),e}function O(s){const e=new Set;return s.forEach(t=>{t.ASSIGNED_BY_ID&&e.add(t.ASSIGNED_BY_ID),t.CREATED_BY_ID&&e.add(t.CREATED_BY_ID),t.UF_RESPONSIBLE&&(Array.isArray(t.UF_RESPONSIBLE)?t.UF_RESPONSIBLE.forEach(r=>e.add(r)):e.add(t.UF_RESPONSIBLE))}),Array.from(e)}function D(s){try{Object.keys(localStorage).forEach(r=>{r.startsWith(`sector-${s}-`)&&localStorage.removeItem(r)}),Object.keys(sessionStorage).forEach(r=>{r.startsWith(`sector-${s}-`)&&sessionStorage.removeItem(r)}),i.info(`Sector cache cleared for: ${s}`,"SectorHelper")}catch(e){i.error(`Failed to clear sector cache for: ${s}`,"SectorHelper",e)}}function g(){try{return localStorage.getItem("sector-dashboard-diagnostics")==="true"}catch{return!1}}function M(){return{log:(s,e={})=>{g()&&(i.info(`[DIAGNOSTICS] ${s}`,"DiagnosticsService",e),console.log(`ðŸ” [DIAGNOSTICS] ${s}`,e))},measureTime:s=>{if(!g())return()=>{};const e=performance.now();return()=>{const r=performance.now()-e;i.info(`[DIAGNOSTICS] ${s} took ${r.toFixed(2)}ms`,"DiagnosticsService"),console.log(`â±ï¸ [DIAGNOSTICS] ${s}: ${r.toFixed(2)}ms`)}},checkServicesStatus:async s=>{if(!g())return{};const e={sectorId:s,timestamp:new Date().toISOString(),services:{}};try{const t=["TicketRepository","EmployeeRepository","ApiClient"];for(const r of t)try{e.services[r]={available:!0,lastCheck:new Date().toISOString()}}catch(a){e.services[r]={available:!1,error:a.message,lastCheck:new Date().toISOString()}}}catch(t){i.error("Failed to check services status","DiagnosticsService",t)}return i.info("Services status checked","DiagnosticsService",e),e},getPerformanceInfo:()=>{if(!g())return{};const s={timestamp:new Date().toISOString(),memory:{},timing:{}};try{performance.memory&&(s.memory={usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}),performance.timing&&(s.timing={navigationStart:performance.timing.navigationStart,loadEventEnd:performance.timing.loadEventEnd,domContentLoadedEventEnd:performance.timing.domContentLoadedEventEnd,totalLoadTime:performance.timing.loadEventEnd-performance.timing.navigationStart})}catch(e){i.error("Failed to get performance info","DiagnosticsService",e)}return s}}}class P{constructor(e,t){this.sectorId=e,this.config={name:t.name,filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:t.filterValue,...t},i.info(`DashboardSectorBaseService initialized for sector: ${e}`,"DashboardSectorBaseService")}async getSectorData(e={}){const t=e.useCache!==!1;e.useBackendCache;const r=e.onProgress||null;try{if(g()){const a=M();a&&a.reset()}}catch(a){i.warn("Error resetting diagnostics","DashboardSectorBaseService",a)}r&&r({step:"initialization",progress:0,details:{description:`Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name}...`}});try{r&&r({step:"loading_tickets",progress:10,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð¸Ð· Bitrix24...`}});const a={};a[this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"]=this.config.filterValue;const c=await C.getTicketsByFilter(a,{entityTypeId:m}),n=A(c,{id:this.sectorId,name:this.config.name,filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"});i.info(`Sector filtering completed for ${this.config.name}`,"DashboardSectorBaseService",{sectorId:this.sectorId,totalTickets:c.length,filteredTickets:n.length,filterDescription:w({filterValue:this.config.filterValue,filterField:this.config.filterField||"UF_CRM_7_TYPE_PRODUCT"})}),r&&r({step:"extracting_employees",progress:55,details:{description:"Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²..."}});const f=O(n),d=await N.getEmployeesByIds(f,p=>{r&&r({step:"loading_employees",progress:55+(p.progress||0)*.3,details:p.details||{}})});r&&r({step:"grouping_tickets",progress:85,details:{description:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼..."}});const I=$(),{stages:y,zeroPointTickets:_}=k(n,d,I),T={stages:y,employees:d,zeroPointTickets:_,metadata:{sectorId:this.sectorId,sectorName:this.config.name,filterValue:this.config.filterValue,totalTickets:n.length,totalEmployees:d.length,lastUpdated:new Date().toISOString()}};if(t){const p=u.getSectorDataCacheKey(this.sectorId);u.set(p,T),i.info(`Sector data cached for ${this.sectorId}`,"DashboardSectorBaseService")}return r&&r({step:"completed",progress:100,details:{description:`Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐµÐºÑ‚Ð¾Ñ€Ð° ${this.config.name} Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°`,totalTickets:n.length,totalEmployees:d.length}}),i.info(`Sector data loaded successfully for ${this.sectorId}`,"DashboardSectorBaseService",{totalTickets:n.length,totalEmployees:d.length,stagesCount:y.length}),T}catch(a){throw i.error(`Error loading sector data for ${this.sectorId}`,"DashboardSectorBaseService",a),r&&r({step:"error",progress:0,details:{description:`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ${a.message}`,error:!0}}),a}}async updateTicketAssignment(e,t,r){try{i.info(`Updating ticket assignment: ${e} -> ${t} -> ${r}`,"DashboardSectorBaseService");const a=await l.call("crm.item.update",{entityTypeId:m,id:e,fields:{stageId:t,assignedById:r}});return D(this.sectorId),i.info(`Ticket assignment updated successfully: ${e}`,"DashboardSectorBaseService"),a}catch(a){throw i.error(`Error updating ticket assignment: ${e}`,"DashboardSectorBaseService",a),a}}async createTicket(e){try{i.info("Creating new ticket","DashboardSectorBaseService",e);const t=await l.call("crm.item.add",{entityTypeId:m,fields:{...e,[this.config.filterField]:this.config.filterValue}});return D(this.sectorId),i.info(`Ticket created successfully: ${t.result}`,"DashboardSectorBaseService"),{id:t.result,...e}}catch(t){throw i.error("Error creating ticket","DashboardSectorBaseService",t),t}}}export{P as D};
