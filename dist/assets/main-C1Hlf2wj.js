const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./chunk-BBmTsmYU.js","./chunk-D2N1ELIn.js","./chunk-C8Cm5yGW.js","./chunk-2JzEd2ES.js","./chunk-X743aslj.js","./direct-access-config-DVmJvOqu.js","./access-config-async-UCYEgjZx.js","./chunk-BxL3V5Fo.js","./WebhookLogsDashboard.vue-2ycfSFAM.js","./WebhookLogDetails.vue-DDlUTWKd.js"])))=>i.map(i=>d[i]);
var qa=Object.defineProperty;var Ya=(o,e,s)=>e in o?qa(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var je=(o,e,s)=>Ya(o,typeof e!="symbol"?e+"":e,s);import{r as be,c as u,o as c,a as ne,b as $,d as ma,t as m,n as X,e as a,f as he,g as I,h as $e,u as Xe,i as ps,j as M,w as pe,T as Ae,F as ee,k as te,l as we,m as ce,p as Ce,q as We,s as Ne,v as et,x as Re,y as It,C as Je,z as Xa,L as Ja,P as Za,A as Qa,B as eo,D as to,E as so,G as ao,H as oo,I as no,J as Be,K as Et,M as _t,N as wt,O as yt,Q as ha,R as fa,S as st,U as At,V as Wt,W as va,X as _s,Y as rs,Z as qs,_ as ro,$ as ys,a0 as ut,a1 as io,a2 as pa,a3 as lo,a4 as co,a5 as uo}from"./chunk-BxL3V5Fo.js";import{a as ya,_ as Ee,g as tt,b as go,f as Ut}from"./chunk-X743aslj.js";import{C as Ys}from"./chunk-C8Cm5yGW.js";import{i as mo,S as Yt,m as Xt,a as Os,g as xs,b as ka,c as ho,d as Xs,E as fo,e as ws,f as Cs,h as es,p as Js,j as vo,k as po,D as yo,l as ko,n as Zs,o as Qs,T as bo,q as ea,r as _o}from"./chunk-BBmTsmYU.js";import{D as vt}from"./chunk-D2N1ELIn.js";import{L as wo}from"./chunk-2JzEd2ES.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();const de=(o,e)=>{const s=o.__vccOpts||o;for(const[t,r]of e)s[t]=r;return s},Co={name:"App"},To={id:"app"};function So(o,e,s,t,r,i){const n=be("router-view");return c(),u("div",To,[ne(n)])}const Do=de(Co,[["render",So]]),Eo={name:"StatusMessage",props:{type:{type:String,required:!0,validator:o=>["success","error","info","warning"].includes(o)},title:{type:String,default:null},message:{type:String,default:null}}},Ao={key:0},$o={key:1};function Io(o,e,s,t,r,i){return c(),u("div",{class:X(["status-message",`status-message--${s.type}`])},[s.title?(c(),u("strong",Ao,m(s.title),1)):$("",!0),s.message?(c(),u("p",$o,m(s.message),1)):$("",!0),ma(o.$slots,"default",{},void 0)],2)}const ks=de(Eo,[["render",Io],["__scopeId","data-v-7f15d2d7"]]),Mo={name:"LoadingSpinner",props:{message:{type:String,default:"Загрузка..."}}},No={class:"loading-spinner"},xo={key:0,class:"message"};function Lo(o,e,s,t,r,i){return c(),u("div",No,[e[0]||(e[0]=a("div",{class:"spinner"},null,-1)),s.message?(c(),u("p",xo,m(s.message),1)):$("",!0)])}const bs=de(Mo,[["render",Lo],["__scopeId","data-v-375eac16"]]);function Ot(){try{if(window.self===window.top)return!1;if(typeof BX24<"u")return!0;try{const o=window.parent.location.origin;return o.includes("bitrix24")||o.includes("kompo.by")}catch{return!1}}catch(o){return console.warn("Error checking Bitrix24 context:",o),!1}}function Po(){return typeof BX24<"u"}class kt{static init(e){return new Promise((s,t)=>{if(!Ot()){console.log("Not inside Bitrix24, skipping BX24.init()"),e&&e(),s();return}if(typeof BX24>"u"){t(new Error("Bitrix24 API not loaded. Make sure script is included: //api.bitrix24.com/api/v1/"));return}const r=setTimeout(()=>{t(new Error("BX24.init() timeout: инициализация Bitrix24 API превысила 5 секунд"))},5e3);try{BX24.init(()=>{clearTimeout(r),e&&e(),s()})}catch(i){clearTimeout(r),t(i)}})}static installFinish(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}try{BX24.installFinish(),e()}catch(t){s(t)}})}static callMethod(e,s={}){return new Promise((t,r)=>{if(typeof BX24>"u"){r(new Error("Bitrix24 API not loaded"));return}const i=setTimeout(()=>{r(new Error(`BX24.callMethod(${e}) timeout: запрос превысил 10 секунд`))},1e4);try{BX24.callMethod(e,s,n=>{if(clearTimeout(i),n.error()){const l=n.error();r(new Error(l.error_description||l.error||"Unknown error"))}else t(n.data())})}catch(n){clearTimeout(i),r(n)}})}static async getCurrentUser(){if(Ot()&&Po())try{const e=await Promise.race([this.callMethod("user.current",{}),new Promise((s,t)=>setTimeout(()=>t(new Error("Timeout")),5e3))]);return console.log("Got user from BX24.callMethod() (interface user):",e?.ID||"unknown"),e}catch(e){console.warn("BX24.callMethod() failed, using proxy API as fallback:",e);try{const t=await new Ys().getCurrentUser();return console.log("Got user from proxy API (token owner, fallback):",t),t}catch(s){throw console.error("Both BX24 API and proxy API failed:",s),e.message&&e.message.includes("timeout")?new Error("Таймаут при определении пользователя. Bitrix24 API не отвечает."):new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}else return console.warn("Not inside Bitrix24, using proxy API (will return token owner, not interface user)"),await new Ys().getCurrentUser()}static getUser(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}if(typeof BX24.getUser!="function"){s(new Error("BX24.getUser is not available"));return}BX24.getUser(t=>{e(t)})})}static getAuth(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}BX24.getAuth(t=>{e(t)})})}}const Oo={name:"InstallPage",components:{StatusMessage:ks,LoadingSpinner:bs},setup(){const o=I(!0),e=I(null),s=I(null);return $e(async()=>{try{let t=null;if(window.INSTALL_RESULT)t=window.INSTALL_RESULT;else{const r=ya("/install.php"),i=await fetch(`${r}?get_result=1`);i.ok&&(t=await i.json())}if(!t)throw new Error("Не удалось получить результат установки");if(s.value=t,t.rest_only===!1)if(t.install===!0){e.value={type:"success",title:"✓ Установка завершена успешно!",message:"Приложение успешно установлено в Bitrix24."};try{await kt.init(()=>{kt.installFinish()})}catch(r){console.error("Error finishing installation:",r)}}else e.value={type:"error",title:"✗ Ошибка установки",message:"Не удалось установить приложение. Проверьте настройки."};else e.value={type:"info",title:"REST-only режим",message:"Это приложение работает только через REST API, без пользовательского интерфейса."}}catch(t){console.error("Error loading install result:",t),e.value={type:"error",title:"Ошибка загрузки",message:t.message||"Не удалось загрузить информацию об установке."}}finally{o.value=!1}}),{loading:o,installStatus:e,installInfo:s}}},Bo={class:"install-page"},Ro={class:"container"},Wo={key:1,class:"info"};function Uo(o,e,s,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner");return c(),u("div",Bo,[a("div",Ro,[e[1]||(e[1]=a("h1",null,"Установка Bitrix24 приложения",-1)),t.installStatus?(c(),he(n,{key:0,type:t.installStatus.type,title:t.installStatus.title,message:t.installStatus.message},null,8,["type","title","message"])):$("",!0),t.installInfo?(c(),u("div",Wo,[e[0]||(e[0]=a("h3",null,"Информация об установке:",-1)),a("pre",null,m(JSON.stringify(t.installInfo,null,2)),1)])):$("",!0),t.loading?(c(),he(l,{key:2,message:"Обработка установки..."})):$("",!0)])])}const Fo=de(Oo,[["render",Uo],["__scopeId","data-v-d082ec9e"]]);function Ho(){const o=Xe(),e=ps();return{goBack:(n="/")=>{window.history.length>1?o.back():o.push(n)},goTo:(n,l={})=>{o.push({path:n,...l})},goHome:(n={})=>{o.push({path:"/",...n})},isCurrentRoute:n=>e.path===n,router:o,route:e}}const jo={name:"BackButton",props:{variant:{type:String,default:"header",validator:o=>["header","floating"].includes(o)},text:{type:String,default:"НАЗАД"},to:{type:String,default:null},showIcon:{type:Boolean,default:!0},ariaLabel:{type:String,default:"Вернуться на главную"},title:{type:String,default:"Вернуться на главную"}},setup(o){const{goBack:e,goHome:s}=Ho();return{buttonClasses:M(()=>[o.variant==="header"?"back-button":"floating-back-button"]),handleClick:()=>{o.to?s({path:o.to}):e()}}}},zo=["aria-label","title"],Vo={key:0,class:"back-button-icon"},Go={key:1,class:"back-button-text"};function Ko(o,e,s,t,r,i){return c(),u("button",{class:X(t.buttonClasses),onClick:e[0]||(e[0]=(...n)=>t.handleClick&&t.handleClick(...n)),"aria-label":s.ariaLabel,title:s.title},[s.showIcon?(c(),u("span",Vo,"←")):$("",!0),s.variant==="header"?(c(),u("span",Go,m(s.text),1)):$("",!0)],10,zo)}const ba=de(jo,[["render",Ko],["__scopeId","data-v-d605b6a0"]]);function qo(o){const e=I(!1),s=I(null),t=I(""),r=I({}),i=I([]),n=I({}),l=I([]),d=I({totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}),g=M(()=>i.value.length>0||l.value.length>0),v=M(()=>!g.value&&!e.value&&!s.value),T=M(()=>{const B=Object.values(n.value).reduce((G,q)=>G+(q?.length||0),0),U=i.value.reduce((G,q)=>G+(q.tickets?.length||0),0);return B+U}),f=M(()=>{if(!T.value)return 0;const U=[...Object.values(n.value).flat(),...i.value.flatMap(G=>G.tickets||[])].filter(G=>G.status==="closed"||G.status==="completed"||G.status==="done").length;return Math.round(U/T.value*100)}),p=(B,U="",G={})=>{e.value=B,t.value=U,r.value=G},y=B=>{s.value=B,e.value=!1},S=()=>{s.value=null},C=B=>{i.value=B},k=B=>{l.value=B},_=B=>{n.value=B},A=B=>{d.value={...d.value,...B,lastUpdated:new Date().toISOString()}},W=()=>{e.value=!1,s.value=null,t.value="",r.value={},i.value=[],n.value={},l.value=[],d.value={totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}},x=B=>i.value.find(U=>U.id===B);return{isLoading:e,error:s,currentStep:t,stepDetails:r,stages:i,zeroPointTickets:n,employees:l,sectorStats:d,hasData:g,isEmpty:v,totalTickets:T,completionRate:f,setLoading:p,setError:y,clearError:S,updateStages:C,updateEmployees:k,updateZeroPointTickets:_,updateSectorStats:A,resetState:W,getStageById:x,getEmployeeById:B=>l.value.find(U=>U.id===B),getStageTickets:B=>{const U=x(B);return U?U.tickets||[]:[]},getZeroPointTickets:B=>n.value[B]||[]}}class Dt{static async call(e,s={}){return await new vt().call(e,s)}}class Oe{static get(e){const s=this.cache.get(e);return s?Date.now()-s.timestamp>s.ttl?(this.cache.delete(e),null):s.data:null}static set(e,s,t=this.DEFAULT_TTL){this.cache.set(e,{data:s,timestamp:Date.now(),ttl:t})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const s=[];for(const t of this.cache.keys())t.startsWith(e)&&s.push(t);s.forEach(t=>this.cache.delete(t))}static cleanExpired(){const e=Date.now(),s=[];for(const[t,r]of this.cache.entries())e-r.timestamp>r.ttl&&s.push(t);s.forEach(t=>this.cache.delete(t))}static getStats(){const e=Date.now();let s=0,t=0;for(const r of this.cache.values())e-r.timestamp>r.ttl?s++:t++;return{total:this.cache.size,valid:t,expired:s}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((t,r)=>t-r).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}je(Oe,"cache",new Map),je(Oe,"DEFAULT_TTL",5*60*1e3),je(Oe,"EMPLOYEES_TTL",30*60*1e3),je(Oe,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{Oe.cleanExpired()},5*60*1e3);const Ts="dashboard-sector-1c-logger-level",zt={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class Mt{static getLevel(){if(typeof localStorage<"u"){const s=localStorage.getItem(Ts);if(s&&zt[s]!==void 0)return s}return!0?"ERROR":"DEBUG"}static setLevel(e){return zt[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(Ts,e),!0):!1}static isEnabled(e,s=null){const t=s||this.getLevel();if(t==="NONE")return!1;const r=zt[e]||0,i=zt[t]||0;return r<=i}static getLevels(){return{...zt}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(Ts)}}let De=class{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,s,t=""){const r=new Date().toISOString(),i=this.getLevelColor(e),n=`%c[${r}] %c[${e}] %c[${t||"Unknown"}] %c${s}`,l=["color: #6c757d; font-weight: normal",`color: ${i}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:n,styles:l}}static log(e,s,t="",r=null){if(!Mt.isEnabled(e))return;const i=this.formatMessage(e,s,t),n=[i.formatted,...i.styles];switch(r!=null&&n.push(r),e){case"ERROR":console.error(...n);break;case"WARN":console.warn(...n);break;case"INFO":console.info(...n);break;case"DEBUG":console.log(...n);break;default:console.log(...n)}}static error(e,s="",t=null){this.log("ERROR",e,s,t)}static warn(e,s="",t=null){this.log("WARN",e,s,t)}static info(e,s="",t=null){this.log("INFO",e,s,t)}static debug(e,s="",t=null){this.log("DEBUG",e,s,t)}};function Ke(o,e,s={}){if(!o||typeof o!="string")throw new Error("Step must be a non-empty string");const t=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let r=s.description;return r||(r=Yo(o,s)),{step:o,progress:t,details:{...s,description:r}}}function Yo(o,e){return o==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`Загрузка тикетов стадии "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:o==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`Фильтрация тикетов: ${e.filteredTickets} из ${e.totalTickets}...`:o==="grouping"&&e.employeeCount!==void 0?`Группировка тикетов по ${e.employeeCount} сотрудникам...`:e.count!==void 0&&e.total!==void 0?`Обработка: ${e.count} из ${e.total}...`:"Загрузка данных..."}function ds(o){if(!o||typeof o!="object")throw new Error("Progress info must be an object");const e=o.step||null;if(!e)throw new Error("Step is required in progress info");const s=o.progress!==void 0&&o.progress!==null?o.progress:o.percent!==void 0&&o.percent!==null?o.percent:void 0,t=o.details||{};return o.stage&&(t.stage=o.stage),o.stageName&&(t.stageName=o.stageName),o.stageIndex!==void 0&&(t.stageIndex=o.stageIndex),o.totalStages!==void 0&&(t.totalStages=o.totalStages),o.count!==void 0&&(t.count=o.count),o.total!==void 0&&(t.total=o.total),o.warning&&(t.warning=o.warning),{step:e,progress:s!=null?Math.max(0,Math.min(100,s)):void 0,details:t}}function Ls(o,e,s){const t=typeof o=="number"&&!isNaN(o)?Math.max(0,Math.min(100,o)):0,r=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,i=typeof s=="number"&&!isNaN(s)?Math.max(0,Math.min(100,s)):0,n=t+r*i/100;return Math.max(0,Math.min(100,n))}const Nt={allowedDepartmentIds:[369,366,7],adminDepartmentIds:[369]};function _a(o){return!o||typeof o!="number"?!1:Nt.allowedDepartmentIds.includes(o)}function ts(o){if(!o||!o.UF_DEPARTMENT)return!1;const e=Array.isArray(o.UF_DEPARTMENT)?o.UF_DEPARTMENT:[];return e.length===0?!1:e.some(s=>Nt.adminDepartmentIds.includes(s))}class Xo{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,s,t,r=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const i=this.metrics.ticketsLoading.stages[e];i.loaded=t,i.batches.push({count:s,total:t,next:r}),i.total=t,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((n,l)=>n+l.total,0)}logFiltering(e,s,t=[],r=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=s,this.metrics.filtering.rejected=t.slice(0,50),this.metrics.filtering.tagValueExamples=r.slice(0,20)}logEmployees(e,s=[],t=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=s.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=t.slice(0,50)}logGrouping(e,s=[],t=[]){e.forEach(r=>{const i={};let n=0;r.employees.forEach(l=>{const d=(l.ticketsInsideSector||[]).length+(l.ticketsOutsideSector||[]).length;i[l.id]=d,n+=d}),this.metrics.grouping.distributionByStages[r.id]={employees:i,total:n}}),this.metrics.grouping.ticketsNotInColumn=s.slice(0,50),this.metrics.grouping.unknownStages=t.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(s=>{this.metrics.zeroPoint.byStage[s]=Array.isArray(e[s])?e[s].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let Ss=null;function Qe(){return Ss||(Ss=new Xo),Ss}function rt(o=null,e=null){if(e&&!ts(e))return!1;if(o&&o.query&&o.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const s=window.location.hash;if(s){const r=s.split("?");if(r.length>1){const i=r[1];if(new URLSearchParams(i).get("diagnostics")==="true")return!0}if(s.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}const Vt=140;class xt{static async getAllTicketsByFilter(e,s="UF_CRM_7_TYPE_PRODUCT",t=null,r=!0){De.info(`Loading tickets by filter: ${s} = ${e}`,"TicketRepository");try{const i=[],n=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],l=n.length;for(let d=0;d<n.length;d++){const g=n[d],v=this.getStageName(g);if(t){const T=d/l*100;t({step:"loading_tickets",progress:T,details:{stage:g,stageName:v,stageIndex:d+1,totalStages:l,filter:`${s} = ${e}`}})}try{const T=await this.getTicketsByStageWithFilter(g,e,s,r,t?f=>{const p=Ls(d/l*100,1/l*100,f.percent||0);t({step:"loading_tickets",progress:p,details:{stage:g,stageName:v,stageIndex:d+1,totalStages:l,count:f.count,total:f.total,filter:`${s} = ${e}`}})}:null);i.push(...T)}catch(T){De.error(`Error loading tickets for stage ${g} with filter ${s} = ${e}`,"TicketRepository",T)}}return De.info(`Loaded ${i.length} tickets with filter ${s} = ${e}`,"TicketRepository"),i}catch(i){throw De.error(`Error loading tickets by filter ${s} = ${e}`,"TicketRepository",i),i}}static async getAllTickets(e,s=null,t=!0){const r=[],i=e.length;try{for(let n=0;n<e.length;n++){const l=e[n],d=this.getStageName(l);if(s){const g=n/i*100;s(Ke("loading_tickets",g,{stage:l,stageName:d,stageIndex:n+1,totalStages:i}))}try{const g=await this.getTicketsByStage(l,t,s?v=>{const T=Ls(n/i*100,1/i*100,v.percent||0);s(Ke("loading_tickets",T,{stage:l,stageName:d,stageIndex:n+1,totalStages:i,count:v.count,total:v.total}))}:null);r.push(...g)}catch(g){De.error(`Error loading tickets for stage ${l}`,"TicketRepository",g);let v=`Ошибка загрузки стадии "${d}"`;throw g.message&&(g.message.includes("HTTP error")||g.message.includes("network")?v=`Ошибка соединения при загрузке стадии "${d}". Проверьте подключение к интернету.`:g.message.includes("timeout")?v=`Превышено время ожидания при загрузке стадии "${d}". Попробуйте позже.`:g.message.includes("403")||g.message.includes("401")?v=`Ошибка доступа при загрузке стадии "${d}". Проверьте права доступа.`:v=`Ошибка загрузки стадии "${d}": ${g.message}`),new Error(v)}}}catch(n){throw De.error("Error in getAllTickets","TicketRepository",n),n}return r}static getStageName(e){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[e]||e}static async getTicketsByStage(e,s=!0,t=null){if(s){const v=Oe.getTicketsCacheKey(e),T=Oe.get(v);if(T!==null){try{const f=Qe();f&&rt()&&f.logTicketsLoading(e,T.length,T.length,null)}catch(f){De.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",f)}return t&&t(ds({step:"loading_tickets",percent:100,count:T.length,total:T.length})),T}}const r=[];let i=0;const n=50;let l=!0,d=0,g=null;for(;l;)try{const v=await Dt.call("crm.item.list",{entityTypeId:Vt,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:i,useOriginalUfNames:"Y"});let T=[];if(v&&v.result&&(Array.isArray(v.result)?T=v.result:v.result.items&&Array.isArray(v.result.items)?T=v.result.items:v.result.data&&Array.isArray(v.result.data)&&(T=v.result.data)),T.length>0){r.push(...T),i+=T.length;const f=v?.result?.next??v?.next,p=f!=null&&f!==""&&String(f)!=="0";l=T.length===n&&p,rt()&&De.debug(`[Pagination] Stage: ${e}, Batch: ${T.length}, Total: ${r.length}, Start: ${i}, NextValue: ${f}, HasNext: ${p}, HasMore: ${l}`,"TicketRepository");try{const y=Qe();y&&rt()&&(De.debug(`[Pagination Debug] Stage: ${e}, Batch: ${T.length}, Total: ${r.length}`,"TicketRepository",{resultStructure:{hasResult:!!v?.result,resultIsArray:Array.isArray(v?.result),hasItems:!!v?.result?.items,hasData:!!v?.result?.data,hasNext:!!f,nextValue:f,nextType:typeof f,resultKeys:v?.result?Object.keys(v.result):[]}}),y.logTicketsLoading(e,T.length,r.length,f||null))}catch(y){De.warn("Diagnostics logging error","TicketRepository",y)}if(l?d=i+n:d=r.length,t){const y=d>0?Math.min(100,r.length/d*100):0;t(ds({step:"loading_tickets",percent:y,count:r.length,total:d}))}g=null}else l=!1}catch(v){if(De.error(`Error loading tickets batch for stage ${e} (start: ${i})`,"TicketRepository",v),i===0)throw g=v,new Error(`Не удалось загрузить тикеты для стадии ${e}: ${v.message||v}`);l=!1,t&&r.length>0&&t(Ke("loading_tickets",100,{count:r.length,total:r.length,warning:`Загружено частично: ${r.length} тикетов. Ошибка при загрузке остальных.`}))}if(g&&r.length===0)throw g;if(s){const v=Oe.getTicketsCacheKey(e);Oe.set(v,r,Oe.TICKETS_TTL)}return r}static async getTicket(e){return(await Dt.call("crm.item.get",{entityTypeId:Vt,id:e})).result||null}static async getTicketsByStageWithFilter(e,s,t="UF_CRM_7_TYPE_PRODUCT",r=!0,i=null){De.info(`Loading tickets for stage ${e} with filter ${t} = ${s}`,"TicketRepository");const n=`tickets_${e}_${t}_${JSON.stringify(s)}`;if(r){const p=Oe.get(n);if(p!==null)return De.info(`Cache hit for filtered tickets: ${e} with ${t} = ${s}`,"TicketRepository"),i&&i({step:"loading_tickets",percent:100,count:p.length,total:p.length}),p}const l=[];let d=0;const g=50;let v=!0,T=0;const f={stageId:e};for(Array.isArray(s),f[t]=s;v;)try{const p=await Dt.call("crm.item.list",{entityTypeId:Vt,filter:f,select:["*"],order:{id:"DESC"},start:d,useOriginalUfNames:"Y"});let y=[];p&&p.result&&(Array.isArray(p.result)?y=p.result:p.result.items&&Array.isArray(p.result.items)?y=p.result.items:p.result.data&&Array.isArray(p.result.data)&&(y=p.result.data)),y.length>0?(l.push(...y),d+=y.length,T=Math.max(T,d+y.length),i&&i({step:"loading_tickets",percent:Math.min(d/Math.max(T,d)*100,95),count:d,total:T}),v=y.length===g&&p.next):v=!1}catch(p){throw De.error(`Error loading batch for stage ${e} with filter ${t} = ${s}`,"TicketRepository",p),v=!1,p}r&&(Oe.set(n,l),De.info(`Cached ${l.length} filtered tickets for stage ${e}`,"TicketRepository"));try{const p=Qe();p&&rt()&&p.logTicketsLoading(`${e}_${s}`,l.length,l.length,null)}catch(p){De.warn("Diagnostics logging error in getTicketsByStageWithFilter","TicketRepository",p)}return i&&i({step:"loading_tickets",percent:100,count:l.length,total:l.length}),De.info(`Loaded ${l.length} tickets for stage ${e} with filter ${t} = ${s}`,"TicketRepository"),l}static async updateTicket(e,s){const r=(await Dt.call("crm.item.update",{entityTypeId:Vt,id:e,fields:s})).result===!0;return r&&Oe.invalidateTicketsCache(),r}static async createTicket(e){const s=await Dt.call("crm.item.add",{entityTypeId:Vt,fields:e}),t=s.result?parseInt(s.result):0;return t>0&&Oe.invalidateTicketsCache(),t}static async assignTicket(e,s,t){return await this.updateTicket(e,{assignedById:s,stageId:t})}}class Jo{static async getEmployeesByIds(e,s=!0){if(!Array.isArray(e)||e.length===0)return[];if(s){const t=Oe.getEmployeesCacheKey(e),r=Oe.get(t);if(r!==null)return De.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),r}try{const t=await Dt.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let r=[];if(t&&t.result&&(Array.isArray(t.result)?r=t.result:De.warn("Unexpected user.get result format","EmployeeRepository",t)),s){const i=Oe.getEmployeesCacheKey(e);Oe.set(i,r,Oe.EMPLOYEES_TTL)}return r}catch(t){return De.error("Error getting employees by IDs","EmployeeRepository",t),[]}}}const qt=new Map;function wa(){qt.clear()}function Zo(o){if(!o)return[];if(Array.isArray(o))return o.filter(s=>typeof s=="number"||!isNaN(parseInt(s))).map(s=>typeof s=="number"?s:parseInt(s));if(typeof o=="number")return[o];const e=parseInt(o);return isNaN(e)?[]:[e]}function Qo(o,e=!0){const s=o.id||o.ID;if(!o||!s)return null;if(e&&qt.has(s))return qt.get(s);const t=o.UF_DEPARTMENT||o.departmentId,r=Zo(t);for(const i of r)if(mo(i)){const l=i;return e&&qt.set(s,l),l}return e&&qt.set(s,null),null}function en(o){const e=Qo(o);return{id:parseInt(o.ID||o.id||0),name:`${o.NAME||o.name||""} ${o.LAST_NAME||o.lastName||""}`.trim()||o.EMAIL||o.email||"Неизвестный",position:o.WORK_POSITION||o.workPosition||"Сотрудник",email:o.EMAIL||o.email||"",sectorId:e,departmentId:o.UF_DEPARTMENT||null,tickets:[]}}function tn(o){return Array.isArray(o)?o.map(e=>en(e)):[]}const sn="1C",an=["1С"],Jt=new Map,ta=100;function Ca(o){return o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||o.ufCrm7TypeProduct||o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||null}function Ds(o){return o==null?null:String(o).trim().toUpperCase().replace(/С/g,"C")||null}function Ta(o){if(!o)return[];if(Array.isArray(o))return o.map(Ds).filter(Boolean);if(typeof o=="object"&&o.value!==void 0){const s=Ds(o.value);return s?[s]:[]}const e=Ds(o);return e?e.split(/[;,]/).map(s=>s.trim()).filter(Boolean):[]}function sa(o){const e=Ca(o),s=Ta(e);return s.length===0?!1:s.some(t=>t===sn||an.includes(t))}function on(o){return`filter:${o.map(s=>s.id||s.ID||"").sort().join(",")}`}function nn(){Jt.size>ta&&Array.from(Jt.keys()).slice(0,Math.floor(ta*.2)).forEach(e=>Jt.delete(e))}function rn(o){if(!Array.isArray(o))return[];const e=on(o),s=Jt.get(e);if(s!==void 0)return s;const t=o.filter(sa);try{const r=Qe();if(r&&rt()){const i=o.filter(d=>!sa(d)),n=[],l=new Set;o.forEach(d=>{const g=Ca(d),v=Ta(g),T=g==null?"":String(g);g!=null&&!l.has(T)&&(l.add(T),n.push({value:g,normalized:v,type:typeof g,isArray:Array.isArray(g),ticketId:d.id||d.ID}))}),r.logFiltering(o.length,t.length,i,n)}}catch(r){console.warn("Diagnostics logging error in filterBySector:",r)}return Jt.set(e,t),nn(),t}const Qt=1051;function us(o){if(!o||typeof o!="object")return null;let e=o.assignedById||o.ASSIGNED_BY_ID||o.assignedByIdId||o.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function Bs(o){if(o==null)return null;typeof o=="object"&&(o=o.id||o.ID||o.value||null);const e=typeof o=="number"?o:parseInt(o);return isNaN(e)||e<=0?null:e}function ln(o,e=Qt){const s=us(o),t=Bs(s);return t===null||t===e}function cn(o,e){Array.isArray(o)||(De.warn("Tickets is not an array","TicketGrouper",o),o=[]),Array.isArray(e)||(De.warn("Employees is not an array","TicketGrouper",e),e=[]);const s=e.filter(d=>(d.id?parseInt(d.id):null)!==Qt),t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:s.map(d=>({...d,isFromSector1C:d.sectorId===Yt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:s.map(d=>({...d,isFromSector1C:d.sectorId===Yt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:s.map(d=>({...d,isFromSector1C:d.sectorId===Yt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],r=new Map(t.map(d=>[d.id,d])),i=new Map;t.forEach(d=>{const g=new Map(d.employees.map(v=>[v.id,v]));i.set(d.id,g)});const n=[],l=[];o.forEach(d=>{const g=Xt(d.stageId||d.STAGE_ID||""),v=r.get(g);if(!v){l.push({id:d.id||d.ID,title:d.title||d.TITLE||"Без названия",stageId:d.stageId||d.STAGE_ID,assignedById:us(d)});return}const T=us(d),f=Bs(T);if(f!==Qt)if(f){const p=i.get(g);let y=p.get(f);y||(y={id:f,name:`Сотрудник #${f}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},v.employees.push(y),p.set(f,y));const S=Os(d),C={...S,stageId:d.stageId||d.STAGE_ID||S.stageId||null,departmentHead:S.departmentHead||null,departmentHeadFull:S.departmentHeadFull||S.departmentHead||null};y.tickets.push(C),y.isFromSector1C?y.ticketsInsideSector.push(C):y.ticketsOutsideSector.push(C)}else n.push({id:d.id||d.ID,title:d.title||d.TITLE||"Без названия",stageId:g,assignedById:T})}),t.forEach(d=>{d.employees.sort((g,v)=>g.isFromSector1C&&!v.isFromSector1C?-1:!g.isFromSector1C&&v.isFromSector1C?1:(g.id||0)-(v.id||0))});try{const d=Qe();if(d&&rt()){const g={};t.forEach(T=>{let f=0,p=0;T.employees.forEach(y=>{f+=(y.ticketsInsideSector||[]).length,p+=(y.ticketsOutsideSector||[]).length}),g[T.id]={insideSector:f,outsideSector:p,total:f+p}});const v=d.metrics.grouping;Object.keys(g).forEach(T=>{v.distributionByStages[T]||(v.distributionByStages[T]={employees:{},total:0}),v.distributionByStages[T].insideSector=g[T].insideSector,v.distributionByStages[T].outsideSector=g[T].outsideSector,v.distributionByStages[T].total=g[T].total}),d.logGrouping(t,n,l)}}catch(d){De.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",d)}return t}function dn(o){const e={formed:[],review:[],execution:[]};if(!Array.isArray(o))return De.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",o),e;o.filter(s=>ln(s)).forEach(s=>{const t=Xt(s.stageId||s.STAGE_ID||"");if(e[t]){const r=Os(s),i={...r,stageId:s.stageId||s.STAGE_ID||r.stageId||null,departmentHead:r.departmentHead||null,departmentHeadFull:r.departmentHeadFull||r.departmentHead||null};e[t].push(i)}});try{const s=Qe();s&&rt()&&s.logZeroPoint(e)}catch(s){De.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",s)}return e}function un(o){if(!Array.isArray(o))return[];const e=new Set,s=[],t=[];o.forEach(i=>{const n=us(i),l=Bs(n);!n||n===null||n===void 0?s.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}):l===Qt&&t.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}),l&&e.add(l)});const r=Array.from(e);try{const i=Qe();i&&rt()&&i.logEmployees(r,s,t)}catch(i){De.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",i)}return r}const as=new Map,gn=10*60*1e3;function mn(o){if(!o||typeof o!="object")return{};const e={},s=Object.keys(o);for(const t of s)t.toUpperCase().startsWith("UF_")&&(e[t]=o[t]);return e}function hn(o,e=null,s=!0){if(s&&e&&as.has(e)){const i=as.get(e),n=Date.now();if(i.timestamp&&n-i.timestamp<gn)return i.data;as.delete(e)}const t=mn(o),r={typeProduct:t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||null,all:t};return s&&e&&as.set(e,{data:r,timestamp:Date.now()}),r}class fn{static async getTicketDetails(e,s={}){const{select:t=["*"],useOriginalUfNames:r=!0,useCache:i=!0}=s;try{const n=await xt.getTicket(e);if(!n)throw new Error(`Тикет с ID ${e} не найден`);const l=hn(n,e,i),d=n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.ufCrm7UfPriority||n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.priority||n.PRIORITY||null,g=xs(d),v=ka(g);return{id:n.id||n.ID,title:n.title||n.TITLE,stageId:n.stageId||n.STAGE_ID,assignedById:n.assignedById||n.ASSIGNED_BY_ID,createdAt:n.createdTime||n.CREATED_TIME||n.CREATED_DATE,updatedAt:n.updatedTime||n.UPDATED_TIME||n.MODIFY_DATE,priorityId:g.id,priorityLabel:g.label,priorityColors:v,priority:g.id,priorityBitrixValue:g.bitrixValue||null,opportunity:n.opportunity||n.OPPORTUNITY,currencyId:n.currencyId||n.CURRENCY_ID,comments:n.comments||n.COMMENTS,additionalFields:l,rawData:n}}catch(n){throw De.error("Error getting ticket details","TicketDetailsService",n),n}}}let Bt=class{static async getSectorData(e=!0,s=!1,t=null){let r=!1;try{if(rt()){const i=Qe();i&&i.reset()}}catch(i){De.warn("Error resetting diagnostics","DashboardSector1CService",i)}if(t&&t(Ke("cache_check",0,{description:"Инициализация загрузки..."})),e){const i=Oe.getSectorDataCacheKey(),n=Oe.get(i);if(n!==null)return t&&t(Ke("cache_hit",100,{description:"Данные загружены из in-memory кеша"})),n}try{t&&t(Ke("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const i=ho(),n=await xt.getAllTickets(i,p=>{if(t){const y=ds(p),S=Ls(10,40,y.progress||0);t(Ke(y.step||"loading_tickets",S,{...y.details,warning:y.details.warning}))}},e);t&&t(Ke("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const l=rn(n);t&&t(Ke("filtering",50,{totalTickets:n.length,filteredTickets:l.length,description:`Отфильтровано ${l.length} тикетов из ${n.length}`})),t&&t(Ke("extracting_employees",60,{filteredTickets:l.length,description:`Анализ ${l.length} тикетов для определения сотрудников...`}));const d=un(l);t&&t(Ke("extracting_employees",60,{employeeCount:d.length,description:`Найдено ${d.length} уникальных сотрудников`})),t&&t(Ke("loading_employees",65,{employeeCount:d.length,description:`Загрузка данных ${d.length} сотрудников...`})),wa();const g=await Jo.getEmployeesByIds(d),v=tn(g);t&&t(Ke("loading_employees",90,{employeeCount:v.length,description:`Загружено данных ${v.length} сотрудников`})),t&&t(Ke("grouping",90,{filteredTickets:l.length,employeeCount:v.length,description:`Группировка ${l.length} тикетов по этапам и ${v.length} сотрудникам...`}));const f={stages:cn(l,v),employees:v,zeroPointTickets:dn(l)};if(t&&t(Ke("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),e){const p=Oe.getSectorDataCacheKey();Oe.set(p,f,Oe.TICKETS_TTL),r=!0}return t&&t(Ke("complete",100,{description:"Загрузка завершена"})),r&&!s&&CacheNotificationService.notifyCacheCreationSuccess("Дашборд сектора 1С"),f}catch(i){throw De.error("Error getting sector data","DashboardSector1CService",i),t&&t({step:"error",progress:0,error:i.message}),i}}static async assignTicket(e,s,t){try{const r=Xs(t),i=await xt.assignTicket(e,s,r);return i&&Oe.invalidateTicketsCache(),i}catch(r){throw De.error("Error assigning ticket","DashboardSector1CService",r),r}}static async createTicket(e){try{const s=Xs(e.stageId||"formed"),t={title:e.title,stageId:s};e.employeeId&&(t.assignedById=e.employeeId);const r=await xt.createTicket(t);return r>0&&Oe.invalidateTicketsCache(),r}catch(s){throw De.error("Error creating ticket","DashboardSector1CService",s),s}}static async getTicket(e){try{const s=await xt.getTicket(e);return Os(s)}catch(s){throw De.error("Error getting ticket","DashboardSector1CService",s),s}}static async getTicketDetails(e,s={}){try{return await fn.getTicketDetails(e,s)}catch(t){throw De.error("Error getting ticket details","DashboardSector1CService",t),t}}static async addComment(e,s){try{return(await Dt.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+fo,comment:s}})).result!==void 0}catch(t){throw De.error("Error adding comment","DashboardSector1CService",t),t}}};const vn=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:Bt},Symbol.toStringTag,{value:"Module"}));class Sa{static normalizeSectorData(e,s){return e?{stages:this.normalizeStages(e.stages||[],s),employees:this.normalizeEmployees(e.employees||[],s),zeroPointTickets:this.normalizeTickets(e.zeroPointTickets||[],s),metrics:this.calculateMetrics(e,s),metadata:this.createMetadata(e,s)}:this.getEmptySectorData(s)}static normalizeStages(e,s){return Array.isArray(e)?e.map((t,r)=>{const i=s.stages?.[t.id]||{},n=r%this.STAGE_COLORS.length;return{id:t.id||`stage_${r}`,name:i.name||t.name||t.title||`Этап ${r+1}`,color:i.color||t.color||this.STAGE_COLORS[n],order:i.order||t.order||r,tickets:this.normalizeTickets(t.tickets||[],s),employees:this.normalizeEmployees(t.employees||[],s),metrics:this.calculateStageMetrics(t,s)}}).sort((t,r)=>(t.order||0)-(r.order||0)):[]}static normalizeEmployees(e,s){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`emp_${Math.random()}`,name:this.normalizeEmployeeName(t),department:t.department||t.UF_DEPARTMENT||s.defaultDepartment||"Unknown",load:t.load||t.currentLoad||0,avatar:t.avatar||t.PERSONAL_PHOTO||null,status:t.status||t.ACTIVE||"active",color:this.assignEmployeeColor(t,s)})):[]}static normalizeTickets(e,s){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`ticket_${Math.random()}`,title:this.normalizeTicketTitle(t),status:t.status||t.STATUS_ID||"new",priority:this.normalizePriority(t),assignedTo:t.assignedTo||t.ASSIGNED_BY_ID||t.assigned_to,createdAt:this.normalizeDate(t.createdAt||t.CREATED_DATE||t.DATE_CREATE),updatedAt:this.normalizeDate(t.updatedAt||t.UPDATED_DATE||t.TIMESTAMP_X),deadline:this.normalizeDate(t.deadline||t.DEADLINE),tags:this.extractTags(t,s),description:t.description||t.DETAIL_TEXT||t.COMMENTS||""})):[]}static normalizeEmployeeName(e){if(!e)return"Неизвестный сотрудник";const s=e.LAST_NAME||e.lastName||"",t=e.NAME||e.firstName||e.FIRST_NAME||"",r=`${s} ${t}`.trim();return r&&r!==" "?r:t||(e.LOGIN||e.login?e.LOGIN||e.login:`Сотрудник #${e.id||e.ID||"unknown"}`)}static normalizeTicketTitle(e){return e.title||e.TITLE||e.name||e.NAME||e.subject||e.SUBJECT||`Тикет ${e.id||e.ID||"без названия"}`}static normalizePriority(e){const s=e.priority||e.PRIORITY;return typeof s=="number"?Math.max(1,Math.min(5,s)):typeof s=="string"&&{low:1,lowest:1,normal:3,medium:3,high:4,highest:5,urgent:5,critical:5}[s.toLowerCase()]||3}static normalizeDate(e){if(!e)return null;try{const s=new Date(e);return isNaN(s.getTime())?null:s.toISOString()}catch{return null}}static extractTags(e,s){const t=[];return e.UF_CRM_7_TYPE_PRODUCT&&t.push(e.UF_CRM_7_TYPE_PRODUCT),(e.category||e.CATEGORY)&&t.push(e.category||e.CATEGORY),(e.type||e.TYPE)&&t.push(e.type||e.TYPE),e.priority&&typeof e.priority=="string"&&t.push(`priority:${e.priority}`),[...new Set(t)]}static assignEmployeeColor(e,s){const t=["#007bff","#28a745","#ffc107","#dc3545","#6c757d","#17a2b8"];if(e.department){const i=e.department.split("").reduce((n,l)=>(n=(n<<5)-n+l.charCodeAt(0),n&n),0);return t[Math.abs(i)%t.length]}const r=e.id||e.ID||0;return t[Math.abs(r)%t.length]}static calculateStageMetrics(e,s){const t=e.tickets||[],r=e.employees||[];return{ticketCount:t.length,employeeCount:r.length,averageLoad:r.length>0?t.length/r.length:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateMetrics(e,s){const t=[...e.zeroPointTickets||[],...(e.stages||[]).flatMap(l=>l.tickets||[])],r=t.length,i=e.employees?.length||0,n=(e.stages||[]).filter(l=>(l.tickets||[]).length>0).length;return{totalTickets:r,totalEmployees:i,activeStages:n,averageTicketsPerEmployee:i>0?r/i:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateCompletionRate(e){if(!e.length)return 0;const s=e.filter(t=>t.status==="closed"||t.status==="completed"||t.status==="done").length;return Math.round(s/e.length*100)}static countOverdueTickets(e){const s=new Date;return e.filter(t=>t.deadline?new Date(t.deadline)<s&&t.status!=="closed"&&t.status!=="completed":!1).length}static createMetadata(e,s){return{sectorId:s.id,sectorName:s.name,lastUpdated:new Date().toISOString(),dataVersion:"2.0",source:"universal-normalizer"}}static getEmptySectorData(e){return{stages:[],employees:[],zeroPointTickets:[],metrics:{totalTickets:0,totalEmployees:0,activeStages:0,averageTicketsPerEmployee:0,completionRate:0,overdueCount:0},metadata:this.createMetadata({},e)}}}je(Sa,"STAGE_COLORS",["#007bff","#ffc107","#28a745","#dc3545","#6c757d","#17a2b8","#e83e8c","#fd7e14"]);class Da{static create(e){if(this.serviceCache.has(e))return this.serviceCache.get(e);const s=this.createServiceInstance(e);return this.serviceCache.set(e,s),s}static createServiceInstance(e){switch(e){case"1c":console.log("[SectorServiceFactory] Creating DashboardSector1CService for sector 1c");const{DashboardSector1CService:s}=require("@/services/dashboard-sector-1c/index.js");return new s;case"pdm":console.log("[SectorServiceFactory] Creating DashboardSectorPDMService for sector pdm");const{DashboardSectorPDMService:t}=require("@/services/dashboard/DashboardSectorPDMService.js");return new t;case"bitrix24":console.log("[SectorServiceFactory] Creating DashboardSectorBitrix24Service for sector bitrix24");const{DashboardSectorBitrix24Service:r}=require("@/services/dashboard/DashboardSectorBitrix24Service.js");return new r;case"infrastructure":console.log("[SectorServiceFactory] Creating DashboardSectorInfrastructureService for sector infrastructure");const{DashboardSectorInfrastructureService:i}=require("@/services/dashboard/DashboardSectorInfrastructureService.js");return new i;default:throw new Error(`Unknown sector: ${e}`)}}static isServiceAvailable(e){return["1c","pdm","bitrix24","infrastructure"].includes(e)}static clearCache(){this.serviceCache.clear(),console.log("[SectorServiceFactory] Service cache cleared")}static getAvailableServices(){return{"1c":{type:"full",description:"Полнофункциональный сервис сектора 1С"},pdm:{type:"stub",description:"Заглушка сервиса сектора PDM"},bitrix24:{type:"stub",description:"Заглушка сервиса сектора Битрикс24"},infrastructure:{type:"stub",description:"Заглушка сервиса сектора Инфраструктура"}}}}je(Da,"serviceCache",new Map);class pn{constructor(e){this.sectorId=e,this.cache=new Map;try{this.sectorService=Da.create(e),console.log(`[UniversalSectorDashboardService] Initialized for sector: ${this.sectorId}`)}catch(s){throw console.error(`[UniversalSectorDashboardService] Failed to initialize for sector ${this.sectorId}:`,s),s}}async getSectorDashboardData(e={}){const s=`dashboard:${this.sectorId}:${JSON.stringify(e)}`;if(!e.forceRefresh&&this.cache.has(s))return console.log(`[UniversalSectorDashboardService] Cache hit for dashboard data: ${this.sectorId}`),this.cache.get(s);try{console.log(`[UniversalSectorDashboardService] Loading dashboard data for sector: ${this.sectorId}`);let t;if(this.sectorId==="1c"){const{DashboardSector1CService:i}=await Ee(async()=>{const{DashboardSector1CService:n}=await Promise.resolve().then(()=>vn);return{DashboardSector1CService:n}},void 0,import.meta.url);t=await i.getSectorData(!e.forceRefresh,!1,null)}else t=await this.sectorService.getSectorData(e);const r=this.normalizeSectorDataToDashboard(t);return this.cache.set(s,r),setTimeout(()=>{this.cache.delete(s)},5*60*1e3),console.log(`[UniversalSectorDashboardService] Returning dashboard data for ${this.sectorId}:`,{stages:r.stages?.length||0,employees:r.employees?.length||0,totalTickets:r.metadata?.totalTickets||0}),r}catch(t){throw console.error(`[UniversalSectorDashboardService] Failed to get dashboard data for ${this.sectorId}:`,t),t}}normalizeSectorDataToDashboard(e){const s=Sa.normalizeSectorData(e,{id:this.sectorId});return{stages:this.convertStagesToDashboardFormat(s.stages),employees:s.employees,zeroPointTickets:this.extractZeroPointTickets(s),metadata:{sectorId:this.sectorId,totalTickets:s.metrics?.totalTickets||0,totalEmployees:s.employees?.length||0,lastUpdated:new Date().toISOString()}}}convertStagesToDashboardFormat(e){return e.map(s=>({id:this.mapStageIdToDashboardId(s.id),name:s.name,color:s.color||"#666",employees:s.employees||[],tickets:s.tickets||[],metrics:{ticketCount:s.tickets?.length||0,employeeCount:s.employees?.length||0}}))}mapStageIdToDashboardId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution",formed:"formed",review:"review",execution:"execution",request:"formed",assessment:"review",deployment:"execution"}[e]||e}extractZeroPointTickets(e){const s={};return e.stages.forEach(t=>{const r=this.mapStageIdToDashboardId(t.id),i=t.tickets.filter(n=>!n.assignedTo||n.assignedTo===null||n.assignedTo==="");s[r]=i}),s}async updateTicketAssignment(e,s,t){try{const r=this.mapDashboardIdToStageId(s),i=await this.sectorService.updateTicketAssignment(e,r,t);return this.clearCache(),i}catch(r){throw console.error("[UniversalSectorDashboardService] Failed to update ticket assignment:",r),r}}mapDashboardIdToStageId(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||e}clearCache(){this.cache.clear(),console.log(`[UniversalSectorDashboardService] Cache cleared for sector: ${this.sectorId}`)}async createTicket(e){try{const s=await this.sectorService.createTicket({...e,sectorId:this.sectorId});return this.clearCache(),s}catch(s){throw console.error("[UniversalSectorDashboardService] Failed to create ticket:",s),s}}async getSectorStats(){try{const e=await this.getSectorDashboardData();return{totalTickets:e.metadata.totalTickets,totalEmployees:e.metadata.totalEmployees,stagesCount:e.stages.length,unassignedTickets:Object.values(e.zeroPointTickets).reduce((s,t)=>s+t.length,0),lastUpdated:e.metadata.lastUpdated}}catch(e){throw console.error("[UniversalSectorDashboardService] Failed to get sector stats:",e),e}}}class Ea{static getService(e){return this.services.has(e)||this.services.set(e,new pn(e)),this.services.get(e)}static clearAll(){this.services.clear()}}je(Ea,"services",new Map);const Gt=I([]);let yn=0;function ct(){const o=(l,d="info",g=3e3)=>{const v=++yn,T={id:v,message:l,type:d,duration:g,timestamp:Date.now()};return Gt.value.push(T),g>0&&setTimeout(()=>{e(v)},g),v},e=l=>{const d=Gt.value.findIndex(g=>g.id===l);d>-1&&Gt.value.splice(d,1)};return{notifications:Gt,showNotification:o,removeNotification:e,clearNotifications:()=>{Gt.value=[]},success:(l,d=3e3)=>o(l,"success",d),error:(l,d=5e3)=>o(l,"error",d),warning:(l,d=4e3)=>o(l,"warning",d),info:(l,d=3e3)=>o(l,"info",d)}}function Aa(){const o=I(null),e=I(0),s=I(null),t=I(null),r=I({}),i=(f,p={})=>{o.value=f,r.value=p},n=f=>{const p=typeof f=="number"&&!isNaN(f)?f:0;e.value=Math.min(100,Math.max(0,p))},l=f=>{s.value=f,t.value=null},d=f=>{t.value=f},g=()=>{t.value=null},v=()=>{o.value=null,e.value=0,s.value=null,t.value=null,r.value={}},T=M(()=>s.value||t.value);return{currentStep:o,progress:e,error:s,temporaryError:t,displayError:T,stepDetails:r,updateStep:i,updateProgress:n,setError:l,setTemporaryError:d,clearTemporaryError:g,reset:v}}function kn(o,e){const s=ct();Aa();let t=null;const r=()=>(t||(t=Ea.getService(e)),t),i=async(_={})=>{try{o.setLoading(!0,"Загрузка данных сектора..."),o.clearError();const W=await r().getSectorDashboardData(_);o.updateStages(W.stages),o.updateEmployees(W.employees),o.updateZeroPointTickets(W.zeroPointTickets),o.updateSectorStats({totalTickets:W.metadata.totalTickets,totalEmployees:W.metadata.totalEmployees,activeStages:W.stages.length,lastUpdated:W.metadata.lastUpdated}),s.success("Данные сектора загружены",`Загружено ${W.metadata.totalTickets} тикетов`)}catch(A){throw console.error(`[useUniversalDashboardActions] Failed to load sector data for ${e}:`,A),o.setError(A.message||"Ошибка загрузки данных сектора"),s.error("Ошибка загрузки",A.message||"Не удалось загрузить данные сектора"),A}finally{o.setLoading(!1)}},n=async(_,A,W=null)=>{try{await r().updateTicketAssignment(_,A,W),s.success("Тикет обновлен","Назначение тикета успешно изменено"),await i({forceRefresh:!0})}catch(x){throw console.error("[useUniversalDashboardActions] Failed to update ticket assignment:",x),s.error("Ошибка обновления",x.message||"Не удалось обновить назначение тикета"),x}},l=async _=>{try{const W=await r().createTicket(_);return s.success("Тикет создан",`Тикет "${W.title}" успешно создан`),await i({forceRefresh:!0}),W}catch(A){throw console.error("[useUniversalDashboardActions] Failed to create ticket:",A),s.error("Ошибка создания",A.message||"Не удалось создать тикет"),A}},d=async(_,A,W=null)=>{try{if(!S(_,A))throw new Error("Перемещение тикета невозможно");await n(_.id,A,W),s.success("Тикет перемещен",`Тикет перемещен на этап "${k(A)}"`)}catch(x){throw console.error("[useUniversalDashboardActions] Failed to move ticket:",x),s.error("Ошибка перемещения",x.message||"Не удалось переместить тикет"),x}},g=async(_,A)=>{try{const W=r(),x=C(_);if(!x)throw new Error("Тикет не найден");await W.updateTicketAssignment(_,x.stageId,A);const D=o.getEmployeeById(A),E=D?D.name:"сотруднику";s.success("Тикет назначен",`Тикет назначен ${E}`),await i({forceRefresh:!0})}catch(W){throw console.error("[useUniversalDashboardActions] Failed to assign ticket:",W),s.error("Ошибка назначения",W.message||"Не удалось назначить тикет"),W}},v=async()=>{try{r().clearCache(),s.success("Кеш очищен","Кеш сектора успешно очищен"),await i({forceRefresh:!0})}catch(_){throw console.error("[useUniversalDashboardActions] Failed to clear cache:",_),s.error("Ошибка очистки",_.message||"Не удалось очистить кеш"),_}},T=async()=>{try{return await r().getSectorStats()}catch(_){throw console.error("[useUniversalDashboardActions] Failed to get sector stats:",_),_}},f=()=>{Ee(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/state")}).catch(_=>{console.error("Failed to navigate to graph state:",_)})},p=()=>{Ee(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/admission-closure")}).catch(_=>{console.error("Failed to navigate to admission closure:",_)})},y=()=>{Ee(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/tickets/time-tracking")}).catch(_=>{console.error("Failed to navigate to tickets management:",_)})},S=(_,A)=>!(!_||!A||_.stageId===A),C=_=>{for(const A of o.stages){const W=A.tickets?.find(x=>x.id===_);if(W)return{...W,stageId:A.id}}for(const[A,W]of Object.entries(o.zeroPointTickets)){const x=W.find(D=>D.id===_);if(x)return{...x,stageId:A}}return null},k=_=>{const A=o.getStageById(_);return A?A.name:_};return{loadSectorData:i,updateTicketAssignment:n,createTicket:l,moveTicket:d,assignTicketToEmployee:g,clearCache:v,getSectorStats:T,navigateToGraphState:f,navigateToAdmissionClosure:p,navigateToTicketsManagement:y,canMoveTicket:S,findTicket:C,getStageName:k}}const bn={name:"SectorDashboard",components:{BackButton:ba},props:{sectorId:{type:String,required:!0,validator:o=>["1c","pdm","bitrix24","infrastructure"].includes(o)}},setup(o){try{console.log(`[SectorDashboard] 🎯 SETUP called for sector: ${o.sectorId}`);const e=Xe(),s=ps(),t=qo(o.sectorId),r=kn(t,o.sectorId),i=I(null),n=I(null),l=M(()=>({"1c":"1С",pdm:"PDM",bitrix24:"Битрикс24",infrastructure:"Инфраструктура"})[o.sectorId]||o.sectorId),d=M(()=>(i.value,!1)),g=()=>{e.push("/")},v=()=>{r.loadSectorData({forceRefresh:!0})},T=()=>{e.push({name:s.name,query:{...s.query,diagnostics:"true"}})},f=()=>{r.clearCache()},p=()=>{r.navigateToGraphState()},y=()=>{r.navigateToAdmissionClosure()},S=()=>{r.navigateToTicketsManagement()};return $e(async()=>{console.log(`[SectorDashboard] 🚀 Mounted for sector: ${o.sectorId} (${l.value})`);try{console.log(`[SectorDashboard] 📡 Starting data load for sector: ${o.sectorId}`),await r.loadSectorData(),console.log(`[SectorDashboard] ✅ Data loaded successfully for sector: ${o.sectorId}`,{hasData:t.hasData,totalTickets:t.totalTickets,stagesCount:t.stages.length,employeesCount:t.employees.length,completionRate:t.completionRate,stages:t.stages.map(C=>({id:C.id,name:C.name,ticketsCount:C.tickets?.length||0})),renderingCondition:!t.isLoading&&!t.error,stagesLength:t.stages.length})}catch(C){console.error(`[SectorDashboard] ❌ Failed to load initial data for sector ${o.sectorId}:`,C),console.log("[SectorDashboard] 🔍 Error details:",{message:C.message,stack:C.stack})}}),{...t,...r,sectorName:l,currentUser:i,draggedTicket:n,isUserAdmin:d,handleGoHome:g,handleRetry:v,navigateToGraphState:p,navigateToAdmissionClosure:y,navigateToTicketsManagement:S,getZeroPointTickets:t.getZeroPointTickets}}catch(e){return console.error(`[SectorDashboard] 💥 CRITICAL ERROR in setup for sector ${o.sectorId}:`,e),console.error("[SectorDashboard] Error stack:",e.stack),console.error("[SectorDashboard] Error message:",e.message),{isLoading:!1,error:`Ошибка инициализации компонента: ${e.message}`,stages:[],employees:[],totalTickets:0,sectorName:o.sectorId,hasData:!1}}}},_n={style:{background:"yellow",padding:"10px","margin-bottom":"10px",border:"2px solid red"}},wn={class:"dashboard-header"},Cn={class:"breadcrumbs-row"},Tn={class:"breadcrumb-current"},Sn={class:"header-actions"},Dn={class:"sector-stats"},En={class:"stat-item"},An={class:"stat-value"},$n={class:"stat-item"},In={class:"stat-value"},Mn={class:"stat-item"},Nn={class:"stat-value"},xn={class:"stat-item"},Ln={class:"stat-value"},Pn={key:0,class:"loading-container"},On={key:0,class:"error-message"},Bn={key:0,class:"error-message-container"},Rn={class:"error-message"},Wn={class:"error-header"},Un={class:"error-text"},Fn={class:"error-actions"},Hn={key:0,class:"dashboard-content"},jn={style:{background:"#f0f0f0",padding:"10px","margin-bottom":"20px","font-size":"12px"}},zn={key:0,class:"stages-container"},Vn={class:"stage-header"},Gn={class:"stage-stats"},Kn={class:"stat"},qn={class:"stat"},Yn={class:"stage-content"},Xn={key:0,class:"tickets-list"},Jn={class:"ticket-id"},Zn={class:"ticket-title"},Qn={key:0,class:"more-tickets"},er={key:1,class:"no-tickets"},tr={key:1,class:"loading-message"},sr={key:2,class:"error-message"},ar={key:3,class:"empty-state"},or={class:"empty-state-content"},nr={class:"sector-info"};function rr(o,e,s,t,r,i){const n=be("BackButton");return c(),u("div",{class:X(`dashboard-sector-${s.sectorId} ${o.draggedTicket?"is-dragging":""}`)},[a("div",_n," 🚨 DEBUG: SectorDashboard RENDERED for sector: "+m(s.sectorId),1),a("div",wn,[a("div",Cn,[a("button",{class:"btn-home-link",type:"button",onClick:e[0]||(e[0]=(...l)=>o.handleGoHome&&o.handleGoHome(...l)),title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),e[10]||(e[10]=a("span",{class:"breadcrumb-separator"},"/",-1)),a("span",Tn,"Дашборд сектора "+m(o.sectorName),1)]),ne(n,{variant:"header"}),a("h1",null,"Дашборд - Сектор "+m(o.sectorName),1),a("div",Sn,[o.isDiagnosticsEnabled&&o.isUserAdmin?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...l)=>o.clearCache&&o.clearCache(...l)),class:"btn-clear-cache",title:"Сбросить кеш сектора и тикетов"},[...e[11]||(e[11]=[a("span",{class:"icon"},"♻️",-1),a("span",null,"Сбросить кеш",-1)])])):$("",!0),!o.isDiagnosticsEnabled&&o.isUserAdmin?(c(),u("button",{key:1,onClick:e[2]||(e[2]=(...l)=>o.enableDiagnostics&&o.enableDiagnostics(...l)),class:"btn-enable-diagnostics",title:"Включить диагностический режим"},[...e[12]||(e[12]=[a("span",{class:"icon"},"🔍",-1),a("span",null,"Диагностика",-1)])])):$("",!0),a("button",{onClick:e[3]||(e[3]=(...l)=>o.navigateToGraphState&&o.navigateToGraphState(...l)),class:"btn-navigate-graph-state",title:"Перейти к графику состояния сектора"},[...e[13]||(e[13]=[a("span",{class:"icon"},"📊",-1),a("span",null,"График состояния",-1)])]),a("button",{onClick:e[4]||(e[4]=(...l)=>o.navigateToAdmissionClosure&&o.navigateToAdmissionClosure(...l)),class:"btn-navigate-admission-closure",title:"Перейти к графику приемки-закрытия"},[...e[14]||(e[14]=[a("span",{class:"icon"},"📈",-1),a("span",null,"Приемка-закрытие",-1)])]),a("button",{onClick:e[5]||(e[5]=(...l)=>o.navigateToTicketsManagement&&o.navigateToTicketsManagement(...l)),class:"btn-navigate-tickets",title:"Перейти к управлению тикетами"},[...e[15]||(e[15]=[a("span",{class:"icon"},"📋",-1),a("span",null,"Управление тикетами",-1)])])])]),a("div",Dn,[a("div",En,[a("div",An,m(o.totalTickets),1),e[16]||(e[16]=a("div",{class:"stat-label"},"Всего тикетов",-1))]),a("div",$n,[a("div",In,m(o.employees.length),1),e[17]||(e[17]=a("div",{class:"stat-label"},"Сотрудников",-1))]),a("div",Mn,[a("div",Nn,m(o.completionRate)+"%",1),e[18]||(e[18]=a("div",{class:"stat-label"},"Завершено",-1))]),a("div",xn,[a("div",Ln,m(o.stages.length),1),e[19]||(e[19]=a("div",{class:"stat-label"},"Этапов",-1))])]),ne(Ae,{name:"fade",mode:"out-in"},{default:pe(()=>[o.isLoading?(c(),u("div",Pn,[e[20]||(e[20]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,m(o.currentStep||"Загрузка данных сектора..."),1),o.error?(c(),u("div",On,[a("p",null,m(o.error),1),a("button",{onClick:e[6]||(e[6]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Повторить")])):$("",!0)])):$("",!0)]),_:1}),o.error&&!o.isLoading?(c(),u("div",Bn,[a("div",Rn,[a("div",Wn,[e[21]||(e[21]=a("span",{class:"error-icon"},"❌",-1)),e[22]||(e[22]=a("h3",null,"Ошибка загрузки данных сектора",-1)),a("button",{onClick:e[7]||(e[7]=(...l)=>o.handleErrorClose&&o.handleErrorClose(...l)),class:"error-close","aria-label":"Закрыть"},"✕")]),a("p",Un,m(o.error),1),a("div",Fn,[a("button",{onClick:e[8]||(e[8]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Повторить загрузку")])])])):$("",!0),ne(Ae,{name:"dashboard-fade"},{default:pe(()=>[!o.isLoading&&!o.error?(c(),u("div",Hn,[a("div",jn," DEBUG: stages.length = "+m(o.stages.length)+", isLoading = "+m(o.isLoading)+", error = "+m(o.error),1),o.stages.length>0?(c(),u("div",zn,[(c(!0),u(ee,null,te(o.stages,l=>(c(),u("div",{key:l.id,class:"stage-card",style:we({borderLeftColor:l.color})},[a("div",Vn,[a("h3",null,m(l.name),1),a("div",Gn,[a("span",Kn,m(l.tickets?.length||0)+" тикетов",1),a("span",qn,m(l.employees?.length||0)+" сотрудников",1)])]),a("div",Yn,[l.tickets&&l.tickets.length>0?(c(),u("div",Xn,[(c(!0),u(ee,null,te(l.tickets.slice(0,3),d=>(c(),u("div",{key:d.id,class:"ticket-item"},[a("span",Jn,"#"+m(d.id),1),a("span",Zn,m(d.title),1)]))),128)),l.tickets.length>3?(c(),u("div",Qn," ...и еще "+m(l.tickets.length-3)+" тикетов ",1)):$("",!0)])):(c(),u("div",er," Нет активных тикетов "))])],4))),128))])):o.isLoading?(c(),u("div",tr," Загрузка данных сектора... ")):o.error?(c(),u("div",sr," Ошибка загрузки: "+m(o.error),1)):(c(),u("div",ar,[a("div",or,[e[29]||(e[29]=a("div",{class:"empty-icon"},"📋",-1)),a("h3",null,'Сектор "'+m(o.sectorName)+'" в разработке',1),e[30]||(e[30]=a("p",null,"Этот сектор находится в стадии разработки. Скоро здесь появятся реальные данные и функциональность.",-1)),a("div",nr,[e[28]||(e[28]=a("h4",null,"Информация о секторе:",-1)),a("ul",null,[a("li",null,[e[23]||(e[23]=a("strong",null,"ID:",-1)),ce(" "+m(s.sectorId),1)]),a("li",null,[e[24]||(e[24]=a("strong",null,"Название:",-1)),ce(" "+m(o.sectorName),1)]),a("li",null,[e[25]||(e[25]=a("strong",null,"Этапов:",-1)),ce(" "+m(o.stages.length),1)]),a("li",null,[e[26]||(e[26]=a("strong",null,"Сотрудников:",-1)),ce(" "+m(o.employees.length),1)]),a("li",null,[e[27]||(e[27]=a("strong",null,"Тикетов:",-1)),ce(" "+m(o.totalTickets),1)])])]),a("button",{onClick:e[9]||(e[9]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Обновить данные")])]))])):$("",!0)]),_:1}),ne(n,{variant:"floating"})],2)}const $a=de(bn,[["render",rr],["__scopeId","data-v-df4dc634"]]),ir=Object.freeze(Object.defineProperty({__proto__:null,default:$a},Symbol.toStringTag,{value:"Module"})),Ia="/api/tickets-time-tracking-sector-1c.php";function lr(o){if(!o)return{meta:null,data:{totalElapsedTime:0,totalElapsedTimeUnit:"hours",totalRecordsCount:0,weeks:[],employeesSummary:[]}};const e=o.data||o.result||o,s=e.meta||o.meta||null;return{meta:{weekNumber:s?.weekNumber??null,weekStartUtc:s?.weekStartUtc??null,weekEndUtc:s?.weekEndUtc??null,totalWeeks:s?.totalWeeks??0,sector1CEmployeesCount:s?.sector1CEmployeesCount??0},data:{totalElapsedTime:e.data?.totalElapsedTime??e.totalElapsedTime??0,totalElapsedTimeUnit:e.data?.totalElapsedTimeUnit??e.totalElapsedTimeUnit??"hours",totalRecordsCount:e.data?.totalRecordsCount??e.totalRecordsCount??0,weeks:e.data?.weeks??e.weeks??[],employeesSummary:e.data?.employeesSummary??e.employeesSummary??[]}}}async function cr(o={}){const{product:e="1C",weekStartUtc:s=null,weekEndUtc:t=null,weeksCount:r=4}=o;try{const i=tt(Ia),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:e,weekStartUtc:s,weekEndUtc:t,weeksCount:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(l.error)throw new Error(l.error_description||l.error||"Unknown error");const d=lr(l);if(l.cache_used===!0){const{CacheNotificationService:g}=await Ee(async()=>{const{CacheNotificationService:v}=await Promise.resolve().then(()=>b$);return{CacheNotificationService:v}},void 0,import.meta.url);g.notifyCacheUsed("Трудозатраты на Тикеты сектора 1С")}return d}catch(i){throw console.error("[TimeTrackingService] Error fetching time tracking data:",i),i}}async function dr({taskIds:o,employeeId:e,weekNumber:s,page:t=1,perPage:r=10}){if(!o||!Array.isArray(o)||o.length===0)return{tasks:[],pagination:{totalTasks:0,currentPage:1,perPage:r,totalPages:0}};try{const i=tt(Ia),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:"1C",includeTaskDetails:!0,taskIds:o,employeeId:e||void 0,weekNumber:s||void 0,page:t,perPage:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.error||l.error_description||"Ошибка получения данных о задачах");return{tasks:l.data.tasks||[],pagination:l.data.pagination||{totalTasks:0,currentPage:1,perPage:r,totalPages:0}}}catch(i){throw console.error("[timeTrackingService] Error loading tasks details:",i),i}}const Ma={getTimeTrackingData:cr,getTasksDetails:dr};function qe(o,e=1){return typeof o!="number"||isNaN(o)?"0 ч":`${o.toFixed(e)} ч`}function os(o,e){if(!o||!e)return`Неделя ${o||"?"}`;try{const s=new Date(e),t=new Date(s);t.setDate(t.getDate()+6);const r=s.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),i=t.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"});return`Неделя ${o} (${r} - ${i})`}catch(s){return console.error("[TimeTrackingUtils] Error formatting week label:",s),`Неделя ${o}`}}function ur(o){return!o||!o.data?!1:o.data.totalRecordsCount>0||o.data.weeks&&o.data.weeks.length>0}const gr={class:"ttt-summary"},mr={class:"summary-cards"},hr={class:"summary-card summary-card--total"},fr={class:"summary-card__content"},vr={class:"summary-card__value"},pr={class:"summary-card summary-card--employees"},yr={class:"summary-card__content"},kr={class:"summary-card__value"},br={class:"summary-card summary-card--average"},_r={class:"summary-card__content"},wr={class:"summary-card__value"},Cr={__name:"TicketsTimeTrackingSummary",props:{data:{type:Object,required:!0}},setup(o){const e=o,s=M(()=>e.data?.data?.totalElapsedTime||0),t=M(()=>e.data?.meta?.sector1CEmployeesCount||0),r=M(()=>{const l=s.value,d=t.value;return d>0?l/d:0}),i=M(()=>s.value===0?"0.0 ч":qe(s.value,1)),n=M(()=>r.value===0?"0.00 ч":qe(r.value,2));return(l,d)=>(c(),u("div",gr,[a("div",mr,[a("div",hr,[d[1]||(d[1]=a("div",{class:"summary-card__icon"},"⏱",-1)),a("div",fr,[d[0]||(d[0]=a("div",{class:"summary-card__label"},"Общая сумма трудозатрат",-1)),a("div",vr,m(i.value),1)])]),a("div",pr,[d[3]||(d[3]=a("div",{class:"summary-card__icon"},"👥",-1)),a("div",yr,[d[2]||(d[2]=a("div",{class:"summary-card__label"},"Сотрудников в секторе",-1)),a("div",kr,m(t.value),1)])]),a("div",br,[d[5]||(d[5]=a("div",{class:"summary-card__icon"},"📊",-1)),a("div",_r,[d[4]||(d[4]=a("div",{class:"summary-card__label"},"Средняя на сотрудника",-1)),a("div",wr,m(n.value),1)])])])]))}},Tr=de(Cr,[["__scopeId","data-v-51b124c7"]]),Sr={class:"ttt-table-container"},Dr={key:0,class:"ttt-table-loading"},Er={key:1,class:"ttt-table-error"},Ar={key:2,class:"ttt-table-empty"},$r={key:3,class:"ttt-table-wrapper"},Ir={class:"ttt-table"},Mr=["onClick"],Nr={class:"ttt-table__header-week-date"},xr=["onClick"],Lr={class:"ttt-table__cell-employee"},Pr=["onClick"],Or={class:"ttt-table__cell-total"},Br={class:"ttt-table__row-total"},Rr=["onClick"],Wr={class:"ttt-table__cell-total"},Ur={__name:"TicketsTimeTrackingTable",props:{data:{type:Object,required:!0},loading:{type:Boolean,default:!1},error:{type:String,default:null}},emits:["cell-click","employee-click","week-click"],setup(o,{emit:e}){const s=o,t=e,r=M(()=>s.data?.data?.weeks||[]),i=M(()=>{if(!s.data||!s.data.data||!s.data.data.weeks)return null;const f=s.data.data.weeks||[],y=(s.data.data.employeesSummary||[]).map(k=>{const _={};let A=0;return f.forEach(W=>{const D=W.employees?.find(E=>E.id===k.id)?.elapsedTime||0;_[W.weekNumber]=D,A+=D}),{id:k.id,name:k.name,weeks:_,total:A}}),S={};let C=0;return f.forEach(k=>{S[k.weekNumber]=k.totalElapsedTime||0,C+=k.totalElapsedTime||0}),{employees:y,weekTotals:S,grandTotal:C}}),n=(f,p)=>i.value?.employees.find(S=>S.id===f)?.weeks[p]||0,l=f=>i.value?.weekTotals[f]||0,d=f=>{if(!f)return"";try{return new Date(f).toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}catch{return""}},g=(f,p)=>{const y=i.value?.employees.find(C=>C.id===f),S=s.data?.data?.weeks?.find(C=>C.weekNumber===p);y&&S&&t("cell-click",{employee:y,week:S,elapsedTime:n(f,p)})},v=f=>{const p=i.value?.employees.find(y=>y.id===f);p&&t("employee-click",{employee:p,weeks:r.value.map(y=>({week:y,elapsedTime:n(f,y.weekNumber)}))})},T=f=>{const p=r.value.find(y=>y.weekNumber===f);p&&t("week-click",{week:p,employees:i.value?.employees.map(y=>({employee:y,elapsedTime:n(y.id,f)})).filter(y=>y.elapsedTime>0)})};return(f,p)=>(c(),u("div",Sr,[o.loading?(c(),u("div",Dr," Загрузка данных... ")):o.error?(c(),u("div",Er,m(o.error),1)):!i.value||i.value.employees.length===0?(c(),u("div",Ar," Нет данных о трудозатратах за выбранный период ")):(c(),u("div",$r,[a("table",Ir,[a("thead",null,[a("tr",null,[p[1]||(p[1]=a("th",{class:"ttt-table__header-employee"},"Сотрудник",-1)),(c(!0),u(ee,null,te(r.value,y=>(c(),u("th",{key:y.weekNumber,class:X(["ttt-table__header-week",{"ttt-table__header--clickable":!0}]),onClick:S=>T(y.weekNumber)},[ce(" Неделя "+m(y.weekNumber),1),p[0]||(p[0]=a("br",null,null,-1)),a("span",Nr,m(d(y.weekStartUtc)),1)],8,Mr))),128)),p[2]||(p[2]=a("th",{class:"ttt-table__header-total"},"Итого",-1))])]),a("tbody",null,[(c(!0),u(ee,null,te(i.value.employees,y=>(c(),u("tr",{key:y.id,class:X(["ttt-table__row",{"ttt-table__row--clickable":!0}]),onClick:S=>v(y.id)},[a("td",Lr,m(y.name),1),(c(!0),u(ee,null,te(r.value,S=>(c(),u("td",{key:`${y.id}-${S.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:Ce(C=>g(y.id,S.weekNumber),["stop"])},m(We(qe)(n(y.id,S.weekNumber))),9,Pr))),128)),a("td",Or,[a("strong",null,m(We(qe)(y.total)),1)])],8,xr))),128)),a("tr",Br,[p[3]||(p[3]=a("td",{class:"ttt-table__cell-employee"},[a("strong",null,"ВСЕГО")],-1)),(c(!0),u(ee,null,te(r.value,y=>(c(),u("td",{key:`total-${y.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:S=>T(y.weekNumber)},[a("strong",null,m(We(qe)(l(y.weekNumber))),1)],8,Rr))),128)),a("td",Wr,[a("strong",null,m(We(qe)(i.value.grandTotal)),1)])])])])]))]))}},Fr=de(Ur,[["__scopeId","data-v-8021e5e4"]]),Hr={class:"modal-header"},jr={class:"modal-body"},zr={key:"level-1",class:"detail-cell"},Vr={class:"detail-info"},Gr={key:0,class:"tasks-list"},Kr={class:"task-header"},qr={class:"task-label"},Yr={class:"task-time"},Xr={key:0,class:"ticket-info"},Jr={class:"ticket-label"},Zr=["title"],Qr={key:1,class:"ticket-title"},ei={key:1,class:"ticket-info ticket-info--no-ticket"},ti={class:"detail-total"},si={key:0,class:"detail-actions"},ai={key:"level-2",class:"tasks-list-level"},oi={class:"tasks-list-header"},ni={class:"tasks-list-title"},ri={class:"tasks-list-content"},ii={key:"loading",class:"loading-state"},li={key:"error",class:"error-state"},ci={class:"error-message"},di={key:"empty",class:"empty-state"},ui={key:"tasks",class:"tasks-cards-container"},gi=["onClick"],mi={class:"task-card__header"},hi={class:"task-card__number"},fi={key:0,class:"task-card__time"},vi={class:"task-card__title"},pi={class:"task-card__dates"},yi={class:"task-card__date-item"},ki={class:"date-value"},bi={class:"task-card__date-item"},_i={class:"task-card__date-item"},wi={class:"date-value"},Ci={key:0,class:"task-card__ticket"},Ti={class:"ticket-header"},Si={class:"ticket-header__left"},Di={class:"ticket-id"},Ei=["title"],Ai={class:"ticket-title"},$i={class:"ticket-meta"},Ii={class:"ticket-meta__row"},Mi={class:"ticket-meta__item"},Ni={class:"meta-value"},xi={class:"ticket-meta__item"},Li={class:"meta-value"},Pi={class:"ticket-meta__row"},Oi={class:"ticket-meta__item"},Bi={class:"meta-value"},Ri={class:"ticket-meta__item"},Wi={class:"meta-value"},Ui={class:"ticket-dates"},Fi={class:"ticket-date-item"},Hi={class:"date-value"},ji={key:1,class:"task-card__no-ticket"},zi={key:0,class:"tasks-pagination"},Vi=["disabled"],Gi={class:"pagination-pages"},Ki=["onClick"],qi=["disabled"],Yi={key:"employee",class:"detail-employee"},Xi={class:"detail-info"},Ji={class:"weeks-list"},Zi={class:"week-header"},Qi={class:"week-label"},el={class:"week-time"},tl={key:"week",class:"detail-week"},sl={class:"detail-info"},al={class:"employees-list"},ol={class:"employee-header"},nl={class:"employee-label"},rl={class:"employee-time"},il={__name:"TimeTrackingDetailModal",props:{cellData:{type:Object,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=e,r=I(1),i=I([]),n=I(!1),l=I(null),d=I(1),g=I(10),v=M(()=>{if(!s.cellData)return"Детализация трудозатрат";if(r.value===2)return`Список задач: ${s.cellData.employee?.name||"Сотрудник"}, Неделя ${s.cellData.week?.weekNumber||"?"}`;if(s.cellData.type==="employee")return`Детализация: ${s.cellData.employee?.name||"Сотрудник"}`;if(s.cellData.type==="week")return`Детализация: Неделя ${s.cellData.week?.weekNumber||"?"}`;const Y=s.cellData.employee?.name||"Сотрудник",H=s.cellData.week?.weekNumber||"?",Z=qe(s.cellData.elapsedTime||0);return`Детализация: ${Y}, Неделя ${H} (${Z})`}),T=M(()=>s.cellData?.week?.employees&&s.cellData.week.employees.find(H=>H.id===s.cellData.employee?.id)?.tasksCount||0),f=M(()=>s.cellData?.week?.employees&&s.cellData.week.employees.find(H=>H.id===s.cellData.employee?.id)?.ticketsCount||0);M(()=>s.cellData?.week?.weekNumber||null);const p=I({totalTasks:0,currentPage:1,perPage:10,totalPages:0}),y=M(()=>p.value.totalPages),S=M(()=>i.value),C=M(()=>{const Y=[];let Z=Math.max(1,p.value.currentPage-Math.floor(2.5)),fe=Math.min(y.value,Z+5-1);fe-Z<4&&(Z=Math.max(1,fe-5+1));for(let P=Z;P<=fe;P++)Y.push(P);return Y}),k=Y=>{if(!Y||Y.length===0)return"Период не указан";if(Y.length===1)return os(Y[0].week.weekNumber,Y[0].week.weekStartUtc);const H=Y[0].week,Z=Y[Y.length-1].week;return`${os(H.weekNumber,H.weekStartUtc)} - ${os(Z.weekNumber,Z.weekStartUtc)}`},_=Y=>Y?os(Y.weekNumber,Y.weekStartUtc):"Период не указан",A=Y=>{if(!Y)return"-";try{const H=new Date(Y);return isNaN(H.getTime())?"-":H.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})}catch(H){return console.warn("[TimeTrackingDetailModal] Error formatting date:",Y,H),"-"}},W=(Y,H)=>{if(H)try{const Z=new Date(H);if(!isNaN(Z.getTime()))return!1}catch{}if(!Y)return!1;try{const Z=new Date(Y);return isNaN(Z.getTime())?!1:new Date>Z}catch(Z){return console.warn("[TimeTrackingDetailModal] Error checking overdue:",Y,Z),!1}},x=Y=>{const H=Y.closedDate?new Date(Y.closedDate):null,Z=W(Y.deadline,Y.closedDate);return{"task-card--completed":!!H,"task-card--overdue":Z,"task-card--in-progress":!H&&!Z}},D=async()=>{r.value=2,await B()},E=()=>{r.value=1,i.value=[],l.value=null,d.value=1,p.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0}},L=Y=>!Y||typeof Y!="object"?!1:!Y.id||typeof Y.id!="number"?(console.warn("[TimeTrackingDetailModal] Invalid task (no ID):",Y),!1):!0,B=async()=>{if(!s.cellData?.week?.employees||!s.cellData.employee){l.value="Недостаточно данных для загрузки задач";return}n.value=!0,l.value=null;try{const Y=s.cellData.week.employees.find(fe=>fe.id===s.cellData.employee?.id);if(!Y){i.value=[];return}let H=[];if(Array.isArray(Y.tasks)&&Y.tasks.length>0&&(H=Y.tasks.map(fe=>typeof fe=="object"&&fe!==null&&fe.id?fe.id:typeof fe=="number"?fe:null).filter(fe=>fe!==null&&fe>0)),H.length===0){i.value=[];return}const Z=await Ma.getTasksDetails({taskIds:H,employeeId:s.cellData.employee.id,weekNumber:s.cellData.week.weekNumber,page:d.value,perPage:g.value});if(!Z||!Array.isArray(Z.tasks)){console.error("[TimeTrackingDetailModal] Invalid response format:",Z),l.value="Некорректный формат данных от сервера",i.value=[];return}i.value=Z.tasks.filter(L),p.value=Z.pagination||{totalTasks:0,currentPage:1,perPage:g.value,totalPages:0},d.value=p.value.currentPage}catch(Y){console.error("[TimeTrackingDetailModal] Error loading tasks details:",{error:Y,taskIds:s.cellData?.week?.employees?.find(Z=>Z.id===s.cellData.employee?.id)?.tasks?.map(Z=>Z.id)||[],employeeId:s.cellData.employee?.id,weekNumber:s.cellData.week?.weekNumber,timestamp:new Date().toISOString()});const H=Y.message||"";H.includes("network")||H.includes("fetch")||H.includes("Failed to fetch")?l.value="Ошибка сети. Проверьте подключение к интернету.":H.includes("timeout")?l.value="Превышено время ожидания. Попробуйте позже.":H.includes("403")||H.includes("401")?l.value="Ошибка доступа. Проверьте права доступа.":H.includes("404")?l.value="Данные не найдены.":H.includes("500")?l.value="Ошибка сервера. Попробуйте позже.":l.value=H||"Ошибка загрузки задач",i.value=[]}finally{n.value=!1}},U=()=>{d.value=1,B()};Ne(d,()=>{r.value===2&&B()});const G=Y=>{if(Y>=1&&Y<=y.value&&Y!==d.value){d.value=Y;const H=document.querySelector(".tasks-cards-container");H&&(H.scrollTop=0)}},q=Y=>{console.log("[TimeTrackingDetailModal] Task clicked:",Y.id)},oe=()=>{t("close")};return Ne(()=>s.cellData,Y=>{Y||(r.value=1,i.value=[],l.value=null,d.value=1,p.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0})}),(Y,H)=>(c(),he(It,{to:"body"},[o.cellData?(c(),u("div",{key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true",onClick:Ce(oe,["self"]),onKeydown:Re(oe,["esc"])},[a("div",{class:"modal-content",onClick:H[2]||(H[2]=Ce(()=>{},["stop"]))},[a("div",Hr,[a("h2",null,m(v.value),1),a("button",{class:"close-button",onClick:oe,"aria-label":"Закрыть"},"×")]),a("div",jr,[ne(Ae,{name:"level",mode:"out-in"},{default:pe(()=>[r.value===1&&(o.cellData.type==="cell"||!o.cellData.type&&o.cellData.employee&&o.cellData.week)?(c(),u("div",zr,[a("div",Vr,[a("p",null,[H[3]||(H[3]=a("strong",null,"Сотрудник:",-1)),ce(" "+m(o.cellData.employee?.name||"Неизвестно"),1)]),a("p",null,[H[4]||(H[4]=a("strong",null,"Неделя:",-1)),ce(" "+m(o.cellData.week?.weekNumber||"?"),1)]),a("p",null,[H[5]||(H[5]=a("strong",null,"Трудозатраты:",-1)),ce(" "+m(We(qe)(o.cellData.elapsedTime||0)),1)])]),o.cellData.week?.employees?(c(),u("div",Gr,[H[8]||(H[8]=a("h3",null,"Задачи и связанные тикеты:",-1)),(c(!0),u(ee,null,te(o.cellData.week.employees.filter(Z=>Z.id===o.cellData.employee?.id),Z=>(c(),u("div",{key:Z.id,class:"employee-tasks"},[(c(!0),u(ee,null,te(Z.tasks,(fe,P)=>(c(),u("div",{class:"task-item",key:P},[a("div",Kr,[a("span",qr,"Задача #"+m(fe.id||P+1),1),a("span",Yr,m(We(qe)(fe.elapsedTime||0)),1)]),fe.ticket?(c(),u("div",Xr,[a("span",Jr,"Тикет #"+m(fe.ticket.id),1),fe.ticket.createdWeek&&fe.ticket.createdWeek!==o.cellData.week.weekNumber?(c(),u("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${fe.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week.weekNumber}`}," (создан в неделе "+m(fe.ticket.createdWeek)+") ",9,Zr)):$("",!0),fe.ticket.title?(c(),u("div",Qr,m(fe.ticket.title),1)):$("",!0)])):(c(),u("div",ei,[...H[6]||(H[6]=[a("span",{class:"no-ticket-label"},"Тикет не связан",-1)])]))]))),128))]))),128)),a("div",ti,[a("p",null,[H[7]||(H[7]=a("strong",null,"Итого:",-1)),ce(" "+m(We(qe)(o.cellData.elapsedTime||0))+" ("+m(T.value)+" задач, "+m(f.value)+" тикетов) ",1)])]),T.value>0?(c(),u("div",si,[a("button",{class:"btn btn-primary btn-tasks-list",onClick:D}," 📋 Список задач ")])):$("",!0)])):$("",!0)])):r.value===2?(c(),u("div",ai,[a("div",oi,[a("button",{class:"btn-back",onClick:E,"aria-label":"Назад"}," ← Назад "),a("h3",ni," Список задач: "+m(o.cellData.employee?.name||"Сотрудник")+", Неделя "+m(o.cellData.week?.weekNumber||"?"),1)]),a("div",ri,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),u("div",ii,[...H[9]||(H[9]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка задач...",-1)])])):l.value?(c(),u("div",li,[H[10]||(H[10]=a("div",{class:"error-icon"},"⚠️",-1)),H[11]||(H[11]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",ci,m(l.value),1),a("button",{class:"btn btn-retry",onClick:U},"Повторить")])):i.value.length===0?(c(),u("div",di,[...H[12]||(H[12]=[a("div",{class:"empty-state-icon"},"📋",-1),a("p",{class:"empty-state-message"},"Нет задач для отображения",-1)])])):(c(),u("div",ui,[ne(et,{name:"task-card",tag:"div",class:"tasks-cards-list"},{default:pe(()=>[(c(!0),u(ee,null,te(S.value.filter(L),Z=>(c(),u("div",{key:Z.id,class:X(["task-card",x(Z)]),onClick:fe=>q(Z)},[a("div",mi,[a("span",hi,"Задача #"+m(Z.id),1),Z.elapsedTime?(c(),u("span",fi,m(We(qe)(Z.elapsedTime)),1)):$("",!0)]),a("div",vi,m(Z.title||"Без названия"),1),a("div",pi,[a("div",yi,[H[13]||(H[13]=a("span",{class:"date-icon"},"📅",-1)),H[14]||(H[14]=a("span",{class:"date-label"},"Начало:",-1)),a("span",ki,m(A(Z.startDate)),1)]),a("div",bi,[H[15]||(H[15]=a("span",{class:"date-icon"},"⏰",-1)),H[16]||(H[16]=a("span",{class:"date-label"},"Дедлайн:",-1)),a("span",{class:X(["date-value",{"date-value--overdue":W(Z.deadline,Z.closedDate)}])},m(A(Z.deadline)||"-"),3)]),a("div",_i,[H[17]||(H[17]=a("span",{class:"date-icon"},"✓",-1)),H[18]||(H[18]=a("span",{class:"date-label"},"Завершено:",-1)),a("span",wi,m(A(Z.closedDate)||"-"),1)])]),Z.ticket?(c(),u("div",Ci,[a("div",Ti,[a("div",Si,[a("span",Di,"Тикет #"+m(Z.ticket.id),1),Z.ticket.createdWeek&&Z.ticket.createdWeek!==o.cellData.week?.weekNumber?(c(),u("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${Z.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week?.weekNumber}`}," Создан в нед. "+m(Z.ticket.createdWeek),9,Ei)):$("",!0)])]),a("div",Ai,m(Z.ticket.title||Z.ticket.ufSubject||"Без названия"),1),a("div",$i,[a("div",Ii,[a("div",Mi,[H[19]||(H[19]=a("span",{class:"meta-label"},"Сектор:",-1)),a("span",Ni,m(Z.ticket.ufSlaBlockStr||"Не указан"),1)]),a("div",xi,[H[20]||(H[20]=a("span",{class:"meta-label"},"Сервис:",-1)),a("span",Li,m(Z.ticket.ufSlaServiceStr||"Не указан"),1)])]),a("div",Pi,[a("div",Oi,[H[21]||(H[21]=a("span",{class:"meta-label"},"Действие:",-1)),a("span",Bi,m(Z.ticket.ufActionStr||"Не указано"),1)]),a("div",Ri,[H[22]||(H[22]=a("span",{class:"meta-label"},"Приоритет:",-1)),a("span",Wi,m(Z.ticket.ufCrm7UfPriority||"Не указан"),1)])])]),a("div",Ui,[a("div",Fi,[H[23]||(H[23]=a("span",{class:"date-icon"},"📅",-1)),H[24]||(H[24]=a("span",{class:"date-label"},"Создан:",-1)),a("span",Hi,m(A(Z.ticket.createdTime)),1)])])])):(c(),u("div",ji,[...H[25]||(H[25]=[a("span",{class:"no-ticket-label"},"Тикет не связан",-1)])])),H[26]||(H[26]=a("div",{class:"task-card__status-placeholder"},null,-1))],10,gi))),128))]),_:1}),y.value>1?(c(),u("div",zi,[a("button",{class:"pagination-btn",disabled:p.value.currentPage===1,onClick:H[0]||(H[0]=Z=>G(p.value.currentPage-1))}," ← Предыдущая ",8,Vi),a("div",Gi,[(c(!0),u(ee,null,te(C.value,Z=>(c(),u("button",{key:Z,class:X(["pagination-page",{"pagination-page--active":Z===p.value.currentPage}]),onClick:fe=>G(Z)},m(Z),11,Ki))),128))]),a("button",{class:"pagination-btn",disabled:p.value.currentPage===y.value,onClick:H[1]||(H[1]=Z=>G(p.value.currentPage+1))}," Следующая → ",8,qi)])):$("",!0)]))]),_:1})])])):r.value===1&&o.cellData.type==="employee"?(c(),u("div",Yi,[a("div",Xi,[a("p",null,[H[27]||(H[27]=a("strong",null,"Сотрудник:",-1)),ce(" "+m(o.cellData.employee?.name||"Неизвестно"),1)]),a("p",null,[H[28]||(H[28]=a("strong",null,"Период:",-1)),ce(" "+m(k(o.cellData.weeks)),1)])]),a("div",Ji,[H[29]||(H[29]=a("h3",null,"Трудозатраты по неделям:",-1)),(c(!0),u(ee,null,te(o.cellData.weeks,Z=>(c(),u("div",{key:Z.week.weekNumber,class:"week-item"},[a("div",Zi,[a("span",Qi,"Неделя "+m(Z.week.weekNumber),1),a("span",el,m(We(qe)(Z.elapsedTime||0)),1)])]))),128))])])):r.value===1&&o.cellData.type==="week"?(c(),u("div",tl,[a("div",sl,[a("p",null,[H[30]||(H[30]=a("strong",null,"Неделя:",-1)),ce(" "+m(o.cellData.week?.weekNumber||"?"),1)]),a("p",null,[H[31]||(H[31]=a("strong",null,"Период:",-1)),ce(" "+m(_(o.cellData.week)),1)]),a("p",null,[H[32]||(H[32]=a("strong",null,"Общие трудозатраты:",-1)),ce(" "+m(We(qe)(o.cellData.week?.totalElapsedTime||0)),1)])]),a("div",al,[H[33]||(H[33]=a("h3",null,"Трудозатраты по сотрудникам:",-1)),(c(!0),u(ee,null,te(o.cellData.employees,Z=>(c(),u("div",{key:Z.employee.id,class:"employee-item"},[a("div",ol,[a("span",nl,m(Z.employee.name),1),a("span",rl,m(We(qe)(Z.elapsedTime||0)),1)])]))),128))])])):$("",!0)]),_:1})]),a("div",{class:"modal-footer"},[a("button",{class:"close-btn",onClick:oe},"Закрыть")])])],32)):$("",!0)]))}},ll=de(il,[["__scopeId","data-v-fc33390b"]]),cl={class:"tickets-time-tracking-dashboard"},dl={class:"dashboard-header"},ul={class:"breadcrumbs-row"},gl=["aria-label","aria-disabled","data-fallback","disabled"],ml={class:"breadcrumbs","aria-label":"Навигация"},hl={key:"preloader",class:"time-tracking-preloader"},fl={key:"error",class:"error-state"},vl={key:"empty",class:"empty-state"},pl={key:"content",class:"dashboard-content"},yl={__name:"TicketsTimeTrackingDashboard",setup(o){const e=Xe(),s=I(!0),t=I(null),r=I(null),i=I(null),n=I(!1),l=M(()=>ur(r.value)),d=async()=>{s.value=!0,t.value=null;const k=new Promise(_=>setTimeout(_,300));try{const[_,A]=await Promise.all([k,Ma.getTimeTrackingData({product:"1C",weeksCount:4})]);r.value=A}catch(_){console.error("[TicketsTimeTrackingDashboard] Error loading data:",_),t.value=_.message||"Не удалось загрузить данные"}finally{s.value=!1}},g=k=>{i.value=k},v=k=>{i.value={type:"employee",...k}},T=k=>{i.value={type:"week",...k}},f=()=>{i.value=null},p=M(()=>typeof window>"u"?!1:window.history.length>1),y=M(()=>p.value?"Вернуться назад":"Вернуться на главную"),S=()=>{n.value||(n.value=!0,p.value?e.go(-1):e.push({name:"dashboard-sector-1c"}),setTimeout(()=>{n.value=!1},300))},C=()=>{e.push("/")};return $e(()=>{d()}),(k,_)=>{const A=be("router-link");return c(),u("div",cl,[a("div",dl,[a("div",ul,[a("button",{class:"btn-home-link",type:"button",onClick:C,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),_[7]||(_[7]=a("span",{class:"breadcrumb-separator"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:S,"aria-label":y.value,"aria-disabled":!p.value,"data-fallback":!p.value,disabled:n.value,title:"Назад"}," ← ",8,gl),a("nav",ml,[ne(A,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[..._[0]||(_[0]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),_[3]||(_[3]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[..._[1]||(_[1]=[ce(" График состояния ",-1)])]),_:1}),_[4]||(_[4]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:pe(()=>[..._[2]||(_[2]=[ce(" График приёма и закрытий ",-1)])]),_:1}),_[5]||(_[5]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),_[6]||(_[6]=a("span",{class:"breadcrumb-current"},"Трудозатраты",-1))])])]),_[10]||(_[10]=a("h1",{class:"dashboard-title"},"Трудозатраты на Тикеты сектора 1С",-1)),$("",!0),ne(Ae,{name:"fade",mode:"out-in"},{default:pe(()=>[s.value?(c(),u("div",hl,[..._[8]||(_[8]=[a("div",{class:"preloader-content"},[a("div",{class:"preloader-spinner"},[a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"})]),a("h3",{class:"preloader-title"},"Загрузка данных"),a("p",{class:"preloader-message"},"Получение данных о трудозатратах..."),a("div",{class:"preloader-dots"},[a("span",{class:"dot"}),a("span",{class:"dot"}),a("span",{class:"dot"})])],-1)])])):t.value?(c(),u("div",fl,[a("p",null,"Ошибка загрузки данных: "+m(t.value),1),a("button",{onClick:d,class:"retry-button"},"Повторить попытку")])):l.value?(c(),u("div",pl,[r.value?(c(),he(Tr,{key:0,data:r.value},null,8,["data"])):$("",!0),r.value?(c(),he(Fr,{key:1,data:r.value,loading:s.value,error:t.value,onCellClick:g,onEmployeeClick:v,onWeekClick:T},null,8,["data","loading","error"])):$("",!0)])):(c(),u("div",vl,[..._[9]||(_[9]=[a("p",null,"Нет данных о трудозатратах за выбранный период",-1)])]))]),_:1}),i.value?(c(),he(ll,{key:1,"cell-data":i.value,onClose:f},null,8,["cell-data"])):$("",!0)])}}},Na=de(yl,[["__scopeId","data-v-2f7848de"]]),kl=Object.freeze(Object.defineProperty({__proto__:null,default:Na},Symbol.toStringTag,{value:"Module"}));Je.register(Xa,Ja,Za,Qa,eo,to,so,ao,oo,no);Je.defaults.responsive=!0;Je.defaults.maintainAspectRatio=!1;Je.defaults.plugins.legend.display=!0;Je.defaults.plugins.legend.position="top";const J={primary:"#007bff",success:"#28a745",danger:"#dc3545",warning:"#ffc107",info:"#17a2b8",carryover:"#ff9800",successLight:"#6cbf47",carryoverLight:"#ffb74d",carryoverDark:"#f57c00"},ht={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class pt{static getApiBaseUrl(){return go()}static async createSnapshot(e,s,t={}){try{if(!e||typeof e!="object")throw new St("sectorData должен быть объектом","VALIDATION_ERROR");if(!s||!["week_start","week_end","manual","current"].includes(s))throw new St("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(e);if(!r.isValid)throw new St(`Ошибка валидации данных сектора: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const i=this.normalizeSectorData(e),l={metadata:this.generateSnapshotMetadata(s,t.createdBy,t.sectorId||ht.defaultSectorId),statistics:i.statistics,ticketIds:i.ticketIds,tickets:i.tickets},d=this.validateSnapshot(l);if(!d.isValid)throw new St(`Ошибка валидации слепка: ${d.errors.join(", ")}`,"VALIDATION_ERROR",{validation:d});d.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",d.warnings);const g=this.getApiBaseUrl(),v=await fetch(`${g}${ht.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:s,date:this.formatDate(new Date)})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const T=await v.json();if(!T.success)throw new Error(T.message||"Ошибка создания слепка");return T.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof St?r:new St(`Ошибка создания слепка: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(e,s){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?action=get&date=${t}&type=${s}`,n=await fetch(i,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success){if(l.message&&l.message.includes("не найден"))return null;throw new Error(l.message||"Ошибка получения слепка")}return l.data.snapshot}catch(t){throw console.error("SnapshotService.getSnapshot error:",t),t}}static async getAllSnapshots(e={}){try{const s=new URLSearchParams;s.append("action","list"),e.startDate&&s.append("startDate",this.formatDate(e.startDate)),e.endDate&&s.append("endDate",this.formatDate(e.endDate)),e.type&&s.append("type",e.type),e.sectorId?s.append("sectorId",e.sectorId):s.append("sectorId",ht.defaultSectorId);const r=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?${s.toString()}`,i=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=await i.json();if(!n.success)throw new Error(n.message||"Ошибка получения списка слепков");return(await Promise.all(n.data.snapshots.map(async d=>{try{return await this.getSnapshot(d.date,d.type)}catch(g){return console.warn(`Ошибка загрузки слепка ${d.date}/${d.type}:`,g),null}}))).filter(d=>d!==null).sort((d,g)=>new Date(d.metadata.createdAt)-new Date(g.metadata.createdAt))}catch(s){throw console.error("SnapshotService.getAllSnapshots error:",s),s}}static normalizeSectorData(e){const{stages:s=[],employees:t=[],zeroPointTickets:r={}}=e,i={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},n=[],l=[],d=[];s.forEach(T=>{const f=T.id;if(i[f]){let p=0;T.employees.forEach(y=>{const S=y.tickets||[];p+=S.length;let C=n.find(k=>k.id===y.id);C||(C={id:y.id,name:y.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(C)),S.forEach(k=>{l.push(k.id),d.push({id:k.id,title:k.title||"Без названия",assignedTo:{id:y.id,name:y.name},createdAt:k.createdAt||"",updatedAt:k.modifiedAt||k.updatedAt||""}),C.ticketsByStage[f]=(C.ticketsByStage[f]||0)+1,C.totalTickets+=1})}),i[f].count=p}});const g={unassigned:0,keeper:0,total:0};Object.values(r).forEach(T=>{Array.isArray(T)&&T.forEach(f=>{g.total+=1,f.assigneeId===1051||f.assignedById===1051?g.keeper+=1:g.unassigned+=1,l.push(f.id),d.push({id:f.id,title:f.title||"Без названия",assignedTo:f.assignedTo||f.assignedById?{id:f.assignedById||f.assigneeId,name:"Неизвестный"}:null,createdAt:f.createdAt||"",updatedAt:f.modifiedAt||f.updatedAt||""})})});const v=Object.values(i).reduce((T,f)=>T+f.count,0)+g.total;return{statistics:{stages:{...i,total:v},employees:n,zeroPoint:g},ticketIds:[...new Set(l)],tickets:d}}static generateSnapshotMetadata(e,s,t){const r=new Date,i=-r.getTimezoneOffset(),n=Math.floor(i/60),l=i%60,d=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(l).padStart(2,"0")}`,g=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${d}`;return{version:ht.snapshotVersion,createdAt:g,createdBy:s||{id:0,name:"Система"},type:e,sectorId:t,sectorName:t==="1C"?"Сектор 1С":`Сектор ${t}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("Некорректная дата");const s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${s}-${t}-${r}`}static buildFilePath(e,s){const t=typeof e=="string"?new Date(e):e,r=t.getFullYear(),i=this.getWeekNumber(t),n=this.formatDate(e);let l;if(s==="current"){const d=new Date,g=`${String(d.getHours()).padStart(2,"0")}-${String(d.getMinutes()).padStart(2,"0")}-${String(d.getSeconds()).padStart(2,"0")}`;l=`current-state-${n}-${g}.json`}else if(s==="manual"){const d=new Date,g=`${String(d.getHours()).padStart(2,"0")}-${String(d.getMinutes()).padStart(2,"0")}-${String(d.getSeconds()).padStart(2,"0")}`;l=`manual-${n}-${g}.json`}else l=`${s}-${n}.json`;return s==="current"?`current/${l}`:`${r}/week-${i}/${l}`}static getWeekNumber(e){const s=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),t=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-t);const r=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-r)/864e5+1)/7)}static validateSnapshot(e){const s=[],t=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&s.push("Неверная версия формата данных"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&s.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(e.metadata.type)||s.push("Неверный тип слепка"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&s.push("Неверный идентификатор сектора"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&s.push("Неверная информация о создателе")):s.push("Отсутствуют метаданные слепка"),!e.statistics)s.push("Отсутствует статистика");else{if(!e.statistics.stages)s.push("Отсутствует статистика по этапам");else{const r=e.statistics.stages,i=(r.formed?.count||0)+(r.review?.count||0)+(r.execution?.count||0);r.total!==i&&t.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${r.total}`)}if(Array.isArray(e.statistics.employees)||s.push("Статистика по сотрудникам должна быть массивом"),!e.statistics.zeroPoint)s.push("Отсутствует статистика нулевой точки");else{const r=e.statistics.zeroPoint,i=(r.unassigned||0)+(r.keeper||0);r.total!==i&&t.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${r.total}`)}}if(Array.isArray(e.ticketIds)||s.push("ticketIds должен быть массивом"),!Array.isArray(e.tickets))s.push("tickets должен быть массивом");else{const r=new Set(e.ticketIds),i=new Set(e.tickets.map(n=>n.id));r.size!==i.size&&t.push("Количество ID в ticketIds не совпадает с количеством тикетов"),e.tickets.forEach((n,l)=>{n.id||s.push(`Тикет #${l}: отсутствует ID`),n.title||s.push(`Тикет #${l}: отсутствует заголовок`),(!n.assignedTo||!n.assignedTo.id)&&t.push(`Тикет #${l}: отсутствует ответственный (может быть в нулевой точке)`),n.createdAt||s.push(`Тикет #${l}: отсутствует дата создания`),n.updatedAt||s.push(`Тикет #${l}: отсутствует дата обновления`)})}return{isValid:s.length===0,errors:s,warnings:t}}static validateSectorData(e){const s=[],t=[];return!e||typeof e!="object"?(s.push("sectorData должен быть объектом"),{isValid:!1,errors:s,warnings:t}):(Array.isArray(e.stages)||s.push("stages должен быть массивом"),Array.isArray(e.employees)||s.push("employees должен быть массивом"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&s.push("zeroPointTickets должен быть объектом"),{isValid:s.length===0,errors:s,warnings:t})}static isValidISODate(e){if(typeof e!="string")return!1;const s=new Date(e);return!isNaN(s.getTime())&&e.includes("T")}static async deleteSnapshot(e,s){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}`,n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:t,type:s})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка удаления слепка");return!0}catch(t){throw console.error("SnapshotService.deleteSnapshot error:",t),t}}static async deleteSnapshotsByPeriod(e){try{const s=await this.getAllSnapshots(e);let t=0;for(const r of s)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&t++}catch(i){console.warn(`Ошибка удаления слепка ${r.metadata.createdAt}:`,i)}return t}catch(s){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",s),s}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,s=ht.snapshotVersion){const t=this.getSnapshotVersion(e);return t===s||t==="1.0"&&s==="1.0"?e:(console.warn(`Миграция с версии ${t} на ${s} пока не реализована`),{...e,metadata:{...e.metadata,version:s}})}static getWeekNumberInfo(e){const s=typeof e=="string"?new Date(e):e,t=this.getWeekNumber(s);return{year:s.getFullYear(),week:t}}static getWeekStartDate(e){const s=typeof e=="string"?new Date(e):e,r=(s.getDay()||7)-1,i=new Date(s);return i.setDate(s.getDate()-r),i.setHours(0,0,0,0),i}static getWeekEndDate(e){const s=typeof e=="string"?new Date(e):e,r=7-(s.getDay()||7),i=new Date(s);return i.setDate(s.getDate()+r),i.setHours(23,59,59,999),i}static async getSnapshotsForWeek(e){try{const s=this.getWeekStartDate(e),t=this.getWeekEndDate(e),r=this.getWeekNumberInfo(e),i=await this.getAllSnapshots({startDate:s,endDate:t}),n=i.find(g=>g.metadata.type==="week_start")||null,l=i.find(g=>g.metadata.type==="week_end")||null,d=i.filter(g=>g.metadata.type==="manual");return{weekStart:n,weekEnd:l,manual:d,weekInfo:r}}catch(s){throw console.error("SnapshotService.getSnapshotsForWeek error:",s),s}}static handleError(e){if(e instanceof St)return{message:e.message,code:e.code,details:e.details};let s="UNKNOWN_ERROR";return e.message.includes("валидац")?s="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("не найден")?s="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?s="API_ERROR":e.message.includes("версия")||e.message.includes("version")?s="VERSION_MISMATCH":(e.message.includes("доступ")||e.message.includes("permission"))&&(s="PERMISSION_DENIED"),{message:e.message||"Неизвестная ошибка",code:s,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const s=await this.getAllSnapshots(e),t={week_start:0,week_end:0,manual:0,current:0},r=new Map;let i=null,n=null;s.forEach(d=>{const g=d.metadata.type;t.hasOwnProperty(g)&&t[g]++;const v=this.getWeekNumberInfo(d.metadata.createdAt),T=`${v.year}-W${v.week}`;r.set(T,(r.get(T)||0)+1);const f=new Date(d.metadata.createdAt);(!i||f<new Date(i.metadata.createdAt))&&(i=d),(!n||f>new Date(n.metadata.createdAt))&&(n=d)});const l=Array.from(r.entries()).map(([d,g])=>{const[v,T]=d.split("-W");return{year:parseInt(v),week:parseInt(T),count:g}}).sort((d,g)=>d.year!==g.year?d.year-g.year:d.week-g.week);return{total:s.length,byType:t,byWeek:l,oldest:i,newest:n}}catch(s){throw console.error("SnapshotService.getSnapshotsStatistics error:",s),s}}}class St extends Error{constructor(e,s,t={}){super(e),this.name="SnapshotError",this.code=s,this.details=t}}const ft={formed:{bitrixId:Cs.formed,name:ws.FORMED.name},review:{bitrixId:Cs.review,name:ws.REVIEW.name},execution:{bitrixId:Cs.execution,name:ws.EXECUTION.name}},Zt=Qt;function bl(o){if(!o||typeof o!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!o.stages||!Array.isArray(o.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=_l(o.stages),s=wl(o.stages),t=Cl(o.zeroPointTickets||{}),r=Tl(o.zeroPointTickets||{}),i=Sl(o.stages,o.zeroPointTickets||{});return{statistics:{stages:e,employees:s,zeroPoint:t,zeroPointByStage:r},ticketIds:i.ticketIds,tickets:i.tickets}}function _l(o){const e={formed:{count:0,stageId:ft.formed.bitrixId,stageName:ft.formed.name},review:{count:0,stageId:ft.review.bitrixId,stageName:ft.review.name},execution:{count:0,stageId:ft.execution.bitrixId,stageName:ft.execution.name},total:0};return o.forEach(s=>{if(!ft[s.id]){console.warn(`Unknown stage ID: ${s.id}`);return}let t=0;s.employees&&Array.isArray(s.employees)&&s.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(t+=r.tickets.length)}),e[s.id].count=t,e.total+=t}),e}function wl(o){const e=new Map;return o.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(t=>{if(!t||!t.id)return;e.has(t.id)||e.set(t.id,{id:t.id,name:t.name||`Сотрудник #${t.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=e.get(t.id),i=t.tickets&&Array.isArray(t.tickets)?t.tickets.length:0;ft[s.id]&&(r.ticketsByStage[s.id]=(r.ticketsByStage[s.id]||0)+i),r.totalTickets+=i})}),Array.from(e.values())}function Cl(o){let e=0,s=0;return!o||typeof o!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(o).forEach(t=>{Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e++:(typeof i=="object"?i.id:i)===Zt?s++:e++})}),{unassigned:e,keeper:s,total:e+s})}function Tl(o){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!o||typeof o!="object"||Object.keys(e).forEach(s=>{const t=o[s];Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e[s].unassigned++:(typeof i=="object"?i.id:i)===Zt?e[s].keeper++:e[s].unassigned++,e[s].total++})}),e}function Sl(o,e){const s=new Set,t=new Map;return Array.isArray(o)&&o.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(i=>{!i.tickets||!Array.isArray(i.tickets)||i.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID:",n.id);return}s.add(l);let d=n.assignedTo;!d&&i.id&&(d={id:i.id,name:i.name||`Сотрудник #${i.id}`}),t.set(l,{id:l,title:n.title||"Без названия",assignedTo:d||null,createdAt:ns(n.createdAt||n.createdTime),updatedAt:ns(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||r.id||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(r=>{Array.isArray(r)&&r.forEach(i=>{if(!i||!i.id){console.warn("Ticket without ID found in zero point:",i);return}const n=parseInt(i.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",i.id);return}s.add(n);let l=i.assignedTo;if(!l&&i.assignedById){const d=typeof i.assignedById=="object"?i.assignedById.id||i.assignedById.value:i.assignedById;d&&d!==Zt?l={id:d,name:"Неизвестный"}:d===Zt&&(l={id:Zt,name:"Хранитель объектов"})}t.set(n,{id:n,title:i.title||"Без названия",assignedTo:l||null,createdAt:ns(i.createdAt||i.createdTime),updatedAt:ns(i.updatedAt||i.modifiedAt||i.updatedTime),stageId:i.stageId||null,departmentHead:i.departmentHead||null,departmentHeadFull:i.departmentHeadFull||i.departmentHead||null,priorityId:i.priorityId||null,priorityLabel:i.priorityLabel||null,service:i.service||null,serviceLabel:i.serviceLabel||null})})}),{ticketIds:Array.from(s).sort((r,i)=>r-i),tickets:Array.from(t.values())}}function ns(o){if(!o)return null;if(o instanceof Date)return o.toISOString();if(typeof o=="string"){if(o.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return o;const e=new Date(o);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",o),null}class Rs{static async getSectorDataForSnapshot(e={}){const{useCache:s=!0,useBackendCache:t=!1,onProgress:r=null,normalize:i=!0,includeTicketDetails:n=!1}=e;try{const l=await Bt.getSectorData(s,t,r);return i?bl(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const e=await Bt.getSectorData(!0);return e!=null}catch{return!1}}}class Es{static compareTwoSnapshots(e,s,t={}){const{includeTickets:r=!1,includeEmployees:i=!0}=t,n=this.validateSnapshot(e),l=this.validateSnapshot(s);if(!n.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...l.errors].join(", "));const d=this.buildComparisonMetadata(e,s),g=this.compareStages(e.statistics.stages,s.statistics.stages),v=i?this.compareEmployees(e.statistics.employees||[],s.statistics.employees||[]):[],T=this.compareZeroPoint(e.statistics.zeroPoint||{},s.statistics.zeroPoint||{}),f=r?this.compareTickets(e.ticketIds||[],s.ticketIds||[],e.tickets||[],s.tickets||[]):null,p=this.buildSummary(g,v,T,f);return{metadata:d,stages:g,employees:v,zeroPoint:T,tickets:f,summary:p}}static calculateDelta(e,s){const t=this.normalizeValue(e),r=this.normalizeValue(s),i=r-t;let n=0;t!==0?n=i/t*100:r!==0&&(n=r>0?1/0:-1/0);const l=this.getTrend(i);return{value1:t,value2:r,delta:i,deltaPercent:Math.round(n*100)/100,trend:l}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,s){const t=["formed","review","execution"],r={};for(const l of t){const d=e[l]?.count||0,g=s[l]?.count||0;r[l]=this.calculateDelta(d,g)}const i=e.total||0,n=s.total||0;return r.total=this.calculateDelta(i,n),r}static compareEmployees(e,s){const t=new Map(e.map(l=>[l.id,l])),r=new Map(s.map(l=>[l.id,l])),i=new Set([...t.keys(),...r.keys()]),n=[];for(const l of i){const d=t.get(l)||null,g=r.get(l)||null;if(!d||!g){n.push({id:l,name:d?.name||g?.name||"Неизвестный",snapshot1:d?{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(d,g),trend:d?"removed":"new"});continue}const v={},T=["formed","review","execution"];for(const p of T){const y=d.ticketsByStage?.[p]||0,S=g.ticketsByStage?.[p]||0;v[p]=this.calculateDelta(y,S)}const f=this.calculateDelta(d.totalTickets||0,g.totalTickets||0);n.push({id:l,name:d.name,snapshot1:{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:v,totalTickets:f},trend:f.trend})}return n}static calculateEmployeeDelta(e,s){if(!e&&!s)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const t={},r=["formed","review","execution"];for(const n of r){const l=e?.ticketsByStage?.[n]||0,d=s?.ticketsByStage?.[n]||0;t[n]=this.calculateDelta(l,d)}const i=this.calculateDelta(e?.totalTickets||0,s?.totalTickets||0);return{ticketsByStage:t,totalTickets:i}}static compareZeroPoint(e,s){return{unassigned:this.calculateDelta(e?.unassigned||0,s?.unassigned||0),keeper:this.calculateDelta(e?.keeper||0,s?.keeper||0),total:this.calculateDelta(e?.total||0,s?.total||0)}}static compareTickets(e,s,t,r){const i=new Set(e),n=new Set(s),l=s.filter(p=>!i.has(p)),d=e.filter(p=>!n.has(p)),g=[],v=[],T=new Map(t.map(p=>[p.id,p])),f=new Map(r.map(p=>[p.id,p]));for(const p of e){if(!n.has(p))continue;const y=T.get(p),S=f.get(p);if(!y||!S)continue;const C=(y.assignedTo?.id||null)!==(S.assignedTo?.id||null),k=(y.stageId||null)!==(S.stageId||null);C||k?g.push(p):v.push(p)}return{new:l,removed:d,changed:g,unchanged:v}}static buildComparisonMetadata(e,s){const t=new Date(e.metadata.createdAt),r=new Date(s.metadata.createdAt),i=new Date,n=r.getTime()-t.getTime(),l=Math.floor(n/(1e3*60*60*24)),d=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),g=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:s.metadata.createdAt,comparisonDate:i.toISOString(),timeDiff:{days:l,hours:d,minutes:g,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,s,t,r){const i=e.total.delta,n=Object.keys(e).filter(g=>g==="total"?!1:e[g].delta!==0).length,l=s.filter(g=>g.trend==="new"||g.trend==="removed"?!0:g.delta.totalTickets.delta!==0).length,d=i!==0||n>0||l>0;return{totalDelta:i,stagesChanged:n,employeesChanged:l,hasChanges:d,newTicketsCount:r?.new?.length||0,removedTicketsCount:r?.removed?.length||0,changedTicketsCount:r?.changed?.length||0}}static validateSnapshot(e){const s=[],t=[];if(!e)return s.push("Snapshot is null or undefined"),{valid:!1,errors:s,warnings:t};if(e.metadata?(e.metadata.createdAt||s.push("Missing metadata.createdAt"),e.metadata.type||s.push("Missing metadata.type")):s.push("Missing metadata field"),!e.statistics)s.push("Missing statistics field");else{if(!e.statistics.stages)s.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const i of r)e.statistics.stages[i]||t.push(`Missing stage: ${i}`)}e.statistics.employees||t.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||t.push("Missing statistics.zeroPoint")}return{valid:s.length===0,errors:s,warnings:t}}static compareMultipleSnapshots(e,s={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const l=this.validateSnapshot(n);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const t=[...e].sort((n,l)=>{const d=new Date(n.metadata.createdAt),g=new Date(l.metadata.createdAt);return d-g}),r=[];for(let n=0;n<t.length-1;n++)r.push({from:n,to:n+1,result:this.compareTwoSnapshots(t[n],t[n+1],s)});const i=this.buildTrends(t);return{snapshots:t.map((n,l)=>({index:l,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:r,trends:i}}static buildTrends(e){const s={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const t of e){const r=t.statistics;s.stages.formed.push(r.stages?.formed?.count||0),s.stages.review.push(r.stages?.review?.count||0),s.stages.execution.push(r.stages?.execution?.count||0),s.stages.total.push(r.stages?.total||0),s.zeroPoint.unassigned.push(r.zeroPoint?.unassigned||0),s.zeroPoint.keeper.push(r.zeroPoint?.keeper||0),s.zeroPoint.total.push(r.zeroPoint?.total||0)}return s}}const Dl={class:"stages-container"},El={class:"stages-chips"},Al=["checked","disabled","onChange"],$l={class:"stage-chip-label"},Il={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:o=>o.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(o,{emit:e}){const s=o,t=e;function r(i,n){const l={...s.selected};l[i]=n,t("update:selected",l),t("change",i,n)}return(i,n)=>(c(),u("div",Dl,[n[0]||(n[0]=a("h4",{class:"stages-title"},"Этапы для отображения:",-1)),a("div",El,[(c(!0),u(ee,null,te(o.stages,l=>(c(),u("label",{key:l.id,class:X(["stage-chip",{"stage-chip--active":o.selected[l.id],"stage-chip--disabled":o.disabled}])},[a("input",{type:"checkbox",checked:o.selected[l.id],disabled:o.disabled,onChange:d=>r(l.id,d.target.checked)},null,40,Al),a("span",{class:"stage-chip-color",style:we({backgroundColor:l.color})},null,4),a("span",$l,m(l.name),1)],2))),128))])]))}},Ml=de(Il,[["__scopeId","data-v-fe03c03c"]]),Nl={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(o,{emit:e}){const s=I(!1),t=M(()=>!1),r={color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d"},i={color:"#ced4da",backgroundColor:"#f8f9fa",textColor:"#6c757d"},n={color:"#dee2e6",backgroundColor:"#f8f9fa",textColor:"#6c757d"},l=M(()=>({label:o.ticket.priorityLabel||"Не указано",colors:o.ticket.priorityColors||r})),d=M(()=>l.value.label||"Не указано"),g=M(()=>({color:l.value.colors.textColor||r.textColor,backgroundColor:l.value.colors.backgroundColor||r.backgroundColor,borderColor:l.value.colors.color||r.color})),v=M(()=>({borderLeftColor:l.value.colors.color||r.color})),T=M(()=>{const E=o.ticket.service||{};return{label:E.label||o.ticket.serviceLabel||"Не указано",colors:E.colors||o.ticket.serviceColors||i}}),f=M(()=>T.value.label||"Не указано"),p=M(()=>({color:T.value.colors.textColor||i.textColor,backgroundColor:T.value.colors.backgroundColor||i.backgroundColor,borderColor:T.value.colors.color||i.color})),y=M(()=>{const E=o.ticket.actionStr||o.ticket.ufActionStr||null;if(!E)return null;const L=String(E).trim();return L.length>0?L:null}),S=M(()=>({color:n.textColor,backgroundColor:n.backgroundColor,borderColor:n.color})),C=M(()=>{if(!o.ticket.createdAt)return"";const E=Js(o.ticket.createdAt);return E?vo(E):""}),k=M(()=>{if(!o.ticket.createdAt)return null;const E=Js(o.ticket.createdAt);return po(E)}),_=M(()=>{const E=k.value;return E&&yo[E]||null}),A=M(()=>{const E=_.value;return E?{color:E.textColor,backgroundColor:E.backgroundColor,borderColor:E.color,border:`1px solid ${E.color}`}:{}});return{handleDragStart:E=>{t.value&&(E.dataTransfer.effectAllowed="move",E.dataTransfer.setData("application/json",JSON.stringify(o.ticket)),E.dataTransfer.setDragImage(E.target,0,0),s.value=!0,e("drag-start",o.ticket))},handleDragEnd:()=>{t.value&&(s.value=!1,e("drag-end"))},handleCardClick:E=>{if(s.value)return;const L=es(o.ticket.id);window.open(L,"_blank"),e("click",o.ticket)},isDragEnabled:t,priorityChipStyle:g,displayPriorityLabel:d,priorityBorderStyle:v,displayServiceLabel:f,serviceChipStyle:p,actionStrValue:y,actionChipStyle:S,formattedCreatedDate:C,dateAccentCategory:k,dateAccentConfig:_,dateAccentStyle:A}}},xl=["draggable"],Ll={key:0,class:"ticket-department"},Pl={class:"ticket-header"},Ol={class:"ticket-id"},Bl={class:"ticket-title"},Rl={class:"ticket-meta"},Wl={key:1,class:"ticket-action"},Ul={key:2,class:"ticket-description"},Fl={class:"ticket-date-label"},Hl={class:"ticket-date-value"};function jl(o,e,s,t,r,i){return c(),u("div",{class:"ticket-card",draggable:t.isDragEnabled,style:we(t.priorityBorderStyle),onClick:e[0]||(e[0]=(...n)=>t.handleCardClick&&t.handleCardClick(...n)),onDragstart:e[1]||(e[1]=(...n)=>t.handleDragStart&&t.handleDragStart(...n)),onDragend:e[2]||(e[2]=(...n)=>t.handleDragEnd&&t.handleDragEnd(...n))},[s.ticket.departmentHead?(c(),u("div",Ll,m(s.ticket.departmentHead),1)):$("",!0),a("div",Pl,[e[3]||(e[3]=a("span",{class:"ticket-icon"},"🎫",-1)),a("span",Ol,"#"+m(s.ticket.id),1)]),a("div",Bl,m(s.ticket.ufSubject||s.ticket.title||"Без названия"),1),a("div",Rl,[a("span",{class:"ticket-priority",style:we(t.priorityChipStyle)},m(t.displayPriorityLabel),5),a("span",{class:"ticket-service",style:we(t.serviceChipStyle)},m(t.displayServiceLabel),5)]),t.actionStrValue?(c(),u("div",Wl,[a("span",{class:"ticket-action-chip",style:we(t.actionChipStyle)},m(t.actionStrValue),5)])):$("",!0),s.ticket.description?(c(),u("div",Ul,m(s.ticket.description),1)):$("",!0),t.formattedCreatedDate?(c(),u("div",{key:3,class:"ticket-created-date",style:we(t.dateAccentStyle)},[a("span",Fl,m(t.dateAccentConfig?.label||""),1),a("span",Hl,m(t.formattedCreatedDate),1)],4)):$("",!0)],44,xl)}const Ct=de(Nl,[["render",jl],["__scopeId","data-v-9cda001c"]]),Ft=10;function gs(o,e){if(!e||!e.statistics)return[];const s=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(r=>r.ticketsByStage&&r.ticketsByStage[o]>0).forEach(r=>{s.push({id:r.id,name:r.name,count:r.ticketsByStage[o]||0})});const t=zl(o,e);return t>0&&s.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:t,isKeeper:!0}),s.sort((r,i)=>i.count-r.count)}function zl(o,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[o])return e.statistics.zeroPointByStage[o].keeper||0;if(e.statistics.zeroPoint){const s=e.statistics.zeroPoint.keeper||0;return Math.floor(s/3)}return 0}function xa(o,e){return!e||!e.statistics||!e.statistics.stages?0:e.statistics.stages[o]?.count||0}function ms(o,e=Ft){if(!o||o.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const s=[...o].sort((n,l)=>l.count-n.count),t=s.slice(0,e),r=s.slice(e),i=r.reduce((n,l)=>n+l.count,0);return{visible:t,others:{employees:r,count:i,employeeCount:r.length}}}function La(o,e){return!o||o.length===0?[]:e===0?o.map(s=>({...s,percentage:0})):o.map(s=>({...s,percentage:parseFloat((s.count/e*100).toFixed(1))}))}function ss(o,e,s="#007bff",t=Ft){if(!o||o.length===0)return{employees:[],others:null};const{visible:r,others:i}=ms(o,t),n=La(r,e).map(d=>({...d,progressBarWidth:d.percentage,progressBarColor:d.isKeeper?"#f59e0b":s}));let l=null;if(i.count>0){const d=parseFloat((i.count/e*100).toFixed(1));l={...i,percentage:d,progressBarWidth:d,progressBarColor:"#6c757d"}}return{employees:n,others:l}}function Vl(o,e){const s={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(r=>{const i=e[r];if(!i)return;const n=gs(o,i),l=xa(o,i);if(n.length===0)return;const{visible:d,others:g}=ms(n,Ft),v=La(d,l);s[r]=v,g.count>0&&(s.others[r]={count:g.count,employeeCount:g.employeeCount,percentage:parseFloat((g.count/l*100).toFixed(1))})}),s}function Gl(o,e="current",s=[]){const t=o[e];if(!t)return{labels:[],datasets:[]};const r=new Map;s.forEach(T=>{gs(T.id,t).forEach(p=>{r.has(p.id)||r.set(p.id,{id:p.id,name:p.name,isKeeper:p.isKeeper||!1,ticketsByStage:{}}),r.get(p.id).ticketsByStage[T.id]=p.count})});const i=Array.from(r.values()).map(T=>{const f=Object.values(T.ticketsByStage).reduce((p,y)=>p+y,0);return{...T,totalTickets:f}});i.sort((T,f)=>f.totalTickets-T.totalTickets);const{visible:n,others:l}=ms(i,Ft),d=s.map(()=>""),g={};s.forEach(T=>{const f=gs(T.id,t),{visible:p}=ms(f,Ft);g[T.id]=p.map(y=>({id:y.id,name:y.name,count:y.count}))});const v=n.map((T,f)=>{const p=s.map(S=>T.ticketsByStage[S.id]||0),y=s.map(S=>{if((T.ticketsByStage[S.id]||0)===0)return"transparent";const _=S.color.replace("#",""),A=parseInt(_.substring(0,2),16),W=parseInt(_.substring(2,4),16),x=parseInt(_.substring(4,6),16),D=.6+f*.05;return`rgba(${A}, ${W}, ${x}, ${Math.min(D,.95)})`});return{label:T.name,data:p,backgroundColor:y,borderColor:s.map(S=>{const C=S.color.replace("#",""),k=parseInt(C.substring(0,2),16),_=parseInt(C.substring(2,4),16),A=parseInt(C.substring(4,6),16);return`rgba(${k}, ${_}, ${A}, 0.8)`}),borderWidth:1,meta:{employeeId:T.id,employeeName:T.name}}});if(l.count>0){const T=s.map(f=>l.employees.reduce((p,y)=>p+(y.ticketsByStage[f.id]||0),0));v.push({label:`Другие (${l.employeeCount})`,data:T,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:d,datasets:v,meta:{employeesByStage:g}}}function Kl(o,e,s=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const t=s.find(g=>g.id===o),r=t?t.name:"",i=t?t.color:"#007bff",n=gs(o,e),l=xa(o,e);if(n.length===0)return{stageName:r,totalCount:0,employees:[],others:null};const d=ss(n,l,i,Ft);return{stageName:r,totalCount:l,employees:d.employees,others:d.others}}function ql(o,e){return e?.[o]||o}function Yl(o,e){return e?.[o]||"#007bff"}function Ws({snapshots:o,graphType:e,timePoint:s,snapshotType:t}){return o?e==="line"&&s?o[s]||null:e==="bar"&&t?o[t]||null:o.current||o.weekEnd||o.weekStart||null:null}function Us(o,e){return e?.statistics?.stages?.[o]?.count||0}function Xl({stageId:o,timePoint:e,meta:s,snapshots:t,stageColor:r,maxVisible:i}){if(!s?.employees||!e)return null;const n=s.employees[e];if(!n||n.length===0)return null;const l=t?.[e]||null,d=Us(o,l)||n.reduce((v,T)=>v+(T.count||0),0),g=ss(n,d,r,i);return{stageId:o,totalCount:d,employees:g.employees,others:g.others,snapshot:l}}function Jl({stageId:o,meta:e,snapshots:s,stageColor:t,maxVisible:r}){const i=e?.employees?.[o];if(!i||!i.employees||i.employees.length===0)return null;const n=Ws({snapshots:s,graphType:"doughnut"}),l=i.totalCount??Us(o,n)??i.employees.reduce((g,v)=>g+(v.count||0),0),d=ss(i.employees,l,t,r);return{stageId:o,totalCount:l,employees:d.employees,others:d.others,snapshot:n}}function Zl({stageId:o,meta:e,snapshots:s,stageColor:t,maxVisible:r,snapshotType:i}){const n=e?.employeesByStage?.[o];if(!n||n.length===0)return null;const l=Ws({snapshots:s,graphType:"bar",snapshotType:i}),d=Us(o,l)||n.reduce((v,T)=>v+(T.count||0),0),g=ss(n,d,t,r);return{stageId:o,totalCount:d,employees:g.employees,others:g.others,snapshot:l}}async function Pa({stageId:o,graphType:e,timePoint:s=null,snapshotType:t=null,snapshots:r=null,meta:i=null,stageColorMap:n=null,stageNameMap:l=null,maxVisible:d=10,restLoader:g=null}){if(!o)throw new Error("stageId обязателен для загрузки данных уровня 1");const v=ql(o,l),T=Yl(o,n);let f=null;if(e==="line"?f=Xl({stageId:o,timePoint:s,meta:i?.line,snapshots:r,stageColor:T,maxVisible:d}):e==="doughnut"?f=Jl({stageId:o,meta:i?.doughnut,snapshots:r,stageColor:T,maxVisible:d}):e==="bar"&&(f=Zl({stageId:o,meta:i?.bar,snapshots:r,stageColor:T,maxVisible:d,snapshotType:t})),f)return{stageId:o,stageName:v,color:T,totalCount:f.totalCount,employees:f.employees,others:f.others,snapshot:f.snapshot};if(typeof g=="function"){const p=await g({stageId:o,graphType:e,timePoint:s,snapshotType:t,snapshots:r});if(p&&Array.isArray(p.employees)){const y=p.totalCount??p.employees.reduce((C,k)=>C+(k.count||0),0),S=ss(p.employees,y,T,d);return{stageId:o,stageName:v,color:T,totalCount:y,employees:S.employees,others:S.others,snapshot:p.snapshot||Ws({snapshots:r,graphType:e,timePoint:s,snapshotType:t})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const Ql={key:"level-1",class:"level-1"},ec={class:"modal-header"},tc={class:"stage-header"},sc=["aria-expanded","onKeydown"],ac={class:"stage-title"},oc=["aria-selected","onClick","onKeydown"],nc={class:"stage-name"},rc={class:"modal-total"},ic={class:"view-switcher"},lc={class:"modal-body"},cc={key:0,class:"load-error"},dc={key:1,class:"stage-loader"},uc={key:2},gc={key:0,class:"no-employees"},mc={key:1,class:"employees-list"},hc=["onClick"],fc={class:"employee-name"},vc={class:"employee-progress"},pc={class:"employee-count"},yc={key:0,class:"employee-item employee-others"},kc={class:"employee-name"},bc={class:"employee-progress"},_c={class:"employee-count"},wc={key:3,class:"view-time"},Cc={key:0,class:"no-data"},Tc={key:1,class:"date-categories-list"},Sc=["onClick"],Dc={class:"category-label"},Ec={class:"category-progress"},Ac={class:"category-count"},$c={key:4,class:"view-departments"},Ic={key:0,class:"no-data"},Mc={key:1,class:"departments-table-container"},Nc={class:"departments-table"},xc=["onClick"],Lc={class:"col-department"},Pc={class:"department-name"},Oc={class:"col-count"},Bc={class:"count-value"},Rc={key:"level-2",class:"level-2"},Wc={class:"modal-header"},Uc={class:"modal-total"},Fc={class:"modal-body"},Hc={class:"stage-info level2-stage-row"},jc={class:"stage-badge"},zc={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},Vc={key:0},Gc={key:0,class:"no-data"},Kc={key:1,class:"date-categories-list"},qc=["onClick"],Yc={class:"category-label"},Xc={class:"category-progress"},Jc={class:"category-count"},Zc={key:1,class:"view-departments"},Qc={key:0,class:"no-data"},ed={key:1,class:"departments-table-container"},td={class:"departments-table"},sd=["onClick"],ad={class:"col-department"},od={class:"department-name"},nd={class:"col-count"},rd={class:"count-value"},id={key:"level-3",class:"level-3"},ld={class:"modal-header"},cd={class:"header-info"},dd={class:"header-badges"},ud={class:"date-badge"},gd={class:"stage-badge"},md={class:"modal-total"},hd={class:"modal-body"},fd={key:0,class:"no-data"},vd={key:1,class:"departments-table-container"},pd={class:"departments-table"},yd=["onClick"],kd={class:"col-department"},bd={class:"department-name"},_d={class:"col-count"},wd={class:"count-value"},Cd={key:"level-4",class:"level-4"},Td={class:"modal-header"},Sd={class:"header-info"},Dd={key:0,class:"header-badges"},Ed={key:0,class:"date-badge"},Ad={key:1,class:"department-badge"},$d={class:"stage-badge"},Id={class:"modal-total"},Md={class:"modal-body"},Nd={key:"loading",class:"loading-state"},xd={key:"error-fallback",class:"error-state-with-fallback"},Ld={class:"tickets-list-container"},Pd={key:"error",class:"error-state"},Od={class:"error-message"},Bd={key:"empty",class:"empty-state"},Rd={class:"empty-state-title"},Wd={class:"empty-state-message"},Ud={key:"tickets",class:"tickets-list-container"},Fd={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(o,{expose:e,emit:s}){const t=o,r=s,i=ct(),n=I(1),l=I("time"),d=I("employees"),g=I(null),v=I([]),T=I([]),f=I(null),p=I(null),y=I(null),S=I(t.stageSwitchContext||null),C=I(!1),k=I(null),_=I(null),A=I(!1),W=I(null),x=I(null),D=M(()=>{const V=S.value?.stageNameMap||{},N=S.value?.stageColorMap||{};return Object.keys(V).map(b=>({id:b,name:V[b],color:N[b]||"#007bff",disabled:b===(g.value?.stageId||t.stageId)}))});M(()=>n.value>1);const E=M(()=>{switch(n.value){case 1:return g.value?.stageName||t.stageName;case 2:return f.value?.employeeName||"";case 3:return`${f.value?.employeeName||""} — ${p.value?.dateCategoryLabel||""}`;case 4:if(!y.value?.context)return"Список тикетов";const V=y.value.context,N=[];return V.employeeName&&N.push(V.employeeName),V.dateCategoryLabel&&N.push(V.dateCategoryLabel),V.departmentName&&N.push(V.departmentName),V.stageName&&N.push(V.stageName),N.length>0?N.join(" — "):"Список тикетов";default:return""}});function L(){console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employeesCount:t.employees?.length||0,hasSnapshot:!!t.snapshot,snapshotTicketIds:t.snapshot?.ticketIds?.length||0,hasTicketDetails:!!t.ticketDetails,snapshotKeys:t.snapshot?Object.keys(t.snapshot):[]}),g.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:g.value.stageId,hasSnapshot:!!g.value.snapshot,employeesCount:g.value.employees.length,snapshotType:g.value.snapshot?typeof g.value.snapshot:"null"}),f.value=null,p.value=null,y.value=null,n.value=1,l.value="time",d.value="employees",B(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function B(){if(!g.value||!g.value.snapshot||!g.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const V=g.value.snapshot.tickets||[],N=g.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:V.length,currentStageId:N,sampleTicket:V[0]?{id:V[0].id,stageId:V[0].stageId,hasDepartmentHead:!!V[0].departmentHead,departmentHead:V[0].departmentHead,hasDepartmentHeadFull:!!V[0].departmentHeadFull,departmentHeadFull:V[0].departmentHeadFull,allKeys:Object.keys(V[0])}:null});let b=V.filter(K=>K.stageId?Xt(K.stageId)===N:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:V.length,afterFilter:b.length,stageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length});const O=b.filter(K=>!K.departmentHead&&!K.departmentHeadFull);if(O.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:O.length,totalTickets:b.length,ticketsWithDepartment:b.filter(j=>j.departmentHead||j.departmentHeadFull).length});const K=O.map(j=>j.id).filter(j=>j);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:K.length,ticketIdsSample:K.slice(0,10)});const j=await bo.getTicketsDetails(K),z=new Map;j.forEach(F=>{F&&F.id&&z.set(F.id,F)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:j.length,detailsMapSize:z.size,sampleDetail:j[0]?{id:j[0].id,departmentHead:j[0].departmentHead,departmentHeadFull:j[0].departmentHeadFull}:null}),b=b.map(F=>{const ie=z.get(F.id);return ie?{...F,stageId:ie.stageId||F.stageId||null,departmentHead:ie.departmentHead||F.departmentHead||null,departmentHeadFull:ie.departmentHeadFull||ie.departmentHead||F.departmentHead||null}:F}),b=b.filter(F=>F.stageId?Xt(F.stageId)===N:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:b.length,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,ticketsWithStageId:b.filter(F=>F.stageId).length,ticketsWithoutStageId:b.filter(F=>!F.stageId).length});const se=b.length,ge=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));b=b.filter(F=>F.stageId?Xt(F.stageId)===N:!0);const ye=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:se,afterStageFilter:b.length,filteredOut:se-b.length,currentStageId:N,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,sampleBeforeFilter:ge,sampleAfterFilter:ye,sampleWithDepartment:b.find(F=>F.departmentHead||F.departmentHeadFull)?{id:b.find(F=>F.departmentHead||F.departmentHeadFull).id,departmentHead:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHead,departmentHeadFull:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(b.find(F=>F.departmentHead||F.departmentHeadFull)).filter(F=>F.toLowerCase().includes("department"))}:null})}catch(j){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",j),console.error("[EmployeeDetailsModal] Error details:",{message:j.message,stack:j.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:b.length,currentStageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length,ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const Q=Zs(b);v.value=Q,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:b.length,sampleTickets:b.slice(0,5).map(K=>({id:K.id,departmentHead:K.departmentHead,departmentHeadFull:K.departmentHeadFull,hasDepartmentHead:!!K.departmentHead,hasDepartmentHeadFull:!!K.departmentHeadFull,allKeys:Object.keys(K).filter(j=>j.toLowerCase().includes("department"))})),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const ue=Qs(b);T.value=ue;const ke=Q.reduce((K,j)=>K+j.count,0),_e=ue.reduce((K,j)=>K+j.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:N,totalTicketsForGrouping:b.length,timeCategoriesCount:Q.length,totalTicketsInTimeCategories:ke,departmentsCount:ue.length,totalTicketsInDepartments:_e,departmentsSample:ue.slice(0,5),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length,consistencyCheck:{totalTickets:b.length,timeCategoriesTotal:ke,departmentsTotal:_e,isConsistent:b.length===ke&&b.length===_e}})}catch(V){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",V),console.error("[EmployeeDetailsModal] Error stack:",V.stack)}}async function U(V){if(!V){i.error("Не указан stageId для загрузки данных");return}if(g.value?.stageId===V)return;if(!S.value){i.error("Нет контекста для смены стадии (stageSwitchContext)");return}C.value=!0,k.value=null;const N=g.value?{...g.value}:null;_.value=N?.stageId||null;try{const b=await Pa({...S.value,stageId:V});g.value={stageId:b.stageId,stageName:b.stageName,stageColor:b.color,totalCount:b.totalCount,employees:b.employees,others:b.others,snapshot:b.snapshot||N?.snapshot||null,ticketDetails:b.ticketDetails||null},f.value=null,p.value=null,y.value=null,n.value=1,l.value="time",d.value="employees",await B()}catch(b){console.error("[EmployeeDetailsModal] Failed to reload stage data:",b),k.value=b?.message||"Не удалось загрузить данные стадии",N&&(g.value=N),i.error(k.value)}finally{C.value=!1}}async function G(V){if(!V||V.count===0){i.info(`У заказчика "${V?.departmentName||"неизвестный"}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),i.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:N}=await Ee(async()=>{const{createContextFromLevel3:O}=await import("./chunk-BBmTsmYU.js").then(Q=>Q.t);return{createContextFromLevel3:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=await N(p.value,V);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function q(V){if(!V||V.count===0){i.info(`У заказчика "${V?.departmentName||"неизвестный"}" нет тикетов`);return}if(!g.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:N}=await Ee(async()=>{const{createContextFromLevel1Department:O}=await import("./chunk-BBmTsmYU.js").then(Q=>Q.t);return{createContextFromLevel1Department:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(g.value,V);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:b.stageName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function oe(V){if(!V||V.count===0){i.info(`В категории "${V?.label||"неизвестная"}" нет тикетов`);return}if(!V.tickets||V.tickets.length===0){i.info(`В категории "${V.label}" нет тикетов`);return}if(!g.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:N}=await Ee(async()=>{const{createContextFromLevel1Time:O}=await import("./chunk-BBmTsmYU.js").then(Q=>Q.t);return{createContextFromLevel1Time:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(g.value,V);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:b.stageName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}Ne(()=>t.isVisible,V=>{V?L():(h(),Se())}),Ne(()=>t.stageSwitchContext,V=>{S.value=V},{deep:!0}),$e(()=>{t.isVisible&&L()});async function Y(V,N=null){if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",V),console.log("[EmployeeDetailsModal] Current popup level:",n.value),N&&N.currentTarget&&(N.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{N.currentTarget&&(N.currentTarget.style.transform="")},150)),!V||!V.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",V);return}if(g.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),g.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:g.value.stageId,stageName:g.value.stageName,hasSnapshot:!!g.value.snapshot,snapshotType:g.value.snapshot?typeof g.value.snapshot:"null",snapshotKeys:g.value.snapshot?Object.keys(g.value.snapshot):[]}),!g.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),i.warning("ID стадии не указан");return}if(!g.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",t.snapshot),i.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",V.id,"stage:",g.value.stageId);const{filterTicketsByDepartment:b}=await Ee(async()=>{const{filterTicketsByDepartment:ke}=await import("./chunk-2JzEd2ES.js").then(_e=>_e.l);return{filterTicketsByDepartment:ke}},__vite__mapDeps([3,4]),import.meta.url).then(ke=>ke.LazyServiceLoader.loadTicketListUtils()),O=await ko(V.id,g.value.stageId,g.value.snapshot,g.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",O?.length||0,O),!O||O.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),i.info(`У сотрудника "${V.name}" нет тикетов на стадии "${g.value.stageName}"`);return}const Q=Zs(O);console.log("[EmployeeDetailsModal] Date categories:",Q?.length||0,Q);const ue=Qs(O).map(ke=>({...ke,tickets:b(O,ke.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",ue?.length||0,ue),f.value={employeeId:V.id,employeeName:V.name,stageId:g.value.stageId,stageName:g.value.stageName,totalCount:O.length,dateCategories:Q,departments:ue,tickets:O,snapshot:g.value.snapshot,ticketDetails:g.value.ticketDetails},l.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:f.value.employeeName,totalCount:f.value.totalCount,dateCategoriesCount:f.value.dateCategories.length,departmentsCount:f.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",f.value),n.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",n.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",f.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!f.value,employeeName:f.value?.employeeName,dateCategoriesCount:f.value?.dateCategories?.length||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",n.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",f.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(b){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",b),console.error("[EmployeeDetailsModal] Error stack:",b.stack),i.error("Ошибка загрузки данных о тикетах: "+b.message)}}async function H(V){if(!V||V.count===0){i.info(`У заказчика "${V?.departmentName||"неизвестный"}" нет тикетов`);return}if(!f.value){i.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:N}=await Ee(async()=>{const{createContextFromLevel2Department:O}=await import("./chunk-BBmTsmYU.js").then(Q=>Q.t);return{createContextFromLevel2Department:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(f.value,V);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:b.employeeName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function Z(V){if(!V||V.count===0){i.info(`В категории "${V?.label||"неизвестная"}" нет тикетов`);return}if(!V.tickets||V.tickets.length===0){i.info(`В категории "${V.label}" нет тикетов`);return}if(!f.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),i.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:N}=await Ee(async()=>{const{createContextFromLevel2:O}=await import("./chunk-BBmTsmYU.js").then(Q=>Q.t);return{createContextFromLevel2:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(f.value,V);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function fe(V){if(console.time("[Performance] goToLevel4"),!V){console.error("[EmployeeDetailsModal] Context is required for level 4"),i.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:V.sourceLevel,employeeId:V.employeeId,stageId:V.stageId,dateCategory:V.dateCategory,departmentName:V.departmentName,ticketsCount:V.tickets?.length||0});try{y.value={context:V,tickets:[],totalCount:0,isLoading:!0,error:null};let N=V.tickets||[];if(N.length===0&&V.snapshot){const{filterTicketsByContext:O}=await Ee(async()=>{const{filterTicketsByContext:Q}=await import("./chunk-BBmTsmYU.js").then(ue=>ue.t);return{filterTicketsByContext:Q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);N=await O(V)}(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),N=V.tickets||[]),(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),V.snapshot&&V.snapshot.tickets&&(N=V.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",N.length)));let b=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:O}=await Ee(async()=>{const{prepareTicketsForDisplay:Q}=await import("./chunk-BBmTsmYU.js").then(ue=>ue.t);return{prepareTicketsForDisplay:Q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);b=await O(N,V.snapshot,V.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(O){console.error("[EmployeeDetailsModal] Error preparing tickets:",O),console.timeEnd("[Performance] prepareTicketsForDisplay"),b=N||[],i.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:N.length,preparedCount:b.length}),y.value={context:V,tickets:b,totalCount:b.length,isLoading:!1,error:null},n.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:y.value.totalCount,ticketsCount:y.value.tickets.length,isLoading:y.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,context:V});let b=[];if(V.snapshot&&V.snapshot.tickets)try{const O=V.stageId;O?b=(V.snapshot.tickets||[]).filter(Q=>Q.stageId===O):b=V.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",b.length)}catch(O){console.error("[EmployeeDetailsModal] Error using fallback tickets:",O)}y.value={context:V,tickets:b,totalCount:b.length,isLoading:!1,error:{message:N.message,hasFallback:b.length>0}},b.length>0?(i.warning("Ошибка загрузки данных. Отображаются данные из кеша."),n.value=4):(i.error("Ошибка загрузки тикетов: "+N.message),P()),console.timeEnd("[Performance] goToLevel4")}}function P(){if(n.value===4){if(y.value&&y.value.context){const V=y.value.context.sourceLevel;n.value=V}else n.value=1;y.value=null}else n.value===3?(n.value=2,p.value=null,y.value=null):n.value===2&&(n.value=1,f.value=null,p.value=null,y.value=null)}function h(){n.value=1,g.value=null,f.value=null,p.value=null,y.value=null,l.value="time"}function w(){if(!y.value?.context)return"Нет тикетов";const{sourceLevel:V,employeeName:N,dateCategoryLabel:b,departmentName:O}=y.value.context;return V===2&&N&&b?`Нет тикетов у ${N} в категории "${b}"`:V===2&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:V===3&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:V===1&&b?`Нет тикетов в категории "${b}"`:V===1&&O?`Нет тикетов у заказчика "${O}"`:"Нет тикетов для отображения"}function R(){if(!y.value?.context)return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:V}=y.value.context;return V?`На стадии "${V}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function re(){if(!y.value?.context){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const V=y.value.context;await fe(V)}function le(V){if(!V){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),i.warning("Ошибка: тикет не найден");return}if(!V.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",V),i.error("Ошибка: ID тикета не указан");return}try{const N=es(V.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:V.id,iframeUrl:N}),!N||typeof N!="string"||N.length===0)throw new Error("Не удалось сформировать URL для тикета");const b=window.open(N,"_blank","noopener,noreferrer");if(!b||b.closed||typeof b.closed>"u")try{const O=document.createElement("a");O.href=N,O.target="_blank",O.rel="noopener noreferrer",O.style.display="none",document.body.appendChild(O),O.click(),document.body.removeChild(O),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:V.id,iframeUrl:N})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:V.id,iframeUrl:N})}catch(N){console.error("[EmployeeDetailsModal] Error opening ticket:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,ticket:V}),i.error("Ошибка открытия тикета: "+N.message)}}function ae(){h(),r("close")}e({reloadLevel1ForStage:U});function me(V){V&&V.stopPropagation(),A.value=!A.value}function Se(){A.value&&(A.value=!1)}function Ie(V){if(!A.value)return;const N=W.value,b=x.value;N&&N.contains(V.target)||b&&b.contains(V.target)||(A.value=!1)}async function xe(V){if(V.disabled){A.value=!1;return}A.value=!1,await U(V.id)}function Fe(V){if(A.value){V.stopPropagation(),Se();return}ae()}return(V,N)=>(c(),he(It,{to:"body"},[o.isVisible?(c(),u("div",{key:0,class:"employee-details-modal",onClick:Ce(ae,["self"]),onKeydown:Re(Fe,["esc"])},[a("div",{class:"modal-content",onClick:Ie},[ne(Ae,{name:"level",mode:"out-in"},{default:pe(()=>[n.value===1?(c(),u("div",Ql,[a("div",ec,[a("div",tc,[a("button",{ref_key:"stageTriggerRef",ref:x,class:"stage-trigger","aria-expanded":A.value,"aria-haspopup":"listbox",onClick:Ce(me,["stop"]),onKeydown:[Re(Ce(me,["prevent"]),["enter"]),Re(Ce(me,["prevent"]),["space"]),Re(Ce(Se,["stop","prevent"]),["esc"])]},[a("span",{class:"stage-color",style:we({backgroundColor:g.value?.stageColor||S.value?.stageColorMap?.[g.value?.stageId]||S.value?.stageColorMap?.[o.stageId]||"#007bff"})},null,4),a("span",ac,m(g.value?.stageName||o.stageName),1),a("span",{class:X(["stage-caret",{open:A.value}])},"▾",2)],40,sc),A.value?(c(),u("div",{key:0,ref_key:"stageDropdownRef",ref:W,class:"stage-dropdown",role:"listbox"},[(c(!0),u(ee,null,te(D.value,b=>(c(),u("div",{key:b.id,class:X(["stage-option",{disabled:b.disabled}]),role:"option","aria-selected":b.disabled,onClick:Ce(O=>xe(b),["stop"]),onKeydown:Re(Ce(O=>xe(b),["prevent"]),["enter"])},[a("span",{class:"stage-color",style:we({backgroundColor:b.color})},null,4),a("span",nc,m(b.name),1)],42,oc))),128))],512)):$("",!0)]),a("span",rc,"Всего: "+m(g.value?.totalCount||o.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",ic,[a("button",{class:X(["view-switch-btn",{active:d.value==="employees"}]),onClick:N[0]||(N[0]=b=>d.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),a("button",{class:X(["view-switch-btn",{active:d.value==="time"}]),onClick:N[1]||(N[1]=b=>d.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),a("button",{class:X(["view-switch-btn",{active:d.value==="departments"}]),onClick:N[2]||(N[2]=b=>d.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),a("div",lc,[k.value?(c(),u("div",cc,[a("span",null,"Ошибка: "+m(k.value),1),a("button",{class:"btn-retry-stage",onClick:N[3]||(N[3]=b=>U(g.value?.stageId||o.stageId))}," Повторить ")])):$("",!0),C.value?(c(),u("div",dc,[...N[7]||(N[7]=[a("div",{class:"loading-spinner small"},null,-1),a("span",null,"Загрузка стадии...",-1)])])):$("",!0),d.value==="employees"?(c(),u("div",uc,[(g.value?.employees||o.employees).length===0&&(!(g.value?.others||o.others)||(g.value?.others||o.others).count===0)?(c(),u("div",gc," Нет данных о сотрудниках ")):(c(),u("div",mc,[(c(!0),u(ee,null,te(g.value?.employees||o.employees,b=>(c(),u("div",{key:b.id,class:X(["employee-item",{"employee-keeper":b.isKeeper}]),onClick:Ce(O=>Y(b,O),["stop"]),title:"Кликните для детализации по временным градациям"},[a("span",fc,m(b.name),1),a("div",vc,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",pc,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1),N[8]||(N[8]=a("span",{class:"employee-arrow"},"→",-1))],10,hc))),128)),(g.value?.others||o.others)&&(g.value?.others||o.others).count>0?(c(),u("div",yc,[a("span",kc,"Другие ("+m((g.value?.others||o.others).employeeCount)+")",1),a("div",bc,[a("div",{class:"progress-bar",style:we({width:(g.value?.others||o.others).progressBarWidth+"%",backgroundColor:(g.value?.others||o.others).progressBarColor})},null,4)]),a("span",_c,m((g.value?.others||o.others).count)+" тикетов ("+m((g.value?.others||o.others).percentage)+"%) ",1)])):$("",!0)]))])):d.value==="time"?(c(),u("div",wc,[v.value.length===0?(c(),u("div",Cc," Загрузка данных... ")):(c(),u("div",Tc,[(c(!0),u(ee,null,te(v.value,b=>(c(),u("div",{key:b.category,class:"category-item",onClick:Ce(O=>oe(b),["stop"])},[a("span",Dc,m(b.label),1),a("div",Ec,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",Ac,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1),N[9]||(N[9]=a("span",{class:"category-arrow"},"→",-1))],8,Sc))),128))]))])):d.value==="departments"?(c(),u("div",$c,[T.value.length===0?(c(),u("div",Ic," Загрузка данных... ")):(c(),u("div",Mc,[a("table",Nc,[N[11]||(N[11]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),u(ee,null,te(T.value,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Ce(Q=>q(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",Lc,[a("span",Pc,m(b.departmentName),1)]),a("td",Oc,[a("span",Bc,m(b.count),1)]),N[10]||(N[10]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,xc))),128))])])]))])):$("",!0)])])):n.value===2&&f.value?(c(),u("div",Rc,[a("div",Wc,[a("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),a("h3",null,m(f.value.employeeName),1),a("span",Uc,"Всего: "+m(f.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",Fc,[a("div",Hc,[a("span",jc,m(f.value.stageName),1),a("div",zc,[a("button",{class:X(["level2-sort-btn",{active:l.value==="time"}]),onClick:N[4]||(N[4]=b=>l.value="time"),title:"Сортировка по времени"}," По времени ",2),a("button",{class:X(["level2-sort-btn",{active:l.value==="departments"}]),onClick:N[5]||(N[5]=b=>l.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),l.value==="time"?(c(),u("div",Vc,[f.value.dateCategories.length===0?(c(),u("div",Gc," Нет данных о тикетах ")):(c(),u("div",Kc,[(c(!0),u(ee,null,te(f.value.dateCategories,b=>(c(),u("div",{key:b.category,class:"category-item",onClick:Ce(O=>Z(b),["stop"])},[a("span",Yc,m(b.label),1),a("div",Xc,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",Jc,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1)],8,qc))),128))]))])):(c(),u("div",Zc,[!f.value.departments||f.value.departments.length===0?(c(),u("div",Qc,[N[12]||(N[12]=ce(" Для выбранного сотрудника заказчики не найдены ",-1)),a("button",{class:"btn-retry-stage",onClick:N[6]||(N[6]=b=>Y({id:f.value.employeeId,name:f.value.employeeName}))}," Обновить ")])):(c(),u("div",ed,[a("table",td,[N[14]||(N[14]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),u(ee,null,te(f.value.departments,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Ce(Q=>H(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",ad,[a("span",od,m(b.departmentName),1)]),a("td",nd,[a("span",rd,m(b.count),1)]),N[13]||(N[13]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,sd))),128))])])]))]))])])):n.value===3&&p.value?(c(),u("div",id,[a("div",ld,[a("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),a("div",cd,[a("h3",null,m(p.value.employeeName),1),a("div",dd,[a("span",ud,m(p.value.dateCategoryLabel),1),a("span",gd,m(p.value.stageName),1)])]),a("span",md,"Всего: "+m(p.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",hd,[p.value.departments.length===0?(c(),u("div",fd," Нет данных о заказчиках ")):(c(),u("div",vd,[a("table",pd,[N[16]||(N[16]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),u(ee,null,te(p.value.departments,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Ce(Q=>G(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",kd,[a("span",bd,m(b.departmentName),1)]),a("td",_d,[a("span",wd,m(b.count),1)]),N[15]||(N[15]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,yd))),128))])])]))])])):n.value===4&&y.value?(c(),u("div",Cd,[a("div",Td,[a("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),a("div",Sd,[a("h3",null,m(E.value),1),y.value.context?(c(),u("div",Dd,[y.value.context.dateCategoryLabel?(c(),u("span",Ed,m(y.value.context.dateCategoryLabel),1)):$("",!0),y.value.context.departmentName?(c(),u("span",Ad,m(y.value.context.departmentName),1)):$("",!0),a("span",$d,m(y.value.context.stageName),1)])):$("",!0)]),a("span",Id,"Всего: "+m(y.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",Md,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[y.value.isLoading?(c(),u("div",Nd,[...N[17]||(N[17]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):y.value.error&&y.value.error.hasFallback?(c(),u("div",xd,[N[18]||(N[18]=a("div",{class:"error-banner"},[a("span",{class:"error-icon"},"⚠️"),a("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),a("div",Ld,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(y.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):y.value.error&&!y.value.error.hasFallback?(c(),u("div",Pd,[N[19]||(N[19]=a("div",{class:"error-icon"},"❌",-1)),N[20]||(N[20]=a("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),a("p",Od,m(y.value.error.message),1),a("button",{class:"btn-retry",onClick:re},"Повторить попытку")])):!y.value.tickets||y.value.tickets.length===0?(c(),u("div",Bd,[N[21]||(N[21]=a("div",{class:"empty-state-icon"},"📭",-1)),a("h3",Rd,m(w()),1),a("p",Wd,m(R()),1)])):(c(),u("div",Ud,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(y.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])],32)):$("",!0)]))}},Hd=de(Fd,[["__scopeId","data-v-7fbd8a12"]]);function jd(o,e,s=.5){if(!e||!Array.isArray(e)||e.length===0||typeof o!="number"||o<0)return 0;(typeof s!="number"||s<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),s=.5);const t=[];if(e.forEach((n,l)=>{if(!n||!n.data||!Array.isArray(n.data))return;const d=n.data[o];d!=null&&!isNaN(d)&&t.push({datasetIndex:l,value:Number(d),y:Number(d)})}),t.length<2)return 0;const r=[];return t.forEach(n=>{let l=!1;for(const d of r){const g=d.y;if(Math.abs(n.y-g)<s){d.points.push(n),d.y=d.points.reduce((T,f)=>T+f.y,0)/d.points.length,l=!0;break}}l||r.push({points:[n],y:n.y})}),r.length===0?0:r.reduce((n,l)=>l.points.length>n.points.length?l:n,r[0]).points.length}function zd(o,e){const s=[];return o.forEach(t=>{let r=!1;for(const i of s){const n=i.y;if(Math.abs(t.value-n)<e){i.points.push(t),i.y=i.points.reduce((l,d)=>l+d.value,0)/i.points.length,r=!0;break}}r||s.push({points:[t],y:t.value})}),s}function Vd(o,e=.5){if(!o)return console.warn("findOverlappingPoints: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];const s=o.data?.datasets,t=o.data?.labels||[];if(!s||!Array.isArray(s)||s.length===0)return[];if(!Array.isArray(t)||t.length===0)return[];(typeof e!="number"||e<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),e=.5);const r=[];return t.forEach((i,n)=>{try{if(jd(n,s,e)<2)return;const d=[];if(s.forEach((p,y)=>{if(!p||!p.data||!Array.isArray(p.data))return;const S=p.data[n];S==null||isNaN(S)||d.push({datasetIndex:y,value:Number(S),label:p.label||`Dataset ${y}`})}),d.length<2)return;const g=zd(d,e);if(g.length===0)return;const v=g.reduce((p,y)=>y.points.length>p.points.length?y:p,g[0]);if(v.points.length<2)return;let T=null,f=null;for(let p=0;p<s.length;p++)try{const y=o.getDatasetMeta(p);if(y&&y.data&&y.data[n]){T=y,f=y.data[n];break}}catch{continue}if(!f||typeof f.x!="number"||typeof f.y!="number")return;r.push({position:n,count:v.points.length,x:f.x,y:f.y,value:v.y,points:v.points.map(p=>({datasetIndex:p.datasetIndex,value:p.value,label:p.label}))})}catch(l){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${n}:`,l)}}),r}function Gd(o,e){const s=[];return o.forEach(t=>{let r=!1;for(const i of s){const n=i.y;if(Math.abs(t.y-n)<e){i.points.push(t),i.y=i.points.reduce((l,d)=>l+d.y,0)/i.points.length,r=!0;break}}r||s.push({points:[t],y:t.y})}),s}function Kd(o,e,s=.5){if(!o)return console.warn("calculatePointJitter: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];if(typeof e!="number"||e<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof s!="number"||s<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),s=.5);const t=o.data?.datasets,r=o.data?.labels||[];if(!t||!Array.isArray(t)||t.length===0)return[];if(!Array.isArray(r)||e>=r.length)return[];const i=[];if(t.forEach((g,v)=>{if(!g||!g.data||!Array.isArray(g.data))return;const T=g.data[e];if(!(T==null||isNaN(T)))try{const f=o.getDatasetMeta(v);if(f&&f.data&&f.data[e]){const p=f.data[e];p&&typeof p.x=="number"&&typeof p.y=="number"&&i.push({datasetIndex:v,value:Number(T),x:p.x,y:p.y})}}catch(f){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${v}:`,f)}}),i.length===0)return[];const n=Gd(i,s),l=[];n.forEach(g=>{const v=g.points||[];v.length>1?v.forEach((f,p)=>{const y=(p-(v.length-1)/2)*4;l.push({datasetIndex:f.datasetIndex,jitterX:y,value:f.value})}):v.length===1&&l.push({datasetIndex:v[0].datasetIndex,jitterX:0,value:v[0].value})});const d=new Set(l.map(g=>g.datasetIndex));return i.forEach(g=>{d.has(g.datasetIndex)||l.push({datasetIndex:g.datasetIndex,jitterX:0,value:g.value})}),l}const qd=.5,aa=6,Yd=2;function Xd(o){return typeof o!="number"||o<2?aa:aa+(o-1)*Yd}function Jd(o,e){if(!o||!o.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!e||typeof e.x!="number"||typeof e.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",e);return}const s=e.count;if(typeof s!="number"||s<2)return;const t=o.ctx,{x:r,y:i,points:n}=e,l=Xd(s);if(t.canvas){t.save();try{t.beginPath(),t.arc(r,i,l,0,2*Math.PI);let g="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&o.data&&o.data.datasets){const v=n[0].datasetIndex,T=o.data.datasets[v];if(T&&T.pointBackgroundColor){const f=Array.isArray(T.pointBackgroundColor)?T.pointBackgroundColor[e.position]||T.pointBackgroundColor[0]:T.pointBackgroundColor;if(f)if(f.startsWith("#")){const p=parseInt(f.slice(1,3),16),y=parseInt(f.slice(3,5),16),S=parseInt(f.slice(5,7),16);g=`rgba(${p}, ${y}, ${S}, 0.4)`}else f.startsWith("rgba")?g=f.replace(/rgba?\(([^)]+)\)/,(p,y)=>{const S=y.split(",").map(C=>C.trim());return`rgba(${S[0]}, ${S[1]}, ${S[2]}, 0.4)`}):g=f+"66"}}t.fillStyle=g,t.fill(),t.strokeStyle=g.replace("0.4","0.6").replace("66","99"),t.lineWidth=1,t.stroke()}catch(g){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",g)}finally{t.restore()}}}const Zd={id:"overlappingPointsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=Vd(o,qd);if(!Array.isArray(e)||e.length===0)return;e.filter(t=>!(!t||typeof t!="object"||typeof t.count!="number"||t.count<2||typeof t.x!="number"||typeof t.y!="number"||!isFinite(t.x)||!isFinite(t.y))).forEach(t=>{try{Jd(o,t)}catch(r){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${t.position}:`,r)}})}catch(e){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",e)}}},Qd=.5,eu={id:"pointJitterPlugin",beforeDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")){o._jitterData||(o._jitterData={});try{const e=o.data?.datasets,s=o.data?.labels||[];if(!e||!Array.isArray(e)||e.length===0||!Array.isArray(s)||s.length===0)return;o._jitterData={},s.forEach((t,r)=>{const i=Kd(o,r,Qd);i&&i.length>0&&i.forEach(n=>{const l=`${n.datasetIndex}_${r}`;o._jitterData[l]=n.jitterX})})}catch(e){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",e)}}},afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx&&!(!o._jitterData||Object.keys(o._jitterData).length===0))try{const e=o.ctx,s=o.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((t,r)=>{const i=o.getDatasetMeta(r);!i||i.hidden||!t.data||!Array.isArray(t.data)||t.data.forEach((n,l)=>{const d=i.data[l];if(!d||typeof d.x!="number"||typeof d.y!="number"||n==null||isNaN(n))return;const g=`${r}_${l}`,v=o._jitterData[g];if(!(v===void 0||v===0)){e.save();try{const T=t.pointStyle||"circle",f=(t.pointRadius||7)+1,p=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[l]||t.pointBackgroundColor[0]:t.pointBackgroundColor,y=Array.isArray(t.pointBorderColor)?t.pointBorderColor[l]||t.pointBorderColor[0]:t.pointBorderColor,S=t.pointBorderWidth||1,C=d.x+v,k=d.y;switch(e.fillStyle=p||"#007bff",e.strokeStyle=y||"#ffffff",e.lineWidth=S,e.beginPath(),T){case"circle":e.arc(C,k,f,0,2*Math.PI);break;case"triangle":e.moveTo(C,k-f),e.lineTo(C-f,k+f),e.lineTo(C+f,k+f),e.closePath();break;case"rect":case"rectRounded":const _=f*1.4;e.rect(C-_/2,k-_/2,_,_);break;case"rectRot":const A=f*1.4;e.moveTo(C,k-A/2),e.lineTo(C+A/2,k),e.lineTo(C,k+A/2),e.lineTo(C-A/2,k),e.closePath();break;case"star":const W=f;for(let E=0;E<5;E++){const L=E*4*Math.PI/5-Math.PI/2,B=C+W*Math.cos(L),U=k+W*Math.sin(L);E===0?e.moveTo(B,U):e.lineTo(B,U)}e.closePath();break;case"cross":const x=f;e.moveTo(C-x,k-x),e.lineTo(C+x,k+x),e.moveTo(C+x,k-x),e.lineTo(C-x,k+x);break;case"crossRot":const D=f;e.moveTo(C-D,k),e.lineTo(C+D,k),e.moveTo(C,k-D),e.lineTo(C,k+D);break;default:e.arc(C,k,f,0,2*Math.PI)}T!=="cross"&&T!=="crossRot"&&e.fill(),e.stroke(),d._originalX||(d._originalX=d.x,d._originalY=d.y),d._jitterX=v,d._jitteredX=C,d._jitteredY=k}catch(T){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${r}_${l}:`,T)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:o=>{o._jitterData}},tu={id:"pointLabelsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=o.ctx,s=o.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((t,r)=>{const i=o.getDatasetMeta(r);if(!i||i.hidden||!t.data||!Array.isArray(t.data))return;const n=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[0]||"#6b7280":t.pointBackgroundColor||"#6b7280";t.data.forEach((l,d)=>{const g=i.data[d];if(!g||typeof g.x!="number"||typeof g.y!="number"||l==null||isNaN(l))return;const v=g._jitteredX!==void 0?g._jitteredX:g.x,T=g._jitteredY!==void 0?g._jitteredY:g.y,f=v+8,p=T-5,y=String(Math.round(l));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const C=e.measureText(y).width,k=11,_=3,A=f-_,W=p-k/2-_,x=C+_*2,D=k+_*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(A,W,x,D),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(A,W,x,D),e.fillStyle=n,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(y,f,p)}catch(S){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${r}_${d}:`,S)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},su={class:"graph-state-chart"},au={class:"chart-header"},ou={class:"chart-type-selector"},nu=["onClick","title"],ru={class:"chart-type-icon"},iu={class:"chart-type-label"},lu={key:0,class:"comparison-type-selector"},cu={class:"radio-group"},du={key:0},uu={key:1},gu={key:2,class:"graph-legend"},mu={key:4,class:"error-container"},hu={class:"error-message"},fu={class:"chart-wrapper"},vu={class:"chart-canvas-container"},pu={key:0,class:"bar-chart-stage-labels"},yu={key:6,class:"no-data"},ku={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(o,{emit:e}){const s=(j,z)=>typeof window>"u"?z:getComputedStyle(document.documentElement).getPropertyValue(j).trim()||z,t=o,r=e,i=I(!1),n=I(null),l=I(null),d=I({weekStart:null,weekEnd:null,current:null}),g=I(null),v=I("weekStartToWeekEnd"),T=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],f=I("line"),p=I(!1),y=I(""),S=I(""),C=I(0),k=I([]),_=I(null),A=I(null),W=I(null),x=I(null),D=I([]),E=M(()=>{switch(f.value){case"line":return yt;case"bar":return fa;case"doughnut":return ha;default:return yt}}),L={formed:s("--b24-primary","#007bff"),review:s("--b24-warning","#ffc107"),execution:s("--b24-success","#28a745")},B=[{id:"formed",name:"Сформировано обращение",color:L.formed},{id:"review",name:"Рассмотрение ТЗ",color:L.review},{id:"execution",name:"Исполнение",color:L.execution}],U=M(()=>B.reduce((j,z)=>(j[z.id]=z.name,j),{})),G=["circle","triangle","rect","rectRot","star","cross","crossRot"],q=I({formed:!0,review:!0,execution:!0}),oe=ct(),Y={id:"employeeLabelsPlugin",afterDatasetsDraw:j=>{if(j.config.type==="bar")try{const z=j.ctx;if(!j.data||!j.data.datasets)return;const se=j.data.datasets,ge=j.scales.y;se.forEach((ye,F)=>{const ie=j.getDatasetMeta(F);if(!ie||ie.hidden)return;const ve=ye.label||"";if(!ve||ve.includes("Другие"))return;const Te=ve.trim().split(/\s+/);let Me="";if(Te.length===1)Me=Te[0];else{const Le=Te[0],Ue=Te.slice(1).join(" ");Me=`${Le}
${Ue}`}const Ve=Me.split(`
`);ye.data.forEach((Le,Ue)=>{if(Le===0||!Le)return;const Ge=ie.data[Ue];if(!Ge||typeof Ge.x!="number"||typeof Ge.y!="number")return;const He=Ge.x,Tt=Ge.y+Ge.height+25;z.save(),z.font="bold 9px Arial, sans-serif",z.fillStyle="#6b7280",z.textAlign="center",z.textBaseline="top",z.translate(He,Tt),z.rotate(-12*Math.PI/180),Ve.forEach((Ga,Ka)=>{const Ks=Ga.trim();Ks&&z.fillText(Ks,0,Ka*11)}),z.restore()})})}catch(z){console.error("Error in employeeLabelsPlugin:",z)}}},H={id:"doughnutCenterTextPlugin",afterDraw:j=>{if(j.config.type!=="doughnut")return;const{ctx:z,chartArea:se,width:ge,height:ye}=j;if(!j.data||!j.data.datasets||j.data.datasets.length===0)return;const ie=j.data.datasets[0].meta?.totals?.overall??null;if(ie===null||typeof ie>"u")return;const ve=["Всего в секторе 1С","тикетов в работе:",`${ie}`];z.save(),z.font='600 16px "Roboto", sans-serif',z.fillStyle=s("--b24-text-primary","#1f2937"),z.textAlign="center",z.textBaseline="middle";const Te=(se.left+se.right)/2,Me=(se.top+se.bottom)/2,Ve=18,Le=Ve*ve.length,Ue=Me-Le/2+4;ve.forEach((Ge,He)=>{He===ve.length-1&&`${Ge}`.length>4?z.font='700 18px "Roboto", sans-serif':z.font='600 16px "Roboto", sans-serif',z.fillText(Ge,Te,Ue+He*Ve)}),z.restore()}};Je.register(Y),Je.register(H);function Z(){const j=new Map;[d.value.weekStart,d.value.weekEnd,d.value.current].forEach(z=>{!z||!z.statistics||!z.statistics.employees||z.statistics.employees.forEach(se=>{j.has(se.id)||j.set(se.id,{id:se.id,name:se.name})})}),D.value=Array.from(j.values()).sort((z,se)=>z.name.localeCompare(se.name))}function fe(j,z="background"){return{increase:{background:s("--b24-success","#28a745"),border:s("--b24-success-hover","#218838"),point:s("--b24-success","#28a745")},decrease:{background:s("--b24-danger","#dc3545"),border:s("--b24-danger-hover","#c82333"),point:s("--b24-danger","#dc3545")},stable:{background:s("--b24-text-muted","#9ca3af"),border:s("--b24-text-secondary","#6b7280"),point:s("--b24-text-muted","#9ca3af")}}[j]?.[z]||s("--b24-text-secondary","#6c757d")}function P(){if(!(!d.value.weekStart||!d.value.weekEnd))try{const j=Es.compareTwoSnapshots(d.value.weekStart,d.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let z=null,se=null;d.value.current&&(z=Es.compareTwoSnapshots(d.value.weekEnd,d.value.current,{includeTickets:!1,includeEmployees:!0}),se=Es.compareTwoSnapshots(d.value.weekStart,d.value.current,{includeTickets:!1,includeEmployees:!0})),g.value={weekStartToWeekEnd:j,weekEndToCurrent:z,weekStartToCurrent:se}}catch(j){console.error("Ошибка сравнения слепков:",j),oe.warning("Не удалось выполнить сравнение слепков: "+j.message)}}function h(j){return j?j.replace(/\s*\(\d+\)\s*$/,"").trim():""}function w(j){const z=h(j);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[z]||"formed"}function R(j){return w(j)}function re(j){return j===0?"weekStart":j===1?"weekEnd":j===2?"current":"weekEnd"}function le(j,z,se,ge,ye=null,F=null,ie=null,ve=null){console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:j,stageId:z,totalCount:se,employeesCount:ge?.length||0,hasSnapshot:!!F,snapshotTicketIds:F?.ticketIds?.length||0}),y.value=j,S.value=z||"",C.value=se,k.value=ge||[],_.value=ye&&ye.count>0?ye:null,A.value=F,W.value=ie,x.value=ve,p.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:S.value,hasCurrentSnapshot:!!A.value})}async function ae(j,z,se){console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:j,timePoint:z,hasMeta:!!se});const ge=B.find(F=>F.id===j);if(!ge){console.warn("[GraphStateChart] Stage not found:",j);return}const ye={graphType:"line",stageId:j,stageName:ge.name,timePoint:z,snapshots:d.value,meta:{line:se||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:U.value};try{const F=await Pa({stageId:j,graphType:"line",timePoint:z,snapshots:d.value,meta:{line:se||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:U.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:F.stageName,stageId:j,totalCount:F.totalCount,employeesCount:F.employees?.length||0,hasSnapshot:!!F.snapshot}),le(F.stageName,j,F.totalCount,F.employees,F.others,F.snapshot,null,ye)}catch(F){console.error("[GraphStateChart] Failed to open modal for line point:",F),oe.error("Не удалось открыть попап для выбранной точки графика")}}function me(j,z){if(!z||!z.employees||z.employees.length===0){oe.warning("Нет данных о сотрудниках для этого этапа");return}const se=d.value.current||d.value.weekEnd||d.value.weekStart,ge={graphType:"doughnut",stageId:j,stageName:z.stageName,snapshots:d.value,meta:{doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:U.value};le(z.stageName,j,z.totalCount,z.employees,z.others,se,null,ge)}function Se(){p.value=!1,y.value="",S.value="",C.value=0,k.value=[],_.value=null,A.value=null,W.value=null}async function Ie(j,z,se){if(f.value!=="line"||z.length===0)return;const ge=z[0],ye=ge.datasetIndex,F=ge.index,ie=se.data.datasets[ye];if(!ie)return;const ve=R(ie.label),Te=re(F);await ae(ve,Te,ie.meta||null)}function xe(j,z,se){if(f.value!=="doughnut"||z.length===0)return;const ye=z[0].index,F=se.data,ie=F.labels[ye],ve=R(ie),Me=F.datasets[0]?.meta?.employees?.[ve];if(!Me){console.warn("Данные о сотрудниках не найдены для этапа:",ve);return}me(ve,Me)}function Fe(j){const z=B[j];if(!z)return 0;const se=d.value.current||d.value.weekEnd||d.value.weekStart;return!se||!se.statistics||!se.statistics.stages?0:se.statistics.stages[z.id]?.count||0}function V(j){const z=B.find(ye=>ye.id===j);if(!z)return"";const se=d.value.current||d.value.weekEnd||d.value.weekStart;if(!se||!se.statistics||!se.statistics.stages)return z.name;const ge=se.statistics.stages[j]?.count||0;return`${z.name} (${ge})`}const N=M(()=>{if(!l.value)return null;if(f.value==="doughnut"||f.value==="bar")return l.value;const j=l.value.datasets.filter(z=>{const se=B.find(ge=>ge.name===z.label);return se?q.value[se.id]:!0});return{...l.value,datasets:j}});M(()=>f.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const b=M(()=>{const j={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:f.value==="bar"?{bottom:80}:{}},onClick:(z,se,ge)=>{f.value==="line"?Ie(z,se,ge):f.value==="doughnut"&&xe(z,se,ge)},onHover:(z,se,ge)=>{f.value==="doughnut"&&(z.native.target.style.cursor=se.length>0?"pointer":"default")},plugins:{legend:{display:f.value!=="bar",position:f.value==="doughnut"?"right":"top",labels:{font:{size:f.value==="doughnut"?14:12,weight:f.value==="doughnut"?"600":"500"},boxWidth:f.value==="doughnut"?18:12,boxHeight:f.value==="doughnut"?18:12,padding:f.value==="doughnut"?14:10},onClick:(z,se,ge)=>{if(f.value==="bar"){const F=se.datasetIndex;if(F!==void 0){const ie=ge.chart.getDatasetMeta(F);ie.hidden=!ie.hidden,ge.chart.update()}return}const ye=se.datasetIndex;if(ye!==void 0){const F=ge.chart.getDatasetMeta(ye);F.hidden=!F.hidden,ge.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:z=>{if(f.value==="bar"){const se=z[0].dataIndex,ge=B[se];return ge?ge.name:""}return z[0].label||""},label:z=>{const se=z.dataset.label||"",ge=z.parsed.y||z.parsed||0,ye=z.dataIndex;if(f.value==="bar"){const F=z.dataset,ie=z.dataIndex,ve=B[ie],Te=ve?ve.name:"";return`${F.label}: ${ge} тикетов на этапе "${Te}"`}if(f.value==="doughnut"){const F=z.dataset.data.reduce((ve,Te)=>ve+Te,0),ie=F>0?(ge/F*100).toFixed(1):0;return`${se}: ${ge} тикетов (${ie}%)`}else{if(!g.value||ye===0)return`${se}: ${ge} тикетов`;let F=null;const ie=w(se);if(v.value==="weekStartToWeekEnd"&&ye===1?F=g.value.weekStartToWeekEnd?.stages?.[ie]:v.value==="weekEndToCurrent"&&ye===2&&d.value.current?F=g.value.weekEndToCurrent?.stages?.[ie]:v.value==="weekStartToCurrent"&&ye===2&&d.value.current&&(F=g.value.weekStartToCurrent?.stages?.[ie]),!F)return`${se}: ${ge} тикетов`;const ve=F.delta,Te=F.deltaPercent,Me=F.trend;let Ve=`${se}: ${ge} тикетов`;if(ve!==0){const Le=ve>0?"+":"",Ue=Me==="increase"?"↑":Me==="decrease"?"↓":"→";Ve+=` (${Le}${ve}, ${Le}${Te.toFixed(1)}%) ${Ue}`}else Ve+=" (без изменений)";return Ve}},afterBody:z=>{if(f.value==="bar"&&z.length>0){const F=z[0];F.dataset;const ie=F.parsed.y||0,ve=F.dataIndex,Te=Fe(ve);return[`${Te>0?(ie/Te*100).toFixed(1):0}% от общего количества этапа`]}if(f.value==="doughnut"&&z.length>0)return["Кликните для детализации по сотрудникам"];if(f.value==="line"){const F=[];if(g.value){const ie=z[0].dataIndex;if(ie!==0){let ve=null;if(w(z[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&ie===1?ve=g.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&ie===2?ve=g.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&ie===2&&(ve=g.value.weekStartToCurrent),ve&&ve.metadata){const Te=ve.metadata.timeDiff;F.push(`Период: ${Te.days} дн. ${Te.hours} ч. ${Te.minutes} мин.`)}}}return F.push("Кликните для детализации по сотрудникам"),F}if(!g.value)return[];const se=z[0].dataIndex;if(se===0)return[];let ge=null;if(w(z[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&se===1?ge=g.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&se===2?ge=g.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&se===2&&(ge=g.value.weekStartToCurrent),!ge||!ge.metadata)return[];const ye=ge.metadata.timeDiff;return[`Период: ${ye.days} дн. ${ye.hours} ч. ${ye.minutes} мин.`]}}},title:{display:!1}}};return f.value==="line"||f.value==="bar"?{...j,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:f.value==="doughnut"?{...j,cutout:"60%"}:j});function O(j){const z=new Date(j),se=z.getFullYear(),ge=String(z.getMonth()+1).padStart(2,"0"),ye=String(z.getDate()).padStart(2,"0");return`${se}-${ge}-${ye}`}function Q(j){const{current:z,weekEnd:se}=j,ge=z||se;if(!ge||!ge.statistics||!ge.statistics.stages)return null;const ye=[],F=[],ie=[],ve=[],Te={},Me={};if(B.forEach(Le=>{const Ue=ge.statistics.stages[Le.id]?.count||0;if(Ue>0){ye.push(`${Le.name} (${Ue})`),F.push(Ue),ie.push(Le.color+"80"),ve.push(Le.color),Me[Le.id]=Ue;const Ge=Kl(Le.id,ge,B);Ge&&Ge.employees&&(Te[Le.id]=Ge)}}),F.length===0)return null;const Ve=F.reduce((Le,Ue)=>Le+Ue,0);return{labels:ye,datasets:[{label:"Распределение по этапам",data:F,backgroundColor:ie,borderColor:ve,borderWidth:2,meta:{employees:Te,totals:{overall:Ve,stages:Me}}}]}}function ue(j){if(f.value==="doughnut")return Q(j);if(f.value==="bar"){const ie=t.showCurrentState&&j.current?"current":j.weekEnd?"weekEnd":"weekStart";return Gl(j,ie,B)}const{weekStart:z,weekEnd:se,current:ge}=j,ye=[],F=[];return B.forEach((ie,ve)=>{const Te=[];if(z&&z.statistics&&z.statistics.stages){const He=z.statistics.stages[ie.id];if(ye.length===0){const Tt=z.metadata?.createdAt?new Date(z.metadata.createdAt):null;ye.push(Tt?O(Tt):"Начало недели")}Te.push(He?.count||0)}else ye.length===0&&ye.push("Начало недели"),Te.push(0);if(se&&se.statistics&&se.statistics.stages){const He=se.statistics.stages[ie.id];if(ye.length===1){const Tt=se.metadata?.createdAt?new Date(se.metadata.createdAt):null;ye.push(Tt?O(Tt):"Конец недели")}Te.push(He?.count||0)}else ye.length===1&&ye.push("Конец недели"),Te.push(0);if(ge&&t.showCurrentState&&ge.statistics&&ge.statistics.stages){const He=ge.statistics.stages[ie.id];ye.length===2&&ye.push("Текущее состояние"),Te.push(He?.count||0)}const Me=["stable"];g.value?v.value==="weekStartToWeekEnd"?(Me.push(g.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),ge&&Me.push(g.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekEndToCurrent"&&ge?(Me.push("stable"),Me.push(g.value.weekEndToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekStartToCurrent"&&ge?(Me.push(g.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),Me.push(g.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):(Me.push("stable"),ge&&Me.push("stable")):(Me.push("stable"),ge&&Me.push("stable"));let Ve,Le,Ue;g.value&&f.value!=="doughnut"?(Ve=Me.map(He=>fe(He,"background")+"40"),Le=Me.map(He=>fe(He,"border")),Ue=Me.map(He=>fe(He,"point"))):(Ve=ie.color+"40",Le=ie.color,Ue=ie.color);let Ge=null;f.value==="line"&&(Ge={employees:Vl(ie.id,j)}),F.push({label:ie.name,data:Te,backgroundColor:(Array.isArray(Ve),Ve),borderColor:(Array.isArray(Le),Le),borderWidth:2,...f.value==="line"&&{pointStyle:G[ve%G.length]},pointBackgroundColor:(Array.isArray(Ue),Ue),pointBorderColor:(Array.isArray(Le),Le),pointRadius:7,pointHoverRadius:10,fill:f.value!=="line",tension:f.value==="line"?.4:0,meta:Ge})}),ye.length===0&&(ye.push("Начало недели","Конец недели"),t.showCurrentState&&ye.push("Текущее состояние")),{labels:ye,datasets:F}}const ke=async()=>{i.value=!0,n.value=null;try{const j=t.period?.endDate?new Date(t.period.endDate):new Date,z=t.period?.startDate?new Date(t.period.startDate):pt.getWeekStartDate(j),se=t.period?.endDate?new Date(t.period.endDate):pt.getWeekEndDate(j),ge=pt.formatDate(z),ye=pt.formatDate(se),[F,ie]=await Promise.all([pt.getSnapshot(ge,"week_start"),pt.getSnapshot(ye,"week_end")]);let ve=null;t.showCurrentState&&(ve=await Rs.getSectorDataForSnapshot({useCache:!1,normalize:!0})),d.value={weekStart:F,weekEnd:ie,current:ve},Z(),P(),K(),r("data-loaded",{weekStart:F,weekEnd:ie,current:ve})}catch(j){console.error("Error loading chart data:",j),n.value=j.message||"Ошибка загрузки данных графика",oe.error("Ошибка загрузки данных графика: "+n.value),r("error",n.value)}finally{i.value=!1}};$e(()=>{Je.register(Zd),Je.register(eu),Je.register(tu),ke()});function _e(j){q.value=j}const K=()=>{const j=ue({weekStart:d.value.weekStart,weekEnd:d.value.weekEnd,current:d.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==j?.labels?.length)l.value=j;else if(j){const z=JSON.stringify(l.value),se=JSON.stringify(j);z!==se&&(l.value=j)}};return Ne(()=>[t.period,t.showCurrentState],()=>{ke()},{deep:!0}),Ne(f,()=>{(d.value.weekStart||d.value.weekEnd||d.value.current)&&K()}),Ne(v,()=>{(d.value.weekStart||d.value.weekEnd||d.value.current)&&K()}),(j,z)=>(c(),u("div",su,[a("div",au,[z[3]||(z[3]=a("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),a("div",ou,[(c(),u(ee,null,te(T,se=>a("button",{key:se.value,onClick:ge=>f.value=se.value,class:X(["chart-type-btn",{active:f.value===se.value}]),title:se.label},[a("span",ru,m(se.icon),1),a("span",iu,m(se.label),1)],10,nu)),64))])]),!i.value&&!n.value&&g.value&&f.value!=="doughnut"?(c(),u("div",lu,[z[7]||(z[7]=a("h4",{class:"comparison-title"},"Тип сравнения:",-1)),a("div",cu,[a("label",null,[Be(a("input",{type:"radio","onUpdate:modelValue":z[0]||(z[0]=se=>v.value=se),value:"weekStartToWeekEnd",onChange:K},null,544),[[Et,v.value]]),z[4]||(z[4]=a("span",null,"Начало недели → Конец недели",-1))]),d.value.current?(c(),u("label",du,[Be(a("input",{type:"radio","onUpdate:modelValue":z[1]||(z[1]=se=>v.value=se),value:"weekEndToCurrent",onChange:K},null,544),[[Et,v.value]]),z[5]||(z[5]=a("span",null,"Конец недели → Текущее состояние",-1))])):$("",!0),d.value.current?(c(),u("label",uu,[Be(a("input",{type:"radio","onUpdate:modelValue":z[2]||(z[2]=se=>v.value=se),value:"weekStartToCurrent",onChange:K},null,544),[[Et,v.value]]),z[6]||(z[6]=a("span",null,"Начало недели → Текущее состояние",-1))])):$("",!0)])])):$("",!0),!i.value&&!n.value&&l.value?(c(),he(Ml,{key:1,stages:B,selected:q.value,"onUpdate:selected":_e,onChange:K},null,8,["selected"])):$("",!0),!i.value&&!n.value&&g.value&&f.value!=="doughnut"?(c(),u("div",gu,[...z[8]||(z[8]=[_t('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):$("",!0),i.value?(c(),he(bs,{key:3,message:"Загрузка данных графика..."})):n.value?(c(),u("div",mu,[a("p",hu,"❌ "+m(n.value),1),a("button",{onClick:ke,class:"btn-retry"},"Повторить загрузку")])):N.value?(c(),u("div",{key:5,class:X(["chart-container",`chart-type-${f.value}`])},[a("div",fu,[a("div",vu,[(c(),he(wt(E.value),{data:N.value,options:b.value},null,8,["data","options"]))]),f.value==="bar"?(c(),u("div",pu,[(c(),u(ee,null,te(B,se=>a("div",{key:se.id,class:"stage-label-item"},m(V(se.id)),1)),64))])):$("",!0)])],2)):(c(),u("div",yu,[...z[9]||(z[9]=[a("p",null,"📊 Нет данных для отображения",-1),a("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ne(Hd,{"is-visible":p.value,"stage-name":y.value,"stage-id":S.value,"total-count":C.value,employees:k.value,others:_.value,snapshot:A.value,"ticket-details":W.value,"stage-switch-context":x.value,onClose:Se},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},bu=de(ku,[["__scopeId","data-v-cbba196a"]]),nt={USER_NOT_DETERMINED:"USER_NOT_DETERMINED",ACCESS_DENIED:"ACCESS_DENIED",API_ERROR:"API_ERROR"};class dt{constructor(e,s=null,t=null,r=null){this.allowed=e,this.errorCode=s,this.errorMessage=t,this.user=r}}class it{static async checkAccess(){try{const e=Ot();if(console.log("AccessControlService.checkAccess - isInsideBitrix24:",e),console.log("AccessControlService.checkAccess - window.self === window.top:",window.self===window.top),console.log("AccessControlService.checkAccess - typeof BX24:",typeof BX24),e)console.log("AccessControlService.checkAccess - Inside Bitrix24, skipping direct access check");else{console.log("AccessControlService.checkAccess - Not inside Bitrix24, checking direct access config...");const{isDirectAccessAllowed:i,getDenyMessage:n}=await Ee(async()=>{const{isDirectAccessAllowed:d,getDenyMessage:g}=await import("./direct-access-config-DVmJvOqu.js");return{isDirectAccessAllowed:d,getDenyMessage:g}},__vite__mapDeps([5,4]),import.meta.url),l=await i();if(console.log("AccessControlService.checkAccess - allowDirectAccess:",l),!l){const d=await n();return console.warn("Direct access denied: Application opened directly in browser, but direct access is disabled in config"),console.warn("Deny message:",d),new dt(!1,nt.ACCESS_DENIED,d,null)}console.log("Direct access allowed: Using primary administrator token from settings.php")}if(e)try{await Promise.race([kt.init(),new Promise((i,n)=>setTimeout(()=>n(new Error("Инициализация Bitrix24 API превысила 5 секунд")),5e3))])}catch(i){console.warn("BX24.init() failed, will try proxy API:",i)}let s;try{s=await Promise.race([kt.getCurrentUser(),new Promise((i,n)=>setTimeout(()=>n(new Error("Получение информации о пользователе превысило 10 секунд")),1e4))])}catch(i){console.warn("Bitrix24BxApi.getCurrentUser() failed, trying proxy API:",i);const{Bitrix24ApiProvider:n}=await Ee(async()=>{const{Bitrix24ApiProvider:l}=await import("./chunk-2JzEd2ES.js").then(d=>d.b);return{Bitrix24ApiProvider:l}},__vite__mapDeps([3,4]),import.meta.url);try{const l=await n.getInstance();s=await Promise.race([l.getCurrentUser(),new Promise((d,g)=>setTimeout(()=>g(new Error("Прокси API превысило 5 секунд")),5e3))]),console.log("Got user from proxy API:",s?.ID||"unknown")}catch(l){throw console.error("Both BX24 API and proxy API failed:",l),new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}if(!s||!s.ID)return console.warn("AccessControlService.checkAccess - user not determined:",s),new dt(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.");console.log("AccessControlService.checkAccess - user determined:",{id:s.ID,name:s.NAME,departments:s.UF_DEPARTMENT});const t=s.UF_DEPARTMENT||[];if(console.log("AccessControlService.checkAccess - departmentIds:",t),!Array.isArray(t)||t.length===0){if(console.log("AccessControlService.checkAccess - user has no departments"),!e){const{isDirectAccessAllowed:i}=await Ee(async()=>{const{isDirectAccessAllowed:l}=await import("./direct-access-config-DVmJvOqu.js");return{isDirectAccessAllowed:l}},__vite__mapDeps([5,4]),import.meta.url);if(await i())return console.log("AccessControlService.checkAccess - Direct access allowed, granting access despite no departments"),new dt(!0,null,null,s)}return console.warn("AccessControlService.checkAccess - Access denied: user has no departments"),new dt(!1,nt.ACCESS_DENIED,"Доступ запрещён. Пользователь не привязан к отделу.")}const r=t.some(i=>_a(i));return console.log("AccessControlService.checkAccess - hasAccess:",r),r?(console.log("AccessControlService.checkAccess - Access granted"),new dt(!0,null,null,s)):(console.warn("AccessControlService.checkAccess - Access denied: no allowed departments"),new dt(!1,nt.ACCESS_DENIED,"Доступ запрещён"))}catch(e){return console.error("AccessControlService.checkAccess error:",e),e.message&&(e.message.includes("CORS")||e.message.includes("blocked")||e.message.includes("ERR_FAILED")||e.message.includes("unknown address space"))&&Ot()?(console.error("CORS error inside Bitrix24: Cannot determine interface user."),new dt(!1,nt.API_ERROR,"Ошибка CORS: не удалось определить пользователя интерфейса. Обратитесь в Поддержку приложения в ИТ отдел.")):e.message&&e.message.includes("not loaded")?new dt(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел."):new dt(!1,nt.API_ERROR,"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел.")}}static async getCurrentUser(){try{return Ot()&&await kt.init(),await kt.getCurrentUser()}catch(e){return console.error("AccessControlService.getCurrentUser error:",e),null}}}const _u={key:0,class:"create-snapshot-button-container"},wu=["disabled"],Cu={class:"modal-content"},Tu={class:"modal-header"},Su=["disabled"],Du={class:"modal-body"},Eu={key:0,class:"progress-container"},Au={class:"progress-bar-wrapper"},$u={class:"progress-text"},Iu={class:"progress-percent"},Mu={class:"progress-description"},Nu={key:1},xu={class:"modal-footer"},Lu=["disabled"],Pu=["disabled"],Ou={key:0},Bu={key:0},Ru={key:1},Wu={key:2},Uu={key:1},Fu={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(o,{emit:e}){const s=o,t=e,r=I(s.user),i=I(!1),n=I(!1),l=I(0),d=I("idle"),g=I(""),v=ct(),T=M(()=>r.value?ts(r.value):!1);$e(async()=>{if(!s.user)try{const C=await it.checkAccess();C.allowed&&(r.value=C.user)}catch(C){console.error("Error loading user:",C)}});const f=()=>{if(!T.value){v.warning("Только администраторы могут создавать слепки");return}i.value=!0},p=()=>{n.value||(i.value=!1,d.value="idle",l.value=0,g.value="")},y=async()=>{if(!n.value){if(!T.value){v.warning("Только администраторы могут создавать слепки");return}n.value=!0,d.value="loading_data",l.value=0,g.value="Инициализация загрузки данных...";try{g.value="Загрузка данных сектора из Bitrix24...";const C=await Rs.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:A=>{const W=Math.min(80,(A.progress||0)*.8);l.value=W,d.value="loading_data",g.value=A.description||A.details?.description||"Загрузка данных сектора..."}});d.value="creating_snapshot",l.value=85,g.value="Создание слепка...";const k=r.value;if(!k)throw new Error("Пользователь не определён");const _=await pt.createSnapshot(C,"manual",{createdBy:{id:k.ID,name:`${k.NAME||""} ${k.LAST_NAME||""}`.trim()||k.EMAIL||`User ${k.ID}`},sectorId:"1C"});d.value="success",l.value=100,g.value="Слепок успешно создан!",v.success("Слепок состояния сектора успешно создан"),t("snapshot-created",_),setTimeout(()=>{p()},1500)}catch(C){d.value="error",l.value=0,g.value="Ошибка создания слепка",console.error("Error creating snapshot:",C);let k="Ошибка создания слепка";C.message&&(C.message.includes("загрузки данных")||C.message.includes("sector data")?k="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":C.message.includes("создания слепка")||C.message.includes("snapshot")?k="Не удалось создать слепок. Обратитесь в поддержку.":C.message.includes("валидац")||C.message.includes("validation")?k="Ошибка валидации данных. Проверьте данные сектора.":k=C.message),v.error(k)}finally{n.value=!1}}},S=C=>{C.key==="Escape"&&i.value&&!n.value&&p()};return $e(()=>{window.addEventListener("keydown",S)}),st(()=>{window.removeEventListener("keydown",S)}),(C,k)=>T.value?(c(),u("div",_u,[a("button",{class:"create-snapshot-btn",onClick:f,disabled:n.value,title:"Создать слепок состояния сектора"},[...k[1]||(k[1]=[a("span",{class:"btn-icon"},"📸",-1),a("span",{class:"btn-text"},"Создать слепок",-1)])],8,wu),(c(),he(It,{to:"body"},[ne(Ae,{name:"modal"},{default:pe(()=>[i.value?(c(),u("div",{key:0,class:"modal-overlay",onClick:k[0]||(k[0]=Ce(_=>!n.value&&p(),["self"]))},[a("div",Cu,[a("div",Tu,[k[2]||(k[2]=a("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),a("button",{class:"modal-close",onClick:p,disabled:n.value,"aria-label":"Закрыть"}," ✕ ",8,Su)]),a("div",Du,[d.value!=="idle"?(c(),u("div",Eu,[a("div",Au,[a("div",{class:"progress-bar",style:we({width:`${l.value}%`})},null,4)]),a("div",$u,[a("span",Iu,m(Math.round(l.value))+"%",1),a("span",Mu,m(g.value),1)])])):(c(),u("div",Nu,[...k[3]||(k[3]=[a("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),a("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),a("div",xu,[a("button",{class:"btn btn-secondary",onClick:p,disabled:n.value}," Отмена ",8,Lu),a("button",{class:"btn btn-primary",onClick:y,disabled:n.value},[n.value?(c(),u("span",Ou,[d.value==="loading_data"?(c(),u("span",Bu,"Загрузка данных...")):d.value==="creating_snapshot"?(c(),u("span",Ru,"Создание...")):(c(),u("span",Wu,"Обработка..."))])):(c(),u("span",Uu,"Создать"))],8,Pu)])])])):$("",!0)]),_:1})]))])):$("",!0)}},Hu=de(Fu,[["__scopeId","data-v-09bccee2"]]),ju=20,zu=5*60*1e3;async function Vu({search:o="",limit:e=ju,sectorDepartmentId:s=Yt.SECTOR_1C}={}){const t=`sector1c_employees_${o}_${e}_${s||"all"}`,r=sessionStorage.getItem(t);if(r)try{const{data:i,timestamp:n}=JSON.parse(r);if(Date.now()-n<zu)return i}catch(i){console.warn("[sector1cEmployees] Cache parse error:",i)}try{const i={ACTIVE:"Y"};s?Array.isArray(s)?i.UF_DEPARTMENT=s:i.UF_DEPARTMENT=[s]:i.UF_DEPARTMENT=[Yt.SECTOR_1C],o&&o.length>=2&&(i["%NAME"]=o,i["%LAST_NAME"]=o,i["%WORK_POSITION"]=o);const g=((await new vt().call("user.get",{filter:i,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,e).map(v=>({id:parseInt(v.ID),name:Gu(v),position:v.WORK_POSITION||"",department:v.UF_DEPARTMENT||null}));try{sessionStorage.setItem(t,JSON.stringify({data:g,timestamp:Date.now()}))}catch(v){console.warn("[sector1cEmployees] Cache write error:",v)}return g}catch(i){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",i),new Error(`Не удалось загрузить сотрудников: ${i.message}`)}}function Gu(o){const e=[o.LAST_NAME,o.NAME,o.SECOND_NAME].filter(Boolean);return e.length>0?e.join(" "):o.NAME||"Без имени"}function Ku(o,e=300){let s;return function(...r){const i=()=>{clearTimeout(s),o(...r)};clearTimeout(s),s=setTimeout(i,e)}}const qu={class:"employee-select-field-text"},Yu={key:0,class:"employee-select-dropdown"},Xu={class:"employee-select-dropdown-search"},Ju={key:0,class:"employee-select-state"},Zu={key:1,class:"employee-select-state employee-select-state--error"},Qu={key:2,class:"employee-select-state"},eg=["checked"],tg=["checked","onChange"],sg={class:"employee-select-item-content"},ag={class:"employee-select-item-name"},og={key:0,class:"employee-select-item-position"},ng={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(null),n=I(""),l=I([]),d=I(!1),g=I(null),v=I(!1),T=M(()=>{if(!n.value)return l.value;const D=n.value.toLowerCase();return l.value.filter(E=>E.name.toLowerCase().includes(D)||E.position&&E.position.toLowerCase().includes(D))}),f=M(()=>{if(s.selected.includes("all")||s.selected.length===0)return s.placeholder;if(s.selected.length===1){const D=l.value.find(E=>E.id===s.selected[0]);return D?D.name:s.placeholder}return`Выбрано: ${s.selected.length} ${W(s.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function p(D=""){d.value=!0,g.value=null;try{l.value=await Vu({search:D})}catch(E){g.value=E,t("error",E)}finally{d.value=!1}}function y(){t("search",n.value)}function S(){d.value||(v.value=!v.value,v.value?(l.value.length===0&&p(),Wt(()=>{i.value&&i.value.focus()})):n.value="")}function C(D){r.value&&!r.value.contains(D.target)&&(v.value=!1,n.value="")}function k(D){const E=[...s.selected],L=E.indexOf(D);if(D==="all")if(L>-1)E.splice(L,1);else return t("update:selected",["all"]);else if(L>-1)E.splice(L,1);else{const B=E.indexOf("all");B>-1&&E.splice(B,1),E.push(D)}t("update:selected",E)}function _(D){return D==="all"?s.selected.includes("all"):s.selected.includes(D)||s.selected.includes("all")}const A=M(()=>n.value?`Нет сотрудников по запросу "${n.value}"`:"Нет сотрудников сектора 1С");function W(D,E,L,B){const U=D%10,G=D%100;return G>=11&&G<=19?B:U===1?E:U>=2&&U<=4?L:B}function x(){p(n.value)}return Ne(()=>s.selected,D=>{(!D||D.length===0)&&t("update:selected",["all"])},{immediate:!0}),$e(()=>{document.addEventListener("click",C),(!s.selected||s.selected.length===0)&&t("update:selected",["all"])}),st(()=>{document.removeEventListener("click",C)}),(D,E)=>(c(),u("div",{class:"employee-select",ref_key:"selectContainer",ref:r},[a("div",{class:X(["employee-select-field",{"employee-select-field--open":v.value,"employee-select-field--disabled":d.value}]),onClick:S},[a("span",qu,m(f.value),1),a("span",{class:X(["employee-select-field-icon",{open:v.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:pe(()=>[v.value?(c(),u("div",Yu,[a("div",Xu,[Be(a("input",{"onUpdate:modelValue":E[0]||(E[0]=L=>n.value=L),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:y,onClick:E[1]||(E[1]=Ce(()=>{},["stop"])),ref_key:"searchInput",ref:i},null,544),[[At,n.value]])]),d.value?(c(),u("div",Ju,[...E[6]||(E[6]=[a("span",{class:"spinner"},"⏳",-1),a("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):g.value?(c(),u("div",Zu,[a("span",null,"❌ "+m(g.value.message||"Ошибка загрузки сотрудников"),1),a("button",{onClick:[x,E[2]||(E[2]=Ce(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!d.value&&T.value.length===0&&!g.value?(c(),u("div",Qu,[a("span",null,"📭 "+m(A.value),1)])):(c(),u("div",{key:3,class:"employee-select-list",style:we({maxHeight:`${o.maxHeight}px`})},[a("label",{class:X(["employee-select-item",{"employee-select-item--selected":_("all")}]),onClick:E[4]||(E[4]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:_("all"),onChange:E[3]||(E[3]=L=>k("all"))},null,40,eg),E[7]||(E[7]=a("div",{class:"employee-select-item-content"},[a("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(c(!0),u(ee,null,te(T.value,L=>(c(),u("label",{key:L.id,class:X(["employee-select-item",{"employee-select-item--selected":_(L.id)}]),onClick:E[5]||(E[5]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:_(L.id),onChange:B=>k(L.id)},null,40,tg),a("div",sg,[a("span",ag,m(L.name),1),L.position?(c(),u("span",og,m(L.position),1)):$("",!0)])],2))),128))],4))])):$("",!0)]),_:1})],512))}},rg=de(ng,[["__scopeId","data-v-6b8c949b"]]),ig={class:"stage-select-field-text"},lg={key:0,class:"stage-select-dropdown"},cg={class:"stage-select-list"},dg=["checked"],ug=["checked","onChange"],gg={class:"stage-select-item-content"},mg={class:"stage-select-item-name"},hg={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(!1),n=M(()=>Object.values(s.selected).every(f=>f===!0)),l=M(()=>{if(n.value)return s.placeholder;const f=s.stages.filter(p=>s.selected[p.id]);return f.length===0?"Этапы не выбраны":f.length===1?f[0].name:`Выбрано: ${f.length} этапа(ов)`});function d(){i.value=!i.value,i.value}function g(f){r.value&&!r.value.contains(f.target)&&(i.value=!1)}function v(f,p){const y={...s.selected};y[f]=p,t("update:selected",y),t("change",f,p)}function T(){const f=n.value,p={};s.stages.forEach(y=>{p[y.id]=!f}),t("update:selected",p),t("change","all",!f)}return $e(()=>{document.addEventListener("click",g)}),st(()=>{document.removeEventListener("click",g)}),(f,p)=>(c(),u("div",{class:"stage-select",ref_key:"selectContainer",ref:r},[a("div",{class:X(["stage-select-field",{"stage-select-field--open":i.value,"stage-select-field--disabled":!1}]),onClick:d},[a("span",ig,m(l.value),1),a("span",{class:X(["stage-select-field-icon",{open:i.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:pe(()=>[i.value?(c(),u("div",lg,[a("div",cg,[a("label",{class:X(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:p[0]||(p[0]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:n.value,onChange:T},null,40,dg),p[2]||(p[2]=a("div",{class:"stage-select-item-content"},[a("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(c(!0),u(ee,null,te(o.stages,y=>(c(),u("label",{key:y.id,class:X(["stage-select-item",{"stage-select-item--selected":o.selected[y.id]}]),onClick:p[1]||(p[1]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:o.selected[y.id],onChange:S=>v(y.id,S.target.checked)},null,40,ug),a("div",gg,[a("span",{class:"stage-select-item-color",style:we({backgroundColor:y.color})},null,4),a("span",mg,m(y.name),1)])],2))),128))])])):$("",!0)]),_:1})],512))}},fg=de(hg,[["__scopeId","data-v-ce2229b2"]]),vg={class:"trigger-text"},pg={class:"week-picker-items"},yg=["data-week-number","onClick"],kg={class:"week-item-content"},bg={class:"week-number"},_g={class:"week-dates"},wg={class:"week-picker-actions"},Cg=["disabled"],Tg={__name:"WeekPicker",props:{selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52}},emits:["update:selectedWeek","change"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(null),n=I([]),l=I(!1),d=I(!1),g=I(null);function v(x=52,D=4){const E=[],L=new Date,B=T(L),U=f(L);for(let G=0;G<x;G++){const q=new Date(B.start);q.setUTCDate(q.getUTCDate()-G*7);const oe=T(q),Y=f(q);E.unshift({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}(E.length===0||E[E.length-1].weekNumber!==U)&&E.push({weekNumber:U,startUtc:B.start.toISOString(),endUtc:B.end.toISOString(),start:B.start,end:B.end});for(let G=1;G<=D;G++){const q=new Date(B.start);q.setUTCDate(q.getUTCDate()+G*7);const oe=T(q),Y=f(q);E.push({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}return E.sort((G,q)=>G.start-q.start),E}function T(x){const D=new Date(x),E=D.getUTCDay(),L=D.getUTCDate()-E+(E===0?-6:1),B=new Date(Date.UTC(D.getUTCFullYear(),D.getUTCMonth(),L,0,0,0)),U=new Date(B);return U.setUTCDate(U.getUTCDate()+6),U.setUTCHours(23,59,59,999),{start:B,end:U}}function f(x){const D=new Date(Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()));D.setUTCDate(D.getUTCDate()+4-(D.getUTCDay()||7));const E=new Date(Date.UTC(D.getUTCFullYear(),0,1));return Math.ceil(((D-E)/864e5+1)/7)}function p(x){const D=new Date(x),E=D.getUTCFullYear(),L=String(D.getUTCMonth()+1).padStart(2,"0"),B=String(D.getUTCDate()).padStart(2,"0");return`${E}-${L}-${B}`}function y(){d.value=!d.value,d.value&&(n.value=v(s.weeksCount,4),g.value=s.selectedWeek||n.value.find(x=>{const E=f(new Date);return x.weekNumber===E})||n.value[0],Wt(()=>{g.value&&_(g.value.weekNumber)}))}function S(x){g.value=x,_(x.weekNumber)}function C(){g.value&&(t("update:selectedWeek",g.value),t("change",g.value),d.value=!1)}function k(){g.value=s.selectedWeek||null,d.value=!1}function _(x){if(!i.value)return;const D=i.value.querySelector(`[data-week-number="${x}"]`);if(D){const E=i.value,L=D.offsetTop,B=E.clientHeight,U=D.clientHeight,G=L-B/2+U/2;E.scrollTo({top:G,behavior:"smooth"})}}function A(){l.value||!d.value||(l.value=!0,clearTimeout(window.weekPickerScrollTimeout),window.weekPickerScrollTimeout=setTimeout(()=>{if(!i.value){l.value=!1;return}const x=i.value,D=x.getBoundingClientRect(),E=D.top+D.height/2,L=x.querySelectorAll(".week-picker-item");let B=null,U=1/0;if(L.forEach(G=>{const q=G.getBoundingClientRect(),oe=q.top+q.height/2,Y=Math.abs(oe-E);Y<U&&(U=Y,B=G)}),B){const G=parseInt(B.dataset.weekNumber),q=n.value.find(oe=>oe.weekNumber===G);q&&(!g.value||q.weekNumber!==g.value.weekNumber)&&(g.value=q)}l.value=!1},150))}function W(x){r.value&&!r.value.contains(x.target)&&d.value&&k()}return $e(()=>{if(n.value=v(s.weeksCount,4),s.selectedWeek)g.value=s.selectedWeek;else{const D=f(new Date),E=n.value.find(L=>L.weekNumber===D);E?g.value=E:g.value=n.value[0]}document.addEventListener("click",W)}),st(()=>{window.weekPickerScrollTimeout&&clearTimeout(window.weekPickerScrollTimeout),document.removeEventListener("click",W)}),Ne(()=>s.selectedWeek,x=>{x&&(g.value=x,d.value&&!l.value&&Wt(()=>{_(x.weekNumber)}))},{deep:!0}),(x,D)=>(c(),u("div",{class:"week-picker",ref_key:"pickerContainer",ref:r},[D[1]||(D[1]=a("div",{class:"week-picker-label"},[a("span",{class:"section-icon"},"📅"),a("span",null,"Период")],-1)),a("div",{class:X(["week-picker-trigger",{"is-open":d.value}]),onClick:y},[a("span",vg,[o.selectedWeek?(c(),u(ee,{key:0},[ce(" Неделя "+m(o.selectedWeek.weekNumber)+" · "+m(p(o.selectedWeek.startUtc))+" — "+m(p(o.selectedWeek.endUtc)),1)],64)):(c(),u(ee,{key:1},[ce(" Выберите неделю ")],64))]),a("span",{class:X(["trigger-icon",{"is-open":d.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:pe(()=>[d.value?(c(),u("div",{key:0,class:"week-picker-dropdown",onClick:D[0]||(D[0]=Ce(()=>{},["stop"]))},[a("div",{class:"week-picker-wheel",ref_key:"wheelContainer",ref:i,onScroll:A},[a("div",pg,[(c(!0),u(ee,null,te(n.value,(E,L)=>(c(),u("div",{key:E.weekNumber,class:X(["week-picker-item",{active:E.weekNumber===g.value?.weekNumber}]),"data-week-number":E.weekNumber,onClick:B=>S(E)},[a("div",kg,[a("div",bg,"Неделя "+m(E.weekNumber),1),a("div",_g,m(p(E.startUtc))+" — "+m(p(E.endUtc)),1)])],10,yg))),128))])],544),a("div",wg,[a("button",{class:"btn-cancel",onClick:k},"Отмена"),a("button",{class:"btn-apply",onClick:C,disabled:!g.value},"Применить",8,Cg)])])):$("",!0)]),_:1})],512))}},Sg=de(Tg,[["__scopeId","data-v-daae25a6"]]),Dg={class:"filters-panel"},Eg={class:"filters-header"},Ag=["disabled"],$g={class:"filters-content"},Ig={key:0,class:"filter-section"},Mg={class:"section-content"},Ng={class:"filter-section"},xg={class:"section-content"},Lg={class:"filter-section"},Pg={key:0,class:"section-content"},Og={class:"section-content"},Bg={key:0,class:"period-mode-group"},Rg=["value"],Wg=["disabled"],Ug=["disabled"],Fg={key:0,class:"period-mode-hint"},Hg={key:1,class:"period-mode-hint"},jg=["value"],zg={key:0,class:"custom-date-range"},Vg={class:"date-range-inputs"},Gg={class:"date-input-group"},Kg=["value","max"],qg={class:"date-input-group"},Yg=["value","min","max"],Xg={key:0,class:"filter-error"},Jg={key:1,class:"filter-hint"},Zg={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1},hideStages:{type:Boolean,default:!1},weekPickerMode:{type:Boolean,default:!1},selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52},showPeriodMode:{type:Boolean,default:!1},periodMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","update:selectedWeek","update:periodMode","reset","apply"],setup(o,{emit:e}){const s=o,t=e,r=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],i=I(null),n=M(()=>{const C=new Date;return C.setFullYear(C.getFullYear()-1),C.toISOString().split("T")[0]}),l=M(()=>new Date().toISOString().split("T")[0]);function d(C){t("update:stages",C),t("apply")}function g(C,k){t("apply")}function v(C){t("update:employees",C),t("apply")}function T(C){t("update:dateRange",C),i.value=null,t("apply")}function f(C,k){const _={...s.customDateRange};if(_[C]=k,_.startDate&&_.endDate){const A=new Date(_.startDate),W=new Date(_.endDate);if(A>W){i.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((W-A)/(1e3*60*60*24))>365){i.value="Период не может превышать 365 дней";return}}i.value=null,t("update:customDateRange",_),t("apply")}function p(C){t("update:selectedWeek",C),t("apply")}function y(C){if(!["weeks","months"].includes(C)){console.warn("[FiltersPanel] Invalid periodMode:",C);return}C!==s.periodMode&&(t("update:periodMode",C),t("apply"))}function S(){i.value=null,t("reset")}return(C,k)=>(c(),u("div",Dg,[a("div",Eg,[k[4]||(k[4]=a("h2",null,"Фильтры",-1)),a("button",{onClick:S,class:"btn-reset-filters",disabled:!o.hasActiveFilters}," Сбросить фильтры ",8,Ag)]),a("div",$g,[o.hideStages?$("",!0):(c(),u("div",Ig,[k[5]||(k[5]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"📊"),ce(" Этапы ")],-1)),a("div",Mg,[ne(fg,{selected:o.stages,stages:r,placeholder:"Выберите этапы","onUpdate:selected":d,onChange:g},null,8,["selected"])])])),a("div",Ng,[k[6]||(k[6]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"👥"),ce(" Сотрудники сектора 1С ")],-1)),a("div",xg,[ne(rg,{selected:o.employees,"onUpdate:selected":v},null,8,["selected"])])]),a("div",Lg,[o.weekPickerMode?(c(),u("div",Pg,[ne(Sg,{selectedWeek:o.selectedWeek,weeksCount:o.weeksCount,"onUpdate:selectedWeek":p,onChange:p},null,8,["selectedWeek","weeksCount"])])):(c(),u(ee,{key:1},[k[11]||(k[11]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"📅"),ce(" Период ")],-1)),a("div",Og,[o.showPeriodMode?(c(),u("div",Bg,[k[7]||(k[7]=a("label",{class:"period-mode-label"},"Режим отображения:",-1)),a("select",{value:o.periodMode,onChange:k[0]||(k[0]=_=>y(_.target.value)),class:X(["period-mode-select",{"period-mode-select--current-weeks":o.periodMode==="weeks","period-mode-select--current-months":o.periodMode==="months"}])},[a("option",{value:"weeks",disabled:o.periodMode==="weeks"}," 4 последние недели ",8,Wg),a("option",{value:"months",disabled:o.periodMode==="months"}," 3 последних месяца ",8,Ug)],42,Rg),o.periodMode==="weeks"?(c(),u("small",Fg," Текущий режим: 4 последние недели ")):o.periodMode==="months"?(c(),u("small",Hg," Текущий режим: 3 последних месяца ")):$("",!0)])):$("",!0),o.showPeriodMode?$("",!0):(c(),u(ee,{key:1},[a("select",{value:o.dateRange,onChange:k[1]||(k[1]=_=>T(_.target.value)),class:"date-range-select"},[...k[8]||(k[8]=[a("option",{value:"last-week"},"Последняя неделя",-1),a("option",{value:"last-2-weeks"},"Последние 2 недели",-1),a("option",{value:"last-month"},"Последний месяц",-1),a("option",{value:"custom"},"Произвольный период",-1)])],40,jg),o.dateRange==="custom"?(c(),u("div",zg,[a("div",Vg,[a("div",Gg,[k[9]||(k[9]=a("label",null,"С:",-1)),a("input",{type:"date",value:o.customDateRange.startDate,onChange:k[2]||(k[2]=_=>f("startDate",_.target.value)),max:o.customDateRange.endDate||l.value,class:"date-input"},null,40,Kg)]),a("div",qg,[k[10]||(k[10]=a("label",null,"По:",-1)),a("input",{type:"date",value:o.customDateRange.endDate,onChange:k[3]||(k[3]=_=>f("endDate",_.target.value)),min:o.customDateRange.startDate||n.value,max:l.value,class:"date-input"},null,40,Yg)])]),i.value?(c(),u("small",Xg,m(i.value),1)):(c(),u("small",Jg," Выберите начальную и конечную дату для отображения данных "))])):$("",!0)],64))])],64))])])]))}},Fs=de(Zg,[["__scopeId","data-v-5970a362"]]);function Qg(){const o=I(!1),e=I(null),s=I(null),t=I(0),r=ct(),i=async(C=!0,k=null)=>{o.value=!0,e.value=null,t.value=0;try{const _=await Rs.getSectorDataForSnapshot({useCache:C,onProgress:A=>{A&&typeof A.progress=="number"&&(t.value=A.progress),k&&k(A)},normalize:!0});return s.value=_,_}catch(_){throw e.value=_.message||"Ошибка загрузки данных сектора",r.error("Ошибка загрузки данных сектора: "+e.value),_}finally{o.value=!1,t.value=100}},n=async(C,k={})=>{if(!s.value){const _="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw e.value=_,r.error(_),new Error(_)}o.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(C))throw new Error(`Неверный тип слепка: ${C}. Допустимые значения: week_start, week_end, manual, current`);const _=await pt.createSnapshot(s.value,C,k);return r.success("Слепок успешно создан"),_}catch(_){throw e.value=_.message||"Ошибка создания слепка",r.error("Ошибка создания слепка: "+e.value),_}finally{o.value=!1}},l=()=>{o.value=!1,e.value=null,s.value=null,t.value=0},d=M(()=>s.value!==null&&s.value!==void 0),g=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),v=M(()=>{const C=new Date;let k,_;switch(g.value.dateRange){case"last-week":k=new Date(C),k.setDate(C.getDate()-7),_=C;break;case"last-2-weeks":k=new Date(C),k.setDate(C.getDate()-14),_=C;break;case"last-month":k=new Date(C),k.setMonth(C.getMonth()-1),_=C;break;case"custom":k=g.value.customDateRange.startDate?new Date(g.value.customDateRange.startDate):null,_=g.value.customDateRange.endDate?new Date(g.value.customDateRange.endDate):null;break;default:k=new Date(C),k.setDate(C.getDate()-7),_=C}return{startDate:k?k.toISOString().split("T")[0]:null,endDate:_?_.toISOString().split("T")[0]:null}}),T=()=>{p()},f=()=>{g.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},p()},p=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(g.value))}catch(C){console.error("Ошибка сохранения фильтров в localStorage:",C)}},y=()=>{try{const C=localStorage.getItem("graphStateFilters");if(C){const k=JSON.parse(C);k&&typeof k=="object"&&(g.value={stages:k.stages||{formed:!0,review:!0,execution:!0},employees:k.employees||["all"],dateRange:k.dateRange||"last-week",customDateRange:k.customDateRange||{startDate:null,endDate:null}})}}catch(C){console.error("Ошибка загрузки фильтров из localStorage:",C)}},S=M(()=>{const C=Object.values(g.value.stages).some(A=>!A),k=!g.value.employees.includes("all"),_=g.value.dateRange!=="last-week";return C||k||_});return{isLoading:o,error:e,currentSectorData:s,loadingProgress:t,hasSectorData:d,filters:g,selectedPeriod:v,hasActiveFilters:S,loadSectorDataForSnapshot:i,createSnapshot:n,resetState:l,applyFilters:T,resetFilters:f,saveFiltersToLocalStorage:p,loadFiltersFromLocalStorage:y}}const em={class:"graph-state-dashboard"},tm={key:1,class:"error-message-container"},sm={class:"error-message"},am={class:"error-text"},om={key:0,class:"error-details"},nm={class:"dashboard-header"},rm={class:"header-content"},im={class:"breadcrumbs-row"},lm=["aria-disabled","data-fallback","disabled"],cm={class:"breadcrumbs","aria-label":"Навигация"},dm={class:"header-actions"},um=["disabled"],gm={key:0},mm={key:1},hm={key:3,class:"dashboard-content"},fm={class:"chart-container"},vm="Назад",pm={__name:"GraphStateDashboard",setup(o){const e=(ae,me)=>typeof window>"u"?me:getComputedStyle(document.documentElement).getPropertyValue(ae).trim()||me,s=ct(),t=Xe(),r={name:"dashboard-sector-1c"},{filters:i,selectedPeriod:n,hasActiveFilters:l,applyFilters:d,resetFilters:g,loadFiltersFromLocalStorage:v}=Qg(),T=I(null),f=I(!0),p=I(!1),y=I("Загрузка данных..."),S=I(null),C=I(!1),k=I(!1),_=I(typeof window<"u"?window.innerWidth:1024),A=I(null),W=I(!1),x=M(()=>_.value<768);M(()=>_.value>=768&&_.value<1024),M(()=>_.value>=1024);const D=M(()=>typeof window>"u"?!1:window.history.length>1);M(()=>{const ae=new Date;return ae.setFullYear(ae.getFullYear()-1),ae.toISOString().split("T")[0]}),M(()=>new Date().toISOString().split("T")[0]);function E(ae){i.value.stages=ae}function L(ae){i.value.employees=ae}function B(ae){i.value.dateRange=ae}function U(ae){i.value.customDateRange=ae}function G(){d()}function q(){g(),A.value=null,G(),s.info("Фильтры сброшены")}function oe(ae){s.success("Слепок успешно создан")}function Y(ae){p.value=!1,y.value="",console.log("Данные графика загружены:",ae)}function H(ae){p.value=!1,Z({message:ae||"Ошибка загрузки графика",details:null,type:"error"})}function Z(ae){S.value={message:ae.message||"Произошла ошибка",details:ae.details||null,type:ae.type||"error",timestamp:new Date},console.error("Dashboard error:",S.value),s.error(S.value.message)}function fe(){S.value=null}function P(){S.value=null,p.value=!0,y.value="Повторная загрузка данных..."}async function h(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){s.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}C.value=!0;try{const ae=document.querySelector(".chart-container");if(!ae)throw new Error("График не найден");const me=window.html2canvas,Se=await me(ae,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),Ie=window.jsPDF,xe=new Ie("landscape","mm","a4"),Fe=297,V=Se.height*Fe/Se.width;xe.setFontSize(18),xe.text("График состояния сектора 1С",148.5,15,{align:"center"});const N=new Date().toLocaleDateString("ru-RU");xe.setFontSize(10);const b=n.value.startDate&&n.value.endDate?`Период: ${n.value.startDate} - ${n.value.endDate}`:"Период: не указан";xe.text(b,148.5,25,{align:"center"}),xe.text(`Экспорт от ${N}`,148.5,30,{align:"center"}),xe.addImage(Se.toDataURL("image/png"),"PNG",10,35,Fe-20,V-20),xe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${N}`,author:"Bitrix24 Dashboard"});const O=`graph-state-${N.replace(/\//g,"-")}.pdf`;xe.save(O),s.success("График успешно экспортирован в PDF")}catch(ae){console.error("Ошибка экспорта в PDF:",ae),Z({message:"Ошибка экспорта в PDF: "+(ae.message||"Неизвестная ошибка"),details:ae.stack,type:"error"})}finally{C.value=!1}}function w(ae){if(ae?.preventDefault?.(),!W.value){W.value=!0;try{if(D.value){t.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),t.push(r)}finally{W.value=!1}}}function R(){t.push("/")}function re(){typeof window<"u"&&(_.value=window.innerWidth)}async function le(){try{const ae=await it.checkAccess();ae.allowed&&(T.value=ae.user)}catch(ae){console.error("Error loading user:",ae)}}return $e(()=>{v(),le(),typeof window<"u"&&(_.value=window.innerWidth,window.addEventListener("resize",re))}),st(()=>{typeof window<"u"&&window.removeEventListener("resize",re)}),(ae,me)=>{const Se=be("router-link");return c(),u("div",em,[p.value?(c(),he(bs,{key:0,message:y.value},null,8,["message"])):$("",!0),S.value?(c(),u("div",tm,[a("div",sm,[a("div",{class:"error-header"},[me[1]||(me[1]=a("span",{class:"error-icon"},"❌",-1)),me[2]||(me[2]=a("h3",null,"Ошибка",-1)),a("button",{onClick:fe,class:"error-close","aria-label":"Закрыть"},"✕")]),a("p",am,m(S.value.message),1),S.value.details?(c(),u("div",om,[a("details",null,[me[3]||(me[3]=a("summary",null,"Детали ошибки",-1)),a("pre",null,m(S.value.details),1)])])):$("",!0),a("div",{class:"error-actions"},[a("button",{onClick:P,class:"btn-retry"},"Повторить попытку")])])])):$("",!0),a("div",nm,[a("div",rm,[a("div",im,[a("button",{class:"btn-home-link",type:"button",onClick:R,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),me[9]||(me[9]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:w,"aria-label":vm,"aria-disabled":!D.value,"data-fallback":!D.value,disabled:W.value,title:"Назад"}," ← ",8,lm),a("nav",cm,[ne(Se,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...me[4]||(me[4]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),me[6]||(me[6]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),me[7]||(me[7]=a("span",{class:"breadcrumb-current"},"График состояния",-1)),me[8]||(me[8]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(Se,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:pe(()=>[...me[5]||(me[5]=[ce(" График приёма и закрытий ",-1)])]),_:1})])]),me[10]||(me[10]=a("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),me[11]||(me[11]=a("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),a("div",dm,[a("button",{onClick:h,class:"btn-export-pdf",disabled:C.value||p.value,title:"Экспортировать график в PDF"},[C.value?(c(),u("span",mm,"⏳ Экспорт...")):(c(),u("span",gm,"📄 Экспорт в PDF"))],8,um),ne(Hu,{user:T.value,onSnapshotCreated:oe},null,8,["user"])])]),x.value?(c(),u("button",{key:2,class:"mobile-filters-toggle",onClick:me[0]||(me[0]=Ie=>k.value=!k.value)},[me[12]||(me[12]=a("span",null,"Фильтры",-1)),a("span",{class:X(["toggle-icon",{open:k.value}])},"▼",2)])):$("",!0),a("div",{class:X({"mobile-open":k.value&&x.value,"mobile-closed":!k.value&&x.value})},[ne(Fs,{stages:We(i).stages,employees:We(i).employees,dateRange:We(i).dateRange,customDateRange:We(i).customDateRange,hasActiveFilters:We(l),"onUpdate:stages":E,"onUpdate:employees":L,"onUpdate:dateRange":B,"onUpdate:customDateRange":U,onReset:q,onApply:G},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!p.value&&!S.value?(c(),u("div",hm,[a("div",fm,[ne(bu,{period:We(n),"show-current-state":f.value,onDataLoaded:Y,onError:H},null,8,["period","show-current-state"])])])):$("",!0)])}}},Oa=de(pm,[["__scopeId","data-v-831b0079"]]),ym=Object.freeze(Object.defineProperty({__proto__:null,default:Oa},Symbol.toStringTag,{value:"Module"})),km={key:0,class:"modal-overlay"},bm={class:"modal-container",role:"dialog","aria-labelledby":"modal-title","aria-modal":"true"},_m={class:"modal-body"},wm={class:"mode-description"},Cm={__name:"PeriodModeInfoModal",props:{isVisible:{type:Boolean,required:!0},currentMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["close","start-loading","select-mode"],setup(o,{emit:e}){const s=o,t=e,r=I(s.currentMode);function i(d){if(!["weeks","months"].includes(d)){console.warn("[PeriodModeInfoModal] Invalid mode:",d);return}r.value=d,console.log("[DEBUG Modal] handleModeSelect: mode =",d),console.log("[DEBUG Modal] Emitting select-mode event"),t("select-mode",d),console.log("[DEBUG Modal] Emitting close event"),t("close"),console.log("[DEBUG Modal] Scheduling start-loading event in 100ms"),setTimeout(()=>{console.log("[DEBUG Modal] Emitting start-loading event"),t("start-loading")},100)}function n(){console.log("[DEBUG Modal] handleClose called, selectedMode =",r.value),console.log("[DEBUG Modal] Emitting select-mode event with",r.value),t("select-mode",r.value),console.log("[DEBUG Modal] Emitting close event"),t("close")}function l(d){d.key==="Escape"&&s.isVisible&&n()}return Ne(()=>s.currentMode,d=>{["weeks","months"].includes(d)&&(r.value=d)}),$e(()=>{s.isVisible&&document.addEventListener("keydown",l)}),st(()=>{document.removeEventListener("keydown",l)}),Ne(()=>s.isVisible,d=>{d?(document.addEventListener("keydown",l),r.value=s.currentMode):document.removeEventListener("keydown",l)}),(d,g)=>(c(),he(It,{to:"body"},[ne(Ae,{name:"modal-fade"},{default:pe(()=>[o.isVisible?(c(),u("div",km,[a("div",bm,[a("div",{class:"modal-header"},[g[2]||(g[2]=a("h2",{id:"modal-title",class:"modal-title"},[a("span",{class:"modal-icon"},"ℹ️"),ce(" Выбор режима отображения ")],-1)),a("button",{class:"modal-close-btn",onClick:n,"aria-label":"Закрыть",type:"button"}," × ")]),a("div",_m,[g[5]||(g[5]=a("p",{class:"modal-description"}," Выберите режим отображения данных для графика приёма и закрытий: ",-1)),a("div",wm,[a("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="weeks"}]),onClick:g[0]||(g[0]=v=>i("weeks")),type:"button"},[...g[3]||(g[3]=[a("div",{class:"mode-header"},[a("span",{class:"mode-icon"},"📅"),a("h3",{class:"mode-title"},"4 последние недели")],-1),a("p",{class:"mode-text"}," Отображение данных за последние 4 недели с детализацией по неделям. Подходит для краткосрочного анализа динамики поступления и закрытия тикетов. ",-1)])],2),a("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="months"}]),onClick:g[1]||(g[1]=v=>i("months")),type:"button"},[...g[4]||(g[4]=[a("div",{class:"mode-header"},[a("span",{class:"mode-icon"},"📊"),a("h3",{class:"mode-title"},"3 последних месяца")],-1),a("p",{class:"mode-text"}," Отображение данных за последние 3 месяца с детализацией по месяцам и неделям внутри месяцев. Подходит для долгосрочного анализа и выявления трендов. ",-1)])],2)])])])])):$("",!0)]),_:1})]))}},Tm=de(Cm,[["__scopeId","data-v-4a42a9a6"]]),Sm={class:"ac-chart"},Dm={class:"ac-chart__header"},Em={class:"ac-chart__subtitle"},Am={class:"ac-chart__controls"},$m={class:"chart-type-selector"},Im=["onClick"],Mm={class:"chart-type-icon"},Nm={class:"chart-type-label"},xm={class:"ac-chart__summary"},Lm={class:"summary-week-block summary-week-block--current"},Pm={class:"summary-week-block__title"},Om={class:"summary-week-block__title-week"},Bm={key:0,class:"summary-week-block__title-dates"},Rm={class:"summary-week-block__cards"},Wm={class:"summary-card__value-wrapper"},Um={class:"summary-card__value"},Fm=["title"],Hm={class:"percentage-indicator__arrow"},jm={class:"percentage-indicator__value"},zm={class:"percentage-indicator__label"},Vm={class:"summary-card__value-wrapper"},Gm={class:"summary-card__value-main"},Km=["title"],qm={class:"percentage-indicator__arrow"},Ym={class:"percentage-indicator__value"},Xm={class:"percentage-indicator__label"},Jm={class:"summary-card__breakdown"},Zm={class:"breakdown-item breakdown-item--this-week"},Qm={class:"breakdown-item__value"},eh={class:"breakdown-item breakdown-item--other-week"},th={class:"breakdown-item__value"},sh={class:"summary-card__value-wrapper"},ah={class:"summary-card__value-main"},oh=["title"],nh={class:"percentage-indicator__arrow"},rh={class:"percentage-indicator__value"},ih={class:"percentage-indicator__label"},lh={class:"summary-card__breakdown"},ch={class:"breakdown-item breakdown-item--this-week"},dh={class:"breakdown-item__value"},uh={class:"breakdown-item breakdown-item--previous-week"},gh={class:"breakdown-item__value"},mh={class:"breakdown-item breakdown-item--older"},hh={class:"breakdown-item__value"},fh={class:"summary-card summary-card--stages"},vh={class:"summary-card__tags"},ph={key:0,class:"stage-tag stage-tag--empty"},yh={key:0,class:"summary-week-divider"},kh={key:1,class:"summary-week-block summary-week-block--previous"},bh={class:"summary-week-block__title"},_h={class:"summary-week-block__title-week"},wh={key:0,class:"summary-week-block__title-dates"},Ch={class:"summary-week-block__cards"},Th={class:"summary-card__value-wrapper"},Sh={class:"summary-card__values-comparison"},Dh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},Eh={class:"summary-card__value"},Ah={class:"value-label"},$h={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},Ih={class:"summary-card__value summary-card__value--current-week"},Mh={class:"value-label"},Nh=["title"],xh={class:"percentage-indicator__arrow"},Lh={class:"percentage-indicator__value"},Ph={class:"percentage-indicator__label"},Oh={class:"summary-card__value-wrapper"},Bh={class:"summary-card__values-comparison"},Rh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},Wh={class:"summary-card__value-main"},Uh={class:"value-label"},Fh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},Hh={class:"summary-card__value-main summary-card__value-main--current-week"},jh={class:"value-label"},zh=["title"],Vh={class:"percentage-indicator__arrow"},Gh={class:"percentage-indicator__value"},Kh={class:"percentage-indicator__label"},qh={class:"summary-card__breakdown"},Yh={class:"breakdown-item breakdown-item--this-week"},Xh={class:"breakdown-item__value"},Jh={class:"breakdown-item breakdown-item--other-week"},Zh={class:"breakdown-item__value"},Qh={class:"summary-card__value-wrapper"},ef={class:"summary-card__values-comparison"},tf={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},sf={class:"summary-card__value-main"},af={class:"value-label"},of={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},nf={class:"summary-card__value-main summary-card__value-main--current-week"},rf={class:"value-label"},lf=["title"],cf={class:"percentage-indicator__arrow"},df={class:"percentage-indicator__value"},uf={class:"percentage-indicator__label"},gf={class:"summary-card__breakdown"},mf={class:"breakdown-item breakdown-item--this-week"},hf={class:"breakdown-item__value"},ff={class:"breakdown-item breakdown-item--previous-week"},vf={class:"breakdown-item__value"},pf={class:"breakdown-item breakdown-item--older"},yf={class:"breakdown-item__value"},kf={class:"summary-card summary-card--stages summary-card--previous"},bf={class:"summary-card__tags"},_f={key:0,class:"stage-tag stage-tag--empty"},wf={class:"ac-chart__body"},Cf={key:0,class:"split-charts-container"},Tf={class:"chart-wrapper chart-wrapper--left"},Sf={class:"chart-canvas-wrapper"},Df={class:"chart-wrapper chart-wrapper--right"},Ef={class:"chart-canvas-wrapper"},Af={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:()=>({weekNumber:null,weekStartUtc:null,weekEndUtc:null})},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,closedTicketsCreatedThisWeek:0,closedTicketsCreatedOtherWeek:0,carryoverTickets:0,carryoverTicketsCreatedThisWeek:0,carryoverTicketsCreatedPreviousWeek:0,carryoverTicketsCreatedOlder:0,carryoverTicketsCreatedOtherWeek:0,series:{new:[0],closed:[0],closedCreatedThisWeek:[0],closedCreatedOtherWeek:[0],carryover:[0],carryoverCreatedThisWeek:[0],carryoverCreatedPreviousWeek:[0],carryoverCreatedOlder:[0],carryoverCreatedOtherWeek:[0]},stagesByWeek:[],stages:[],responsible:[]})}},emits:["open-responsible","open-stages","open-carryover"],setup(o,{emit:e}){Je.register(va);const s=o,t=e,r=M(()=>{const h=s.meta?.weeks||[];return h.length>=2?h[h.length-2]:null}),i=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],n=I("line"),l={color:"#111827",font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:h=>h?.dataset?.borderColor||"#111827",borderWidth:1,borderRadius:4,padding:4,offset:8,formatter:h=>h==null||isNaN(h)?"":k(h),display:h=>{if(h?.chart?.config?.type!=="line")return!1;const R=h?.dataset?.data?.[h.dataIndex];return R!=null&&!isNaN(R)&&isFinite(R)}};M(()=>s.meta?.weekNumber??"—");const d=()=>{const h=s.meta?.weeks||[];return h.length>0?h.map(w=>`Неделя ${w.weekNumber}`):[s.meta?.weekNumber?`Неделя ${s.meta.weekNumber}`:"Неделя"]};function g(h,w,R,re=.3,le=0){if(!w)return((Ie,xe)=>{const Fe=parseInt(Ie.slice(1,3),16),V=parseInt(Ie.slice(3,5),16),N=parseInt(Ie.slice(5,7),16);return`rgba(${Fe}, ${V}, ${N}, ${xe})`})(R,re);const ae=(Se,Ie)=>{const xe=parseInt(Se.slice(1,3),16),Fe=parseInt(Se.slice(3,5),16),V=parseInt(Se.slice(5,7),16);return`rgba(${xe}, ${Fe}, ${V}, ${Ie})`},me=h.createLinearGradient(0,w.bottom,0,w.top);return me.addColorStop(0,ae(R,re)),me.addColorStop(1,ae(R,le)),me}const v=M(()=>{const h=d(),w=Array.isArray(s.data.series?.new)&&s.data.series.new.length>0?s.data.series.new:[s.data.newTickets??0],R=Array.isArray(s.data.series?.closed)&&s.data.series.closed.length>0?s.data.series.closed:[s.data.closedTickets??0],re=Array.isArray(s.data.series?.closedCreatedThisWeek)&&s.data.series.closedCreatedThisWeek.length>0?s.data.series.closedCreatedThisWeek:[s.data.closedTicketsCreatedThisWeek??0],le=Array.isArray(s.data.series?.closedCreatedOtherWeek)&&s.data.series.closedCreatedOtherWeek.length>0?s.data.series.closedCreatedOtherWeek:[s.data.closedTicketsCreatedOtherWeek??0];return{labels:h,datasets:[{label:"Новые",data:w,backgroundColor:ae=>{const me=ae.chart,{ctx:Se,chartArea:Ie}=me;return g(Se,Ie,J.primary)},borderColor:J.primary,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:R,backgroundColor:ae=>{const me=ae.chart,{ctx:Se,chartArea:Ie}=me;return g(Se,Ie,J.success)},borderColor:J.success,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:re,backgroundColor:J.successLight,borderColor:J.successLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:le,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}}]}}),T=M(()=>{const h=d(),w=Array.isArray(s.data.series?.carryover)&&s.data.series.carryover.length>0?s.data.series.carryover:[s.data.carryoverTickets??0],R=Array.isArray(s.data.series?.carryoverCreatedThisWeek)&&s.data.series.carryoverCreatedThisWeek.length>0?s.data.series.carryoverCreatedThisWeek:[s.data.carryoverTicketsCreatedThisWeek??0],re=Array.isArray(s.data.series?.carryoverCreatedPreviousWeek)&&s.data.series.carryoverCreatedPreviousWeek.length>0?s.data.series.carryoverCreatedPreviousWeek:[s.data.carryoverTicketsCreatedPreviousWeek??0],le=Array.isArray(s.data.series?.carryoverCreatedOlder)&&s.data.series.carryoverCreatedOlder.length>0?s.data.series.carryoverCreatedOlder:[s.data.carryoverTicketsCreatedOlder??0];return Array.isArray(s.data.series?.carryoverCreatedOtherWeek)&&s.data.series.carryoverCreatedOtherWeek.length>0?s.data.series.carryoverCreatedOtherWeek:s.data.carryoverTicketsCreatedOtherWeek,{labels:h,datasets:[{label:"Переходящие (все)",data:w,backgroundColor:ae=>{const me=ae.chart,{ctx:Se,chartArea:Ie}=me;return g(Se,Ie,J.carryover)},borderColor:J.carryover,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:R,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:re,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:le,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),f=M(()=>{const h=s.meta?.weeks||[],w=h.length>0?h.map(Fe=>`Неделя ${Fe.weekNumber}`):[s.meta?.weekNumber?`Неделя ${s.meta.weekNumber}`:"Неделя"],R=Array.isArray(s.data.series?.new)&&s.data.series.new.length>0?s.data.series.new:[s.data.newTickets??0],re=Array.isArray(s.data.series?.closed)&&s.data.series.closed.length>0?s.data.series.closed:[s.data.closedTickets??0],le=Array.isArray(s.data.series?.closedCreatedThisWeek)&&s.data.series.closedCreatedThisWeek.length>0?s.data.series.closedCreatedThisWeek:[s.data.closedTicketsCreatedThisWeek??0],ae=Array.isArray(s.data.series?.closedCreatedOtherWeek)&&s.data.series.closedCreatedOtherWeek.length>0?s.data.series.closedCreatedOtherWeek:[s.data.closedTicketsCreatedOtherWeek??0],me=Array.isArray(s.data.series?.carryover)&&s.data.series.carryover.length>0?s.data.series.carryover:[s.data.carryoverTickets??0],Se=Array.isArray(s.data.series?.carryoverCreatedThisWeek)&&s.data.series.carryoverCreatedThisWeek.length>0?s.data.series.carryoverCreatedThisWeek:[s.data.carryoverTicketsCreatedThisWeek??0],Ie=Array.isArray(s.data.series?.carryoverCreatedPreviousWeek)&&s.data.series.carryoverCreatedPreviousWeek.length>0?s.data.series.carryoverCreatedPreviousWeek:[s.data.carryoverTicketsCreatedPreviousWeek??0],xe=Array.isArray(s.data.series?.carryoverCreatedOlder)&&s.data.series.carryoverCreatedOlder.length>0?s.data.series.carryoverCreatedOlder:[s.data.carryoverTicketsCreatedOlder??0];return Array.isArray(s.data.series?.carryoverCreatedOtherWeek)&&s.data.series.carryoverCreatedOtherWeek.length>0?s.data.series.carryoverCreatedOtherWeek:s.data.carryoverTicketsCreatedOtherWeek,{labels:w,datasets:[{label:"Новые",data:R,backgroundColor:J.primary,borderColor:J.primary,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:re,backgroundColor:J.success,borderColor:J.success,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:le,backgroundColor:J.successLight,borderColor:J.successLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:ae,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}},{label:"Переходящие (все)",data:me,backgroundColor:J.carryover,borderColor:J.carryover,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:Se,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:Ie,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:xe,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),p=M(()=>({labels:["Новые","Закрытые","Переходящие"],datasets:[{data:[s.data.newTickets??0,s.data.closedTickets??0,s.data.carryoverTickets??0],backgroundColor:[J.primary,J.success,J.carryover],borderWidth:1}]})),y=M(()=>{switch(n.value){case"line":return yt;case"bar":return fa;case"doughnut":return ha;default:return yt}}),S=M(()=>n.value==="doughnut"?p.value:f.value),C=h=>{if(!h)return"—";try{return new Date(h).toLocaleDateString("ru-RU",{day:"2-digit",month:"short"})}catch{return h}};function k(h){return h==null||isNaN(h)?"0":h>=1e3?h.toLocaleString("ru-RU"):h.toString()}function _(h){const w=h%10,R=h%100;return R>=11&&R<=14?"тикетов":w===1?"тикет":w>=2&&w<=4?"тикета":"тикетов"}const A=M(()=>({responsive:!0,maintainAspectRatio:!1,resizeDelay:0,animation:{duration:800,easing:"easeOutQuart"},interaction:{intersect:!1,mode:"index"},plugins:{datalabels:{...l,anchor:"end",align:"top"},tooltip:{enabled:!0,backgroundColor:"rgba(255, 255, 255, 0.98)",titleColor:"#111827",bodyColor:"#374151",borderColor:"#e5e7eb",borderWidth:1,cornerRadius:8,padding:16,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},displayColors:!0,boxPadding:6,usePointStyle:!0,animation:{duration:300,easing:"easeOutQuart"},callbacks:{title:h=>{if(!h||h.length===0)return"";const w=h[0]?.dataIndex,R=s.meta?.weeks||[];if(R.length>0&&w!==void 0&&R[w]){const me=R[w];return`Неделя ${me.weekNumber} (${C(me.weekStartUtc)} — ${C(me.weekEndUtc)})`}const re=s.meta?.weekNumber,le=s.meta?.weekStartUtc,ae=s.meta?.weekEndUtc;return re&&le&&ae?`Неделя ${re} (${C(le)} — ${C(ae)})`:h[0]?.label||""},label:h=>{const w=h.parsed.y,R=h.dataset.label||"";if(w==null||isNaN(w))return`${R}: 0 тикетов`;const re=k(w),le=_(w);return`${R}: ${re} ${le}`}}},legend:{position:"bottom",labels:{font:{size:13,weight:"500"},padding:12,boxWidth:18,boxHeight:12,usePointStyle:!0,pointStyle:"circle",generateLabels:h=>Je.defaults.plugins.legend.labels.generateLabels(h).map((R,re)=>{const le=h.data.datasets[re],ae=h.getDatasetMeta(re),me=le.borderDash&&Array.isArray(le.borderDash)&&le.borderDash.length>0||le.borderWidth===2||le.fill===!1;return ae.hidden?(R.fontColor="#9ca3af",R.textDecoration="line-through",R.opacity=.5):me?R.fontColor="#6b7280":R.fontColor="#111827",R})},onClick:(h,w)=>{const R=w.datasetIndex;if(R==null){console.warn("[Legend] Invalid datasetIndex:",R);return}const re=h.chart;if(!re){console.warn("[Legend] Chart not found");return}const le=re.getDatasetMeta(R);if(!le){console.warn("[Legend] Dataset meta not found for index:",R);return}le.hidden=!le.hidden,re.update("active")},onHover:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="pointer")},onLeave:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="default")}}},scales:n.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10,color:"#374151",callback:h=>h==null||isNaN(h)?"0":k(h)},title:{display:!1},grid:{color:h=>{if(!h||!h.tick||h.tick.value===void 0)return"#e5e7eb";const w=h.tick.value;return isNaN(w)||!isFinite(w)?"#e5e7eb":w===0||w%5===0?"#d1d5db":"#e5e7eb"},lineWidth:h=>{if(!h||!h.tick||h.tick.value===void 0)return 1;const w=h.tick.value;return isNaN(w)||!isFinite(w)?1:w===0||w%5===0?1.5:1}}},x:{ticks:{maxRotation:45,minRotation:45,font:{size:14},padding:10,color:"#374151"},title:{display:!1},grid:{color:"#e5e7eb",lineWidth:1}}}})),W=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=0){const R={newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0};if(R.carryoverTickets>0&&console.log("[DEBUG currentWeekData]",{total:R.carryoverTickets,thisWeek:R.carryoverTicketsCreatedThisWeek,previousWeek:R.carryoverTicketsCreatedPreviousWeek,older:R.carryoverTicketsCreatedOlder,otherWeek:R.carryoverTicketsCreatedOtherWeek,sum:R.carryoverTicketsCreatedThisWeek+R.carryoverTicketsCreatedPreviousWeek+R.carryoverTicketsCreatedOlder,lastIndex:w,series:{carryoverCreatedPreviousWeek:h.carryoverCreatedPreviousWeek,carryoverCreatedOlder:h.carryoverCreatedOlder,carryoverCreatedPreviousWeekLength:h.carryoverCreatedPreviousWeek?.length,carryoverCreatedOlderLength:h.carryoverCreatedOlder?.length,carryoverCreatedPreviousWeekLast:h.carryoverCreatedPreviousWeek?.[w],carryoverCreatedOlderLast:h.carryoverCreatedOlder?.[w]},currentWeek:s.data.currentWeek,data:{carryoverTicketsCreatedPreviousWeek:s.data.carryoverTicketsCreatedPreviousWeek,carryoverTicketsCreatedOlder:s.data.carryoverTicketsCreatedOlder}}),R.newTickets>0||R.closedTickets>0||R.carryoverTickets>0)return R}}if(s.data?.currentWeek&&typeof s.data.currentWeek=="object"){const h=s.data.currentWeek;if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(s.data?.weeksData&&Array.isArray(s.data.weeksData)&&s.data.weeksData.length>0){const h=s.data.weeksData[s.data.weeksData.length-1];if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=0)return{newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0}}return s.data||{}}),x=M(()=>{const h=s.meta?.weeks||[];return h.length>0?h[h.length-1]:{weekNumber:s.meta?.currentWeek?.weekNumber??s.meta?.weekNumber??null,weekStartUtc:s.meta?.currentWeek?.weekStartUtc??s.meta?.weekStartUtc??null,weekEndUtc:s.meta?.currentWeek?.weekEndUtc??s.meta?.weekEndUtc??null}}),D=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=1){const R=w-1,re=s.meta?.weeks?.[R],le={weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[R]!==void 0?h.closedCreatedThisWeek[R]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[R]!==void 0?h.closedCreatedOtherWeek[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[R]!==void 0?h.carryoverCreatedThisWeek[R]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[R]!==void 0?h.carryoverCreatedPreviousWeek[R]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[R]!==void 0?h.carryoverCreatedOlder[R]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[R]!==void 0?h.carryoverCreatedOtherWeek[R]:0};if(le.newTickets>0||le.closedTickets>0||le.carryoverTickets>0)return le}}if(s.data?.weeksData&&Array.isArray(s.data.weeksData)&&s.data.weeksData.length>=2){const h=s.data.weeksData.length-2,w=s.data.weeksData[h],R=s.meta?.weeks?.[h];if((w.newTickets??0)>0||(w.closedTickets??0)>0||(w.carryoverTickets??0)>0)return{weekNumber:w.weekNumber??R?.weekNumber??null,weekStartUtc:R?.weekStartUtc??null,weekEndUtc:R?.weekEndUtc??null,newTickets:w.newTickets??0,closedTickets:w.closedTickets??0,closedTicketsCreatedThisWeek:w.closedTicketsCreatedThisWeek??0,closedTicketsCreatedOtherWeek:w.closedTicketsCreatedOtherWeek??0,carryoverTickets:w.carryoverTickets??0,carryoverTicketsCreatedThisWeek:w.carryoverTicketsCreatedThisWeek??0,carryoverTicketsCreatedOtherWeek:w.carryoverTicketsCreatedOtherWeek??0}}if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=1){const R=w-1,re=s.meta?.weeks?.[R];return{weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[R]!==void 0?h.closedCreatedThisWeek[R]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[R]!==void 0?h.closedCreatedOtherWeek[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[R]!==void 0?h.carryoverCreatedThisWeek[R]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[R]!==void 0?h.carryoverCreatedPreviousWeek[R]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[R]!==void 0?h.carryoverCreatedOlder[R]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[R]!==void 0?h.carryoverCreatedOtherWeek[R]:0}}}return null}),E=M(()=>{const h=s.data?.stagesByWeek;return Array.isArray(h)?h:null}),L=M(()=>{const h=E.value;if(h&&h.length>0){const w=h.length-1,R=h[w];if(Array.isArray(R))return R}return s.data?.stages??[]}),B=M(()=>{const h=E.value;if(h&&h.length>=2){const w=h.length-2,R=h[w];if(Array.isArray(R))return R}return[]}),U=M(()=>D.value?.weekNumber?`Нет данных для недели ${D.value.weekNumber}`:"Нет данных");function G(h,w){if(typeof h!="number"||isNaN(h)||w==null||typeof w!="number"||isNaN(w)||w===0)return null;if(h===w)return 0;const R=(h-w)/w*100;return!isFinite(R)||isNaN(R)?null:R}function q(h){return h==null||isNaN(h)?"":`${h>=0?"+":""}${h.toFixed(1)}%`}const oe=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=2){const R=w-2;return{weekNumber:s.meta?.weeks?.[R]?.weekNumber??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0}}}return null}),Y=M(()=>{const h=W.value,w=D.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}}),H=M(()=>{const h=D.value,w=oe.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}});function Z(h,w){if(!h||!w)return"";try{const R=new Date(h),re=new Date(w),le=R.getUTCDate(),ae=R.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),me=R.getUTCFullYear(),Se=re.getUTCDate(),Ie=re.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),xe=re.getUTCFullYear();return me===xe&&ae===Ie?`${le} — ${Se} ${ae}`:me===xe?`${le} ${ae} — ${Se} ${Ie}`:`${le} ${ae} ${me} — ${Se} ${Ie} ${xe}`}catch(R){return console.error("[formatWeekDates] Error:",R),""}}const fe=h=>{const w=W.value,R=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,ae=x.value;h==="new"&&R>0?t("open-stages",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc})},P=h=>{const w=D.value;if(!w)return;const R=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,ae=r.value;ae&&(h==="new"&&R>0?t("open-stages",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}))};return(h,w)=>(c(),u("div",Sm,[a("header",Dm,[a("div",null,[w[6]||(w[6]=a("h2",{class:"ac-chart__title"},"График приёма и закрытий сектора 1С",-1)),a("p",Em," Неделя "+m(o.meta?.currentWeek?.weekNumber??o.meta?.weekNumber??"—")+" · "+m((o.meta?.currentWeek?.weekStartUtc??o.meta?.weekStartUtc)||"—")+" — "+m((o.meta?.currentWeek?.weekEndUtc??o.meta?.weekEndUtc)||"—")+" (UTC) ",1)]),a("div",Am,[a("div",$m,[(c(),u(ee,null,te(i,R=>a("button",{key:R.value,class:X(["chart-type-btn",{active:n.value===R.value}]),onClick:re=>n.value=R.value},[a("span",Mm,m(R.icon),1),a("span",Nm,m(R.label),1)],10,Im)),64))])])]),a("section",xm,[a("div",Lm,[a("h3",Pm,[w[7]||(w[7]=a("span",{class:"summary-week-block__title-text"},"Текущая неделя",-1)),a("span",Om," Неделя "+m(x.value.weekNumber??"—"),1),x.value.weekStartUtc?(c(),u("span",Bm,m(Z(x.value.weekStartUtc,x.value.weekEndUtc)),1)):$("",!0)]),a("div",Rm,[a("div",{class:"summary-card summary-card--new",onClick:w[0]||(w[0]=R=>fe("new"))},[w[8]||(w[8]=a("div",{class:"summary-card__label"},"Новые за неделю",-1)),a("div",Wm,[a("div",Um,m(W.value?.newTickets??0),1),Y.value.newTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.newTickets)}`},[a("span",Hm,m(Y.value.newTickets>=0?"↑":"↓"),1),a("span",jm,m(q(Y.value.newTickets)),1),a("span",zm,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,Fm)):$("",!0)])]),a("div",{class:"summary-card summary-card--closed-breakdown",onClick:w[1]||(w[1]=R=>fe("closed"))},[w[13]||(w[13]=a("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),a("div",Vm,[a("div",Gm,m(W.value?.closedTickets??0),1),Y.value.closedTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.closedTickets)}`},[a("span",qm,m(Y.value.closedTickets>=0?"↑":"↓"),1),a("span",Ym,m(q(Y.value.closedTickets)),1),a("span",Xm,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,Km)):$("",!0)]),a("div",Jm,[a("div",Zm,[w[9]||(w[9]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",Qm,m(W.value?.closedTicketsCreatedThisWeek??0),1),w[10]||(w[10]=a("span",{class:"breakdown-item__label"},"этой неделей",-1))]),a("div",eh,[w[11]||(w[11]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",th,m(W.value?.closedTicketsCreatedOtherWeek??0),1),w[12]||(w[12]=a("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),a("div",{class:"summary-card summary-card--carryover-breakdown",onClick:w[2]||(w[2]=R=>fe("carryover"))},[w[20]||(w[20]=a("div",{class:"summary-card__label"},"Переходящие",-1)),a("div",sh,[a("div",ah,m(W.value?.carryoverTickets??0),1),Y.value.carryoverTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.carryoverTickets)}`},[a("span",nh,m(Y.value.carryoverTickets>=0?"↑":"↓"),1),a("span",rh,m(q(Y.value.carryoverTickets)),1),a("span",ih,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,oh)):$("",!0)]),a("div",lh,[a("div",ch,[w[14]||(w[14]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",dh,m(W.value?.carryoverTicketsCreatedThisWeek??0),1),w[15]||(w[15]=a("span",{class:"breakdown-item__label"},"этой недели",-1))]),a("div",uh,[w[16]||(w[16]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",gh,m(W.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[17]||(w[17]=a("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),a("div",mh,[w[18]||(w[18]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",hh,m(W.value?.carryoverTicketsCreatedOlder??0),1),w[19]||(w[19]=a("span",{class:"breakdown-item__label"},"остальные",-1))])])]),a("div",fh,[w[21]||(w[21]=a("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),a("div",vh,[(c(!0),u(ee,null,te(L.value,R=>(c(),u("span",{key:R.stageId,class:"stage-tag"},m(R.stageName||R.stageId)+" — "+m(R.count),1))),128)),!L.value||L.value.length===0?(c(),u("span",ph," Нет данных ")):$("",!0)])])])]),D.value?(c(),u("div",yh,[...w[22]||(w[22]=[a("div",{class:"summary-week-divider__line"},null,-1),a("div",{class:"summary-week-divider__label"},"Предыдущая неделя",-1)])])):$("",!0),D.value?(c(),u("div",kh,[a("h3",bh,[w[23]||(w[23]=a("span",{class:"summary-week-block__title-text"},"Предыдущая неделя",-1)),a("span",_h," Неделя "+m(D.value.weekNumber??"—"),1),D.value.weekStartUtc?(c(),u("span",wh,m(Z(D.value.weekStartUtc,D.value.weekEndUtc)),1)):$("",!0)]),a("div",Ch,[a("div",{class:"summary-card summary-card--new summary-card--previous summary-card--clickable",onClick:w[3]||(w[3]=R=>P("new"))},[w[24]||(w[24]=a("div",{class:"summary-card__label"},"Новые за неделю",-1)),a("div",Th,[a("div",Sh,[a("div",Dh,[a("div",Eh,m(D.value?.newTickets??0),1),a("span",Ah,"Неделя "+m(D.value?.weekNumber??"—"),1)]),a("div",$h,[a("div",Ih,m(oe.value?.newTickets??0),1),a("span",Mh,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.newTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.newTickets)}`},[a("span",xh,m(H.value.newTickets>=0?"↑":"↓"),1),a("span",Lh,m(q(H.value.newTickets)),1),a("span",Ph,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,Nh)):$("",!0)])]),a("div",{class:"summary-card summary-card--closed-breakdown summary-card--previous summary-card--clickable",onClick:w[4]||(w[4]=R=>P("closed"))},[w[29]||(w[29]=a("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),a("div",Oh,[a("div",Bh,[a("div",Rh,[a("div",Wh,m(D.value?.closedTickets??0),1),a("span",Uh,"Неделя "+m(D.value?.weekNumber??"—"),1)]),a("div",Fh,[a("div",Hh,m(oe.value?.closedTickets??0),1),a("span",jh,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.closedTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.closedTickets)}`},[a("span",Vh,m(H.value.closedTickets>=0?"↑":"↓"),1),a("span",Gh,m(q(H.value.closedTickets)),1),a("span",Kh,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,zh)):$("",!0)]),a("div",qh,[a("div",Yh,[w[25]||(w[25]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",Xh,m(D.value?.closedTicketsCreatedThisWeek??0),1),w[26]||(w[26]=a("span",{class:"breakdown-item__label"},"этой неделей",-1))]),a("div",Jh,[w[27]||(w[27]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",Zh,m(D.value?.closedTicketsCreatedOtherWeek??0),1),w[28]||(w[28]=a("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),a("div",{class:"summary-card summary-card--carryover-breakdown summary-card--previous summary-card--clickable",onClick:w[5]||(w[5]=R=>P("carryover"))},[w[36]||(w[36]=a("div",{class:"summary-card__label"},"Переходящие",-1)),a("div",Qh,[a("div",ef,[a("div",tf,[a("div",sf,m(D.value?.carryoverTickets??0),1),a("span",af,"Неделя "+m(D.value?.weekNumber??"—"),1)]),a("div",of,[a("div",nf,m(oe.value?.carryoverTickets??0),1),a("span",rf,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.carryoverTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.carryoverTickets)}`},[a("span",cf,m(H.value.carryoverTickets>=0?"↑":"↓"),1),a("span",df,m(q(H.value.carryoverTickets)),1),a("span",uf,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,lf)):$("",!0)]),a("div",gf,[a("div",mf,[w[30]||(w[30]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",hf,m(D.value?.carryoverTicketsCreatedThisWeek??0),1),w[31]||(w[31]=a("span",{class:"breakdown-item__label"},"этой недели",-1))]),a("div",ff,[w[32]||(w[32]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",vf,m(D.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[33]||(w[33]=a("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),a("div",pf,[w[34]||(w[34]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",yf,m(D.value?.carryoverTicketsCreatedOlder??0),1),w[35]||(w[35]=a("span",{class:"breakdown-item__label"},"остальные",-1))])])]),a("div",kf,[w[37]||(w[37]=a("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),a("div",bf,[(c(!0),u(ee,null,te(B.value,R=>(c(),u("span",{key:R.stageId,class:"stage-tag"},m(R.stageName||R.stageId)+" — "+m(R.count),1))),128)),!B.value||B.value.length===0?(c(),u("span",_f,m(U.value),1)):$("",!0)])])])])):$("",!0)]),a("div",wf,[n.value==="line"?(c(),u("div",Cf,[a("div",Tf,[w[38]||(w[38]=a("h3",{class:"chart-subtitle"},"Новые и Закрытые тикеты",-1)),a("div",Sf,[ne(We(yt),{data:v.value,options:A.value},null,8,["data","options"])])]),a("div",Df,[w[39]||(w[39]=a("h3",{class:"chart-subtitle"},"Переходящие тикеты",-1)),a("div",Ef,[ne(We(yt),{data:T.value,options:A.value},null,8,["data","options"])])])])):(c(),he(wt(y.value),{key:1,data:S.value,options:A.value},null,8,["data","options"]))])]))}},$f=de(Af,[["__scopeId","data-v-3666e13a"]]),If={class:"summary-cards-months"},Mf={class:"summary-card summary-card--new"},Nf={class:"card-content"},xf={class:"card-main-value"},Lf=["title"],Pf={class:"card-month-breakdown"},Of={class:"month-name"},Bf={class:"month-value"},Rf={key:0,class:"month-item month-item--empty"},Wf={class:"summary-card summary-card--closed"},Uf={class:"card-content"},Ff={class:"card-main-value"},Hf=["title"],jf={class:"card-month-breakdown-hierarchical"},zf={class:"month-header"},Vf={class:"month-name"},Gf={class:"month-value"},Kf={class:"month-breakdown"},qf={class:"breakdown-item breakdown-this-week"},Yf={class:"breakdown-value"},Xf={class:"breakdown-item breakdown-other-week"},Jf={class:"breakdown-value"},Zf={key:0,class:"month-item-hierarchical month-item--empty"},Qf={class:"summary-card summary-card--carryover"},ev={class:"card-content"},tv={class:"card-current-value"},sv={class:"current-value"},av=["title"],ov={class:"card-month-breakdown"},nv={class:"month-name"},rv={class:"month-value"},iv={key:0,class:"month-item month-item--empty"},lv={class:"summary-card summary-card--stages"},cv={class:"card-content"},dv={class:"stages-list"},uv={class:"stage-icon"},gv={class:"stage-name"},mv={class:"stage-value"},hv={key:0,class:"stage-item stage-item--empty"},fv={__name:"SummaryCardsMonths",props:{data:{type:Object,required:!0,default:()=>({newTickets:0,newTicketsByMonth:[],closedTickets:0,closedTicketsByMonth:[],carryoverTickets:0,carryoverTicketsByMonth:[],stages:[]})}},setup(o){const e=o;function s(C){return C==null||isNaN(C)?"0":C>=1e6?(C/1e6).toFixed(1)+"M":C>=1e3?C.toLocaleString("ru-RU"):C.toString()}function t(C){return C==null||isNaN(C)?"":`${C>=0?"+":""}${C.toFixed(1)}%`}function r(C,k){if(typeof C!="number"||isNaN(C)||k==null||typeof k!="number"||isNaN(k)||k===0)return null;if(C===k)return 0;const _=(C-k)/k*100;return!isFinite(_)||isNaN(_)?null:_}const i=M(()=>e.data?.newTickets||0),n=M(()=>s(i.value)),l=M(()=>e.data?.newTicketsByMonth||[]),d=M(()=>e.data?.closedTicketsByMonth||[]),g=M(()=>e.data?.carryoverTicketsByMonth||[]),v=M(()=>{const C=g.value;return C.length===0?0:C[C.length-1]?.count||0}),T=M(()=>{const C=typeof e.data?.newTickets=="number"?e.data.newTickets:parseInt(e.data?.newTickets)||0,k=e.data?.previousPeriodData?.newTickets;return r(C,k)}),f=M(()=>{const C=typeof e.data?.closedTickets=="number"?e.data.closedTickets:parseInt(e.data?.closedTickets)||0,k=e.data?.previousPeriodData?.closedTickets;return r(C,k)}),p=M(()=>{const C=v.value,k=g.value,_=k.length>0?k[0]?.count||0:null;return r(C,_)});function y(C){return{"DT140_12:SUCCESS":"stage-success","DT140_12:FAIL":"stage-fail","DT140_12:UC_0GBU8Z":"stage-other"}[C]||""}function S(C){return{"DT140_12:SUCCESS":"✓","DT140_12:FAIL":"✗","DT140_12:UC_0GBU8Z":"⚠"}[C]||"•"}return(C,k)=>(c(),u("div",If,[a("div",Mf,[k[0]||(k[0]=a("h3",{class:"card-title"},"Новые за период",-1)),a("div",Nf,[a("div",xf,[ce(m(n.value)+" ",1),T.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",T.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(T.value)}`},m(t(T.value)),11,Lf)):$("",!0)]),a("div",Pf,[(c(!0),u(ee,null,te(l.value,_=>(c(),u("div",{key:`new-${_.month}`,class:"month-item"},[a("span",Of,m(_.monthName)+":",1),a("span",Bf,m(s(_.count)),1)]))),128)),l.value.length===0?(c(),u("div",Rf," Нет данных ")):$("",!0)])])]),a("div",Wf,[k[5]||(k[5]=a("h3",{class:"card-title"},"Закрытые всего",-1)),a("div",Uf,[a("div",Ff,[ce(m(s(o.data.closedTickets||0))+" ",1),f.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",f.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(f.value)}`},m(t(f.value)),11,Hf)):$("",!0)]),a("div",jf,[(c(!0),u(ee,null,te(d.value,_=>(c(),u("div",{key:`closed-${_.month}`,class:"month-item-hierarchical"},[a("div",zf,[a("span",Vf,m(_.monthName)+":",1),a("span",Gf,m(s(_.count||0)),1)]),a("div",Kf,[a("div",qf,[k[1]||(k[1]=a("span",{class:"breakdown-icon"},"✓",-1)),k[2]||(k[2]=a("span",{class:"breakdown-label"},"этого месяца:",-1)),a("span",Yf,m(s(_.closedCreatedThisWeek||0)),1)]),a("div",Xf,[k[3]||(k[3]=a("span",{class:"breakdown-icon"},"↻",-1)),k[4]||(k[4]=a("span",{class:"breakdown-label"},"другого месяца:",-1)),a("span",Jf,m(s(_.closedCreatedOtherWeek||0)),1)])])]))),128)),d.value.length===0?(c(),u("div",Zf," Нет данных ")):$("",!0)])])]),a("div",Qf,[k[7]||(k[7]=a("h3",{class:"card-title"},"Переходящие всего",-1)),k[8]||(k[8]=a("p",{class:"card-hint"},"Активные тикеты сектора в трех основных рабочих стадиях (текущее состояние)",-1)),a("div",ev,[a("div",tv,[k[6]||(k[6]=a("span",{class:"current-label"},"Текущее состояние:",-1)),a("span",sv,[ce(m(s(v.value))+" ",1),p.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",p.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(p.value)}`},m(t(p.value)),11,av)):$("",!0)])]),a("div",ov,[(c(!0),u(ee,null,te(g.value,_=>(c(),u("div",{key:`carryover-${_.month}`,class:"month-item"},[a("span",nv,m(_.monthName)+":",1),a("span",rv,m(s(_.count||0)),1)]))),128)),g.value.length===0?(c(),u("div",iv," Нет данных ")):$("",!0)])])]),a("div",lv,[k[10]||(k[10]=a("h3",{class:"card-title"},"Закрытия по стадиям",-1)),a("div",cv,[a("div",dv,[(c(!0),u(ee,null,te(o.data.stages||[],_=>(c(),u("div",{key:_.stageId,class:X(["stage-item",y(_.stageId)])},[a("span",uv,m(S(_.stageId)),1),a("span",gv,m(_.stageName||_.stageId)+":",1),a("span",mv,m(s(_.count||0)),1)],2))),128)),!o.data.stages||o.data.stages.length===0?(c(),u("div",hv,[...k[9]||(k[9]=[a("span",{class:"stage-name"},"Нет данных",-1)])])):$("",!0)])])])]))}},vv=de(fv,[["__scopeId","data-v-15d88b90"]]),pv={class:"line-chart-months"},yv={class:"chart-section"},kv={class:"chart-title"},bv={key:0,class:"chart-period"},_v={class:"chart-wrapper"},wv={class:"chart-container"},Cv={class:"chart-summary"},Tv={class:"summary-numbers"},Sv={class:"summary-row"},Dv={class:"summary-values"},Ev={class:"summary-row"},Av={class:"summary-values"},$v={class:"summary-analysis"},Iv=["innerHTML"],Mv={class:"chart-section"},Nv={class:"chart-title"},xv={key:0,class:"chart-period"},Lv={class:"chart-wrapper"},Pv={class:"chart-container"},Ov={class:"chart-analysis"},Bv={class:"analysis-content"},Rv=["innerHTML"],Wv={class:"chart-table-section"},Uv={class:"chart-table-wrapper"},Fv={class:"data-table"},Hv={class:"data-row data-row--new"},jv={class:"data-row data-row--closed"},zv={class:"data-row data-row--carryover"},Vv={__name:"LineChartMonths",props:{data:{type:Object,required:!0,default:()=>({newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[]})},meta:{type:Object,default:()=>({months:[]})}},setup(o){Je.register(va);const e=o;function s(y){return y==null||isNaN(y)?"0":y>=1e3?y.toLocaleString("ru-RU"):y.toString()}const t=M(()=>{const y=new Set;return e.data.newTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&y.add(C.weekNumber)})}),e.data.closedTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&y.add(C.weekNumber)})}),e.data.carryoverTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&y.add(C.weekNumber)})}),Array.from(y).sort((S,C)=>S-C)}),r=M(()=>{const y=e.data.newTicketsByMonth||[],S=y.map(_=>_.monthName||`Месяц ${_.month}`),C=y.map(_=>_.count||0),k=(e.data.closedTicketsByMonth||[]).map(_=>_.count||0);return{labels:S,datasets:[{label:"Новые тикеты",data:C,borderColor:J.primary,backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:10,color:J.primary,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.primary,borderWidth:1,borderRadius:4,padding:4}},{label:"Закрытые тикеты",data:k,borderColor:J.success,backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"start",align:"bottom",offset:10,color:J.success,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.success,borderWidth:1,borderRadius:4,padding:4}}]}}),i=M(()=>{const y=e.data.carryoverTicketsByMonth||[],S=y.map(k=>k.monthName||`Месяц ${k.month}`),C=y.map(k=>k.count||0);return{labels:S,datasets:[{label:"Переходящие тикеты",data:C,borderColor:J.carryover,backgroundColor:"rgba(255, 152, 0, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:4,color:J.carryover}}]}}),n={responsive:!0,maintainAspectRatio:!1,layout:{padding:{left:16,right:0,top:56,bottom:0}},plugins:{legend:{position:"left",labels:{font:{size:14,weight:"500"},padding:16,boxWidth:20,boxHeight:12}},tooltip:{enabled:!0,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:12},datalabels:{anchor:"end",align:"top",formatter:(y,S)=>y==null||isNaN(y)?"":y.toString(),color:"#333",font:{size:12,weight:"bold"},padding:{top:4,bottom:4},display:function(y){const S=y.dataset.data[y.dataIndex];return S!=null&&!isNaN(S)&&isFinite(S)},backgroundColor:"rgba(255, 255, 255, 0.8)",borderColor:"#333",borderWidth:1,borderRadius:4,padding:4}},scales:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10},grid:{lineWidth:1.5}},x:{ticks:{maxRotation:0,minRotation:0,font:{size:14},padding:10},grid:{lineWidth:1.5}}}};function l(y){if(!y||y.length===0)return null;const S=y[0],C=y[y.length-1];if(!S||!C)return null;const k=S.monthName||`Месяц ${S.month}`,_=C.monthName||`Месяц ${C.month}`,A=S.year||new Date().getFullYear();return`${k} — ${_} ${A}`}const d=M(()=>l(e.data?.newTicketsByMonth||[])),g=M(()=>l(e.data?.carryoverTicketsByMonth||[])),v=M(()=>{const y=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(y.length===0)return{new:"—",closed:"—"};const C=y.map(_=>`${s(_.count||0)} (${_.monthName||_.month})`).join(" → "),k=S.map(_=>`${s(_.count||0)} (${_.monthName||_.month})`).join(" → ");return{new:C,closed:k}}),T=M(()=>{const y=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(y.length<2)return["Недостаточно данных для анализа"];const C=[],k=[],_=[];if(y.length>=2){const A=y[0],W=y[1],x=y[2];if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const D=A.monthName||A.month,E=W.monthName||W.month,L=s(A.count||0),B=s(W.count||0);if(A.count>0){const U=(W.count-A.count)/A.count*100;if(isFinite(U)&&!isNaN(U)){const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";k.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&k.push(`  • Появление тикетов: с 0 (${D}) до ${B} (${E})`)}if(x&&W&&typeof W.count=="number"&&typeof x.count=="number"){const D=W.monthName||W.month,E=x.monthName||x.month,L=s(W.count||0),B=s(x.count||0);if(W.count>0){const U=(x.count-W.count)/W.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)k.push(`  • Без изменений: ${L} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";k.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W.count===0&&x.count>0&&k.push(`  • Появление тикетов: с 0 (${D}) до ${B} (${E})`)}}if(S.length>=2){const A=S[0],W=S[1],x=S[2];if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const D=A.monthName||A.month,E=W.monthName||W.month,L=s(A.count||0),B=s(W.count||0);if(A.count>0){const U=(W.count-A.count)/A.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)_.push(`  • Без изменений: ${L} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${B} (${E})`)}if(x&&W&&typeof W.count=="number"&&typeof x.count=="number"){const D=W.monthName||W.month,E=x.monthName||x.month,L=s(W.count||0),B=s(x.count||0);if(W.count>0){const U=(x.count-W.count)/W.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)_.push(`  • Без изменений: ${L} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W.count===0&&x.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${B} (${E})`)}}if(k.length>0&&(C.push("Новые тикеты:"),C.push(...k)),_.length>0&&(C.push("Закрытые тикеты:"),C.push(..._)),y.length>=3&&S.length>=3){const A=y[0],W=y[y.length-1],x=S[0],D=S[S.length-1],E=A.count||0,L=W.count||0,B=x.count||0,U=D.count||0;if(E>0&&B>0){const G=(L-E)/E*100,q=(U-B)/B*100;if(isFinite(G)&&isFinite(q)){const oe=A.monthName||A.month,Y=W.monthName||W.month,H=x.monthName||x.month,Z=D.monthName||D.month,fe=G>=0?"#28a745":"#dc3545",P=G>=0?"#28a745":"#dc3545",h=q>=0?"#28a745":"#dc3545",w=q>=0?"#28a745":"#dc3545";C.push("Общая динамика за период:"),C.push(`  • Новые тикеты: <span style="color: ${fe}; font-weight: 600;">${G>=0?"рост":"снижение"}</span> с ${s(E)} (${oe}) до ${s(L)} (${Y}) — <span style="color: ${P}; font-weight: 600;">${G>=0?"+":"-"}${Math.abs(G).toFixed(1)}%</span>`),C.push(`  • Закрытые тикеты: <span style="color: ${h}; font-weight: 600;">${q>=0?"рост":"снижение"}</span> с ${s(B)} (${H}) до ${s(U)} (${Z}) — <span style="color: ${w}; font-weight: 600;">${q>=0?"+":"-"}${Math.abs(q).toFixed(1)}%</span>`)}}}return C.length>0?C:["Недостаточно данных для анализа"]}),f=M(()=>{const y=e.data?.carryoverTicketsByMonth||[];if(y.length===0)return["Нет данных для анализа"];const S=[],C=[],k=y.filter(_=>_&&typeof _.count=="number").map(_=>`${s(_.count||0)} (${_.monthName||_.month||"Неизвестно"})`).join(" → ");if(k&&S.push(`Переходящие тикеты: ${k}`),y.length>=2){const _=y[0],A=y[1],W=y[2];if(A&&_&&typeof _.count=="number"&&typeof A.count=="number"){const x=_.monthName||_.month,D=A.monthName||A.month,E=s(_.count||0),L=s(A.count||0);if(_.count>0){const B=(A.count-_.count)/_.count*100;if(isFinite(B)&&!isNaN(B))if(Math.abs(B)<.1)C.push(`  • Без изменений: ${E} (${x}) → ${L} (${D}) — 0.0%`);else{const U=B>=0?"Рост":"Снижение",G=Math.abs(B),q=B>=0?"+":"-",oe=B>=0?"#28a745":"#dc3545",Y=B>=0?"#28a745":"#dc3545";C.push(`  • <span style="color: ${oe}; font-weight: 600;">${U}</span> с ${E} (${x}) до ${L} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else _.count===0&&A.count>0&&C.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${L} (${D})`)}if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const x=A.monthName||A.month,D=W.monthName||W.month,E=s(A.count||0),L=s(W.count||0);if(A.count>0){const B=(W.count-A.count)/A.count*100;if(isFinite(B)&&!isNaN(B))if(Math.abs(B)<.1)C.push(`  • Без изменений: ${E} (${x}) → ${L} (${D}) — 0.0%`);else{const U=B>=0?"Рост":"Снижение",G=Math.abs(B),q=B>=0?"+":"-",oe=B>=0?"#28a745":"#dc3545",Y=B>=0?"#28a745":"#dc3545";C.push(`  • <span style="color: ${oe}; font-weight: 600;">${U}</span> с ${E} (${x}) до ${L} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&C.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${L} (${D})`)}}if(C.length>0&&(S.push("Динамика по месяцам:"),S.push(...C)),y.length>=3){const _=y[0],A=y[y.length-1];if(_&&A&&typeof _.count=="number"&&typeof A.count=="number"){const W=_.count||0,x=A.count||0,D=_.monthName||_.month,E=A.monthName||A.month,L=s(W),B=s(x);if(W>0){const U=(x-W)/W*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<1)S.push("Тенденция за период:"),S.push(`  • Стабильное количество: ${L} (${D}) → ${B} (${E}) — изменение менее 1%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";S.push("Тенденция за период:"),S.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W===0&&x>0?(S.push("Тенденция за период:"),S.push(`  • Появление переходящих тикетов: с 0 (${D}) до ${B} (${E})`)):W>0&&x===0&&(S.push("Тенденция за период:"),S.push(`  • Полное отсутствие переходящих тикетов: с ${L} (${D}) до 0 (${E})`))}}return S.length>0?S:["Недостаточно данных для анализа"]});function p(y,S){let C=[];switch(y){case"new":C=e.data.newTicketsByMonth||[];break;case"closed":C=e.data.closedTicketsByMonth||[];break;case"carryover":C=e.data.carryoverTicketsByMonth||[];break;default:return"-"}for(const k of C){if(!k.weeks||!Array.isArray(k.weeks))continue;const _=k.weeks.find(A=>A&&A.weekNumber===S);if(_){const A=_.count||0;return A>0?s(A):"-"}}return"-"}return(y,S)=>(c(),u("div",pv,[a("div",yv,[a("h3",kv,[S[0]||(S[0]=ce(" Новые и Закрытые тикеты ",-1)),d.value?(c(),u("span",bv,"("+m(d.value)+")",1)):$("",!0)]),a("div",_v,[a("div",wv,[ne(We(yt),{data:r.value,options:n},null,8,["data"])]),a("div",Cv,[S[3]||(S[3]=a("h4",{class:"summary-title"},"Сводный итог",-1)),a("div",Tv,[a("div",Sv,[S[1]||(S[1]=a("span",{class:"summary-label"},"Новые:",-1)),a("span",Dv,m(v.value.new),1)]),a("div",Ev,[S[2]||(S[2]=a("span",{class:"summary-label"},"Закрытые:",-1)),a("span",Av,m(v.value.closed),1)])]),a("div",$v,[(c(!0),u(ee,null,te(T.value,(C,k)=>(c(),u("p",{key:k,innerHTML:C},null,8,Iv))),128))])])])]),a("div",Mv,[a("h3",Nv,[S[4]||(S[4]=ce(" Переходящие тикеты ",-1)),g.value?(c(),u("span",xv,"("+m(g.value)+")",1)):$("",!0)]),a("div",Lv,[a("div",Pv,[ne(We(yt),{data:i.value,options:n},null,8,["data"])]),a("div",Ov,[S[5]||(S[5]=a("h4",{class:"analysis-title"},"Анализ",-1)),a("div",Bv,[(c(!0),u(ee,null,te(f.value,(C,k)=>(c(),u("p",{key:k,innerHTML:C},null,8,Rv))),128))])])])]),a("div",Wv,[S[10]||(S[10]=a("h3",{class:"chart-title"},"Детализация по месяцам и неделям",-1)),a("div",Uv,[a("table",Fv,[a("thead",null,[a("tr",null,[S[6]||(S[6]=a("th",{class:"month-header-cell"},"Месяц",-1)),(c(!0),u(ee,null,te(t.value,C=>(c(),u("th",{key:`week-${C}`,class:"week-header-cell"}," Неделя "+m(C),1))),128))])]),a("tbody",null,[a("tr",Hv,[S[7]||(S[7]=a("td",{class:"data-type-cell"},"Новые",-1)),(c(!0),u(ee,null,te(t.value,C=>(c(),u("td",{key:`new-${C}`,class:"week-data-cell"},m(p("new",C)),1))),128))]),a("tr",jv,[S[8]||(S[8]=a("td",{class:"data-type-cell"},"Закрытые",-1)),(c(!0),u(ee,null,te(t.value,C=>(c(),u("td",{key:`closed-${C}`,class:"week-data-cell"},m(p("closed",C)),1))),128))]),a("tr",zv,[S[9]||(S[9]=a("td",{class:"data-type-cell"},"Переходящие",-1)),(c(!0),u(ee,null,te(t.value,C=>(c(),u("td",{key:`carryover-${C}`,class:"week-data-cell"},m(p("carryover",C)),1))),128))])])])])])]))}},Gv=de(Vv,[["__scopeId","data-v-31a3d565"]]),Kv={class:"months-preloader"},qv={class:"preloader-content"},Yv={class:"progress-container"},Xv={class:"progress-bar"},Jv={class:"progress-text"},Zv={class:"preloader-message"},Qv={class:"stages-list"},ep={class:"stage-icon"},tp={class:"stage-text"},sp={__name:"MonthsModePreloader",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},currentStage:{type:String,default:""}},setup(o){const e=o,s=[{label:"Подготовка данных...",threshold:5},{label:"Загрузка данных за период (запрос 1)...",threshold:35},{label:"Загрузка данных за период (запрос 2)...",threshold:65},{label:"Загрузка данных за период (запрос 3)...",threshold:85},{label:"Агрегация данных...",threshold:90},{label:"Формирование графиков...",threshold:100}];function t(i){return e.progress>=s[i].threshold}function r(i){const n=s[i].threshold,l=i>0?s[i-1].threshold:0;return e.progress>=l&&e.progress<n}return(i,n)=>(c(),u("div",Kv,[a("div",qv,[n[0]||(n[0]=_t('<div class="preloader-spinner" data-v-b571fe67><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div></div><h3 class="preloader-title" data-v-b571fe67>Загрузка данных за 3 месяца</h3>',2)),a("div",Yv,[a("div",Xv,[a("div",{class:"progress-fill",style:we({width:`${o.progress}%`})},null,4)]),a("div",Jv,m(Math.round(o.progress))+"%",1)]),a("p",Zv,m(o.currentStage),1),a("div",Qv,[(c(),u(ee,null,te(s,(l,d)=>a("div",{key:d,class:X(["stage-item",{"stage-completed":t(d),"stage-current":r(d)}])},[a("span",ep,m(t(d)?"✓":r(d)?"→":"○"),1),a("span",tp,m(l.label),1)],2)),64))])])]))}},ap=de(sp,[["__scopeId","data-v-b571fe67"]]),op={class:"ac-dashboard-months"},np={key:"content"},rp={class:"dashboard-header"},ip={class:"header-content"},lp={class:"breadcrumbs-row"},cp=["aria-label","aria-disabled","data-fallback","disabled"],dp={class:"breadcrumbs","aria-label":"Навигация"},up={class:"dashboard-layout"},gp={class:"filters-container"},mp={class:"chart-container"},hp={__name:"GraphAdmissionClosureMonthsDashboard",setup(o){const e=Xe(),s=I(!0),t=I(0),r=I("Подготовка данных..."),i=I(null),n=I(null),l=I({newTickets:0,closedTickets:0,carryoverTickets:0,newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[],previousPeriodData:{newTickets:null,closedTickets:null,carryoverTickets:null}}),d=I(!1),g=M(()=>typeof window>"u"?!1:window.history.length>1),v=M(()=>g.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),T={name:"dashboard-sector-1c"};function f(L){if(L?.preventDefault?.(),!d.value){d.value=!0;try{if(g.value){e.back();return}console.warn("GraphAdmissionClosureMonthsDashboard: fallback navigation to dashboard-sector-1c"),e.push(T)}finally{d.value=!1}}}const p=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),y=M(()=>{const L=p.value.customDateRange.startDate||p.value.customDateRange.endDate,B=p.value.employees.length===1&&p.value.employees.includes("all");return L||!B});async function S(L,B,U=500){const G=t.value,q=10,oe=(L-G)/q,Y=U/q;for(let H=0;H<q;H++)await new Promise(Z=>setTimeout(Z,Y)),t.value=Math.min(G+oe*(H+1),L);t.value=L,r.value=B}async function C(){console.log("[DEBUG MonthsDashboard] loadData called"),console.log("[DEBUG MonthsDashboard] isLoading before:",s.value),s.value=!0,i.value=null,t.value=0,r.value="Подготовка данных...",console.log("[DEBUG MonthsDashboard] isLoading set to true");let L=null,B=null;try{console.log("[DEBUG MonthsDashboard] Starting API call"),await S(5,"Подготовка данных...",200);const U=Date.now(),G=2e4;L=setInterval(()=>{const H=Date.now()-U,Z=Math.min(5+H/G*85,90);t.value=Z,Z<35?r.value="Загрузка данных за период (запрос 1)...":Z<65?r.value="Загрузка данных за период (запрос 2)...":Z<85?r.value="Загрузка данных за период (запрос 3)...":r.value="Агрегация данных..."},500),B=setTimeout(()=>{L&&(clearInterval(L),L=null)},G+1e4);const q=await Ut({product:"1C",periodMode:"months",includeTickets:!0});clearTimeout(B),L&&(clearInterval(L),L=null),t.value=90,r.value="Агрегация данных завершена",await S(100,"Формирование графиков...",300),console.log("[DEBUG MonthsDashboard] API call successful, result:",q);const{meta:oe,data:Y}=q;n.value=oe,l.value=Y,console.log("[DEBUG MonthsDashboard] Data set, meta:",oe,"data keys:",Object.keys(Y)),await new Promise(H=>setTimeout(H,200))}catch(U){L&&(clearInterval(L),L=null),B&&(clearTimeout(B),B=null),console.error("[DEBUG MonthsDashboard] API call failed:",U),i.value=U instanceof Error?U:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureMonthsDashboard] loadData error:",U),t.value=100,r.value="Ошибка загрузки данных"}finally{console.log("[DEBUG MonthsDashboard] Finally block: setting isLoading to false"),s.value=!1,console.log("[DEBUG MonthsDashboard] isLoading after:",s.value)}}function k(L){p.value.stages=L}function _(L){p.value.employees=L}function A(L){p.value.dateRange=L}function W(L){p.value.customDateRange=L}function x(){p.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},D()}function D(){C()}function E(L){if(!["weeks","months"].includes(L)){console.warn("[GraphAdmissionClosureMonthsDashboard] Invalid periodMode:",L);return}L==="weeks"&&window.dispatchEvent(new CustomEvent("period-mode-change",{detail:{mode:L}}))}return $e(()=>{console.log("[DEBUG MonthsDashboard] onMounted called"),console.log("[DEBUG MonthsDashboard] isLoading before loadData:",s.value),C()}),(L,B)=>{const U=be("router-link");return c(),u("div",op,[ne(Ae,{name:"fade",mode:"out-in"},{default:pe(()=>[s.value?(c(),he(ap,{key:"preloader",progress:t.value,"current-stage":r.value},null,8,["progress","current-stage"])):(c(),u("div",np,[a("div",rp,[a("div",ip,[a("div",lp,[a("button",{class:"btn-back-link",type:"button",onClick:f,"aria-label":v.value,"aria-disabled":!g.value,"data-fallback":!g.value,disabled:d.value,title:"Назад"}," ← ",8,cp),a("nav",dp,[ne(U,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...B[0]||(B[0]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),B[2]||(B[2]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(U,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[...B[1]||(B[1]=[ce(" График состояния ",-1)])]),_:1}),B[3]||(B[3]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),B[4]||(B[4]=a("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),B[5]||(B[5]=a("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),B[6]||(B[6]=a("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),a("div",up,[a("div",gp,[ne(Fs,{stages:p.value.stages,employees:p.value.employees,dateRange:p.value.dateRange,customDateRange:p.value.customDateRange,hasActiveFilters:y.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":"months","onUpdate:stages":k,"onUpdate:employees":_,"onUpdate:dateRange":A,"onUpdate:customDateRange":W,"onUpdate:periodMode":E,onReset:x,onApply:D},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),a("div",mp,[i.value?(c(),he(ks,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),u(ee,{key:1},[ne(vv,{data:l.value},null,8,["data"]),ne(Gv,{data:l.value,meta:n.value},null,8,["data","meta"])],64))])])]))]),_:1})])}}},fp=de(hp,[["__scopeId","data-v-fe3ca7ed"]]);class hs{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const s=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",s);const t=await this.getEmployeesByIds(s);return console.log("Loaded employees:",t.length),{stages:this.groupTicketsByStages(e,t),employees:t,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],s=[];for(const t of e){console.log(`Loading tickets for stage: ${t}`);const r=await this.getTicketsByStage(t);s.push(...r),console.log(`Loaded ${r.length} tickets for stage ${t}`)}return s}static async getTicketsByStage(e){const s=[];let t=0;const r=50;let i=!0;for(;i;)try{const d=await new vt().call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:t,useOriginalUfNames:"Y"});let g=[];d&&d.result&&(Array.isArray(d.result)?g=d.result:d.result.items&&Array.isArray(d.result.items)?g=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(g=d.result.data)),g.length>0?(s.push(...g),t+=g.length,i=g.length===r):i=!1}catch(l){console.error(`Error loading tickets batch for stage ${e} (start: ${t}):`,l),i=!1}s.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(s[0],null,2)),console.log("Sample ticket keys:",Object.keys(s[0])),console.log("Sample ticket assignedById variants:",{assignedById:s[0].assignedById,assignedByIdId:s[0].assignedByIdId,ASSIGNED_BY_ID:s[0].ASSIGNED_BY_ID}));const n=s.filter(l=>{const d=l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product||l.ufCrm7TypeProduct||l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product;return Array.isArray(d)?d.includes(this.SECTOR_TAG):typeof d=="object"&&d!==null?d.value===this.SECTOR_TAG||d===this.SECTOR_TAG:d===this.SECTOR_TAG});return console.log(`Filtered ${n.length} tickets from ${s.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),n}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const s=new Set;return e.forEach(t=>{const r=t.assignedById||t.assignedByIdId||t.ASSIGNED_BY_ID||t.assignedById||t.assignedById&&typeof t.assignedById=="object"&&(t.assignedById.id||t.assignedById.ID)||t.assignedById&&typeof t.assignedById=="object"&&t.assignedById.value;if(r){const i=parseInt(r);i&&!isNaN(i)&&i>0&&s.add(i)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(s))),Array.from(s)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await new vt().call("user.get",{filter:{ID:e}});let r=[];return t&&t.result&&(Array.isArray(t.result)?r=t.result:console.warn("Unexpected user.get result format:",t)),r.map(i=>({id:parseInt(i.ID||i.id||0),name:`${i.NAME||i.name||""} ${i.LAST_NAME||i.lastName||""}`.trim()||i.EMAIL||i.email||"Неизвестный",position:i.WORK_POSITION||i.workPosition||"Сотрудник",email:i.EMAIL||i.email||"",tickets:[]}))}catch(s){return console.error("Error getting employees by IDs:",s),[]}}static groupTicketsByStages(e,s){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(s)||(console.warn("Employees is not an array:",s),s=[]);const t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:s.map(r=>({...r,tickets:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:s.map(r=>({...r,tickets:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:s.map(r=>({...r,tickets:[]}))}];return e.forEach(r=>{const i=this.mapStageId(r.stageId||r.STAGE_ID||""),n=t.find(l=>l.id===i);if(n){const l=r.assignedById||r.ASSIGNED_BY_ID||null,d=l?parseInt(l):null;if(d){let g=n.employees.find(v=>v.id===d);g||(g={id:d,name:`Сотрудник #${d}`,position:"Неизвестно",email:"",tickets:[]},n.employees.push(g)),g.tickets.push(this.mapTicket(r))}}}),t}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const s=parseInt(e.id||e.ID||0),t=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",i=e.assignedById||e.ASSIGNED_BY_ID||null,n=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",l=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",d=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,g=xs(d),v=ka(g);return{id:s,title:t,priorityId:g.id,priorityLabel:g.label,priorityColors:v,priority:g.id,priorityBitrixValue:g.bitrixValue||null,status:this.mapStatus(r),assigneeId:i?parseInt(i):null,stageId:this.mapStageId(r),createdAt:n,modifiedAt:l,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return xs(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const s=ea(e);if(s&&s.bitrixValue)return s.bitrixValue;const t={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return t[e]?t[e]:ea(_o).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const s={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(t=>!(t.assignedById||t.ASSIGNED_BY_ID)).forEach(t=>{const r=this.mapStageId(t.stageId||t.STAGE_ID||"");s[r]&&s[r].push(this.mapTicket(t))}),s):(console.warn("Tickets is not an array in getZeroPointTickets:",e),s)}static async assignTicket(e,s,t){try{const r=this.mapStageIdToBitrix(t);return(await new vt().call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:s,stageId:r}})).result===!0}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(e){try{const t=await new vt().call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(s){throw console.error("Error creating ticket:",s),s}}static async getTicket(e){try{const t=await new vt().call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(s){throw console.error("Error getting ticket:",s),s}}static async addComment(e,s){try{return(await new vt().call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:s}})).result!==void 0}catch(t){throw console.error("Error adding comment:",t),t}}}je(hs,"ENTITY_TYPE_ID",140),je(hs,"SECTOR_TAG","1C");const vp=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:hs},Symbol.toStringTag,{value:"Module"}));function pp(o){if(!o)return null;try{const e=new Date(o);return isNaN(e.getTime())?null:e}catch{return console.warn("Invalid date format:",o),null}}function yp(o,e){return Math.floor((o-e)/864e5)}function kp(o){return!o||isNaN(o.getTime())?!1:o<=new Date}const lt={ONE_MONTH:"one_month",TWO_MONTHS:"two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},Rt={[lt.ONE_MONTH]:"Один месяц",[lt.TWO_MONTHS]:"Два месяца",[lt.MORE_THAN_HALF_YEAR]:"Более полугода",[lt.MORE_THAN_YEAR]:"Более года"},oa={[lt.ONE_MONTH]:30,[lt.TWO_MONTHS]:60,[lt.MORE_THAN_HALF_YEAR]:180,[lt.MORE_THAN_YEAR]:365};function fs(o,e,s=new Date){if(!Array.isArray(o))return console.warn("filterTicketsByTimePeriod: tickets must be an array"),[];if(!oa[e])return console.warn(`filterTicketsByTimePeriod: Unknown period "${e}"`),o;const t=oa[e],r=e.includes("more_than");return o.filter(i=>{try{if(!i||!i.id||!i.created_at)return console.warn("Ticket missing required fields:",i),!1;const n=pp(i.created_at);if(!n)return console.warn(`Invalid date for ticket ${i.id}: ${i.created_at}`),!1;if(!kp(n))return console.warn(`Future or invalid date for ticket ${i.id}: ${i.created_at}`),!1;const l=yp(s,n);return r?l>t:l<=t}catch(n){return console.error(`Error filtering ticket ${i?.id||"unknown"}:`,n),!1}})}const bp={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},_p={class:"modal"},wp={key:0,class:"modal__tabs"},Cp={key:"level-0-categories",class:"level-0"},Tp={class:"modal__header"},Sp={class:"modal__title"},Dp={key:0},Ep={class:"modal__body"},Ap={class:"categories-list"},$p=["onClick"],Ip={class:"category-item"},Mp={class:"category-item__icon"},Np={key:0},xp={key:1},Lp={class:"category-item__content"},Pp={class:"category-item__label"},Op={class:"category-item__count"},Bp={key:0,class:"category-item__arrow"},Rp={class:"modal__footer"},Wp={key:"level-1-categories",class:"level-1"},Up={class:"modal__header"},Fp={class:"modal__body"},Hp={key:"loading",class:"loading-names"},jp={key:"empty",class:"modal__empty"},zp={key:"list",class:"responsible-list"},Vp=["onClick"],Gp={class:"responsible-list__name"},Kp={class:"responsible-list__count"},qp={key:0,class:"responsible-list__arrow"},Yp={class:"modal__footer"},Xp={key:"level-2-categories",class:"level-2"},Jp={class:"modal__header"},Zp={class:"modal__title"},Qp={class:"modal__body"},ey={class:"time-sort-controls"},ty={class:"time-sort-buttons"},sy=["onClick"],ay={class:"count"},oy={key:"loading",class:"loading-state"},ny={key:"error",class:"error-state"},ry={class:"error-message"},iy={key:"empty",class:"empty-state"},ly={class:"empty-state-message"},cy={key:"tickets",class:"tickets-list-container"},dy={key:"level-0-employees",class:"level-0"},uy={class:"modal__header"},gy={class:"modal__title"},my={key:0},hy={class:"modal__body"},fy={key:"loading",class:"loading-names"},vy={key:"empty",class:"modal__empty"},py={key:"list",class:"responsible-list"},yy=["onClick"],ky={class:"responsible-list__name"},by={class:"responsible-list__count"},_y={key:0,class:"responsible-list__arrow"},wy={class:"modal__footer"},Cy={key:"level-1-employees",class:"level-1"},Ty={class:"modal__header"},Sy={class:"modal__title"},Dy={class:"modal__body"},Ey={class:"categories-list"},Ay=["onClick"],$y={class:"category-item"},Iy={class:"category-item__icon"},My={key:0},Ny={key:1},xy={class:"category-item__content"},Ly={class:"category-item__label"},Py={class:"category-item__count"},Oy={key:0,class:"category-item__arrow"},By={class:"modal__footer"},Ry={key:"level-2-employees",class:"level-2"},Wy={class:"modal__header"},Uy={class:"modal__title"},Fy={class:"modal__body"},Hy={key:"loading",class:"loading-state"},jy={key:"error",class:"error-state"},zy={class:"error-message"},Vy={key:"empty",class:"empty-state"},Gy={class:"empty-state-message"},Ky={key:"tickets",class:"tickets-list-container"},qy={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]},closedTicketsCreatedThisWeek:{type:Number,default:0},closedTicketsCreatedOtherWeek:{type:Number,default:0},responsibleCreatedThisWeek:{type:Array,default:()=>[]},responsibleCreatedOtherWeek:{type:Array,default:()=>[]},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},setup(o){const e=o,s=I(0),t=I("categories"),r=I(null),i=I(null),n=I(null),l=I([]),d=I(!1),g=I(null),v=I([]),T=I([]),f=I(!1),p=I(lt.ONE_MONTH),y=M(()=>[{id:"created-this-week",label:"Тикеты закрытые этой неделью и созданные этой неделью",count:e.closedTicketsCreatedThisWeek??0,responsible:e.responsibleCreatedThisWeek??[]},{id:"created-other-week",label:"Тикеты закрытые этой неделью и созданные ранее",count:e.closedTicketsCreatedOtherWeek??0,responsible:e.responsibleCreatedOtherWeek??[]}]),S=M(()=>{const P=new Map;return(e.responsibleCreatedThisWeek||[]).forEach(h=>{const w=h.id??"unassigned";P.has(w)||P.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const R=P.get(w);R.thisWeekCount=h.count??0,R.thisWeekTickets=h.tickets||[],R.totalCount+=R.thisWeekCount}),(e.responsibleCreatedOtherWeek||[]).forEach(h=>{const w=h.id??"unassigned";P.has(w)||P.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const R=P.get(w);R.otherWeekCount=h.count??0,R.otherWeekTickets=h.tickets||[],R.totalCount+=R.otherWeekCount}),Array.from(P.values())}),C=M(()=>{if(!i.value)return[];const P=i.value.thisWeekTickets||[],h=i.value.otherWeekTickets||[];return console.log("[ResponsibleModal] Computing gradations for employee:",{id:i.value.id,name:i.value.name,thisWeekCount:i.value.thisWeekCount,otherWeekCount:i.value.otherWeekCount,thisWeekTickets:P.length,otherWeekTickets:h.length,employee:i.value}),[{id:"this-week",label:"На этой неделе",count:i.value.thisWeekCount??0,tickets:P,employeeId:i.value.id},{id:"other-week",label:"На другой неделе",count:i.value.otherWeekCount??0,tickets:h,employeeId:i.value.id}]}),k=M(()=>(T.value||[]).length>0),_=M(()=>{if(!l.value||l.value.length===0)return[];try{const P=performance.now(),h=fs(l.value,p.value),w=performance.now();return console.log(`[ResponsibleModal] Filtering took ${(w-P).toFixed(2)}ms, results: ${h.length}`),h}catch(P){return console.error("[ResponsibleModal] Error filtering tickets:",P),[]}}),A=M(()=>Object.keys(Rt).map(P=>({key:P,label:Rt[P],count:fs(l.value,P).length})));async function W(P){const h=P.filter(w=>w.id!==null&&w.id!==void 0).map(w=>w.id);if(h.length===0)return P;try{const w=await hs.getEmployeesByIds(h),R=new Map;return w.forEach(re=>{R.set(re.id,re.name)}),P.map(re=>re.id&&R.has(re.id)?{...re,name:R.get(re.id)}:re)}catch(w){return console.error("[ResponsibleModal] Error enriching names:",w),P}}Ne([()=>t.value,()=>S.value],async([P,h])=>{if(!(P!=="employees"||s.value!==0)){if(!h||h.length===0){T.value=[];return}f.value=!0;try{T.value=await W(h)}catch(w){console.error("[ResponsibleModal] Error loading employee names:",w),T.value=h}finally{f.value=!1}}},{immediate:!0}),Ne(()=>e.responsible,async P=>{if(!(s.value!==0||r.value||t.value!=="categories")){if(!P||P.length===0){v.value=[];return}f.value=!0;try{v.value=await W(P)}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=P}finally{f.value=!1}}},{immediate:!1});const x=M(()=>(v.value||[]).length>0);function D(P){t.value!==P&&(t.value=P,s.value=0,r.value=null,i.value=null,n.value=null,l.value=[],g.value=null,v.value=[],T.value=[])}async function E(P){if(!P||P.count===0){console.warn("[ResponsibleModal] handleCategoryClick: Invalid category or count is 0",{category:P,count:P?.count});return}console.log("[ResponsibleModal] handleCategoryClick called:",{categoryId:P.id,categoryLabel:P.label,categoryCount:P.count,responsibleCount:P.responsible?.length||0,responsibleWithTickets:P.responsible?.filter(h=>h.tickets&&h.tickets.length>0).length||0,responsibleSample:P.responsible?.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))}),r.value=P,s.value=1,f.value=!0;try{v.value=await W(P.responsible),console.log("[ResponsibleModal] After enrichResponsibleWithNames:",{enrichedCount:v.value.length,enrichedSample:v.value.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))})}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=P.responsible}finally{f.value=!1}}async function L(P,h=null){!P||!P.id||P.totalCount===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),console.log("[ResponsibleModal] Employee selected from list:",{id:P.id,name:P.name,thisWeekCount:P.thisWeekCount,otherWeekCount:P.otherWeekCount,thisWeekTickets:P.thisWeekTickets?.length||0,otherWeekTickets:P.otherWeekTickets?.length||0,employee:P}),i.value={...P,thisWeekTickets:P.thisWeekTickets||[],otherWeekTickets:P.otherWeekTickets||[]},s.value=1)}async function B(P){if(!P||P.count===0)return;n.value=P,s.value=2;const h=P.tickets||[];console.log("[ResponsibleModal] Gradation clicked:",{id:P.id,label:P.label,count:P.count,ticketsInGradation:h.length,selectedEmployee:i.value?.id}),h.length>0?(console.log("[ResponsibleModal] Loading tickets from gradation:",h.length),await U(h)):(console.log("[ResponsibleModal] Tickets not in gradation, loading from API"),await G(P))}async function U(P){d.value=!0,g.value=null;try{try{const{prepareTicketsForDisplay:h}=await Ee(async()=>{const{prepareTicketsForDisplay:w}=await import("./chunk-BBmTsmYU.js").then(R=>R.t);return{prepareTicketsForDisplay:w}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await h(P,null,null)}catch(h){console.error("[ResponsibleModal] Error preparing tickets:",h),l.value=P}l.value.length===0&&(g.value=null)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),l.value=[]}finally{d.value=!1}}async function G(P){d.value=!0,g.value=null;try{if(!e.weekStartUtc||!e.weekEndUtc||!i.value)throw new Error("Не указаны границы недели или выбранный сотрудник");const h=await Ut({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0}),re=(P.id==="this-week"?h.data.responsibleCreatedThisWeek:h.data.responsibleCreatedOtherWeek)?.find(le=>le.id===i.value.id)?.tickets||[];try{const{prepareTicketsForDisplay:le}=await Ee(async()=>{const{prepareTicketsForDisplay:ae}=await import("./chunk-BBmTsmYU.js").then(me=>me.t);return{prepareTicketsForDisplay:ae}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await le(re,null,null)}catch(le){console.error("[ResponsibleModal] Error preparing tickets:",le),l.value=re}l.value.length===0&&(g.value=null)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets from API:",h),l.value=[]}finally{d.value=!1}}async function q(P,h=null){!P||!P.id||P.count===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),i.value=P,s.value=2,await oe(P.id))}async function oe(P){d.value=!0,g.value=null;try{let h=[];if(console.log("[ResponsibleModal] loadEmployeeTickets called:",{employeeId:P,selectedCategory:r.value?.id,hasSelectedCategory:!!r.value,hasResponsible:!!r.value?.responsible,responsibleCount:r.value?.responsible?.length||0,categoryData:r.value?{id:r.value.id,label:r.value.label,count:r.value.count,responsibleSample:r.value.responsible?.slice(0,2).map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0}))}:null}),r.value&&r.value.responsible){const w=r.value.responsible.find(R=>R.id===P);console.log("[ResponsibleModal] Employee found in category:",{employee:w,hasTickets:!!w?.tickets,ticketsCount:w?.tickets?.length||0,tickets:w?.tickets?w.tickets.slice(0,2):null}),h=w?.tickets||[]}if(h.length===0&&e.weekStartUtc&&e.weekEndUtc){console.log("[ResponsibleModal] Tickets not found in category, loading from API",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,categoryId:r.value?.id});const w=await Ut({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0});console.log("[ResponsibleModal] API response:",{hasResponsibleCreatedThisWeek:!!w.data.responsibleCreatedThisWeek,hasResponsibleCreatedOtherWeek:!!w.data.responsibleCreatedOtherWeek,thisWeekCount:w.data.responsibleCreatedThisWeek?.length||0,otherWeekCount:w.data.responsibleCreatedOtherWeek?.length||0,thisWeekSample:w.data.responsibleCreatedThisWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0})),otherWeekSample:w.data.responsibleCreatedOtherWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const R=r.value?.id==="created-this-week"?w.data.responsibleCreatedThisWeek:w.data.responsibleCreatedOtherWeek;console.log("[ResponsibleModal] Category data:",{categoryId:r.value?.id,categoryDataCount:R?.length||0,categoryDataSample:R?.slice(0,2).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const re=R?.find(le=>le.id===P);console.log("[ResponsibleModal] Employee found in API response:",{employee:re?{id:re.id,name:re.name,count:re.count,hasTickets:!!re.tickets,ticketsCount:re.tickets?.length||0,ticketsSample:re.tickets?.slice(0,2)}:null}),h=re?.tickets||[]}console.log("[ResponsibleModal] Final employeeTickets before prepareTicketsForDisplay:",{ticketsCount:h.length,ticketsSample:h.slice(0,2).map(w=>({id:w.id,title:w.title||w.ufSubject||"No title",stageId:w.stageId}))});try{const{prepareTicketsForDisplay:w}=await Ee(async()=>{const{prepareTicketsForDisplay:R}=await import("./chunk-BBmTsmYU.js").then(re=>re.t);return{prepareTicketsForDisplay:R}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await w(h,null,null),console.log("[ResponsibleModal] Tickets after prepareTicketsForDisplay:",{ticketsCount:l.value.length,ticketsSample:l.value.slice(0,2).map(R=>({id:R.id,title:R.title||R.ufSubject||"No title",stageId:R.stageId}))})}catch(w){console.error("[ResponsibleModal] Error preparing tickets:",w),console.error("[ResponsibleModal] prepareError details:",{message:w.message,stack:w.stack,employeeTicketsCount:h.length}),l.value=h,console.log("[ResponsibleModal] Using fallback tickets (without enrichment):",l.value.length)}l.value.length===0?(console.warn("[ResponsibleModal] No tickets after loading and preparation",{employeeId:P,categoryId:r.value?.id,employeeTicketsCount:h.length,finalTicketsCount:l.value.length}),g.value=null):console.log("[ResponsibleModal] Successfully loaded tickets:",l.value.length)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),console.error("[ResponsibleModal] Error details:",{message:h.message,stack:h.stack,employeeId:P,categoryId:r.value?.id}),l.value=[]}finally{d.value=!1}}function Y(){s.value===2?(s.value=1,t.value==="categories"?i.value=null:n.value=null,l.value=[],g.value=null):s.value===1&&(s.value=0,t.value==="categories"?(r.value=null,v.value=[]):i.value=null)}function H(P){console.log(`[ResponsibleModal] Sort mode changed: ${p.value} -> ${P}`);const h=performance.now();p.value=P,setTimeout(()=>{const w=_.value,R=performance.now();console.log(`[ResponsibleModal] Filtering completed in ${(R-h).toFixed(2)}ms, ${w.length} tickets shown`)},0)}function Z(P){const h=es(P.id);window.open(h,"_blank")}function fe(){t.value==="employees"&&n.value?U(n.value.tickets):t.value==="categories"&&i.value&&oe(i.value.id)}return Ne(()=>e.isVisible,P=>{if(P){console.log("[TASK-070] ResponsibleModal opened for week",e.weekNumber),console.log("[TASK-070] ResponsibleModal props types:",{responsibleCreatedThisWeekType:typeof e.responsibleCreatedThisWeek,responsibleCreatedThisWeekIsArray:Array.isArray(e.responsibleCreatedThisWeek),responsibleCreatedThisWeekLength:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:"not array",responsibleCreatedOtherWeekType:typeof e.responsibleCreatedOtherWeek,responsibleCreatedOtherWeekIsArray:Array.isArray(e.responsibleCreatedOtherWeek),responsibleCreatedOtherWeekLength:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:"not array"}),console.log("[TASK-070] ResponsibleModal data:",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,responsibleCreatedThisWeek:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:e.responsibleCreatedThisWeek?"not array":"null/undefined",responsibleCreatedOtherWeek:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:e.responsibleCreatedOtherWeek?"not array":"null/undefined",closedTicketsCreatedThisWeek:e.closedTicketsCreatedThisWeek,closedTicketsCreatedOtherWeek:e.closedTicketsCreatedOtherWeek}),console.log("[TASK-070] ResponsibleModal detailed data:",{responsibleCreatedThisWeek:e.responsibleCreatedThisWeek,responsibleCreatedOtherWeek:e.responsibleCreatedOtherWeek,responsibleCreatedThisWeekWithTickets:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null",responsibleCreatedOtherWeekWithTickets:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null"});const h=e.weekNumber;h&&console.log("[TASK-070] ResponsibleModal: Week number",h)}else s.value=0,t.value="categories",r.value=null,i.value=null,n.value=null,l.value=[],g.value=null,v.value=[],T.value=[]}),(P,h)=>o.isVisible?(c(),u("div",bp,[a("div",_p,[s.value===0?(c(),u("div",wp,[a("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="categories"}]),onClick:h[0]||(h[0]=w=>D("categories"))}," По категориям ",2),a("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="employees"}]),onClick:h[1]||(h[1]=w=>D("employees"))}," По сотрудникам ",2)])):$("",!0),ne(Ae,{name:"level",mode:"out-in"},{default:pe(()=>[t.value==="categories"&&s.value===0?(c(),u("div",Cp,[a("header",Tp,[a("h3",Sp,[h[12]||(h[12]=ce(" Закрытые за неделю",-1)),o.weekNumber?(c(),u("span",Dp," · Неделя "+m(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:h[2]||(h[2]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Ep,[a("ul",Ap,[(c(!0),u(ee,null,te(y.value,w=>(c(),u("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:R=>E(w)},[a("div",Ip,[a("div",Mp,[w.id==="created-this-week"?(c(),u("span",Np,"✓")):(c(),u("span",xp,"↻"))]),a("div",Lp,[a("div",Pp,m(w.label),1),a("div",Op,m(w.count)+" тикетов",1)]),w.count>0?(c(),u("span",Bp,"→")):$("",!0)])],10,$p))),128))])]),a("footer",Rp,[a("button",{class:"btn",onClick:h[3]||(h[3]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="categories"&&s.value===1?(c(),u("div",Wp,[a("header",Up,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),h[13]||(h[13]=a("h3",{class:"modal__title"},"Ответственные за неделю",-1)),a("button",{class:"modal__close",onClick:h[4]||(h[4]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Fp,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[f.value?(c(),u("div",Hp,[...h[14]||(h[14]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка имён сотрудников...",-1)])])):x.value?(c(),u("ul",zp,[(c(!0),u(ee,null,te(v.value,w=>(c(),u("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.count>0}]),onClick:R=>q(w,R),title:"Кликните для просмотра тикетов сотрудника"},[a("span",Gp,m(w.name||"Не назначен"),1),a("span",Kp,m(w.count??0)+" тикетов ",1),w.id&&w.count>0?(c(),u("span",qp,"→")):$("",!0)],10,Vp))),128))])):(c(),u("p",jp,"Нет данных по ответственным"))]),_:1})]),a("footer",Yp,[a("button",{class:"btn",onClick:h[5]||(h[5]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="categories"&&s.value===2?(c(),u("div",Xp,[a("header",Jp,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",Zp,"Тикеты сотрудника: "+m(i.value?.name||"Неизвестно"),1),a("button",{class:"modal__close",onClick:h[6]||(h[6]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Qp,[a("div",ey,[h[15]||(h[15]=a("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),a("div",ty,[(c(!0),u(ee,null,te(A.value,w=>(c(),u("button",{key:w.key,class:X(["time-sort-btn",{active:p.value===w.key}]),onClick:R=>H(w.key)},[ce(m(w.label)+" ",1),a("span",ay,"("+m(w.count)+")",1)],10,sy))),128))])]),ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[d.value?(c(),u("div",oy,[...h[16]||(h[16]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):g.value?(c(),u("div",ny,[h[17]||(h[17]=a("div",{class:"error-icon"},"⚠️",-1)),h[18]||(h[18]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",ry,m(g.value),1),a("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):_.value.length===0?(c(),u("div",iy,[h[19]||(h[19]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",ly," У сотрудника нет тикетов за выбранный период ("+m(We(Rt)[p.value])+") ",1)])):(c(),u("div",cy,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(_.value,(w,R)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":R}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):t.value==="employees"&&s.value===0?(c(),u("div",dy,[a("header",uy,[a("h3",gy,[h[20]||(h[20]=ce(" Закрытые за неделю",-1)),o.weekNumber?(c(),u("span",my," · Неделя "+m(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:h[7]||(h[7]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",hy,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[f.value?(c(),u("div",fy,[...h[21]||(h[21]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка имён сотрудников...",-1)])])):k.value?(c(),u("ul",py,[(c(!0),u(ee,null,te(T.value,w=>(c(),u("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.totalCount>0}]),onClick:R=>L(w,R),title:"Кликните для просмотра градации тикетов сотрудника"},[a("span",ky,m(w.name||"Не назначен"),1),a("span",by,m(w.totalCount??0)+" тикетов ",1),w.id&&w.totalCount>0?(c(),u("span",_y,"→")):$("",!0)],10,yy))),128))])):(c(),u("p",vy,"Нет данных по сотрудникам"))]),_:1})]),a("footer",wy,[a("button",{class:"btn",onClick:h[8]||(h[8]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="employees"&&s.value===1?(c(),u("div",Cy,[a("header",Ty,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",Sy,"Тикеты сотрудника: "+m(i.value?.name||"Неизвестно"),1),a("button",{class:"modal__close",onClick:h[9]||(h[9]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Dy,[a("ul",Ey,[(c(!0),u(ee,null,te(C.value,w=>(c(),u("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:R=>B(w)},[a("div",$y,[a("div",Iy,[w.id==="this-week"?(c(),u("span",My,"✓")):(c(),u("span",Ny,"↻"))]),a("div",xy,[a("div",Ly,m(w.label),1),a("div",Py,m(w.count)+" тикетов",1)]),w.count>0?(c(),u("span",Oy,"→")):$("",!0)])],10,Ay))),128))])]),a("footer",By,[a("button",{class:"btn",onClick:h[10]||(h[10]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="employees"&&s.value===2?(c(),u("div",Ry,[a("header",Wy,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",Uy," Тикеты сотрудника: "+m(i.value?.name||"Неизвестно")+" ("+m(n.value?.label||"")+") ",1),a("button",{class:"modal__close",onClick:h[11]||(h[11]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Fy,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[d.value?(c(),u("div",Hy,[...h[22]||(h[22]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):g.value?(c(),u("div",jy,[h[23]||(h[23]=a("div",{class:"error-icon"},"⚠️",-1)),h[24]||(h[24]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",zy,m(g.value),1),a("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):l.value.length===0?(c(),u("div",Vy,[h[25]||(h[25]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",Gy,m(t.value==="employees"?`У сотрудника нет тикетов в категории "${n.value?.label||""}"`:"У сотрудника нет закрытых тикетов за выбранную неделю"),1)])):(c(),u("div",Ky,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(_.value,(w,R)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":R}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Yy=de(qy,[["__scopeId","data-v-6f43202a"]]),Xy={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Jy={class:"modal"},Zy={key:"level-1",class:"level-1"},Qy={class:"modal__header"},ek={class:"modal__title"},tk={key:0},sk={class:"modal__body"},ak={key:"loading",class:"loading-names"},ok={key:"empty",class:"modal__empty"},nk={key:"list",class:"stages-list"},rk=["onClick"],ik={class:"stages-list__name"},lk={class:"stages-list__count"},ck={key:0,class:"stages-list__arrow"},dk={class:"modal__footer"},uk={key:"level-2",class:"level-2"},gk={class:"modal__header"},mk={class:"modal__title"},hk={class:"modal__body"},fk={class:"time-sort-controls"},vk={class:"time-sort-buttons"},pk=["onClick"],yk={class:"count"},kk={key:"loading",class:"loading-state"},bk={key:"error",class:"error-state"},_k={class:"error-message"},wk={key:"empty",class:"empty-state"},Ck={class:"empty-state-message"},Tk={key:"tickets",class:"tickets-list-container"},Sk={__name:"StagesModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=I(1),r=I(null),i=I([]),n=I(!1),l=I(!1),d=I(null),g=I([]),v=I(lt.ONE_MONTH),T=M(()=>g.value.length>0&&g.value.some(x=>x.count>0)),f=M(()=>{if(!i.value||i.value.length===0)return[];try{const x=performance.now(),D=fs(i.value,v.value),E=performance.now();return console.log(`[StagesModal] Filtering took ${(E-x).toFixed(2)}ms, results: ${D.length}`),D}catch(x){return console.error("[StagesModal] Error filtering tickets:",x),[]}}),p=M(()=>Object.keys(Rt).map(x=>({key:x,label:Rt[x],count:fs(i.value,x).length})));async function y(){if(console.log("[TASK-070] StagesModal: loadStages called",{weekNumber:s.weekNumber,weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc}),!s.weekStartUtc||!s.weekEndUtc){console.warn("[TASK-070] StagesModal: Missing week boundaries, cannot load stages"),g.value=[];return}l.value=!0,d.value=null;try{console.log("[TASK-070] StagesModal: Fetching stages from API...");const x=await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeNewTicketsByStages:!0});console.log("[TASK-070] StagesModal: API response received",{hasNewTicketsByStages:!!x.data.newTicketsByStages,stagesCount:x.data.newTicketsByStages?.length||0}),g.value=x.data.newTicketsByStages||[],g.value.length===0?console.warn("[TASK-070] StagesModal: API returned empty stages array for week",s.weekNumber):console.log("[TASK-070] StagesModal: Stages loaded successfully",g.value.length,"stages")}catch(x){d.value=x.message||"Ошибка загрузки стадий",console.error("[TASK-070] StagesModal: Error loading stages:",x),g.value=[]}finally{l.value=!1}}async function S(x,D=null){!x||x.count===0||(D&&D.currentTarget&&(D.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{D.currentTarget&&(D.currentTarget.style.transform="")},150)),r.value=x,t.value=2,await C(x.stageId))}async function C(x){n.value=!0,d.value=null;try{const D=g.value.find(U=>U.stageId===x);if(D&&Array.isArray(D.tickets)&&D.tickets.length>0){console.log("[TASK-070] StagesModal: Using preloaded tickets for stage",x,"count:",D.tickets.length);const U=D.tickets;try{const{prepareTicketsForDisplay:G}=await Ee(async()=>{const{prepareTicketsForDisplay:q}=await import("./chunk-BBmTsmYU.js").then(oe=>oe.t);return{prepareTicketsForDisplay:q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await G(U,null,null)}catch(G){console.error("[TASK-070] StagesModal: Error preparing tickets:",G),i.value=U}n.value=!1;return}if(console.log("[TASK-070] StagesModal: Tickets not preloaded, loading from API for stage",x),!s.weekStartUtc||!s.weekEndUtc)throw new Error("Не указаны границы недели");const B=(await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeNewTicketsByStages:!0,includeTickets:!0})).data.newTicketsByStages?.find(U=>U.stageId===x)?.tickets||[];try{const{prepareTicketsForDisplay:U}=await Ee(async()=>{const{prepareTicketsForDisplay:G}=await import("./chunk-BBmTsmYU.js").then(q=>q.t);return{prepareTicketsForDisplay:G}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await U(B,null,null)}catch(U){console.error("[StagesModal] Error preparing tickets:",U),i.value=B}i.value.length===0&&(d.value=null)}catch(D){d.value=D.message||"Ошибка загрузки тикетов",console.error("[StagesModal] Error loading tickets:",D),i.value=[]}finally{n.value=!1}}function k(){t.value=1,r.value=null,i.value=[],d.value=null}function _(x){const D=es(x.id);window.open(D,"_blank")}function A(){r.value&&C(r.value.stageId)}function W(x){console.log(`[StagesModal] Sort mode changed: ${v.value} -> ${x}`);const D=performance.now();v.value=x,setTimeout(()=>{const E=f.value,L=performance.now();console.log(`[StagesModal] Filtering completed in ${(L-D).toFixed(2)}ms, ${E.length} tickets shown`)},0)}return Ne(()=>s.isVisible,async x=>{x?(t.value=1,r.value=null,i.value=[],d.value=null,console.log("[TASK-070] StagesModal opened:",{weekNumber:s.weekNumber,weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,preloadedData:s.preloadedData?Array.isArray(s.preloadedData)?`Array(${s.preloadedData.length})`:typeof s.preloadedData:"null"}),s.preloadedData&&Array.isArray(s.preloadedData)&&s.preloadedData.length>0?(console.log("[TASK-070] StagesModal: Using preloaded data, stages count:",s.preloadedData.length),s.preloadedData.every(E=>E.stageId&&E.stageName&&typeof E.count=="number")?(g.value=s.preloadedData,l.value=!1,console.log("[TASK-070] StagesModal: Preloaded data set, stages:",g.value.length)):(console.warn("[TASK-070] StagesModal: Invalid preloaded data structure, falling back to API"),await y())):(console.log("[TASK-070] StagesModal: No preloaded data, loading from API",{weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc}),await y())):(t.value=1,r.value=null,i.value=[],d.value=null,g.value=[])},{immediate:!1}),Ne([()=>s.weekNumber,()=>s.preloadedData],async([x,D])=>{s.isVisible&&x&&(D&&Array.isArray(D)&&D.length>0?D.every(L=>L.stageId&&L.stageName&&typeof L.count=="number")?(console.log("[TASK-070] StagesModal: Week changed, updating with preloaded data for week",x),g.value=D,l.value=!1):(console.log("[TASK-070] StagesModal: Week changed, invalid preloaded data, loading from API for week",x),await y()):(console.log("[TASK-070] StagesModal: Week changed, loading from API for week",x),await y()))}),(x,D)=>o.isVisible?(c(),u("div",Xy,[a("div",Jy,[ne(Ae,{name:"level",mode:"out-in"},{default:pe(()=>[t.value===1?(c(),u("div",Zy,[a("header",Qy,[a("h3",ek,[D[3]||(D[3]=ce(" Новые тикеты по стадиям",-1)),o.weekNumber?(c(),u("span",tk," · Неделя "+m(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:D[0]||(D[0]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",sk,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[l.value?(c(),u("div",ak,[...D[4]||(D[4]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка стадий...",-1)])])):T.value?(c(),u("ul",nk,[(c(!0),u(ee,null,te(g.value,E=>(c(),u("li",{key:E.stageId,class:X(["stages-list__item",{"stages-list__item--clickable":E.count>0}]),style:we({"--stage-color":E.color}),onClick:L=>S(E,L),title:"Кликните для просмотра тикетов стадии"},[a("span",{class:"stages-list__color",style:we({backgroundColor:E.color})},null,4),a("span",ik,m(E.stageName),1),a("span",lk,m(E.count)+" тикетов ",1),E.count>0?(c(),u("span",ck,"→")):$("",!0)],14,rk))),128))])):(c(),u("p",ok," Нет новых тикетов за выбранную неделю "))]),_:1})]),a("footer",dk,[a("button",{class:"btn",onClick:D[1]||(D[1]=E=>x.$emit("close"))},"Закрыть")])])):t.value===2?(c(),u("div",uk,[a("header",gk,[a("button",{class:"btn-back",onClick:k,"aria-label":"Назад"},"← Назад"),a("h3",mk," Тикеты стадии: "+m(r.value?.stageName||"Неизвестно"),1),a("button",{class:"modal__close",onClick:D[2]||(D[2]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",hk,[a("div",fk,[D[5]||(D[5]=a("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),a("div",vk,[(c(!0),u(ee,null,te(p.value,E=>(c(),u("button",{key:E.key,class:X(["time-sort-btn",{active:v.value===E.key}]),onClick:L=>W(E.key)},[ce(m(E.label)+" ",1),a("span",yk,"("+m(E.count)+")",1)],10,pk))),128))])]),ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),u("div",kk,[...D[6]||(D[6]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов стадии...",-1),a("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):d.value?(c(),u("div",bk,[D[7]||(D[7]=a("div",{class:"error-icon"},"⚠️",-1)),D[8]||(D[8]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",_k,m(d.value),1),a("button",{class:"btn btn-retry",onClick:A},"Повторить")])):f.value.length===0?(c(),u("div",wk,[D[9]||(D[9]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",Ck," На стадии «"+m(r.value?.stageName)+"» нет тикетов за выбранный период ("+m(We(Rt)[v.value])+") ",1)])):(c(),u("div",Tk,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(f.value,(E,L)=>(c(),he(Ct,{key:E.id,ticket:E,draggable:!1,style:we({"--ticket-index":L}),onClick:_},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Dk=de(Sk,[["__scopeId","data-v-0dacaef9"]]),Lt=new Map,Ek=5*60*1e3;function Ak(o,e){return`${o}:${JSON.stringify(e)}`}function na(o){return Date.now()-o.timestamp<Ek}function $k(o,e){if(Lt.set(o,{data:e,timestamp:Date.now()}),Lt.size>20){const s=Lt.keys().next().value;Lt.delete(s)}}function Ik(o){const e=Lt.get(o);return e&&na(e)?(console.log("[API-CACHE] Cache hit for key:",o),e.data):(e&&!na(e)&&(console.log("[API-CACHE] Cache expired for key:",o),Lt.delete(o)),null)}async function Mk(o={}){const e="/api/graph-1c-admission-closure.php",s=Ak(e,o),t=Ik(e);if(t)return t;console.log("[API-CACHE] Cache miss, making API request for:",s);const{LazyServiceLoader:r}=await Ee(async()=>{const{LazyServiceLoader:l}=await import("./chunk-2JzEd2ES.js").then(d=>d.l);return{LazyServiceLoader:l}},__vite__mapDeps([3,4]),import.meta.url),{fetchAdmissionClosureStats:i}=await r.loadAdmissionClosureService(),n=await i(o);return $k(s,n),n}async function Nk(o,e){return Mk({product:"1C",weekStartUtc:o,weekEndUtc:e,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!0})}const xk={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Lk={class:"modal"},Pk={key:"level-1",class:"level-1"},Ok={class:"modal__header"},Bk={class:"modal__title"},Rk={key:0},Wk={class:"modal__body"},Uk={key:"loading",class:"loading-names"},Fk={key:"empty",class:"modal__empty"},Hk={key:"list",class:"duration-list"},jk=["onClick"],zk={class:"duration-list__name"},Vk={class:"duration-list__count"},Gk={key:0,class:"duration-list__arrow"},Kk={class:"modal__footer"},qk={key:"level-2",class:"level-2"},Yk={class:"modal__header"},Xk={class:"modal__title"},Jk={class:"modal__body"},Zk={key:"loading",class:"loading-state"},Qk={key:"error",class:"error-state"},e1={class:"error-message"},t1={key:"empty",class:"empty-state"},s1={class:"empty-state-message"},a1={key:"tickets",class:"tickets-list-container"},o1={__name:"CarryoverDurationModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=I(1),r=I(null),i=I([]),n=I(!1),l=I(!1),d=I(null),g=I([]),v=M(()=>g.value.length>0&&g.value.some(k=>k.count>0));async function T(){if(!s.weekStartUtc||!s.weekEndUtc){g.value=[];return}l.value=!0,d.value=null;try{const k=await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0});g.value=k.data.carryoverTicketsByDuration||[]}catch(k){d.value=k.message||"Ошибка загрузки категорий",console.error("[CarryoverDurationModal] Error loading categories:",k),g.value=[]}finally{l.value=!1}}async function f(k,_=null){!k||k.count===0||(_&&_.currentTarget&&(_.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{_.currentTarget&&(_.currentTarget.style.transform="")},150)),r.value=k,t.value=2,await p(k.durationCategory))}async function p(k){n.value=!0,d.value=null;try{const _=g.value.find(D=>D.durationCategory===k);if(_&&Array.isArray(_.tickets)&&_.tickets.length>0){console.log("[TASK-070] CarryoverDurationModal: Using preloaded tickets for category",k,"count:",_.tickets.length);const D=_.tickets;try{const{prepareTicketsForDisplay:E}=await Ee(async()=>{const{prepareTicketsForDisplay:L}=await import("./chunk-BBmTsmYU.js").then(B=>B.t);return{prepareTicketsForDisplay:L}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await E(D,null,null)}catch(E){console.error("[TASK-070] CarryoverDurationModal: Error preparing tickets:",E),i.value=D}n.value=!1;return}if(console.log("[TASK-070] CarryoverDurationModal: Tickets not preloaded, loading from API for category",k),!s.weekStartUtc||!s.weekEndUtc)throw new Error("Не указаны границы недели");const x=(await Nk(s.weekStartUtc,s.weekEndUtc)).data.carryoverTicketsByDuration?.find(D=>D.durationCategory===k)?.tickets||[];try{const{prepareTicketsForDisplay:D}=await Ee(async()=>{const{prepareTicketsForDisplay:E}=await import("./chunk-BBmTsmYU.js").then(L=>L.t);return{prepareTicketsForDisplay:E}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await D(x,null,null)}catch(D){console.error("[CarryoverDurationModal] Error preparing tickets:",D),i.value=x}i.value.length===0&&(d.value=null)}catch(_){d.value=_.message||"Ошибка загрузки тикетов",console.error("[CarryoverDurationModal] Error loading tickets:",_),i.value=[]}finally{n.value=!1}}function y(){t.value=1,r.value=null,i.value=[],d.value=null}function S(k){const _=es(k.id);window.open(_,"_blank")}function C(){r.value&&p(r.value.durationCategory)}return Ne(()=>s.isVisible,async k=>{k?(t.value=1,r.value=null,i.value=[],d.value=null,s.preloadedData&&Array.isArray(s.preloadedData)&&s.preloadedData.length>0?(console.log("[TASK-070] CarryoverDurationModal: Using preloaded data, categories count:",s.preloadedData.length),s.preloadedData.every(A=>A.durationCategory&&A.durationLabel&&typeof A.count=="number")?(g.value=s.preloadedData,l.value=!1):(console.warn("[TASK-070] CarryoverDurationModal: Invalid preloaded data structure, falling back to API"),await T())):(console.log("[TASK-070] CarryoverDurationModal: No preloaded data, loading from API"),await T())):(t.value=1,r.value=null,i.value=[],d.value=null,g.value=[])},{immediate:!1}),Ne([()=>s.weekNumber,()=>s.preloadedData],async([k,_])=>{s.isVisible&&k&&(_&&Array.isArray(_)&&_.length>0?_.every(W=>W.durationCategory&&W.durationLabel&&typeof W.count=="number")?(console.log("[TASK-070] CarryoverDurationModal: Week changed, updating with preloaded data for week",k),g.value=_,l.value=!1):(console.log("[TASK-070] CarryoverDurationModal: Week changed, invalid preloaded data, loading from API for week",k),await T()):(console.log("[TASK-070] CarryoverDurationModal: Week changed, loading from API for week",k),await T()))}),(k,_)=>o.isVisible?(c(),u("div",xk,[a("div",Lk,[ne(Ae,{name:"level",mode:"out-in"},{default:pe(()=>[t.value===1?(c(),u("div",Pk,[a("header",Ok,[a("h3",Bk,[_[3]||(_[3]=ce(" Переходящие тикеты по срокам",-1)),o.weekNumber?(c(),u("span",Rk," · Неделя "+m(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:_[0]||(_[0]=A=>k.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Wk,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[l.value?(c(),u("div",Uk,[..._[4]||(_[4]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка категорий...",-1)])])):v.value?(c(),u("ul",Hk,[(c(!0),u(ee,null,te(g.value,A=>(c(),u("li",{key:A.durationCategory,class:X(["duration-list__item",{"duration-list__item--clickable":A.count>0}]),style:we({"--duration-color":A.color}),onClick:W=>f(A,W),title:"Кликните для просмотра тикетов категории"},[a("span",{class:"duration-list__color",style:we({backgroundColor:A.color})},null,4),a("span",zk,m(A.durationLabel),1),a("span",Vk,m(A.count)+" тикетов ",1),A.count>0?(c(),u("span",Gk,"→")):$("",!0)],14,jk))),128))])):(c(),u("p",Fk," Нет переходящих тикетов за выбранную неделю "))]),_:1})]),a("footer",Kk,[a("button",{class:"btn",onClick:_[1]||(_[1]=A=>k.$emit("close"))},"Закрыть")])])):t.value===2?(c(),u("div",qk,[a("header",Yk,[a("button",{class:"btn-back",onClick:y,"aria-label":"Назад"},"← Назад"),a("h3",Xk," Тикеты: "+m(r.value?.durationLabel||"Неизвестно"),1),a("button",{class:"modal__close",onClick:_[2]||(_[2]=A=>k.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Jk,[ne(Ae,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),u("div",Zk,[..._[5]||(_[5]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов категории...",-1),a("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):d.value?(c(),u("div",Qk,[_[6]||(_[6]=a("div",{class:"error-icon"},"⚠️",-1)),_[7]||(_[7]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",e1,m(d.value),1),a("button",{class:"btn btn-retry",onClick:C},"Повторить")])):i.value.length===0?(c(),u("div",t1,[_[8]||(_[8]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",s1," В категории «"+m(r.value?.durationLabel)+"» нет тикетов ",1)])):(c(),u("div",a1,[ne(et,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),u(ee,null,te(i.value,(A,W)=>(c(),he(Ct,{key:A.id,ticket:A,draggable:!1,style:we({"--ticket-index":W}),onClick:S},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},n1=de(o1,[["__scopeId","data-v-f199806c"]]);function r1(){const o=I(null),e=I(!1),s=I(null),t=async()=>{if(o.value)return o.value;try{e.value=!0,s.value=null;const{fetchAdmissionClosureStats:n,...l}=await wo.loadAdmissionClosureService();o.value={fetchAdmissionClosureStats:n,...l}}catch(n){throw s.value=n,console.error("Failed to load admission service:",n),n}finally{e.value=!1}return o.value},r=async(n={})=>(await t()).fetchAdmissionClosureStats(n),i=()=>{o.value=null,s.value=null};return{service:_s(o),loading:_s(e),error:_s(s),loadService:t,fetchStats:r,clearService:i}}const i1={class:"ac-dashboard"},l1={key:"preloader",class:"chart-preloader"},c1={class:"preloader-content"},d1={class:"preloader-message"},u1={key:"content"},g1={key:1,class:"weeks-dashboard"},m1={class:"dashboard-header"},h1={class:"header-content"},f1={class:"breadcrumbs-row"},v1=["aria-label","aria-disabled","data-fallback","disabled"],p1={class:"breadcrumbs","aria-label":"Навигация"},y1={class:"dashboard-layout"},k1={class:"filters-container"},b1={class:"chart-container"},_1={__name:"GraphAdmissionClosureDashboard",setup(o){const e=Xe(),{fetchStats:s}=r1(),t=async b=>await s(b),r=I(!1),i=I(null),n=I(null),l=I({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),d=I(!1),g=I(!1),v=I(!1),T=I(!0),f=I(null),p=I({weeks:new Map,currentWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null},previousWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null}}),y=M(()=>{const b=n.value?.weeks||[];return b.length>=2?b[b.length-2]:null}),S=I(!1),C=M(()=>typeof window>"u"?!1:window.history.length>1),k=M(()=>C.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),_={name:"dashboard-sector-1c"};function A(b){if(b?.preventDefault?.(),!S.value){S.value=!0;try{if(C.value){e.back();return}console.warn("GraphAdmissionClosureDashboard: fallback navigation to dashboard-sector-1c"),e.push(_)}finally{S.value=!1}}}function W(){e.push("/")}const x=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),D=I("weeks"),E=M(()=>{const b=x.value.customDateRange.startDate||x.value.customDateRange.endDate,O=x.value.employees.length===1&&x.value.employees.includes("all");return b||!O});async function L(){if(console.log("[DEBUG] loadData called"),console.log("[DEBUG] periodMode:",D.value),console.log("[DEBUG] isLoading before:",r.value),D.value!=="weeks"){console.log("[DEBUG] loadData: periodMode is not weeks, returning and resetting isLoading"),r.value=!1;return}console.log("[DEBUG] Setting isLoading to true"),r.value=!0,i.value=null;const b=new Promise(O=>setTimeout(O,300));try{console.log("[DEBUG] Starting API call");const O=N(),Q=O.weekStartUtc,ue=O.weekEndUtc;console.log("[DEBUG] Week bounds:",{weekStartUtc:Q,weekEndUtc:ue});const[ke,_e]=await Promise.all([b,t({product:"1C",periodMode:"weeks",weekStartUtc:Q,weekEndUtc:ue,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0})]);console.log("[DEBUG] API call successful, result:",_e);const{meta:K,data:j,carryoverDebug:z}=_e;n.value=K;const se=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:j.responsibleCreatedThisWeek?Object.values(j.responsibleCreatedThisWeek):[],ge=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:j.responsibleCreatedOtherWeek?Object.values(j.responsibleCreatedOtherWeek):[];l.value={...j,responsibleCreatedThisWeek:se,responsibleCreatedOtherWeek:ge},console.log("[DEBUG] Data set, meta:",K,"data keys:",Object.keys(j)),console.log("[TASK-070] chartData.value.responsibleCreatedThisWeek after normalization:",{isArray:Array.isArray(se),length:se.length,sample:se.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] chartData.value.responsibleCreatedOtherWeek after normalization:",{isArray:Array.isArray(ge),length:ge.length,sample:ge.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedThisWeek from API:",{count:j.responsibleCreatedThisWeek?.length||0,data:j.responsibleCreatedThisWeek,details:j.responsibleCreatedThisWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedOtherWeek from API:",{count:j.responsibleCreatedOtherWeek?.length||0,data:j.responsibleCreatedOtherWeek,details:j.responsibleCreatedOtherWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] closedTicketsCreatedThisWeek:",j.closedTicketsCreatedThisWeek),console.log("[TASK-070] closedTicketsCreatedOtherWeek:",j.closedTicketsCreatedOtherWeek);const ye=K?.weeks||[];if(console.log("[PERF-OPTIMIZATION] Preloading popup data for",ye.length,"weeks"),ye.forEach((F,ie)=>{p.value.weeks.has(F.weekNumber)||p.value.weeks.set(F.weekNumber,{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:F});const ve=p.value.weeks.get(F.weekNumber);ie===ye.length-1&&(j.newTicketsByStages&&(ve.newTicketsByStages=j.newTicketsByStages,console.log("[PERF-OPTIMIZATION] Preloaded newTicketsByStages for week",F.weekNumber,":",j.newTicketsByStages.length,"stages")),j.carryoverTicketsByDuration&&(ve.carryoverTicketsByDuration=j.carryoverTicketsByDuration,console.log("[PERF-OPTIMIZATION] Preloaded carryoverTicketsByDuration for week",F.weekNumber,":",j.carryoverTicketsByDuration.length,"categories")))}),j.newTicketsByStages&&(p.value.currentWeek.newTicketsByStages=j.newTicketsByStages),j.carryoverTicketsByDuration&&(p.value.currentWeek.carryoverTicketsByDuration=j.carryoverTicketsByDuration),ye.length>1&&G(ye.slice(0,-1)),j.responsibleCreatedThisWeek){const F=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:Object.values(j.responsibleCreatedThisWeek);p.value.currentWeek.responsibleCreatedThisWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedThisWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(j.responsibleCreatedOtherWeek){const F=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:Object.values(j.responsibleCreatedOtherWeek);p.value.currentWeek.responsibleCreatedOtherWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedOtherWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(z&&(console.log("[CARRYOVER-DEBUG] ========================================"),console.log("[CARRYOVER-DEBUG] Total:",z.total),console.log("[CARRYOVER-DEBUG] ThisWeek:",z.thisWeek),console.log("[CARRYOVER-DEBUG] PreviousWeek:",z.previousWeek),console.log("[CARRYOVER-DEBUG] Older:",z.older),console.log("[CARRYOVER-DEBUG] Sum:",z.sum,"(expected:",z.total,")"),console.log("[CARRYOVER-DEBUG] Series:",z.series),console.log("[CARRYOVER-DEBUG] CurrentWeekData:",z.currentWeekData),console.log("[CARRYOVER-DEBUG] WeeksData:",z.weeksData),console.log("[CARRYOVER-DEBUG] Full object:",z),console.log("[CARRYOVER-DEBUG] ========================================")),y.value){const F=y.value.weekStartUtc,ie=y.value.weekEndUtc;console.log("[TASK-070] Starting preload for previous week:",{weekNumber:y.value.weekNumber,weekStartUtc:F,weekEndUtc:ie}),t({product:"1C",periodMode:"weeks",weekStartUtc:F,weekEndUtc:ie,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0}).then(ve=>{if(console.log("[TASK-070] Preload successful for previous week"),ve.data.newTicketsByStages&&(p.value.previousWeek.newTicketsByStages=ve.data.newTicketsByStages,console.log("[TASK-070] Preloaded newTicketsByStages for previous week:",ve.data.newTicketsByStages.length,"stages")),ve.data.carryoverTicketsByDuration&&(p.value.previousWeek.carryoverTicketsByDuration=ve.data.carryoverTicketsByDuration,console.log("[TASK-070] Preloaded carryoverTicketsByDuration for previous week:",ve.data.carryoverTicketsByDuration.length,"categories")),ve.data.responsibleCreatedThisWeek){const Te=Array.isArray(ve.data.responsibleCreatedThisWeek)?ve.data.responsibleCreatedThisWeek:Object.values(ve.data.responsibleCreatedThisWeek);p.value.previousWeek.responsibleCreatedThisWeek=Te,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for previous week:",Te.length,"employees")}if(ve.data.responsibleCreatedOtherWeek){const Te=Array.isArray(ve.data.responsibleCreatedOtherWeek)?ve.data.responsibleCreatedOtherWeek:Object.values(ve.data.responsibleCreatedOtherWeek);p.value.previousWeek.responsibleCreatedOtherWeek=Te,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for previous week:",Te.length,"employees")}}).catch(ve=>{console.warn("[TASK-070] Failed to preload previous week data (non-critical):",ve)})}}catch(O){console.error("[DEBUG] API call failed:",O),i.value=O instanceof Error?O:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureDashboard] loadData error:",O)}finally{console.log("[DEBUG] Finally block: setting isLoading to false"),r.value=!1,console.log("[DEBUG] isLoading after:",r.value)}}function B(b){if(!b||!n.value)return console.log("[TASK-070] getPreloadedStagesData: Missing weekMeta or chartMeta"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null;console.log("[TASK-070] getPreloadedStagesData:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,weeksInMeta:O.length});const ke=b.weekNumber===Q,_e=b.weekNumber===ue;let K=null;if(ke)K=p.value.currentWeek.newTicketsByStages,console.log("[TASK-070] Requested week is current week, checking currentWeek data:",K?`Array(${K.length})`:"null");else if(_e)K=p.value.previousWeek.newTicketsByStages,console.log("[TASK-070] Requested week is previous week, checking previousWeek data:",K?`Array(${K.length})`:"null");else return console.log("[TASK-070] Requested week",b.weekNumber,"is neither current nor previous, no preloaded data available"),null;return Array.isArray(K)&&K.length>0?(console.log("[TASK-070] Using preloaded stages data for week",b.weekNumber,":",K.length,"stages"),K):(console.log("[TASK-070] No preloaded stages data for week",b.weekNumber,", will use API fallback"),null)}function U(b){if(!b)return null;const O=p.value.weeks.get(b.weekNumber);if(O?.carryoverTicketsByDuration&&Array.isArray(O.carryoverTicketsByDuration))return console.log("[PERF-OPTIMIZATION] Using preloaded carryover data for week",b.weekNumber,":",O.carryoverTicketsByDuration.length,"categories"),O.carryoverTicketsByDuration;const Q=n.value?.weeks||[],ue=Q.length>0?Q[Q.length-1].weekNumber:n.value.weekNumber,_e=b.weekNumber===ue?p.value.currentWeek.carryoverTicketsByDuration:p.value.previousWeek.carryoverTicketsByDuration;return Array.isArray(_e)&&_e.length>0?(console.log("[TASK-070] Using fallback preloaded carryover data for week",b.weekNumber,":",_e.length,"categories"),_e):(console.log("[PERF-ISSUE] No preloaded carryover data for week",b.weekNumber,", will use slow API fallback"),null)}async function G(b){if(!(!b||b.length===0)){console.log("[PERF-OPTIMIZATION] Starting background preload for",b.length,"weeks");for(const O of b)try{await new Promise(ke=>setTimeout(ke,500)),console.log("[PERF-OPTIMIZATION] Preloading data for week",O.weekNumber);const Q=await t({product:"1C",periodMode:"weeks",weekStartUtc:O.weekStartUtc,weekEndUtc:O.weekEndUtc,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!1}),ue={newTicketsByStages:Q.data.newTicketsByStages||null,carryoverTicketsByDuration:Q.data.carryoverTicketsByDuration||null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:O};p.value.weeks.set(O.weekNumber,ue),console.log("[PERF-OPTIMIZATION] Successfully preloaded data for week",O.weekNumber)}catch(Q){console.warn("[PERF-OPTIMIZATION] Failed to preload data for week",O.weekNumber,":",Q)}console.log("[PERF-OPTIMIZATION] Background preload completed")}}function q(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber;return b.weekNumber===Q&&l.value.responsible||null}function oe(b){if(!b){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedThisWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;if(console.log("[TASK-070] getResponsibleCreatedThisWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=p.value.previousWeek.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedThisWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function Y(b){if(!b){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedOtherWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;if(console.log("[TASK-070] getResponsibleCreatedOtherWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=p.value.previousWeek.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedOtherWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function H(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;return ke?l.value.closedTicketsCreatedThisWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===ue)?.closedTicketsCreatedThisWeek??null:null}function Z(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;return ke?l.value.closedTicketsCreatedOtherWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===ue)?.closedTicketsCreatedOtherWeek??null:null}function fe(b){x.value.stages=b}function P(b){x.value.employees=b}function h(b){x.value.dateRange=b}function w(b){x.value.customDateRange=b}function R(b){if(!["weeks","months"].includes(b)){console.warn("[GraphAdmissionClosureDashboard] Invalid periodMode:",b);return}b!==D.value&&(D.value=b,b==="weeks"?L():b==="months"&&(r.value=!1))}function re(b){const{mode:O}=b.detail;["weeks","months"].includes(O)&&R(O)}function le(){x.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},ae()}function ae(){D.value==="weeks"&&L()}function me(b){["weeks","months"].includes(b)&&(D.value=b)}function Se(){console.log("[DEBUG] handleCloseModal called"),console.log("[DEBUG] showPeriodModeInfo before:",T.value),console.log("[DEBUG] isLoading before:",r.value),console.log("[DEBUG] periodMode:",D.value),T.value=!1,r.value=!0,console.log("[DEBUG] showPeriodModeInfo after:",T.value),console.log("[DEBUG] isLoading after:",r.value),Wt(()=>{console.log("[DEBUG] handleCloseModal: calling handleStartLoading in nextTick"),Ie()})}function Ie(){console.log("[DEBUG] handleStartLoading called"),console.log("[DEBUG] periodMode before check:",D.value),console.log("[DEBUG] showPeriodModeInfo:",T.value),console.log("[DEBUG] isLoading:",r.value),(!D.value||!["weeks","months"].includes(D.value))&&(console.warn('[GraphAdmissionClosureDashboard] Period mode not set, using default "weeks"'),D.value="weeks"),console.log("[GraphAdmissionClosureDashboard] Starting loading, periodMode:",D.value),Wt(()=>{console.log("[DEBUG] nextTick callback, periodMode:",D.value),console.log("[DEBUG] isLoading in nextTick:",r.value),D.value==="weeks"?(console.log("[GraphAdmissionClosureDashboard] Loading data for weeks mode"),L()):D.value==="months"&&(console.log("[GraphAdmissionClosureDashboard] Months mode - data will be loaded by GraphAdmissionClosureMonthsDashboard"),r.value=!1,console.log("[DEBUG] Reset parent isLoading to false for months mode"))})}function xe(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},g.value=!0}function Fe(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},d.value=!0}function V(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},v.value=!0}$e(()=>{try{const b="graph-admission-closure-period-mode-info-shown";localStorage.getItem(b)&&localStorage.removeItem(b);const O="graph-admission-closure-period-mode";localStorage.getItem(O)&&localStorage.removeItem(O)}catch(b){console.warn("[GraphAdmissionClosureDashboard] Failed to clean localStorage:",b)}window.addEventListener("period-mode-change",re)}),st(()=>{window.removeEventListener("period-mode-change",re)});function N(){const b=new Date,O=new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate())),Q=O.getUTCDay(),ue=O.getUTCDate()-Q+(Q===0?-6:1),ke=new Date(Date.UTC(O.getUTCFullYear(),O.getUTCMonth(),ue,0,0,0)),_e=new Date(ke);return _e.setUTCDate(_e.getUTCDate()+6),_e.setUTCHours(23,59,59,999),{weekStartUtc:ke.toISOString(),weekEndUtc:_e.toISOString()}}return(b,O)=>{const Q=be("router-link");return c(),u("div",i1,[ne(Ae,{name:"fade",mode:"out-in"},{default:pe(()=>[r.value?(c(),u("div",l1,[a("div",c1,[O[3]||(O[3]=a("div",{class:"preloader-spinner"},[a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"})],-1)),O[4]||(O[4]=a("h3",{class:"preloader-title"},"Загрузка графика",-1)),a("p",d1," Получение данных за "+m(D.value==="weeks"?"4 недели":"3 месяца")+"... ",1),O[5]||(O[5]=a("div",{class:"preloader-dots"},[a("span",{class:"dot"}),a("span",{class:"dot"}),a("span",{class:"dot"})],-1))])])):!T.value&&!r.value?(c(),u("div",u1,[D.value==="months"?(c(),he(fp,{key:0})):(c(),u("div",g1,[a("div",m1,[a("div",h1,[a("div",f1,[a("button",{class:"btn-home-link",type:"button",onClick:W,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),O[11]||(O[11]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:A,"aria-label":k.value,"aria-disabled":!C.value,"data-fallback":!C.value,disabled:S.value,title:"Назад"}," ← ",8,v1),a("nav",p1,[ne(Q,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...O[6]||(O[6]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),O[8]||(O[8]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(Q,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[...O[7]||(O[7]=[ce(" График состояния ",-1)])]),_:1}),O[9]||(O[9]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),O[10]||(O[10]=a("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),O[12]||(O[12]=a("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),O[13]||(O[13]=a("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),a("div",y1,[a("div",k1,[ne(Fs,{stages:x.value.stages,employees:x.value.employees,dateRange:x.value.dateRange,customDateRange:x.value.customDateRange,hasActiveFilters:E.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":D.value,"onUpdate:stages":fe,"onUpdate:employees":P,"onUpdate:dateRange":h,"onUpdate:customDateRange":w,"onUpdate:periodMode":R,onReset:le,onApply:ae},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","period-mode"])]),a("div",b1,[i.value?(c(),he(ks,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),he($f,{key:1,meta:n.value,data:l.value,onOpenResponsible:Fe,onOpenStages:xe,onOpenCarryover:V},null,8,["meta","data"]))])])]))])):$("",!0)]),_:1}),ne(Yy,{"is-visible":d.value,responsible:q(f.value)||l.value.responsible||[],"closed-tickets-created-this-week":H(f.value)??l.value.closedTicketsCreatedThisWeek??0,"closed-tickets-created-other-week":Z(f.value)??l.value.closedTicketsCreatedOtherWeek??0,"responsible-created-this-week":oe(f.value)||l.value.responsibleCreatedThisWeek||[],"responsible-created-other-week":Y(f.value)||l.value.responsibleCreatedOtherWeek||[],"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,onClose:O[0]||(O[0]=ue=>{d.value=!1,f.value.value=null})},null,8,["is-visible","responsible","closed-tickets-created-this-week","closed-tickets-created-other-week","responsible-created-this-week","responsible-created-other-week","week-number","week-start-utc","week-end-utc"]),ne(Dk,{"is-visible":g.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":B(f.value),onClose:O[1]||(O[1]=ue=>{g.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),ne(n1,{"is-visible":v.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":U(f.value),onClose:O[2]||(O[2]=ue=>{v.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),T.value?(c(),he(Tm,{key:0,"is-visible":T.value,"current-mode":D.value,onClose:Se,onSelectMode:me},null,8,["is-visible","current-mode"])):$("",!0)])}}},Ba=de(_1,[["__scopeId","data-v-2fa9296d"]]),w1=Object.freeze(Object.defineProperty({__proto__:null,default:Ba},Symbol.toStringTag,{value:"Module"})),C1={name:"ZeroPoint",components:{TicketCard:Ct},props:{tickets:{type:Array,required:!0,default:()=>[]},stageId:{type:String,required:!0}},emits:{"ticket-dragged":o=>typeof o=="object"&&o!==null,"ticket-assigned":o=>typeof o=="object"&&o!==null,"ticket-clicked":o=>typeof o=="object"&&o!==null},setup(o,{emit:e}){return{hasTickets:M(()=>Array.isArray(o.tickets)&&o.tickets.length>0),handleTicketDragStart:r=>{e("ticket-dragged",r)}}}},T1={class:"zero-point"},S1={key:0,class:"empty-state"};function D1(o,e,s,t,r,i){const n=be("TicketCard");return c(),u("div",T1,[e[3]||(e[3]=a("div",{class:"zero-point-header"},[a("h3",null,"Нулевая точка")],-1)),rs([s.tickets.length,s.tickets.map(l=>l.id).join(",")],()=>(c(),u("div",{class:"zero-point-tickets"},[(c(!0),u(ee,null,te(s.tickets,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onDragStart:d=>t.handleTicketDragStart(l),onClick:d=>o.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128))])),e,0),e[1]||(qs(-1,!0),(e[1]=t.hasTickets?$("",!0):(c(),u("div",S1,[...e[2]||(e[2]=[a("p",null,"Нет неразобранных тикетов в стадии",-1)])]))).cacheIndex=1,qs(1),e[1])])}const E1=de(C1,[["render",D1],["__scopeId","data-v-c5370e55"]]);function A1(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Ra(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Wa(o){return typeof o=="string"&&["formed","review","execution"].includes(o)}function $1(o){return!o||typeof o!="object"?!1:A1(o.id)&&typeof o.title=="string"&&o.title.trim().length>0}function Ua(o,e,s){return!(!$1(o)||!Ra(e)||!Wa(s)||o.assigneeId===e&&o.stageId===s)}function I1(o){const e=[];return!o||typeof o!="object"?(e.push("Данные тикета должны быть объектом"),{valid:!1,errors:e}):((!o.title||typeof o.title!="string"||o.title.trim().length===0)&&e.push("Название тикета обязательно"),o.stageId&&!Wa(o.stageId)&&e.push("Некорректный ID стадии"),o.employeeId&&!Ra(o.employeeId)&&e.push("Некорректный ID сотрудника"),{valid:e.length===0,errors:e})}function M1(o){const e=ct(),s=I(!1);return{isDropZoneActive:s,handleDragStart:(d,g)=>{d.dataTransfer.effectAllowed="move",d.dataTransfer.setData("application/json",JSON.stringify(g)),d.dataTransfer.setDragImage(d.target,0,0)},handleDragOver:d=>{d.preventDefault(),d.dataTransfer.dropEffect="move",s.value=!0},handleDragLeave:d=>{const g=d.currentTarget.getBoundingClientRect(),v=d.clientX,T=d.clientY;(v<g.left||v>g.right||T<g.top||T>g.bottom)&&(s.value=!1)},handleDrop:async(d,g,v)=>{d.preventDefault(),s.value=!1;const T=d.dataTransfer.getData("application/json");if(T)try{const f=JSON.parse(T);if(!Ua(f,g,v)){e.warning("Нельзя переместить тикет сюда");return}o&&typeof o=="function"&&await o(f,g,v)}catch(f){De.error("Error parsing ticket data","useDragAndDrop",f),e.error("Ошибка обработки данных тикета")}},handleDragEnd:d=>{s.value=!1}}}function Fa(o=null){const e=ro(),s=e?.type?.name||e?.type?.__name||null,t=o||s||"Unknown",r=(g,v,T=null)=>{De.log(g,v,t,T)};return{error:(g,v=null)=>{r("ERROR",g,v)},warn:(g,v=null)=>{r("WARN",g,v)},info:(g,v=null)=>{r("INFO",g,v)},debug:(g,v=null)=>{r("DEBUG",g,v)},log:r,context:t}}const N1={name:"EmployeeColumn",components:{TicketCard:Ct},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(o,{emit:e}){Fa("EmployeeColumn");const t=M1(async(v,T,f)=>{e("ticket-dropped",v,T)}),r=M(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:Array.isArray(o.employee.ticketsInsideSector)?o.employee.ticketsInsideSector:[]),i=M(()=>o.employee.isFromSector1C?[]:Array.isArray(o.employee.ticketsOutsideSector)?o.employee.ticketsOutsideSector:Array.isArray(o.employee.tickets)?o.employee.tickets:[]),n=M(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:[]),l=M(()=>r.value.length+i.value.length),d=v=>{t.handleDrop(v,o.employee.id,o.stageId)},g=v=>{};return{isDropZoneActive:t.isDropZoneActive,handleDragOver:t.handleDragOver,handleDragLeave:t.handleDragLeave,handleDrop:d,ticketsInsideSector:r,ticketsOutsideSector:i,ticketsToDisplay:n,totalTicketsCount:l,handleTicketDragStart:g}}},x1={class:"employee-header"},L1={class:"employee-info"},P1={class:"employee-details"},O1={class:"employee-name"},B1={key:0,class:"employee-position"},R1={class:"tickets-count"},W1={class:"tickets-list"},U1={class:"section-header"},F1={class:"section-count"},H1={key:2,class:"empty-state"};function j1(o,e,s,t,r,i){const n=be("TicketCard");return c(),u("div",{class:X(["employee-column",{"drop-zone-active":t.isDropZoneActive}]),onDragover:e[3]||(e[3]=Ce((...l)=>t.handleDragOver&&t.handleDragOver(...l),["prevent"])),onDragleave:e[4]||(e[4]=(...l)=>t.handleDragLeave&&t.handleDragLeave(...l)),onDrop:e[5]||(e[5]=(...l)=>t.handleDrop&&t.handleDrop(...l))},[a("div",x1,[a("div",L1,[e[6]||(e[6]=a("span",{class:"employee-icon"},"👤",-1)),a("div",P1,[a("div",O1,m(s.employee.name),1),s.employee.position?(c(),u("div",B1,m(s.employee.position),1)):$("",!0)])]),a("div",R1," 📊 Тикетов: "+m(t.totalTicketsCount),1)]),a("div",W1,[s.employee.isFromSector1C?rs([t.ticketsToDisplay.length,t.ticketsToDisplay.map(l=>l.id).join(",")],()=>(c(),u("div",{key:0},[ne(et,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),u(ee,null,te(t.ticketsToDisplay,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,0):(c(),u(ee,{key:1},[t.ticketsInsideSector.length>0?rs([t.ticketsInsideSector.length,t.ticketsInsideSector.map(l=>l.id).join(",")],()=>(c(),u("div",{key:0,class:"tickets-section tickets-inside-sector"},[ne(et,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),u(ee,null,te(t.ticketsInsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,1):$("",!0),t.ticketsOutsideSector.length>0?rs([t.ticketsOutsideSector.length,t.ticketsOutsideSector.map(l=>l.id).join(",")],()=>(c(),u("div",{key:1,class:"tickets-section tickets-outside-sector"},[a("div",U1,[e[7]||(e[7]=a("span",{class:"section-badge"},"Вне сектора",-1)),a("span",F1,m(t.ticketsOutsideSector.length),1)]),ne(et,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),u(ee,null,te(t.ticketsOutsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,2):$("",!0)],64)),t.totalTicketsCount===0?(c(),u("div",H1,[...e[8]||(e[8]=[a("p",null,"Нет тикетов",-1)])])):$("",!0)])],34)}const z1=de(N1,[["render",j1],["__scopeId","data-v-cdec5b5c"]]),V1={name:"DashboardStage",components:{ZeroPoint:E1,EmployeeColumn:z1},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(o,{emit:e}){const s=Fa("DashboardStage"),t=I(!1),r=M(()=>{const f=Array.isArray(o.zeroPointTickets)?o.zeroPointTickets.length:0,p=Array.isArray(o.stage.employees)?o.stage.employees.reduce((y,S)=>Array.isArray(S.ticketsInsideSector)?y+S.ticketsInsideSector.length:S.isFromSector1C&&Array.isArray(S.tickets)?y+S.tickets.length:y,0):0;return f+p}),i=M(()=>Array.isArray(o.stage.employees)?o.stage.employees.reduce((f,p)=>Array.isArray(p.ticketsOutsideSector)?f+p.ticketsOutsideSector.length:!p.isFromSector1C&&Array.isArray(p.tickets)?f+p.tickets.length:f,0):0),n=M(()=>r.value+i.value),l=M(()=>{const f=o.stage?.name||"Стадия",p=r.value,y=i.value;return y===0?`${f} (${p})`:`${f} (${p} / ${y})`});return{isDragging:t,ticketsCountInsideSector:r,ticketsCountOutsideSector:i,totalTicketsCount:n,stageNameWithCount:l,handleTicketDragged:f=>{t.value=!0},handleTicketAssigned:(f,p)=>{e("ticket-assigned",f,p)},handleTicketDropped:(f,p)=>{e("ticket-moved",f,p,o.stage.id),t.value=!1},handleTicketClicked:f=>{s.debug("Ticket clicked",f),e("ticket-clicked",f)}}}},G1={class:"stage-header"},K1={class:"stage-content"},q1={class:"employees-container"};function Y1(o,e,s,t,r,i){const n=be("ZeroPoint"),l=be("EmployeeColumn");return c(),u("div",{class:"dashboard-stage",style:we({borderLeftColor:s.stage.color})},[a("div",G1,[a("h2",null,m(t.stageNameWithCount),1)]),a("div",K1,[ne(n,{tickets:s.zeroPointTickets,"stage-id":s.stage.id,onTicketDragged:t.handleTicketDragged,onTicketAssigned:t.handleTicketAssigned,onTicketClicked:t.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),a("div",q1,[(c(!0),u(ee,null,te(s.stage.employees,d=>(c(),he(l,{key:d.id,employee:d,"stage-id":s.stage.id,onTicketClicked:t.handleTicketClicked,onTicketDropped:t.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const X1=de(V1,[["render",Y1],["__scopeId","data-v-c6fbde76"]]),As={cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},J1={loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},Z1={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(o,{emit:e}){const s=M(()=>{const{currentStep:g,stepDetails:v}=o;return v?.description?{title:g?As[g]?.title||g:"Загрузка...",description:v.description}:g?As[g]?As[g]:J1[g]||{title:"Загрузка...",description:"Пожалуйста, подождите..."}:{title:"Загрузка...",description:"Инициализация..."}}),t=M(()=>s.value.title),r=M(()=>s.value.description),i=M(()=>o.stepDetails),n=M(()=>{const g=o.progress;return g==null||isNaN(g)?0:Math.round(Math.max(0,Math.min(100,g)))});return{stepTitle:t,stepDescription:r,details:i,displayProgress:n,getStageDisplayName:g=>g?{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение","Сформировано обращение":"Сформировано обращение","Рассмотрение ТЗ":"Рассмотрение ТЗ",Исполнение:"Исполнение"}[g]||g:"",handleRetry:()=>{e("retry")}}}},Q1={class:"preloader-backdrop"},e0={class:"preloader-container"},t0={class:"preloader-content-scrollable"},s0={key:0,class:"spinner-container"},a0={class:"preloader-content"},o0={class:"step-title"},n0={key:0,class:"step-description"},r0={key:1,class:"progress-container"},i0={class:"progress-bar"},l0={class:"progress-text"},c0={key:2,class:"step-details"},d0={key:0,class:"detail-description"},u0={key:1,class:"detail-item"},g0={class:"detail-value"},m0={key:0,class:"detail-total"},h0={key:2,class:"detail-item"},f0={class:"detail-value"},v0={key:0,class:"detail-total"},p0={key:3,class:"detail-item"},y0={class:"detail-value"},k0={key:0,class:"detail-total"},b0={key:4,class:"detail-item"},_0={class:"detail-value"},w0={key:5,class:"detail-warning"},C0={key:0,class:"error-container"},T0={class:"error-content"},S0={class:"error-message"};function D0(o,e,s,t,r,i){return c(),u("div",{class:X(["loading-preloader",{"has-error":s.error}])},[a("div",Q1,[a("div",e0,[a("div",t0,[s.error?$("",!0):(c(),u("div",s0,[...e[1]||(e[1]=[a("div",{class:"spinner"},null,-1)])])),a("div",a0,[a("h3",o0,m(t.stepTitle),1),t.stepDescription?(c(),u("p",n0,m(t.stepDescription),1)):$("",!0),s.error?$("",!0):(c(),u("div",r0,[a("div",i0,[a("div",{class:"progress-fill",style:we({width:t.displayProgress+"%"})},null,4)]),a("span",l0,m(t.displayProgress)+"%",1)])),s.error?$("",!0):(c(),u("div",c0,[t.details.description?(c(),u("div",d0,m(t.details.description),1)):$("",!0),t.details.count!==void 0?(c(),u("div",u0,[e[2]||(e[2]=a("span",{class:"detail-label"},"Загружено тикетов:",-1)),a("span",g0,m(t.details.count),1),t.details.total!==void 0?(c(),u("span",m0," из "+m(t.details.total),1)):$("",!0)])):$("",!0),t.details.filteredTickets!==void 0?(c(),u("div",h0,[e[3]||(e[3]=a("span",{class:"detail-label"},"Отфильтровано тикетов:",-1)),a("span",f0,m(t.details.filteredTickets),1),t.details.totalTickets!==void 0?(c(),u("span",v0," из "+m(t.details.totalTickets),1)):$("",!0)])):$("",!0),t.details.stage?(c(),u("div",p0,[e[4]||(e[4]=a("span",{class:"detail-label"},"Стадия:",-1)),a("span",y0,m(t.getStageDisplayName(t.details.stage)),1),t.details.stageIndex&&t.details.totalStages?(c(),u("span",k0," ("+m(t.details.stageIndex)+"/"+m(t.details.totalStages)+") ",1)):$("",!0)])):$("",!0),t.details.employeeCount!==void 0?(c(),u("div",b0,[e[5]||(e[5]=a("span",{class:"detail-label"},"Сотрудников:",-1)),a("span",_0,m(t.details.employeeCount),1)])):$("",!0),t.details.warning?(c(),u("div",w0,[a("span",null,"⚠️ "+m(t.details.warning),1)])):$("",!0)]))])])])]),s.error?(c(),u("div",C0,[a("div",T0,[e[6]||(e[6]=a("div",{class:"error-icon"},"⚠️",-1)),a("p",S0,m(s.error),1),a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleRetry&&t.handleRetry(...n)),class:"retry-button"}," Повторить попытку ")])])):$("",!0)],2)}const E0=de(Z1,[["render",D0],["__scopeId","data-v-d129ff19"]]),A0={name:"LoggerControl",props:{showControl:{type:Boolean,default:!1}},setup(){const o=I(!1),e=I("ERROR"),s=I(!0),t=d=>({NONE:"Отключено",ERROR:"Только ошибки",WARN:"Предупреждения и ошибки",INFO:"Информация, предупреждения и ошибки",DEBUG:"Все логи (отладка)"})[d]||d;return $e(()=>{const d=Mt.getLevel();e.value=d,o.value=d!=="NONE"}),{enabled:o,level:e,isExpanded:s,getLevelDescription:t,handleToggle:()=>{o.value?(e.value==="NONE"&&(e.value="ERROR"),Mt.setLevel(e.value)):(Mt.setLevel("NONE"),e.value="NONE")},handleLevelChange:()=>{o.value&&Mt.setLevel(e.value)},resetToDefault:()=>{const d="ERROR";e.value=d,o.value=!0,Mt.setLevel(d)},toggleVisibility:()=>{s.value=!s.value}}}},$0={key:0,class:"logger-control"},I0={class:"logger-control-header"},M0=["aria-label"],N0={key:0,class:"logger-control-content"},x0={class:"logger-control-section"},L0={class:"logger-control-label"},P0={key:0,class:"logger-control-section"},O0={class:"logger-control-label"},B0={key:1,class:"logger-control-info"},R0={class:"logger-control-info-text"},W0={key:2,class:"logger-control-section"};function U0(o,e,s,t,r,i){return s.showControl?(c(),u("div",$0,[a("div",I0,[e[6]||(e[6]=a("h3",{class:"logger-control-title"},"Управление логированием",-1)),a("button",{class:"logger-control-toggle",onClick:e[0]||(e[0]=(...n)=>t.toggleVisibility&&t.toggleVisibility(...n)),"aria-label":t.isExpanded?"Свернуть":"Развернуть"},m(t.isExpanded?"▼":"▶"),9,M0)]),t.isExpanded?(c(),u("div",N0,[a("div",x0,[a("label",L0,[Be(a("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=n=>t.enabled=n),onChange:e[2]||(e[2]=(...n)=>t.handleToggle&&t.handleToggle(...n)),class:"logger-control-checkbox"},null,544),[[ys,t.enabled]]),e[7]||(e[7]=a("span",{class:"logger-control-label-text"},"Включить логирование",-1))])]),t.enabled?(c(),u("div",P0,[a("label",O0,[e[9]||(e[9]=a("span",{class:"logger-control-label-text"},"Уровень логирования:",-1)),Be(a("select",{"onUpdate:modelValue":e[3]||(e[3]=n=>t.level=n),onChange:e[4]||(e[4]=(...n)=>t.handleLevelChange&&t.handleLevelChange(...n)),class:"logger-control-select"},[...e[8]||(e[8]=[_t('<option value="NONE" data-v-ed57067c>Отключено</option><option value="ERROR" data-v-ed57067c>Только ошибки</option><option value="WARN" data-v-ed57067c>Предупреждения и ошибки</option><option value="INFO" data-v-ed57067c>Информация, предупреждения и ошибки</option><option value="DEBUG" data-v-ed57067c>Все логи (отладка)</option>',5)])],544),[[ut,t.level]])])])):$("",!0),t.enabled?(c(),u("div",B0,[a("span",R0,[e[10]||(e[10]=ce(" Текущий уровень: ",-1)),a("strong",null,m(t.getLevelDescription(t.level)),1)])])):$("",!0),t.enabled?(c(),u("div",W0,[a("button",{onClick:e[5]||(e[5]=(...n)=>t.resetToDefault&&t.resetToDefault(...n)),class:"logger-control-reset-btn",title:"Сбросить к значению по умолчанию"}," Сбросить к умолчанию ")])):$("",!0)])):$("",!0)])):$("",!0)}const F0=de(A0,[["render",U0],["__scopeId","data-v-ed57067c"]]),H0={name:"DiagnosticsPanel",props:{isEnabled:{type:Boolean,default:!1},isUserAdmin:{type:Boolean,default:!1}},setup(o){const e=I(!0),s=Qe(),t=M(()=>!o.isEnabled||!o.isUserAdmin?{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}:s?s.getMetrics():(console.warn("[DiagnosticsPanel] Diagnostics service not available"),{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}})),r=M(()=>!o.isEnabled||!o.isUserAdmin||!s?{withoutAssignedById:[],withAssignedById1051:[],withoutSectorTag:[],notInColumn:[],unknownStage:[]}:s.getProblematicTickets()),i=M(()=>{const g=r.value;return g.withoutAssignedById.length===0&&g.withAssignedById1051.length===0&&g.withoutSectorTag.length===0&&g.notInColumn.length===0&&g.unknownStage.length===0});return{isExpanded:e,metrics:t,problematicTickets:r,hasNoProblems:i,toggleExpanded:()=>{e.value=!e.value},downloadJSON:()=>{if(!s)return;const g=s.exportToJSON(),v=new Blob([g],{type:"application/json"}),T=URL.createObjectURL(v),f=document.createElement("a");f.href=T,f.download=`dashboard-diagnostics-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(T)},getStageName:g=>xt.getStageName(g)||g}}},j0={key:0,class:"diagnostics-panel"},z0={class:"diagnostics-header"},V0={class:"header-actions"},G0=["title"],K0={key:0,class:"diagnostics-content"},q0={class:"diagnostics-section"},Y0={class:"metrics-grid"},X0={class:"metric-card"},J0={class:"metric-value"},Z0={class:"metric-label"},Q0={class:"metric-value"},eb={class:"metric-detail"},tb={class:"diagnostics-section"},sb={class:"metrics-grid"},ab={class:"metric-card"},ob={class:"metric-value"},nb={class:"metric-card",style:{"border-left-color":"#28a745"}},rb={class:"metric-value"},ib={class:"metric-card",style:{"border-left-color":"#dc3545"}},lb={class:"metric-value"},cb={key:0,class:"metric-detail"},db={key:0,class:"warning-box"},ub={key:1,class:"examples-box"},gb={class:"example-type"},mb={key:0,class:"normalized"},hb={class:"diagnostics-section"},fb={class:"metrics-grid"},vb={class:"metric-card"},pb={class:"metric-value"},yb={class:"metric-card"},kb={class:"metric-value"},bb={class:"metric-card"},_b={class:"metric-value"},wb={class:"diagnostics-section"},Cb={class:"metrics-grid"},Tb={class:"metric-card"},Sb={class:"metric-value"},Db={class:"metric-card",style:{"border-left-color":"#28a745"}},Eb={class:"metric-value"},Ab={class:"metric-card",style:{"border-left-color":"#ffc107"}},$b={class:"metric-value"},Ib={key:0,class:"employees-list"},Mb={class:"diagnostics-section"},Nb={class:"metrics-grid"},xb={class:"metric-label"},Lb={class:"metric-value"},Pb={class:"diagnostics-section problematic-tickets"},Ob={key:0,class:"problem-group"},Bb={class:"tickets-list"},Rb={class:"ticket-id"},Wb={class:"ticket-title"},Ub={class:"ticket-stage"},Fb={key:0,class:"more-items"},Hb={key:1,class:"problem-group"},jb={class:"tickets-list"},zb={class:"ticket-id"},Vb={class:"ticket-title"},Gb={class:"ticket-stage"},Kb={key:0,class:"more-items"},qb={key:2,class:"problem-group"},Yb={class:"tickets-list"},Xb={class:"ticket-id"},Jb={class:"ticket-title"},Zb={class:"ticket-stage"},Qb={key:0,class:"more-items"},e_={key:3,class:"problem-group"},t_={class:"tickets-list"},s_={class:"ticket-id"},a_={class:"ticket-title"},o_={class:"ticket-stage"},n_={key:0,class:"more-items"},r_={key:4,class:"problem-group"},i_={class:"tickets-list"},l_={class:"ticket-id"},c_={class:"ticket-title"},d_={class:"ticket-stage"},u_={key:0,class:"more-items"},g_={key:5,class:"no-problems"};function m_(o,e,s,t,r,i){return s.isEnabled&&s.isUserAdmin?(c(),u("div",j0,[a("div",z0,[e[2]||(e[2]=a("h2",null,"🔍 Диагностика дашборда",-1)),a("div",V0,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.downloadJSON&&t.downloadJSON(...n)),class:"btn-download",title:"Скачать JSON"}," 📥 Скачать JSON "),a("button",{onClick:e[1]||(e[1]=(...n)=>t.toggleExpanded&&t.toggleExpanded(...n)),class:"btn-toggle",title:t.isExpanded?"Свернуть":"Развернуть"},m(t.isExpanded?"▼":"▶"),9,G0)])]),t.isExpanded?(c(),u("div",K0,[a("section",q0,[e[4]||(e[4]=a("h3",null,"📊 Загрузка тикетов",-1)),a("div",Y0,[a("div",X0,[e[3]||(e[3]=a("div",{class:"metric-label"},"Всего загружено",-1)),a("div",J0,m(t.metrics.ticketsLoading.totalLoaded),1)]),(c(!0),u(ee,null,te(t.metrics.ticketsLoading.stages,(n,l)=>(c(),u("div",{key:l,class:"metric-card"},[a("div",Z0,m(t.getStageName(l)),1),a("div",Q0,m(n.total),1),a("div",eb,"Батчей: "+m(n.batches.length),1)]))),128))])]),a("section",tb,[e[10]||(e[10]=a("h3",null,"🔍 Фильтрация по сектору 1С",-1)),a("div",sb,[a("div",ab,[e[5]||(e[5]=a("div",{class:"metric-label"},"Всего тикетов загружено",-1)),a("div",ob,m(t.metrics.filtering.total),1)]),a("div",nb,[e[6]||(e[6]=a("div",{class:"metric-label"},"Прошло фильтр (тег 1С)",-1)),a("div",rb,m(t.metrics.filtering.filtered),1)]),a("div",ib,[e[7]||(e[7]=a("div",{class:"metric-label"},"Отклонено (нет тега 1С)",-1)),a("div",lb,m(t.metrics.filtering.rejected.length),1),t.metrics.filtering.total>0?(c(),u("div",cb,m(Math.round(t.metrics.filtering.rejected.length/t.metrics.filtering.total*100))+"% от всех ",1)):$("",!0)])]),t.metrics.filtering.rejected.length>0?(c(),u("div",db,[e[8]||(e[8]=a("strong",null,"⚠️ Внимание:",-1)),ce(" "+m(t.metrics.filtering.rejected.length)+" тикетов не имеют тега сектора 1С (UF_CRM_7_TYPE_PRODUCT = '1C') и поэтому не отображаются в дашборде. Эти тикеты есть в Bitrix24, но не попали в интерфейс. ",1)])):$("",!0),t.metrics.filtering.tagValueExamples.length>0?(c(),u("div",ub,[e[9]||(e[9]=a("h4",null,"Примеры значений UF_CRM_7_TYPE_PRODUCT:",-1)),a("ul",null,[(c(!0),u(ee,null,te(t.metrics.filtering.tagValueExamples.slice(0,10),(n,l)=>(c(),u("li",{key:l},[a("code",null,m(JSON.stringify(n.value)),1),a("span",gb,"("+m(n.type)+m(n.isArray?", массив":"")+")",1),n.normalized&&n.normalized.length?(c(),u("span",mb," → нормализовано: "+m(n.normalized.join(", ")),1)):$("",!0)]))),128))])])):$("",!0)]),a("section",hb,[e[14]||(e[14]=a("h3",null,"👥 Сотрудники",-1)),a("div",fb,[a("div",vb,[e[11]||(e[11]=a("div",{class:"metric-label"},"Уникальных ID",-1)),a("div",pb,m(t.metrics.employees.totalUnique),1)]),a("div",yb,[e[12]||(e[12]=a("div",{class:"metric-label"},"Без assignedById",-1)),a("div",kb,m(t.metrics.employees.ticketsWithoutAssignedById.length),1)]),a("div",bb,[e[13]||(e[13]=a("div",{class:"metric-label"},"С assignedById=1051",-1)),a("div",_b,m(t.metrics.employees.ticketsWithAssignedById1051.length),1)])])]),a("section",wb,[e[18]||(e[18]=a("h3",null,"📦 Группировка по стадиям",-1)),(c(!0),u(ee,null,te(t.metrics.grouping.distributionByStages,(n,l)=>(c(),u("div",{key:l,class:"stage-distribution"},[a("h4",null,m(t.getStageName(l)),1),a("div",Cb,[a("div",Tb,[e[15]||(e[15]=a("div",{class:"metric-label"},"Всего тикетов в стадии",-1)),a("div",Sb,m(n.total||0),1)]),a("div",Db,[e[16]||(e[16]=a("div",{class:"metric-label"},"Внутри сектора 1С",-1)),a("div",Eb,m(n.insideSector||0),1)]),a("div",Ab,[e[17]||(e[17]=a("div",{class:"metric-label"},"Вне сектора 1С",-1)),a("div",$b,m(n.outsideSector||0),1)])]),Object.keys(n.employees||{}).length>0?(c(),u("div",Ib,[(c(!0),u(ee,null,te(n.employees,(d,g)=>(c(),u("div",{key:g,class:"employee-item"}," Сотрудник #"+m(g)+": "+m(d)+" тикетов ",1))),128))])):$("",!0)]))),128))]),a("section",Mb,[e[19]||(e[19]=a("h3",null,"🎯 Нулевая точка",-1)),a("div",Nb,[(c(!0),u(ee,null,te(t.metrics.zeroPoint.byStage,(n,l)=>(c(),u("div",{key:l,class:"metric-card"},[a("div",xb,m(t.getStageName(l)),1),a("div",Lb,m(n),1)]))),128))])]),a("section",Pb,[e[20]||(e[20]=a("h3",null,"⚠️ Проблемные тикеты",-1)),t.problematicTickets.withoutAssignedById.length>0?(c(),u("div",Ob,[a("h4",null,"Без assignedById ("+m(t.problematicTickets.withoutAssignedById.length)+")",1),a("div",Bb,[(c(!0),u(ee,null,te(t.problematicTickets.withoutAssignedById.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[a("span",Rb,"#"+m(n.id),1),a("span",Wb,m(n.title),1),a("span",Ub,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withoutAssignedById.length>10?(c(),u("div",Fb," ... и ещё "+m(t.problematicTickets.withoutAssignedById.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withAssignedById1051.length>0?(c(),u("div",Hb,[a("h4",null,"С assignedById=1051 ("+m(t.problematicTickets.withAssignedById1051.length)+")",1),a("div",jb,[(c(!0),u(ee,null,te(t.problematicTickets.withAssignedById1051.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[a("span",zb,"#"+m(n.id),1),a("span",Vb,m(n.title),1),a("span",Gb,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withAssignedById1051.length>10?(c(),u("div",Kb," ... и ещё "+m(t.problematicTickets.withAssignedById1051.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withoutSectorTag.length>0?(c(),u("div",qb,[a("h4",null,"Без/неверный тег сектора ("+m(t.problematicTickets.withoutSectorTag.length)+")",1),a("div",Yb,[(c(!0),u(ee,null,te(t.problematicTickets.withoutSectorTag.slice(0,10),n=>(c(),u("div",{key:n.id||n.ID,class:"ticket-item"},[a("span",Xb,"#"+m(n.id||n.ID),1),a("span",Jb,m(n.title||n.TITLE||"Без названия"),1),a("span",Zb,m(t.getStageName(n.stageId||n.STAGE_ID)),1)]))),128)),t.problematicTickets.withoutSectorTag.length>10?(c(),u("div",Qb," ... и ещё "+m(t.problematicTickets.withoutSectorTag.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.notInColumn.length>0?(c(),u("div",e_,[a("h4",null,"Не попали в колонку ("+m(t.problematicTickets.notInColumn.length)+")",1),a("div",t_,[(c(!0),u(ee,null,te(t.problematicTickets.notInColumn.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[a("span",s_,"#"+m(n.id),1),a("span",a_,m(n.title),1),a("span",o_,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.notInColumn.length>10?(c(),u("div",n_," ... и ещё "+m(t.problematicTickets.notInColumn.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.unknownStage.length>0?(c(),u("div",r_,[a("h4",null,"Неизвестная стадия ("+m(t.problematicTickets.unknownStage.length)+")",1),a("div",i_,[(c(!0),u(ee,null,te(t.problematicTickets.unknownStage.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[a("span",l_,"#"+m(n.id),1),a("span",c_,m(n.title),1),a("span",d_,"Стадия: "+m(n.stageId),1)]))),128)),t.problematicTickets.unknownStage.length>10?(c(),u("div",u_," ... и ещё "+m(t.problematicTickets.unknownStage.length-10),1)):$("",!0)])])):$("",!0),t.hasNoProblems?(c(),u("div",g_," ✅ Проблемных тикетов не обнаружено ")):$("",!0)])])):$("",!0)])):$("",!0)}const h_=de(H0,[["render",m_],["__scopeId","data-v-74a5e138"]]);function f_(){const o=I(!1),e=I(null),s=I([{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}]),t=I({formed:[],review:[],execution:[]}),r=I([]),i=I(null);return{isLoading:o,error:e,stages:s,zeroPointTickets:t,employees:r,draggedTicket:i,updateState:v=>{v.stages&&(s.value=v.stages),v.employees&&(r.value=v.employees),v.zeroPointTickets&&(t.value=v.zeroPointTickets)},resetState:()=>{o.value=!1,e.value=null,s.value=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}],t.value={formed:[],review:[],execution:[]},r.value=[],i.value=null},updateLocalStateAfterMove:(v,T,f)=>{const p=s.value.find(S=>S.employees.some(C=>C.tickets.some(k=>k.id===v.id)));if(p){const S=p.employees.find(C=>C.tickets.some(k=>k.id===v.id));S&&(S.tickets=S.tickets.filter(C=>C.id!==v.id))}const y=s.value.find(S=>S.id===f);if(y){const S=y.employees.find(C=>C.id===T);if(S){const C={...v,assigneeId:T,stageId:f};S.tickets.push(C)}}Object.keys(t.value).forEach(S=>{t.value[S]=t.value[S].filter(C=>C.id!==v.id)})},getEmployeeTickets:(v,T)=>{const f=s.value.find(y=>y.id===T);if(!f)return[];const p=f.employees.find(y=>y.id===v);return p?p.tickets||[]:[]}}}const gt={fadeOutDuration:400,fadeInDuration:400,delayBetween:150,readyDisplayTime:800,fadeOutEasing:"ease-out",fadeInEasing:"ease-in",fadeOutTransform:"scale(0.95)",fadeInTransform:"translateY(10px)"},ra={fadeInDuration:400,fadeInEasing:"ease-in"};function Ha(o,e,s="opacity, transform"){return`${s} ${o}ms ${e}`}function v_(){return Ha(gt.fadeOutDuration,gt.fadeOutEasing)}function p_(){return Ha(ra.fadeInDuration,ra.fadeInEasing)}function y_(){const o=I(!1),e=I(null),s=n=>{o.value=!0,e.value=Date.now(),n&&n()},t=n=>{o.value=!1,e.value=null,n&&n()},r=(n,l,d=gt)=>{s(()=>{n&&n(),setTimeout(()=>{l&&l()},d.delayBetween),setTimeout(()=>{t()},d.fadeOutDuration)})},i=M(()=>e.value?Date.now()-e.value:0);return{isTransitioning:M(()=>o.value),startTransition:s,endTransition:t,executeTransition:r,transitionDuration:i}}function k_(o,e=""){if(Logger.error(`API Error ${e?`(${e})`:""}`,"ErrorHandler",o),o.message){if(o.message.includes("HTTP error"))return"Ошибка соединения с сервером. Проверьте подключение к интернету.";if(o.message.includes("timeout"))return"Превышено время ожидания ответа. Попробуйте позже.";if(o.message.includes("403")||o.message.includes("401"))return"Ошибка доступа. Проверьте права доступа.";if(o.message.includes("500"))return"Ошибка на сервере. Обратитесь к администратору."}return o.message||"Произошла неизвестная ошибка"}function b_(o,e="",s={}){const t={message:o.message,stack:o.stack,context:e,...s,timestamp:new Date().toISOString()};Logger.error("Error logged","ErrorHandler",t)}function $s(o,e="",s=null){const t=k_(o,e);b_(o,e),s&&typeof s=="function"?s(t,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:t,autoHideDelay:5e3})}function __(o){const e=ct(),s=Aa(),{isTransitioning:t,executeTransition:r}=y_();function i(p,y){const S=ds(p);S.step&&y.updateStep(S.step,S.details||{}),S.progress!==void 0&&S.progress!==null&&(y.updateProgress(S.progress),y.clearTemporaryError())}const n=async(p=!0)=>{o.isLoading.value=!0,o.error.value=null,s.reset(),s.updateStep("cache_check",{description:"Инициализация загрузки данных..."}),s.updateProgress(0);try{const y=await Bt.getSectorData(p,S=>{i(S,s)});o.updateState(y)}catch(y){o.error.value=y.message,s.setError(y.message),$s(y,"loading sector data",e.error)}finally{if(o.error.value)o.isLoading.value=!1;else{s.updateStep("complete",{description:"Дашборд загружен"}),s.updateProgress(100);const y=gt.readyDisplayTime||800;setTimeout(()=>{r(()=>{},()=>{o.isLoading.value=!1},gt),setTimeout(()=>{s.reset()},gt.fadeOutDuration)},y)}}},l=async(p,y,S)=>{if(!Ua(p,y,S))return e.warning("Нельзя переместить тикет сюда"),!1;try{const C=await Bt.assignTicket(p.id,y,S);return C&&(o.updateLocalStateAfterMove(p,y,S),e.success("Тикет перемещён")),C}catch(C){return $s(C,"assigning ticket",e.error),!1}finally{o.draggedTicket.value=null}};return{loadSectorData:n,assignTicket:l,moveTicketToStage:async(p,y)=>await l(p,p.assigneeId,y),assignTicketToEmployee:async(p,y)=>await l(p,y,p.stageId),createTicket:async p=>{const y=I1(p);if(!y.valid){const S=y.errors.join(", ");return e.error(S),0}try{const S=await Bt.createTicket(p);return S>0&&(await n(!1),e.success("Тикет создан")),S}catch(S){return $s(S,"creating ticket",e.error),0}},handleTicketDragStart:p=>{o.draggedTicket.value=p},handleTicketDrop:async(p,y,S)=>{await l(p,y,S)},loadingProgress:s,isTransitioning:t}}const Hs={name:"DashboardSector1C",components:{DashboardStage:X1,LoadingPreloader:E0,LoggerControl:F0,BackButton:ba,DiagnosticsPanel:h_},setup(){const o=Xe(),e=ps(),s=f_(),t=__(s),r=I(null),i=M(()=>r.value?ts(r.value):!1),n=M(()=>rt(e,r.value)),l=()=>{o.push({name:"dashboard-sector-1c",query:{...e.query,diagnostics:"true"}}),typeof localStorage<"u"&&localStorage.setItem("dashboard-sector-1c-diagnostics","true");const x=Qe();x&&x.reset(),t.loadSectorData(!1)},d=()=>{Oe.invalidateTicketsCache(),Oe.invalidateEmployeesCache(),wa();const x=Qe();x&&x.reset(),t.loadSectorData(!1)};$e(async()=>{try{r.value=await it.getCurrentUser()}catch(x){console.error("Error getting current user:",x),r.value=null}if(n.value){const x=Qe();x&&x.reset()}t.loadSectorData()});const g=v_(),v=p_(),T=`${gt.delayBetween}ms`,f=gt.fadeOutTransform,p=gt.fadeInTransform,y=()=>{t.loadSectorData(!1)},S=()=>{o.push({name:"dashboard-graph-state"})},C=()=>{o.push({name:"dashboard-graph-admission-closure"})},k=()=>{o.push({name:"dashboard-tickets-time-tracking"})},_=()=>{o.push("/")},A=t.loadingProgress,W=M(()=>typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-show-logger-control")==="true":!1);return{isLoading:s.isLoading,error:s.error,stages:s.stages,zeroPointTickets:s.zeroPointTickets,employees:s.employees,draggedTicket:s.draggedTicket,currentStep:A.currentStep,progress:A.progress,stepDetails:A.stepDetails,loadingProgress:A,loadSectorData:t.loadSectorData,handleTicketDragStart:t.handleTicketDragStart,handleTicketDrop:t.handleTicketDrop,assignTicketToEmployee:t.assignTicketToEmployee,moveTicketToStage:t.moveTicketToStage,createTicket:t.createTicket,getEmployeeTickets:s.getEmployeeTickets,showLoggerControl:W,handleRetry:y,isTransitioning:t.isTransitioning,preloaderFadeOutTransition:g,dashboardFadeInTransition:v,transitionDelay:T,preloaderFadeOutTransform:f,dashboardFadeInTransform:p,navigateToGraphState:S,navigateToAdmissionClosure:C,navigateToTimeTracking:k,handleGoHome:_,isDiagnosticsEnabled:n,enableDiagnostics:l,clearCache:d,isUserAdmin:i}}},ia=()=>{io(o=>({e25fa6d4:o.preloaderFadeOutTransition,v2de4400b:o.preloaderFadeOutTransform,v66f66a76:o.dashboardFadeInTransition,e224f3ee:o.transitionDelay,v171b9ffc:o.dashboardFadeInTransform}))},la=Hs.setup;Hs.setup=la?(o,e)=>(ia(),la(o,e)):ia;const w_={class:"dashboard-header"},C_={class:"breadcrumbs-row"},T_={class:"header-actions"},S_={key:0,class:"dashboard-content"},D_={class:"stages-container"};function E_(o,e,s,t,r,i){const n=be("BackButton"),l=be("LoadingPreloader"),d=be("DashboardStage"),g=be("LoggerControl"),v=be("DiagnosticsPanel");return c(),u("div",{class:X(["dashboard-sector-1c",{"is-dragging":t.draggedTicket}])},[a("div",w_,[a("div",C_,[a("button",{class:"btn-home-link",type:"button",onClick:e[0]||(e[0]=(...T)=>t.handleGoHome&&t.handleGoHome(...T)),title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),e[6]||(e[6]=a("span",{class:"breadcrumb-separator"},"/",-1)),e[7]||(e[7]=a("span",{class:"breadcrumb-current"},"Дашборд сектора 1С",-1))]),ne(n,{variant:"header"}),e[13]||(e[13]=a("h1",null,"Дашборд - Сектор 1С",-1)),a("div",T_,[t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...T)=>t.clearCache&&t.clearCache(...T)),class:"btn-clear-cache",title:"Сбросить кеш сектора и тикетов"},[...e[8]||(e[8]=[a("span",{class:"icon"},"♻️",-1),a("span",null,"Сбросить кеш",-1)])])):$("",!0),!t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),u("button",{key:1,onClick:e[2]||(e[2]=(...T)=>t.enableDiagnostics&&t.enableDiagnostics(...T)),class:"btn-enable-diagnostics",title:"Включить диагностический режим"},[...e[9]||(e[9]=[a("span",{class:"icon"},"🔍",-1),a("span",null,"Диагностика",-1)])])):$("",!0),a("button",{onClick:e[3]||(e[3]=(...T)=>t.navigateToGraphState&&t.navigateToGraphState(...T)),class:"btn-navigate-graph-state",title:"Перейти к графику состояния сектора"},[...e[10]||(e[10]=[a("span",{class:"icon"},"📊",-1),a("span",null,"График состояния",-1)])]),a("button",{onClick:e[4]||(e[4]=(...T)=>t.navigateToAdmissionClosure&&t.navigateToAdmissionClosure(...T)),class:"btn-navigate-admission-closure",title:"Перейти к графику приёма и закрытий сектора"},[...e[11]||(e[11]=[a("span",{class:"icon"},"📈",-1),a("span",null,"График приёма и закрытий",-1)])]),a("button",{onClick:e[5]||(e[5]=(...T)=>t.navigateToTimeTracking&&t.navigateToTimeTracking(...T)),class:"btn-navigate-time-tracking",title:"Перейти к трудозатратам на тикеты сектора"},[...e[12]||(e[12]=[a("span",{class:"icon"},"⏱",-1),a("span",null,"Трудозатраты",-1)])])])]),ne(Ae,{name:"preloader-fade"},{default:pe(()=>[t.isLoading||t.error||t.currentStep?(c(),he(l,{key:0,"current-step":t.currentStep,progress:t.progress,"step-details":t.stepDetails,error:t.error||null,onRetry:t.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):$("",!0)]),_:1}),ne(Ae,{name:"dashboard-fade"},{default:pe(()=>[!t.isLoading&&!t.error&&!t.currentStep?(c(),u("div",S_,[a("div",D_,[(c(!0),u(ee,null,te(t.stages,T=>(c(),he(d,{key:T.id,stage:T,"zero-point-tickets":t.zeroPointTickets[T.id]||[],onTicketMoved:t.handleTicketDrop,onTicketAssigned:t.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):$("",!0)]),_:1}),ne(n,{variant:"floating"}),ne(g,{"show-control":t.showLoggerControl},null,8,["show-control"]),ne(v,{"is-enabled":t.isDiagnosticsEnabled,"is-user-admin":t.isUserAdmin},null,8,["is-enabled","is-user-admin"])],2)}const ja=de(Hs,[["render",E_],["__scopeId","data-v-11e84363"]]),za=Object.freeze(Object.defineProperty({__proto__:null,default:ja},Symbol.toStringTag,{value:"Module"})),A_={name:"ModuleAdapter",props:{moduleConfig:{type:Object,required:!0,validator:o=>o.id&&o.title&&o.component},sectorId:{type:String,required:!0},isCompact:{type:Boolean,default:!0}},emits:["module-ready","module-error","module-navigate"],setup(o,{emit:e}){const s=Xe(),t=I(!1),r=I(null),i=I(null),n=I(null),l={SectorDashboard:$a,TicketsTimeTrackingDashboard:Na,GraphStateDashboard:Oa,GraphAdmissionClosureDashboard:Ba,DashboardSector1C:ja},d=M(()=>{const S={isCompact:o.isCompact,sectorId:o.sectorId,moduleId:o.moduleConfig.id};switch(o.moduleConfig.component){case"SectorDashboard":return{sectorId:o.sectorId};case"DashboardSector1C":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphStateDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0,autoLoad:!1};case"TicketsTimeTrackingDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphAdmissionClosureDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};default:return S}}),g=async()=>{try{t.value=!0,r.value=null;const S=o.moduleConfig.component;l[S]?(i.value=l[S],console.log(`[ModuleAdapter] ✅ Loading real component ${S} for module ${o.moduleConfig.id} in sector ${o.sectorId}`),console.log("[ModuleAdapter] Component loaded:",i.value)):(i.value="div",console.log(`[ModuleAdapter] ⚠️ Loading module ${o.moduleConfig.id} for sector ${o.sectorId} - using placeholder (component ${S} not found)`)),e("module-ready",{moduleId:o.moduleConfig.id,sectorId:o.sectorId})}catch(S){console.error(`Failed to load module ${o.moduleConfig.id}:`,S),r.value=S.message,e("module-error",{moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})}finally{t.value=!1}},v=()=>{o.moduleConfig.route?s.push(o.moduleConfig.route):console.warn(`No route defined for module ${o.moduleConfig.id}`)},T=()=>{g()},f=S=>{e("module-navigate",{type:"ready",moduleId:o.moduleConfig.id,sectorId:o.sectorId,data:S})},p=S=>{e("module-navigate",{type:"error",moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})},y=S=>{e("module-navigate",{type:"navigate",moduleId:o.moduleConfig.id,sectorId:o.sectorId,navigation:S})};return $e(()=>{g()}),{isLoading:t,error:r,moduleComponent:i,moduleInstance:n,moduleProps:d,openFullView:v,retryLoad:T,onModuleReady:f,onModuleError:p,onModuleNavigate:y}}},$_={class:"module-header"},I_={class:"module-icon"},M_={class:"module-info"},N_={class:"module-actions"},x_=["aria-label"],L_={class:"module-content"},P_={key:0,class:"module-loading"},O_={key:1,class:"module-error"},B_={key:2,class:"module-body"},R_={class:"module-placeholder"},W_={class:"placeholder-icon"};function U_(o,e,s,t,r,i){return c(),u("div",{class:X(["sector-module-adapter",`module-${s.moduleConfig.id}`])},[a("div",$_,[a("div",I_,m(s.moduleConfig.icon),1),a("div",M_,[a("h3",null,m(s.moduleConfig.title),1),a("p",null,m(s.moduleConfig.description),1)]),a("div",N_,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-module-fullscreen",title:"Открыть в полном размере","aria-label":`Открыть ${s.moduleConfig.title} в полном размере`}," ⛶ ",8,x_)])]),a("div",L_,[t.isLoading?(c(),u("div",P_,[e[3]||(e[3]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,"Загрузка "+m(s.moduleConfig.title)+"...",1)])):t.error?(c(),u("div",O_,[e[4]||(e[4]=a("div",{class:"error-icon"},"⚠️",-1)),e[5]||(e[5]=a("p",null,"Ошибка загрузки модуля",-1)),a("button",{onClick:e[1]||(e[1]=(...n)=>t.retryLoad&&t.retryLoad(...n)),class:"btn-retry"},"Повторить")])):(c(),u("div",B_,[a("div",R_,[a("div",W_,m(s.moduleConfig.icon),1),a("h4",null,m(s.moduleConfig.title),1),a("p",null,m(s.moduleConfig.description),1),e[6]||(e[6]=a("div",{class:"placeholder-status"},[a("span",{class:"status-badge"},"В разработке"),a("small",null,"Модуль готовится к интеграции")],-1)),a("button",{onClick:e[2]||(e[2]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-open-full"}," Открыть в полном размере ")])]))])],2)}const F_=de(A_,[["render",U_],["__scopeId","data-v-8cd78004"]]),H_={name:"SectorContainer",components:{ModuleAdapter:F_},props:{sectorConfig:{type:Object,required:!0,validator:o=>o.id&&o.name&&o.icon}},emits:["module-ready","module-error","module-event","sector-expanded","sector-collapsed"],setup(o,{emit:e}){Xe();const s=I(!1),t=I(!1),r=I([]),i=M(()=>o.sectorConfig.modules&&o.sectorConfig.modules.length>0),n=M(()=>!1);$e(async()=>{i.value&&await l()});const l=async()=>{t.value=!0;try{r.value=o.sectorConfig.modules||[],e("module-ready",{sectorId:o.sectorConfig.id,modulesCount:r.value.length})}catch(p){console.error(`Failed to load modules for sector ${o.sectorConfig.id}:`,p),e("module-error",{sectorId:o.sectorConfig.id,error:p.message})}finally{t.value=!1}};return{expanded:s,loading:t,sectorModules:r,hasModules:i,canNavigateToDashboard:n,toggleExpanded:()=>{s.value=!s.value,s.value?e("sector-expanded",{sectorId:o.sectorConfig.id}):e("sector-collapsed",{sectorId:o.sectorConfig.id})},onModuleReady:p=>{e("module-ready",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,data:p})},onModuleError:p=>{e("module-error",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,error:p.error})},onModuleNavigate:p=>{e("module-event",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,event:p})},navigateToSectorDashboard:()=>{console.log(`Navigate to dashboard for sector: ${o.sectorConfig.id}`)}}}},j_={class:"sector-header"},z_={class:"sector-header-left"},V_={class:"sector-icon"},G_={class:"sector-title"},K_={class:"sector-actions"},q_={key:0,class:"sector-content"},Y_={key:0,class:"sector-loading"},X_={key:1,class:"sector-modules-grid"},J_={key:2,class:"no-modules"},Z_={key:3,class:"sector-dashboard-link"};function Q_(o,e,s,t,r,i){const n=be("ModuleAdapter");return c(),u("div",{class:X(["sector-container",`sector-${s.sectorConfig.id}`])},[a("div",j_,[a("div",z_,[a("div",V_,m(s.sectorConfig.icon),1),a("div",G_,[a("h2",null,m(s.sectorConfig.name),1),a("p",null,m(s.sectorConfig.description),1)])]),a("div",K_,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.toggleExpanded&&t.toggleExpanded(...l)),class:"btn-toggle-sector"},m(t.expanded?"Свернуть":"Развернуть"),1)])]),t.expanded?(c(),u("div",q_,[t.loading?(c(),u("div",Y_,[e[3]||(e[3]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,"Загрузка сектора "+m(s.sectorConfig.name)+"...",1)])):t.sectorModules.length>0?(c(),u("div",X_,[(c(!0),u(ee,null,te(t.sectorModules,l=>(c(),he(n,{key:l.id,"module-config":l,"sector-id":s.sectorConfig.id,"is-compact":!0,onModuleReady:t.onModuleReady,onModuleError:t.onModuleError,onModuleNavigate:t.onModuleNavigate},null,8,["module-config","sector-id","onModuleReady","onModuleError","onModuleNavigate"]))),128))])):(c(),u("div",J_,[a("p",null,'Модули для сектора "'+m(s.sectorConfig.name)+'" находятся в разработке',1),t.canNavigateToDashboard?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[4]||(e[4]=[a("span",{class:"icon"},"📊",-1),ce(" Открыть полный дашборд сектора ",-1)])])):$("",!0)])),t.sectorModules.length>0&&t.canNavigateToDashboard?(c(),u("div",Z_,[a("button",{onClick:e[2]||(e[2]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[5]||(e[5]=[a("span",{class:"icon"},"📊",-1),ce(" Открыть полный дашборд сектора ",-1)])])])):$("",!0)])):$("",!0)],2)}const ew=de(H_,[["render",Q_],["__scopeId","data-v-0fa90bab"]]);class is{static async logAppEntry(e,s=null){if(!e||!e.ID)return console.warn("[ActivityLoggingService] Invalid user object for app entry logging"),!1;const t={timestamp:new Date().toISOString(),type:"app_entry",user_id:e.ID,user_name:this.getUserName(e),user_email:e.EMAIL||null,ip:s||this.getClientIp(),user_agent:navigator.userAgent,session_id:this.getSessionId()};return await this.saveLog(t)}static async logPageVisit(e,s,t=null){if(!s||!s.ID)return console.warn("[ActivityLoggingService] Invalid user object for page visit logging"),!1;if(!e||!e.path)return console.warn("[ActivityLoggingService] Invalid route object for page visit logging"),!1;const r={timestamp:new Date().toISOString(),type:"page_visit",user_id:s.ID,user_name:this.getUserName(s),route_path:e.path,route_name:e.name||null,route_title:e.meta?.title||null,from_path:t?.path||null,from_name:t?.name||null,session_id:this.getSessionId()};return await this.saveLog(r)}static async saveLog(e){try{const s=tt("/api/user-activity-log.php"),t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e),signal:AbortSignal.timeout(5e3)});if(!t.ok){const i=await t.text();return console.error("[ActivityLoggingService] Failed to save log:",{status:t.status,statusText:t.statusText,error:i}),!1}const r=await t.json();return r.success?!0:(console.error("[ActivityLoggingService] API returned error:",r.error),!1)}catch(s){return s.name==="AbortError"?console.warn("[ActivityLoggingService] Request timeout (activity logging skipped)"):console.error("[ActivityLoggingService] Error saving log:",s),!1}}static getSessionId(){const e="activity_session_id";if(sessionStorage.getItem(e))return sessionStorage.getItem(e);const s=this.generateSessionId();return sessionStorage.setItem(e,s),s}static generateSessionId(){const e=Date.now(),s=Math.random().toString(36).substring(2,11);return`${e}-${s}`}static getUserName(e){const s=e.NAME||"",t=e.LAST_NAME||"";return`${s} ${t}`.trim()||e.EMAIL||`User #${e.ID}`}static getClientIp(){return null}static isAppEntryLogged(){return sessionStorage.getItem("app_entry_logged")==="true"}static markAppEntryLogged(){sessionStorage.setItem("app_entry_logged","true")}}const tw={reports:[{id:1,title:"Отчёт по тикетам",icon:"📊",route:"/reports/tickets",description:"Статистика по тикетам и обращениям",active:!1},{id:2,title:"Отчёт по производительности",icon:"📈",route:"/reports/performance",description:"Анализ производительности работы отдела",active:!1},{id:3,title:"Отчёт по срокам",icon:"📉",route:"/reports/deadlines",description:"Анализ соблюдения сроков выполнения задач",active:!1},{id:4,title:"Сводный отчёт",icon:"📋",route:"/reports/summary",description:"Общая сводка по всем показателям",active:!1},{id:5,title:"Дашборд сектора 1С",icon:"📋",route:"/dashboard/sector-1c",description:"Управление тикетами сектора 1С",active:!0},{id:6,title:"График состояния",icon:"📊",route:"/dashboard/graph-state",description:"Визуализация изменений состояния сектора 1С во времени",active:!0,category:"analytics",order:6},{id:7,title:"График приёма/закрытий 1С",icon:"📈",route:"/dashboard/graph-admission-closure",description:"Недельные новые и закрытые тикеты сектора 1С",active:!0,category:"analytics",order:7},{id:8,title:"Трудозатраты на Тикеты сектора 1С",icon:"⏱",route:"/dashboard/tickets-time-tracking",description:"Трудозатраты сотрудников сектора 1С по неделям",active:!0,category:"analytics",order:8}]};function sw(){return tw.reports.filter(o=>o.active===!0)}const aw={adminInterfaces:[{id:1,title:"Управление пользователями",icon:"👥",route:"/admin/users",description:"Управление доступом пользователей к приложению"},{id:2,title:"Настройки системы",icon:"⚙️",route:"/admin/settings",description:"Конфигурация системы и параметров приложения"},{id:3,title:"Логи вебхуков",icon:"📋",route:"/admin/webhook-logs",description:"Просмотр и анализ логов вебхуков"},{id:4,title:"Статистика использования",icon:"📊",route:"/admin/usage-stats",description:"Аналитика использования приложения"},{id:5,title:"Ручное управление кешем",icon:"🗑️",route:"/admin/cache",description:"Управление кешем модулей приложения"}]};function ow(){return[...aw.adminInterfaces]}const Kt={sector1c:{id:"1c",name:"Сектор 1С",description:"Модули для работы с системами 1С:Предприятие",icon:"⚙️",color:"#007bff",borderColor:"#0056b3",backgroundColor:"#f8f9fa",filterValue:"1C",modules:[{id:"dashboard-sector-1c",title:"Дашборд сектора 1С",description:"Панель управления сектором 1С с основными метриками",icon:"⚙️",component:"SectorDashboard",route:"/dashboard/sector-1c",category:"management"},{id:"tickets-management-sector-1c",title:"Управление тикетами сектора 1С",description:"Управление заявками и задачами сектора 1С",icon:"📋",component:"TicketsTimeTrackingDashboard",route:"/tickets/time-tracking",category:"tickets"},{id:"state-chart",title:"График состояния",description:"Визуализация текущего состояния систем сектора 1С",icon:"📊",component:"GraphStateDashboard",route:"/graph/state",category:"analytics"},{id:"changes-visualization",title:"Визуализация изменений сост",description:"Отображение изменений состояния в секторе 1С",icon:"📈",component:"GraphAdmissionClosureDashboard",route:"/graph/admission-closure",category:"analytics"}],features:["smart-process-140","1c-integration"],order:1},sectorPdm:{id:"pdm",name:"Сектор PDM",description:"Управление системами PDM (Product Data Management)",icon:"🔧",color:"#28a745",borderColor:"#1e7e34",backgroundColor:"#f8fff8",filterValue:"PDM",modules:[{id:"dashboard-sector-pdm",title:"Дашборд сектора PDM",description:"Панель управления сектором PDM с основными метриками",icon:"🔧",component:"SectorDashboard",route:"/dashboard/sector-pdm",category:"management"}],features:["pdm-integration"],order:2},sectorBitrix24:{id:"bitrix24",name:"Сектор Битрикс24",description:"Управление и поддержка Битрикс24",icon:"🌐",color:"#ffc107",borderColor:"#d39e00",backgroundColor:"#fffef8",filterValue:"Bitrix24",modules:[{id:"dashboard-sector-bitrix24",title:"Дашборд сектора Битрикс24",description:"Панель управления сектором Битрикс24 с основными метриками",icon:"🌐",component:"SectorDashboard",route:"/dashboard/sector-bitrix24",category:"management"}],features:["bitrix24-integration"],order:3},sectorInfrastructure:{id:"infrastructure",name:"Сектор Железо/Инфраструктура",description:"Управление инфраструктурой, оборудованием и прочими задачами",icon:"🖥️",color:"#dc3545",borderColor:"#bd2130",backgroundColor:"#fff8f8",filterValues:["Железо","Прочее"],modules:[{id:"dashboard-sector-infrastructure",title:"Дашборд сектора Инфраструктура",description:"Панель управления сектором Инфраструктура с основными метриками",icon:"🖥️",component:"SectorDashboard",route:"/dashboard/sector-infrastructure",category:"management"}],features:["infrastructure-management"],order:4}};class nw{static getAllSectors(){return Object.values(Kt).sort((e,s)=>(e.order||0)-(s.order||0))}static getSectorById(e){return Kt[e]||null}static getSectorsWithModules(){return this.getAllSectors().filter(e=>e.modules&&e.modules.length>0)}static getSectorColors(){const e={};return Object.values(Kt).forEach(s=>{e[s.id]=s.color}),e}static sectorExists(e){return Object.values(Kt).some(s=>s.id===e)}static getNextOrder(){return Math.max(...Object.values(Kt).map(s=>s.order||0))+1}}const rw={name:"IndexPage",components:{StatusMessage:ks,LoadingSpinner:bs,SectorContainer:ew},beforeCreate(){console.log("[IndexPage] beforeCreate() called")},created(){console.log("[IndexPage] created() called")},beforeMount(){console.log("[IndexPage] beforeMount() called")},setup(){console.log("[IndexPage] setup() called");const o=Xe(),e=I(!0),s=I(null),t=I(!1),r=I(!1),i=I(""),n=I(null),l=I(null),d=I(!1);console.log("[IndexPage] Initial state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value});const g=I(sw()),v=I(nw.getAllSectors()),T=I(!1),f=I(ow()),p=M(()=>n.value?ts(n.value):!1),y=M(()=>{if(!n.value)return"Пользователь";const U=n.value.FIRST_NAME?n.value.FIRST_NAME.trim():"",G=n.value.LAST_NAME?n.value.LAST_NAME.trim():"",q=n.value.NAME?n.value.NAME.trim():"";return U&&G?`${U} ${G}`:q&&G&&q!==G?`${q} ${G}`:U&&q&&U!==q?`${U} ${q}`:q&&q.includes(" ")?q:U||G||q||`Пользователь #${n.value.ID}`}),S=M(()=>s.value?s.value.includes("no_install_app")?"Приложение не установлено":"Ошибка API":null),C=M(()=>s.value?s.value.includes("no_install_app")?"Приложение не установлено в Bitrix24. Необходимо выполнить установку.":s.value:null),k=M(()=>s.value&&s.value.includes("no_install_app")),_=M(()=>ya("/install.php"));$e(async()=>{console.log("[IndexPage] onMounted() called");try{console.log("[IndexPage] Calling AccessControlService.checkAccess()...");const U=await it.checkAccess();if(console.log("[IndexPage] Access result:",{allowed:U.allowed,hasUser:!!U.user,user:U.user,errorCode:U.errorCode,errorMessage:U.errorMessage}),U.allowed){if(console.log("[IndexPage] Setting accessAllowed to true"),t.value=!0,n.value=U.user,console.log("[IndexPage] Access allowed, setting state:",{accessAllowed:t.value,hasUser:!!n.value,loading:e.value,accessDenied:r.value}),!is.isAppEntryLogged())try{U.user&&await is.logAppEntry(U.user)&&is.markAppEntryLogged()}catch(G){console.error("[IndexPage] Error logging app entry:",G)}}else{r.value=!0;const G=Ot(),q=!G&&U.errorCode===nt.ACCESS_DENIED&&U.errorMessage&&U.errorMessage.includes("Прямой доступ");if(console.log("IndexPage - accessResult:",{errorCode:U.errorCode,errorMessage:U.errorMessage,isInsideB24:G,isDirectAccessDeniedCheck:q}),d.value=q,q&&(i.value=U.errorMessage,console.log("IndexPage - Set direct access denied message:",U.errorMessage)),console.log("IndexPage - State after check:",{accessDenied:r.value,isDirectAccessDenied:d.value,accessErrorMessage:i.value}),!q){if(U.user){const{getAllowedDepartmentIds:oe}=await Ee(async()=>{const{getAllowedDepartmentIds:Y}=await import("./access-config-async-UCYEgjZx.js");return{getAllowedDepartmentIds:Y}},__vite__mapDeps([6,7,4,2,3,0,1]),import.meta.url);l.value={userId:U.user.ID,departmentIds:U.user.UF_DEPARTMENT||[],allowedIds:oe()}}U.errorCode===nt.USER_NOT_DETERMINED?i.value="Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.":U.errorCode===nt.ACCESS_DENIED?i.value="Доступ запрещён":i.value=U.errorMessage||"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел."}}}catch(U){s.value=U.message,console.error("Error checking access:",U)}finally{e.value=!1,console.log("[IndexPage] Final state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value,hasUser:!!n.value,error:s.value})}});const A=U=>{if(!U){console.error("Route is not defined for report");return}o.push(U)},W=()=>{T.value=!0},x=()=>{T.value=!1};return{loading:e,error:s,accessAllowed:t,accessDenied:r,accessErrorMessage:i,currentUser:n,userName:y,debugInfo:l,isDirectAccessDenied:d,errorTitle:S,errorMessage:C,showInstallLink:k,installPageUrl:_,reportsButtons:g,navigateToReport:A,sectors:v,handleModuleEvent:U=>{console.log("Module event:",U)},handleSectorExpanded:U=>{console.log("Sector expanded:",U.sectorId)},handleSectorCollapsed:U=>{console.log("Sector collapsed:",U.sectorId)},isAdmin:p,showAdminPopup:T,adminButtons:f,openAdminPopup:W,closeAdminPopup:x,navigateToAdmin:U=>{if(!U){console.error("Route is not defined for admin interface");return}o.push(U),x()}}}},iw={class:"index-page"},lw={class:"container"},cw={key:0,class:"install-link"},dw=["href"],uw={key:0,class:"direct-access-denied-info",style:{"margin-top":"15px",padding:"15px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px"}},gw={key:1,class:"debug-info",style:{"margin-top":"15px",padding:"10px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px","font-size":"12px"}},mw={key:3,class:"main-content"},hw={class:"greeting-section"},fw={class:"greeting-header"},vw={class:"greeting-header-content"},pw={class:"greeting-text"},yw={class:"sectors-section"},kw={class:"admin-popup-header"},bw={class:"admin-popup-content"},_w={class:"admin-buttons-grid"},ww=["onClick"],Cw={class:"admin-icon"},Tw={class:"admin-title"},Sw={key:0,class:"admin-description"};function Dw(o,e,s,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner"),d=be("SectorContainer");return c(),u("div",iw,[a("div",lw,[t.error?(c(),he(n,{key:0,type:"error",title:t.errorTitle,message:t.errorMessage},{default:pe(()=>[t.showInstallLink?(c(),u("div",cw,[a("a",{href:t.installPageUrl},"Установить приложение",8,dw)])):$("",!0)]),_:1},8,["title","message"])):$("",!0),t.loading?(c(),he(l,{key:1,message:"Проверка доступа..."})):$("",!0),!t.loading&&t.accessDenied?(c(),he(n,{key:2,type:"error",title:"Доступ запрещён",message:t.accessErrorMessage},{default:pe(()=>[t.isDirectAccessDenied?(c(),u("div",uw,[...e[4]||(e[4]=[a("p",{style:{margin:"0 0 10px 0","font-weight":"600",color:"#856404"}},[a("strong",null,"Как открыть приложение:")],-1),a("ol",{style:{margin:"0","padding-left":"20px",color:"#856404"}},[a("li",null,"Войдите в Bitrix24"),a("li",null,"Откройте приложение через интерфейс Bitrix24 (placement, виджет или вкладку)")],-1)])])):t.debugInfo?(c(),u("div",gw,[e[5]||(e[5]=a("strong",null,"Отладочная информация:",-1)),e[6]||(e[6]=a("br",null,null,-1)),ce(" ID пользователя: "+m(t.debugInfo.userId),1),e[7]||(e[7]=a("br",null,null,-1)),ce(" ID отделов пользователя: "+m(t.debugInfo.departmentIds),1),e[8]||(e[8]=a("br",null,null,-1)),ce(" Разрешённые ID отделов: "+m(t.debugInfo.allowedIds),1),e[9]||(e[9]=a("br",null,null,-1)),e[10]||(e[10]=a("small",{style:{color:"#856404"}},"Добавьте ID отдела в файл vue-app/src/config/access-config.js",-1))])):$("",!0)]),_:1},8,["message"])):$("",!0),!t.loading&&!t.accessDenied&&t.accessAllowed?(c(),u("div",mw,[a("div",hw,[a("div",fw,[a("div",vw,[e[13]||(e[13]=a("h2",{class:"greeting-title"},"Страница Аналитики ИТ отдела для Планерки Генеральной дирекции",-1)),a("p",pw,[e[11]||(e[11]=ce(" Добро пожаловать, ",-1)),a("strong",null,m(t.userName),1),e[12]||(e[12]=ce("! ",-1))])]),t.isAdmin?(c(),u("button",{key:0,class:"admin-button-header",onClick:e[0]||(e[0]=(...g)=>t.openAdminPopup&&t.openAdminPopup(...g)),title:"Администрирование"}," ⚙️ ")):$("",!0)])]),a("div",yw,[(c(!0),u(ee,null,te(t.sectors,g=>(c(),he(d,{key:g.id,"sector-config":g,onModuleEvent:t.handleModuleEvent,onSectorExpanded:t.handleSectorExpanded,onSectorCollapsed:t.handleSectorCollapsed},null,8,["sector-config","onModuleEvent","onSectorExpanded","onSectorCollapsed"]))),128))]),t.showAdminPopup&&t.isAdmin?(c(),u("div",{key:0,class:"admin-popup-overlay",onClick:e[3]||(e[3]=(...g)=>t.closeAdminPopup&&t.closeAdminPopup(...g))},[a("div",{class:"admin-popup",onClick:e[2]||(e[2]=Ce(()=>{},["stop"]))},[a("div",kw,[e[14]||(e[14]=a("h3",{class:"admin-popup-title"},"⚙️ Администрирование",-1)),a("button",{class:"admin-popup-close",onClick:e[1]||(e[1]=(...g)=>t.closeAdminPopup&&t.closeAdminPopup(...g))}," ✕ ")]),a("div",bw,[a("div",_w,[(c(!0),u(ee,null,te(t.adminButtons,g=>(c(),u("div",{key:g.id,class:"admin-interface-button",onClick:v=>t.navigateToAdmin(g.route)},[a("div",Cw,m(g.icon),1),a("div",Tw,m(g.title),1),g.description?(c(),u("div",Sw,m(g.description),1)):$("",!0)],8,ww))),128))])])])])):$("",!0)])):$("",!0)])])}const Ew=de(rw,[["render",Dw],["__scopeId","data-v-12137466"]]),Ze=I(new Map),at=I({hits:0,misses:0,sets:0,invalidations:0}),Is={defaultTTL:5*60*1e3,maxSize:100,enableStats:!0};function Aw(o={}){const{ttl:e=Is.defaultTTL,maxSize:s=Is.maxSize,enableStats:t=Is.enableStats}=o,r=C=>{const k=new WeakSet;return JSON.stringify(C,(_,A)=>{if(typeof A=="object"&&A!==null){if(k.has(A))return"[Circular]";k.add(A)}return typeof A=="function"||A===void 0?null:A})},i=(C,k={})=>{const _=Object.keys(k).sort().reduce((A,W)=>{const x=k[W];if(x==null)A[W]=null;else if(typeof x=="object")try{A[W]=r(x)}catch{A[W]=String(x)}else A[W]=x;return A},{});try{return`${C}_${r(_)}`}catch{const W=Object.keys(_).sort().map(x=>`${x}=${_[x]}`).join("&");return`${C}_${W}`}},n=C=>{const k=Ze.value.get(C);return k?Date.now()-k.timestamp>k.ttl?(Ze.value.delete(C),t&&at.value.misses++,null):(k.lastAccessed=Date.now(),t&&at.value.hits++,k.data):(t&&at.value.misses++,null)},l=(C,k,_=null)=>{Ze.value.size>=s&&d(),Ze.value.set(C,{data:k,timestamp:Date.now(),lastAccessed:Date.now(),ttl:_||e}),t&&at.value.sets++},d=()=>{let C=null,k=1/0;for(const[_,A]of Ze.value.entries())A.lastAccessed<k&&(k=A.lastAccessed,C=_);C&&Ze.value.delete(C)},g=()=>{Ze.value.clear(),t&&(at.value={hits:0,misses:0,sets:0,invalidations:0})},v=C=>{const k=typeof C=="string"?new RegExp(C):C;let _=0;for(const A of Ze.value.keys())k.test(A)&&(Ze.value.delete(A),_++);return t&&(at.value.invalidations+=_),_},T=()=>{const C=Date.now();let k=0;for(const[_,A]of Ze.value.entries())C-A.timestamp>A.ttl&&(Ze.value.delete(_),k++);return k},f=()=>{const C=at.value.hits+at.value.misses,k=C>0?(at.value.hits/C*100).toFixed(2):0;return{...at.value,size:Ze.value.size,hitRate:`${k}%`}};let p=null;const y=(C=5*60*1e3)=>{p&&clearInterval(p),p=setInterval(()=>{T()},C)},S=()=>{p&&(clearInterval(p),p=null)};return y(),{get:n,set:l,clear:g,invalidate:v,cleanup:T,getCacheKey:i,getStats:f,startAutoCleanup:y,stopAutoCleanup:S}}function mt(o){if(!o||typeof o!="object"||!o.timestamp||typeof o.timestamp!="string"||!o.event||typeof o.event!="string"||!o.category||typeof o.category!="string"||!["tasks","smart-processes","errors"].includes(o.category))return!1;try{new Date(o.timestamp)}catch{return!1}return!0}function $w(o){if(!o||typeof o!="object")return!1;for(const[e,s]of Object.entries(o))if(typeof s=="function")return!1;return!0}function Ht(o){if(!mt(o))return null;const e={timestamp:o.timestamp,event:o.event,category:o.category};return o.ip&&typeof o.ip=="string"&&(e.ip=o.ip),o.payload&&typeof o.payload=="object"&&(e.payload=o.payload),o.details&&$w(o.details)&&(e.details=o.details),e}function js(o){return Array.isArray(o)?o.map(e=>Ht(e)).filter(e=>e!==null):[]}const{get:Iw,set:Mw,getCacheKey:Nw,invalidate:ca}=Aw({ttl:2*60*1e3,maxSize:50});class da{static getBaseUrl(){return tt("/api/webhook-logs.php")}static get BASE_URL(){return this.getBaseUrl()}static async getLogs(e={},s=1,t=50,r=!1){if(s<1)throw new Error("Page must be greater than 0");if(t<1||t>1e3)throw new Error("Limit must be between 1 and 1000");const i={category:e.category||null,event:e.event||null,date:e.date||null,hour:e.hour!==void 0?e.hour:null,dateFrom:e.dateFrom||null,dateTo:e.dateTo||null,ip:e.ip||null,status:e.status||null},n=this.getBaseUrl(),l=Nw(n,{filters:i,page:s,limit:t});if(!r){const g=Iw(l);if(g)return console.log("[WebhookLogsApiService] Cache hit:",l.substring(0,50)+"..."),g}console.log("[WebhookLogsApiService] Cache miss:",l.substring(0,50)+"...");const d=new URLSearchParams({page:s.toString(),limit:t.toString()});i.category&&d.append("category",i.category),i.event&&d.append("event",i.event),i.date&&d.append("date",i.date),i.hour!==null&&d.append("hour",i.hour.toString()),i.dateFrom&&d.append("dateFrom",i.dateFrom),i.dateTo&&d.append("dateTo",i.dateTo),i.ip&&d.append("ip",i.ip),i.status&&d.append("status",i.status);try{const g=this.getBaseUrl(),v=await fetch(`${g}?${d.toString()}`);if(!v.ok){const y=await v.text();let S;try{S=JSON.parse(y)}catch{S={error:y}}throw new Error(S.error_description||S.error||`HTTP error! status: ${v.status}`)}const T=await v.json();if(console.log("[WebhookLogsApiService] API response:",{success:T.success,logsCount:T.logs?.length||0,pagination:T.pagination,hasError:!!T.error}),T.error)throw new Error(T.error_description||T.error);if(!T.success)throw console.warn("[WebhookLogsApiService] API returned success=false:",T),new Error("API request failed");if(!Array.isArray(T.logs))throw console.error("[WebhookLogsApiService] Invalid logs format:",T.logs),new Error("Invalid logs format: expected array");const f=js(T.logs);(!T.pagination||typeof T.pagination!="object")&&(console.warn("[WebhookLogsApiService] Invalid pagination format:",T.pagination),T.pagination={page:s,limit:t,total:f.length,pages:Math.ceil(f.length/t)});const p={success:!0,logs:f,pagination:{page:T.pagination.page||s,limit:T.pagination.limit||t,total:T.pagination.total||f.length,pages:T.pagination.pages||Math.ceil((T.pagination.total||f.length)/t)}};return Mw(l,p),p}catch(g){throw console.error("[WebhookLogsApiService] Error:",g),g}}static invalidateCacheOnFilterChange(e={},s={}){const t=ca(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Invalidated ${t} entries on filter change`)}static clearCache(){const e=ca(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Cleared ${e} entries`)}static async getLogDetails(e,s=null){const t={};return s&&(t.date=s),(await this.getLogs(t,1,1e3)).logs.find(n=>`${n.timestamp}_${n.event}`===e)||null}static async getErrors(e={},s=1,t=50){return this.getLogs({...e,category:"errors"},s,t)}static async getStats(e={}){const s=await this.getLogs(e,1,1e3),t={total:s.pagination.total||s.logs.length,tasks:0,smartProcesses:0,errors:0,byEvent:{},byDate:{}};return s.logs.forEach(r=>{r.category==="tasks"?t.tasks++:r.category==="smart-processes"?t.smartProcesses++:r.category==="errors"&&t.errors++,t.byEvent[r.event]||(t.byEvent[r.event]=0),t.byEvent[r.event]++;const i=r.timestamp.split("T")[0];t.byDate[i]||(t.byDate[i]=0),t.byDate[i]++}),t}}function xw(){const o=ps(),e=Xe(),s=new Date().toISOString().split("T")[0],t=I({category:null,event:null,dateFrom:s,dateTo:null,hour:null,ip:null,search:null,status:null}),r=()=>{const g=o.query;t.value={category:g.category||null,event:g.event||null,dateFrom:g.dateFrom||g.date||s,dateTo:g.dateTo||null,hour:g.hour?parseInt(g.hour):null,ip:g.ip||null,search:g.search||null,status:g.status||null}},i=g=>{if(d)return;const v={...o.query};Object.keys(g).forEach(f=>{const p=g[f];p!==null&&p!==""&&p!==void 0?v[f]=p.toString():delete v[f]}),JSON.stringify(v)!==JSON.stringify(o.query)&&(d=!0,e.replace({path:o.path,query:v}).finally(()=>{setTimeout(()=>{d=!1},100)}))},n=g=>{const v={...t.value,...g};JSON.stringify(t.value)!==JSON.stringify(v)&&(t.value=v,i(t.value))},l=()=>{t.value={category:null,event:null,dateFrom:s,dateTo:null,hour:null,ip:null,search:null,status:null},i(t.value)};$e(()=>{r()});let d=!1;return Ne(()=>o.query,(g,v)=>{if(d)return;JSON.stringify(g)!==JSON.stringify(v)&&r()},{deep:!0}),{filters:t,updateFilters:n,clearFilters:l,loadFiltersFromUrl:r}}function Lw(o,e,s={}){if(!e||!e.trim())return o;const{caseSensitive:t=!1,searchInEvent:r=!0,searchInPayload:i=!0,searchInDetails:n=!0,searchInIp:l=!0,searchInTimestamp:d=!1}=s,g=t?e.trim():e.trim().toLowerCase();return o.filter(v=>{if(r&&v.event&&(t?v.event:v.event.toLowerCase()).includes(g))return!0;if(i&&v.payload)try{const T=JSON.stringify(v.payload);if((t?T:T.toLowerCase()).includes(g))return!0}catch(T){console.warn("Error searching in payload:",T)}if(n&&v.details)try{const T=JSON.stringify(v.details);if((t?T:T.toLowerCase()).includes(g))return!0}catch(T){console.warn("Error searching in details:",T)}return!!(l&&v.ip&&(t?v.ip:v.ip.toLowerCase()).includes(g)||d&&v.timestamp&&(t?v.timestamp:v.timestamp.toLowerCase()).includes(g))})}function Ps(o){if(!o||typeof o!="object"||o.category!==void 0&&o.category!==null&&!["tasks","smart-processes","errors"].includes(o.category)||o.date!==void 0&&o.date!==null&&!/^\d{4}-\d{2}-\d{2}$/.test(o.date))return!1;if(o.hour!==void 0&&o.hour!==null){const e=parseInt(o.hour,10);if(isNaN(e)||e<0||e>23)return!1}return!(o.ip!==void 0&&o.ip!==null&&(typeof o.ip!="string"||o.ip.length===0))}function Pw(o){if(!o||typeof o!="object")return!1;const e=parseInt(o.page,10),s=parseInt(o.limit,10),t=parseInt(o.total,10),r=parseInt(o.pages,10);return!(isNaN(e)||e<1||isNaN(s)||s<1||s>1e3||isNaN(t)||t<0||isNaN(r)||r<0)}function ua(o){if(o==null)return"";const e=String(o),s=e.replace(/"/g,'""');return e.includes(",")||e.includes(`
`)||e.includes('"')?`"${s}"`:s}function Ow(o){return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}function Bw(o,e="webhook-logs.csv",s={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{columns:i=null,onProgress:n=null}=s,l=i||Object.keys(o[0]),g=[l.map(y=>ua(y)).join(",")],v=o.length,T=1e3;for(let y=0;y<v;y+=T){const S=o.slice(y,y+T);if(S.forEach(C=>{const k=l.map(_=>{const A=C[_];return ua(Ow(A))});g.push(k.join(","))}),n){const C=Math.min(100,Math.round((y+S.length)/v*100));n(C)}}const f="\uFEFF"+g.join(`
`),p=new Blob([f],{type:"text/csv;charset=utf-8;"});Va(p,e),n&&n(100),t()}catch(i){r(i)}})}function Rw(o,e="webhook-logs.json",s={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{pretty:i=!0,onProgress:n=null}=s,l=i?JSON.stringify(o,null,2):JSON.stringify(o);n&&n(50);const d=new Blob([l],{type:"application/json;charset=utf-8;"});Va(d,e),n&&n(100),t()}catch(i){r(i)}})}function Va(o,e){const s=URL.createObjectURL(o),t=document.createElement("a");t.href=s,t.download=e,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t),URL.revokeObjectURL(s)},100)}function Ww(o,e={},s=0){const t=new Date().toISOString().split("T")[0],r=new Date().toTimeString().split(" ")[0].replace(/:/g,"-");let i=`webhook-logs_${t}_${r}`;const n=[];return e.category&&n.push(`cat-${e.category}`),e.event&&n.push(`evt-${e.event.substring(0,10)}`),e.dateFrom&&n.push(`from-${e.dateFrom}`),e.dateTo&&n.push(`to-${e.dateTo}`),n.length>0&&(i+=`_${n.join("-")}`),s>0&&(i+=`_${s}records`),`${i}.${o}`}function Uw(o){const e=[];if(!Array.isArray(o))return e.push("Данные должны быть массивом"),{valid:!1,errors:e,estimatedSize:0};if(o.length===0)return e.push("Нет данных для экспорта"),{valid:!1,errors:e,estimatedSize:0};const s=JSON.stringify(o).length,t=50*1024*1024;return s>t&&e.push(`Большой объём данных (${Math.round(s/1024/1024)} MB). Экспорт может занять время.`),{valid:e.length===0,errors:e,estimatedSize:s}}function zs(o,e="short"){if(!o)return"—";try{const s=new Date(o);if(isNaN(s.getTime()))return"Invalid date";switch(e){case"short":return s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});case"long":return s.toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});case"relative":return Fw(s);default:return s.toLocaleString("ru-RU")}}catch{return"Invalid date"}}function Fw(o){const s=new Date-o,t=Math.floor(s/1e3),r=Math.floor(t/60),i=Math.floor(r/60),n=Math.floor(i/24);return t<60?"только что":r<60?`${r} ${Ms(r,"минуту","минуты","минут")} назад`:i<24?`${i} ${Ms(i,"час","часа","часов")} назад`:n<7?`${n} ${Ms(n,"день","дня","дней")} назад`:zs(o.toISOString(),"short")}function Ms(o,e,s,t){const r=o%10,i=o%100;return r===1&&i!==11?e:r>=2&&r<=4&&(i<10||i>=20)?s:t}function jt(o){return o?o.replace(/^ON/,"").split(/(?=[A-Z])/).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):"—"}function bt(o){return{tasks:"Задачи","smart-processes":"Смарт-процессы",errors:"Ошибки"}[o]||o}function Vs(o){if(!o||typeof o!="object")return"—";const e=[];if(o.task_id&&e.push(`Задача #${o.task_id}`),o.entity_id&&e.push(`Сущность #${o.entity_id}`),o.task_title&&e.push(`"${o.task_title}"`),o.title&&e.push(`"${o.title}"`),o.comment_text){const s=o.comment_text.length>50?o.comment_text.substring(0,50)+"...":o.comment_text;e.push(`Комментарий: ${s}`)}return e.length>0?e.join(" • "):"—"}const Hw={name:"WebhookLogsExport",props:{logs:{type:Array,default:()=>[]},selectedLogs:{type:Array,default:()=>[]},filters:{type:Object,default:()=>({})},totalCount:{type:Number,default:0}},emits:["export-start","export-complete","export-error"],setup(o,{emit:e}){const s=I(!1),t=I("csv"),r=I("all"),i=I(!0),n=I(!1),l=I(0),d=I([]),g=I(null),v=M(()=>o.selectedLogs.length),T=M(()=>o.logs.length>0||o.totalCount>0),f=M(()=>o.filters.category||o.filters.event||o.filters.dateFrom||o.filters.dateTo),p=M(()=>r.value==="selected"?v.value:o.logs.length||o.totalCount),y=M(()=>r.value==="selected"?v.value>0:T.value),S=()=>{l.value=0,d.value=[],g.value=null,v.value>0?r.value="selected":r.value="all",s.value=!0,k()},C=()=>{n.value||(s.value=!1)},k=()=>{const x=_(),D=Uw(x);d.value=D.errors,g.value=D.estimatedSize},_=()=>(r.value==="selected"?o.selectedLogs:o.logs).map(E=>Ht(E)).filter(E=>mt(E)?!0:(console.warn("[WebhookLogsExport] Skipping invalid log:",E),!1)),A=async()=>{try{n.value=!0,l.value=0;let x=_();if(x.length===0)throw new Error("Нет валидных данных для экспорта");const D=x.map(B=>({timestamp:B.timestamp,event:B.event,category:B.category,ip:B.ip||null,details:B.details||null,payload:B.payload||null,formatted:{timestamp:zs(B.timestamp),event:jt(B.event),category:bt(B.category),details:Vs(B.details)}}));e("export-start",{format:t.value,scope:r.value,count:D.length});const E=Ww(t.value,o.filters,D.length),L=B=>{l.value=B};t.value==="csv"?await Bw(D,E,{onProgress:L}):await Rw(D,E,{pretty:i.value,onProgress:L}),e("export-complete",{format:t.value,filename:E,count:D.length}),setTimeout(()=>{n.value=!1,s.value=!1,l.value=0},500)}catch(x){console.error("[WebhookLogsExport] Export error:",x),e("export-error",x),n.value=!1,l.value=0,alert(`Ошибка экспорта: ${x.message}`)}},W=x=>x<1024?`${x} B`:x<1024*1024?`${(x/1024).toFixed(2)} KB`:`${(x/1024/1024).toFixed(2)} MB`;return Ne([r,()=>o.logs,()=>o.selectedLogs],()=>{s.value&&k()}),{showExportModal:s,exportFormat:t,exportScope:r,jsonPretty:i,exporting:n,exportProgress:l,exportWarnings:d,estimatedSize:g,selectedCount:v,hasAllLogs:T,hasFilters:f,exportCount:p,canExport:y,openExportModal:S,closeExportModal:C,handleExport:A,formatSize:W}}},jw={class:"webhook-logs-export"},zw=["disabled","title"],Vw={key:0,class:"selected-badge"},Gw={class:"export-modal-header"},Kw={class:"export-modal-body"},qw={class:"export-section"},Yw={class:"radio-group"},Xw={class:"export-section"},Jw={class:"radio-group"},Zw=["disabled"],Qw={class:"radio-label"},eC={key:0},tC={key:1},sC=["disabled"],aC={class:"radio-label"},oC={key:0,class:"export-section"},nC={class:"checkbox-option"},rC={class:"export-info"},iC={class:"info-item"},lC={class:"info-value"},cC={key:0,class:"info-item"},dC={class:"info-value"},uC={key:1,class:"export-warnings"},gC={key:0,class:"export-progress"},mC={class:"progress-bar"},hC={class:"progress-text"},fC={class:"export-modal-footer"},vC=["disabled"],pC={key:0},yC={key:1},kC=["disabled"];function bC(o,e,s,t,r,i){return c(),u("div",jw,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.openExportModal&&t.openExportModal(...n)),class:"btn-export",disabled:!t.canExport,title:t.canExport?"Экспорт данных":"Нет данных для экспорта"},[e[11]||(e[11]=a("span",{class:"btn-icon"},"📥",-1)),e[12]||(e[12]=a("span",{class:"btn-text"},"Экспорт",-1)),t.selectedCount>0?(c(),u("span",Vw,m(t.selectedCount),1)):$("",!0)],8,zw),ne(Ae,{name:"modal"},{default:pe(()=>[t.showExportModal?(c(),u("div",{key:0,class:"export-modal-overlay",onClick:e[10]||(e[10]=(...n)=>t.closeExportModal&&t.closeExportModal(...n))},[a("div",{class:"export-modal",onClick:e[9]||(e[9]=Ce(()=>{},["stop"]))},[a("div",Gw,[e[13]||(e[13]=a("h3",null,"Экспорт данных",-1)),a("button",{onClick:e[1]||(e[1]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),class:"btn-close"},"✕")]),a("div",Kw,[a("div",qw,[e[16]||(e[16]=a("h4",null,"Формат файла",-1)),a("div",Yw,[a("label",{class:X(["radio-option",{active:t.exportFormat==="csv"}])},[Be(a("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=n=>t.exportFormat=n),value:"csv",class:"radio-input"},null,512),[[Et,t.exportFormat]]),e[14]||(e[14]=a("span",{class:"radio-label"},[a("strong",null,"CSV"),a("small",null,"Для Excel, LibreOffice")],-1))],2),a("label",{class:X(["radio-option",{active:t.exportFormat==="json"}])},[Be(a("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=n=>t.exportFormat=n),value:"json",class:"radio-input"},null,512),[[Et,t.exportFormat]]),e[15]||(e[15]=a("span",{class:"radio-label"},[a("strong",null,"JSON"),a("small",null,"Для разработчиков, API")],-1))],2)])]),a("div",Xw,[e[19]||(e[19]=a("h4",null,"Что экспортировать",-1)),a("div",Jw,[a("label",{class:X(["radio-option",{active:t.exportScope==="all",disabled:!t.hasAllLogs}])},[Be(a("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=n=>t.exportScope=n),value:"all",disabled:!t.hasAllLogs,class:"radio-input"},null,8,Zw),[[Et,t.exportScope]]),a("span",Qw,[e[17]||(e[17]=a("strong",null,"Все записи",-1)),t.hasFilters?(c(),u("small",eC,"С применёнными фильтрами ("+m(t.exportCount)+" записей)",1)):(c(),u("small",tC,"Всего: "+m(t.exportCount)+" записей",1))])],2),a("label",{class:X(["radio-option",{active:t.exportScope==="selected",disabled:t.selectedCount===0}])},[Be(a("input",{type:"radio","onUpdate:modelValue":e[5]||(e[5]=n=>t.exportScope=n),value:"selected",disabled:t.selectedCount===0,class:"radio-input"},null,8,sC),[[Et,t.exportScope]]),a("span",aC,[e[18]||(e[18]=a("strong",null,"Выбранные записи",-1)),a("small",null,m(t.selectedCount)+" записей выбрано",1)])],2)])]),t.exportFormat==="json"?(c(),u("div",oC,[e[21]||(e[21]=a("h4",null,"Опции JSON",-1)),a("label",nC,[Be(a("input",{type:"checkbox","onUpdate:modelValue":e[6]||(e[6]=n=>t.jsonPretty=n),class:"checkbox-input"},null,512),[[ys,t.jsonPretty]]),e[20]||(e[20]=a("span",{class:"checkbox-label"},"Красивое форматирование (с отступами)",-1))])])):$("",!0),a("div",rC,[a("div",iC,[e[22]||(e[22]=a("span",{class:"info-label"},"Записей к экспорту:",-1)),a("span",lC,m(t.exportCount),1)]),t.estimatedSize?(c(),u("div",cC,[e[23]||(e[23]=a("span",{class:"info-label"},"Примерный размер:",-1)),a("span",dC,m(t.formatSize(t.estimatedSize)),1)])):$("",!0)]),t.exportWarnings.length>0?(c(),u("div",uC,[(c(!0),u(ee,null,te(t.exportWarnings,(n,l)=>(c(),u("div",{key:l,class:"warning-item"}," ⚠️ "+m(n),1))),128))])):$("",!0)]),t.exporting?(c(),u("div",gC,[a("div",mC,[a("div",{class:"progress-fill",style:we({width:`${t.exportProgress}%`})},null,4)]),a("div",hC," Экспорт: "+m(t.exportProgress)+"% ",1)])):$("",!0),a("div",fC,[a("button",{onClick:e[7]||(e[7]=(...n)=>t.handleExport&&t.handleExport(...n)),disabled:t.exporting||!t.canExport,class:"btn-primary"},[t.exporting?(c(),u("span",pC,"Экспорт...")):(c(),u("span",yC,"Экспортировать"))],8,vC),a("button",{onClick:e[8]||(e[8]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),disabled:t.exporting,class:"btn-secondary"}," Отмена ",8,kC)])])])):$("",!0)]),_:1})])}const _C=de(Hw,[["render",bC],["__scopeId","data-v-7ae66f8c"]]),wC={name:"WebhookLogSearch",props:{modelValue:{type:String,default:""}},emits:["update:modelValue","search"],setup(o,{emit:e}){const s=I(o.modelValue||""),t=I(!1),r=I(null),i=Ku(p=>{t.value=!1,e("search",p)},400),n=()=>{t.value=!0,e("update:modelValue",s.value),i(s.value)},l=()=>{t.value=!1,e("search",s.value)},d=()=>{s.value="",t.value=!1,r.value=null,e("update:modelValue",""),e("search","")};return Ne(()=>o.modelValue,p=>{p!==s.value&&(s.value=p)}),{searchQuery:s,isSearching:t,searchResultsCount:r,handleSearchInput:n,handleSearch:l,clearSearch:d,setResultsCount:p=>{r.value=p},getResultsText:p=>{const y=p%10,S=p%100;return S>=11&&S<=19?"записей":y===1?"запись":y>=2&&y<=4?"записи":"записей"},performSearch:(p,y)=>{if(!p||!y||!Array.isArray(y))return[];const S=p.toLowerCase().trim();return S.length===0?y:y.map(k=>Ht(k)).filter(k=>mt(k)).filter(k=>{if(k.event&&k.event.toLowerCase().includes(S)||k.category&&k.category.toLowerCase().includes(S)||k.ip&&k.ip.toLowerCase().includes(S)||k.details&&typeof k.details=="object"&&(k.details.task_id&&String(k.details.task_id).includes(S)||k.details.task_title&&k.details.task_title.toLowerCase().includes(S)||k.details.entity_id&&String(k.details.entity_id).includes(S)||k.details.title&&k.details.title.toLowerCase().includes(S)||k.details.comment_text&&k.details.comment_text.toLowerCase().includes(S)))return!0;if(k.payload&&typeof k.payload=="object")try{if(JSON.stringify(k.payload).toLowerCase().includes(S))return!0}catch{}return!1})},formatSearchResult:p=>{const y=[];if(p.event&&y.push(jt(p.event)),p.category&&y.push(bt(p.category)),p.details){const S=Vs(p.details);S!=="—"&&y.push(S)}return y.join(" • ")}}}},CC={class:"webhook-search"},TC={class:"search-wrapper"},SC={key:0,class:"search-indicator"},DC={key:1,class:"search-results"};function EC(o,e,s,t,r,i){return c(),u("div",CC,[a("div",TC,[e[5]||(e[5]=a("span",{class:"search-icon"},"🔍",-1)),Be(a("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>t.searchQuery=n),type:"text",placeholder:"Поиск по содержимому логов (событие, payload, IP, детали)...",class:"search-input",onInput:e[1]||(e[1]=(...n)=>t.handleSearchInput&&t.handleSearchInput(...n)),onKeyup:[e[2]||(e[2]=Re((...n)=>t.handleSearch&&t.handleSearch(...n),["enter"])),e[3]||(e[3]=Re((...n)=>t.clearSearch&&t.clearSearch(...n),["esc"]))]},null,544),[[At,t.searchQuery]]),t.searchQuery?(c(),u("button",{key:0,onClick:e[4]||(e[4]=(...n)=>t.clearSearch&&t.clearSearch(...n)),class:"clear-button",title:"Очистить поиск (Esc)","aria-label":"Очистить поиск"}," ✕ ")):$("",!0)]),t.isSearching?(c(),u("div",SC,[...e[6]||(e[6]=[a("span",{class:"spinner"},null,-1),ce(" Поиск... ",-1)])])):$("",!0),t.searchQuery&&t.searchResultsCount!==null?(c(),u("div",DC," Найдено: "+m(t.searchResultsCount)+" "+m(t.getResultsText(t.searchResultsCount)),1)):$("",!0)])}const AC=de(wC,[["render",EC],["__scopeId","data-v-db228863"]]);function $C(o,e=null){const s=()=>{try{const n=localStorage.getItem(o);return n?JSON.parse(n):e}catch(n){return console.error(`Error loading ${o} from localStorage:`,n),e}},t=n=>{try{localStorage.setItem(o,JSON.stringify(n))}catch(l){console.error(`Error saving ${o} to localStorage:`,l)}},r=()=>{try{localStorage.removeItem(o)}catch(n){console.error(`Error clearing ${o} from localStorage:`,n)}},i=I(s());return Ne(i,n=>{t(n)},{deep:!0}),{value:i,save:t,load:s,clear:r}}const IC={name:"WebhookLogFilters",props:{filters:{type:Object,required:!0}},emits:["update:filters","reset"],setup(o,{emit:e}){const s=I(null),t=$C("webhook-filters",{category:null,event:null,dateFrom:null,dateTo:null,hour:null,ip:null,status:null}),r=E=>(s.value=null,Ps(E)?(e("update:filters",E),!0):(s.value="Некорректные параметры фильтрации",console.error("[WebhookLogFilters] Validation error:",s.value),!1)),i=new Date().toISOString().split("T")[0],n=I({category:t.value.category||o.filters.category||null,event:t.value.event||o.filters.event||null,dateFrom:t.value.dateFrom||o.filters.dateFrom||o.filters.date||i,dateTo:t.value.dateTo||o.filters.dateTo||null,hour:t.value.hour!==void 0?t.value.hour:o.filters.hour!==void 0?o.filters.hour:null,ip:t.value.ip||o.filters.ip||null,status:t.value.status||o.filters.status||null}),l=I(null),d=[{id:"today",label:"Сегодня",getDates:()=>({from:i,to:i})},{id:"yesterday",label:"Вчера",getDates:()=>{const E=new Date;E.setDate(E.getDate()-1);const L=E.toISOString().split("T")[0];return{from:L,to:L}}},{id:"last7days",label:"Последние 7 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-7),{from:E.toISOString().split("T")[0],to:i}}},{id:"last30days",label:"Последние 30 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-30),{from:E.toISOString().split("T")[0],to:i}}}],g=E=>{const L=d.find(B=>B.id===E);if(L){const B=L.getDates();n.value.dateFrom=B.from,n.value.dateTo=B.to,l.value=E,x()}};Ne(()=>o.filters,E=>{n.value={category:E.category||null,event:E.event||null,dateFrom:E.dateFrom||E.date||i,dateTo:E.dateTo||null,hour:E.hour!==void 0?E.hour:null,ip:E.ip||null,status:E.status||null}},{deep:!0}),Ne(n,E=>{t.value={...E},e("update:filters",{...E})},{deep:!0});const v=M(()=>{const E={};return n.value.category&&(E.category=n.value.category),n.value.event&&(E.event=n.value.event),n.value.hour!==null&&(E.hour=n.value.hour),n.value.ip&&(E.ip=n.value.ip),n.value.status&&(E.status=n.value.status),n.value.dateFrom&&n.value.dateFrom!==i&&(E.dateFrom=n.value.dateFrom),n.value.dateTo&&(E.dateTo=n.value.dateTo),E}),T=M(()=>Object.keys(v.value).length>0),f=E=>({category:"Категория",event:"Событие",hour:"Час",ip:"IP адрес",status:"Статус",dateFrom:"Дата от",dateTo:"Дата до"})[E]||E,p=(E,L)=>E==="category"?bt(L)||L:E==="hour"?`${String(L).padStart(2,"0")}:00`:E==="event"?jt(L)||L:E==="status"&&{success:"Успешно",error:"Ошибка",warning:"Предупреждение"}[L]||L,y=M(()=>[{value:null,label:"Все категории"},{value:"tasks",label:bt("tasks")},{value:"smart-processes",label:bt("smart-processes")},{value:"errors",label:bt("errors")}]),S=M(()=>[{value:null,label:"Все события"},...["ONTASKADD","ONTASKUPDATE","ONTASKDELETE","ONTASKCOMMENTADD","ONTASKCOMMENTUPDATE","ONTASKCOMMENTDELETE","ONCRMDYNAMICITEMADD","ONCRMDYNAMICITEMUPDATE","ONCRMDYNAMICITEMDELETE"].map(L=>({value:L,label:jt(L)}))]),C=E=>{E==="hour"?n.value[E]=null:E==="dateFrom"?n.value[E]=i:n.value[E]=null,l.value=null},k=E=>{const L={...n.value,category:E||null};r(L)&&(n.value.category=E)},_=E=>{const L={...n.value,event:E||null};r(L)&&(n.value.event=E)},A=(E,L)=>{if(E&&!/^\d{4}-\d{2}-\d{2}$/.test(E)){console.error("[WebhookLogFilters] Invalid date format:",E),s.value="Некорректный формат даты";return}const B={...n.value,[L]:E||null};r(B)&&(n.value[L]=E)},W=E=>{if(E!=null){const B=parseInt(E,10);if(isNaN(B)||B<0||B>23){console.error("[WebhookLogFilters] Invalid hour:",E),s.value="Некорректный час (должен быть от 0 до 23)";return}}const L={...n.value,hour:E!=null?parseInt(E,10):null};r(L)&&(n.value.hour=E!=null?parseInt(E,10):null)},x=()=>{r({...n.value})},D=()=>{n.value={category:null,event:null,dateFrom:i,dateTo:null,hour:null,ip:null,status:null},l.value=null,t.clear(),e("reset")};return $e(()=>{t.value&&Object.keys(t.value).length>0&&e("update:filters",{...t.value})}),{localFilters:n,activeFilters:v,hasActiveFilters:T,getFilterLabel:f,getFilterValue:p,clearFilter:C,handleFilterChange:x,handleCategoryChange:k,handleEventChange:_,handleDateChange:A,handleHourChange:W,handleReset:D,quickFilters:d,activeQuickFilter:l,applyQuickFilter:g,categoryOptions:y,eventOptions:S,validationError:s}}},MC={class:"webhook-log-filters"},NC={key:0,class:"active-filters-indicator"},xC=["onClick"],LC={key:1,class:"validation-error"},PC={class:"quick-filters"},OC=["onClick"],BC={class:"filters-row"},RC={class:"filter-group"},WC=["value"],UC={class:"filter-group"},FC=["value"],HC={class:"filter-group"},jC={class:"filter-group"},zC={class:"filter-group"},VC={class:"filter-group"},GC={class:"filter-group"};function KC(o,e,s,t,r,i){return c(),u("div",MC,[t.hasActiveFilters?(c(),u("div",NC,[e[14]||(e[14]=a("span",{class:"indicator-text"},"Активные фильтры:",-1)),(c(!0),u(ee,null,te(t.activeFilters,(n,l)=>(c(),u("span",{key:l,class:"filter-badge"},[ce(m(t.getFilterLabel(l))+": "+m(t.getFilterValue(l,n))+" ",1),a("button",{onClick:d=>t.clearFilter(l),class:"filter-badge-remove",title:"Удалить фильтр"}," × ",8,xC)]))),128)),a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-clear-all"}," Очистить все ")])):$("",!0),t.validationError?(c(),u("div",LC," ⚠️ "+m(t.validationError),1)):$("",!0),a("div",PC,[e[15]||(e[15]=a("span",{class:"quick-filters-label"},"Быстрые фильтры:",-1)),(c(!0),u(ee,null,te(t.quickFilters,n=>(c(),u("button",{key:n.id,onClick:l=>t.applyQuickFilter(n.id),class:X(["quick-filter-btn",{active:t.activeQuickFilter===n.id}])},m(n.label),11,OC))),128))]),a("div",BC,[a("div",RC,[e[16]||(e[16]=a("label",{for:"category-filter"},"Категория:",-1)),Be(a("select",{id:"category-filter","onUpdate:modelValue":e[1]||(e[1]=n=>t.localFilters.category=n),onChange:e[2]||(e[2]=n=>t.handleCategoryChange(t.localFilters.category)),class:"filter-select"},[(c(!0),u(ee,null,te(t.categoryOptions,n=>(c(),u("option",{key:n.value,value:n.value},m(n.label),9,WC))),128))],544),[[ut,t.localFilters.category]])]),a("div",UC,[e[17]||(e[17]=a("label",{for:"event-filter"},"Тип события:",-1)),Be(a("select",{id:"event-filter","onUpdate:modelValue":e[3]||(e[3]=n=>t.localFilters.event=n),onChange:e[4]||(e[4]=n=>t.handleEventChange(t.localFilters.event)),class:"filter-select"},[(c(!0),u(ee,null,te(t.eventOptions,n=>(c(),u("option",{key:n.value,value:n.value},m(n.label),9,FC))),128))],544),[[ut,t.localFilters.event]])]),a("div",HC,[e[18]||(e[18]=a("label",{for:"date-from-filter"},"Дата от:",-1)),Be(a("input",{id:"date-from-filter","onUpdate:modelValue":e[5]||(e[5]=n=>t.localFilters.dateFrom=n),type:"date",onChange:e[6]||(e[6]=n=>t.handleDateChange(t.localFilters.dateFrom,"dateFrom")),class:"filter-input"},null,544),[[At,t.localFilters.dateFrom]])]),a("div",jC,[e[19]||(e[19]=a("label",{for:"date-to-filter"},"Дата до:",-1)),Be(a("input",{id:"date-to-filter","onUpdate:modelValue":e[7]||(e[7]=n=>t.localFilters.dateTo=n),type:"date",onChange:e[8]||(e[8]=n=>t.handleDateChange(t.localFilters.dateTo,"dateTo")),class:"filter-input"},null,544),[[At,t.localFilters.dateTo]])]),a("div",zC,[e[20]||(e[20]=a("label",{for:"ip-filter"},"IP адрес:",-1)),Be(a("input",{id:"ip-filter","onUpdate:modelValue":e[9]||(e[9]=n=>t.localFilters.ip=n),type:"text",placeholder:"192.168.1.1",onInput:e[10]||(e[10]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-input"},null,544),[[At,t.localFilters.ip]])]),a("div",VC,[e[22]||(e[22]=a("label",{for:"status-filter"},"Статус:",-1)),Be(a("select",{id:"status-filter","onUpdate:modelValue":e[11]||(e[11]=n=>t.localFilters.status=n),onChange:e[12]||(e[12]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-select"},[...e[21]||(e[21]=[a("option",{value:null},"Все статусы",-1),a("option",{value:"success"},"Успешно",-1),a("option",{value:"error"},"Ошибка",-1),a("option",{value:"warning"},"Предупреждение",-1)])],544),[[ut,t.localFilters.status]])]),a("div",GC,[a("button",{onClick:e[13]||(e[13]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-reset"}," Сбросить ")])])])}const qC=de(IC,[["render",KC],["__scopeId","data-v-2a150a46"]]),YC={name:"WebhookLogList",props:{logs:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},error:{type:String,default:null},pagination:{type:Object,default:null},selectedLogs:{type:Array,default:()=>[]}},emits:["select-log","page-change","update:selectedLogs"],setup(o,{emit:e}){const s=M(()=>!o.logs||!Array.isArray(o.logs)?(console.warn("[WebhookLogList] Invalid logs prop:",o.logs),[]):o.logs.map(L=>Ht(L)).filter(L=>mt(L)?!0:(console.warn("[WebhookLogList] Invalid log entry:",L),!1))),t=I("timestamp"),r=I("desc"),i=L=>{t.value===L?r.value=r.value==="asc"?"desc":"asc":(t.value=L,r.value="desc")},n=M(()=>!s.value||s.value.length===0?[]:[...s.value].sort((B,U)=>{let G,q;switch(t.value){case"timestamp":G=new Date(B.timestamp||0).getTime(),q=new Date(U.timestamp||0).getTime();break;case"event":G=(B.event||"").toLowerCase(),q=(U.event||"").toLowerCase();break;case"category":G=(B.category||"").toLowerCase(),q=(U.category||"").toLowerCase();break;case"ip":G=(B.ip||"").toLowerCase(),q=(U.ip||"").toLowerCase();break;default:return 0}return G<q?r.value==="asc"?-1:1:G>q?r.value==="asc"?1:-1:0})),l=L=>t.value!==L?"↕️":r.value==="asc"?"↑":"↓",d=L=>L.category==="errors"?"status-error":"status-success",g=L=>L.category==="errors"?"❌":"✅",v=L=>L.category==="errors"?"Ошибка обработки":"Успешно обработано",T=L=>`${L.timestamp}_${L.event}_${L.ip||"unknown"}`,f=L=>L?zs(L,"short"):"—",p=L=>L?jt(L):"—",y=L=>L?bt(L):"—",S=L=>!L||typeof L!="object"?"—":Vs(L),C=L=>`category-${L}`,k=L=>L?.startsWith("ONTASK")?"event-task":L?.startsWith("ONCRMDYNAMIC")?"event-smart-process":"event-other",_=L=>{e("select-log",L)},A=L=>{L>=1&&L<=o.pagination.pages&&e("page-change",L)},W=L=>o.selectedLogs.some(B=>T(B)===T(L)),x=(L,B)=>{B.stopPropagation();const U=[...o.selectedLogs],G=T(L),q=U.findIndex(oe=>T(oe)===G);B.target.checked?q===-1&&U.push(L):q!==-1&&U.splice(q,1),e("update:selectedLogs",U)},D=L=>{L.target.checked?e("update:selectedLogs",[...o.logs]):e("update:selectedLogs",[])},E=M(()=>s.value.length>0&&s.value.every(L=>W(L)));return Ne(()=>o.logs,L=>{if(L&&Array.isArray(L)){const B=L.filter(U=>!mt(U)).length;B>0&&console.warn(`[WebhookLogList] Received ${B} invalid log entries out of ${L.length}`)}},{immediate:!0}),{validatedLogs:s,sortBy:t,sortOrder:r,sortedLogs:n,handleSort:i,getSortIcon:l,getStatusClass:d,getStatusIcon:g,getStatusTitle:v,getLogId:T,formatTimestamp:f,formatEvent:p,formatCategoryLabel:y,formatDetailsPreview:S,getCategoryClass:C,getEventClass:k,handleLogClick:_,handlePageChange:A,isSelected:W,handleSelectLog:x,handleSelectAll:D,allSelected:E}}},XC={class:"webhook-log-list"},JC={key:0,class:"logs-table-container"},ZC={class:"logs-table"},QC={class:"checkbox-header"},eT=["checked"],tT={class:"sort-icon"},sT={class:"sort-icon"},aT={class:"sort-icon"},oT={class:"sort-icon"},nT=["onClick"],rT=["checked","onChange"],iT=["title"],lT={class:"details-preview"},cT=["onClick"],dT={key:0,class:"pagination"},uT=["disabled"],gT={class:"pagination-info"},mT=["disabled"];function hT(o,e,s,t,r,i){return c(),u("div",XC,[s.logs.length>0?(c(),u("div",JC,[a("table",ZC,[a("thead",null,[a("tr",null,[a("th",QC,[a("input",{type:"checkbox",checked:t.allSelected,onChange:e[0]||(e[0]=(...n)=>t.handleSelectAll&&t.handleSelectAll(...n)),onClick:e[1]||(e[1]=Ce(()=>{},["stop"])),class:"checkbox-input",title:"Выбрать все"},null,40,eT)]),a("th",{onClick:e[2]||(e[2]=n=>t.handleSort("timestamp")),class:X(["sortable",{"sort-asc":t.sortBy==="timestamp"&&t.sortOrder==="asc","sort-desc":t.sortBy==="timestamp"&&t.sortOrder==="desc"}])},[e[9]||(e[9]=ce(" Дата и время ",-1)),a("span",tT,m(t.getSortIcon("timestamp")),1)],2),a("th",{onClick:e[3]||(e[3]=n=>t.handleSort("event")),class:X(["sortable",{"sort-asc":t.sortBy==="event"&&t.sortOrder==="asc","sort-desc":t.sortBy==="event"&&t.sortOrder==="desc"}])},[e[10]||(e[10]=ce(" Тип события ",-1)),a("span",sT,m(t.getSortIcon("event")),1)],2),a("th",{onClick:e[4]||(e[4]=n=>t.handleSort("category")),class:X(["sortable",{"sort-asc":t.sortBy==="category"&&t.sortOrder==="asc","sort-desc":t.sortBy==="category"&&t.sortOrder==="desc"}])},[e[11]||(e[11]=ce(" Категория ",-1)),a("span",aT,m(t.getSortIcon("category")),1)],2),a("th",{onClick:e[5]||(e[5]=n=>t.handleSort("ip")),class:X(["sortable",{"sort-asc":t.sortBy==="ip"&&t.sortOrder==="asc","sort-desc":t.sortBy==="ip"&&t.sortOrder==="desc"}])},[e[12]||(e[12]=ce(" IP ",-1)),a("span",oT,m(t.getSortIcon("ip")),1)],2),e[13]||(e[13]=a("th",null,"Детали",-1)),e[14]||(e[14]=a("th",null,"Действия",-1))])]),a("tbody",null,[(c(!0),u(ee,null,te(t.sortedLogs,n=>(c(),u("tr",{key:t.getLogId(n),onClick:l=>t.handleLogClick(n),class:X(["log-row",{"row-selected":t.isSelected(n)}])},[a("td",{onClick:e[6]||(e[6]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:t.isSelected(n),onChange:l=>t.handleSelectLog(n,l),class:"checkbox-input"},null,40,rT)]),a("td",null,m(t.formatTimestamp(n.timestamp)),1),a("td",null,[a("span",{class:X(["status-indicator",t.getStatusClass(n)]),title:t.getStatusTitle(n)},m(t.getStatusIcon(n)),11,iT),a("span",{class:X(["event-badge",t.getEventClass(n.event)])},m(t.formatEvent(n.event)),3)]),a("td",null,[a("span",{class:X(["category-badge",t.getCategoryClass(n.category)])},m(t.formatCategoryLabel(n.category)),3)]),a("td",null,m(n.ip||"N/A"),1),a("td",null,[a("div",lT,m(t.formatDetailsPreview(n.details)),1)]),a("td",null,[a("button",{onClick:Ce(l=>t.handleLogClick(n),["stop"]),class:"btn-view"}," Просмотр ",8,cT)])],10,nT))),128))])]),s.pagination&&s.pagination.pages>1?(c(),u("div",dT,[a("button",{onClick:e[7]||(e[7]=n=>t.handlePageChange(s.pagination.page-1)),disabled:s.pagination.page<=1,class:"btn-pagination"}," Назад ",8,uT),a("span",gT," Страница "+m(s.pagination.page)+" из "+m(s.pagination.pages)+" (всего: "+m(s.pagination.total)+") ",1),a("button",{onClick:e[8]||(e[8]=n=>t.handlePageChange(s.pagination.page+1)),disabled:s.pagination.page>=s.pagination.pages,class:"btn-pagination"}," Вперёд ",8,mT)])):$("",!0)])):$("",!0)])}const fT=de(YC,[["render",hT],["__scopeId","data-v-fddd3018"]]),vT={name:"LoadingSkeleton",props:{width:{type:[String,Number],default:"100%"},height:{type:[String,Number],default:"20px"},variant:{type:String,default:"rect",validator:o=>["rect","circle","text","table-row"].includes(o)},animated:{type:Boolean,default:!0},borderRadius:{type:String,default:null}},setup(o){return{skeletonStyle:M(()=>{const s={width:typeof o.width=="number"?`${o.width}px`:o.width,height:typeof o.height=="number"?`${o.height}px`:o.height};return o.borderRadius&&(s.borderRadius=o.borderRadius),s})}}},pT={key:0,class:"skeleton-shimmer"};function yT(o,e,s,t,r,i){return c(),u("div",{class:X(["skeleton",[`skeleton-${s.variant}`,{"skeleton-animated":s.animated}]]),style:we(t.skeletonStyle)},[s.animated?(c(),u("div",pT)):$("",!0)],6)}const kT=de(vT,[["render",yT],["__scopeId","data-v-014f86e6"]]),bT={name:"SkeletonLogList",components:{LoadingSkeleton:kT},props:{rows:{type:Number,default:5}},setup(){return{getColumnWidth:e=>["40px","15%","20%","15%","15%","20%","15%"][e-1]||"100%"}}},_T={class:"skeleton-log-list"},wT={class:"skeleton-table-header"};function CT(o,e,s,t,r,i){const n=be("LoadingSkeleton");return c(),u("div",_T,[a("div",wT,[(c(),u(ee,null,te(7,l=>ne(n,{key:l,width:"120px",height:"16px",variant:"text"})),64))]),(c(!0),u(ee,null,te(s.rows,l=>(c(),u("div",{key:l,class:"skeleton-table-row"},[(c(),u(ee,null,te(7,d=>ne(n,{key:d,width:"100%",height:"20px",variant:"text",style:we({width:t.getColumnWidth(d)})},null,8,["style"])),64))]))),128))])}const TT=de(bT,[["render",CT],["__scopeId","data-v-475c4e73"]]),ST={name:"EmptyState",props:{icon:{type:String,default:"📭"},title:{type:String,required:!0},description:{type:String,required:!0},actionLabel:{type:String,default:null},actions:{type:Array,default:null},hints:{type:Array,default:()=>[]},variant:{type:String,default:"default",validator:o=>["default","error","warning","info"].includes(o)}},emits:["action","action-click"]},DT={class:"empty-icon"},ET={class:"empty-title"},AT={class:"empty-description"},$T={key:0,class:"empty-hints"},IT={key:1,class:"empty-actions"},MT=["onClick"];function NT(o,e,s,t,r,i){return c(),u("div",{class:X(["empty-state",`empty-state-${s.variant}`])},[a("div",DT,m(s.icon),1),a("h3",ET,m(s.title),1),a("p",AT,m(s.description),1),s.hints&&s.hints.length>0?(c(),u("div",$T,[(c(!0),u(ee,null,te(s.hints,(n,l)=>(c(),u("div",{key:l,class:"hint-item"}," 💡 "+m(n),1))),128))])):$("",!0),s.actionLabel||s.actions?(c(),u("div",IT,[s.actionLabel?(c(),u("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("action")),class:"btn-primary"},m(s.actionLabel),1)):$("",!0),(c(!0),u(ee,null,te(s.actions,(n,l)=>(c(),u("button",{key:l,onClick:d=>o.$emit("action-click",n.id),class:X(["btn",`btn-${n.variant||"secondary"}`])},m(n.label),11,MT))),128))])):$("",!0)],2)}const xT=de(ST,[["render",NT],["__scopeId","data-v-081c13b9"]]),LT={name:"ErrorDisplay",props:{title:{type:String,default:"Произошла ошибка"},message:{type:String,required:!0},details:{type:String,default:null},severity:{type:String,default:"error",validator:o=>["error","warning","critical"].includes(o)},retryable:{type:Boolean,default:!1}},emits:["retry"],setup(){return{showDetails:I(!1)}}},PT={class:"error-icon"},OT={class:"error-content"},BT={class:"error-title"},RT={class:"error-message"},WT={key:0,class:"error-details"},UT={class:"error-actions"};function FT(o,e,s,t,r,i){return c(),u("div",{class:X(["error-display",`error-${s.severity}`])},[a("div",PT,m(s.severity==="critical"?"🚨":"⚠️"),1),a("div",OT,[a("h4",BT,m(s.title),1),a("p",RT,m(s.message),1),s.details&&t.showDetails?(c(),u("div",WT,[a("pre",null,m(s.details),1)])):$("",!0),a("div",UT,[s.retryable?(c(),u("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("retry")),class:"btn-retry"}," 🔄 Повторить ")):$("",!0),s.details?(c(),u("button",{key:1,onClick:e[1]||(e[1]=n=>t.showDetails=!t.showDetails),class:"btn-details"},m(t.showDetails?"Скрыть":"Показать")+" детали ",1)):$("",!0)])])],2)}const HT=de(LT,[["render",FT],["__scopeId","data-v-3f2f4c14"]]),jT={name:"Notification",props:{notification:{type:Object,required:!0}},emits:["close"],setup(o,{emit:e}){const s=I(100),t=M(()=>o.notification.duration>0);let r=null;const i={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},n=M(()=>i[o.notification.type]||"ℹ️"),l=()=>{e("close")},d=()=>{o.notification.onClick&&o.notification.onClick()};return $e(()=>{if(t.value&&o.notification.duration>0){const g=Date.now(),v=o.notification.duration;r=setInterval(()=>{const T=Date.now()-g;s.value=Math.max(0,100-T/v*100),s.value<=0&&(clearInterval(r),l())},50)}}),st(()=>{r&&clearInterval(r)}),{icon:n,progress:s,showProgress:t,close:l,handleClick:d}}},zT={class:"notification-content"},VT={class:"notification-icon"},GT={class:"notification-message"},KT={key:0,class:"notification-progress"};function qT(o,e,s,t,r,i){return c(),u("div",{class:X(["notification",`notification-${s.notification.type}`]),onClick:e[1]||(e[1]=(...n)=>t.handleClick&&t.handleClick(...n))},[a("div",zT,[a("span",VT,m(t.icon),1),a("span",GT,m(s.notification.message),1)]),a("button",{onClick:e[0]||(e[0]=Ce((...n)=>t.close&&t.close(...n),["stop"])),class:"notification-close"},"✕"),t.showProgress?(c(),u("div",KT,[a("div",{class:"progress-bar",style:we({width:`${t.progress}%`})},null,4)])):$("",!0)],2)}const YT=de(jT,[["render",qT],["__scopeId","data-v-1b602bdf"]]),XT={name:"NotificationContainer",components:{Notification:YT},setup(){const{notifications:o,removeNotification:e}=ct();return{notifications:o,removeNotification:e}}},JT={class:"notification-container"};function ZT(o,e,s,t,r,i){const n=be("Notification");return c(),he(It,{to:"body"},[a("div",JT,[ne(et,{name:"notification",tag:"div"},{default:pe(()=>[(c(!0),u(ee,null,te(t.notifications,l=>(c(),he(n,{key:l.id,notification:l,onClose:d=>t.removeNotification(l.id)},null,8,["notification","onClose"]))),128))]),_:1})])])}const QT=de(XT,[["render",ZT],["__scopeId","data-v-dd8772c8"]]),eS={name:"RealtimeControls",props:{enabled:{type:Boolean,default:!1},connectionState:{type:String,default:"disconnected"},error:{type:String,default:null}},emits:["toggle"],setup(o,{emit:e}){const s=I(o.enabled);Ne(()=>o.enabled,T=>{s.value=T});const t=M(()=>o.connectionState==="connecting"),r=M(()=>!!o.error),i=M(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),n=M(()=>{switch(o.connectionState){case"connected":return"Подключено";case"connecting":return"Подключение...";case"disconnected":return"Отключено";case"error":return"Ошибка соединения";default:return"Неизвестное состояние"}}),l=M(()=>n.value),d=M(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),g=M(()=>o.error?typeof o.error=="string"?o.error:o.error.message?o.error.message:"Неизвестная ошибка":null);return{localEnabled:s,isConnecting:t,hasError:r,statusClass:i,statusText:n,connectionStatusText:l,connectionStatusClass:d,displayError:g,handleToggle:()=>{e("toggle",s.value)}}}},tS={class:"realtime-controls"},sS={class:"control-toggle"},aS=["disabled"],oS={class:"status-text"},nS={key:0,class:"error-message"};function rS(o,e,s,t,r,i){return c(),u("div",tS,[a("label",sS,[Be(a("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=n=>t.localEnabled=n),onChange:e[1]||(e[1]=(...n)=>t.handleToggle&&t.handleToggle(...n)),disabled:t.isConnecting},null,40,aS),[[ys,t.localEnabled]]),e[2]||(e[2]=a("span",{class:"toggle-label"},"Автообновление",-1))]),a("div",{class:X(["status-indicator",t.statusClass])},[e[3]||(e[3]=a("span",{class:"status-dot"},null,-1)),a("span",oS,m(t.statusText),1)],2),t.hasError&&t.displayError?(c(),u("div",nS," ⚠️ "+m(t.displayError),1)):$("",!0)])}const iS=de(eS,[["render",rS],["__scopeId","data-v-af36f073"]]),lS={name:"NewLogsIndicator",props:{count:{type:Number,default:0},newLogs:{type:Array,default:()=>[]}},emits:["apply","dismiss"],setup(o,{emit:e}){const s=(n,l,d,g)=>{const v=n%10,T=n%100;return T>=11&&T<=19?g:v===1?l:v>=2&&v<=4?d:g},t=M(()=>!o.newLogs||!Array.isArray(o.newLogs)||o.newLogs.length===0?[]:o.newLogs.map(l=>Ht(l)).filter(l=>mt(l)).slice(0,5).map(l=>({...l,formatted:{event:jt(l.event),category:bt(l.category)}})));return{pluralize:s,newLogsPreview:t,handleApply:()=>{if(!o.newLogs||o.newLogs.length===0)return;const n=o.newLogs.map(l=>Ht(l)).filter(l=>mt(l));if(n.length===0){console.warn("[NewLogsIndicator] No valid logs to apply");return}e("apply",n)},handleDismiss:()=>{e("dismiss")}}}},cS={key:0,class:"new-logs-indicator"},dS={class:"indicator-content"},uS={class:"indicator-text"},gS={class:"indicator-actions"};function mS(o,e,s,t,r,i){return c(),he(Ae,{name:"slide-down"},{default:pe(()=>[s.count>0?(c(),u("div",cS,[a("div",dS,[e[2]||(e[2]=a("span",{class:"indicator-icon"},"🔔",-1)),a("span",uS,m(s.count)+" "+m(t.pluralize(s.count,"новое событие","новых события","новых событий")),1),a("div",gS,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleApply&&t.handleApply(...n)),class:"btn-apply"}," Применить "),a("button",{onClick:e[1]||(e[1]=(...n)=>t.handleDismiss&&t.handleDismiss(...n)),class:"btn-dismiss"}," ✕ ")])])])):$("",!0)]),_:1})}const hS=de(lS,[["render",mS],["__scopeId","data-v-19791dbc"]]);class fS{constructor(e,s={}){this.url=e,this.options={reconnectInterval:3e3,maxReconnectAttempts:10,reconnectDelay:1e3,lastTimestamp:null,...s},this.eventSource=null,this.listeners=new Map,this.reconnectAttempts=0,this.reconnectTimer=null,this.isManualDisconnect=!1,this.connectionState="disconnected"}updateOptions(e){this.options={...this.options,...e}}connect(){if(this.connectionState==="connected"||this.connectionState==="connecting"){console.warn("[RealtimeService] Already connected or connecting");return}this.isManualDisconnect=!1,this.connectionState="connecting",this.notifyListeners("state-change",{state:this.connectionState});try{let e=this.url;if(!e.startsWith("http://")&&!e.startsWith("https://")){const s=new URL(e,window.location.origin);this.options.lastTimestamp&&s.searchParams.set("last_timestamp",this.options.lastTimestamp),e=s.toString()}else{const s=new URL(e);this.options.lastTimestamp&&s.searchParams.set("last_timestamp",this.options.lastTimestamp),e=s.toString()}console.log("[RealtimeService] Connecting to:",e),this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{console.log("[RealtimeService] EventSource opened"),this.notifyListeners("open",{timestamp:new Date().toISOString()})},this.eventSource.onmessage=s=>{try{const t=JSON.parse(s.data);this.notifyListeners("message",t)}catch(t){console.error("[RealtimeService] Error parsing message:",t)}},this.eventSource.addEventListener("connected",s=>{try{const t=JSON.parse(s.data);console.log("[RealtimeService] Connected event received:",t),this.connectionState="connected",this.reconnectAttempts=0,this.notifyListeners("connected",t),this.notifyListeners("state-change",{state:this.connectionState})}catch(t){console.error("[RealtimeService] Error parsing connected event:",t)}}),this.eventSource.addEventListener("new_logs",s=>{const t=JSON.parse(s.data);if(t.logs&&t.logs.length>0){const r=t.logs[t.logs.length-1];r.timestamp&&(this.options.lastTimestamp=r.timestamp)}this.notifyListeners("new_logs",t)}),this.eventSource.addEventListener("error",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("error",t)}catch{this.notifyListeners("error",{message:"Server error"})}}),this.eventSource.addEventListener("timeout",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("timeout",t)}catch{this.notifyListeners("timeout",{message:"Connection timeout"})}this.reconnect()}),this.eventSource.addEventListener("closed",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("closed",t)}catch{this.notifyListeners("closed",{message:"Connection closed"})}this.isManualDisconnect||this.reconnect()}),this.eventSource.onerror=s=>{console.error("[RealtimeService] Connection error:",s),console.error("[RealtimeService] EventSource readyState:",this.eventSource?.readyState),this.eventSource?.readyState===EventSource.CLOSED?(console.log("[RealtimeService] EventSource closed by server"),this.connectionState="disconnected",this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()):this.eventSource?.readyState===EventSource.CONNECTING?console.log("[RealtimeService] Still connecting..."):(this.connectionState="error",this.notifyListeners("error",{error:s,type:"connection",message:"Failed to connect to realtime stream",readyState:this.eventSource?.readyState}),this.notifyListeners("state-change",{state:this.connectionState}),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.isManualDisconnect||this.reconnect())}}catch(e){console.error("[RealtimeService] Error creating EventSource:",e),this.connectionState="error",this.notifyListeners("error",{error:e,type:"initialization"}),this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()}}reconnect(){if(this.isManualDisconnect)return;if(this.reconnectAttempts>=this.options.maxReconnectAttempts){console.error("[RealtimeService] Max reconnect attempts reached"),this.notifyListeners("max-reconnect-attempts",{attempts:this.reconnectAttempts});return}this.reconnectAttempts++;const e=Math.min(this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),this.options.reconnectInterval);console.log(`[RealtimeService] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.connect()},e)}disconnect(){this.isManualDisconnect=!0,this.connectionState="disconnected",this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.notifyListeners("disconnected",{timestamp:new Date().toISOString()}),this.notifyListeners("state-change",{state:this.connectionState})}on(e,s){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(s)}off(e,s){if(this.listeners.has(e)){const t=this.listeners.get(e),r=t.indexOf(s);r>-1&&t.splice(r,1)}}notifyListeners(e,s){this.listeners.has(e)&&this.listeners.get(e).forEach(t=>{try{t(s)}catch(r){console.error(`[RealtimeService] Error in listener for ${e}:`,r)}})}getState(){return this.connectionState}isConnected(){return this.connectionState==="connected"}}function vS(o,e={}){const{autoConnect:s=!1,enableSound:t=!1,onNewLogs:r=null,validateLogs:i=!0}=e,n=new fS(o,e),l=I("disconnected"),d=I([]),g=I(0),v=I(null),T=I(null),f=I(0),p=M(()=>l.value==="connected"),y=M(()=>l.value==="connecting"),S=M(()=>l.value==="error"),C=M(()=>g.value>0),k=G=>{l.value=G.state,G.state==="connected"&&(f.value=0,T.value=null)},_=G=>{let q=G.logs||[];if(i){q=js(q);const oe=q.filter(Y=>mt(Y));oe.length!==q.length&&console.warn("[useRealtime] Filtered out invalid logs:",q.length-oe.length),q=oe}q.length!==0&&(d.value.push(...q),g.value+=q.length,v.value=new Date().toISOString(),t&&q.length>0&&U(),r&&r(q))},A=G=>{const q=G.message||G.error?.message||"Connection error";T.value=q,l.value="error",console.error("[useRealtime] Error:",G)},W=G=>{console.warn("[useRealtime] Connection timeout:",G)},x=G=>{T.value=`Max reconnect attempts reached (${G.attempts})`,console.error("[useRealtime] Max reconnect attempts:",G)},D=(G={})=>{T.value=null,G.lastTimestamp!==void 0&&n.updateOptions({lastTimestamp:G.lastTimestamp}),n.on("state-change",k),n.on("new_logs",_),n.on("error",A),n.on("timeout",W),n.on("max-reconnect-attempts",x),n.connect()},E=()=>{n.off("state-change",k),n.off("new_logs",_),n.off("error",A),n.off("timeout",W),n.off("max-reconnect-attempts",x),n.disconnect()},L=()=>{d.value=[],g.value=0},B=G=>{G&&Array.isArray(G)&&(G.unshift(...d.value),L())},U=()=>{try{const G=new Audio("/sounds/notification.mp3");G.volume=.3,G.play().catch(q=>{console.warn("[useRealtime] Failed to play sound:",q)})}catch(G){console.warn("[useRealtime] Sound not available:",G)}};return s&&$e(()=>{D()}),st(()=>{E()}),{connectionState:l,isConnected:p,isConnecting:y,hasError:S,newLogs:d,newLogsCount:g,hasNewLogs:C,lastUpdateTime:v,error:T,reconnectAttempts:f,connect:D,disconnect:E,clearNewLogs:L,applyNewLogs:B}}const pS=pa(()=>Ee(()=>import("./WebhookLogsDashboard.vue-2ycfSFAM.js"),__vite__mapDeps([8,7,4,2,3,0,1]),import.meta.url)),yS=pa(()=>Ee(()=>import("./WebhookLogDetails.vue-DDlUTWKd.js"),__vite__mapDeps([9,7,4,2,3,0,1]),import.meta.url)),kS={name:"WebhookLogsPage",components:{WebhookLogsDashboard:pS,WebhookLogsExport:_C,WebhookLogSearch:AC,WebhookLogFilters:qC,WebhookLogList:fT,WebhookLogDetails:yS,SkeletonLogList:TT,EmptyState:xT,ErrorDisplay:HT,NotificationContainer:QT,RealtimeControls:iS,NewLogsIndicator:hS},setup(){const o=Xe(),{success:e,error:s}=ct(),t=I(!1),r=I(!1),i=I(null),n=I(null),l=I([]),d=(N,b=2)=>{if(N==null)return String(N);if(typeof N=="string")return N;const O=(Q,ue=0)=>{if(ue>10)return"[Max Depth]";if(Q==null||typeof Q!="object")return Q;if(Array.isArray(Q))return Q.map(_e=>O(_e,ue+1));const ke={};try{for(const _e in Q)if(Object.prototype.hasOwnProperty.call(Q,_e))try{const K=Q[_e];if(typeof K=="function"||K===void 0)continue;ke[_e]=O(K,ue+1)}catch{ke[_e]="[Error reading property]"}}catch{return"[Error reading object]"}return ke};try{const Q=O(N),ue=new WeakSet;return JSON.stringify(Q,(ke,_e)=>{if(typeof _e=="object"&&_e!==null){if(ue.has(_e))return"[Circular]";ue.add(_e)}return _e},b)}catch(Q){return console.error("[WebhookLogsPage] Error in safeStringify:",Q),`[Error: ${Q.message}]`}},g=I(null),v=I([]),T=I(""),f=I(null),p=I(null),y=I(!1),{connectionState:S,newLogsCount:C,error:k,connect:_,disconnect:A,applyNewLogs:W,clearNewLogs:x}=vS(tt("/api/webhook-realtime.php"),{autoConnect:!1,enableSound:!0,validateLogs:!0,onNewLogs:N=>{console.log("[WebhookLogsPage] New logs received:",N.length),N.length>0&&(l.value.unshift(...N),B.value.total+=N.length,e(`Получено ${N.length} новых событий`))}}),{filters:D,updateFilters:E,clearFilters:L}=xw(),B=I({page:1,limit:50,total:0,pages:0}),U=M(()=>{let N=[...l.value];return T.value&&T.value.trim()&&(N=Lw(N,T.value,{caseSensitive:!1,searchInEvent:!0,searchInPayload:!0,searchInDetails:!0,searchInIp:!0})),D.value.category&&(N=N.filter(b=>b.category===D.value.category)),D.value.event&&(N=N.filter(b=>b.event===D.value.event)),D.value.ip&&(N=N.filter(b=>b.ip&&b.ip.includes(D.value.ip))),D.value.status&&(N=N.filter(b=>D.value.status==="error"?b.category==="errors":D.value.status==="success"?b.category!=="errors":!0)),D.value.dateFrom&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]>=D.value.dateFrom:!1)),D.value.dateTo&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]<=D.value.dateTo:!1)),D.value.hour!==null&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).getHours()===D.value.hour:!1)),N});Ne(U,N=>{f.value&&T.value&&f.value.setResultsCount(N.length)});const G=async()=>{try{await kt.init();const N=await kt.getCurrentUser();if(console.log("[WebhookLogsPage] User data:",N),!N||!N.ID){console.warn("[WebhookLogsPage] User not determined"),n.value=d({error:"User not determined",userId:N?.ID||null,userName:N?`${N.NAME||""} ${N.LAST_NAME||""}`.trim():null}),t.value=!1;return}const b=N?.UF_DEPARTMENT||[];if(console.log("[WebhookLogsPage] User departments:",b),console.log("[WebhookLogsPage] Allowed departments:",Nt.allowedDepartmentIds),b.length>0){const O=b.some(Q=>_a(Q));console.log("[WebhookLogsPage] Has access:",O),t.value=O,O||(n.value=d({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:b,allowedDepartments:Nt.allowedDepartmentIds,message:"User departments do not match allowed departments"}))}else console.warn("[WebhookLogsPage] User has no departments"),n.value=d({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:[],allowedDepartments:Nt.allowedDepartmentIds,message:"User has no departments assigned"}),t.value=!1}catch(N){console.error("[WebhookLogsPage] Error checking access:",N),n.value=d({error:N.message,stack:N.stack}),t.value=!1}},q=M(()=>Nt.allowedDepartmentIds.join(", ")),oe=async(N=!1)=>{if(t.value&&!(Z&&!N)){Z=!0,r.value=!0,i.value=null;try{const b=new Date().toISOString().split("T")[0],O={category:D.value.category||null,event:D.value.event||null,date:D.value.dateFrom||b,hour:D.value.hour!==null&&D.value.hour!==void 0?D.value.hour:null,ip:D.value.ip||null,status:D.value.status||null,dateFrom:D.value.dateFrom||b,dateTo:D.value.dateTo||null};if(!Ps(O))throw new Error("Некорректные параметры фильтрации");console.log("[WebhookLogsPage] Loading logs with filters:",O);const Q=await da.getLogs(O,B.value.page,B.value.limit,N);if(console.log("[WebhookLogsPage] API result:",Q),console.log("[WebhookLogsPage] Logs count:",Q?.logs?.length||0),console.log("[WebhookLogsPage] Pagination:",Q?.pagination),!Q.success)throw new Error(Q.error||"Ошибка загрузки логов");Pw(Q.pagination)?B.value=Q.pagination:(console.warn("[WebhookLogsPage] Invalid pagination format, using defaults"),B.value={page:B.value.page,limit:B.value.limit,total:Q.logs.length,pages:Math.ceil(Q.logs.length/B.value.limit)});const ue=js(Q.logs),ke=ue.filter(_e=>mt(_e));ke.length!==ue.length&&console.warn("[WebhookLogsPage] Filtered out invalid logs:",ue.length-ke.length),l.value=ke,N&&e("Логи обновлены")}catch(b){Y(b)}finally{r.value=!1,Z=!1}}},Y=N=>{console.error("[WebhookLogsPage] API Error:",N),N.status===403?(i.value="Доступ запрещён",s("У вас нет доступа к логам вебхуков")):N.status===404?(i.value="Логи не найдены",s("Логи для указанных фильтров не найдены")):N.status>=500?(i.value="Ошибка сервера",s("Произошла ошибка на сервере. Попробуйте позже.")):(i.value=N.message||"Неизвестная ошибка",s(i.value)),N.status>=500&&(l.value=[])},H=N=>{T.value=N,E({search:N||null})};let Z=!1;const fe=N=>{if(!Ps(N)){s("Некорректные параметры фильтрации");return}const b={category:D.value.category,event:D.value.event,dateFrom:D.value.dateFrom,dateTo:D.value.dateTo,hour:D.value.hour,ip:D.value.ip,status:D.value.status},O={category:N?.category||null,event:N?.event||null,dateFrom:N?.dateFrom||null,dateTo:N?.dateTo||null,hour:N?.hour!==void 0?N.hour:null,ip:N?.ip||null,status:N?.status||null},Q=Object.keys(O).some(ue=>{const ke=b[ue],_e=O[ue];return ke!==_e});if(!(!Q&&!Z)){if(E(O),B.value.page=1,Q)try{da.invalidateCacheOnFilterChange(b,O)}catch(ue){console.error("[WebhookLogsPage] Error invalidating cache:",ue)}Z||(Z=!0,oe(!0).finally(()=>{Z=!1}))}},P=()=>{L(),T.value="",B.value.page=1,oe()},h=N=>{g.value=N},w=()=>{g.value=null},R=N=>{B.value.page=N,oe()},re=()=>{try{o.push("/")}catch(N){console.error("Navigation error:",N),window.location.hash="#/"}},le=N=>{v.value=N},ae=N=>{console.log("Экспорт начат:",N)},me=N=>{console.log("Экспорт завершён:",N),e(`Экспорт завершён: ${N.count} записей в файле ${N.filename}`)},Se=N=>{console.error("Ошибка экспорта:",N),s(`Ошибка экспорта: ${N.message||"Неизвестная ошибка"}`)},Ie=()=>{T.value="",P()},xe=N=>{if(console.log("[WebhookLogsPage] Toggle auto-update:",N),y.value=N,N){let b=null;if(l.value.length>0){const O=l.value[0];O.timestamp&&(b=O.timestamp,console.log("[WebhookLogsPage] Using lastTimestamp:",b))}_({lastTimestamp:b})}else A()},Fe=()=>{W(l.value),e("Новые события применены")},V=()=>{x()};return $e(async()=>{await G(),t.value&&(D.value.search&&(T.value=D.value.search),await oe())}),{hasAccess:t,loading:r,error:i,logs:l,filteredLogs:U,selectedLog:g,selectedLogs:v,filters:D,searchQuery:T,searchComponent:f,pagination:B,previousPeriodStats:p,handleFiltersUpdate:fe,handleFiltersReset:P,handleSearch:H,handleLogSelect:h,handleLogClose:w,handlePageChange:R,handleSelectedLogsUpdate:le,handleExportStart:ae,handleExportComplete:me,handleExportError:Se,handleClearSearch:Ie,autoUpdateEnabled:y,connectionState:S,newLogsCount:C,realtimeError:k,handleToggleAutoUpdate:xe,handleApplyNewLogs:Fe,handleDismissNewLogs:V,allowedDepartmentsText:q,accessDebugInfo:n,goBack:re}}},bS={class:"webhook-logs-page"},_S={class:"page-header"},wS={class:"page-header-top"},CS={key:0,class:"access-denied"},TS={class:"access-denied-content"},SS={class:"access-hint"},DS={key:0,class:"access-debug"},ES={key:1,class:"page-content"},AS={class:"actions-bar"};function $S(o,e,s,t,r,i){const n=be("WebhookLogsDashboard"),l=be("WebhookLogsExport"),d=be("WebhookLogSearch"),g=be("RealtimeControls"),v=be("NewLogsIndicator"),T=be("WebhookLogFilters"),f=be("SkeletonLogList"),p=be("WebhookLogList"),y=be("EmptyState"),S=be("ErrorDisplay"),C=be("WebhookLogDetails"),k=be("NotificationContainer");return c(),u("div",bS,[a("div",_S,[a("div",wS,[a("button",{onClick:e[0]||(e[0]=(..._)=>t.goBack&&t.goBack(..._)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[3]||(e[3]=[a("span",{class:"back-icon","aria-hidden":"true"},"←",-1),a("span",{class:"back-text"},"Назад",-1)])])]),e[4]||(e[4]=a("h1",null,"Логи вебхуков Bitrix24",-1))]),t.hasAccess?(c(),u("div",ES,[ne(n,{logs:t.logs,pagination:t.pagination,"previous-period-stats":t.previousPeriodStats},null,8,["logs","pagination","previous-period-stats"]),a("div",AS,[ne(l,{logs:t.filteredLogs,"selected-logs":t.selectedLogs,filters:t.filters,"total-count":t.filteredLogs.length,onExportStart:t.handleExportStart,onExportComplete:t.handleExportComplete,onExportError:t.handleExportError},null,8,["logs","selected-logs","filters","total-count","onExportStart","onExportComplete","onExportError"]),ne(d,{modelValue:t.searchQuery,"onUpdate:modelValue":e[1]||(e[1]=_=>t.searchQuery=_),onSearch:t.handleSearch,ref:"searchComponent"},null,8,["modelValue","onSearch"])]),ne(g,{enabled:t.autoUpdateEnabled,"connection-state":t.connectionState,error:t.realtimeError,onToggle:t.handleToggleAutoUpdate},null,8,["enabled","connection-state","error","onToggle"]),ne(v,{count:t.newLogsCount,onApply:t.handleApplyNewLogs,onDismiss:t.handleDismissNewLogs},null,8,["count","onApply","onDismiss"]),ne(T,{filters:t.filters,"onUpdate:filters":t.handleFiltersUpdate,onReset:t.handleFiltersReset},null,8,["filters","onUpdate:filters","onReset"]),ne(Ae,{name:"fade"},{default:pe(()=>[t.loading&&t.logs.length===0?(c(),he(f,{key:0,rows:5})):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length>0?(c(),he(p,{key:0,logs:t.filteredLogs,loading:!1,error:null,pagination:t.pagination,"selected-logs":t.selectedLogs,onSelectLog:t.handleLogSelect,onPageChange:t.handlePageChange,"onUpdate:selectedLogs":t.handleSelectedLogsUpdate},null,8,["logs","pagination","selected-logs","onSelectLog","onPageChange","onUpdate:selectedLogs"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length===0?(c(),he(y,{key:0,icon:"📭",title:"Логи не найдены",description:"Логи вебхуков пока отсутствуют. Они появятся здесь после получения событий от Bitrix24.",hints:["Проверьте фильтры по категории и типу события","Убедитесь, что выбран правильный период","Попробуйте очистить все фильтры"],"action-label":"Очистить фильтры",onAction:t.handleFiltersReset},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length>0?(c(),he(y,{key:0,icon:"🔍",title:"Ничего не найдено",description:"По вашему запросу ничего не найдено. Попробуйте изменить параметры поиска или фильтры.",hints:["Проверьте правильность написания поискового запроса","Попробуйте использовать другие фильтры","Очистите поиск и попробуйте снова"],"action-label":"Очистить поиск",onAction:t.handleClearSearch},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:pe(()=>[t.error?(c(),he(S,{key:0,title:"Ошибка загрузки логов",message:t.error,retryable:!0,onRetry:o.loadLogs},null,8,["message","onRetry"])):$("",!0)]),_:1}),t.selectedLog?(c(),u("div",{key:0,class:"modal-overlay",onClick:e[2]||(e[2]=(..._)=>t.handleLogClose&&t.handleLogClose(..._))})):$("",!0),ne(Ae,{name:"modal"},{default:pe(()=>[t.selectedLog?(c(),he(C,{key:0,log:t.selectedLog,onClose:t.handleLogClose},null,8,["log","onClose"])):$("",!0)]),_:1})])):(c(),u("div",CS,[a("div",TS,[e[7]||(e[7]=a("h2",null,"Доступ запрещён",-1)),e[8]||(e[8]=a("p",null,"У вас нет доступа к просмотру логов вебхуков.",-1)),a("p",SS,[e[5]||(e[5]=ce(" Доступ разрешён только пользователям из отделов: ",-1)),a("strong",null,m(t.allowedDepartmentsText),1)]),e[9]||(e[9]=a("p",{class:"access-hint"}," Если вы считаете, что у вас должен быть доступ, обратитесь к администратору системы. ",-1)),t.accessDebugInfo?(c(),u("details",DS,[e[6]||(e[6]=a("summary",null,"Отладочная информация",-1)),a("pre",null,m(t.accessDebugInfo),1)])):$("",!0)])])),ne(k)])}const IS=de(kS,[["render",$S],["__scopeId","data-v-628bf174"]]),MS={name:"DrillDownNavigation",props:{breadcrumbs:{type:Array,default:()=>[],validator:o=>Array.isArray(o)&&o.every(e=>typeof e=="object"&&typeof e.id=="string"&&typeof e.label=="string")},separator:{type:String,default:">"},showBackButton:{type:Boolean,default:!0},additionalActions:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},maxLabelLength:{type:Number,default:30}},emits:["navigate","back","action"],setup(o,{emit:e}){const s=M(()=>o.breadcrumbs.map(d=>({...d,label:r(d.label,o.maxLabelLength)}))),t=M(()=>{const d=s.value;return d.length<=5?d:[d[0],{id:"ellipsis-start",label:"...",isEllipsis:!0},...d.slice(-3)]}),r=(d,g)=>d.length<=g?d:d.substring(0,g-3)+"...";return{visibleBreadcrumbs:t,handleNavigate:d=>{d.action&&e("navigate",d)},handleBack:()=>{e("back")},handleAction:d=>{e("action",d)}}}},NS={class:"drilldown-navigation",role:"navigation","aria-label":"Навигация по разделам управления пользователями"},xS={class:"breadcrumb-list"},LS={key:0,class:"breadcrumb-separator","aria-hidden":"true"},PS=["onClick","onKeydown","aria-label","title"],OS={class:"breadcrumb-text"},BS={key:2,class:"breadcrumb-current-text","aria-current":"page"},RS={class:"breadcrumb-text"},WS={key:3,class:"breadcrumb-loading","aria-label":"Загрузка данных"},US=["aria-label","title"],FS={key:1,class:"breadcrumb-actions"},HS=["onClick","onKeydown","aria-label","title","disabled"],jS={key:1,class:"action-text"};function zS(o,e,s,t,r,i){return c(),u("nav",NS,[a("ol",xS,[(c(!0),u(ee,null,te(s.breadcrumbs,(n,l)=>(c(),u("li",{key:n.id,class:X(["breadcrumb-item",{"breadcrumb-current":l===s.breadcrumbs.length-1,"breadcrumb-interactive":l<s.breadcrumbs.length-1}])},[l>0?(c(),u("span",LS,m(s.separator),1)):$("",!0),l<s.breadcrumbs.length-1&&n.action?(c(),u("button",{key:1,class:"breadcrumb-link",onClick:d=>t.handleNavigate(n),onKeydown:[Re(d=>t.handleNavigate(n),["enter"]),Re(d=>t.handleNavigate(n),["space"])],"aria-label":`Перейти к разделу ${n.label}`,title:`Вернуться к ${n.label}`},[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),a("span",OS,m(n.label),1)],40,PS)):(c(),u("span",BS,[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),a("span",RS,m(n.label),1)])),l===s.breadcrumbs.length-1&&s.isLoading?(c(),u("div",WS,[...e[3]||(e[3]=[a("div",{class:"loading-spinner","aria-hidden":"true"},null,-1)])])):$("",!0)],2))),128))]),s.showBackButton&&s.breadcrumbs.length>1?(c(),u("button",{key:0,class:"back-button",onClick:e[0]||(e[0]=(...n)=>t.handleBack&&t.handleBack(...n)),onKeydown:[e[1]||(e[1]=Re((...n)=>t.handleBack&&t.handleBack(...n),["enter"])),e[2]||(e[2]=Re((...n)=>t.handleBack&&t.handleBack(...n),["space"]))],"aria-label":`Вернуться к ${s.breadcrumbs[s.breadcrumbs.length-2]?.label||"предыдущему разделу"}`,title:`Вернуться к ${s.breadcrumbs[s.breadcrumbs.length-2]?.label||"предыдущему разделу"}`},[...e[4]||(e[4]=[a("svg",{class:"back-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1),a("span",{class:"back-text"},"Назад",-1)])],40,US)):$("",!0),s.additionalActions.length>0?(c(),u("div",FS,[(c(!0),u(ee,null,te(s.additionalActions,n=>(c(),u("button",{key:n.id,class:X(["action-button",n.class]),onClick:l=>t.handleAction(n),onKeydown:[Re(l=>t.handleAction(n),["enter"]),Re(l=>t.handleAction(n),["space"])],"aria-label":n.label,title:n.title||n.label,disabled:n.disabled},[n.icon?(c(),he(wt(n.icon),{key:0,class:"action-icon","aria-hidden":"true"})):$("",!0),n.text?(c(),u("span",jS,m(n.text),1)):$("",!0)],42,HS))),128))])):$("",!0)])}const VS=de(MS,[["render",zS],["__scopeId","data-v-e0da3deb"]]),GS={name:"MetricCard",emits:["click"],props:{metric:{type:Object,default:()=>({})},title:{type:String,required:!0},value:{type:[Number,String],required:!0},unit:{type:String,default:""},subtitle:{type:String,default:""},icon:{type:String,default:""},trend:{type:Number,default:null},trendPeriod:{type:String,default:""},progress:{type:Number,default:null},size:{type:String,default:"medium",validator:o=>["small","medium","large","compact"].includes(o)},interactive:{type:Boolean,default:!1}},computed:{formattedValue(){return typeof this.value=="number"?this.value>=1e6?`${(this.value/1e6).toFixed(1)}M`:this.value>=1e3?`${(this.value/1e3).toFixed(1)}K`:this.value.toLocaleString():this.value}}},KS={class:"metric-header"},qS=["innerHTML"],YS={class:"metric-title"},XS={class:"metric-value-section"},JS={class:"metric-value"},ZS={key:0,class:"metric-unit"},QS={key:0,class:"metric-subtitle"},eD={key:1,class:"metric-trend"},tD={class:"trend-indicator"},sD={key:0,viewBox:"0 0 24 24",width:"12",height:"12"},aD={key:1,viewBox:"0 0 24 24",width:"12",height:"12"},oD={key:2,viewBox:"0 0 24 24",width:"12",height:"12"},nD={class:"trend-value"},rD={class:"trend-period"},iD={key:2,class:"metric-progress"},lD={class:"progress-bar"},cD={class:"progress-text"};function dD(o,e,s,t,r,i){return c(),u("div",{class:X(["metric-card",{[`size-${s.size}`]:!0,"has-trend":s.trend!==null,"trend-up":s.trend>0,"trend-down":s.trend<0,"trend-neutral":s.trend===0,interactive:s.interactive}]),onClick:e[0]||(e[0]=n=>s.interactive?o.$emit("click",s.metric):null)},[a("div",KS,[s.icon?(c(),u("div",{key:0,class:"metric-icon",innerHTML:s.icon},null,8,qS)):$("",!0),a("div",YS,m(s.title),1)]),a("div",XS,[a("div",JS,m(i.formattedValue),1),s.unit?(c(),u("div",ZS,m(s.unit),1)):$("",!0)]),s.subtitle?(c(),u("div",QS,m(s.subtitle),1)):$("",!0),s.trend!==null?(c(),u("div",eD,[a("div",tD,[s.trend>0?(c(),u("svg",sD,[...e[1]||(e[1]=[a("path",{d:"M7 14l5-5 5 5z",fill:"currentColor"},null,-1)])])):s.trend<0?(c(),u("svg",aD,[...e[2]||(e[2]=[a("path",{d:"M7 10l5 5 5-5z",fill:"currentColor"},null,-1)])])):(c(),u("svg",oD,[...e[3]||(e[3]=[a("path",{d:"M7 12h10v-2H7z",fill:"currentColor"},null,-1)])]))]),a("span",nD,m(Math.abs(s.trend))+"%",1),a("span",rD,m(s.trendPeriod||"vs prev"),1)])):$("",!0),s.progress!==null?(c(),u("div",iD,[a("div",lD,[a("div",{class:"progress-fill",style:we({width:`${Math.min(s.progress,100)}%`})},null,4)]),a("span",cD,m(s.progress)+"%",1)])):$("",!0)],2)}const uD=de(GS,[["render",dD],["__scopeId","data-v-b8d66bef"]]),gD={name:"ContextSidebar",components:{MetricCard:uD},props:{context:{type:String,default:"global",validator:o=>["global","user","management"].includes(o)},selectedUser:{type:Object,default:null},selectedUsers:{type:Array,default:()=>[]},globalMetrics:{type:Array,default:()=>[]},userStats:{type:Object,default:()=>({})},userFilters:{type:Object,default:()=>({timeRange:"week",activity_types:[]})},filterPresets:{type:Array,default:()=>[]},activePreset:{type:String,default:null},recentActivity:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},activityTypes:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},collapsed:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},emits:["toggle-collapse","metric-click","filter-preset-apply","activity-click","filter-change","view-profile","export-data","edit-permissions","bulk-action","user-select"],setup(o,{emit:e}){const s=I(o.collapsed),t=M(()=>{if(!o.selectedUser?.name)return"";const[A,W]=o.selectedUser.name.split(" ");return`${A?.[0]||""}${W?.[0]||""}`.toUpperCase()}),r=()=>{s.value=!s.value,e("toggle-collapse",s.value)},i=()=>{switch(o.context){case"global":return"Обзор";case"user":return"Анализ пользователя";case"management":return"Управление";default:return"Обзор"}},n=()=>`${i()} - боковая панель с дополнительной информацией`,l=A=>{switch(A){case"online":return"Онлайн";case"away":return"Отошёл";case"offline":return"Оффлайн";default:return"Неизвестно"}},d=A=>{if(!A)return"";const[W,x]=A.split(" ");return`${W?.[0]||""}${x?.[0]||""}`.toUpperCase()},g=A=>{const W=Math.floor(A/60),x=A%60;return`${W}:${x.toString().padStart(2,"0")}`},v=A=>{const W=new Date(A),D=new Date-W,E=Math.floor(D/(1e3*60)),L=Math.floor(D/(1e3*60*60)),B=Math.floor(D/(1e3*60*60*24));return E<1?"только что":E<60?`${E} мин назад`:L<24?`${L} ч назад`:B<7?`${B} д назад`:W.toLocaleDateString()},T=A=>{e("metric-click",A)},f=A=>{e("filter-preset-apply",A)},p=A=>{e("activity-click",A)},y=()=>{e("filter-change",o.userFilters)},S=()=>{e("view-profile",o.selectedUser)},C=()=>{e("export-data",o.selectedUser)},k=()=>{e("edit-permissions",o.selectedUser)},_=A=>{e("bulk-action",{action:A,users:o.selectedUsers})};return Ne(()=>o.collapsed,A=>{s.value=A}),{isCollapsed:s,userInitials:t,toggleCollapse:r,getContextTitle:i,getAriaLabel:n,getStatusText:l,getUserInitials:d,formatDuration:g,formatTime:v,handleMetricClick:T,applyFilterPreset:f,handleActivityClick:p,handleFilterChange:y,viewDetailedProfile:S,exportUserData:C,editPermissions:k,performBulkAction:_}}},mD=["aria-label"],hD=["aria-label","title"],fD={class:"sidebar-header"},vD={class:"context-title"},pD={key:0,class:"user-indicator"},yD={class:"user-avatar"},kD=["src","alt"],bD={key:1,class:"avatar-placeholder"},_D={class:"user-info"},wD={class:"user-name"},CD={key:0,class:"global-context-content"},TD={class:"metrics-section"},SD={class:"metrics-grid"},DD={class:"filters-section"},ED={class:"filter-presets"},AD=["onClick","aria-label"],$D={class:"preset-label"},ID={key:0,class:"preset-count"},MD={class:"recent-activity-section"},ND={class:"recent-activity-list"},xD=["onClick"],LD={class:"activity-content"},PD={class:"activity-text"},OD={class:"activity-time"},BD={key:1,class:"user-context-content"},RD={class:"user-stats-section"},WD={class:"user-stats-grid"},UD={class:"stat-item"},FD={class:"stat-value"},HD={class:"stat-item"},jD={class:"stat-value"},zD={class:"stat-item"},VD={class:"stat-value"},GD={class:"stat-item"},KD={class:"stat-value"},qD={class:"analysis-filters-section"},YD={class:"filter-controls"},XD={class:"filter-group"},JD={class:"filter-group"},ZD={class:"checkbox-group"},QD=["value"],e2={class:"user-actions-section"},t2={class:"action-buttons"},s2=["aria-label"],a2=["aria-label"],o2=["aria-label"],n2={key:2,class:"management-context-content"},r2={key:0,class:"selected-users-section"},i2={class:"section-title"},l2={class:"selected-users-list"},c2={class:"user-avatar small"},d2=["src","alt"],u2={key:1,class:"avatar-placeholder small"},g2={class:"user-name"},m2={key:0,class:"more-users"},h2={class:"bulk-operations-section"},f2={class:"bulk-actions"},v2=["disabled"],p2=["disabled"],y2=["disabled"],k2={class:"audit-log-section"},b2={class:"audit-log-list"},_2={class:"audit-content"},w2={class:"audit-text"},C2={class:"audit-time"},T2={key:0,class:"sidebar-loading-overlay"};function S2(o,e,s,t,r,i){const n=be("MetricCard");return c(),u("aside",{class:X(["context-sidebar",{collapsed:t.isCollapsed,"context-global":s.context==="global","context-user":s.context==="user","context-management":s.context==="management"}]),role:"complementary","aria-label":t.getAriaLabel()},[a("button",{class:"collapse-toggle",onClick:e[0]||(e[0]=(...l)=>t.toggleCollapse&&t.toggleCollapse(...l)),onKeydown:[e[1]||(e[1]=Re((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["enter"])),e[2]||(e[2]=Re((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["space"]))],"aria-label":t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель",title:t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель"},[(c(),u("svg",{class:X(["collapse-icon",{rotated:t.isCollapsed}]),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[13]||(e[13]=[a("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"},null,-1)])],2))],40,hD),a("header",fD,[a("h3",vD,m(t.getContextTitle()),1),s.context==="user"&&s.selectedUser?(c(),u("div",pD,[a("div",yD,[s.selectedUser.avatar?(c(),u("img",{key:0,src:s.selectedUser.avatar,alt:`Аватар ${s.selectedUser.name}`},null,8,kD)):(c(),u("div",bD,m(t.userInitials),1))]),a("div",_D,[a("div",wD,m(s.selectedUser.name),1),a("div",{class:X(["user-status",s.selectedUser.status])},m(t.getStatusText(s.selectedUser.status)),3)])])):$("",!0)]),a("div",{class:X(["sidebar-content",{"content-collapsed":t.isCollapsed}])},[s.context==="global"?(c(),u("div",CD,[a("section",TD,[e[14]||(e[14]=a("h4",{class:"section-title"},"Общая статистика",-1)),a("div",SD,[(c(!0),u(ee,null,te(s.globalMetrics,l=>(c(),he(n,{key:l.id,metric:l,size:"compact",onClick:t.handleMetricClick},null,8,["metric","onClick"]))),128))])]),a("section",DD,[e[15]||(e[15]=a("h4",{class:"section-title"},"Быстрые фильтры",-1)),a("div",ED,[(c(!0),u(ee,null,te(s.filterPresets,l=>(c(),u("button",{key:l.id,class:X(["filter-preset",{active:s.activePreset===l.id}]),onClick:d=>t.applyFilterPreset(l),"aria-label":`Применить фильтр: ${l.label}`},[(c(),he(wt(l.icon),{class:"preset-icon"})),a("span",$D,m(l.label),1),l.count!==void 0?(c(),u("span",ID,m(l.count),1)):$("",!0)],10,AD))),128))])]),a("section",MD,[e[16]||(e[16]=a("h4",{class:"section-title"},"Недавние действия",-1)),a("div",ND,[(c(!0),u(ee,null,te(s.recentActivity,l=>(c(),u("div",{key:l.id,class:"activity-item",onClick:d=>t.handleActivityClick(l)},[a("div",{class:X(["activity-icon",l.type])},[(c(),he(wt(l.icon)))],2),a("div",LD,[a("div",PD,m(l.text),1),a("div",OD,m(t.formatTime(l.timestamp)),1)])],8,xD))),128))])])])):s.context==="user"?(c(),u("div",BD,[a("section",RD,[e[21]||(e[21]=a("h4",{class:"section-title"},"Статистика пользователя",-1)),a("div",WD,[a("div",UD,[a("div",FD,m(s.userStats.total_actions||0),1),e[17]||(e[17]=a("div",{class:"stat-label"},"действий",-1)),s.userStats.actions_change!==0?(c(),u("div",{key:0,class:X(["stat-change",{positive:s.userStats.actions_change>0,negative:s.userStats.actions_change<0}])},m(s.userStats.actions_change>0?"+":"")+m(s.userStats.actions_change)+"% ",3)):$("",!0)]),a("div",HD,[a("div",jD,m(t.formatDuration(s.userStats.avg_session_duration||0)),1),e[18]||(e[18]=a("div",{class:"stat-label"},"средняя сессия",-1))]),a("div",zD,[a("div",VD,m(s.userStats.total_sessions||0),1),e[19]||(e[19]=a("div",{class:"stat-label"},"сессий",-1))]),a("div",GD,[a("div",KD,m(s.userStats.activity_score||0)+"/100",1),e[20]||(e[20]=a("div",{class:"stat-label"},"активность",-1))])])]),a("section",qD,[e[26]||(e[26]=a("h4",{class:"section-title"},"Фильтры анализа",-1)),a("div",YD,[a("div",XD,[e[23]||(e[23]=a("label",{class:"filter-label"},"Период:",-1)),Be(a("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>s.userFilters.timeRange=l),class:"filter-select",onChange:e[4]||(e[4]=(...l)=>t.handleFilterChange&&t.handleFilterChange(...l))},[...e[22]||(e[22]=[_t('<option value="today" data-v-abccaced>Сегодня</option><option value="week" data-v-abccaced>Неделя</option><option value="month" data-v-abccaced>Месяц</option><option value="quarter" data-v-abccaced>Квартал</option><option value="year" data-v-abccaced>Год</option>',5)])],544),[[ut,s.userFilters.timeRange]])]),a("div",JD,[e[25]||(e[25]=a("label",{class:"filter-label"},"Типы действий:",-1)),a("div",ZD,[(c(!0),u(ee,null,te(s.activityTypes,l=>(c(),u("label",{key:l.id,class:"checkbox-label"},[Be(a("input",{type:"checkbox",value:l.id,"onUpdate:modelValue":e[5]||(e[5]=d=>s.userFilters.activity_types=d),onChange:e[6]||(e[6]=(...d)=>t.handleFilterChange&&t.handleFilterChange(...d))},null,40,QD),[[ys,s.userFilters.activity_types]]),e[24]||(e[24]=a("span",{class:"checkmark"},null,-1)),ce(" "+m(l.label),1)]))),128))])])])]),a("section",e2,[e[30]||(e[30]=a("h4",{class:"section-title"},"Действия",-1)),a("div",t2,[a("button",{class:"action-button primary",onClick:e[7]||(e[7]=(...l)=>t.viewDetailedProfile&&t.viewDetailedProfile(...l)),"aria-label":`Просмотреть детальный профиль ${s.selectedUser?.name}`},[...e[27]||(e[27]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.6C18.8 6 18.5 5.4 18.1 4.9L19 3L17 1L15.4 1.9C14.9 1.5 14.3 1.2 13.7 1L13 0V2C12.4 2 11.8 2.2 11.3 2.6L10.6 1.9L8.6 3L9.5 4.9C9.1 5.4 8.8 6 8.6 6.6L7 7V9L8.6 8.4C8.8 9 9.1 9.6 9.5 10.1L8.6 12L10.6 13.9L11.3 13.2C11.8 13.6 12.4 13.8 13 14V16H11V18H13V20H11V22H13V20H15V18H13V16H15V14C15.6 14 16.2 13.6 16.7 13.2L17.4 13.9L19.4 12L18.5 10.1C18.9 9.6 19.2 9 19.4 8.4L21 9ZM12 8C10.9 8 10 7.1 10 6C10 4.9 10.9 4 12 4C13.1 4 14 4.9 14 6C14 7.1 13.1 8 12 8Z"})],-1),ce(" Детальный профиль ",-1)])],8,s2),a("button",{class:"action-button secondary",onClick:e[8]||(e[8]=(...l)=>t.exportUserData&&t.exportUserData(...l)),"aria-label":`Экспортировать данные ${s.selectedUser?.name}`},[...e[28]||(e[28]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ce(" Экспорт данных ",-1)])],8,a2),s.canEditPermissions?(c(),u("button",{key:0,class:"action-button warning",onClick:e[9]||(e[9]=(...l)=>t.editPermissions&&t.editPermissions(...l)),"aria-label":`Изменить права ${s.selectedUser?.name}`},[...e[29]||(e[29]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить права ",-1)])],8,o2)):$("",!0)])])])):s.context==="management"?(c(),u("div",n2,[s.selectedUsers.length>0?(c(),u("section",r2,[a("h4",i2,"Выбрано пользователей: "+m(s.selectedUsers.length),1),a("div",l2,[(c(!0),u(ee,null,te(s.selectedUsers.slice(0,3),l=>(c(),u("div",{key:l.id,class:"selected-user-item"},[a("div",c2,[l.avatar?(c(),u("img",{key:0,src:l.avatar,alt:l.name},null,8,d2)):(c(),u("div",u2,m(t.getUserInitials(l.name)),1))]),a("span",g2,m(l.name),1)]))),128)),s.selectedUsers.length>3?(c(),u("div",m2," +"+m(s.selectedUsers.length-3)+" ещё ",1)):$("",!0)])])):$("",!0),a("section",h2,[e[34]||(e[34]=a("h4",{class:"section-title"},"Массовые операции",-1)),a("div",f2,[a("button",{class:"bulk-action-button",onClick:e[10]||(e[10]=l=>t.performBulkAction("change_department")),disabled:s.selectedUsers.length===0},[...e[31]||(e[31]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить отдел ",-1)])],8,v2),a("button",{class:"bulk-action-button",onClick:e[11]||(e[11]=l=>t.performBulkAction("toggle_admin")),disabled:s.selectedUsers.length===0},[...e[32]||(e[32]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить права администратора ",-1)])],8,p2),a("button",{class:"bulk-action-button",onClick:e[12]||(e[12]=l=>t.performBulkAction("export")),disabled:s.selectedUsers.length===0},[...e[33]||(e[33]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ce(" Экспорт ",-1)])],8,y2)])]),a("section",k2,[e[35]||(e[35]=a("h4",{class:"section-title"},"Последние изменения",-1)),a("div",b2,[(c(!0),u(ee,null,te(s.auditLog.slice(0,5),l=>(c(),u("div",{key:l.id,class:"audit-entry"},[a("div",{class:X(["audit-icon",l.type])},[(c(),he(wt(l.icon)))],2),a("div",_2,[a("div",w2,m(l.text),1),a("div",C2,m(t.formatTime(l.timestamp)),1)])]))),128))])])])):$("",!0)],2),s.isLoading?(c(),u("div",T2,[...e[36]||(e[36]=[a("div",{class:"loading-spinner","aria-label":"Загрузка данных"},null,-1)])])):$("",!0)],10,mD)}const D2=de(gD,[["render",S2],["__scopeId","data-v-abccaced"]]),ga=o=>new Date(o),E2=(o,e,s={})=>{const t=new Date(o),r=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return e.replace("yyyy",r).replace("MM",i).replace("dd",n)},A2={name:"UnifiedUserCard",props:{user:{type:Object,required:!0,validator:o=>o&&typeof o=="object"&&o.id&&o.name&&o.email},isSelected:{type:Boolean,default:!1},showExtendedMetrics:{type:Boolean,default:!1},compactView:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1},canDelete:{type:Boolean,default:!1},maxDepartments:{type:Number,default:2}},emits:["select","view-profile","edit-permissions","toggle-hidden","view-analytics","export-data","send-notification","view-audit","delete-user"],setup(o,{emit:e}){const s=I(!1),t=I(null),r=M(()=>{const[P,h]=o.user.name.split(" ");return`${P?.[0]||""}${h?.[0]||""}`.toUpperCase()}),i=M(()=>{const P=["#2196F3","#4CAF50","#FF9800","#F44336","#9C27B0","#00BCD4","#8BC34A","#FFC107","#E91E63","#3F51B5"];return P[Math.abs(o.user.id)%P.length]}),n=M(()=>(o.user.departments||[]).slice(0,o.maxDepartments).map(h=>({...h,shortName:h.name.length>10?h.name.substring(0,8)+"...":h.name}))),l=M(()=>{const P=o.user.departments||[];return Math.max(0,P.length-o.maxDepartments)}),d=M(()=>{const P=o.user.activity_stats?.total_actions||0;return P>=1e6?`${(P/1e6).toFixed(1)}M`:P>=1e3?`${(P/1e3).toFixed(1)}K`:P.toLocaleString()}),g=M(()=>{const P=o.user.activity_stats?.total_sessions||0;return P>=1e3?`${(P/1e3).toFixed(1)}K`:P.toString()}),v=M(()=>{const P=o.user.activity_stats?.avg_session_duration||0,h=Math.floor(P/60),w=Math.floor(P%60);return`${h}:${w.toString().padStart(2,"0")}`}),T=M(()=>{const P=o.user.activity_stats?.last_activity;if(!P)return"Никогда";let h;try{h=typeof P=="string"?ga(P):new Date(P)}catch{return"Неизвестно"}const R=new Date-h,re=Math.floor(R/(1e3*60*60*24)),le=Math.floor(R/(1e3*60*60)),ae=Math.floor(R/(1e3*60));return ae<1?"только что":ae<60?`${ae} мин`:le<24?`${le} ч`:re<7?`${re} д`:re<30?`${Math.floor(re/7)} нед`:E2(h,"dd.MM.yyyy")}),f=M(()=>Math.min(100,Math.max(0,o.user.activity_stats?.activity_score||0))),p=M(()=>o.user.activity_stats?.actions_change_percent||0),y=M(()=>o.user.status||"offline"),S=M(()=>!!o.user.is_admin),C=M(()=>{if(!o.user.created_at)return!1;try{const P=typeof o.user.created_at=="string"?ga(o.user.created_at):new Date(o.user.created_at);return Math.floor((new Date-P)/(1e3*60*60*24))<=7}catch{return!1}}),k=M(()=>!!o.user.is_hidden),_=M(()=>o.user.name||"Неизвестный пользователь"),A=M(()=>o.user.email||""),W=M(()=>o.user.avatar||null),x=()=>{e("select",o.user)},D=()=>{e("view-profile",o.user)},E=()=>{e("edit-permissions",o.user)},L=()=>{e("toggle-hidden",o.user)},B=()=>{s.value=!0;const P=h=>{t.value&&!t.value.contains(h.target)&&(s.value=!1,document.removeEventListener("click",P))};setTimeout(()=>{document.addEventListener("click",P)},0)},U=()=>{s.value=!1,e("view-analytics",o.user)},G=()=>{s.value=!1,e("export-data",o.user)},q=()=>{s.value=!1,e("send-notification",o.user)},oe=()=>{s.value=!1,e("view-audit",o.user)},Y=()=>{s.value=!1,confirm(`Вы уверены, что хотите удалить пользователя ${o.user.name}?`)&&e("delete-user",o.user)},H=()=>{console.warn(`Failed to load avatar for user ${o.user.id}`)},Z=P=>{switch(P){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},fe=P=>{if(P.key==="Enter"||P.key===" ")P.preventDefault(),x();else if(P.key==="ArrowDown"){P.preventDefault();const h=P.target.nextElementSibling;h&&h.focus()}else if(P.key==="ArrowUp"){P.preventDefault();const h=P.target.previousElementSibling;h&&h.focus()}};return $e(()=>{const P=document.querySelector(`[data-user-id="${o.user.id}"]`);P&&P.addEventListener("keydown",fe)}),st(()=>{const P=document.querySelector(`[data-user-id="${o.user.id}"]`);P&&P.removeEventListener("keydown",fe)}),{showContextMenuFlag:s,contextMenuRef:t,userInitials:r,avatarColor:i,visibleDepartments:n,hiddenDepartmentsCount:l,totalActionsFormatted:d,totalSessionsFormatted:g,avgSessionDurationFormatted:v,lastActivityFormatted:T,activityScore:f,actionsChange:p,userStatus:y,isAdmin:S,isNew:C,isHidden:k,userName:_,userEmail:A,userAvatar:W,handleSelect:x,viewProfile:D,editPermissions:E,toggleHidden:L,showContextMenu:B,viewDetailedAnalytics:U,exportUserData:G,sendNotification:q,viewAuditLog:oe,deleteUser:Y,handleAvatarError:H,getStatusText:Z}}},$2=["aria-label","aria-selected","aria-describedby"],I2={class:"user-avatar-section"},M2={class:"avatar-container"},N2=["src","alt"],x2=["title"],L2={key:2,class:"new-indicator",title:"Новый пользователь"},P2={class:"user-info-section"},O2={class:"user-header"},B2={class:"user-name"},R2={class:"user-badges"},W2={key:0,class:"badge admin",title:"Администратор"},U2={key:1,class:"badge hidden",title:"Скрытый пользователь"},F2={class:"user-email"},H2={key:0,class:"user-departments"},j2=["title"],z2=["title"],V2={class:"user-metrics-section"},G2={class:"metric primary"},K2={class:"metric-value"},q2=["title"],Y2={class:"metric secondary"},X2={class:"metric-value"},J2={key:0,class:"activity-score"},Z2={class:"score-bar"},Q2=["title"],eE={key:1,class:"mini-metrics"},tE={class:"mini-metric"},sE={class:"mini-metric"},aE={class:"user-actions-section"},oE=["aria-label","title"],nE=["aria-label","title"],rE=["aria-label","title"],iE=["aria-label"],lE=["aria-label"],cE=["aria-label"],dE=["aria-label"],uE=["aria-label"],gE=["aria-label"],mE=["aria-label"],hE=["id"],fE={key:1,class:"selection-indicator","aria-hidden":"true"};function vE(o,e,s,t,r,i){return c(),u("div",{class:X(["unified-user-card",{selected:s.isSelected,"activity-high":t.activityScore>=80,"activity-medium":t.activityScore>=50&&t.activityScore<80,"activity-low":t.activityScore<50,"status-online":t.userStatus==="online","status-away":t.userStatus==="away","status-offline":t.userStatus==="offline","has-departments":t.visibleDepartments.length>0,"is-admin":t.isAdmin,"is-new":t.isNew,"is-hidden":t.isHidden,"compact-view":s.compactView}]),onClick:e[10]||(e[10]=(...n)=>t.handleSelect&&t.handleSelect(...n)),onDblclick:e[11]||(e[11]=(...n)=>t.viewProfile&&t.viewProfile(...n)),onKeydown:[e[12]||(e[12]=Re((...n)=>t.handleSelect&&t.handleSelect(...n),["enter"])),e[13]||(e[13]=Re((...n)=>t.handleSelect&&t.handleSelect(...n),["space"]))],onContextmenu:e[14]||(e[14]=Ce((...n)=>t.showContextMenu&&t.showContextMenu(...n),["prevent"])),tabindex:"0",role:"button","aria-label":`Выбрать пользователя ${t.userName}`,"aria-selected":s.isSelected,"aria-describedby":`user-card-${s.user.id}-description`},[a("div",I2,[a("div",M2,[t.userAvatar?(c(),u("img",{key:0,src:t.userAvatar,alt:`Аватар ${t.userName}`,class:"user-avatar",onError:e[0]||(e[0]=(...n)=>t.handleAvatarError&&t.handleAvatarError(...n))},null,40,N2)):(c(),u("div",{key:1,class:"avatar-placeholder",style:we({backgroundColor:t.avatarColor})},m(t.userInitials),5)),a("div",{class:X(["status-indicator",t.userStatus]),title:`Статус: ${t.getStatusText(t.userStatus)}`},null,10,x2),t.isNew?(c(),u("div",L2," NEW ")):$("",!0)])]),a("div",P2,[a("div",O2,[a("h4",B2,m(t.userName),1),a("div",R2,[t.isAdmin?(c(),u("span",W2," Админ ")):$("",!0),t.isHidden?(c(),u("span",U2," Скрыт ")):$("",!0)])]),a("p",F2,m(t.userEmail),1),t.visibleDepartments.length>0?(c(),u("div",H2,[(c(!0),u(ee,null,te(t.visibleDepartments,n=>(c(),u("span",{key:n.id,class:"dept-tag",style:we({backgroundColor:n.color}),title:n.name},m(n.shortName||n.name),13,j2))),128)),t.hiddenDepartmentsCount>0?(c(),u("span",{key:0,class:"dept-more",title:`Ещё ${t.hiddenDepartmentsCount} отделов`}," +"+m(t.hiddenDepartmentsCount),9,z2)):$("",!0)])):$("",!0)]),a("div",V2,[a("div",G2,[a("div",K2,m(t.totalActionsFormatted),1),e[15]||(e[15]=a("div",{class:"metric-label"},"действий",-1)),t.actionsChange!==0?(c(),u("div",{key:0,class:X(["metric-change",{positive:t.actionsChange>0,negative:t.actionsChange<0}]),title:`Изменение: ${t.actionsChange>0?"+":""}${t.actionsChange}%`},m(t.actionsChange>0?"+":"")+m(t.actionsChange)+"% ",11,q2)):$("",!0)]),a("div",Y2,[a("div",X2,m(t.lastActivityFormatted),1),e[16]||(e[16]=a("div",{class:"metric-label"},"активность",-1))]),s.compactView?$("",!0):(c(),u("div",J2,[a("div",Z2,[a("div",{class:X(["score-fill",{"high-score":t.activityScore>=80,"medium-score":t.activityScore>=50&&t.activityScore<80,"low-score":t.activityScore<50}]),style:we({width:`${t.activityScore}%`})},null,6)]),a("div",{class:"score-label",title:`Уровень активности: ${t.activityScore}/100`},m(t.activityScore)+"/100 ",9,Q2)])),s.compactView?(c(),u("div",eE,[a("span",tE,m(t.totalSessionsFormatted)+" сессий",1),a("span",sE,m(t.avgSessionDurationFormatted),1)])):$("",!0)]),a("div",aE,[a("button",{onClick:e[1]||(e[1]=Ce((...n)=>t.viewProfile&&t.viewProfile(...n),["stop"])),class:"action-btn primary","aria-label":`Просмотреть профиль ${t.userName}`,title:`Просмотреть профиль ${t.userName}`}," 👁️ ",8,oE),s.canEditPermissions?(c(),u("button",{key:0,onClick:e[2]||(e[2]=Ce((...n)=>t.editPermissions&&t.editPermissions(...n),["stop"])),class:"action-btn secondary","aria-label":`Изменить права ${t.userName}`,title:`Изменить права ${t.userName}`}," ⚙️ ",8,nE)):$("",!0),a("button",{onClick:e[3]||(e[3]=Ce((...n)=>t.toggleHidden&&t.toggleHidden(...n),["stop"])),class:X(["action-btn tertiary",{active:t.isHidden}]),"aria-label":`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`,title:`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`},m(t.isHidden?"👁️‍🗨️":"🙈"),11,rE),a("button",{onClick:e[4]||(e[4]=Ce((...n)=>t.showContextMenu&&t.showContextMenu(...n),["stop"])),class:"action-btn menu","aria-label":`Меню действий для ${t.userName}`,title:"Дополнительные действия"}," ⋮ ",8,iE)]),t.showContextMenuFlag?(c(),u("div",{key:0,class:"context-menu",ref:"contextMenu",role:"menu","aria-label":`Меню действий для ${t.userName}`},[a("button",{onClick:e[5]||(e[5]=(...n)=>t.viewDetailedAnalytics&&t.viewDetailedAnalytics(...n)),class:"menu-item",role:"menuitem","aria-label":`Детальная аналитика для ${t.userName}`}," 📊 Детальная аналитика ",8,cE),a("button",{onClick:e[6]||(e[6]=(...n)=>t.exportUserData&&t.exportUserData(...n)),class:"menu-item",role:"menuitem","aria-label":`Экспорт данных ${t.userName}`}," 📥 Экспорт данных ",8,dE),a("button",{onClick:e[7]||(e[7]=(...n)=>t.sendNotification&&t.sendNotification(...n)),class:"menu-item",role:"menuitem","aria-label":`Отправить уведомление ${t.userName}`}," 📧 Уведомление ",8,uE),a("button",{onClick:e[8]||(e[8]=(...n)=>t.viewAuditLog&&t.viewAuditLog(...n)),class:"menu-item",role:"menuitem","aria-label":`Журнал аудита для ${t.userName}`}," 📋 Журнал аудита ",8,gE),e[17]||(e[17]=a("hr",{class:"menu-divider",role:"separator"},null,-1)),s.canDelete?(c(),u("button",{key:0,onClick:e[9]||(e[9]=(...n)=>t.deleteUser&&t.deleteUser(...n)),class:"menu-item danger",role:"menuitem","aria-label":`Удалить пользователя ${t.userName}`}," 🗑️ Удалить пользователя ",8,mE)):$("",!0)],8,lE)):$("",!0),a("div",{id:`user-card-${s.user.id}-description`,class:"sr-only"}," Пользователь "+m(t.userName)+", email "+m(t.userEmail)+", статус "+m(t.getStatusText(t.userStatus))+", "+m(t.totalActionsFormatted)+" действий, последняя активность "+m(t.lastActivityFormatted)+", уровень активности "+m(t.activityScore)+" из 100. "+m(t.isAdmin?"Администратор.":"")+" "+m(t.isHidden?"Скрытый пользователь.":"")+" "+m(t.visibleDepartments.length>0?`Отделы: ${t.visibleDepartments.map(n=>n.name).join(", ")}.`:""),9,hE),s.isSelected?(c(),u("div",fE,[...e[18]||(e[18]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16"},[a("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})],-1)])])):$("",!0)],42,$2)}const pE=de(A2,[["render",vE],["__scopeId","data-v-5e790fbc"]]),yE={name:"BulkActionsBar",emits:["execute","clear-selection"],props:{selectedUsers:{type:Array,default:()=>[]},availableActions:{type:Array,default:()=>[]}}},kE={key:0,class:"bulk-actions-bar"},bE={class:"bar-content"},_E={class:"selection-info"},wE={class:"selection-count"},CE={class:"selection-text"},TE={class:"actions-list"},SE=["onClick","title"],DE={key:0,class:"action-icon"},EE={class:"action-text"};function AE(o,e,s,t,r,i){return s.selectedUsers.length>0?(c(),u("div",kE,[a("div",bE,[a("div",_E,[a("span",wE," Выбрано: "+m(s.selectedUsers.length),1),a("span",CE,m(s.selectedUsers.length===1?"пользователь":"пользователей"),1)]),a("div",TE,[(c(!0),u(ee,null,te(s.availableActions,n=>(c(),u("button",{key:n.id,onClick:l=>o.$emit("execute",n),class:X(["action-btn",n.class]),title:n.description},[n.icon?(c(),u("span",DE,m(n.icon),1)):$("",!0),a("span",EE,m(n.label),1)],10,SE))),128))]),a("button",{onClick:e[0]||(e[0]=n=>o.$emit("clear-selection")),class:"clear-btn",title:"Очистить выбор"}," ✕ ")])])):$("",!0)}const $E=de(yE,[["render",AE],["__scopeId","data-v-56b78081"]]),IE={name:"VirtualList",emits:["item-click"],props:{items:{type:Array,default:()=>[]},itemHeight:{type:Number,default:50},containerHeight:{type:Number,default:400},bufferSize:{type:Number,default:5}},data(){return{scrollTop:0}},computed:{totalItems(){return this.items.length},totalHeight(){return this.totalItems*this.itemHeight},visibleCount(){return Math.ceil(this.containerHeight/this.itemHeight)+this.bufferSize*2},startIndex(){const o=Math.floor(this.scrollTop/this.itemHeight)-this.bufferSize;return Math.max(0,o)},endIndex(){const o=this.startIndex+this.visibleCount;return Math.min(this.totalItems,o)},visibleItems(){return this.items.slice(this.startIndex,this.endIndex)},offsetTop(){return this.startIndex*this.itemHeight},offsetBottom(){return Math.max(0,this.totalHeight-this.offsetTop-this.visibleItems.length*this.itemHeight)},listHeight(){return Math.min(this.totalHeight,this.containerHeight)}},methods:{handleScroll(o){this.scrollTop=o.target.scrollTop},getItemKey(o,e){return o.id||o.key||e},scrollToIndex(o){const e=Math.max(0,o*this.itemHeight-this.containerHeight/2);this.$refs.container?.scrollTo({top:e,behavior:"smooth"})},scrollToTop(){this.$refs.container?.scrollTo({top:0,behavior:"smooth"})},scrollToBottom(){const o=this.totalHeight-this.containerHeight;this.$refs.container?.scrollTo({top:o,behavior:"smooth"})}}},ME={class:"virtual-list-container",ref:"container"};function NE(o,e,s,t,r,i){return c(),u("div",ME,[a("div",{class:"virtual-list",style:we({height:`${i.listHeight}px`}),onScroll:e[0]||(e[0]=(...n)=>i.handleScroll&&i.handleScroll(...n))},[a("div",{class:"virtual-spacer top",style:we({height:`${i.offsetTop}px`})},null,4),(c(!0),u(ee,null,te(i.visibleItems,(n,l)=>(c(),u("div",{key:i.getItemKey(n,i.startIndex+l),class:"virtual-item"},[ma(o.$slots,"item",{item:n,index:i.startIndex+l},void 0)]))),128)),a("div",{class:"virtual-spacer bottom",style:we({height:`${i.offsetBottom}px`})},null,4)],36)],512)}const xE=de(IE,[["render",NE],["__scopeId","data-v-302c06ef"]]),LE={name:"PaginationControls",emits:["page-change","per-page-change"],props:{currentPage:{type:Number,required:!0},totalPages:{type:Number,required:!0},totalItems:{type:Number,required:!0},perPage:{type:Number,default:50},showPerPageSelector:{type:Boolean,default:!0},perPageOptions:{type:Array,default:()=>[10,25,50,100]},maxVisiblePages:{type:Number,default:7}},computed:{startItem(){return(this.currentPage-1)*this.perPage+1},endItem(){return Math.min(this.currentPage*this.perPage,this.totalItems)},visiblePages(){const o=[],e=this.totalPages,s=this.currentPage,t=this.maxVisiblePages;if(e<=t)for(let r=1;r<=e;r++)o.push(r);else{const r=Math.max(1,s-Math.floor(t/2)),i=Math.min(e,r+t-1),n=Math.max(1,i-t+1);n>1&&(o.push(1),n>2&&o.push("..."));for(let l=n;l<=i;l++)o.push(l);i<e&&(i<e-1&&o.push("..."),o.push(e))}return o}}},PE={key:0,class:"pagination-controls"},OE={class:"pagination-info"},BE={class:"pagination-text"},RE={class:"pagination-nav"},WE=["disabled"],UE=["disabled"],FE={key:0,class:"page-btn ellipsis",disabled:"","aria-hidden":"true"},HE=["onClick","aria-label","aria-current"],jE=["disabled"],zE=["disabled"],VE={key:0,class:"per-page-selector"},GE=["value"],KE=["value"];function qE(o,e,s,t,r,i){return s.totalPages>1?(c(),u("div",PE,[a("div",OE,[a("span",BE,m(i.startItem)+"-"+m(i.endItem)+" из "+m(s.totalItems.toLocaleString()),1)]),a("div",RE,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("page-change",1)),disabled:s.currentPage===1,class:"page-btn first","aria-label":"Перейти на первую страницу",title:"Первая страница"}," «« ",8,WE),a("button",{onClick:e[1]||(e[1]=n=>o.$emit("page-change",s.currentPage-1)),disabled:s.currentPage===1,class:"page-btn prev","aria-label":"Перейти на предыдущую страницу",title:"Предыдущая страница"}," ‹ ",8,UE),(c(!0),u(ee,null,te(i.visiblePages,n=>(c(),u(ee,{key:n},[n==="..."?(c(),u("button",FE,m(n),1)):(c(),u("button",{key:1,onClick:l=>o.$emit("page-change",n),class:X({"page-btn":!0,current:n===s.currentPage}),"aria-label":`Перейти на страницу ${n}`,"aria-current":n===s.currentPage?"page":null},m(n),11,HE))],64))),128)),a("button",{onClick:e[2]||(e[2]=n=>o.$emit("page-change",s.currentPage+1)),disabled:s.currentPage===s.totalPages,class:"page-btn next","aria-label":"Перейти на следующую страницу",title:"Следующая страница"}," › ",8,jE),a("button",{onClick:e[3]||(e[3]=n=>o.$emit("page-change",s.totalPages)),disabled:s.currentPage===s.totalPages,class:"page-btn last","aria-label":"Перейти на последнюю страницу",title:"Последняя страница"}," »» ",8,zE)]),s.showPerPageSelector?(c(),u("div",VE,[e[5]||(e[5]=a("label",{for:"per-page-select",class:"per-page-label"},"Показывать:",-1)),a("select",{id:"per-page-select",value:s.perPage,onChange:e[4]||(e[4]=n=>o.$emit("per-page-change",parseInt(n.target.value))),class:"per-page-select","aria-label":"Количество элементов на странице"},[(c(!0),u(ee,null,te(s.perPageOptions,n=>(c(),u("option",{key:n,value:n},m(n),9,KE))),128))],40,GE)])):$("",!0)])):$("",!0)}const YE=de(LE,[["render",qE],["__scopeId","data-v-59d0e153"]]),XE={name:"UserListPanel",components:{UnifiedUserCard:pE,BulkActionsBar:$E,VirtualList:xE,PaginationControls:YE},props:{users:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},pagination:{type:Object,default:()=>({current_page:1,per_page:50,total:0,total_pages:0})},filters:{type:Object,default:()=>({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"})},viewOptions:{type:Object,default:()=>({compactView:!1,showExtendedMetrics:!1,itemsPerPage:50})},canEditPermissions:{type:Boolean,default:!1},canDeleteUsers:{type:Boolean,default:!1}},emits:["user-select","user-select-multiple","filters-change","pagination-change","view-options-change","user-action"],setup(o,{emit:e}){const s=I(!1),t=I([]),r=I({...o.filters}),i=I(null),n=I(null),l=M(()=>o.users),d=M(()=>{let P=0;return r.value.search&&P++,r.value.department_ids.length>0&&P++,r.value.activity_filter!=="all"&&P++,r.value.time_range!=="week"&&P++,P}),g=M(()=>{if(!n.value)return 400;const P=n.value.getBoundingClientRect();return Math.max(400,window.innerHeight-P.top-200)}),v=M(()=>[{id:369,name:"Битрикс24 отдел",color:"#2196F3"},{id:366,name:"Сектор 1С",color:"#4CAF50"},{id:370,name:"Отдел аналитики",color:"#FF9800"},{id:371,name:"Техническая поддержка",color:"#F44336"}]),T=M(()=>[{id:"change_department",label:"Изменить отдел",icon:"BuildingIcon",description:"Назначить пользователей в другой отдел"},{id:"toggle_admin",label:"Изменить права администратора",icon:"ShieldIcon",description:"Предоставить или отозвать права администратора"},{id:"export",label:"Экспорт данных",icon:"DownloadIcon",description:"Экспортировать данные выбранных пользователей"},{id:"hide_users",label:"Скрыть пользователей",icon:"EyeOffIcon",description:"Скрыть выбранных пользователей из списка"}]),f=()=>{s.value=!s.value},p=()=>{e("filters-change",{...r.value})},y=()=>{r.value={search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"},p()},S=P=>{const h=r.value.department_ids.indexOf(P);h>-1?r.value.department_ids.splice(h,1):r.value.department_ids.push(P),p()},C=()=>{r.value.sort_order=r.value.sort_order==="asc"?"desc":"asc",p()},k=()=>{const P={...o.viewOptions,compactView:!o.viewOptions.compactView};e("view-options-change",P)},_=()=>{i.value&&clearTimeout(i.value),i.value=setTimeout(A,300)},A=()=>{p()},W=()=>{r.value.search="",p()},x=P=>{D(P)},D=P=>{e("user-select",P)},E=P=>{t.value=P,e("user-select-multiple",P)},L=()=>{t.value=[]},B=P=>{e("user-action","view-profile",P)},U=P=>{e("user-action","edit-permissions",P)},G=P=>{e("user-action","toggle-visibility",P)},q=P=>{e("user-action","view-analytics",P)},oe=P=>{e("user-action","export-data",P)},Y=P=>{e("user-action","delete",P)},H=P=>{e("user-action","bulk-action",{action:P,users:t.value})},Z=P=>{e("pagination-change",P)},fe=P=>{e("pagination-change",1,P)};return Ne(()=>o.filters,P=>{r.value={...P}},{deep:!0}),$e(()=>{Wt(()=>{n.value&&(n.value.style.height=`${g.value}px`)})}),{showFilters:s,selectedUsers:t,localFilters:r,filteredUsers:l,activeFiltersCount:d,listHeight:g,departments:v,bulkActions:T,listContainer:n,toggleFilters:f,applyFilters:p,resetFilters:y,toggleDepartmentFilter:S,toggleSortOrder:C,toggleCompactView:k,debounceSearch:_,applySearch:A,clearSearch:W,handleUserClick:x,handleUserSelect:D,handleUserSelectMultiple:E,clearSelection:L,handleViewProfile:B,handleEditPermissions:U,handleToggleHidden:G,handleViewAnalytics:q,handleExportUserData:oe,handleDeleteUser:Y,handleBulkAction:H,handlePageChange:Z,handlePerPageChange:fe}}},JE={class:"panel-header"},ZE={class:"header-content"},QE={class:"panel-title"},eA={key:0,class:"users-count"},tA={class:"header-actions"},sA={class:"search-container"},aA=["aria-expanded"],oA={key:0,class:"filters-count"},nA={class:"view-options"},rA={key:0,class:"filters-panel",role:"region","aria-label":"Панель фильтров"},iA={class:"filters-grid"},lA={class:"filter-group"},cA={class:"departments-filter"},dA=["onClick","aria-label"],uA={class:"filter-group"},gA={class:"filter-group"},mA={class:"filter-group"},hA={class:"sort-controls"},fA=["aria-label"],vA={class:"filter-actions"},pA={class:"users-list-container",role:"list","aria-label":"Список пользователей"},yA={key:0,class:"loading-state"},kA={key:1,class:"empty-state"},bA={class:"empty-title"},_A={class:"empty-description"};function wA(o,e,s,t,r,i){const n=be("BulkActionsBar"),l=be("UnifiedUserCard"),d=be("VirtualList"),g=be("PaginationControls");return c(),u("div",{class:X(["user-list-panel",{loading:s.loading,empty:!s.loading&&t.filteredUsers.length===0,"compact-view":s.viewOptions.compactView}]),role:"region","aria-label":"Список пользователей"},[a("div",JE,[a("div",ZE,[a("h2",QE,[e[16]||(e[16]=ce(" Пользователи ",-1)),s.loading?$("",!0):(c(),u("span",eA," ("+m(s.pagination.total.toLocaleString())+") ",1))]),a("div",tA,[a("div",sA,[Be(a("input",{"onUpdate:modelValue":e[0]||(e[0]=v=>t.localFilters.search=v),type:"text",class:"search-input",placeholder:"Поиск по имени или email...",onInput:e[1]||(e[1]=(...v)=>t.debounceSearch&&t.debounceSearch(...v)),onKeydown:e[2]||(e[2]=Re((...v)=>t.applySearch&&t.applySearch(...v),["enter"])),"aria-label":"Поиск пользователей"},null,544),[[At,t.localFilters.search]]),t.localFilters.search?(c(),u("button",{key:0,onClick:e[3]||(e[3]=(...v)=>t.clearSearch&&t.clearSearch(...v)),class:"search-clear","aria-label":"Очистить поиск"}," ✕ ")):$("",!0),e[17]||(e[17]=a("div",{class:"search-icon","aria-hidden":"true"},"🔍",-1))]),a("button",{onClick:e[4]||(e[4]=(...v)=>t.toggleFilters&&t.toggleFilters(...v)),class:X(["filters-toggle",{active:t.showFilters}]),"aria-label":"Показать/скрыть фильтры","aria-expanded":t.showFilters},[e[18]||(e[18]=a("svg",{class:"filter-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"})],-1)),e[19]||(e[19]=ce(" Фильтры ",-1)),t.activeFiltersCount>0?(c(),u("span",oA,m(t.activeFiltersCount),1)):$("",!0)],10,aA),a("div",nA,[a("button",{onClick:e[5]||(e[5]=(...v)=>t.toggleCompactView&&t.toggleCompactView(...v)),class:X(["view-toggle",{active:s.viewOptions.compactView}]),"aria-label":"Переключить компактный вид",title:"Компактный вид"},[...e[20]||(e[20]=[a("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M3 3h18v2H3V3zm0 16h18v2H3v16zm0-8h18v2H3v-2z"})],-1)])],2)])])])]),t.showFilters?(c(),u("div",rA,[a("div",iA,[a("div",lA,[e[21]||(e[21]=a("label",{class:"filter-label"},"Отделы:",-1)),a("div",cA,[(c(!0),u(ee,null,te(t.departments,v=>(c(),u("button",{key:v.id,onClick:T=>t.toggleDepartmentFilter(v.id),class:X(["department-chip",{active:t.localFilters.department_ids.includes(v.id)}]),style:we({borderColor:v.color}),"aria-label":`Фильтр по отделу ${v.name}`},[a("span",{class:"dept-dot",style:we({backgroundColor:v.color}),"aria-hidden":"true"},null,4),ce(" "+m(v.name),1)],14,dA))),128))])]),a("div",uA,[e[23]||(e[23]=a("label",{class:"filter-label"},"Активность:",-1)),Be(a("select",{"onUpdate:modelValue":e[6]||(e[6]=v=>t.localFilters.activity_filter=v),class:"filter-select",onChange:e[7]||(e[7]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Фильтр по уровню активности"},[...e[22]||(e[22]=[_t('<option value="all" data-v-8c6ab554>Все пользователи</option><option value="active" data-v-8c6ab554>Активные (80%+)</option><option value="moderate" data-v-8c6ab554>Средне активные (50-80%)</option><option value="inactive" data-v-8c6ab554>Неактивные (&lt;50%)</option><option value="new" data-v-8c6ab554>Новые (за неделю)</option>',5)])],544),[[ut,t.localFilters.activity_filter]])]),a("div",gA,[e[25]||(e[25]=a("label",{class:"filter-label"},"Период:",-1)),Be(a("select",{"onUpdate:modelValue":e[8]||(e[8]=v=>t.localFilters.time_range=v),class:"filter-select",onChange:e[9]||(e[9]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Временной диапазон для фильтрации"},[...e[24]||(e[24]=[_t('<option value="today" data-v-8c6ab554>Сегодня</option><option value="week" data-v-8c6ab554>Эта неделя</option><option value="month" data-v-8c6ab554>Этот месяц</option><option value="quarter" data-v-8c6ab554>Этот квартал</option><option value="year" data-v-8c6ab554>Этот год</option>',5)])],544),[[ut,t.localFilters.time_range]])]),a("div",mA,[e[28]||(e[28]=a("label",{class:"filter-label"},"Сортировка:",-1)),a("div",hA,[Be(a("select",{"onUpdate:modelValue":e[10]||(e[10]=v=>t.localFilters.sort_by=v),class:"filter-select sort-select",onChange:e[11]||(e[11]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Поле сортировки"},[...e[26]||(e[26]=[a("option",{value:"last_activity"},"Последняя активность",-1),a("option",{value:"name"},"Имя",-1),a("option",{value:"email"},"Email",-1),a("option",{value:"total_actions"},"Количество действий",-1)])],544),[[ut,t.localFilters.sort_by]]),a("button",{onClick:e[12]||(e[12]=(...v)=>t.toggleSortOrder&&t.toggleSortOrder(...v)),class:"sort-order-toggle","aria-label":`Изменить порядок сортировки на ${t.localFilters.sort_order==="asc"?"убывающий":"возрастающий"}`},[(c(),u("svg",{class:X({rotated:t.localFilters.sort_order==="desc"}),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[27]||(e[27]=[a("path",{d:"M7 14l5-5 5 5z"},null,-1)])],2))],8,fA)])])]),a("div",vA,[a("button",{onClick:e[13]||(e[13]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"filter-reset-btn"}," Сбросить "),a("button",{onClick:e[14]||(e[14]=(...v)=>t.applyFilters&&t.applyFilters(...v)),class:"filter-apply-btn"}," Применить ")])])):$("",!0),t.selectedUsers.length>0?(c(),he(n,{key:1,"selected-users":t.selectedUsers,"available-actions":t.bulkActions,onExecute:t.handleBulkAction,onClearSelection:t.clearSelection},null,8,["selected-users","available-actions","onExecute","onClearSelection"])):$("",!0),a("div",pA,[s.loading?(c(),u("div",yA,[(c(!0),u(ee,null,te(s.viewOptions.itemsPerPage,v=>(c(),u("div",{key:v,class:"user-skeleton","aria-hidden":"true"},[...e[29]||(e[29]=[_t('<div class="skeleton-avatar" data-v-8c6ab554></div><div class="skeleton-content" data-v-8c6ab554><div class="skeleton-line" data-v-8c6ab554></div><div class="skeleton-line short" data-v-8c6ab554></div></div><div class="skeleton-actions" data-v-8c6ab554><div class="skeleton-button" data-v-8c6ab554></div><div class="skeleton-button" data-v-8c6ab554></div></div>',3)])]))),128))])):t.filteredUsers.length===0?(c(),u("div",kA,[e[30]||(e[30]=a("div",{class:"empty-icon","aria-hidden":"true"},"👥",-1)),a("h3",bA,m(t.localFilters.search?"Пользователи не найдены":"Нет пользователей"),1),a("p",_A,m(t.localFilters.search?`По запросу "${t.localFilters.search}" ничего не найдено. Попробуйте изменить поиск или сбросить фильтры.`:"В системе ещё нет зарегистрированных пользователей."),1),t.activeFiltersCount>0?(c(),u("button",{key:0,onClick:e[15]||(e[15]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"empty-action-btn"}," Сбросить фильтры ")):$("",!0)])):(c(),he(d,{key:2,items:t.filteredUsers,"item-height":s.viewOptions.compactView?80:120,"container-height":t.listHeight,class:"virtual-users-list",onItemClick:t.handleUserClick},{item:pe(({item:v,index:T})=>[(c(),he(l,{key:v.id,user:v,"is-selected":t.selectedUsers.some(f=>f.id===v.id),"compact-view":s.viewOptions.compactView,"can-edit-permissions":s.canEditPermissions,"can-delete":s.canDeleteUsers,"show-extended-metrics":!s.viewOptions.compactView,onSelect:t.handleUserSelect,onViewProfile:t.handleViewProfile,onEditPermissions:t.handleEditPermissions,onToggleHidden:t.handleToggleHidden,onViewAnalytics:t.handleViewAnalytics,onExportData:t.handleExportUserData,onDeleteUser:t.handleDeleteUser},null,8,["user","is-selected","compact-view","can-edit-permissions","can-delete","show-extended-metrics","onSelect","onViewProfile","onEditPermissions","onToggleHidden","onViewAnalytics","onExportData","onDeleteUser"]))]),_:1},8,["items","item-height","container-height","onItemClick"]))]),!s.loading&&s.pagination.total_pages>1?(c(),he(g,{key:2,"current-page":s.pagination.current_page,"total-pages":s.pagination.total_pages,"total-items":s.pagination.total,"per-page":s.pagination.per_page,onPageChange:t.handlePageChange,onPerPageChange:t.handlePerPageChange},null,8,["current-page","total-pages","total-items","per-page","onPageChange","onPerPageChange"])):$("",!0)],2)}const CA=de(XE,[["render",wA],["__scopeId","data-v-8c6ab554"]]),TA={name:"AnalysisPanel",emits:["back","filter-change","export"],props:{user:{type:Object,default:null},activityData:{type:Object,default:()=>({})},filters:{type:Object,default:()=>({})},timeRange:{type:String,default:"week"},isLoading:{type:Boolean,default:!1}},methods:{getStatusText(o){switch(o){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},formatDuration(o){const e=Math.floor(o/60),s=Math.floor(o%60);return`${e}:${s.toString().padStart(2,"0")}`},formatLastActivity(o){if(!o)return"Никогда";const e=new Date(o),t=new Date-e,r=Math.floor(t/(1e3*60)),i=Math.floor(t/(1e3*60*60)),n=Math.floor(t/(1e3*60*60*24));return r<1?"только что":r<60?`${r} мин назад`:i<24?`${i} ч назад`:n<7?`${n} д назад`:e.toLocaleDateString("ru-RU")}}},SA={class:"analysis-panel"},DA={class:"analysis-header"},EA={class:"user-summary"},AA={class:"user-avatar"},$A=["src","alt"],IA={key:1,class:"avatar-placeholder"},MA={class:"user-info"},NA={class:"user-email"},xA={class:"user-status"},LA={key:0,class:"admin-badge"},PA={class:"header-actions"},OA={class:"analysis-content"},BA={class:"stats-section"},RA={class:"stats-grid"},WA={class:"stat-card"},UA={class:"stat-value"},FA={class:"stat-card"},HA={class:"stat-value"},jA={class:"stat-card"},zA={class:"stat-value"},VA={class:"stat-card"},GA={class:"stat-value"},KA={class:"activity-section"},qA={class:"last-activity"},YA={key:0,class:"departments-section"},XA={class:"departments-list"};function JA(o,e,s,t,r,i){return c(),u("div",SA,[a("div",DA,[a("div",EA,[a("div",AA,[s.user.avatar?(c(),u("img",{key:0,src:s.user.avatar,alt:`Аватар ${s.user.name}`},null,8,$A)):(c(),u("div",IA,m(s.user.name.charAt(0)),1))]),a("div",MA,[a("h2",null,m(s.user.name),1),a("p",NA,m(s.user.email),1),a("div",xA,[a("span",{class:X(`status-${s.user.status}`)},m(i.getStatusText(s.user.status)),3),s.user.is_admin?(c(),u("span",LA,"Администратор")):$("",!0)])])]),a("div",PA,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку")])]),a("div",OA,[a("div",BA,[e[5]||(e[5]=a("h3",null,"📊 Статистика активности",-1)),a("div",RA,[a("div",WA,[a("div",UA,m(s.user.activity_stats?.total_actions||0),1),e[1]||(e[1]=a("div",{class:"stat-label"},"Всего действий",-1))]),a("div",FA,[a("div",HA,m(s.user.activity_stats?.total_sessions||0),1),e[2]||(e[2]=a("div",{class:"stat-label"},"Сессий",-1))]),a("div",jA,[a("div",zA,m(i.formatDuration(s.user.activity_stats?.avg_session_duration||0)),1),e[3]||(e[3]=a("div",{class:"stat-label"},"Средняя сессия",-1))]),a("div",VA,[a("div",GA,m(s.user.activity_stats?.activity_score||0)+"/100",1),e[4]||(e[4]=a("div",{class:"stat-label"},"Уровень активности",-1))])])]),a("div",KA,[e[6]||(e[6]=a("h3",null,"🕒 Последняя активность",-1)),a("div",qA,[a("p",null,m(i.formatLastActivity(s.user.activity_stats?.last_activity)),1)])]),s.user.departments&&s.user.departments.length>0?(c(),u("div",YA,[e[7]||(e[7]=a("h3",null,"🏢 Отделы",-1)),a("div",XA,[(c(!0),u(ee,null,te(s.user.departments,n=>(c(),u("span",{key:n.id,class:"department-tag",style:we({backgroundColor:n.color})},m(n.name),5))),128))])])):$("",!0),e[8]||(e[8]=a("div",{class:"placeholder-note"},[a("strong",null,"🚧 Следующие возможности в разработке:"),a("ul",null,[a("li",null,"График активности по времени"),a("li",null,"Анализ паттернов использования"),a("li",null,"Сравнение с другими пользователями"),a("li",null,"Экспорт детальной статистики")])],-1))])])}const ZA=de(TA,[["render",JA],["__scopeId","data-v-15fd9d64"]]),QA={name:"ManagementPanel",emits:["back","permissions-change","bulk-update"],props:{selectedUsers:{type:Array,default:()=>[]},allUsers:{type:Array,default:()=>[]},departments:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},methods:{handleBulkPermissions(){this.$emit("bulk-update","change_permissions",{is_admin:!1,department_id:369})}}},e$={class:"management-panel"},t$={class:"panel-placeholder"},s$={key:0,class:"selected-info"},a$={class:"selected-list"},o$={class:"user-name"},n$={class:"user-email"},r$={class:"placeholder-actions"};function i$(o,e,s,t,r,i){return c(),u("div",e$,[a("div",t$,[e[2]||(e[2]=a("div",{class:"placeholder-icon"},"⚙️",-1)),e[3]||(e[3]=a("h3",null,"Панель управления правами",-1)),e[4]||(e[4]=a("p",null,"Управление правами доступа и ролями пользователей",-1)),e[5]||(e[5]=a("div",{class:"placeholder-note"},[a("strong",null,"Статус:"),ce(" В разработке (TASK-089 - Этап 5) ")],-1)),s.selectedUsers.length>0?(c(),u("div",s$,[a("h4",null,"Выбрано пользователей: "+m(s.selectedUsers.length),1),a("div",a$,[(c(!0),u(ee,null,te(s.selectedUsers.slice(0,3),n=>(c(),u("div",{key:n.id,class:"selected-user"},[a("span",o$,m(n.name),1),a("span",n$,m(n.email),1)]))),128))])])):$("",!0),a("div",r$,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку"),s.selectedUsers.length>0?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...n)=>i.handleBulkPermissions&&i.handleBulkPermissions(...n)),class:"permissions-btn"}," Изменить права ("+m(s.selectedUsers.length)+") ",1)):$("",!0)])])])}const l$=de(QA,[["render",i$],["__scopeId","data-v-7dfddba5"]]),c$={name:"UnifiedUserManagement",components:{DrillDownNavigation:VS,ContextSidebar:D2,UserListPanel:CA,AnalysisPanel:ZA,ManagementPanel:l$},props:{config:{type:Object,default:()=>({enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"})}},setup(o){console.log("[UnifiedUserManagement] Component loaded successfully",o.config);const e=I("global"),s=I(null),t=I(!1),r=I([{id:1,name:"Иван Иванов",email:"ivan@example.com",departments:[{id:369,name:"Битрикс24 отдел",color:"#2196F3"}],is_admin:!0,activity_stats:{total_actions:156,last_activity:new Date().toISOString(),activity_score:85},status:"online"},{id:2,name:"Петр Петров",email:"petr@example.com",departments:[{id:366,name:"Сектор 1С",color:"#4CAF50"}],is_admin:!1,activity_stats:{total_actions:89,last_activity:new Date(Date.now()-864e5).toISOString(),activity_score:67},status:"away"},{id:3,name:"Анна Сидорова",email:"anna@example.com",departments:[],is_admin:!1,activity_stats:{total_actions:23,last_activity:new Date(Date.now()-6048e5).toISOString(),activity_score:35},status:"offline"}]),i=I({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc"}),n=I([{id:"total_users",label:"Всего пользователей",value:r.value.length,change:5.2},{id:"active_users",label:"Активных сегодня",value:r.value.filter(y=>y.status==="online").length,change:12.1},{id:"new_users",label:"Новых сегодня",value:1,change:-2.3}]),l=M(()=>{const y=[{id:"global",label:"Управление пользователями",icon:"UsersIcon",action:()=>d("global")}];return e.value==="user"&&s.value&&y.push({id:`user-${s.value.id}`,label:s.value.name,icon:"UserIcon",action:()=>g(s.value)}),e.value==="management"&&y.push({id:"management",label:"Управление правами",icon:"SettingsIcon",action:()=>d("management")}),y}),d=(y,S={})=>{e.value=y,S.user&&(s.value=S.user),console.log(`[UnifiedUserManagement] Switched to context: ${y}`,S)},g=y=>{s.value=y,d("user",{user:y})};return{currentContext:e,selectedUser:s,loading:t,users:r,filters:i,globalMetrics:n,breadcrumbs:l,handleUserSelect:y=>{g(y)},handleBreadcrumbNavigate:y=>{y.action&&y.action()},handleGoBack:()=>{(e.value==="user"||e.value==="management")&&(d("global"),s.value=null),console.log("[UnifiedUserManagement] Returned to global context")},handleMetricClick:y=>{console.log("Metric clicked:",y)}}}},d$={class:"unified-user-management"},u$={class:"management-grid"},g$={class:"main-content-area"};function m$(o,e,s,t,r,i){const n=be("DrillDownNavigation"),l=be("ContextSidebar"),d=be("UserListPanel"),g=be("AnalysisPanel"),v=be("ManagementPanel");return c(),u("div",d$,[ne(n,{breadcrumbs:t.breadcrumbs,"is-loading":t.loading,onNavigate:t.handleBreadcrumbNavigate,onBack:t.handleGoBack},null,8,["breadcrumbs","is-loading","onNavigate","onBack"]),a("div",u$,[ne(l,{context:t.currentContext,"global-metrics":t.globalMetrics,"selected-user":t.selectedUser,onMetricClick:t.handleMetricClick},null,8,["context","global-metrics","selected-user","onMetricClick"]),a("div",g$,[t.currentContext==="global"?(c(),he(d,{key:0,users:t.users,loading:t.loading,pagination:{current_page:1,total:t.users.length,total_pages:1},filters:t.filters,"can-edit-permissions":!0,"can-delete":!1,onUserSelect:t.handleUserSelect},null,8,["users","loading","pagination","filters","onUserSelect"])):t.currentContext==="user"?(c(),he(g,{key:1,user:t.selectedUser,onBack:t.handleGoBack},null,8,["user","onBack"])):t.currentContext==="management"?(c(),he(v,{key:2,onBack:t.handleGoBack},null,8,["onBack"])):$("",!0)])])])}const h$=de(c$,[["render",m$],["__scopeId","data-v-953cd27b"]]),f$={name:"UsersManagementPage",components:{UnifiedUserManagement:h$},setup(){const o=Xe();return $e(async()=>{try{if(!(await it.checkAccess()).allowed){o.push("/");return}if(!await it.getCurrentUser()){o.push("/");return}console.log("[UsersManagementPage] Access granted - loading unified interface")}catch(e){console.error("[UsersManagementPage] Access check failed:",e),o.push("/")}}),{}}},v$={class:"users-management-page"};function p$(o,e,s,t,r,i){const n=be("UnifiedUserManagement");return c(),u("div",v$,[ne(n,{config:{enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"}})])}const y$=de(f$,[["render",p$],["__scopeId","data-v-3ef05244"]]);class Pe{static async getCacheStatus(){try{const e=tt("/api/admin/cache-status.php");console.log("[CacheManagementService] Fetching cache status from:",e);const s=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(console.log("[CacheManagementService] Response status:",s.status),!s.ok){const r=await s.text();throw console.error("[CacheManagementService] HTTP error:",r),new Error(`HTTP error! status: ${s.status}, message: ${r}`)}const t=await s.json();if(console.log("[CacheManagementService] API result:",t),t.success){let r=t.modules||[];console.log("[CacheManagementService] Modules from API:",r.length,r),r.length===0&&(console.log("[CacheManagementService] Using mock data for UI demonstration"),r=this.getMockModules(),console.log("[CacheManagementService] Mock modules:",r.length));const i=this.categorizeAndSortModules(r);return console.log("[CacheManagementService] Categorized result:",i),i}else throw new Error(t.error||"Failed to get cache status")}catch(e){console.error("[CacheManagementService] Error getting cache status:",e),console.log("[CacheManagementService] Using mock data due to API error");const s=this.getMockModules(),t=this.categorizeAndSortModules(s);return console.log("[CacheManagementService] Mock categorized result:",t),t}}static async clearCache(e){try{const s=tt("/api/admin/cache-clear.php"),t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,confirm:!0})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return!0;throw new Error(r.error||"Failed to clear cache")}catch(s){throw console.error("[CacheManagementService] Error clearing cache:",s),s}}static async getCacheStats(){try{const e=tt("/api/admin/cache-stats.php"),s=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(t.success)return t.stats||{};throw new Error(t.error||"Failed to get cache stats")}catch(e){throw console.error("[CacheManagementService] Error getting cache stats:",e),e}}static formatCacheSize(e){if(e===0)return"0 B";const s=1024,t=["B","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(s));return Math.round(e/Math.pow(s,r)*100)/100+" "+t[r]}static categorizeAndSortModules(e,s={}){const t=this.generateCacheKey(e),r=this.getCachedResult(t);if(r&&!s.forceRefresh)return r;const i=performance.now(),n=this.performCategorization(e),l=performance.now();return n.metadata={processingTime:l-i,totalModules:e.length,primaryCount:n.primaryModules.length,secondaryCount:n.secondaryModules.length,cached:!1},this.setCachedResult(t,n),n}static performCategorization(e){const s=[],t=[];return e.forEach(r=>{this.validateModule(r),this.PRIMARY_MODULE_IDS.includes(r.id)?s.push({...r,category:"primary",priority:this.PRIMARY_MODULE_PRIORITIES[r.id]||999}):t.push({...r,category:"secondary",groupType:this.getModuleType(r.id)})}),{primaryModules:this.sortPrimaryModules(s),secondaryModules:this.sortSecondaryModules(t)}}static sortPrimaryModules(e){return e.sort((s,t)=>{const r=this.PRIMARY_MODULE_PRIORITIES[s.id]||999,i=this.PRIMARY_MODULE_PRIORITIES[t.id]||999;return r-i})}static sortSecondaryModules(e){return e.sort((s,t)=>{const r=this.getModuleType(s.id),i=this.getModuleType(t.id);return r!==i?this.compareModuleTypes(r,i):s.name.localeCompare(t.name)})}static compareModuleTypes(e,s){const t=["users","activity","webhooks","other"],r=t.indexOf(e),i=t.indexOf(s);return(r===-1?999:r)-(i===-1?999:i)}static getModuleType(e){for(const[s,t]of Object.entries(this.SECONDARY_MODULE_TYPES))if(e.startsWith(t.prefix))return s;return e.includes("time-tracking")?"time-tracking":e.includes("graph")?"graphs":e.includes("dashboard")?"dashboards":"other"}static getModuleTypeConfig(e){return this.SECONDARY_MODULE_TYPES[e]||{title:"🔧 Прочие модули",description:"Дополнительные модули системы"}}static validateModule(e){if(!e||typeof e!="object")throw new Error("Module must be an object");if(!e.id||typeof e.id!="string")throw new Error("Module must have a valid id");if(!e.name||typeof e.name!="string")throw new Error("Module must have a valid name");return!0}static generateCacheKey(e){const s=e.map(t=>t.id).sort().join(",");return btoa(s).substring(0,16)}static getCachedResult(e){const s=this.categorizationCache.get(e);return s?Date.now()-s.timestamp>this.CACHE_TTL?(this.categorizationCache.delete(e),null):{...s.data,metadata:{...s.data.metadata,cached:!0}}:null}static setCachedResult(e,s){if(this.categorizationCache.set(e,{data:{...s,metadata:{...s.metadata,cached:!1}},timestamp:Date.now()}),this.categorizationCache.size>10){const t=this.categorizationCache.keys().next().value;this.categorizationCache.delete(t)}}static clearCategorizationCache(){this.categorizationCache.clear()}static invalidateCacheAfterModuleOperation(){this.clearCategorizationCache()}static getCategorizationStats(){return{cacheSize:this.categorizationCache.size,cacheEntries:Array.from(this.categorizationCache.entries()).map(([e,s])=>({key:e,age:Date.now()-s.timestamp,modulesCount:s.data.primaryModules.length+s.data.secondaryModules.length}))}}static formatTTL(e){return e<60?`${e} сек`:e<3600?`${Math.floor(e/60)} мин`:`${Math.floor(e/3600)} ч`}static formatCreationTime(e){return e<1e3?`${Math.round(e)}мс`:e<6e4?`${Math.round(e/1e3*10)/10}сек`:`${Math.round(e/6e4*10)/10}мин`}static formatCacheHitRatio(e){return`${Math.round(e*100)}%`}static formatDataFreshness(e){return`${Math.round(e*100)}%`}static getExpiryColor(e){if(!e)return"gray";const s=Date.now()/1e3,t=(e-s)/3600;return t>2?"green":t>.5?"yellow":"red"}static getEfficiencyColor(e){return e>=.85?"green":e>=.7?"yellow":"red"}static getCreationTimeColor(e){return e<=2e3?"green":e<=1e4?"yellow":"red"}static getFreshnessColor(e){return e>=.9?"green":e>=.7?"yellow":"red"}static generateModuleMetadata(e){const s=Math.floor(Date.now()/1e3),t=e.metadata||{},r=this.PRIMARY_MODULE_IDS.includes(e.id);return{version:t.version||"1.0",module_id:e.id,module_name:e.name,created_at:t.created_at||s-Math.random()*86400*7,created_by:t.created_by||(Math.random()>.5?"system":"cron"),creation_time_ms:t.creation_time_ms||500+Math.random()*9500,last_accessed_at:t.last_accessed_at||s-Math.random()*3600,access_count:t.access_count||Math.floor(Math.random()*100)+1,expires_at:t.expires_at||s+(e.ttl||3600),ttl_seconds:e.ttl||3600,file_size_bytes:e.total_size||Math.floor(Math.random()*1e7)+1e6,compression_ratio:t.compression_ratio||.7+Math.random()*.3,data_version:t.data_version||`2026.01.12.v${Math.floor(Math.random()*10)+1}`,source_params:t.source_params||{period:r?Math.random()>.5?"weeks":"months":"default",sector_id:e.id.includes("sector-1c")?"1c":"all",filters:Math.random()>.5?["active_only"]:[],limit:Math.floor(Math.random()*1e3)+500},performance_metrics:t.performance_metrics||{avg_response_time_ms:20+Math.random()*80,cache_hit_ratio:.7+Math.random()*.3,data_freshness_score:.8+Math.random()*.2}}}static getMockModules(){const e=Math.floor(Date.now()/1e3);return[{id:"dashboard-sector-1c",name:"Дашборд сектора 1С",status:"active",file_count:5,total_size:1024e3,ttl:600,created_at:e-7200,expires_at:e+1800,cache_dir:"api/cache/dashboard-sector-1c"},{id:"graph-state",name:"График состояния",status:"active",file_count:3,total_size:512e3,ttl:3600,created_at:e-3600,expires_at:e+7200,cache_dir:"api/cache/graph-state"},{id:"graph-admission-closure-weeks",name:"График приема/закрытий 1С (4 недели)",status:"active",file_count:8,total_size:2048e3,ttl:300,created_at:e-1800,expires_at:e+120,cache_dir:"api/cache/graph-admission-closure/weeks"},{id:"graph-admission-closure-months",name:"График приема/закрытий 1С (3 месяца)",status:"active",file_count:12,total_size:3072e3,ttl:300,created_at:e-3600,expires_at:e+240,cache_dir:"api/cache/graph-admission-closure/months"},{id:"time-tracking-default",name:"Трудозатраты (режим по умолчанию)",status:"active",file_count:4,total_size:768e3,ttl:300,created_at:e-900,expires_at:e+2100,cache_dir:"api/cache/time-tracking-sector-1c/default"},{id:"time-tracking-detailed",name:"Трудозатраты (детальный режим)",status:"active",file_count:6,total_size:1536e3,ttl:120,created_at:e-600,expires_at:e+3540,cache_dir:"api/cache/time-tracking-sector-1c/detailed"},{id:"time-tracking-summary",name:"Трудозатраты (сводный режим)",status:"active",file_count:2,total_size:384e3,ttl:600,created_at:e-1800,expires_at:e+4200,cache_dir:"api/cache/time-tracking-sector-1c/summary"},{id:"users-management-departments",name:"Управление пользователями (отделы)",status:"active",file_count:2,total_size:256e3,ttl:3600,created_at:e-7200,expires_at:e+28800,cache_dir:"api/cache/users-management/departments"},{id:"webhook-logs-api",name:"Логи вебхуков (API запросы)",status:"active",file_count:15,total_size:512e4,ttl:300,created_at:e-3600,expires_at:e+2400,cache_dir:"api/cache/webhook-logs/api"}]}static enrichModulesWithMetadata(e){return e.map(s=>({...s,metadata:this.generateModuleMetadata(s)}))}}je(Pe,"PRIMARY_MODULE_IDS",["dashboard-sector-1c","graph-state","graph-admission-closure-weeks","graph-admission-closure-months","time-tracking-default","time-tracking-detailed","time-tracking-summary"]),je(Pe,"PRIMARY_MODULE_PRIORITIES",{"dashboard-sector-1c":1,"graph-state":2,"graph-admission-closure-weeks":3,"graph-admission-closure-months":4,"time-tracking-default":5,"time-tracking-detailed":6,"time-tracking-summary":7}),je(Pe,"SECONDARY_MODULE_TYPES",{users:{prefix:"users-management",title:"👥 Управление пользователями",description:"Модули для управления пользователями и отделами"},activity:{prefix:"user-activity",title:"📊 Отслеживание активности",description:"Мониторинг активности пользователей"},webhooks:{prefix:"webhook-logs",title:"🔗 Логи вебхуков",description:"Логирование и мониторинг вебхуков"}}),je(Pe,"categorizationCache",new Map),je(Pe,"CACHE_TTL",3e4);function k$(o){const e=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),s=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-s);const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}class Ns{static async createCache(e,s=null,t={}){try{const r=tt("/api/admin/cache-create.php"),i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,mode:s,params:t})});if(!i.ok){const l=await i.json().catch(()=>({}));throw new Error(l.error||`HTTP error! status: ${i.status}`)}const n=await i.json();if(n.success)return n;throw new Error(n.error||"Failed to create cache")}catch(r){throw console.error("[CacheCreationService] Error creating cache:",r),r}}static async getCreationStatus(e){try{const s=tt(`/api/admin/cache-create-status.php?task_id=${e}`),t=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return r;throw new Error(r.error||"Failed to get creation status")}catch(s){throw console.error("[CacheCreationService] Error getting creation status:",s),s}}static getDefaultParams(e){if(e.includes("graph-admission-closure"))if((e.includes("weeks")?"weeks":"months")==="weeks"){const t=new Date,r=t.getUTCFullYear(),i=k$(t),n=new Date(r,0,1+(i-1)*7),l=n.getUTCDay(),d=n.getUTCDate()-l+(l===0?-6:1);n.setUTCDate(d),n.setUTCHours(0,0,0,0);const g=new Date(n);return g.setUTCDate(n.getUTCDate()+6),g.setUTCHours(23,59,59,999),{product:"1C",periodMode:"weeks",weekStartUtc:n.toISOString(),weekEndUtc:g.toISOString(),includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,useCache:!0,forceRefresh:!0}}else return{product:"1C",periodMode:"months",includeTickets:!0,includeNewTicketsByStages:!1,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!1};if(e.includes("dashboard-sector-1c"))return{forceRefresh:!0,ttl:600};if(e.includes("graph-state"))return{type:"current",forceRefresh:!0,ttl:3600};if(e.includes("time-tracking")){const s=e.includes("detailed")?"detailed":e.includes("summary")?"summary":"default";return{product:"1C",includeTaskDetails:s==="detailed",summary:s==="summary"}}return{}}}let ls=class{static notifyCacheCreationStarted(e){this.showNotification({content:`Начато создание кеша для модуля "${e}"...`,type:"info",autoHideDelay:3e3})}static notifyCacheCreationSuccess(e){this.showNotification({content:`✅ Кеш для модуля "${e}" успешно создан`,type:"success",autoHideDelay:5e3})}static notifyCacheCreationError(e,s){this.showNotification({content:`❌ Ошибка создания кеша для модуля "${e}": ${s}`,type:"error",autoHideDelay:7e3})}static notifyCacheUpdated(e,s="auto"){const t=s==="manual"?"вручную":"автоматически";this.showNotification({content:`🔄 Кеш для модуля "${e}" обновлён ${t}`,type:"info",autoHideDelay:4e3})}static notifyCacheUsed(e){this.showNotification({content:`⚡ Использован кеш для модуля "${e}"`,type:"success",autoHideDelay:3e3})}static showNotification(e){typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:e.content,autoHideDelay:e.autoHideDelay||3e3}):console.log("[CacheNotification]",e.content)}};const b$=Object.freeze(Object.defineProperty({__proto__:null,CacheNotificationService:ls},Symbol.toStringTag,{value:"Module"})),_$={name:"CacheCreateProgress",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},message:{type:String,default:"Создание кеша..."}}},w$={class:"cache-create-progress"},C$={class:"progress-bar"},T$={class:"progress-text"};function S$(o,e,s,t,r,i){return c(),u("div",w$,[a("div",C$,[a("div",{class:"progress-fill",style:we({width:s.progress+"%"})},null,4)]),a("div",T$,m(s.progress)+"% - "+m(s.message),1)])}const D$=de(_$,[["render",S$],["__scopeId","data-v-7071de3b"]]),E$={name:"CacheCreateModal",components:{CacheCreateProgress:D$},props:{module:{type:Object,required:!0}},emits:["close","create"],setup(o,{emit:e}){const s=I(!1),t=I(0),r=I(""),i=I(null),n=I(""),l=M(()=>o.module.id.includes("graph-admission-closure")||o.module.id.includes("time-tracking")),d=M(()=>o.module.id.includes("graph-admission-closure")?["months","weeks"]:o.module.id.includes("time-tracking")?["default","detailed","summary"]:[]),g=()=>{e("close")},v=f=>{f.preventDefault(),f.stopPropagation(),f.target===f.currentTarget&&g()},T=async()=>{s.value=!0,t.value=0,r.value="Начало создания кеша...";try{let f={};if(n.value.trim())try{f=JSON.parse(n.value)}catch{throw new Error("Неверный формат JSON параметров")}else f=Ns.getDefaultParams(o.module.id);ls.notifyCacheCreationStarted(o.module.name),t.value=25,r.value="Загрузка данных из Bitrix24...";const p=await Ns.createCache(o.module.id,i.value,f);t.value=75,r.value="Сохранение кеша...",await new Promise(y=>setTimeout(y,500)),t.value=100,r.value="Кеш успешно создан!",ls.notifyCacheCreationSuccess(o.module.name),setTimeout(()=>{e("create",p),g()},1e3)}catch(f){console.error("[CacheCreateModal] Error creating cache:",f),ls.notifyCacheCreationError(o.module.name,f.message),s.value=!1}};return $e(()=>{d.value.length>0&&(i.value=d.value[0]);const f=Ns.getDefaultParams(o.module.id);n.value=JSON.stringify(f,null,2)}),{creating:s,progress:t,progressMessage:r,selectedMode:i,paramsJson:n,supportsModes:l,availableModes:d,close:g,handleOverlayClick:v,handleCreate:T}}},A$={class:"modal-header"},$$={class:"modal-body"},I$={key:1,class:"create-form"},M$={key:0,class:"form-group"},N$=["value"],x$={class:"form-group"},L$={class:"modal-footer"},P$=["disabled"],O$=["disabled"],B$={key:0},R$={key:1};function W$(o,e,s,t,r,i){const n=be("CacheCreateProgress");return c(),he(It,{to:"body"},[a("div",{class:"modal-overlay",onClick:e[6]||(e[6]=(...l)=>t.handleOverlayClick&&t.handleOverlayClick(...l))},[a("div",{class:"modal-content",onClick:e[5]||(e[5]=Ce(()=>{},["stop"])),style:{"pointer-events":"auto"}},[a("div",A$,[a("h2",null,"Создание кеша: "+m(s.module.name),1),a("button",{onClick:e[0]||(e[0]=(...l)=>t.close&&t.close(...l)),class:"btn-close"},"×")]),a("div",$$,[t.creating?(c(),he(n,{key:0,progress:t.progress,message:t.progressMessage},null,8,["progress","message"])):(c(),u("div",I$,[t.supportsModes?(c(),u("div",M$,[e[7]||(e[7]=a("label",null,"Режим кеша:",-1)),Be(a("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>t.selectedMode=l),class:"form-control"},[(c(!0),u(ee,null,te(t.availableModes,l=>(c(),u("option",{key:l,value:l},m(l),9,N$))),128))],512),[[ut,t.selectedMode]])])):$("",!0),a("div",x$,[e[8]||(e[8]=a("label",null,"Параметры (JSON):",-1)),Be(a("textarea",{"onUpdate:modelValue":e[2]||(e[2]=l=>t.paramsJson=l),placeholder:'{"product": "1C", ...}',rows:"5",class:"form-control"},null,512),[[At,t.paramsJson]]),e[9]||(e[9]=a("small",{class:"form-text"},"Оставьте пустым для использования параметров по умолчанию",-1))])]))]),a("div",L$,[a("button",{onClick:e[3]||(e[3]=(...l)=>t.close&&t.close(...l)),class:"btn-cancel",disabled:t.creating},"Отмена",8,P$),a("button",{onClick:e[4]||(e[4]=(...l)=>t.handleCreate&&t.handleCreate(...l)),disabled:t.creating,class:"btn-create"},[t.creating?(c(),u("span",B$,"Создание...")):(c(),u("span",R$,"Создать кеш"))],8,O$)])])])])}const U$=de(E$,[["render",W$],["__scopeId","data-v-1fa7d83b"]]),F$={name:"CacheCreateButton",components:{CacheCreateModal:U$},props:{module:{type:Object,required:!0}},emits:["created"],setup(o,{emit:e}){const s=I(!1),t=I(!1);return{showModal:s,creating:t,openModal:()=>{s.value=!0},closeModal:()=>{s.value=!1},handleCreate:async l=>{t.value=!0;try{e("created",l)}finally{t.value=!1}}}}},H$={class:"cache-create-button"},j$=["disabled"],z$={key:0},V$={key:1};function G$(o,e,s,t,r,i){const n=be("CacheCreateModal");return c(),u("div",H$,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.openModal&&t.openModal(...l)),disabled:t.creating,class:X(["btn-create",{"btn-disabled":t.creating}])},[t.creating?(c(),u("span",z$,"Создание...")):(c(),u("span",V$,"➕ Создать кеш"))],10,j$),t.showModal?(c(),he(n,{key:0,module:s.module,onClose:t.closeModal,onCreate:t.handleCreate},null,8,["module","onClose","onCreate"])):$("",!0)])}const K$=de(F$,[["render",G$],["__scopeId","data-v-45e7d308"]]);class Ye{static success(e,s,t={}){this.show("success",e,s,t)}static error(e,s,t={}){this.show("error",e,s,t)}static warning(e,s,t={}){this.show("warning",e,s,t)}static info(e,s,t={}){this.show("info",e,s,t)}static show(e,s,t,r={}){const i={autoHideDelay:r.autoHideDelay||5e3,position:r.position||"top-right",...r};this.isBitrix24Available()?this.showBitrix24Notification(e,s,t,i):this.showFallbackNotification(e,s,t,i)}static isBitrix24Available(){return typeof window<"u"&&window.BX&&window.BX.UI&&window.BX.UI.Notification&&window.BX.UI.Notification.Center&&typeof window.BX.UI.Notification.Center.notify=="function"}static showBitrix24Notification(e,s,t,r){try{const n={success:"success",error:"error",warning:"warning",info:"info"}[e]||"info",l=s?`${s}: ${t}`:t;window.BX.UI.Notification.Center.notify({content:l,autoHideDelay:r.autoHideDelay,category:`cache-management-${e}`,position:r.position}),console.log(`[NotificationSystem] Bitrix24 notification shown: ${e}`,{title:s,message:t,config:r})}catch(i){console.error("[NotificationSystem] Error showing Bitrix24 notification:",i),this.showFallbackNotification(e,s,t,r)}}static showFallbackNotification(e,s,t,r){if("Notification"in window&&Notification.permission==="granted")try{const i=new Notification(s||"Уведомление",{body:t,icon:this.getIconForType(e),tag:`cache-management-${e}`});setTimeout(()=>{i.close()},r.autoHideDelay),console.log(`[NotificationSystem] Browser notification shown: ${e}`,{title:s,message:t});return}catch(i){console.warn("[NotificationSystem] Browser notification failed:",i)}this.showCustomNotification(e,s,t,r)}static showCustomNotification(e,s,t,r){let i=document.getElementById("notification-container");if(!i){i=document.createElement("div"),i.id="notification-container",i.className="notification-container",document.body.appendChild(i);const d=document.createElement("style");d.textContent=this.getNotificationStyles(),document.head.appendChild(d)}const n=document.createElement("div");n.className=`custom-notification notification-${e}`,n.innerHTML=`
      <div class="notification-content">
        <div class="notification-title">${s||""}</div>
        <div class="notification-message">${t}</div>
      </div>
      <button class="notification-close" aria-label="Закрыть уведомление">×</button>
    `,n.querySelector(".notification-close").addEventListener("click",()=>{this.removeCustomNotification(n)}),i.appendChild(n),setTimeout(()=>{this.removeCustomNotification(n)},r.autoHideDelay),console.log(`[NotificationSystem] Custom notification shown: ${e}`,{title:s,message:t})}static removeCustomNotification(e){e&&e.parentNode&&(e.classList.add("notification-hiding"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}static getIconForType(e){const s={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"};return s[e]||s.info}static getNotificationStyles(){return`
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        pointer-events: none;
      }

      .custom-notification {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        min-width: 300px;
        max-width: 500px;
        pointer-events: auto;
        opacity: 0;
        transform: translateX(100%);
        animation: notificationSlideIn 0.3s ease forwards;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 16px;
        gap: 12px;
      }

      .custom-notification.notification-success {
        border-left-color: #28a745;
      }

      .custom-notification.notification-error {
        border-left-color: #dc3545;
      }

      .custom-notification.notification-warning {
        border-left-color: #ffc107;
      }

      .custom-notification.notification-info {
        border-left-color: #17a2b8;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #333;
      }

      .notification-message {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
      }

      .notification-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        flex-shrink: 0;
      }

      .notification-close:hover {
        color: #333;
      }

      .notification-hiding {
        animation: notificationSlideOut 0.3s ease forwards;
      }

      @keyframes notificationSlideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes notificationSlideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      @media (max-width: 768px) {
        .notification-container {
          left: 10px;
          right: 10px;
          top: 10px;
        }

        .custom-notification {
          min-width: auto;
          max-width: none;
        }
      }
    `}static clearAll(){try{this.isBitrix24Available()&&window.BX.UI.Notification.Center.clearAll&&window.BX.UI.Notification.Center.clearAll()}catch(s){console.warn("[NotificationSystem] Error clearing Bitrix24 notifications:",s)}const e=document.getElementById("notification-container");if(e&&(e.innerHTML=""),"Notification"in window&&"getNotifications"in Notification)try{Notification.getNotifications().forEach(t=>{t.tag&&t.tag.startsWith("cache-management-")&&t.close()})}catch(s){console.warn("[NotificationSystem] Error clearing browser notifications:",s)}}}Ye.show.bind(Ye);Ye.success.bind(Ye);Ye.error.bind(Ye);Ye.warning.bind(Ye);Ye.info.bind(Ye);let ze=null,ot=null;const Pt=class Pt{static show(e={}){return new Promise((s,t)=>{ot=s,ze||(ze=this.createModal(),document.body.appendChild(ze)),this.configureModal(e),this.showModal()})}static hide(){ze&&(this.hideModal(),ot&&(ot(!1),ot=null))}static createModal(){const e=document.createElement("div");return e.className="cache-confirmation-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","confirmation-title"),e.setAttribute("aria-describedby","confirmation-message"),e.innerHTML=`
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="confirmation-title" class="modal-title"></h3>
          <button
            class="modal-close"
            data-action="cancel"
            aria-label="Закрыть окно подтверждения"
          >
            ×
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-icon">
            <span class="icon-symbol"></span>
          </div>
          <p id="confirmation-message" class="modal-message"></p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-cancel" data-action="cancel"></button>
          <button class="btn btn-confirm" data-action="confirm"></button>
        </div>
      </div>
    `,this.attachEventListeners(e),this.addStyles(),e}static configureModal(e){const{title:s="Подтверждение действия",message:t="Вы уверены, что хотите выполнить это действие?",type:r="warning",confirmText:i="Подтвердить",cancelText:n="Отмена",showCancel:l=!0}=e,d=ze.querySelector(".modal-title");d.textContent=s;const g=ze.querySelector(".modal-message");g.textContent=t;const v=ze.querySelector(".icon-symbol"),T={danger:"⚠️",warning:"⚠️",info:"ℹ️",success:"✅"};v.textContent=T[r]||T.warning;const f=ze.querySelector(".btn-cancel"),p=ze.querySelector(".btn-confirm");f.textContent=n,p.textContent=i,l?f.style.display="inline-block":f.style.display="none",ze.className=`cache-confirmation-modal modal-${r}`}static showModal(){document.body.style.overflow="hidden",ze.style.display="flex",ze.classList.add("modal-visible"),setTimeout(()=>{const e=ze.querySelector(".btn-confirm");e&&e.focus()},100),document.addEventListener("keydown",this.handleKeyDown)}static hideModal(){document.body.style.overflow="",ze.classList.remove("modal-visible"),document.removeEventListener("keydown",this.handleKeyDown),setTimeout(()=>{ze&&(ze.style.display="none")},300)}static attachEventListeners(e){e.addEventListener("click",s=>{const t=s.target.closest("[data-action]")?.getAttribute("data-action");t==="confirm"?this.handleConfirm():t==="cancel"&&this.handleCancel()})}static handleConfirm(){ot&&(ot(!0),ot=null),this.hideModal()}static handleCancel(){ot&&(ot(!1),ot=null),this.hideModal()}static handleTabNavigation(e){const t=ze.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=t[0],i=t[t.length-1];e.shiftKey?document.activeElement===r&&(e.preventDefault(),i.focus()):document.activeElement===i&&(e.preventDefault(),r.focus())}static addStyles(){if(document.getElementById("cache-confirmation-styles"))return;const e=document.createElement("style");e.id="cache-confirmation-styles",e.textContent=`
      .cache-confirmation-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .cache-confirmation-modal.modal-visible {
        display: flex;
      }

      .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        z-index: 10001;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: #f0f0f0;
        color: #333;
      }

      .modal-body {
        padding: 24px;
        text-align: center;
      }

      .modal-icon {
        margin-bottom: 16px;
      }

      .icon-symbol {
        font-size: 48px;
        display: block;
      }

      .modal-message {
        margin: 0;
        font-size: 16px;
        color: #555;
        line-height: 1.5;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px 24px;
        border-top: 1px solid #e0e0e0;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
      }

      .btn-cancel {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
      }

      .btn-cancel:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }

      .btn-confirm {
        background: #007bff;
        color: white;
      }

      .btn-confirm:hover {
        background: #0056b3;
      }

      /* Типы модальных окон */
      .modal-danger .btn-confirm {
        background: #dc3545;
      }

      .modal-danger .btn-confirm:hover {
        background: #c82333;
      }

      .modal-warning .btn-confirm {
        background: #ffc107;
        color: #212529;
      }

      .modal-warning .btn-confirm:hover {
        background: #e0a800;
      }

      .modal-info .btn-confirm {
        background: #17a2b8;
      }

      .modal-info .btn-confirm:hover {
        background: #138496;
      }

      .modal-success .btn-confirm {
        background: #28a745;
      }

      .modal-success .btn-confirm:hover {
        background: #1e7e34;
      }

      /* Адаптивность */
      @media (max-width: 480px) {
        .modal-content {
          margin: 20px;
          width: calc(100% - 40px);
        }

        .modal-header,
        .modal-body,
        .modal-footer {
          padding-left: 20px;
          padding-right: 20px;
        }

        .modal-footer {
          flex-direction: column-reverse;
        }

        .btn {
          width: 100%;
        }
      }

      /* Доступность */
      @media (prefers-reduced-motion: reduce) {
        .modal-content,
        .modal-close,
        .btn {
          animation: none;
          transition: none;
        }
      }

      /* Высокий контраст */
      @media (prefers-contrast: high) {
        .modal-content {
          border: 2px solid #000;
        }

        .btn-cancel {
          border: 2px solid #000;
        }

        .btn-confirm {
          border: 2px solid #000;
        }
      }
    `,document.head.appendChild(e)}};je(Pt,"handleKeyDown",e=>{switch(e.key){case"Enter":e.preventDefault(),Pt.handleConfirm();break;case"Escape":e.preventDefault(),Pt.handleCancel();break;case"Tab":Pt.handleTabNavigation(e);break}});let $t=Pt;$t.show.bind($t);$t.hide.bind($t);const q$={name:"CacheModuleCard",components:{CacheCreateButton:K$},props:{module:{type:Object,required:!0,validator:o=>o&&typeof o.id=="string"&&typeof o.name=="string"},isPrimary:{type:Boolean,default:!1},priority:{type:Number,default:999},groupType:{type:String,default:null}},emits:["clear","refresh","details"],setup(o,{emit:e}){const s=I(!1),t=I(!1),r=I(!1),i=I(!1),n=b=>{if(!b.target.closest(".action-button"))switch(b.key){case"Enter":case" ":b.preventDefault();const O=b.currentTarget.querySelector(".action-button:not([disabled])");O&&O.focus();break}};$e(()=>{const b=()=>{i.value=window.innerWidth<768};b(),window.addEventListener("resize",b);const O=document.querySelector(`[data-module-id="${o.module.id}"]`);O&&O.addEventListener("keydown",n)}),st(()=>{const b=document.querySelector(`[data-module-id="${o.module.id}"]`);b&&b.removeEventListener("keydown",n)});const l=M(()=>({"cache-module-card":!0,"primary-module":o.isPrimary,"secondary-module":!o.isPrimary,"high-priority":o.priority<=3,"expiring-soon":S.value,"empty-cache":p.value,loading:s.value||t.value,[w.value]:!0})),d=M(()=>o.isPrimary?"🏆":{users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"}[o.groupType]||"🔧"),g=M(()=>({"primary-icon":o.isPrimary,"secondary-icon":!o.isPrimary})),v=M(()=>o.isPrimary?"Основной модуль":o.groupType?Pe.getModuleTypeConfig(o.groupType).title||"Неизвестная группа":""),T=M(()=>o.priority?`priority-${o.priority}`:""),f=M(()=>`status-${o.module.status||"empty"}`),p=M(()=>(o.module.file_count||0)===0),y=M(()=>o.module.expires_at?new Date(o.module.expires_at*1e3)<=new Date:!1),S=M(()=>{if(!o.module.expires_at)return!1;const Q=(new Date(o.module.expires_at*1e3)-new Date)/(1e3*60*60);return Q>0&&Q<=2}),C=M(()=>{const b=o.module.status;return b==="active"?"Активен":b==="expired"?"Просрочен":b==="empty"?"Пуст":"Неизвестен"}),k=M(()=>Pe.formatCacheSize(o.module.total_size||0)),_=M(()=>Pe.formatTTL(o.module.ttl||0)),A=M(()=>{if(!o.module.cache_dir)return"";const b=o.module.cache_dir.split("/");return b.length>2?"..."+b.slice(-2).join("/"):o.module.cache_dir}),W=M(()=>o.module.metadata?.creation_time_ms?Pe.formatCreationTime(o.module.metadata.creation_time_ms):"—"),x=M(()=>{if(!o.module.metadata?.last_accessed_at)return"—";const b=new Date(o.module.metadata.last_accessed_at*1e3),Q=new Date-b;return Q<6e4?"Только что":Q<36e5?`${Math.floor(Q/6e4)} мин назад`:b.toLocaleString("ru-RU",{hour:"2-digit",minute:"2-digit"})}),D=M(()=>o.module.metadata?.access_count||0),E=M(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?Pe.formatCacheHitRatio(o.module.metadata.performance_metrics.cache_hit_ratio):"—"),L=M(()=>o.module.metadata?.performance_metrics?.data_freshness_score?Pe.formatDataFreshness(o.module.metadata.performance_metrics.data_freshness_score):"—"),B=M(()=>o.module.expires_at?`metric-${Pe.getExpiryColor(o.module.expires_at)}`:""),U=M(()=>o.module.metadata?.creation_time_ms?`metric-${Pe.getCreationTimeColor(o.module.metadata.creation_time_ms)}`:""),G=M(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?`metric-${Pe.getEfficiencyColor(o.module.metadata.performance_metrics.cache_hit_ratio)}`:""),q=M(()=>o.module.metadata?.performance_metrics?.data_freshness_score?`metric-${Pe.getFreshnessColor(o.module.metadata.performance_metrics.data_freshness_score)}`:""),oe=M(()=>{if(!o.module.expires_at)return null;const b=new Date(o.module.expires_at*1e3);return Math.max(0,Math.floor((b-new Date)/1e3))}),Y=M(()=>{if(oe.value===null)return"—";if(oe.value<=0)return"Истек";const b=Math.floor(oe.value/3600),O=Math.floor(oe.value%3600/60),Q=oe.value%60;return b>0?`${b}ч ${O}м`:O>0?`${O}м ${Q}с`:`${Q}с`}),H=M(()=>oe.value===null?"":oe.value<=0||oe.value<=1800?"metric-red":oe.value<=7200?"metric-orange":"metric-green"),Z=b=>{if(b===0)return"0 B";const O=1024,Q=["B","KB","MB","GB","TB"],ue=Math.floor(Math.log(b)/Math.log(O));return parseFloat((b/Math.pow(O,ue)).toFixed(1))+" "+Q[ue]},fe=b=>b<60?`${b}с`:b<3600?`${Math.floor(b/60)}м`:b<86400?`${Math.floor(b/3600)}ч`:`${Math.floor(b/86400)}д`,P=M(()=>{if(p.value)return"empty";if(y.value)return"expired";const b=oe.value;return b===null?"fresh":b<=0?"expired":b<=30*60*1e3?"critical":b<=2*60*60*1e3?"warning":"fresh"}),h=M(()=>{const b=P.value;return{fresh:"Свежий кеш",warning:"Истекает скоро",critical:"Критически истекает",expired:"Просрочен",empty:"Кеш пуст"}[b]||"Неизвестное состояние"}),w=M(()=>`cache-state-${P.value}`),R=M(()=>({fresh:"🟢",warning:"🟡",critical:"🔴",expired:"⚫",empty:"⚪"})[P.value]||"❓"),re=M(()=>!p.value&&!s.value),le=M(()=>o.isPrimary&&!p.value),ae=M(()=>p.value?"Кеш модуля пуст":`Очистить кеш модуля ${o.module.name}`),me=M(()=>{if(!o.module.created_at)return"—";const b=new Date(o.module.created_at*1e3),O=new Date,Q=O-b;if(Q<6e4)return"Только что";if(Q<36e5){const ke=Math.floor(Q/6e4);return`${ke} ${ke===1?"минуту":ke<5?"минуты":"минут"} назад`}if(b.toDateString()===O.toDateString())return`Сегодня в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`;const ue=new Date(O);return ue.setDate(ue.getDate()-1),b.toDateString()===ue.toDateString()?`Вчера в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`:b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),Se=M(()=>{if(!o.module.expires_at)return"—";const b=new Date(o.module.expires_at*1e3),Q=b-new Date;if(Q<0)return`Просрочен (${b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})`;const ue=Math.floor(Q/6e4),ke=Math.floor(ue/60);return ke>0?`${ke} ч ${ue%60} мин`:ue>0?`${ue} мин`:"Менее минуты"});return{clearing:s,creating:t,showDetailModal:r,isMobile:i,moduleClasses:l,moduleIcon:d,iconClass:g,moduleTypeText:v,priorityClass:T,statusClass:f,isEmpty:p,isExpired:y,isExpiringSoon:S,statusText:C,formattedSize:k,formattedTTL:_,shortCacheDir:A,formattedCreationTime:W,formattedLastAccess:x,accessCount:D,cacheEfficiency:E,dataFreshness:L,expiresClass:B,creationTimeClass:U,cacheEfficiencyClass:G,dataFreshnessClass:q,cacheState:P,cacheStateText:h,cacheStateClass:w,cacheStateIcon:R,timeToExpiry:oe,formatTimeToExpiry:Y,timeToExpiryClass:H,formatBytes:Z,formatTTL:fe,canClear:re,canShowDetails:le,clearButtonLabel:ae,formattedCreatedAt:me,formattedExpiresAt:Se,handleClear:async()=>{if(re.value)try{if(!await $t.show({title:"Подтверждение очистки кеша",message:`Вы действительно хотите очистить кеш модуля "${o.module.name}"?

Это действие нельзя отменить.`,type:"danger",confirmText:"🗑️ Очистить кеш",cancelText:"Отмена"}))return;s.value=!0,await Pe.clearCache(o.module.id),e("clear",o.module.id),Ye.success("Кеш успешно очищен",`Кеш модуля "${o.module.name}" был полностью очищен`)}catch(b){console.error("[CacheModuleCard] Error clearing cache:",b),Ye.error("Ошибка очистки кеша",`Не удалось очистить кеш модуля "${o.module.name}": ${b.message}`)}finally{s.value=!1}},handleCacheCreated:()=>{Pe.invalidateCacheAfterModuleOperation(),e("refresh")},handleCreatingState:b=>{t.value=b},showDetails:()=>{r.value=!0,e("details",o.module)},closeDetails:()=>{r.value=!1}}}},Y$=["aria-labelledby","aria-describedby","data-module-id"],X$={class:"card-header"},J$={class:"module-identity"},Z$={class:"module-info"},Q$=["id"],eI={class:"module-type"},tI={class:"header-meta"},sI=["id"],aI={class:"card-content"},oI={class:"data-grid",role:"region","aria-label":"Информация о кеше"},nI={class:"data-section statistics"},rI={class:"data-items"},iI={class:"data-item"},lI={class:"data-value"},cI={class:"data-item"},dI={class:"data-value"},uI={key:0,class:"data-item full-width"},gI=["title"],mI={class:"data-section lifetime"},hI={class:"data-items"},fI={class:"data-item"},vI={class:"data-value"},pI={key:0,class:"data-item"},yI={class:"data-value"},kI={key:1,class:"data-item"},bI={class:"data-section cache-state"},_I={class:"section-header"},wI=["aria-label"],CI={class:"data-items"},TI={class:"data-value cache-state-text"},SI={key:0,class:"data-section performance"},DI={class:"data-items"},EI={key:0,class:"data-item"},AI={key:1,class:"data-item"},$I={class:"data-value"},II={key:2,class:"data-item"},MI={class:"data-value"},NI={key:3,class:"data-item"},xI={key:4,class:"data-item"},LI={key:5,class:"data-item"},PI={class:"data-value"},OI={key:6,class:"data-item"},BI={class:"data-value"},RI={key:7,class:"data-item"},WI=["aria-label"],UI={class:"primary-actions"},FI={class:"secondary-actions"},HI=["disabled","aria-label"],jI={key:0,class:"button-content"},zI={key:1,class:"button-content"},VI={key:2,class:"button-content"},GI=["aria-label"],KI={class:"detail-modal",role:"dialog","aria-modal":"true"},qI={class:"modal-header"},YI={class:"modal-content"},XI={class:"json-data"};function JI(o,e,s,t,r,i){const n=be("CacheCreateButton");return c(),u("article",{class:X(["cache-module-card",t.moduleClasses]),role:"article","aria-labelledby":`module-${s.module.id}-title`,"aria-describedby":`module-${s.module.id}-status`,"data-module-id":s.module.id,tabindex:"0"},[a("div",X$,[a("div",J$,[a("div",{class:X(["module-icon",t.iconClass])},m(t.moduleIcon),3),a("div",Z$,[a("h3",{class:"module-name",id:`module-${s.module.id}-title`},m(s.module.name),9,Q$),a("span",eI,m(t.moduleTypeText),1)])]),a("div",tI,[s.isPrimary&&s.priority?(c(),u("span",{key:0,class:X(["priority-badge",t.priorityClass])},m(s.priority),3)):$("",!0),a("span",{class:X(["status-badge",t.statusClass]),id:`module-${s.module.id}-status`,role:"status"},m(t.statusText),11,sI)])]),a("div",aI,[a("div",oI,[a("div",nI,[e[14]||(e[14]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"📊"),a("h4",{class:"section-title"},"Статистика")],-1)),a("div",rI,[a("div",iI,[e[11]||(e[11]=a("span",{class:"data-label"},"Файлов:",-1)),a("span",lI,m(s.module.file_count||0),1)]),a("div",cI,[e[12]||(e[12]=a("span",{class:"data-label"},"Размер:",-1)),a("span",dI,m(t.formattedSize),1)]),s.module.cache_dir?(c(),u("div",uI,[e[13]||(e[13]=a("span",{class:"data-label"},"Директория:",-1)),a("span",{class:"data-value cache-dir",title:s.module.cache_dir},m(t.shortCacheDir),9,gI)])):$("",!0)])]),a("div",mI,[e[18]||(e[18]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"⏰"),a("h4",{class:"section-title"},"Время жизни")],-1)),a("div",hI,[a("div",fI,[e[15]||(e[15]=a("span",{class:"data-label"},"TTL:",-1)),a("span",vI,m(t.formattedTTL),1)]),s.module.created_at?(c(),u("div",pI,[e[16]||(e[16]=a("span",{class:"data-label"},"Создан:",-1)),a("span",yI,m(t.formattedCreatedAt),1)])):$("",!0),s.module.expires_at?(c(),u("div",kI,[e[17]||(e[17]=a("span",{class:"data-label"},"Истекает:",-1)),a("span",{class:X(["data-value",t.expiresClass])},m(t.formattedExpiresAt),3)])):$("",!0)])]),a("div",bI,[a("div",_I,[a("span",{class:"section-icon","aria-label":t.cacheStateText,"aria-hidden":"false"},m(t.cacheStateIcon),9,wI),e[19]||(e[19]=a("h4",{class:"section-title"},"Состояние кеша",-1))]),a("div",CI,[a("div",{class:X(["data-item cache-state-indicator",t.cacheStateClass])},[e[20]||(e[20]=a("span",{class:"data-label"},"Статус:",-1)),a("span",TI,m(t.cacheStateText),1)],2)])]),s.module.metadata||s.module.created_at?(c(),u("div",SI,[e[29]||(e[29]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"⚡"),a("h4",{class:"section-title"},"Производительность")],-1)),a("div",DI,[t.formattedCreationTime?(c(),u("div",EI,[e[21]||(e[21]=a("span",{class:"data-label"},"Время создания:",-1)),a("span",{class:X(["data-value",t.creationTimeClass])},m(t.formattedCreationTime),3)])):$("",!0),t.formattedLastAccess?(c(),u("div",AI,[e[22]||(e[22]=a("span",{class:"data-label"},"Последний доступ:",-1)),a("span",$I,m(t.formattedLastAccess),1)])):$("",!0),t.accessCount!==null?(c(),u("div",II,[e[23]||(e[23]=a("span",{class:"data-label"},"Обращений:",-1)),a("span",MI,m(t.accessCount),1)])):$("",!0),t.cacheEfficiency?(c(),u("div",NI,[e[24]||(e[24]=a("span",{class:"data-label"},"Эффективность:",-1)),a("span",{class:X(["data-value",t.cacheEfficiencyClass])},m(t.cacheEfficiency),3)])):$("",!0),t.dataFreshness?(c(),u("div",xI,[e[25]||(e[25]=a("span",{class:"data-label"},"Свежесть данных:",-1)),a("span",{class:X(["data-value",t.dataFreshnessClass])},m(t.dataFreshness),3)])):$("",!0),s.module.total_size?(c(),u("div",LI,[e[26]||(e[26]=a("span",{class:"data-label"},"Общий размер:",-1)),a("span",PI,m(t.formatBytes(s.module.total_size)),1)])):$("",!0),s.module.ttl?(c(),u("div",OI,[e[27]||(e[27]=a("span",{class:"data-label"},"TTL:",-1)),a("span",BI,m(t.formatTTL(s.module.ttl)),1)])):$("",!0),t.timeToExpiry!==null?(c(),u("div",RI,[e[28]||(e[28]=a("span",{class:"data-label"},"Истекает через:",-1)),a("span",{class:X(["data-value",t.timeToExpiryClass])},m(t.formatTimeToExpiry),3)])):$("",!0)])])):$("",!0)])]),a("div",{class:X(["card-actions",{"mobile-layout":t.isMobile}]),role:"group","aria-label":`Действия с кешем ${s.module.name}`},[a("div",UI,[ne(n,{module:s.module,disabled:t.creating,onCreated:t.handleCacheCreated,onCreating:t.handleCreatingState,class:X({loading:t.creating})},null,8,["module","disabled","onCreated","onCreating","class"])]),a("div",FI,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClear&&t.handleClear(...l)),onKeydown:[e[1]||(e[1]=Re((...l)=>t.handleClear&&t.handleClear(...l),["enter"])),e[2]||(e[2]=Re(Ce((...l)=>t.handleClear&&t.handleClear(...l),["prevent"]),["space"]))],disabled:!t.canClear,class:X(["action-button clear-button",{disabled:!t.canClear,loading:t.clearing}]),"aria-label":t.clearButtonLabel,tabindex:"0"},[t.clearing?(c(),u("span",jI,[...e[30]||(e[30]=[a("span",{class:"spinner"},null,-1),ce(" Очистка... ",-1)])])):t.isEmpty?(c(),u("span",zI," 📁 Кеш пуст ")):(c(),u("span",VI," 🗑️ Очистить "))],42,HI),t.canShowDetails?(c(),u("button",{key:0,onClick:e[3]||(e[3]=(...l)=>t.showDetails&&t.showDetails(...l)),onKeydown:[e[4]||(e[4]=Re((...l)=>t.showDetails&&t.showDetails(...l),["enter"])),e[5]||(e[5]=Re(Ce((...l)=>t.showDetails&&t.showDetails(...l),["prevent"]),["space"]))],class:"action-button details-button","aria-label":`Показать детали кеша ${s.module.name}`,title:"Показать детали кеша",tabindex:"0"}," 📊 ",40,GI)):$("",!0)])],10,WI),(c(),he(It,{to:"body"},[t.showDetailModal?(c(),u("div",{key:0,class:"detail-modal-overlay",onClick:e[9]||(e[9]=Ce((...l)=>t.closeDetails&&t.closeDetails(...l),["self"])),onKeydown:e[10]||(e[10]=Re((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))},[a("div",KI,[a("div",qI,[a("h3",null,"Детали кеша: "+m(s.module.name),1),a("button",{onClick:e[6]||(e[6]=(...l)=>t.closeDetails&&t.closeDetails(...l)),onKeydown:[e[7]||(e[7]=Re((...l)=>t.closeDetails&&t.closeDetails(...l),["enter"])),e[8]||(e[8]=Re((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))],class:"close-button","aria-label":"Закрыть",tabindex:"0"}," ✕ ",32)]),a("div",YI,[a("pre",XI,m(JSON.stringify(s.module,null,2)),1)])])],32)):$("",!0)]))],10,Y$)}const ZI=de(q$,[["render",JI],["__scopeId","data-v-bc59cd77"]]),QI={name:"CacheStats",props:{modules:{type:Array,required:!1,default:()=>[]}},setup(o){console.log("[CacheStats] setup called with modules:",o.modules);const e=M(()=>o.modules||[]),s=M(()=>{console.log("[CacheStats] Computing primaryModules, total modules:",e.value?.length||0);const y=e.value.filter(S=>Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Primary modules count:",y.length),y}),t=M(()=>{console.log("[CacheStats] Computing secondaryModules, total modules:",e.value?.length||0);const y=e.value.filter(S=>!Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Secondary modules count:",y.length),y}),r=M(()=>s.value?.length||0),i=M(()=>t.value?.length||0),n=M(()=>e.value?.length||0),l=M(()=>e.value.reduce((y,S)=>y+(S.file_count||0),0)),d=M(()=>(o.modules||[]).reduce((y,S)=>y+(S.total_size||0),0)),g=M(()=>Pe.formatCacheSize(d.value)),v=M(()=>{const y=o.modules||[];if(y.length===0)return"0 мин";const S=y.reduce((k,_)=>k+(_.ttl||0),0),C=Math.round(S/y.length);return Pe.formatTTL(C)}),T=M(()=>(e.value||[]).filter(y=>y.status==="active").length),f=M(()=>{if((i.value||0)===0)return[];const y={};(t.value||[]).forEach(C=>{const k=Pe.getModuleType(C.id);if(!y[k]){const _=Pe.getModuleTypeConfig(k);y[k]={type:k,title:_.title||"Неизвестная группа",icon:p(k),count:0}}y[k].count++});const S=i.value||0;return Object.values(y).map(C=>({...C,percentage:S>0?Math.round(C.count/S*100):0})).sort((C,k)=>k.count-C.count)}),p=y=>{const S={users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"};return S[y]||S.other};return{modules:e,primaryModulesCount:r,secondaryModulesCount:i,totalModules:n,totalFiles:l,totalSizeFormatted:g,avgTTL:v,activeModules:T,groupStats:f}}},eM={key:0,class:"cache-stats"},tM={class:"stats-overview"},sM={class:"overview-grid"},aM={class:"overview-card primary"},oM={class:"overview-content"},nM={class:"overview-value"},rM={class:"overview-card secondary"},iM={class:"overview-content"},lM={class:"overview-value"},cM={class:"overview-card total"},dM={class:"overview-content"},uM={class:"overview-value"},gM={class:"detailed-stats"},mM={class:"stats-grid"},hM={class:"stat-card"},fM={class:"stat-content"},vM={class:"stat-value"},pM={class:"stat-card"},yM={class:"stat-content"},kM={class:"stat-value"},bM={class:"stat-card"},_M={class:"stat-content"},wM={class:"stat-value"},CM={class:"stat-card"},TM={class:"stat-content"},SM={class:"stat-value"},DM={key:0,class:"group-distribution"},EM={class:"distribution-grid"},AM={class:"group-icon"},$M={class:"group-info"},IM={class:"group-name"},MM={class:"group-count"},NM={class:"group-percentage"},xM={key:1,class:"cache-stats-loading"};function LM(o,e,s,t,r,i){return(t.modules||[]).length>0?(c(),u("div",eM,[e[18]||(e[18]=a("h2",{class:"stats-title"},"📊 Статистика кеша по категориям",-1)),a("div",tM,[a("div",sM,[a("div",aM,[e[2]||(e[2]=a("div",{class:"overview-icon"},"🏆",-1)),a("div",oM,[a("div",nM,m(t.primaryModulesCount),1),e[0]||(e[0]=a("div",{class:"overview-label"},"Основных модулей",-1)),e[1]||(e[1]=a("div",{class:"overview-desc"},"Приоритетные",-1))])]),a("div",rM,[e[5]||(e[5]=a("div",{class:"overview-icon"},"🔧",-1)),a("div",iM,[a("div",lM,m(t.secondaryModulesCount),1),e[3]||(e[3]=a("div",{class:"overview-label"},"Побочных модулей",-1)),e[4]||(e[4]=a("div",{class:"overview-desc"},"Служебные",-1))])]),a("div",cM,[e[8]||(e[8]=a("div",{class:"overview-icon"},"📦",-1)),a("div",dM,[a("div",uM,m(t.totalModules),1),e[6]||(e[6]=a("div",{class:"overview-label"},"Всего модулей",-1)),e[7]||(e[7]=a("div",{class:"overview-desc"},"Активных",-1))])])])]),a("div",gM,[a("div",mM,[a("div",hM,[e[10]||(e[10]=a("div",{class:"stat-icon"},"📄",-1)),a("div",fM,[a("div",vM,m(t.totalFiles),1),e[9]||(e[9]=a("div",{class:"stat-label"},"Всего файлов",-1))])]),a("div",pM,[e[12]||(e[12]=a("div",{class:"stat-icon"},"💾",-1)),a("div",yM,[a("div",kM,m(t.totalSizeFormatted),1),e[11]||(e[11]=a("div",{class:"stat-label"},"Общий размер",-1))])]),a("div",bM,[e[14]||(e[14]=a("div",{class:"stat-icon"},"⏱️",-1)),a("div",_M,[a("div",wM,m(t.avgTTL),1),e[13]||(e[13]=a("div",{class:"stat-label"},"Средний TTL",-1))])]),a("div",CM,[e[16]||(e[16]=a("div",{class:"stat-icon"},"⚡",-1)),a("div",TM,[a("div",SM,m(t.activeModules),1),e[15]||(e[15]=a("div",{class:"stat-label"},"Активных кешей",-1))])])])]),t.secondaryModulesCount>0?(c(),u("div",DM,[e[17]||(e[17]=a("h3",{class:"distribution-title"},"Распределение побочных модулей",-1)),a("div",EM,[(c(!0),u(ee,null,te(t.groupStats,n=>(c(),u("div",{key:n.type,class:"distribution-item"},[a("div",AM,m(n.icon),1),a("div",$M,[a("div",IM,m(n.title),1),a("div",MM,m(n.count)+" модулей",1)]),a("div",NM,m(n.percentage)+"%",1)]))),128))])])):$("",!0)])):(c(),u("div",xM,[...e[19]||(e[19]=[a("p",null,"📊 Загрузка статистики...",-1)])]))}const PM=de(QI,[["render",LM],["__scopeId","data-v-9fa190bb"]]),OM={name:"CacheManagement",components:{CacheModuleCard:ZI,CacheStats:PM},setup(){const o=I([]),e=I([]),s=I(!0),t=I(null),r=I(!1),i=M(()=>(o.value?.length||0)+(e.value?.length||0)),n=M(()=>{const k=l.value?.length||0,_=(d.value?.length||0)>0?1:0;return k+_}),l=M(()=>{const k=(o.value||[]).filter(_=>!_.id.includes("time-tracking"));return console.log("[CacheManagement] individualPrimaryModules:",k.length,k.map(_=>_.id)),k}),d=M(()=>{const k=(o.value||[]).filter(_=>_.id.includes("time-tracking")).sort((_,A)=>{const W=["time-tracking-default","time-tracking-detailed","time-tracking-summary"];return W.indexOf(_.id)-W.indexOf(A.id)});return console.log("[CacheManagement] timeTrackingModules:",k.length,k.map(_=>_.id)),k}),g=M(()=>{const k={};return(e.value||[]).forEach(A=>{const W=Pe.getModuleType(A.id);k[W]||(k[W]={type:W,title:T(W),modules:[]}),k[W].modules.push(A)}),Object.values(k).sort((A,W)=>{const x=["users","activity","webhooks","other"],D=x.indexOf(A.type),E=x.indexOf(W.type);return(D===-1?999:D)-(E===-1?999:E)})}),v=async()=>{s.value=!0,t.value=null;try{const k=await Pe.getCacheStatus();o.value=k.primaryModules||[],e.value=k.secondaryModules||[],console.log("[CacheManagement] Primary modules:",o.value.length,o.value.map(_=>({id:_.id,name:_.name}))),console.log("[CacheManagement] Secondary modules:",e.value.length,e.value.map(_=>({id:_.id,name:_.name})))}catch(k){console.error("[CacheManagement] Error loading modules:",k),t.value=k.message}finally{s.value=!1}},T=k=>{const _={users:"👥 Управление пользователями",activity:"📊 Отслеживание активности",webhooks:"🔗 Логи вебхуков",other:"🔧 Прочие модули"};return _[k]||_.other},f=async k=>{console.log(`[CacheManagement] Clearing module: ${k}`),Pe.invalidateCacheAfterModuleOperation(),await v()},p=async()=>{console.log("[CacheManagement] Clearing all cache"),r.value=!0;try{await Pe.clearCache("all"),Pe.invalidateCacheAfterModuleOperation(),Ye.success("Кеш полностью очищен","Все файлы кеша были успешно удалены"),await v()}catch(k){console.error("[CacheManagement] Error clearing all cache:",k),Ye.error("Ошибка очистки кеша",`Не удалось очистить весь кеш: ${k.message}`)}finally{r.value=!1}},y=async k=>{console.log(`[CacheManagement] Creating cache for: ${k.name} (${k.id})`),alert(`Создание кеша для модуля: ${k.name}
ID: ${k.id}
Это mock функция для тестирования интерфейса.`)},S=async k=>{console.log(`[CacheManagement] Clearing cache for: ${k.name} (${k.id})`),alert(`Очистка кеша для модуля: ${k.name}
ID: ${k.id}
Это mock функция для тестирования интерфейса.`)},C=()=>{v()};return $e(()=>{v()}),{primaryModules:o,secondaryModules:e,loading:s,error:t,totalModules:i,groupedSecondaryModules:g,individualPrimaryModules:l,timeTrackingModules:d,logicalPrimaryCount:n,clearingAll:r,handleModuleClear:f,handleClearAllCache:p,handleCreateMock:y,handleClearMock:S,refreshModules:C}}},BM={class:"cache-management"},RM={key:0,class:"header-section"},WM={class:"stats-bar"},UM={class:"stat-item"},FM={class:"stat-item"},HM={class:"stat-item"},jM={key:0,class:"global-actions"},zM=["disabled"],VM={key:0},GM={key:1},KM={class:"section-header"},qM={class:"section-meta"},YM={class:"module-count","aria-label":"{{ logicalPrimaryCount }} основных модулей"},XM={key:0,class:"modules-container"},JM={key:0,class:"modules-grid"},ZM={key:1,class:"time-tracking-group"},QM={class:"modules-grid"},e4={key:1,class:"empty-state"},t4={key:2,class:"section-divider"},s4={key:3,class:"cache-section secondary-modules","aria-labelledby":"secondary-modules-heading"},a4={class:"section-header"},o4={class:"section-meta"},n4={class:"module-count","aria-label":"{{ (secondaryModules || []).length }} второстепенных модулей"},r4={class:"grouped-modules"},i4={class:"group-header"},l4={class:"group-title"},c4={class:"group-badge secondary"},d4={class:"modules-grid"},u4={key:4,class:"error-message",role:"alert","aria-live":"assertive"},g4={key:5,class:"loading-overlay",role:"status","aria-live":"polite","aria-label":"Загрузка модулей кеша"};function m4(o,e,s,t,r,i){const n=be("CacheModuleCard");return c(),u("div",BM,[!t.loading&&!t.error?(c(),u("div",RM,[e[6]||(e[6]=a("h1",null,"🗑️ Ручное управление кешем",-1)),e[7]||(e[7]=a("p",{class:"description"}," Управление кешем системы сгруппировано по важности для удобства администрирования ",-1)),a("div",WM,[a("span",UM,[a("strong",null,m(t.totalModules),1),e[3]||(e[3]=ce(" всего модулей ",-1))]),a("span",FM,[a("strong",null,m(t.logicalPrimaryCount),1),e[4]||(e[4]=ce(" основных ",-1))]),a("span",HM,[a("strong",null,m((t.secondaryModules||[]).length),1),e[5]||(e[5]=ce(" дополнительных ",-1))])]),!t.loading&&!t.error?(c(),u("div",jM,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClearAllCache&&t.handleClearAllCache(...l)),disabled:t.clearingAll,class:X(["btn-clear-all",{"btn-disabled":t.clearingAll}])},[t.clearingAll?(c(),u("span",VM,"🧹 Очистка всего кеша...")):(c(),u("span",GM,"🗑️ Очистить весь кеш"))],10,zM)])):$("",!0)])):$("",!0),!t.loading&&!t.error?(c(),u("section",{key:1,class:X(["cache-section primary-modules",{empty:(t.primaryModules||[]).length===0}]),"aria-labelledby":"primary-modules-heading"},[a("div",KM,[e[9]||(e[9]=a("h2",{id:"primary-modules-heading"},"🏆 Основные модули кеша",-1)),a("div",qM,[a("span",YM,m(t.logicalPrimaryCount),1),e[8]||(e[8]=a("span",{class:"section-badge primary",role:"status","aria-label":"Приоритетные модули"},"Приоритет",-1))])]),e[13]||(e[13]=a("p",{class:"section-description"}," 5 основных модулей для оперативного анализа и мониторинга системы: дашборд сектора 1С, график состояния, графики приема-закрытия и трудозатраты на тикеты сектора 1С. ",-1)),(t.primaryModules||[]).length>0?(c(),u("div",XM,[t.individualPrimaryModules.length>0?(c(),u("div",JM,[(c(!0),u(ee,null,te(t.individualPrimaryModules,l=>(c(),u("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])):$("",!0),(t.timeTrackingModules||[]).length>0?(c(),u("div",ZM,[e[10]||(e[10]=a("div",{class:"group-header"},[a("h3",{class:"group-title"},"⏱️ Трудозатраты на тикеты сектора 1С"),a("span",{class:"group-badge"},"Основная группа")],-1)),e[11]||(e[11]=a("p",{class:"group-description"},"Анализ времени работы с задачами в разных режимах отображения",-1)),a("div",QM,[(c(!0),u(ee,null,te(t.timeTrackingModules,l=>(c(),u("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])])):$("",!0)])):(c(),u("div",e4,[e[12]||(e[12]=a("p",null,"⚠️ Основные модули кеша не найдены",-1)),a("button",{onClick:e[1]||(e[1]=(...l)=>t.refreshModules&&t.refreshModules(...l)),class:"refresh-btn"},"Обновить список")]))],2)):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),u("div",t4,[...e[14]||(e[14]=[_t('<div class="divider-line" data-v-6a4e8216></div><div class="divider-content" data-v-6a4e8216><span class="divider-icon" data-v-6a4e8216>🔧</span><span class="divider-text" data-v-6a4e8216>Дополнительные модули</span><span class="divider-subtitle" data-v-6a4e8216>Вспомогательные функции системы</span></div><div class="divider-line" data-v-6a4e8216></div>',3)])])):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),u("section",s4,[a("div",a4,[e[16]||(e[16]=a("h2",{id:"secondary-modules-heading"},"🔧 Побочные модули кеша",-1)),a("div",o4,[a("span",n4,m((t.secondaryModules||[]).length),1),e[15]||(e[15]=a("span",{class:"section-badge secondary",role:"status","aria-label":"Служебные модули"},"Служебные",-1))])]),e[17]||(e[17]=a("p",{class:"section-description"}," Модули для администрирования и детального мониторинга системы. ",-1)),a("div",r4,[(c(!0),u(ee,null,te(t.groupedSecondaryModules,l=>(c(),u("div",{key:l.type,class:X(["module-group",`group-${l.type}`])},[a("div",i4,[a("h3",l4,m(l.title),1),a("span",c4,m(l.modules.length),1)]),a("div",d4,[(c(!0),u(ee,null,te(l.modules,d=>(c(),u("div",{key:d.id,class:"module-wrapper"},[ne(n,{module:d,"is-primary":!1,"group-type":l.type,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","group-type","onClear","onRefresh"])]))),128))])],2))),128))])])):$("",!0),t.error?(c(),u("div",u4,[e[18]||(e[18]=a("h3",null,"❌ Ошибка загрузки модулей кеша",-1)),a("p",null,m(t.error),1),a("button",{onClick:e[2]||(e[2]=(...l)=>o.loadModules&&o.loadModules(...l)),class:"retry-btn","aria-label":"Повторить загрузку модулей кеша"},"Повторить попытку")])):$("",!0),t.loading?(c(),u("div",g4,[...e[19]||(e[19]=[a("div",{class:"loading-spinner","aria-hidden":"true"},null,-1),a("p",null,"Загрузка модулей кеша...",-1)])])):$("",!0)])}const h4=de(OM,[["render",m4],["__scopeId","data-v-6a4e8216"]]),f4={name:"CacheManagementPage",components:{CacheManagement:h4},beforeCreate(){console.log("[CacheManagementPage] beforeCreate() called")},created(){console.log("[CacheManagementPage] created() called")},beforeMount(){console.log("[CacheManagementPage] beforeMount() called")},setup(){console.log("[CacheManagementPage] setup() called with new hierarchical UI");const o=Xe(),e=I(!1),s=I(null),t=()=>{o.push({name:"index"})};return $e(()=>{console.log("[CacheManagementPage] onMounted() called - hierarchical cache management ready")}),{loading:e,error:s,goBack:t}}},v4={class:"cache-management-page"},p4={class:"page-header"},y4={class:"page-header-top"},k4={key:0,class:"loading"},b4={key:1,class:"error"},_4={key:2,class:"cache-content"};function w4(o,e,s,t,r,i){const n=be("CacheManagement");return c(),u("div",v4,[a("div",p4,[a("div",y4,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.goBack&&t.goBack(...l)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[1]||(e[1]=[a("span",{class:"back-icon","aria-hidden":"true"},"←",-1),a("span",{class:"back-text"},"Назад",-1)])])]),e[2]||(e[2]=a("h1",null,"🗑️ Ручное управление кешем",-1))]),t.loading?(c(),u("div",k4," Загрузка статуса кеша... ")):t.error?(c(),u("div",b4,m(t.error),1)):(c(),u("div",_4,[ne(n)]))])}const C4=de(f4,[["render",w4],["__scopeId","data-v-a20ded38"]]),T4=[{path:"/install",name:"install",component:Fo},{path:"/",name:"index",component:Ew},{path:"/webhook-logs",name:"webhook-logs",redirect:"/admin/webhook-logs"},{path:"/admin/webhook-logs",name:"admin-webhook-logs",component:IS,meta:{requiresAuth:!0,title:"Логи вебхуков",adminOnly:!0}},{path:"/admin/users",name:"admin-users",component:y$,meta:{requiresAuth:!0,title:"Управление пользователями",adminOnly:!0}},{path:"/admin/cache",name:"admin-cache",component:C4,meta:{requiresAuth:!0,title:"Ручное управление кешем",adminOnly:!0}},{path:"/dashboard/sector-1c",name:"dashboard-sector-1c",component:()=>Ee(()=>Promise.resolve().then(()=>za),void 0,import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector1c"}},{path:"/dashboard/sector/:sectorId",name:"dashboard-sector",component:()=>Ee(()=>Promise.resolve().then(()=>ir),void 0,import.meta.url),props:o=>({sectorId:o.params.sectorId}),meta:{requiresAuth:!0,chunk:"universal-dashboard"},beforeEnter:(o,e,s)=>{const{SECTORS_CONFIG:t,SectorConfigUtils:r}=require("@/config/sectors.js"),i=o.params.sectorId;if(console.log(`[Router] beforeEnter: checking sector ${i}`),console.log("[Router] Available sectors:",Object.values(t).map(n=>n.id)),!r.sectorExists(i)){console.warn(`[Router] Sector ${i} does not exist, redirecting to index`),s({name:"index"});return}console.log(`[Router] Sector ${i} exists, allowing navigation`),s()}},{path:"/dashboard/graph-admission-closure",name:"dashboard-graph-admission-closure",component:()=>Ee(()=>Promise.resolve().then(()=>w1),void 0,import.meta.url),meta:{title:"График приёма и закрытий сектора 1С",description:"Недельные агрегаты новых и закрытых тикетов сектора 1С",requiresAuth:!0,chunk:"admission-dashboard"}},{path:"/dashboard/graph-state",name:"dashboard-graph-state",component:()=>Ee(()=>Promise.resolve().then(()=>ym),void 0,import.meta.url),meta:{title:"График состояния сектора 1С",description:"Визуализация изменений состояния сектора во времени",requiresAuth:!0,chunk:"graph-state"}},{path:"/dashboard/tickets-time-tracking",name:"dashboard-tickets-time-tracking",component:()=>Ee(()=>Promise.resolve().then(()=>kl),void 0,import.meta.url),meta:{title:"Трудозатраты на Тикеты сектора 1С",description:"Трудозатраты сотрудников сектора 1С по неделям",requiresAuth:!0,chunk:"tickets-tracking"}}],vs=lo({history:co(),routes:T4});vs.beforeEach(async(o,e,s)=>{if(console.log("[Router] beforeEach:",{to:o.path,from:e.path,name:o.name}),o.meta.title&&(document.title=`${o.meta.title} - Bitrix24 Dashboard`),o.meta.requiresAuth){console.log("[Router] requiresAuth check for:",o.path);try{const t=await it.checkAccess();if(!t.allowed){console.warn("Unauthorized access attempt to:",o.path,t.errorMessage),s({name:"index"});return}}catch(t){console.error("Error checking access in navigation guard:",t),s();return}}if(o.meta.adminOnly)try{const t=await it.getCurrentUser();if(!t||!ts(t)){console.warn("Admin access required for:",o.path),s({name:"index"});return}}catch(t){console.error("Error checking admin access in navigation guard:",t),s({name:"index"});return}if(e.name!==null&&o.path!==e.path)try{if((await it.checkAccess()).allowed){const r=await it.getCurrentUser();r&&is.logPageVisit(o,r,e).catch(i=>{console.error("[Router] Error logging page visit:",i)})}}catch(t){console.error("[Router] Error in activity logging:",t)}if(o.name==="index"&&!e.name&&setTimeout(()=>{Ee(()=>Promise.resolve().then(()=>za),void 0,import.meta.url)},1e3),o.meta.chunk)switch(o.meta.chunk){case"dashboard-sector1c":setTimeout(()=>{Ee(()=>Promise.resolve().then(()=>vp),void 0,import.meta.url)},500);break;case"admission-dashboard":setTimeout(()=>{Ee(()=>import("./chunk-2JzEd2ES.js").then(t=>t.l),__vite__mapDeps([3,4]),import.meta.url)},500);break}console.log("[Router] Allowing navigation to:",o.path),s()});setTimeout(()=>{const o=window.location.pathname,e=window.location.hash;e&&e!=="#/"||(o.includes("install.php")?vs.replace("/install"):vs.replace("/"))},0);class cs{static startBundleLoad(){this.metrics.bundleLoadTime=performance.now()}static endBundleLoad(e){const s=performance.now()-this.metrics.bundleLoadTime;this.metrics.chunkLoadTimes.set(e,s),console.log(`📦 Chunk "${e}" loaded in ${s.toFixed(2)}ms`),window.gtag&&window.gtag("event","bundle_load",{chunk_name:e,load_time:s}),s>1e3&&console.warn(`🐌 Slow chunk load: ${e} took ${s.toFixed(2)}ms`)}static trackComponentLoad(e,s){const t=performance.now()-s;this.metrics.componentLoadTime.set(e,t),console.log(`🧩 Component "${e}" loaded in ${t.toFixed(2)}ms`),t>500&&console.warn(`🐌 Slow component load: ${e} took ${t.toFixed(2)}ms`)}static trackApiCall(e,s){this.metrics.apiResponseTime.set(e,s),s>1e3&&console.warn(`🐌 Slow API call to ${e}: ${s}ms`)}static getReport(){const e=Array.from(this.metrics.componentLoadTime.values()),s=Array.from(this.metrics.apiResponseTime.values()),t=Array.from(this.metrics.chunkLoadTimes.values());return{totalChunks:this.metrics.chunkLoadTimes.size,totalComponents:this.metrics.componentLoadTime.size,totalApiCalls:this.metrics.apiResponseTime.size,averageComponentLoadTime:e.length>0?e.reduce((r,i)=>r+i,0)/e.length:0,averageApiResponseTime:s.length>0?s.reduce((r,i)=>r+i,0)/s.length:0,averageChunkLoadTime:t.length>0?t.reduce((r,i)=>r+i,0)/t.length:0,slowestComponents:Array.from(this.metrics.componentLoadTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i})),slowestApiCalls:Array.from(this.metrics.apiResponseTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({endpoint:r,time:i})),slowestChunks:Array.from(this.metrics.chunkLoadTimes.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i}))}}static clearMetrics(){this.metrics.bundleLoadTime=0,this.metrics.componentLoadTime.clear(),this.metrics.apiResponseTime.clear(),this.metrics.chunkLoadTimes.clear()}}je(cs,"metrics",{bundleLoadTime:0,componentLoadTime:new Map,apiResponseTime:new Map,chunkLoadTimes:new Map});class S4{static init(){this.initChunkLoadErrorHandling(),this.initUnhandledErrorHandling(),this.initNetworkErrorHandling()}static initChunkLoadErrorHandling(){if(window.addEventListener("error",e=>{e.target.tagName==="SCRIPT"&&(console.error("❌ Chunk loading error:",e.target.src),this.reportError("chunk_load_error",{url:e.target.src,message:e.message||"Script load failed"}))}),"PerformanceObserver"in window)try{new PerformanceObserver(s=>{for(const t of s.getEntries())if(t.entryType==="resource"&&t.name.includes(".js")){const r=t.responseEnd-t.requestStart;cs.trackApiCall(t.name,r)}}).observe({entryTypes:["resource"]})}catch{console.warn("PerformanceObserver not supported")}}static initUnhandledErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("❌ Unhandled promise rejection:",e.reason),this.reportError("unhandled_rejection",{reason:e.reason?.message||String(e.reason),stack:e.reason?.stack})}),window.addEventListener("error",e=>{e.error&&e.filename&&(console.error("❌ Unhandled error:",e.error),this.reportError("unhandled_error",{message:e.error.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error.stack}))})}static initNetworkErrorHandling(){const e=window.fetch;window.fetch=function(...s){const t=performance.now();return e.apply(this,s).then(r=>{const i=performance.now()-t;return cs.trackApiCall(s[0],i),r.ok||console.warn(`🚨 API error: ${r.status} ${r.statusText} for ${s[0]}`),r}).catch(r=>{const i=performance.now()-t;throw console.error(`❌ Network error for ${s[0]}:`,r),cs.trackApiCall(s[0],i),this.reportError("network_error",{url:s[0],message:r.message,loadTime:i}),r})}}static reportError(e,s){const t={type:e,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,...s};if(console.error("📊 Error report:",t),window.Sentry&&window.Sentry.captureException(new Error(`${e}: ${JSON.stringify(s)}`)),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:"/api/log-error.php",method:"POST",data:t})}catch(r){console.error("Failed to send error report to Bitrix24:",r)}window.gtag&&window.gtag("event","exception",{description:`${e}: ${s.message||"Unknown error"}`,fatal:!1})}static getErrorStats(){return{chunkLoadErrors:0,networkErrors:0,unhandledErrors:0,totalErrors:0}}}const Gs=uo(Do);Gs.use(vs);const D4=o=>{try{const e=new WeakSet;return JSON.stringify(o,(s,t)=>{if(typeof t=="object"&&t!==null){if(e.has(t))return"[Circular]";e.add(t)}return typeof t=="function"||t===void 0?null:t})}catch{return String(o)}};Gs.config.errorHandler=(o,e,s)=>{if(o instanceof TypeError&&o.message.includes("Cannot read properties of undefined (reading 'type')")){console.warn("Caught undefined.type error:",{error:o.message,component:e?.$options?.name||"Unknown",info:s,stack:o.stack});return}if(console.error("Vue error:",o,s),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:tt("/api/log-error.php"),method:"POST",data:{error:o?.message||String(o),info:typeof s=="string"?s:D4(s),component:e?.$options?.name||"Unknown"}})}catch(t){console.error("Failed to log error:",t)}};Gs.mount("#app");S4.init();export{de as _,Nt as a,bt as b,J as c,$w as d,zs as e,jt as f,b$ as g,mt as i,Ht as n};
