const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ticketListUtils-BxdZ12Le.js","assets/index-CTn-fgjj.js","assets/main-BZu-8wvz.js","assets/main-hkNOQW78.css","assets/index-Bxxce_5E.css","assets/index-QyYsdHna.js"])))=>i.map(i=>d[i]);
import{_ as Ie,a as T,o as E,b as i,F as de,e as pe,n as oe,l as me,t as H,g as N,c as ee,G as Ue,m as Oe,f as Ae,d as Z,j as ie,k as Te,H as qe,i as ne,B as Je,T as At,I as Ot,u as Ze,J as Be,K as Qe,p as tt,L as rt,x as Ut,M as zt,N as Pt,C as Lt,O as lt,D as Kt,P as Vt,Q as Gt,y as at,R as je,z as Yt,r as qt}from"./main-BZu-8wvz.js";import{L as It,D as Xt,B as Jt}from"./index-QyYsdHna.js";import{S as it,d as ct,K as Zt,D as $t,B as pt,m as Mt,e as st,f as fe,h as Nt,j as Qt,T as Rt,k as ea,l as Ft}from"./index-CTn-fgjj.js";const Ee={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Ce{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new He("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new He("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const s=this.validateSectorData(t);if(!s.isValid)throw new He(`Ошибка валидации данных сектора: ${s.errors.join(", ")}`,"VALIDATION_ERROR",{validation:s});const n=this.normalizeSectorData(t),c={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||Ee.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},o=this.validateSnapshot(c);if(!o.isValid)throw new He(`Ошибка валидации слепка: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",o.warnings);const u=this.getApiBaseUrl(),f=await fetch(`${u}${Ee.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:e,date:this.formatDate(new Date)})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const p=await f.json();if(!p.success)throw new Error(p.message||"Ошибка создания слепка");return p.data.snapshot}catch(s){throw console.error("SnapshotService.createSnapshot error:",s),s instanceof He?s:new He(`Ошибка создания слепка: ${s.message}`,"API_ERROR",{originalError:s})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,l=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ee.defaultSectorId);const s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?${e.toString()}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка получения списка слепков");return(await Promise.all(l.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(u){return console.warn(`Ошибка загрузки слепка ${o.date}/${o.type}:`,u),null}}))).filter(o=>o!==null).sort((o,u)=>new Date(o.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:s={}}=t,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},l=[],c=[],o=[];e.forEach(p=>{const d=p.id;if(n[d]){let g=0;p.employees.forEach(D=>{const y=D.tickets||[];g+=y.length;let k=l.find(S=>S.id===D.id);k||(k={id:D.id,name:D.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(k)),y.forEach(S=>{c.push(S.id),o.push({id:S.id,title:S.title||"Без названия",assignedTo:{id:D.id,name:D.name},createdAt:S.createdAt||"",updatedAt:S.modifiedAt||S.updatedAt||""}),k.ticketsByStage[d]=(k.ticketsByStage[d]||0)+1,k.totalTickets+=1})}),n[d].count=g}});const u={unassigned:0,keeper:0,total:0};Object.values(s).forEach(p=>{Array.isArray(p)&&p.forEach(d=>{u.total+=1,d.assigneeId===1051||d.assignedById===1051?u.keeper+=1:u.unassigned+=1,c.push(d.id),o.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const f=Object.values(n).reduce((p,d)=>p+d.count,0)+u.total;return{statistics:{stages:{...n,total:f},employees:l,zeroPoint:u},ticketIds:[...new Set(c)],tickets:o}}static generateSnapshotMetadata(t,e,a){const s=new Date,n=-s.getTimezoneOffset(),l=Math.floor(n/60),c=n%60,o=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`,u=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${o}`;return{version:Ee.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${s}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,s=a.getFullYear(),n=this.getWeekNumber(a),l=this.formatDate(t);let c;if(e==="current"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`current-state-${l}-${u}.json`}else if(e==="manual"){const o=new Date,u=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`manual-${l}-${u}.json`}else c=`${e}-${l}.json`;return e==="current"?`current/${c}`:`${s}/week-${n}/${c}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const s=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-s)/864e5+1)/7)}static validateSnapshot(t){var s,n,l;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const c=t.statistics.stages,o=(((s=c.formed)==null?void 0:s.count)||0)+(((n=c.review)==null?void 0:n.count)||0)+(((l=c.execution)==null?void 0:l.count)||0);c.total!==o&&a.push(`Несоответствие общего количества тикетов: ожидается ${o}, указано ${c.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const c=t.statistics.zeroPoint,o=(c.unassigned||0)+(c.keeper||0);c.total!==o&&a.push(`Несоответствие статистики нулевой точки: ожидается ${o}, указано ${c.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const c=new Set(t.ticketIds),o=new Set(t.tickets.map(u=>u.id));c.size!==o.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((u,f)=>{u.id||e.push(`Тикет #${f}: отсутствует ID`),u.title||e.push(`Тикет #${f}: отсутствует заголовок`),(!u.assignedTo||!u.assignedTo.id)&&a.push(`Тикет #${f}: отсутствует ответственный (может быть в нулевой точке)`),u.createdAt||e.push(`Тикет #${f}: отсутствует дата создания`),u.updatedAt||e.push(`Тикет #${f}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),n=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}`,l=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const s of e)try{await this.deleteSnapshot(s.metadata.createdAt.split("T")[0],s.metadata.type)&&a++}catch(n){console.warn(`Ошибка удаления слепка ${s.metadata.createdAt}:`,n)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ee.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,s=(e.getDay()||7)-1,n=new Date(e);return n.setDate(e.getDate()-s),n.setHours(0,0,0,0),n}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,s=7-(e.getDay()||7),n=new Date(e);return n.setDate(e.getDate()+s),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),s=this.getWeekNumberInfo(t),n=await this.getAllSnapshots({startDate:e,endDate:a}),l=n.find(u=>u.metadata.type==="week_start")||null,c=n.find(u=>u.metadata.type==="week_end")||null,o=n.filter(u=>u.metadata.type==="manual");return{weekStart:l,weekEnd:c,manual:o,weekInfo:s}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof He)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},s=new Map;let n=null,l=null;e.forEach(o=>{const u=o.metadata.type;a.hasOwnProperty(u)&&a[u]++;const f=this.getWeekNumberInfo(o.metadata.createdAt),p=`${f.year}-W${f.week}`;s.set(p,(s.get(p)||0)+1);const d=new Date(o.metadata.createdAt);(!n||d<new Date(n.metadata.createdAt))&&(n=o),(!l||d>new Date(l.metadata.createdAt))&&(l=o)});const c=Array.from(s.entries()).map(([o,u])=>{const[f,p]=o.split("-W");return{year:parseInt(f),week:parseInt(p),count:u}}).sort((o,u)=>o.year!==u.year?o.year-u.year:o.week-u.week);return{total:e.length,byType:a,byWeek:c,oldest:n,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class He extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const _e={formed:{bitrixId:ct.formed,name:it.FORMED.name},review:{bitrixId:ct.review,name:it.REVIEW.name},execution:{bitrixId:ct.execution,name:it.EXECUTION.name}},Xe=Zt;function ta(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=aa(r.stages),e=sa(r.stages),a=na(r.zeroPointTickets||{}),s=oa(r.zeroPointTickets||{}),n=la(r.stages,r.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:s},ticketIds:n.ticketIds,tickets:n.tickets}}function aa(r){const t={formed:{count:0,stageId:_e.formed.bitrixId,stageName:_e.formed.name},review:{count:0,stageId:_e.review.bitrixId,stageName:_e.review.name},execution:{count:0,stageId:_e.execution.bitrixId,stageName:_e.execution.name},total:0};return r.forEach(e=>{if(!_e[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(s=>{s.tickets&&Array.isArray(s.tickets)&&(a+=s.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function sa(r){const t=new Map;return r.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const s=t.get(a.id),n=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;_e[e.id]&&(s.ticketsByStage[e.id]=(s.ticketsByStage[e.id]||0)+n),s.totalTickets+=n})}),Array.from(t.values())}function na(r){let t=0,e=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t++:(typeof n=="object"?n.id:n)===Xe?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function oa(r){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(t).forEach(e=>{const a=r[e];Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?t[e].unassigned++:(typeof n=="object"?n.id:n)===Xe?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function la(r,t){const e=new Set,a=new Map;return Array.isArray(r)&&r.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const c=parseInt(l.id);if(isNaN(c)){console.warn("Invalid ticket ID:",l.id);return}e.add(c);let o=l.assignedTo;!o&&n.id&&(o={id:n.id,name:n.name||`Сотрудник #${n.id}`}),a.set(c,{id:c,title:l.title||"Без названия",assignedTo:o||null,createdAt:et(l.createdAt||l.createdTime),updatedAt:et(l.updatedAt||l.modifiedAt||l.updatedTime),stageId:l.stageId||s.id||null,departmentHead:l.departmentHead||null,departmentHeadFull:l.departmentHeadFull||l.departmentHead||null,priorityId:l.priorityId||null,priorityLabel:l.priorityLabel||null,service:l.service||null,serviceLabel:l.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",n.id);return}e.add(l);let c=n.assignedTo;if(!c&&n.assignedById){const o=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;o&&o!==Xe?c={id:o,name:"Неизвестный"}:o===Xe&&(c={id:Xe,name:"Хранитель объектов"})}a.set(l,{id:l,title:n.title||"Без названия",assignedTo:c||null,createdAt:et(n.createdAt||n.createdTime),updatedAt:et(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((s,n)=>s-n),tickets:Array.from(a.values())}}function et(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const t=new Date(r);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",r),null}class gt{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:s=!0,includeTicketDetails:n=!1}=t;try{const l=await $t.getSectorData(e,a);return s?ta(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await $t.getSectorData(!0);return t!=null}catch{return!1}}}class ut{static compareTwoSnapshots(t,e,a={}){const{includeTickets:s=!1,includeEmployees:n=!0}=a,l=this.validateSnapshot(t),c=this.validateSnapshot(e);if(!l.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...c.errors].join(", "));const o=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),f=n?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],p=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=s?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,g=this.buildSummary(u,f,p,d);return{metadata:o,stages:u,employees:f,zeroPoint:p,tickets:d,summary:g}}static calculateDelta(t,e){const a=this.normalizeValue(t),s=this.normalizeValue(e),n=s-a;let l=0;a!==0?l=n/a*100:s!==0&&(l=s>0?1/0:-1/0);const c=this.getTrend(n);return{value1:a,value2:s,delta:n,deltaPercent:Math.round(l*100)/100,trend:c}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var c,o;const a=["formed","review","execution"],s={};for(const u of a){const f=((c=t[u])==null?void 0:c.count)||0,p=((o=e[u])==null?void 0:o.count)||0;s[u]=this.calculateDelta(f,p)}const n=t.total||0,l=e.total||0;return s.total=this.calculateDelta(n,l),s}static compareEmployees(t,e){var c,o;const a=new Map(t.map(u=>[u.id,u])),s=new Map(e.map(u=>[u.id,u])),n=new Set([...a.keys(),...s.keys()]),l=[];for(const u of n){const f=a.get(u)||null,p=s.get(u)||null;if(!f||!p){l.push({id:u,name:(f==null?void 0:f.name)||(p==null?void 0:p.name)||"Неизвестный",snapshot1:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,snapshot2:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,delta:this.calculateEmployeeDelta(f,p),trend:f?"removed":"new"});continue}const d={},g=["formed","review","execution"];for(const y of g){const k=((c=f.ticketsByStage)==null?void 0:c[y])||0,S=((o=p.ticketsByStage)==null?void 0:o[y])||0;d[y]=this.calculateDelta(k,S)}const D=this.calculateDelta(f.totalTickets||0,p.totalTickets||0);l.push({id:u,name:f.name,snapshot1:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},snapshot2:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},delta:{ticketsByStage:d,totalTickets:D},trend:D.trend})}return l}static calculateEmployeeDelta(t,e){var l,c;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},s=["formed","review","execution"];for(const o of s){const u=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[o])||0,f=((c=e==null?void 0:e.ticketsByStage)==null?void 0:c[o])||0;a[o]=this.calculateDelta(u,f)}const n=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:n}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,s){var g,D;const n=new Set(t),l=new Set(e),c=e.filter(y=>!n.has(y)),o=t.filter(y=>!l.has(y)),u=[],f=[],p=new Map(a.map(y=>[y.id,y])),d=new Map(s.map(y=>[y.id,y]));for(const y of t){if(!l.has(y))continue;const k=p.get(y),S=d.get(y);if(!k||!S)continue;const A=(((g=k.assignedTo)==null?void 0:g.id)||null)!==(((D=S.assignedTo)==null?void 0:D.id)||null),z=(k.stageId||null)!==(S.stageId||null);A||z?u.push(y):f.push(y)}return{new:c,removed:o,changed:u,unchanged:f}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),s=new Date(e.metadata.createdAt),n=new Date,l=s.getTime()-a.getTime(),c=Math.floor(l/(1e3*60*60*24)),o=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:n.toISOString(),timeDiff:{days:c,hours:o,minutes:u,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,a,s){var u,f,p;const n=t.total.delta,l=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,c=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,o=n!==0||l>0||c>0;return{totalDelta:n,stagesChanged:l,employeesChanged:c,hasChanges:o,newTicketsCount:((u=s==null?void 0:s.new)==null?void 0:u.length)||0,removedTicketsCount:((f=s==null?void 0:s.removed)==null?void 0:f.length)||0,changedTicketsCount:((p=s==null?void 0:s.changed)==null?void 0:p.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const s=["formed","review","execution"];for(const n of s)t.statistics.stages[n]||a.push(`Missing stage: ${n}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const c=this.validateSnapshot(l);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...t].sort((l,c)=>{const o=new Date(l.metadata.createdAt),u=new Date(c.metadata.createdAt);return o-u}),s=[];for(let l=0;l<a.length-1;l++)s.push({from:l,to:l+1,result:this.compareTwoSnapshots(a[l],a[l+1],e)});const n=this.buildTrends(a);return{snapshots:a.map((l,c)=>({index:c,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:s,trends:n}}static buildTrends(t){var a,s,n,l,c,o,u,f,p,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const g of t){const D=g.statistics;e.stages.formed.push(((s=(a=D.stages)==null?void 0:a.formed)==null?void 0:s.count)||0),e.stages.review.push(((l=(n=D.stages)==null?void 0:n.review)==null?void 0:l.count)||0),e.stages.execution.push(((o=(c=D.stages)==null?void 0:c.execution)==null?void 0:o.count)||0),e.stages.total.push(((u=D.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((f=D.zeroPoint)==null?void 0:f.unassigned)||0),e.zeroPoint.keeper.push(((p=D.zeroPoint)==null?void 0:p.keeper)||0),e.zeroPoint.total.push(((d=D.zeroPoint)==null?void 0:d.total)||0)}return e}}const ra={class:"stages-container"},ia={class:"stages-chips"},ca=["checked","disabled","onChange"],ua={class:"stage-chip-label"},da={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:r=>r.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t;function s(n,l){const c={...e.selected};c[n]=l,a("update:selected",c),a("change",n,l)}return(n,l)=>(E(),T("div",ra,[l[0]||(l[0]=i("h4",{class:"stages-title"},"Этапы для отображения:",-1)),i("div",ia,[(E(!0),T(de,null,pe(r.stages,c=>(E(),T("label",{key:c.id,class:oe(["stage-chip",{"stage-chip--active":r.selected[c.id],"stage-chip--disabled":r.disabled}])},[i("input",{type:"checkbox",checked:r.selected[c.id],disabled:r.disabled,onChange:o=>s(c.id,o.target.checked)},null,40,ca),i("span",{class:"stage-chip-color",style:me({backgroundColor:c.color})},null,4),i("span",ua,H(c.name),1)],2))),128))])]))}},pa=Ie(da,[["__scopeId","data-v-fe03c03c"]]),dt=140,We=new Map;class Bt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await pt.call("crm.item.list",{entityTypeId:dt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let a=[];if(e&&e.result&&(Array.isArray(e.result)?a=e.result:e.result.items&&Array.isArray(e.result.items)?a=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(a=e.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const s=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s),ticketSample:JSON.stringify(s).substring(0,500)});const n=Mt(s),l=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:n.departmentHead,departmentHeadFull:l?String(l).trim():null});let c=null;if(l){const o=String(l).trim();o.length>0&&(c=o)}return{...n,departmentHeadFull:c}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(s=>{We.has(s)?e.push(We.get(s)):a.push(s)}),a.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:dt});const s=await pt.call("crm.item.list",{entityTypeId:dt,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!s,resultType:typeof s,resultKeys:s?Object.keys(s):[],hasResultResult:!!(s!=null&&s.result),resultResultType:typeof(s==null?void 0:s.result),isArray:Array.isArray(s==null?void 0:s.result),resultResultLength:Array.isArray(s==null?void 0:s.result)?s.result.length:"not array",fullResult:s});let n=[];if(s&&s.result&&(Array.isArray(s.result)?n=s.result:s.result.items&&Array.isArray(s.result.items)?n=s.result.items:s.result.data&&Array.isArray(s.result.data)&&(n=s.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!s,hasResultResult:!!(s!=null&&s.result),resultType:typeof(s==null?void 0:s.result),result:s,resultKeys:s?Object.keys(s):[]}),e;const l=n.map((c,o)=>{o===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const u=Mt(c);o===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:u.id,hasDepartmentHead:!!u.departmentHead,departmentHead:u.departmentHead,mappedTicketKeys:Object.keys(u).filter(g=>g.toLowerCase().includes("department"))});const f=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;o===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:f,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(g=>g.toLowerCase().includes("department")||g.toLowerCase().includes("uf_crm"))});let p=null;if(f){const g=String(f).trim();g.length>0&&(p=g)}!p&&u.departmentHead&&(p=u.departmentHead);const d={...u,departmentHeadFull:p||u.departmentHead||null};return o===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&We.set(d.id,d),d});return[...e,...l]}catch(s){return console.error("[TicketDetailsService] Error loading tickets details batch:",s),console.error("[TicketDetailsService] Error details:",{message:s.message,stack:s.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){We.size>t&&We.clear()}static getCacheSize(){return We.size}}async function ga(r,t,e,a=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:r,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!r||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const s=e.tickets.filter(f=>{const p=f.assignedTo;return p?(typeof p=="object"?p.id:p)===r:!1});if(s.length===0)return[];const n=!s[0].stageId||!s[0].departmentHead;let l=null;if(n){const f=s.map(p=>p.id);if(a&&typeof a=="object")l=a;else try{const p=await Bt.getTicketsDetails(f);l=new Map,p.forEach(d=>{d&&d.id&&l.set(d.id,d)})}catch(p){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",p),l=null}}return s.map(f=>{const p=f.id,d={id:p,title:f.title||"Без названия",assignedTo:f.assignedTo,createdAt:f.createdAt,updatedAt:f.updatedAt};if(l){const g=l instanceof Map?l.get(p):l[p];g?(d.stageId=g.stageId||null,d.departmentHead=g.departmentHead||null,d.departmentHeadFull=g.departmentHeadFull||g.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=f.stageId||null,d.departmentHead=f.departmentHead||null,d.departmentHeadFull=f.departmentHeadFull||f.departmentHead||null;return d}).filter(f=>f.stageId?st(f.stageId)===t:!0)}function xt(r,t=new Date){if(!r||r.length===0)return[];const e=r.length,a={};return Object.values(fe).forEach(n=>{a[n]={category:n,label:Nt[n].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:Nt[n].color}}),r.forEach(n=>{if(!n.createdAt){a[fe.MORE_THAN_YEAR].count++,a[fe.MORE_THAN_YEAR].tickets.push(n);return}const l=Qt(n.createdAt,t);a[l]&&(a[l].count++,a[l].tickets.push(n))}),Object.values(a).filter(n=>n.count>0).map(n=>{const l=e>0?parseFloat((n.count/e*100).toFixed(1)):0;return{...n,percentage:l,progressBarWidth:l}}).sort((n,l)=>{const c=[fe.TODAY,fe.YESTERDAY,fe.THIS_WEEK,fe.LAST_WEEK,fe.MORE_THAN_TWO_WEEKS,fe.UP_TO_ONE_MONTH,fe.MORE_THAN_TWO_MONTHS,fe.MORE_THAN_HALF_YEAR,fe.MORE_THAN_YEAR];return c.indexOf(n.category)-c.indexOf(l.category)})}function fa(r){if(!r||r.length===0)return[];const t={};r.forEach(a=>{let s=a.departmentHeadFull||a.departmentHead;r.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(n=>n.toLowerCase().includes("department"))}),s?(s=String(s).trim(),s.length===0&&(s="Без заказчика")):s="Без заказчика",t[s]||(t[s]={departmentName:s,count:0}),t[s].count++});const e=Object.values(t);return e.sort((a,s)=>s.count!==a.count?s.count-a.count:a.departmentName.localeCompare(s.departmentName,"ru")),e}const ze=10;function nt(r,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(s=>s.ticketsByStage&&s.ticketsByStage[r]>0).forEach(s=>{e.push({id:s.id,name:s.name,count:s.ticketsByStage[r]||0})});const a=ma(r,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((s,n)=>n.count-s.count)}function ma(r,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[r])return t.statistics.zeroPointByStage[r].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function jt(r,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[r])==null?void 0:e.count)||0}function ot(r,t=ze){if(!r||r.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...r].sort((l,c)=>c.count-l.count),a=e.slice(0,t),s=e.slice(t),n=s.reduce((l,c)=>l+c.count,0);return{visible:a,others:{employees:s,count:n,employeeCount:s.length}}}function Wt(r,t){return!r||r.length===0?[]:t===0?r.map(e=>({...e,percentage:0})):r.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Ke(r,t,e="#007bff",a=ze){if(!r||r.length===0)return{employees:[],others:null};const{visible:s,others:n}=ot(r,a),l=Wt(s,t).map(o=>({...o,progressBarWidth:o.percentage,progressBarColor:o.isKeeper?"#f59e0b":e}));let c=null;if(n.count>0){const o=parseFloat((n.count/t*100).toFixed(1));c={...n,percentage:o,progressBarWidth:o,progressBarColor:"#6c757d"}}return{employees:l,others:c}}function ha(r,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(s=>{const n=t[s];if(!n)return;const l=nt(r,n),c=jt(r,n);if(l.length===0)return;const{visible:o,others:u}=ot(l,ze),f=Wt(o,c);e[s]=f,u.count>0&&(e.others[s]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/c*100).toFixed(1))})}),e}function va(r,t="current",e=[]){const a=r[t];if(!a)return{labels:[],datasets:[]};const s=new Map;e.forEach(p=>{nt(p.id,a).forEach(g=>{s.has(g.id)||s.set(g.id,{id:g.id,name:g.name,isKeeper:g.isKeeper||!1,ticketsByStage:{}}),s.get(g.id).ticketsByStage[p.id]=g.count})});const n=Array.from(s.values()).map(p=>{const d=Object.values(p.ticketsByStage).reduce((g,D)=>g+D,0);return{...p,totalTickets:d}});n.sort((p,d)=>d.totalTickets-p.totalTickets);const{visible:l,others:c}=ot(n,ze),o=e.map(()=>""),u={};e.forEach(p=>{const d=nt(p.id,a),{visible:g}=ot(d,ze);u[p.id]=g.map(D=>({id:D.id,name:D.name,count:D.count}))});const f=l.map((p,d)=>{const g=e.map(y=>p.ticketsByStage[y.id]||0),D=e.map(y=>{if((p.ticketsByStage[y.id]||0)===0)return"transparent";const A=y.color.replace("#",""),z=parseInt(A.substring(0,2),16),Q=parseInt(A.substring(2,4),16),te=parseInt(A.substring(4,6),16),B=.6+d*.05;return`rgba(${z}, ${Q}, ${te}, ${Math.min(B,.95)})`});return{label:p.name,data:g,backgroundColor:D,borderColor:e.map(y=>{const k=y.color.replace("#",""),S=parseInt(k.substring(0,2),16),A=parseInt(k.substring(2,4),16),z=parseInt(k.substring(4,6),16);return`rgba(${S}, ${A}, ${z}, 0.8)`}),borderWidth:1,meta:{employeeId:p.id,employeeName:p.name}}});if(c.count>0){const p=e.map(d=>c.employees.reduce((g,D)=>g+(D.ticketsByStage[d.id]||0),0));f.push({label:`Другие (${c.employeeCount})`,data:p,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:o,datasets:f,meta:{employeesByStage:u}}}function ya(r,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(u=>u.id===r),s=a?a.name:"",n=a?a.color:"#007bff",l=nt(r,t),c=jt(r,t);if(l.length===0)return{stageName:s,totalCount:0,employees:[],others:null};const o=Ke(l,c,n,ze);return{stageName:s,totalCount:c,employees:o.employees,others:o.others}}function ka(r,t){return(t==null?void 0:t[r])||r}function wa(r,t){return(t==null?void 0:t[r])||"#007bff"}function ft({snapshots:r,graphType:t,timePoint:e,snapshotType:a}){return r?t==="line"&&e?r[e]||null:t==="bar"&&a?r[a]||null:r.current||r.weekEnd||r.weekStart||null:null}function mt(r,t){var e,a,s;return((s=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[r])==null?void 0:s.count)||0}function ba({stageId:r,timePoint:t,meta:e,snapshots:a,stageColor:s,maxVisible:n}){if(!(e!=null&&e.employees)||!t)return null;const l=e.employees[t];if(!l||l.length===0)return null;const c=(a==null?void 0:a[t])||null,o=mt(r,c)||l.reduce((f,p)=>f+(p.count||0),0),u=Ke(l,o,s,n);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}function Sa({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s}){var u;const n=(u=t==null?void 0:t.employees)==null?void 0:u[r];if(!n||!n.employees||n.employees.length===0)return null;const l=ft({snapshots:e,graphType:"doughnut"}),c=n.totalCount??mt(r,l)??n.employees.reduce((f,p)=>f+(p.count||0),0),o=Ke(n.employees,c,a,s);return{stageId:r,totalCount:c,employees:o.employees,others:o.others,snapshot:l}}function Da({stageId:r,meta:t,snapshots:e,stageColor:a,maxVisible:s,snapshotType:n}){var f;const l=(f=t==null?void 0:t.employeesByStage)==null?void 0:f[r];if(!l||l.length===0)return null;const c=ft({snapshots:e,graphType:"bar",snapshotType:n}),o=mt(r,c)||l.reduce((p,d)=>p+(d.count||0),0),u=Ke(l,o,a,s);return{stageId:r,totalCount:o,employees:u.employees,others:u.others,snapshot:c}}async function Ea({stageId:r,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:s=null,meta:n=null,stageColorMap:l=null,stageNameMap:c=null,maxVisible:o=10,restLoader:u=null}){if(!r)throw new Error("stageId обязателен для загрузки данных уровня 1");const f=ka(r,c),p=wa(r,l);let d=null;if(t==="line"?d=ba({stageId:r,timePoint:e,meta:n==null?void 0:n.line,snapshots:s,stageColor:p,maxVisible:o}):t==="doughnut"?d=Sa({stageId:r,meta:n==null?void 0:n.doughnut,snapshots:s,stageColor:p,maxVisible:o}):t==="bar"&&(d=Da({stageId:r,meta:n==null?void 0:n.bar,snapshots:s,stageColor:p,maxVisible:o,snapshotType:a})),d)return{stageId:r,stageName:f,color:p,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot};if(typeof u=="function"){const g=await u({stageId:r,graphType:t,timePoint:e,snapshotType:a,snapshots:s});if(g&&Array.isArray(g.employees)){const D=g.totalCount??g.employees.reduce((k,S)=>k+(S.count||0),0),y=Ke(g.employees,D,p,o);return{stageId:r,stageName:f,color:p,totalCount:D,employees:y.employees,others:y.others,snapshot:g.snapshot||ft({snapshots:s,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const _a={key:"level-1",class:"level-1"},Ca={class:"modal-header"},Ta={class:"stage-header"},Aa=["aria-expanded","onKeydown"],Ia={class:"stage-title"},$a=["aria-selected","onClick","onKeydown"],Ma={class:"stage-name"},Na={class:"modal-total"},Ra={class:"view-switcher"},Fa={class:"modal-body"},xa={key:0,class:"load-error"},Ha={key:1,class:"stage-loader"},Oa={key:2},Pa={key:0,class:"no-employees"},La={key:1,class:"employees-list"},Ba=["onClick"],ja={class:"employee-name"},Wa={class:"employee-progress"},Ua={class:"employee-count"},za={key:0,class:"employee-item employee-others"},Ka={class:"employee-name"},Va={class:"employee-progress"},Ga={class:"employee-count"},Ya={key:3,class:"view-time"},qa={key:0,class:"no-data"},Xa={key:1,class:"date-categories-list"},Ja=["onClick"],Za={class:"category-label"},Qa={class:"category-progress"},es={class:"category-count"},ts={key:4,class:"view-departments"},as={key:0,class:"no-data"},ss={key:1,class:"departments-table-container"},ns={class:"departments-table"},os=["onClick"],ls={class:"col-department"},rs={class:"department-name"},is={class:"col-count"},cs={class:"count-value"},us={key:"level-2",class:"level-2"},ds={class:"modal-header"},ps={class:"modal-total"},gs={class:"modal-body"},fs={class:"stage-info"},ms={class:"stage-badge"},hs={key:0,class:"no-data"},vs={key:1,class:"date-categories-list"},ys=["onClick"],ks={class:"category-label"},ws={class:"category-progress"},bs={class:"category-count"},Ss={key:"level-3",class:"level-3"},Ds={class:"modal-header"},Es={class:"header-info"},_s={class:"header-badges"},Cs={class:"date-badge"},Ts={class:"stage-badge"},As={class:"modal-total"},Is={class:"modal-body"},$s={key:0,class:"no-data"},Ms={key:1,class:"departments-table-container"},Ns={class:"departments-table"},Rs=["onClick"],Fs={class:"col-department"},xs={class:"department-name"},Hs={class:"col-count"},Os={class:"count-value"},Ps={key:"level-4",class:"level-4"},Ls={class:"modal-header"},Bs={class:"header-info"},js={key:0,class:"header-badges"},Ws={key:0,class:"date-badge"},Us={key:1,class:"department-badge"},zs={class:"stage-badge"},Ks={class:"modal-total"},Vs={class:"modal-body"},Gs={key:"loading",class:"loading-state"},Ys={key:"error-fallback",class:"error-state-with-fallback"},qs={class:"tickets-list-container"},Xs={key:"error",class:"error-state"},Js={class:"error-message"},Zs={key:"empty",class:"empty-state"},Qs={class:"empty-state-title"},en={class:"empty-state-message"},tn={key:"tickets",class:"tickets-list-container"},an={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(r,{expose:t,emit:e}){const a=r,s=e,n=Ze(),l=N(1),c=N("employees"),o=N(null),u=N([]),f=N([]),p=N(null),d=N(null),g=N(null),D=N(a.stageSwitchContext||null),y=N(!1),k=N(null),S=N(null),A=N(!1),z=N(null),Q=N(null),te=ee(()=>{var w,M;const h=((w=D.value)==null?void 0:w.stageNameMap)||{},b=((M=D.value)==null?void 0:M.stageColorMap)||{};return Object.keys(h).map(K=>{var W;return{id:K,name:h[K],color:b[K]||"#007bff",disabled:K===(((W=o.value)==null?void 0:W.stageId)||a.stageId)}})});ee(()=>l.value>1);const B=ee(()=>{var h,b,w,M,K;switch(l.value){case 1:return((h=o.value)==null?void 0:h.stageName)||a.stageName;case 2:return((b=p.value)==null?void 0:b.employeeName)||"";case 3:return`${((w=p.value)==null?void 0:w.employeeName)||""} — ${((M=d.value)==null?void 0:M.dateCategoryLabel)||""}`;case 4:if(!((K=g.value)!=null&&K.context))return"Список тикетов";const W=g.value.context,ae=[];return W.employeeName&&ae.push(W.employeeName),W.dateCategoryLabel&&ae.push(W.dateCategoryLabel),W.departmentName&&ae.push(W.departmentName),W.stageName&&ae.push(W.stageName),ae.length>0?ae.join(" — "):"Список тикетов";default:return""}});function P(){var h,b,w;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((h=a.employees)==null?void 0:h.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((w=(b=a.snapshot)==null?void 0:b.ticketIds)==null?void 0:w.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",G(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function G(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const h=o.value.snapshot.tickets||[],b=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:h.length,currentStageId:b,sampleTicket:h[0]?{id:h[0].id,stageId:h[0].stageId,hasDepartmentHead:!!h[0].departmentHead,departmentHead:h[0].departmentHead,hasDepartmentHeadFull:!!h[0].departmentHeadFull,departmentHeadFull:h[0].departmentHeadFull,allKeys:Object.keys(h[0])}:null});let w=h.filter(F=>F.stageId?st(F.stageId)===b:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:h.length,afterFilter:w.length,stageId:b,ticketsWithStageId:w.filter(F=>F.stageId).length,ticketsWithoutStageId:w.filter(F=>!F.stageId).length});const M=w.filter(F=>!F.departmentHead&&!F.departmentHeadFull);if(M.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:M.length,totalTickets:w.length,ticketsWithDepartment:w.filter(q=>q.departmentHead||q.departmentHeadFull).length});const F=M.map(q=>q.id).filter(q=>q);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:F.length,ticketIdsSample:F.slice(0,10)});const q=await Bt.getTicketsDetails(F),re=new Map;q.forEach(m=>{m&&m.id&&re.set(m.id,m)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:q.length,detailsMapSize:re.size,sampleDetail:q[0]?{id:q[0].id,departmentHead:q[0].departmentHead,departmentHeadFull:q[0].departmentHeadFull}:null}),w=w.map(m=>{const I=re.get(m.id);return I?{...m,stageId:I.stageId||m.stageId||null,departmentHead:I.departmentHead||m.departmentHead||null,departmentHeadFull:I.departmentHeadFull||I.departmentHead||m.departmentHead||null}:m}),w=w.filter(m=>m.stageId?st(m.stageId)===b:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:w.length,ticketsWithDepartment:w.filter(m=>m.departmentHead||m.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(m=>!m.departmentHead&&!m.departmentHeadFull).length,ticketsWithStageId:w.filter(m=>m.stageId).length,ticketsWithoutStageId:w.filter(m=>!m.stageId).length});const C=w.length,v=w.slice(0,3).map(m=>({id:m.id,departmentHead:m.departmentHead,departmentHeadFull:m.departmentHeadFull,stageId:m.stageId}));w=w.filter(m=>m.stageId?st(m.stageId)===b:!0);const _=w.slice(0,3).map(m=>({id:m.id,departmentHead:m.departmentHead,departmentHeadFull:m.departmentHeadFull,stageId:m.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:C,afterStageFilter:w.length,filteredOut:C-w.length,currentStageId:b,ticketsWithDepartment:w.filter(m=>m.departmentHead||m.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(m=>!m.departmentHead&&!m.departmentHeadFull).length,sampleBeforeFilter:v,sampleAfterFilter:_,sampleWithDepartment:w.find(m=>m.departmentHead||m.departmentHeadFull)?{id:w.find(m=>m.departmentHead||m.departmentHeadFull).id,departmentHead:w.find(m=>m.departmentHead||m.departmentHeadFull).departmentHead,departmentHeadFull:w.find(m=>m.departmentHead||m.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(w.find(m=>m.departmentHead||m.departmentHeadFull)).filter(m=>m.toLowerCase().includes("department"))}:null})}catch(q){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",q),console.error("[EmployeeDetailsModal] Error details:",{message:q.message,stack:q.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:w.length,currentStageId:b,ticketsWithStageId:w.filter(F=>F.stageId).length,ticketsWithoutStageId:w.filter(F=>!F.stageId).length,ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const K=xt(w);u.value=K,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:w.length,sampleTickets:w.slice(0,5).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,hasDepartmentHead:!!F.departmentHead,hasDepartmentHeadFull:!!F.departmentHeadFull,allKeys:Object.keys(F).filter(q=>q.toLowerCase().includes("department"))})),ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const W=fa(w);f.value=W;const ae=K.reduce((F,q)=>F+q.count,0),Se=W.reduce((F,q)=>F+q.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:b,totalTicketsForGrouping:w.length,timeCategoriesCount:K.length,totalTicketsInTimeCategories:ae,departmentsCount:W.length,totalTicketsInDepartments:Se,departmentsSample:W.slice(0,5),ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,consistencyCheck:{totalTickets:w.length,timeCategoriesTotal:ae,departmentsTotal:Se,isConsistent:w.length===ae&&w.length===Se}})}catch(h){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",h),console.error("[EmployeeDetailsModal] Error stack:",h.stack)}}async function X(h){var w;if(!h){n.error("Не указан stageId для загрузки данных");return}if(((w=o.value)==null?void 0:w.stageId)===h)return;if(!D.value){n.error("Нет контекста для смены стадии (stageSwitchContext)");return}y.value=!0,k.value=null;const b=o.value?{...o.value}:null;S.value=(b==null?void 0:b.stageId)||null;try{const M=await Ea({...D.value,stageId:h});o.value={stageId:M.stageId,stageName:M.stageName,stageColor:M.color,totalCount:M.totalCount,employees:M.employees,others:M.others,snapshot:M.snapshot||(b==null?void 0:b.snapshot)||null,ticketDetails:M.ticketDetails||null},p.value=null,d.value=null,g.value=null,l.value=1,c.value="employees",await G()}catch(M){console.error("[EmployeeDetailsModal] Failed to reload stage data:",M),k.value=(M==null?void 0:M.message)||"Не удалось загрузить данные стадии",b&&(o.value=b),n.error(k.value)}finally{y.value=!1}}async function ce(h){if(!h||h.count===0){n.info(`У заказчика "${(h==null?void 0:h.departmentName)||"неизвестный"}" нет тикетов`);return}if(!d.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),n.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:b}=await Be(async()=>{const{createContextFromLevel3:M}=await import("./ticketListUtils-BxdZ12Le.js");return{createContextFromLevel3:M}},__vite__mapDeps([0,1,2,3,4,5])),w=await b(d.value,h);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:w.employeeName,dateCategory:w.dateCategoryLabel,departmentName:w.departmentName,ticketsCount:w.tickets.length}),await ke(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function ue(h){if(!h||h.count===0){n.info(`У заказчика "${(h==null?void 0:h.departmentName)||"неизвестный"}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:b}=await Be(async()=>{const{createContextFromLevel1Department:M}=await import("./ticketListUtils-BxdZ12Le.js");return{createContextFromLevel1Department:M}},__vite__mapDeps([0,1,2,3,4,5])),w=b(o.value,h);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:w.stageName,departmentName:w.departmentName,ticketsCount:w.tickets.length}),await ke(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function $e(h){if(!h||h.count===0){n.info(`В категории "${(h==null?void 0:h.label)||"неизвестная"}" нет тикетов`);return}if(!h.tickets||h.tickets.length===0){n.info(`В категории "${h.label}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),n.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:b}=await Be(async()=>{const{createContextFromLevel1Time:M}=await import("./ticketListUtils-BxdZ12Le.js");return{createContextFromLevel1Time:M}},__vite__mapDeps([0,1,2,3,4,5])),w=b(o.value,h);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:w.stageName,dateCategory:w.dateCategoryLabel,ticketsCount:w.tickets.length}),await ke(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}Ue(()=>a.isVisible,h=>{h?P():(Pe(),Y())}),Ue(()=>a.stageSwitchContext,h=>{D.value=h},{deep:!0}),Oe(()=>{a.isVisible&&P()});async function we(h,b=null){var w,M,K;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",h),console.log("[EmployeeDetailsModal] Current popup level:",l.value),b&&b.currentTarget&&(b.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{b.currentTarget&&(b.currentTarget.style.transform="")},150)),!h||!h.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",h);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),n.warning("ID стадии не указан");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),n.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",h.id,"stage:",o.value.stageId);const W=await ga(h.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(W==null?void 0:W.length)||0,W),!W||W.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),n.info(`У сотрудника "${h.name}" нет тикетов на стадии "${o.value.stageName}"`);return}const ae=xt(W);console.log("[EmployeeDetailsModal] Date categories:",(ae==null?void 0:ae.length)||0,ae),p.value={employeeId:h.id,employeeName:h.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:W.length,dateCategories:ae,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),l.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",l.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(w=p.value)==null?void 0:w.employeeName,dateCategoriesCount:((K=(M=p.value)==null?void 0:M.dateCategories)==null?void 0:K.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",l.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(W){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",W),console.error("[EmployeeDetailsModal] Error stack:",W.stack),n.error("Ошибка загрузки данных о тикетах: "+W.message)}}async function Ve(h){if(!h||h.count===0){n.info(`В категории "${(h==null?void 0:h.label)||"неизвестная"}" нет тикетов`);return}if(!h.tickets||h.tickets.length===0){n.info(`В категории "${h.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),n.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:b}=await Be(async()=>{const{createContextFromLevel2:M}=await import("./ticketListUtils-BxdZ12Le.js");return{createContextFromLevel2:M}},__vite__mapDeps([0,1,2,3,4,5])),w=b(p.value,h);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:w.employeeName,dateCategory:w.dateCategoryLabel,ticketsCount:w.tickets.length}),await ke(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",b),n.error("Ошибка перехода на список тикетов: "+b.message)}}async function ke(h){var b;if(console.time("[Performance] goToLevel4"),!h){console.error("[EmployeeDetailsModal] Context is required for level 4"),n.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:h.sourceLevel,employeeId:h.employeeId,stageId:h.stageId,dateCategory:h.dateCategory,departmentName:h.departmentName,ticketsCount:((b=h.tickets)==null?void 0:b.length)||0});try{g.value={context:h,tickets:[],totalCount:0,isLoading:!0,error:null};let w=h.tickets||[];if(w.length===0&&h.snapshot){const{filterTicketsByContext:K}=await Be(async()=>{const{filterTicketsByContext:W}=await import("./ticketListUtils-BxdZ12Le.js");return{filterTicketsByContext:W}},__vite__mapDeps([0,1,2,3,4,5]));w=await K(h)}(!w||w.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),w=h.tickets||[]),(!w||w.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),h.snapshot&&h.snapshot.tickets&&(w=h.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",w.length)));let M=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:K}=await Be(async()=>{const{prepareTicketsForDisplay:W}=await import("./ticketListUtils-BxdZ12Le.js");return{prepareTicketsForDisplay:W}},__vite__mapDeps([0,1,2,3,4,5]));M=await K(w,h.snapshot,h.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(K){console.error("[EmployeeDetailsModal] Error preparing tickets:",K),console.timeEnd("[Performance] prepareTicketsForDisplay"),M=w||[],n.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:w.length,preparedCount:M.length}),g.value={context:h,tickets:M,totalCount:M.length,isLoading:!1,error:null},l.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:g.value.totalCount,ticketsCount:g.value.tickets.length,isLoading:g.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(w){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",w),console.error("[EmployeeDetailsModal] Error details:",{message:w.message,stack:w.stack,context:h});let M=[];if(h.snapshot&&h.snapshot.tickets)try{const K=h.stageId;K?M=(h.snapshot.tickets||[]).filter(W=>W.stageId===K):M=h.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",M.length)}catch(K){console.error("[EmployeeDetailsModal] Error using fallback tickets:",K)}g.value={context:h,tickets:M,totalCount:M.length,isLoading:!1,error:{message:w.message,hasFallback:M.length>0}},M.length>0?(n.warning("Ошибка загрузки данных. Отображаются данные из кеша."),l.value=4):(n.error("Ошибка загрузки тикетов: "+w.message),he()),console.timeEnd("[Performance] goToLevel4")}}function he(){if(l.value===4){if(g.value&&g.value.context){const h=g.value.context.sourceLevel;l.value=h}else l.value=1;g.value=null}else l.value===3?(l.value=2,d.value=null,g.value=null):l.value===2&&(l.value=1,p.value=null,d.value=null,g.value=null)}function Pe(){l.value=1,o.value=null,p.value=null,d.value=null,g.value=null}function be(){var K;if(!((K=g.value)!=null&&K.context))return"Нет тикетов";const{sourceLevel:h,employeeName:b,dateCategoryLabel:w,departmentName:M}=g.value.context;return h===2&&b&&w?`Нет тикетов у ${b} в категории "${w}"`:h===3&&b&&M?`Нет тикетов у ${b} у заказчика "${M}"`:h===1&&w?`Нет тикетов в категории "${w}"`:h===1&&M?`Нет тикетов у заказчика "${M}"`:"Нет тикетов для отображения"}function Le(){var b;if(!((b=g.value)!=null&&b.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:h}=g.value.context;return h?`На стадии "${h}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function Ge(){var b;if(!((b=g.value)!=null&&b.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const h=g.value.context;await ke(h)}function Me(h){if(!h){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),n.warning("Ошибка: тикет не найден");return}if(!h.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",h),n.error("Ошибка: ID тикета не указан");return}try{const b=ea(h.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:h.id,iframeUrl:b}),!b||typeof b!="string"||b.length===0)throw new Error("Не удалось сформировать URL для тикета");const w=window.open(b,"_blank","noopener,noreferrer");if(!w||w.closed||typeof w.closed>"u")try{const M=document.createElement("a");M.href=b,M.target="_blank",M.rel="noopener noreferrer",M.style.display="none",document.body.appendChild(M),M.click(),document.body.removeChild(M),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:h.id,iframeUrl:b})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:h.id,iframeUrl:b})}catch(b){console.error("[EmployeeDetailsModal] Error opening ticket:",b),console.error("[EmployeeDetailsModal] Error details:",{message:b.message,stack:b.stack,ticket:h}),n.error("Ошибка открытия тикета: "+b.message)}}function ve(){Pe(),s("close")}t({reloadLevel1ForStage:X});function L(h){h&&h.stopPropagation(),A.value=!A.value}function Y(){A.value&&(A.value=!1)}function ye(h){if(!A.value)return;const b=z.value,w=Q.value;b&&b.contains(h.target)||w&&w.contains(h.target)||(A.value=!1)}async function Ne(h){if(h.disabled){A.value=!1;return}A.value=!1,await X(h.id)}return(h,b)=>(E(),Ae(Ot,{to:"body"},[r.isVisible?(E(),T("div",{key:0,class:"employee-details-modal",onClick:ne(ve,["self"]),onKeydown:qe(ve,["esc"])},[i("div",{class:"modal-content",onClick:ye},[ie(Je,{name:"level",mode:"out-in"},{default:Te(()=>{var w,M,K,W,ae,Se,F,q,re,C,v,_,m,I,O,R,V,U,j;return[l.value===1?(E(),T("div",_a,[i("div",Ca,[i("div",Ta,[i("button",{ref_key:"stageTriggerRef",ref:Q,class:"stage-trigger","aria-expanded":A.value,"aria-haspopup":"listbox",onClick:ne(L,["stop"]),onKeydown:[qe(ne(L,["prevent"]),["enter"]),qe(ne(L,["prevent"]),["space"]),qe(ne(Y,["stop","prevent"]),["esc"])]},[i("span",{class:"stage-color",style:me({backgroundColor:((w=o.value)==null?void 0:w.stageColor)||((W=(M=D.value)==null?void 0:M.stageColorMap)==null?void 0:W[(K=o.value)==null?void 0:K.stageId])||((Se=(ae=D.value)==null?void 0:ae.stageColorMap)==null?void 0:Se[r.stageId])||"#007bff"})},null,4),i("span",Ia,H(((F=o.value)==null?void 0:F.stageName)||r.stageName),1),i("span",{class:oe(["stage-caret",{open:A.value}])},"▾",2)],40,Aa),A.value?(E(),T("div",{key:0,ref_key:"stageDropdownRef",ref:z,class:"stage-dropdown",role:"listbox"},[(E(!0),T(de,null,pe(te.value,$=>(E(),T("div",{key:$.id,class:oe(["stage-option",{disabled:$.disabled}]),role:"option","aria-selected":$.disabled,onClick:ne(x=>Ne($),["stop"]),onKeydown:qe(ne(x=>Ne($),["prevent"]),["enter"])},[i("span",{class:"stage-color",style:me({backgroundColor:$.color})},null,4),i("span",Ma,H($.name),1)],42,$a))),128))],512)):Z("",!0)]),i("span",Na,"Всего: "+H(((q=o.value)==null?void 0:q.totalCount)||r.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Ra,[i("button",{class:oe(["view-switch-btn",{active:c.value==="employees"}]),onClick:b[0]||(b[0]=$=>c.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="time"}]),onClick:b[1]||(b[1]=$=>c.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),i("button",{class:oe(["view-switch-btn",{active:c.value==="departments"}]),onClick:b[2]||(b[2]=$=>c.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),i("div",Fa,[k.value?(E(),T("div",xa,[i("span",null,"Ошибка: "+H(k.value),1)])):Z("",!0),y.value?(E(),T("div",Ha,[...b[3]||(b[3]=[i("div",{class:"loading-spinner small"},null,-1),i("span",null,"Загрузка стадии...",-1)])])):Z("",!0),c.value==="employees"?(E(),T("div",Oa,[(((re=o.value)==null?void 0:re.employees)||r.employees).length===0&&(!((C=o.value)!=null&&C.others||r.others)||(((v=o.value)==null?void 0:v.others)||r.others).count===0)?(E(),T("div",Pa," Нет данных о сотрудниках ")):(E(),T("div",La,[(E(!0),T(de,null,pe(((_=o.value)==null?void 0:_.employees)||r.employees,$=>(E(),T("div",{key:$.id,class:oe(["employee-item",{"employee-keeper":$.isKeeper}]),onClick:ne(x=>we($,x),["stop"]),title:"Кликните для детализации по временным градациям"},[i("span",ja,H($.name),1),i("div",Wa,[i("div",{class:"progress-bar",style:me({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",Ua,H($.count)+" тикетов ("+H($.percentage)+"%) ",1),b[4]||(b[4]=i("span",{class:"employee-arrow"},"→",-1))],10,Ba))),128)),((m=o.value)!=null&&m.others||r.others)&&(((I=o.value)==null?void 0:I.others)||r.others).count>0?(E(),T("div",za,[i("span",Ka,"Другие ("+H((((O=o.value)==null?void 0:O.others)||r.others).employeeCount)+")",1),i("div",Va,[i("div",{class:"progress-bar",style:me({width:(((R=o.value)==null?void 0:R.others)||r.others).progressBarWidth+"%",backgroundColor:(((V=o.value)==null?void 0:V.others)||r.others).progressBarColor})},null,4)]),i("span",Ga,H((((U=o.value)==null?void 0:U.others)||r.others).count)+" тикетов ("+H((((j=o.value)==null?void 0:j.others)||r.others).percentage)+"%) ",1)])):Z("",!0)]))])):c.value==="time"?(E(),T("div",Ya,[u.value.length===0?(E(),T("div",qa," Загрузка данных... ")):(E(),T("div",Xa,[(E(!0),T(de,null,pe(u.value,$=>(E(),T("div",{key:$.category,class:"category-item",onClick:ne(x=>$e($),["stop"])},[i("span",Za,H($.label),1),i("div",Qa,[i("div",{class:"progress-bar",style:me({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",es,H($.count)+" тикетов ("+H($.percentage)+"%) ",1),b[5]||(b[5]=i("span",{class:"category-arrow"},"→",-1))],8,Ja))),128))]))])):c.value==="departments"?(E(),T("div",ts,[f.value.length===0?(E(),T("div",as," Загрузка данных... ")):(E(),T("div",ss,[i("table",ns,[b[7]||(b[7]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(E(!0),T(de,null,pe(f.value,($,x)=>(E(),T("tr",{key:x,class:"department-row",onClick:ne(J=>ue($),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",ls,[i("span",rs,H($.departmentName),1)]),i("td",is,[i("span",cs,H($.count),1)]),b[6]||(b[6]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,os))),128))])])]))])):Z("",!0)])])):l.value===2&&p.value?(E(),T("div",us,[i("div",ds,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("h3",null,H(p.value.employeeName),1),i("span",ps,"Всего: "+H(p.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",gs,[i("div",fs,[i("span",ms,H(p.value.stageName),1)]),p.value.dateCategories.length===0?(E(),T("div",hs," Нет данных о тикетах ")):(E(),T("div",vs,[(E(!0),T(de,null,pe(p.value.dateCategories,$=>(E(),T("div",{key:$.category,class:"category-item",onClick:ne(x=>Ve($),["stop"])},[i("span",ks,H($.label),1),i("div",ws,[i("div",{class:"progress-bar",style:me({width:$.progressBarWidth+"%",backgroundColor:$.progressBarColor})},null,4)]),i("span",bs,H($.count)+" тикетов ("+H($.percentage)+"%) ",1)],8,ys))),128))]))])])):l.value===3&&d.value?(E(),T("div",Ss,[i("div",Ds,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("div",Es,[i("h3",null,H(d.value.employeeName),1),i("div",_s,[i("span",Cs,H(d.value.dateCategoryLabel),1),i("span",Ts,H(d.value.stageName),1)])]),i("span",As,"Всего: "+H(d.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Is,[d.value.departments.length===0?(E(),T("div",$s," Нет данных о заказчиках ")):(E(),T("div",Ms,[i("table",Ns,[b[9]||(b[9]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(E(!0),T(de,null,pe(d.value.departments,($,x)=>(E(),T("tr",{key:x,class:"department-row",onClick:ne(J=>ce($),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",Fs,[i("span",xs,H($.departmentName),1)]),i("td",Hs,[i("span",Os,H($.count),1)]),b[8]||(b[8]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,Rs))),128))])])]))])])):l.value===4&&g.value?(E(),T("div",Ps,[i("div",Ls,[i("button",{class:"btn-back",onClick:he,"aria-label":"Назад"}," ← "),i("div",Bs,[i("h3",null,H(B.value),1),g.value.context?(E(),T("div",js,[g.value.context.dateCategoryLabel?(E(),T("span",Ws,H(g.value.context.dateCategoryLabel),1)):Z("",!0),g.value.context.departmentName?(E(),T("span",Us,H(g.value.context.departmentName),1)):Z("",!0),i("span",zs,H(g.value.context.stageName),1)])):Z("",!0)]),i("span",Ks,"Всего: "+H(g.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ve,"aria-label":"Закрыть"},"×")]),i("div",Vs,[ie(Je,{name:"loading",mode:"out-in"},{default:Te(()=>[g.value.isLoading?(E(),T("div",Gs,[...b[10]||(b[10]=[i("div",{class:"loading-spinner"},null,-1),i("p",null,"Загрузка тикетов...",-1)])])):g.value.error&&g.value.error.hasFallback?(E(),T("div",Ys,[b[11]||(b[11]=i("div",{class:"error-banner"},[i("span",{class:"error-icon"},"⚠️"),i("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),i("div",qs,[ie(At,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(E(!0),T(de,null,pe(g.value.tickets,($,x)=>(E(),Ae(Rt,{key:$.id,ticket:$,draggable:!1,style:me({"--ticket-index":x}),onClick:J=>Me($)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):g.value.error&&!g.value.error.hasFallback?(E(),T("div",Xs,[b[12]||(b[12]=i("div",{class:"error-icon"},"❌",-1)),b[13]||(b[13]=i("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),i("p",Js,H(g.value.error.message),1),i("button",{class:"btn-retry",onClick:Ge},"Повторить попытку")])):!g.value.tickets||g.value.tickets.length===0?(E(),T("div",Zs,[b[14]||(b[14]=i("div",{class:"empty-state-icon"},"📭",-1)),i("h3",Qs,H(be()),1),i("p",en,H(Le()),1)])):(E(),T("div",tn,[ie(At,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(E(!0),T(de,null,pe(g.value.tickets,($,x)=>(E(),Ae(Rt,{key:$.id,ticket:$,draggable:!1,style:me({"--ticket-index":x}),onClick:J=>Me($)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):Z("",!0)]}),_:1})])],32)):Z("",!0)]))}},sn=Ie(an,[["__scopeId","data-v-407a67e6"]]);function nn(r,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof r!="number"||r<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((l,c)=>{if(!l||!l.data||!Array.isArray(l.data))return;const o=l.data[r];o!=null&&!isNaN(o)&&a.push({datasetIndex:c,value:Number(o),y:Number(o)})}),a.length<2)return 0;const s=[];return a.forEach(l=>{let c=!1;for(const o of s){const u=o.y;if(Math.abs(l.y-u)<e){o.points.push(l),o.y=o.points.reduce((p,d)=>p+d.y,0)/o.points.length,c=!0;break}}c||s.push({points:[l],y:l.y})}),s.length===0?0:s.reduce((l,c)=>c.points.length>l.points.length?c:l,s[0]).points.length}function on(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.value-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.value,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.value})}),e}function ln(r,t=.5){var n,l;if(!r)return console.warn("findOverlappingPoints: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];const e=(n=r.data)==null?void 0:n.datasets,a=((l=r.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const s=[];return a.forEach((c,o)=>{try{if(nn(o,e,t)<2)return;const f=[];if(e.forEach((y,k)=>{if(!y||!y.data||!Array.isArray(y.data))return;const S=y.data[o];S==null||isNaN(S)||f.push({datasetIndex:k,value:Number(S),label:y.label||`Dataset ${k}`})}),f.length<2)return;const p=on(f,t);if(p.length===0)return;const d=p.reduce((y,k)=>k.points.length>y.points.length?k:y,p[0]);if(d.points.length<2)return;let g=null,D=null;for(let y=0;y<e.length;y++)try{const k=r.getDatasetMeta(y);if(k&&k.data&&k.data[o]){g=k,D=k.data[o];break}}catch{continue}if(!D||typeof D.x!="number"||typeof D.y!="number")return;s.push({position:o,count:d.points.length,x:D.x,y:D.y,value:d.y,points:d.points.map(y=>({datasetIndex:y.datasetIndex,value:y.value,label:y.label}))})}catch(u){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${o}:`,u)}}),s}function rn(r,t){const e=[];return r.forEach(a=>{let s=!1;for(const n of e){const l=n.y;if(Math.abs(a.y-l)<t){n.points.push(a),n.y=n.points.reduce((c,o)=>c+o.y,0)/n.points.length,s=!0;break}}s||e.push({points:[a],y:a.y})}),e}function cn(r,t,e=.5){var u,f;if(!r)return console.warn("calculatePointJitter: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(u=r.data)==null?void 0:u.datasets,s=((f=r.data)==null?void 0:f.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(s)||t>=s.length)return[];const n=[];if(a.forEach((p,d)=>{if(!p||!p.data||!Array.isArray(p.data))return;const g=p.data[t];if(!(g==null||isNaN(g)))try{const D=r.getDatasetMeta(d);if(D&&D.data&&D.data[t]){const y=D.data[t];y&&typeof y.x=="number"&&typeof y.y=="number"&&n.push({datasetIndex:d,value:Number(g),x:y.x,y:y.y})}}catch(D){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,D)}}),n.length===0)return[];const l=rn(n,e),c=[];l.forEach(p=>{const d=p.points||[];d.length>1?d.forEach((D,y)=>{const k=(y-(d.length-1)/2)*4;c.push({datasetIndex:D.datasetIndex,jitterX:k,value:D.value})}):d.length===1&&c.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const o=new Set(c.map(p=>p.datasetIndex));return n.forEach(p=>{o.has(p.datasetIndex)||c.push({datasetIndex:p.datasetIndex,jitterX:0,value:p.value})}),c}const un=.5,Ht=6,dn=2;function pn(r){return typeof r!="number"||r<2?Ht:Ht+(r-1)*dn}function gn(r,t){if(!r||!r.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=r.ctx,{x:s,y:n,points:l}=t,c=pn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(s,n,c,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&r.data&&r.data.datasets){const f=l[0].datasetIndex,p=r.data.datasets[f];if(p&&p.pointBackgroundColor){const d=Array.isArray(p.pointBackgroundColor)?p.pointBackgroundColor[t.position]||p.pointBackgroundColor[0]:p.pointBackgroundColor;if(d)if(d.startsWith("#")){const g=parseInt(d.slice(1,3),16),D=parseInt(d.slice(3,5),16),y=parseInt(d.slice(5,7),16);u=`rgba(${g}, ${D}, ${y}, 0.4)`}else d.startsWith("rgba")?u=d.replace(/rgba?\(([^)]+)\)/,(g,D)=>{const y=D.split(",").map(k=>k.trim());return`rgba(${y[0]}, ${y[1]}, ${y[2]}, 0.4)`}):u=d+"66"}}a.fillStyle=u,a.fill(),a.strokeStyle=u.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(u){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",u)}finally{a.restore()}}}const fn={id:"overlappingPointsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const t=ln(r,un);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{gn(r,a)}catch(s){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,s)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},mn=.5,hn={id:"pointJitterPlugin",beforeDatasetsDraw:r=>{var t,e;if(!(!r||!r.config||r.config.type!=="line")){r._jitterData||(r._jitterData={});try{const a=(t=r.data)==null?void 0:t.datasets,s=((e=r.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(s)||s.length===0)return;r._jitterData={},s.forEach((n,l)=>{const c=cn(r,l,mn);c&&c.length>0&&c.forEach(o=>{const u=`${o.datasetIndex}_${l}`;r._jitterData[u]=o.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx&&!(!r._jitterData||Object.keys(r._jitterData).length===0))try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);!l||l.hidden||!s.data||!Array.isArray(s.data)||s.data.forEach((c,o)=>{const u=l.data[o];if(!u||typeof u.x!="number"||typeof u.y!="number"||c==null||isNaN(c))return;const f=`${n}_${o}`,p=r._jitterData[f];if(!(p===void 0||p===0)){e.save();try{const d=s.pointStyle||"circle",g=(s.pointRadius||7)+1,D=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[o]||s.pointBackgroundColor[0]:s.pointBackgroundColor,y=Array.isArray(s.pointBorderColor)?s.pointBorderColor[o]||s.pointBorderColor[0]:s.pointBorderColor,k=s.pointBorderWidth||1,S=u.x+p,A=u.y;switch(e.fillStyle=D||"#007bff",e.strokeStyle=y||"#ffffff",e.lineWidth=k,e.beginPath(),d){case"circle":e.arc(S,A,g,0,2*Math.PI);break;case"triangle":e.moveTo(S,A-g),e.lineTo(S-g,A+g),e.lineTo(S+g,A+g),e.closePath();break;case"rect":case"rectRounded":const z=g*1.4;e.rect(S-z/2,A-z/2,z,z);break;case"rectRot":const Q=g*1.4;e.moveTo(S,A-Q/2),e.lineTo(S+Q/2,A),e.lineTo(S,A+Q/2),e.lineTo(S-Q/2,A),e.closePath();break;case"star":const te=g;for(let G=0;G<5;G++){const X=G*4*Math.PI/5-Math.PI/2,ce=S+te*Math.cos(X),ue=A+te*Math.sin(X);G===0?e.moveTo(ce,ue):e.lineTo(ce,ue)}e.closePath();break;case"cross":const B=g;e.moveTo(S-B,A-B),e.lineTo(S+B,A+B),e.moveTo(S+B,A-B),e.lineTo(S-B,A+B);break;case"crossRot":const P=g;e.moveTo(S-P,A),e.lineTo(S+P,A),e.moveTo(S,A-P),e.lineTo(S,A+P);break;default:e.arc(S,A,g,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),u._originalX||(u._originalX=u.x,u._originalY=u.y),u._jitterX=p,u._jitteredX=S,u._jitteredY=A}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${n}_${o}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:r=>{r._jitterData}},vn={id:"pointLabelsPlugin",afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=r.ctx,a=(t=r.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((s,n)=>{const l=r.getDatasetMeta(n);if(!l||l.hidden||!s.data||!Array.isArray(s.data))return;const c=Array.isArray(s.pointBackgroundColor)?s.pointBackgroundColor[0]||"#6b7280":s.pointBackgroundColor||"#6b7280";s.data.forEach((o,u)=>{const f=l.data[u];if(!f||typeof f.x!="number"||typeof f.y!="number"||o==null||isNaN(o))return;const p=f._jitteredX!==void 0?f._jitteredX:f.x,d=f._jitteredY!==void 0?f._jitteredY:f.y,g=p+8,D=d-5,y=String(Math.round(o));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const S=e.measureText(y).width,A=11,z=3,Q=g-z,te=D-A/2-z,B=S+z*2,P=A+z*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Q,te,B,P),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Q,te,B,P),e.fillStyle=c,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(y,g,D)}catch(k){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${n}_${u}:`,k)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},yn={class:"graph-state-chart"},kn={class:"chart-header"},wn={class:"chart-type-selector"},bn=["onClick","title"],Sn={class:"chart-type-icon"},Dn={class:"chart-type-label"},En={key:0,class:"comparison-type-selector"},_n={class:"radio-group"},Cn={key:0},Tn={key:1},An={key:2,class:"graph-legend"},In={key:4,class:"error-container"},$n={class:"error-message"},Mn={class:"chart-wrapper"},Nn={class:"chart-canvas-container"},Rn={key:0,class:"bar-chart-stage-labels"},Fn={key:6,class:"no-data"},xn={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(r,{emit:t}){const e=(C,v)=>typeof window>"u"?v:getComputedStyle(document.documentElement).getPropertyValue(C).trim()||v,a=r,s=t,n=N(!1),l=N(null),c=N(null),o=N({weekStart:null,weekEnd:null,current:null}),u=N(null),f=N("weekStartToWeekEnd"),p=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=N("line"),g=N(!1),D=N(""),y=N(""),k=N(0),S=N([]),A=N(null),z=N(null),Q=N(null),te=N(null),B=N([]),P=ee(()=>{switch(d.value){case"line":return It;case"bar":return Jt;case"doughnut":return Xt;default:return It}}),G={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},X=[{id:"formed",name:"Сформировано обращение",color:G.formed},{id:"review",name:"Рассмотрение ТЗ",color:G.review},{id:"execution",name:"Исполнение",color:G.execution}],ce=ee(()=>X.reduce((C,v)=>(C[v.id]=v.name,C),{})),ue=["circle","triangle","rect","rectRot","star","cross","crossRot"],$e=N({formed:!0,review:!0,execution:!0}),we=Ze(),Ve={id:"employeeLabelsPlugin",afterDatasetsDraw:C=>{if(C.config.type==="bar")try{const v=C.ctx;if(!C.data||!C.data.datasets)return;const _=C.data.datasets,m=C.scales.y;_.forEach((I,O)=>{const R=C.getDatasetMeta(O);if(!R||R.hidden)return;const V=I.label||"";if(!V||V.includes("Другие"))return;const U=V.trim().split(/\s+/);let j="";if(U.length===1)j=U[0];else{const x=U[0],J=U.slice(1).join(" ");j=`${x}
${J}`}const $=j.split(`
`);I.data.forEach((x,J)=>{if(x===0||!x)return;const se=R.data[J];if(!se||typeof se.x!="number"||typeof se.y!="number")return;const ge=se.x,Re=se.y+se.height+25;v.save(),v.font="bold 9px Arial, sans-serif",v.fillStyle="#6b7280",v.textAlign="center",v.textBaseline="top",v.translate(ge,Re),v.rotate(-12*Math.PI/180),$.forEach((De,Fe)=>{const xe=De.trim();xe&&v.fillText(xe,0,Fe*11)}),v.restore()})})}catch(v){console.error("Error in employeeLabelsPlugin:",v)}}};Qe.register(Ve);function ke(){const C=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(v=>{!v||!v.statistics||!v.statistics.employees||v.statistics.employees.forEach(_=>{C.has(_.id)||C.set(_.id,{id:_.id,name:_.name})})}),B.value=Array.from(C.values()).sort((v,_)=>v.name.localeCompare(_.name))}function he(C,v="background"){var m;return((m={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[C])==null?void 0:m[v])||e("--b24-text-secondary","#6c757d")}function Pe(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const C=ut.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let v=null,_=null;o.value.current&&(v=ut.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),_=ut.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:C,weekEndToCurrent:v,weekStartToCurrent:_}}catch(C){console.error("Ошибка сравнения слепков:",C),we.warning("Не удалось выполнить сравнение слепков: "+C.message)}}function be(C){return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[C]||"formed"}function Le(C){return be(C)}function Ge(C){return C===0?"weekStart":C===1?"weekEnd":C===2?"current":"weekEnd"}function Me(C){return o.value[C]||null}function ve(C,v,_,m,I=null,O=null,R=null,V=null){var U;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:C,stageId:v,totalCount:_,employeesCount:(m==null?void 0:m.length)||0,hasSnapshot:!!O,snapshotTicketIds:((U=O==null?void 0:O.ticketIds)==null?void 0:U.length)||0}),D.value=C,y.value=v||"",k.value=_,S.value=m||[],A.value=I&&I.count>0?I:null,z.value=O,Q.value=R,te.value=V,g.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:y.value,hasCurrentSnapshot:!!z.value})}function L(C,v,_){var U,j,$,x,J,se;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:C,timePoint:v,employeeDataCount:_==null?void 0:_.length});const m=X.find(ge=>ge.id===C);if(!m){console.warn("[GraphStateChart] Stage not found:",C);return}const I=Me(v);if(console.log("[GraphStateChart] Snapshot for timePoint:",v,I?"found":"not found"),!I){console.warn("[GraphStateChart] Snapshot not found for timePoint:",v),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!o.value.weekStart,weekEnd:!!o.value.weekEnd,current:!!o.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!I.tickets,ticketsIsArray:Array.isArray(I.tickets),ticketsLength:((U=I.tickets)==null?void 0:U.length)||0,hasTicketIds:!!I.ticketIds,ticketIdsLength:((j=I.ticketIds)==null?void 0:j.length)||0,hasMetadata:!!I.metadata,hasStatistics:!!I.statistics,snapshotKeys:Object.keys(I),snapshotType:typeof I}),!I.tickets||!Array.isArray(I.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",I),we.warning("Слепок не содержит данных о тикетах");return}const O=((J=(x=($=I.statistics)==null?void 0:$.stages)==null?void 0:x[C])==null?void 0:J.count)||0;console.log("[GraphStateChart] Total count for stage:",O);const R=Ke(_,O,m.color,10),V={graphType:"line",stageId:C,stageName:m.name,timePoint:v,snapshots:o.value,meta:{line:dataset.meta},stageColorMap:G,stageNameMap:ce.value};console.log("[GraphStateChart] Opening modal with:",{stageName:m.name,stageId:C,totalCount:O,employeesCount:((se=R.employees)==null?void 0:se.length)||0,hasSnapshot:!!I,snapshotHasTickets:!!I.tickets}),ve(m.name,C,O,R.employees,R.others,I,null,V)}function Y(C,v){var I,O,R;if(!v||!v.employees||v.employees.length===0){we.warning("Нет данных о сотрудниках для этого этапа");return}const _=o.value.current||o.value.weekEnd||o.value.weekStart,m={graphType:"doughnut",stageId:C,stageName:v.stageName,snapshots:o.value,meta:{doughnut:((R=(O=(I=c.value)==null?void 0:I.datasets)==null?void 0:O[0])==null?void 0:R.meta)||null},stageColorMap:G,stageNameMap:ce.value};ve(v.stageName,C,v.totalCount,v.employees,v.others,_,null,m)}function ye(){g.value=!1,D.value="",y.value="",k.value=0,S.value=[],A.value=null,z.value=null,Q.value=null}function Ne(C,v,_){var $,x;if(d.value!=="line"||v.length===0)return;const m=v[0],I=m.datasetIndex,O=m.index,R=_.data.datasets[I];if(!R||!R.meta)return;const V=Le(R.label),U=Ge(O),j=(x=($=R.meta)==null?void 0:$.employees)==null?void 0:x[U];!j||j.length===0||L(V,U,j)}function h(C,v,_){var $,x;if(d.value!=="doughnut"||v.length===0)return;const I=v[0].index,O=_.data,R=O.labels[I],V=Le(R),U=(x=($=O.datasets[0])==null?void 0:$.meta)==null?void 0:x.employees,j=U==null?void 0:U[V];if(!j){console.warn("Данные о сотрудниках не найдены для этапа:",V);return}Y(V,j)}function b(C){var m;const v=X[C];if(!v)return 0;const _=o.value.current||o.value.weekEnd||o.value.weekStart;return!_||!_.statistics||!_.statistics.stages?0:((m=_.statistics.stages[v.id])==null?void 0:m.count)||0}function w(C){var I;const v=X.find(O=>O.id===C);if(!v)return"";const _=o.value.current||o.value.weekEnd||o.value.weekStart;if(!_||!_.statistics||!_.statistics.stages)return v.name;const m=((I=_.statistics.stages[C])==null?void 0:I.count)||0;return`${v.name} (${m})`}const M=ee(()=>{if(!c.value)return null;if(d.value==="doughnut"||d.value==="bar")return c.value;const C=c.value.datasets.filter(v=>{const _=X.find(m=>m.name===v.label);return _?$e.value[_.id]:!0});return{...c.value,datasets:C}});ee(()=>d.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const K=ee(()=>{const C={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(v,_,m)=>{d.value==="line"?Ne(v,_,m):d.value==="doughnut"&&h(v,_,m)},onHover:(v,_,m)=>{d.value==="doughnut"&&(v.native.target.style.cursor=_.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",onClick:(v,_,m)=>{if(d.value==="bar"){const O=_.datasetIndex;if(O!==void 0){const R=m.chart.getDatasetMeta(O);R.hidden=!R.hidden,m.chart.update()}return}const I=_.datasetIndex;if(I!==void 0){const O=m.chart.getDatasetMeta(I);O.hidden=!O.hidden,m.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:v=>{if(d.value==="bar"){const _=v[0].dataIndex,m=X[_];return m?m.name:""}return v[0].label||""},label:v=>{var O,R,V,U,j,$;const _=v.dataset.label||"",m=v.parsed.y||v.parsed||0,I=v.dataIndex;if(d.value==="bar"){const x=v.dataset,J=v.dataIndex,se=X[J],ge=se?se.name:"";return`${x.label}: ${m} тикетов на этапе "${ge}"`}if(d.value==="doughnut"){const x=v.dataset.data.reduce((se,ge)=>se+ge,0),J=x>0?(m/x*100).toFixed(1):0;return`${_}: ${m} тикетов (${J}%)`}else{if(!u.value||I===0)return`${_}: ${m} тикетов`;let x=null;const J=be(_);if(f.value==="weekStartToWeekEnd"&&I===1?x=(R=(O=u.value.weekStartToWeekEnd)==null?void 0:O.stages)==null?void 0:R[J]:f.value==="weekEndToCurrent"&&I===2&&o.value.current?x=(U=(V=u.value.weekEndToCurrent)==null?void 0:V.stages)==null?void 0:U[J]:f.value==="weekStartToCurrent"&&I===2&&o.value.current&&(x=($=(j=u.value.weekStartToCurrent)==null?void 0:j.stages)==null?void 0:$[J]),!x)return`${_}: ${m} тикетов`;const se=x.delta,ge=x.deltaPercent,Re=x.trend;let De=`${_}: ${m} тикетов`;if(se!==0){const Fe=se>0?"+":"",xe=Re==="increase"?"↑":Re==="decrease"?"↓":"→";De+=` (${Fe}${se}, ${Fe}${ge.toFixed(1)}%) ${xe}`}else De+=" (без изменений)";return De}},afterBody:v=>{if(d.value==="bar"&&v.length>0){const O=v[0];O.dataset;const R=O.parsed.y||0,V=O.dataIndex,U=b(V);return[`${U>0?(R/U*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&v.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const O=[];if(u.value){const R=v[0].dataIndex;if(R!==0){let V=null;if(be(v[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&R===1?V=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&R===2?V=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&R===2&&(V=u.value.weekStartToCurrent),V&&V.metadata){const U=V.metadata.timeDiff;O.push(`Период: ${U.days} дн. ${U.hours} ч. ${U.minutes} мин.`)}}}return O.push("Кликните для детализации по сотрудникам"),O}if(!u.value)return[];const _=v[0].dataIndex;if(_===0)return[];let m=null;if(be(v[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&_===1?m=u.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&_===2?m=u.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&_===2&&(m=u.value.weekStartToCurrent),!m||!m.metadata)return[];const I=m.metadata.timeDiff;return[`Период: ${I.days} дн. ${I.hours} ч. ${I.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...C,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...C,cutout:"60%"}:C});function W(C){const v=new Date(C),_=v.getFullYear(),m=String(v.getMonth()+1).padStart(2,"0"),I=String(v.getDate()).padStart(2,"0");return`${_}-${m}-${I}`}function ae(C){const{current:v,weekEnd:_}=C,m=v||_;if(!m||!m.statistics||!m.statistics.stages)return null;const I=[],O=[],R=[],V=[],U={};return X.forEach(j=>{var x;const $=((x=m.statistics.stages[j.id])==null?void 0:x.count)||0;if($>0){I.push(j.name),O.push($),R.push(j.color+"80"),V.push(j.color);const J=ya(j.id,m,X);J&&J.employees&&(U[j.id]=J)}}),O.length===0?null:{labels:I,datasets:[{label:"Распределение по этапам",data:O,backgroundColor:R,borderColor:V,borderWidth:2,meta:{employees:U}}]}}function Se(C){if(d.value==="doughnut")return ae(C);if(d.value==="bar"){const R=a.showCurrentState&&C.current?"current":C.weekEnd?"weekEnd":"weekStart";return va(C,R,X)}const{weekStart:v,weekEnd:_,current:m}=C,I=[],O=[];return X.forEach((R,V)=>{var ge,Re,De,Fe,xe,ht,vt,yt,kt,wt,bt,St,Dt,Et,_t,Ct,Tt;const U=[];if(v&&v.statistics&&v.statistics.stages){const le=v.statistics.stages[R.id];if(I.length===0){const Ye=(ge=v.metadata)!=null&&ge.createdAt?new Date(v.metadata.createdAt):null;I.push(Ye?W(Ye):"Начало недели")}U.push((le==null?void 0:le.count)||0)}else I.length===0&&I.push("Начало недели"),U.push(0);if(_&&_.statistics&&_.statistics.stages){const le=_.statistics.stages[R.id];if(I.length===1){const Ye=(Re=_.metadata)!=null&&Re.createdAt?new Date(_.metadata.createdAt):null;I.push(Ye?W(Ye):"Конец недели")}U.push((le==null?void 0:le.count)||0)}else I.length===1&&I.push("Конец недели"),U.push(0);if(m&&a.showCurrentState&&m.statistics&&m.statistics.stages){const le=m.statistics.stages[R.id];I.length===2&&I.push("Текущее состояние"),U.push((le==null?void 0:le.count)||0)}const j=["stable"];u.value?f.value==="weekStartToWeekEnd"?(j.push(((xe=(Fe=(De=u.value.weekStartToWeekEnd)==null?void 0:De.stages)==null?void 0:Fe[R.id])==null?void 0:xe.trend)||"stable"),m&&j.push(((yt=(vt=(ht=u.value.weekStartToCurrent)==null?void 0:ht.stages)==null?void 0:vt[R.id])==null?void 0:yt.trend)||"stable")):f.value==="weekEndToCurrent"&&m?(j.push("stable"),j.push(((bt=(wt=(kt=u.value.weekEndToCurrent)==null?void 0:kt.stages)==null?void 0:wt[R.id])==null?void 0:bt.trend)||"stable")):f.value==="weekStartToCurrent"&&m?(j.push(((Et=(Dt=(St=u.value.weekStartToWeekEnd)==null?void 0:St.stages)==null?void 0:Dt[R.id])==null?void 0:Et.trend)||"stable"),j.push(((Tt=(Ct=(_t=u.value.weekStartToCurrent)==null?void 0:_t.stages)==null?void 0:Ct[R.id])==null?void 0:Tt.trend)||"stable")):(j.push("stable"),m&&j.push("stable")):(j.push("stable"),m&&j.push("stable"));let $,x,J;u.value&&d.value!=="doughnut"?($=j.map(le=>he(le,"background")+"40"),x=j.map(le=>he(le,"border")),J=j.map(le=>he(le,"point"))):($=R.color+"40",x=R.color,J=R.color);let se=null;d.value==="line"&&(se={employees:ha(R.id,C)}),O.push({label:R.name,data:U,backgroundColor:(Array.isArray($),$),borderColor:(Array.isArray(x),x),borderWidth:2,...d.value==="line"&&{pointStyle:ue[V%ue.length]},pointBackgroundColor:(Array.isArray(J),J),pointBorderColor:(Array.isArray(x),x),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:se})}),I.length===0&&(I.push("Начало недели","Конец недели"),a.showCurrentState&&I.push("Текущее состояние")),{labels:I,datasets:O}}const F=async()=>{var C,v,_;n.value=!0,l.value=null;try{const m=(C=a.period)!=null&&C.endDate?new Date(a.period.endDate):new Date,I=(v=a.period)!=null&&v.startDate?new Date(a.period.startDate):Ce.getWeekStartDate(m),O=(_=a.period)!=null&&_.endDate?new Date(a.period.endDate):Ce.getWeekEndDate(m),R=Ce.formatDate(I),V=Ce.formatDate(O),[U,j]=await Promise.all([Ce.getSnapshot(R,"week_start"),Ce.getSnapshot(V,"week_end")]);let $=null;a.showCurrentState&&($=await gt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:U,weekEnd:j,current:$},ke(),Pe(),re(),s("data-loaded",{weekStart:U,weekEnd:j,current:$})}catch(m){console.error("Error loading chart data:",m),l.value=m.message||"Ошибка загрузки данных графика",we.error("Ошибка загрузки данных графика: "+l.value),s("error",l.value)}finally{n.value=!1}};Oe(()=>{Qe.register(fn),Qe.register(hn),Qe.register(vn),F()});function q(C){$e.value=C}const re=()=>{var v;const C=Se({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==((v=C==null?void 0:C.labels)==null?void 0:v.length))c.value=C;else if(C){const _=JSON.stringify(c.value),m=JSON.stringify(C);_!==m&&(c.value=C)}};return Ue(()=>[a.period,a.showCurrentState],()=>{F()},{deep:!0}),Ue(d,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&re()}),Ue(f,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&re()}),(C,v)=>(E(),T("div",yn,[i("div",kn,[v[3]||(v[3]=i("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),i("div",wn,[(E(),T(de,null,pe(p,_=>i("button",{key:_.value,onClick:m=>d.value=_.value,class:oe(["chart-type-btn",{active:d.value===_.value}]),title:_.label},[i("span",Sn,H(_.icon),1),i("span",Dn,H(_.label),1)],10,bn)),64))])]),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(E(),T("div",En,[v[7]||(v[7]=i("h4",{class:"comparison-title"},"Тип сравнения:",-1)),i("div",_n,[i("label",null,[tt(i("input",{type:"radio","onUpdate:modelValue":v[0]||(v[0]=_=>f.value=_),value:"weekStartToWeekEnd",onChange:re},null,544),[[rt,f.value]]),v[4]||(v[4]=i("span",null,"Начало недели → Конец недели",-1))]),o.value.current?(E(),T("label",Cn,[tt(i("input",{type:"radio","onUpdate:modelValue":v[1]||(v[1]=_=>f.value=_),value:"weekEndToCurrent",onChange:re},null,544),[[rt,f.value]]),v[5]||(v[5]=i("span",null,"Конец недели → Текущее состояние",-1))])):Z("",!0),o.value.current?(E(),T("label",Tn,[tt(i("input",{type:"radio","onUpdate:modelValue":v[2]||(v[2]=_=>f.value=_),value:"weekStartToCurrent",onChange:re},null,544),[[rt,f.value]]),v[6]||(v[6]=i("span",null,"Начало недели → Текущее состояние",-1))])):Z("",!0)])])):Z("",!0),!n.value&&!l.value&&c.value?(E(),Ae(pa,{key:1,stages:X,selected:$e.value,"onUpdate:selected":q,onChange:re},null,8,["selected"])):Z("",!0),!n.value&&!l.value&&u.value&&d.value!=="doughnut"?(E(),T("div",An,[...v[8]||(v[8]=[Ut('<h4 class="legend-title" data-v-3ee1103a>Легенда:</h4><div class="legend-items" data-v-3ee1103a><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-increase" data-v-3ee1103a></span><span data-v-3ee1103a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-decrease" data-v-3ee1103a></span><span data-v-3ee1103a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-3ee1103a><span class="legend-color legend-stable" data-v-3ee1103a></span><span data-v-3ee1103a>Серый — без изменений</span></div></div>',2)])])):Z("",!0),n.value?(E(),Ae(Pt,{key:3,message:"Загрузка данных графика..."})):l.value?(E(),T("div",In,[i("p",$n,"❌ "+H(l.value),1),i("button",{onClick:F,class:"btn-retry"},"Повторить загрузку")])):M.value?(E(),T("div",{key:5,class:oe(["chart-container",`chart-type-${d.value}`])},[i("div",Mn,[i("div",Nn,[(E(),Ae(zt(P.value),{data:M.value,options:K.value},null,8,["data","options"]))]),d.value==="bar"?(E(),T("div",Rn,[(E(),T(de,null,pe(X,_=>i("div",{key:_.id,class:"stage-label-item"},H(w(_.id)),1)),64))])):Z("",!0)])],2)):(E(),T("div",Fn,[...v[9]||(v[9]=[i("p",null,"📊 Нет данных для отображения",-1),i("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ie(sn,{"is-visible":g.value,"stage-name":D.value,"stage-id":y.value,"total-count":k.value,employees:S.value,others:A.value,snapshot:z.value,"ticket-details":Q.value,"stage-switch-context":te.value,onClose:ye},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},Hn=Ie(xn,[["__scopeId","data-v-3ee1103a"]]),On={key:0,class:"create-snapshot-button-container"},Pn=["disabled"],Ln={class:"modal-content"},Bn={class:"modal-header"},jn=["disabled"],Wn={class:"modal-body"},Un={key:0,class:"progress-container"},zn={class:"progress-bar-wrapper"},Kn={class:"progress-text"},Vn={class:"progress-percent"},Gn={class:"progress-description"},Yn={key:1},qn={class:"modal-footer"},Xn=["disabled"],Jn=["disabled"],Zn={key:0},Qn={key:0},eo={key:1},to={key:2},ao={key:1},so={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(r,{emit:t}){const e=r,a=t,s=N(e.user),n=N(!1),l=N(!1),c=N(0),o=N("idle"),u=N(""),f=Ze(),p=ee(()=>s.value?Kt(s.value):!1);Oe(async()=>{if(!e.user)try{const k=await Lt.checkAccess();k.allowed&&(s.value=k.user)}catch(k){console.error("Error loading user:",k)}});const d=()=>{if(!p.value){f.warning("Только администраторы могут создавать слепки");return}n.value=!0},g=()=>{l.value||(n.value=!1,o.value="idle",c.value=0,u.value="")},D=async()=>{if(!l.value){if(!p.value){f.warning("Только администраторы могут создавать слепки");return}l.value=!0,o.value="loading_data",c.value=0,u.value="Инициализация загрузки данных...";try{u.value="Загрузка данных сектора из Bitrix24...";const k=await gt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:z=>{var te;const Q=Math.min(80,(z.progress||0)*.8);c.value=Q,o.value="loading_data",u.value=z.description||((te=z.details)==null?void 0:te.description)||"Загрузка данных сектора..."}});o.value="creating_snapshot",c.value=85,u.value="Создание слепка...";const S=s.value;if(!S)throw new Error("Пользователь не определён");const A=await Ce.createSnapshot(k,"manual",{createdBy:{id:S.ID,name:`${S.NAME||""} ${S.LAST_NAME||""}`.trim()||S.EMAIL||`User ${S.ID}`},sectorId:"1C"});o.value="success",c.value=100,u.value="Слепок успешно создан!",f.success("Слепок состояния сектора успешно создан"),a("snapshot-created",A),setTimeout(()=>{g()},1500)}catch(k){o.value="error",c.value=0,u.value="Ошибка создания слепка",console.error("Error creating snapshot:",k);let S="Ошибка создания слепка";k.message&&(k.message.includes("загрузки данных")||k.message.includes("sector data")?S="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":k.message.includes("создания слепка")||k.message.includes("snapshot")?S="Не удалось создать слепок. Обратитесь в поддержку.":k.message.includes("валидац")||k.message.includes("validation")?S="Ошибка валидации данных. Проверьте данные сектора.":S=k.message),f.error(S)}finally{l.value=!1}}},y=k=>{k.key==="Escape"&&n.value&&!l.value&&g()};return Oe(()=>{window.addEventListener("keydown",y)}),lt(()=>{window.removeEventListener("keydown",y)}),(k,S)=>p.value?(E(),T("div",On,[i("button",{class:"create-snapshot-btn",onClick:d,disabled:l.value,title:"Создать слепок состояния сектора"},[...S[1]||(S[1]=[i("span",{class:"btn-icon"},"📸",-1),i("span",{class:"btn-text"},"Создать слепок",-1)])],8,Pn),(E(),Ae(Ot,{to:"body"},[ie(Je,{name:"modal"},{default:Te(()=>[n.value?(E(),T("div",{key:0,class:"modal-overlay",onClick:S[0]||(S[0]=ne(A=>!l.value&&g(),["self"]))},[i("div",Ln,[i("div",Bn,[S[2]||(S[2]=i("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),i("button",{class:"modal-close",onClick:g,disabled:l.value,"aria-label":"Закрыть"}," ✕ ",8,jn)]),i("div",Wn,[o.value!=="idle"?(E(),T("div",Un,[i("div",zn,[i("div",{class:"progress-bar",style:me({width:`${c.value}%`})},null,4)]),i("div",Kn,[i("span",Vn,H(Math.round(c.value))+"%",1),i("span",Gn,H(u.value),1)])])):(E(),T("div",Yn,[...S[3]||(S[3]=[i("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),i("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),i("div",qn,[i("button",{class:"btn btn-secondary",onClick:g,disabled:l.value}," Отмена ",8,Xn),i("button",{class:"btn btn-primary",onClick:D,disabled:l.value},[l.value?(E(),T("span",Zn,[o.value==="loading_data"?(E(),T("span",Qn,"Загрузка данных...")):o.value==="creating_snapshot"?(E(),T("span",eo,"Создание...")):(E(),T("span",to,"Обработка..."))])):(E(),T("span",ao,"Создать"))],8,Jn)])])])):Z("",!0)]),_:1})]))])):Z("",!0)}},no=Ie(so,[["__scopeId","data-v-09bccee2"]]),oo=20,lo=5*60*1e3;async function ro({search:r="",limit:t=oo,sectorDepartmentId:e=Ft.SECTOR_1C}={}){const a=`sector1c_employees_${r}_${t}_${e||"all"}`,s=sessionStorage.getItem(a);if(s)try{const{data:n,timestamp:l}=JSON.parse(s);if(Date.now()-l<lo)return n}catch(n){console.warn("[sector1cEmployees] Cache parse error:",n)}try{const n={ACTIVE:"Y"};e?Array.isArray(e)?n.UF_DEPARTMENT=e:n.UF_DEPARTMENT=[e]:n.UF_DEPARTMENT=[Ft.SECTOR_1C],r&&r.length>=2&&(n["%NAME"]=r,n["%LAST_NAME"]=r,n["%WORK_POSITION"]=r);const o=((await pt.call("user.get",{filter:n,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:io(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:o,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return o}catch(n){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",n),new Error(`Не удалось загрузить сотрудников: ${n.message}`)}}function io(r){const t=[r.LAST_NAME,r.NAME,r.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):r.NAME||"Без имени"}const co={class:"employee-select-field-text"},uo={key:0,class:"employee-select-dropdown"},po={class:"employee-select-dropdown-search"},go={key:0,class:"employee-select-state"},fo={key:1,class:"employee-select-state employee-select-state--error"},mo={key:2,class:"employee-select-state"},ho=["checked"],vo=["checked","onChange"],yo={class:"employee-select-item-content"},ko={class:"employee-select-item-name"},wo={key:0,class:"employee-select-item-position"},bo={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(null),l=N(""),c=N([]),o=N(!1),u=N(null),f=N(!1),p=ee(()=>{if(!l.value)return c.value;const B=l.value.toLowerCase();return c.value.filter(P=>P.name.toLowerCase().includes(B)||P.position&&P.position.toLowerCase().includes(B))}),d=ee(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const B=c.value.find(P=>P.id===e.selected[0]);return B?B.name:e.placeholder}return`Выбрано: ${e.selected.length} ${Q(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function g(B=""){o.value=!0,u.value=null;try{c.value=await ro({search:B})}catch(P){u.value=P,a("error",P)}finally{o.value=!1}}function D(){a("search",l.value)}function y(){o.value||(f.value=!f.value,f.value?(c.value.length===0&&g(),Gt(()=>{n.value&&n.value.focus()})):l.value="")}function k(B){s.value&&!s.value.contains(B.target)&&(f.value=!1,l.value="")}function S(B){const P=[...e.selected],G=P.indexOf(B);if(B==="all")if(G>-1)P.splice(G,1);else return a("update:selected",["all"]);else if(G>-1)P.splice(G,1);else{const X=P.indexOf("all");X>-1&&P.splice(X,1),P.push(B)}a("update:selected",P)}function A(B){return B==="all"?e.selected.includes("all"):e.selected.includes(B)||e.selected.includes("all")}const z=ee(()=>l.value?`Нет сотрудников по запросу "${l.value}"`:"Нет сотрудников сектора 1С");function Q(B,P,G,X){const ce=B%10,ue=B%100;return ue>=11&&ue<=19?X:ce===1?P:ce>=2&&ce<=4?G:X}function te(){g(l.value)}return Ue(()=>e.selected,B=>{(!B||B.length===0)&&a("update:selected",["all"])},{immediate:!0}),Oe(()=>{document.addEventListener("click",k),(!e.selected||e.selected.length===0)&&a("update:selected",["all"])}),lt(()=>{document.removeEventListener("click",k)}),(B,P)=>(E(),T("div",{class:"employee-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["employee-select-field",{"employee-select-field--open":f.value,"employee-select-field--disabled":o.value}]),onClick:y},[i("span",co,H(d.value),1),i("span",{class:oe(["employee-select-field-icon",{open:f.value}])},"▼",2)],2),ie(Je,{name:"dropdown-fade"},{default:Te(()=>[f.value?(E(),T("div",uo,[i("div",po,[tt(i("input",{"onUpdate:modelValue":P[0]||(P[0]=G=>l.value=G),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:D,onClick:P[1]||(P[1]=ne(()=>{},["stop"])),ref_key:"searchInput",ref:n},null,544),[[Vt,l.value]])]),o.value?(E(),T("div",go,[...P[6]||(P[6]=[i("span",{class:"spinner"},"⏳",-1),i("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):u.value?(E(),T("div",fo,[i("span",null,"❌ "+H(u.value.message||"Ошибка загрузки сотрудников"),1),i("button",{onClick:[te,P[2]||(P[2]=ne(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!o.value&&p.value.length===0&&!u.value?(E(),T("div",mo,[i("span",null,"📭 "+H(z.value),1)])):(E(),T("div",{key:3,class:"employee-select-list",style:me({maxHeight:`${r.maxHeight}px`})},[i("label",{class:oe(["employee-select-item",{"employee-select-item--selected":A("all")}]),onClick:P[4]||(P[4]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:A("all"),onChange:P[3]||(P[3]=G=>S("all"))},null,40,ho),P[7]||(P[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(E(!0),T(de,null,pe(p.value,G=>(E(),T("label",{key:G.id,class:oe(["employee-select-item",{"employee-select-item--selected":A(G.id)}]),onClick:P[5]||(P[5]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:A(G.id),onChange:X=>S(G.id)},null,40,vo),i("div",yo,[i("span",ko,H(G.name),1),G.position?(E(),T("span",wo,H(G.position),1)):Z("",!0)])],2))),128))],4))])):Z("",!0)]),_:1})],512))}},So=Ie(bo,[["__scopeId","data-v-6b8c949b"]]),Do={class:"stage-select-field-text"},Eo={key:0,class:"stage-select-dropdown"},_o={class:"stage-select-list"},Co=["checked"],To=["checked","onChange"],Ao={class:"stage-select-item-content"},Io={class:"stage-select-item-name"},$o={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,a=t,s=N(null),n=N(!1),l=ee(()=>Object.values(e.selected).every(d=>d===!0)),c=ee(()=>{if(l.value)return e.placeholder;const d=e.stages.filter(g=>e.selected[g.id]);return d.length===0?"Этапы не выбраны":d.length===1?d[0].name:`Выбрано: ${d.length} этапа(ов)`});function o(){n.value=!n.value,n.value}function u(d){s.value&&!s.value.contains(d.target)&&(n.value=!1)}function f(d,g){const D={...e.selected};D[d]=g,a("update:selected",D),a("change",d,g)}function p(){const d=l.value,g={};e.stages.forEach(D=>{g[D.id]=!d}),a("update:selected",g),a("change","all",!d)}return Oe(()=>{document.addEventListener("click",u)}),lt(()=>{document.removeEventListener("click",u)}),(d,g)=>(E(),T("div",{class:"stage-select",ref_key:"selectContainer",ref:s},[i("div",{class:oe(["stage-select-field",{"stage-select-field--open":n.value,"stage-select-field--disabled":!1}]),onClick:o},[i("span",Do,H(c.value),1),i("span",{class:oe(["stage-select-field-icon",{open:n.value}])},"▼",2)],2),ie(Je,{name:"dropdown-fade"},{default:Te(()=>[n.value?(E(),T("div",Eo,[i("div",_o,[i("label",{class:oe(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:g[0]||(g[0]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:l.value,onChange:p},null,40,Co),g[2]||(g[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(E(!0),T(de,null,pe(r.stages,D=>(E(),T("label",{key:D.id,class:oe(["stage-select-item",{"stage-select-item--selected":r.selected[D.id]}]),onClick:g[1]||(g[1]=ne(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:r.selected[D.id],onChange:y=>f(D.id,y.target.checked)},null,40,To),i("div",Ao,[i("span",{class:"stage-select-item-color",style:me({backgroundColor:D.color})},null,4),i("span",Io,H(D.name),1)])],2))),128))])])):Z("",!0)]),_:1})],512))}},Mo=Ie($o,[["__scopeId","data-v-ce2229b2"]]),No={class:"filters-panel"},Ro={class:"filters-header"},Fo=["disabled"],xo={class:"filters-content"},Ho={class:"filter-section"},Oo={class:"section-content"},Po={class:"filter-section"},Lo={class:"section-content"},Bo={class:"filter-section"},jo={class:"section-content"},Wo=["value"],Uo={key:0,class:"custom-date-range"},zo={class:"date-range-inputs"},Ko={class:"date-input-group"},Vo=["value","max"],Go={class:"date-input-group"},Yo=["value","min","max"],qo={key:0,class:"filter-error"},Xo={key:1,class:"filter-hint"},Jo={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(r,{emit:t}){const e=r,a=t,s=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],n=N(null),l=ee(()=>{const D=new Date;return D.setFullYear(D.getFullYear()-1),D.toISOString().split("T")[0]}),c=ee(()=>new Date().toISOString().split("T")[0]);function o(D){a("update:stages",D),a("apply")}function u(D,y){a("apply")}function f(D){a("update:employees",D),a("apply")}function p(D){a("update:dateRange",D),n.value=null,a("apply")}function d(D,y){const k={...e.customDateRange};if(k[D]=y,k.startDate&&k.endDate){const S=new Date(k.startDate),A=new Date(k.endDate);if(S>A){n.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((A-S)/(1e3*60*60*24))>365){n.value="Период не может превышать 365 дней";return}}n.value=null,a("update:customDateRange",k),a("apply")}function g(){n.value=null,a("reset")}return(D,y)=>(E(),T("div",No,[i("div",Ro,[y[3]||(y[3]=i("h2",null,"Фильтры",-1)),i("button",{onClick:g,class:"btn-reset-filters",disabled:!r.hasActiveFilters}," Сбросить фильтры ",8,Fo)]),i("div",xo,[i("div",Ho,[y[4]||(y[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📊"),at(" Этапы ")],-1)),i("div",Oo,[ie(Mo,{selected:r.stages,stages:s,placeholder:"Выберите этапы","onUpdate:selected":o,onChange:u},null,8,["selected"])])]),i("div",Po,[y[5]||(y[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"👥"),at(" Сотрудники сектора 1С ")],-1)),i("div",Lo,[ie(So,{selected:r.employees,"onUpdate:selected":f},null,8,["selected"])])]),i("div",Bo,[y[9]||(y[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📅"),at(" Период ")],-1)),i("div",jo,[i("select",{value:r.dateRange,onChange:y[0]||(y[0]=k=>p(k.target.value)),class:"date-range-select"},[...y[6]||(y[6]=[i("option",{value:"last-week"},"Последняя неделя",-1),i("option",{value:"last-2-weeks"},"Последние 2 недели",-1),i("option",{value:"last-month"},"Последний месяц",-1),i("option",{value:"custom"},"Произвольный период",-1)])],40,Wo),r.dateRange==="custom"?(E(),T("div",Uo,[i("div",zo,[i("div",Ko,[y[7]||(y[7]=i("label",null,"С:",-1)),i("input",{type:"date",value:r.customDateRange.startDate,onChange:y[1]||(y[1]=k=>d("startDate",k.target.value)),max:r.customDateRange.endDate||c.value,class:"date-input"},null,40,Vo)]),i("div",Go,[y[8]||(y[8]=i("label",null,"По:",-1)),i("input",{type:"date",value:r.customDateRange.endDate,onChange:y[2]||(y[2]=k=>d("endDate",k.target.value)),min:r.customDateRange.startDate||l.value,max:c.value,class:"date-input"},null,40,Yo)])]),n.value?(E(),T("small",qo,H(n.value),1)):(E(),T("small",Xo," Выберите начальную и конечную дату для отображения данных "))])):Z("",!0)])])])]))}},Zo=Ie(Jo,[["__scopeId","data-v-4b7456a2"]]);function Qo(){const r=N(!1),t=N(null),e=N(null),a=N(0),s=Ze(),n=async(k=!0,S=null)=>{r.value=!0,t.value=null,a.value=0;try{const A=await gt.getSectorDataForSnapshot({useCache:k,onProgress:z=>{z&&typeof z.progress=="number"&&(a.value=z.progress),S&&S(z)},normalize:!0});return e.value=A,A}catch(A){throw t.value=A.message||"Ошибка загрузки данных сектора",s.error("Ошибка загрузки данных сектора: "+t.value),A}finally{r.value=!1,a.value=100}},l=async(k,S={})=>{if(!e.value){const A="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=A,s.error(A),new Error(A)}r.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(k))throw new Error(`Неверный тип слепка: ${k}. Допустимые значения: week_start, week_end, manual, current`);const A=await Ce.createSnapshot(e.value,k,S);return s.success("Слепок успешно создан"),A}catch(A){throw t.value=A.message||"Ошибка создания слепка",s.error("Ошибка создания слепка: "+t.value),A}finally{r.value=!1}},c=()=>{r.value=!1,t.value=null,e.value=null,a.value=0},o=ee(()=>e.value!==null&&e.value!==void 0),u=N({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),f=ee(()=>{const k=new Date;let S,A;switch(u.value.dateRange){case"last-week":S=new Date(k),S.setDate(k.getDate()-7),A=k;break;case"last-2-weeks":S=new Date(k),S.setDate(k.getDate()-14),A=k;break;case"last-month":S=new Date(k),S.setMonth(k.getMonth()-1),A=k;break;case"custom":S=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,A=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:S=new Date(k),S.setDate(k.getDate()-7),A=k}return{startDate:S?S.toISOString().split("T")[0]:null,endDate:A?A.toISOString().split("T")[0]:null}}),p=()=>{g()},d=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},g()},g=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(k){console.error("Ошибка сохранения фильтров в localStorage:",k)}},D=()=>{try{const k=localStorage.getItem("graphStateFilters");if(k){const S=JSON.parse(k);S&&typeof S=="object"&&(u.value={stages:S.stages||{formed:!0,review:!0,execution:!0},employees:S.employees||["all"],dateRange:S.dateRange||"last-week",customDateRange:S.customDateRange||{startDate:null,endDate:null}})}}catch(k){console.error("Ошибка загрузки фильтров из localStorage:",k)}},y=ee(()=>{const k=Object.values(u.value.stages).some(z=>!z),S=!u.value.employees.includes("all"),A=u.value.dateRange!=="last-week";return k||S||A});return{isLoading:r,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:o,filters:u,selectedPeriod:f,hasActiveFilters:y,loadSectorDataForSnapshot:n,createSnapshot:l,resetState:c,applyFilters:p,resetFilters:d,saveFiltersToLocalStorage:g,loadFiltersFromLocalStorage:D}}const el={class:"graph-state-dashboard"},tl={key:1,class:"error-message-container"},al={class:"error-message"},sl={class:"error-text"},nl={key:0,class:"error-details"},ol={class:"dashboard-header"},ll={class:"header-content"},rl={class:"breadcrumbs-row"},il=["aria-disabled","data-fallback","disabled"],cl={class:"breadcrumbs","aria-label":"Навигация"},ul={class:"header-actions"},dl=["disabled"],pl={key:0},gl={key:1},fl={key:3,class:"dashboard-content"},ml={class:"chart-container"},hl="Назад",vl={__name:"GraphStateDashboard",setup(r){const t=(L,Y)=>typeof window>"u"?Y:getComputedStyle(document.documentElement).getPropertyValue(L).trim()||Y,e=Ze(),a=Yt(),s={name:"dashboard-sector-1c"},{filters:n,selectedPeriod:l,hasActiveFilters:c,applyFilters:o,resetFilters:u,loadFiltersFromLocalStorage:f}=Qo(),p=N(null),d=N(!0),g=N(!1),D=N("Загрузка данных..."),y=N(null),k=N(!1),S=N(!1),A=N(typeof window<"u"?window.innerWidth:1024),z=N(null),Q=N(!1),te=ee(()=>A.value<768);ee(()=>A.value>=768&&A.value<1024),ee(()=>A.value>=1024);const B=ee(()=>typeof window>"u"?!1:window.history.length>1);ee(()=>{const L=new Date;return L.setFullYear(L.getFullYear()-1),L.toISOString().split("T")[0]}),ee(()=>new Date().toISOString().split("T")[0]);function P(L){n.value.stages=L}function G(L){n.value.employees=L}function X(L){n.value.dateRange=L}function ce(L){n.value.customDateRange=L}function ue(){o()}function $e(){u(),z.value=null,ue(),e.info("Фильтры сброшены")}function we(L){e.success("Слепок успешно создан")}function Ve(L){g.value=!1,D.value="",console.log("Данные графика загружены:",L)}function ke(L){g.value=!1,he({message:L||"Ошибка загрузки графика",details:null,type:"error"})}function he(L){y.value={message:L.message||"Произошла ошибка",details:L.details||null,type:L.type||"error",timestamp:new Date},console.error("Dashboard error:",y.value),e.error(y.value.message)}function Pe(){y.value=null}function be(){y.value=null,g.value=!0,D.value="Повторная загрузка данных..."}async function Le(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}k.value=!0;try{const L=document.querySelector(".chart-container");if(!L)throw new Error("График не найден");const Y=window.html2canvas,ye=await Y(L,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Ne=window.jsPDF,h=new Ne("landscape","mm","a4"),b=297,w=ye.height*b/ye.width;h.setFontSize(18),h.text("График состояния сектора 1С",148.5,15,{align:"center"});const M=new Date().toLocaleDateString("ru-RU");h.setFontSize(10);const K=l.value.startDate&&l.value.endDate?`Период: ${l.value.startDate} - ${l.value.endDate}`:"Период: не указан";h.text(K,148.5,25,{align:"center"}),h.text(`Экспорт от ${M}`,148.5,30,{align:"center"}),h.addImage(ye.toDataURL("image/png"),"PNG",10,35,b-20,w-20),h.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${M}`,author:"Bitrix24 Dashboard"});const W=`graph-state-${M.replace(/\//g,"-")}.pdf`;h.save(W),e.success("График успешно экспортирован в PDF")}catch(L){console.error("Ошибка экспорта в PDF:",L),he({message:"Ошибка экспорта в PDF: "+(L.message||"Неизвестная ошибка"),details:L.stack,type:"error"})}finally{k.value=!1}}function Ge(L){var Y;if((Y=L==null?void 0:L.preventDefault)==null||Y.call(L),!Q.value){Q.value=!0;try{if(B.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(s)}finally{Q.value=!1}}}function Me(){typeof window<"u"&&(A.value=window.innerWidth)}async function ve(){try{const L=await Lt.checkAccess();L.allowed&&(p.value=L.user)}catch(L){console.error("Error loading user:",L)}}return Oe(()=>{f(),ve(),typeof window<"u"&&(A.value=window.innerWidth,window.addEventListener("resize",Me))}),lt(()=>{typeof window<"u"&&window.removeEventListener("resize",Me)}),(L,Y)=>{const ye=qt("router-link");return E(),T("div",el,[g.value?(E(),Ae(Pt,{key:0,message:D.value},null,8,["message"])):Z("",!0),y.value?(E(),T("div",tl,[i("div",al,[i("div",{class:"error-header"},[Y[1]||(Y[1]=i("span",{class:"error-icon"},"❌",-1)),Y[2]||(Y[2]=i("h3",null,"Ошибка",-1)),i("button",{onClick:Pe,class:"error-close","aria-label":"Закрыть"},"✕")]),i("p",sl,H(y.value.message),1),y.value.details?(E(),T("div",nl,[i("details",null,[Y[3]||(Y[3]=i("summary",null,"Детали ошибки",-1)),i("pre",null,H(y.value.details),1)])])):Z("",!0),i("div",{class:"error-actions"},[i("button",{onClick:be,class:"btn-retry"},"Повторить попытку")])])])):Z("",!0),i("div",ol,[i("div",ll,[i("div",rl,[i("button",{class:"btn-back-link",type:"button",onClick:Ge,"aria-label":hl,"aria-disabled":!B.value,"data-fallback":!B.value,disabled:Q.value,title:"Назад"}," ← ",8,il),i("nav",cl,[ie(ye,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Te(()=>[...Y[4]||(Y[4]=[at(" Дашборд сектора 1С ",-1)])]),_:1}),Y[5]||(Y[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),Y[6]||(Y[6]=i("span",{class:"breadcrumb-current"},"График состояния",-1))])]),Y[7]||(Y[7]=i("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),Y[8]||(Y[8]=i("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),i("div",ul,[i("button",{onClick:Le,class:"btn-export-pdf",disabled:k.value||g.value,title:"Экспортировать график в PDF"},[k.value?(E(),T("span",gl,"⏳ Экспорт...")):(E(),T("span",pl,"📄 Экспорт в PDF"))],8,dl),ie(no,{user:p.value,onSnapshotCreated:we},null,8,["user"])])]),te.value?(E(),T("button",{key:2,class:"mobile-filters-toggle",onClick:Y[0]||(Y[0]=Ne=>S.value=!S.value)},[Y[9]||(Y[9]=i("span",null,"Фильтры",-1)),i("span",{class:oe(["toggle-icon",{open:S.value}])},"▼",2)])):Z("",!0),i("div",{class:oe({"mobile-open":S.value&&te.value,"mobile-closed":!S.value&&te.value})},[ie(Zo,{stages:je(n).stages,employees:je(n).employees,dateRange:je(n).dateRange,customDateRange:je(n).customDateRange,hasActiveFilters:je(c),"onUpdate:stages":P,"onUpdate:employees":G,"onUpdate:dateRange":X,"onUpdate:customDateRange":ce,onReset:$e,onApply:ue},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!g.value&&!y.value?(E(),T("div",fl,[i("div",ml,[ie(Hn,{period:je(l),"show-current-state":d.value,onDataLoaded:Ve,onError:ke},null,8,["period","show-current-state"])])])):Z("",!0)])}}},yl=Ie(vl,[["__scopeId","data-v-e995acfd"]]),Sl=Object.freeze(Object.defineProperty({__proto__:null,default:yl},Symbol.toStringTag,{value:"Module"}));export{Sl as G,Bt as T,ga as g};
