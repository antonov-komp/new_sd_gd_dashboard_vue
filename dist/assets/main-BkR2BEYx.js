const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DashboardSectorPDMService-B0QQE_Wk.js","./chunk-CITvVYpI.js","./chunk-DgW6SZr3.js","./chunk-BeUHPrL3.js","./chunk-cxcosIgb.js","./chunk-BuX-LpxK.js","./chunk-qDiINO2f.js","./chunk-BnSB3pIR.js","./DashboardSectorBitrix24Service-CfTuOUuw.js","./DashboardSectorInfrastructureService-DKTYy2to.js","./direct-access-config-Bm3k8CvE.js","./access-config-async-Bqc9SW93.js","./WebhookLogsDashboard.vue-B_gD4AD5.js","./WebhookLogDetails.vue-Cqyr97zA.js","./SectorDashboardPDM.vue-1xWOYL6p.js","./SectorDashboardBitrix24.vue-OkVG_2Iq.js","./SectorDashboardInfrastructure.vue-By56mhyp.js"])))=>i.map(i=>d[i]);
var qs=Object.defineProperty;var Ys=(o,e,a)=>e in o?qs(o,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[e]=a;var Fe=(o,e,a)=>Ys(o,typeof e!="symbol"?e+"":e,a);import{r as be,c as u,o as c,a as ne,b as $,d as hs,t as m,n as X,e as s,f as he,g as M,h as $e,u as Xe,i as Ra,j as I,F as ee,k as te,l as we,m as ge,w as Te,p as Ue,q as Ne,s as ye,T as Ae,v as Qe,x as Be,y as It,C as Je,z as Xs,L as Js,P as Zs,A as Qs,B as eo,D as to,E as ao,G as so,H as oo,I as no,J as Re,K as Et,M as _t,N as wt,O as yt,Q as fs,R as vs,S as at,U as At,V as Wt,W as ps,X as wa,Y as la,Z as Xa,_ as ro,$ as ka,a0 as dt,a1 as io,a2 as ys,a3 as lo,a4 as co,a5 as uo}from"./chunk-DgW6SZr3.js";import{a as ks,_ as Ce,g as et,b as go,f as Ft}from"./chunk-BeUHPrL3.js";import{C as Ja}from"./chunk-cxcosIgb.js";import{i as mo,S as Jt,m as Zt,a as Ba,g as La,b as bs,c as ho,d as Za,E as fo,e as Ca,f as Ta,h as aa,p as Qa,j as vo,k as po,D as yo,l as ko,n as es,o as ts,T as bo,q as as,r as _o}from"./chunk-qDiINO2f.js";import{D as vt}from"./chunk-BnSB3pIR.js";import{L as wo}from"./chunk-BuX-LpxK.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function a(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(r){if(r.ep)return;r.ep=!0;const i=a(r);fetch(r.href,i)}})();const ce=(o,e)=>{const a=o.__vccOpts||o;for(const[t,r]of e)a[t]=r;return a},Co={name:"App"},To={id:"app"};function So(o,e,a,t,r,i){const n=be("router-view");return c(),u("div",To,[ne(n)])}const Do=ce(Co,[["render",So]]),Eo={name:"StatusMessage",props:{type:{type:String,required:!0,validator:o=>["success","error","info","warning"].includes(o)},title:{type:String,default:null},message:{type:String,default:null}}},Ao={key:0},$o={key:1};function Io(o,e,a,t,r,i){return c(),u("div",{class:X(["status-message",`status-message--${a.type}`])},[a.title?(c(),u("strong",Ao,m(a.title),1)):$("",!0),a.message?(c(),u("p",$o,m(a.message),1)):$("",!0),hs(o.$slots,"default",{},void 0)],2)}const ba=ce(Eo,[["render",Io],["__scopeId","data-v-7f15d2d7"]]),Mo={name:"LoadingSpinner",props:{message:{type:String,default:"Загрузка..."}}},No={class:"loading-spinner"},xo={key:0,class:"message"};function Lo(o,e,a,t,r,i){return c(),u("div",No,[e[0]||(e[0]=s("div",{class:"spinner"},null,-1)),a.message?(c(),u("p",xo,m(a.message),1)):$("",!0)])}const _a=ce(Mo,[["render",Lo],["__scopeId","data-v-375eac16"]]);function Rt(){try{if(window.self===window.top)return!1;if(typeof BX24<"u")return!0;try{const o=window.parent.location.origin;return o.includes("bitrix24")||o.includes("kompo.by")}catch{return!1}}catch(o){return console.warn("Error checking Bitrix24 context:",o),!1}}function Po(){return typeof BX24<"u"}class kt{static init(e){return new Promise((a,t)=>{if(!Rt()){console.log("Not inside Bitrix24, skipping BX24.init()"),e&&e(),a();return}if(typeof BX24>"u"){t(new Error("Bitrix24 API not loaded. Make sure script is included: //api.bitrix24.com/api/v1/"));return}const r=setTimeout(()=>{t(new Error("BX24.init() timeout: инициализация Bitrix24 API превысила 5 секунд"))},5e3);try{BX24.init(()=>{clearTimeout(r),e&&e(),a()})}catch(i){clearTimeout(r),t(i)}})}static installFinish(){return new Promise((e,a)=>{if(typeof BX24>"u"){a(new Error("Bitrix24 API not loaded"));return}try{BX24.installFinish(),e()}catch(t){a(t)}})}static callMethod(e,a={}){return new Promise((t,r)=>{if(typeof BX24>"u"){r(new Error("Bitrix24 API not loaded"));return}const i=setTimeout(()=>{r(new Error(`BX24.callMethod(${e}) timeout: запрос превысил 10 секунд`))},1e4);try{BX24.callMethod(e,a,n=>{if(clearTimeout(i),n.error()){const l=n.error();r(new Error(l.error_description||l.error||"Unknown error"))}else t(n.data())})}catch(n){clearTimeout(i),r(n)}})}static async getCurrentUser(){if(Rt()&&Po())try{const e=await Promise.race([this.callMethod("user.current",{}),new Promise((a,t)=>setTimeout(()=>t(new Error("Timeout")),5e3))]);return console.log("Got user from BX24.callMethod() (interface user):",e?.ID||"unknown"),e}catch(e){console.warn("BX24.callMethod() failed, using proxy API as fallback:",e);try{const t=await new Ja().getCurrentUser();return console.log("Got user from proxy API (token owner, fallback):",t),t}catch(a){throw console.error("Both BX24 API and proxy API failed:",a),e.message&&e.message.includes("timeout")?new Error("Таймаут при определении пользователя. Bitrix24 API не отвечает."):new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}else return console.warn("Not inside Bitrix24, using proxy API (will return token owner, not interface user)"),await new Ja().getCurrentUser()}static getUser(){return new Promise((e,a)=>{if(typeof BX24>"u"){a(new Error("Bitrix24 API not loaded"));return}if(typeof BX24.getUser!="function"){a(new Error("BX24.getUser is not available"));return}BX24.getUser(t=>{e(t)})})}static getAuth(){return new Promise((e,a)=>{if(typeof BX24>"u"){a(new Error("Bitrix24 API not loaded"));return}BX24.getAuth(t=>{e(t)})})}}const Oo={name:"InstallPage",components:{StatusMessage:ba,LoadingSpinner:_a},setup(){const o=M(!0),e=M(null),a=M(null);return $e(async()=>{try{let t=null;if(window.INSTALL_RESULT)t=window.INSTALL_RESULT;else{const r=ks("/install.php"),i=await fetch(`${r}?get_result=1`);i.ok&&(t=await i.json())}if(!t)throw new Error("Не удалось получить результат установки");if(a.value=t,t.rest_only===!1)if(t.install===!0){e.value={type:"success",title:"✓ Установка завершена успешно!",message:"Приложение успешно установлено в Bitrix24."};try{await kt.init(()=>{kt.installFinish()})}catch(r){console.error("Error finishing installation:",r)}}else e.value={type:"error",title:"✗ Ошибка установки",message:"Не удалось установить приложение. Проверьте настройки."};else e.value={type:"info",title:"REST-only режим",message:"Это приложение работает только через REST API, без пользовательского интерфейса."}}catch(t){console.error("Error loading install result:",t),e.value={type:"error",title:"Ошибка загрузки",message:t.message||"Не удалось загрузить информацию об установке."}}finally{o.value=!1}}),{loading:o,installStatus:e,installInfo:a}}},Ro={class:"install-page"},Bo={class:"container"},Uo={key:1,class:"info"};function Wo(o,e,a,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner");return c(),u("div",Ro,[s("div",Bo,[e[1]||(e[1]=s("h1",null,"Установка Bitrix24 приложения",-1)),t.installStatus?(c(),he(n,{key:0,type:t.installStatus.type,title:t.installStatus.title,message:t.installStatus.message},null,8,["type","title","message"])):$("",!0),t.installInfo?(c(),u("div",Uo,[e[0]||(e[0]=s("h3",null,"Информация об установке:",-1)),s("pre",null,m(JSON.stringify(t.installInfo,null,2)),1)])):$("",!0),t.loading?(c(),he(l,{key:2,message:"Обработка установки..."})):$("",!0)])])}const Fo=ce(Oo,[["render",Wo],["__scopeId","data-v-d082ec9e"]]);function Ho(){const o=Xe(),e=Ra();return{goBack:(n="/")=>{window.history.length>1?o.back():o.push(n)},goTo:(n,l={})=>{o.push({path:n,...l})},goHome:(n={})=>{o.push({path:"/",...n})},isCurrentRoute:n=>e.path===n,router:o,route:e}}const jo={name:"BackButton",props:{variant:{type:String,default:"header",validator:o=>["header","floating"].includes(o)},text:{type:String,default:"НАЗАД"},to:{type:String,default:null},showIcon:{type:Boolean,default:!0},ariaLabel:{type:String,default:"Вернуться на главную"},title:{type:String,default:"Вернуться на главную"}},setup(o){const{goBack:e,goHome:a}=Ho();return{buttonClasses:I(()=>[o.variant==="header"?"back-button":"floating-back-button"]),handleClick:()=>{o.to?a({path:o.to}):e()}}}},Vo=["aria-label","title"],zo={key:0,class:"back-button-icon"},Go={key:1,class:"back-button-text"};function Ko(o,e,a,t,r,i){return c(),u("button",{class:X(t.buttonClasses),onClick:e[0]||(e[0]=(...n)=>t.handleClick&&t.handleClick(...n)),"aria-label":a.ariaLabel,title:a.title},[a.showIcon?(c(),u("span",zo,"←")):$("",!0),a.variant==="header"?(c(),u("span",Go,m(a.text),1)):$("",!0)],10,Vo)}const _s=ce(jo,[["render",Ko],["__scopeId","data-v-d605b6a0"]]);function qo(o){const e=M(!1),a=M(null),t=M(""),r=M({}),i=M([]),n=M({}),l=M([]),d=M({totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}),g=I(()=>i.value.length>0||l.value.length>0),v=I(()=>!g.value&&!e.value&&!a.value),C=I(()=>{const R=Object.values(n.value).reduce((G,q)=>G+(q?.length||0),0),W=i.value.reduce((G,q)=>G+(q.tickets?.length||0),0);return R+W}),f=I(()=>{if(!C.value)return 0;const W=[...Object.values(n.value).flat(),...i.value.flatMap(G=>G.tickets||[])].filter(G=>G.status==="closed"||G.status==="completed"||G.status==="done").length;return Math.round(W/C.value*100)}),p=(R,W="",G={})=>{e.value=R,t.value=W,r.value=G},y=R=>{a.value=R,e.value=!1},S=()=>{a.value=null},T=R=>{i.value=R},k=R=>{l.value=R},_=R=>{n.value=R},A=R=>{d.value={...d.value,...R,lastUpdated:new Date().toISOString()}},U=()=>{e.value=!1,a.value=null,t.value="",r.value={},i.value=[],n.value={},l.value=[],d.value={totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}},x=R=>i.value.find(W=>W.id===R);return{isLoading:e,error:a,currentStep:t,stepDetails:r,stages:i,zeroPointTickets:n,employees:l,sectorStats:d,hasData:g,isEmpty:v,totalTickets:C,completionRate:f,setLoading:p,setError:y,clearError:S,updateStages:T,updateEmployees:k,updateZeroPointTickets:_,updateSectorStats:A,resetState:U,getStageById:x,getEmployeeById:R=>l.value.find(W=>W.id===R),getStageTickets:R=>{const W=x(R);return W?W.tickets||[]:[]},getZeroPointTickets:R=>n.value[R]||[]}}class Dt{static async call(e,a={}){return await new vt().call(e,a)}}class Oe{static get(e){const a=this.cache.get(e);return a?Date.now()-a.timestamp>a.ttl?(this.cache.delete(e),null):a.data:null}static set(e,a,t=this.DEFAULT_TTL){this.cache.set(e,{data:a,timestamp:Date.now(),ttl:t})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const a=[];for(const t of this.cache.keys())t.startsWith(e)&&a.push(t);a.forEach(t=>this.cache.delete(t))}static cleanExpired(){const e=Date.now(),a=[];for(const[t,r]of this.cache.entries())e-r.timestamp>r.ttl&&a.push(t);a.forEach(t=>this.cache.delete(t))}static getStats(){const e=Date.now();let a=0,t=0;for(const r of this.cache.values())e-r.timestamp>r.ttl?a++:t++;return{total:this.cache.size,valid:t,expired:a}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((t,r)=>t-r).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}Fe(Oe,"cache",new Map),Fe(Oe,"DEFAULT_TTL",5*60*1e3),Fe(Oe,"EMPLOYEES_TTL",30*60*1e3),Fe(Oe,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{Oe.cleanExpired()},5*60*1e3);const Sa="dashboard-sector-1c-logger-level",zt={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};let Mt=class{static getLevel(){if(typeof localStorage<"u"){const a=localStorage.getItem(Sa);if(a&&zt[a]!==void 0)return a}return!0?"ERROR":"DEBUG"}static setLevel(e){return zt[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(Sa,e),!0):!1}static isEnabled(e,a=null){const t=a||this.getLevel();if(t==="NONE")return!1;const r=zt[e]||0,i=zt[t]||0;return r<=i}static getLevels(){return{...zt}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(Sa)}},Ee=class{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,a,t=""){const r=new Date().toISOString(),i=this.getLevelColor(e),n=`%c[${r}] %c[${e}] %c[${t||"Unknown"}] %c${a}`,l=["color: #6c757d; font-weight: normal",`color: ${i}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:n,styles:l}}static log(e,a,t="",r=null){if(!Mt.isEnabled(e))return;const i=this.formatMessage(e,a,t),n=[i.formatted,...i.styles];switch(r!=null&&n.push(r),e){case"ERROR":console.error(...n);break;case"WARN":console.warn(...n);break;case"INFO":console.info(...n);break;case"DEBUG":console.log(...n);break;default:console.log(...n)}}static error(e,a="",t=null){this.log("ERROR",e,a,t)}static warn(e,a="",t=null){this.log("WARN",e,a,t)}static info(e,a="",t=null){this.log("INFO",e,a,t)}static debug(e,a="",t=null){this.log("DEBUG",e,a,t)}};function Ke(o,e,a={}){if(!o||typeof o!="string")throw new Error("Step must be a non-empty string");const t=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let r=a.description;return r||(r=Yo(o,a)),{step:o,progress:t,details:{...a,description:r}}}function Yo(o,e){return o==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`Загрузка тикетов стадии "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:o==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`Фильтрация тикетов: ${e.filteredTickets} из ${e.totalTickets}...`:o==="grouping"&&e.employeeCount!==void 0?`Группировка тикетов по ${e.employeeCount} сотрудникам...`:e.count!==void 0&&e.total!==void 0?`Обработка: ${e.count} из ${e.total}...`:"Загрузка данных..."}function ga(o){if(!o||typeof o!="object")throw new Error("Progress info must be an object");const e=o.step||null;if(!e)throw new Error("Step is required in progress info");const a=o.progress!==void 0&&o.progress!==null?o.progress:o.percent!==void 0&&o.percent!==null?o.percent:void 0,t=o.details||{};return o.stage&&(t.stage=o.stage),o.stageName&&(t.stageName=o.stageName),o.stageIndex!==void 0&&(t.stageIndex=o.stageIndex),o.totalStages!==void 0&&(t.totalStages=o.totalStages),o.count!==void 0&&(t.count=o.count),o.total!==void 0&&(t.total=o.total),o.warning&&(t.warning=o.warning),{step:e,progress:a!=null?Math.max(0,Math.min(100,a)):void 0,details:t}}function Pa(o,e,a){const t=typeof o=="number"&&!isNaN(o)?Math.max(0,Math.min(100,o)):0,r=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,i=typeof a=="number"&&!isNaN(a)?Math.max(0,Math.min(100,a)):0,n=t+r*i/100;return Math.max(0,Math.min(100,n))}const xt={allowedDepartmentIds:[369,366,7],adminDepartmentIds:[369]};function ws(o){return!o||typeof o!="number"?!1:xt.allowedDepartmentIds.includes(o)}function sa(o){if(!o||!o.UF_DEPARTMENT)return!1;const e=Array.isArray(o.UF_DEPARTMENT)?o.UF_DEPARTMENT:[];return e.length===0?!1:e.some(a=>xt.adminDepartmentIds.includes(a))}class Xo{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,a,t,r=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const i=this.metrics.ticketsLoading.stages[e];i.loaded=t,i.batches.push({count:a,total:t,next:r}),i.total=t,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((n,l)=>n+l.total,0)}logFiltering(e,a,t=[],r=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=a,this.metrics.filtering.rejected=t.slice(0,50),this.metrics.filtering.tagValueExamples=r.slice(0,20)}logEmployees(e,a=[],t=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=a.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=t.slice(0,50)}logGrouping(e,a=[],t=[]){e.forEach(r=>{const i={};let n=0;r.employees.forEach(l=>{const d=(l.ticketsInsideSector||[]).length+(l.ticketsOutsideSector||[]).length;i[l.id]=d,n+=d}),this.metrics.grouping.distributionByStages[r.id]={employees:i,total:n}}),this.metrics.grouping.ticketsNotInColumn=a.slice(0,50),this.metrics.grouping.unknownStages=t.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(a=>{this.metrics.zeroPoint.byStage[a]=Array.isArray(e[a])?e[a].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let Da=null;function tt(){return Da||(Da=new Xo),Da}function ct(o=null,e=null){if(e&&!sa(e))return!1;if(o&&o.query&&o.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const a=window.location.hash;if(a){const r=a.split("?");if(r.length>1){const i=r[1];if(new URLSearchParams(i).get("diagnostics")==="true")return!0}if(a.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}const Gt=140;class Lt{static async getAllTicketsByFilter(e,a="UF_CRM_7_TYPE_PRODUCT",t=null,r=!0){Ee.info(`Loading tickets by filter: ${a} = ${e}`,"TicketRepository");try{const i=[],n=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],l=n.length;for(let d=0;d<n.length;d++){const g=n[d],v=this.getStageName(g);if(t){const C=d/l*100;t({step:"loading_tickets",progress:C,details:{stage:g,stageName:v,stageIndex:d+1,totalStages:l,filter:`${a} = ${e}`}})}try{const C=await this.getTicketsByStageWithFilter(g,e,a,r,t?f=>{const p=Pa(d/l*100,1/l*100,f.percent||0);t({step:"loading_tickets",progress:p,details:{stage:g,stageName:v,stageIndex:d+1,totalStages:l,count:f.count,total:f.total,filter:`${a} = ${e}`}})}:null);i.push(...C)}catch(C){Ee.error(`Error loading tickets for stage ${g} with filter ${a} = ${e}`,"TicketRepository",C)}}return Ee.info(`Loaded ${i.length} tickets with filter ${a} = ${e}`,"TicketRepository"),i}catch(i){throw Ee.error(`Error loading tickets by filter ${a} = ${e}`,"TicketRepository",i),i}}static async getAllTickets(e,a=null,t=!0){const r=[],i=e.length;try{for(let n=0;n<e.length;n++){const l=e[n],d=this.getStageName(l);if(a){const g=n/i*100;a(Ke("loading_tickets",g,{stage:l,stageName:d,stageIndex:n+1,totalStages:i}))}try{const g=await this.getTicketsByStage(l,t,a?v=>{const C=Pa(n/i*100,1/i*100,v.percent||0);a(Ke("loading_tickets",C,{stage:l,stageName:d,stageIndex:n+1,totalStages:i,count:v.count,total:v.total}))}:null);r.push(...g)}catch(g){Ee.error(`Error loading tickets for stage ${l}`,"TicketRepository",g);let v=`Ошибка загрузки стадии "${d}"`;throw g.message&&(g.message.includes("HTTP error")||g.message.includes("network")?v=`Ошибка соединения при загрузке стадии "${d}". Проверьте подключение к интернету.`:g.message.includes("timeout")?v=`Превышено время ожидания при загрузке стадии "${d}". Попробуйте позже.`:g.message.includes("403")||g.message.includes("401")?v=`Ошибка доступа при загрузке стадии "${d}". Проверьте права доступа.`:v=`Ошибка загрузки стадии "${d}": ${g.message}`),new Error(v)}}}catch(n){throw Ee.error("Error in getAllTickets","TicketRepository",n),n}return r}static getStageName(e){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[e]||e}static async getTicketsByStage(e,a=!0,t=null){if(a){const v=Oe.getTicketsCacheKey(e),C=Oe.get(v);if(C!==null){try{const f=tt();f&&ct()&&f.logTicketsLoading(e,C.length,C.length,null)}catch(f){Ee.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",f)}return t&&t(ga({step:"loading_tickets",percent:100,count:C.length,total:C.length})),C}}const r=[];let i=0;const n=50;let l=!0,d=0,g=null;for(;l;)try{const v=await Dt.call("crm.item.list",{entityTypeId:Gt,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:i,useOriginalUfNames:"Y"});let C=[];if(v&&v.result&&(Array.isArray(v.result)?C=v.result:v.result.items&&Array.isArray(v.result.items)?C=v.result.items:v.result.data&&Array.isArray(v.result.data)&&(C=v.result.data)),C.length>0){r.push(...C),i+=C.length;const f=v?.result?.next??v?.next,p=f!=null&&f!==""&&String(f)!=="0";l=C.length===n&&p,ct()&&Ee.debug(`[Pagination] Stage: ${e}, Batch: ${C.length}, Total: ${r.length}, Start: ${i}, NextValue: ${f}, HasNext: ${p}, HasMore: ${l}`,"TicketRepository");try{const y=tt();y&&ct()&&(Ee.debug(`[Pagination Debug] Stage: ${e}, Batch: ${C.length}, Total: ${r.length}`,"TicketRepository",{resultStructure:{hasResult:!!v?.result,resultIsArray:Array.isArray(v?.result),hasItems:!!v?.result?.items,hasData:!!v?.result?.data,hasNext:!!f,nextValue:f,nextType:typeof f,resultKeys:v?.result?Object.keys(v.result):[]}}),y.logTicketsLoading(e,C.length,r.length,f||null))}catch(y){Ee.warn("Diagnostics logging error","TicketRepository",y)}if(l?d=i+n:d=r.length,t){const y=d>0?Math.min(100,r.length/d*100):0;t(ga({step:"loading_tickets",percent:y,count:r.length,total:d}))}g=null}else l=!1}catch(v){if(Ee.error(`Error loading tickets batch for stage ${e} (start: ${i})`,"TicketRepository",v),i===0)throw g=v,new Error(`Не удалось загрузить тикеты для стадии ${e}: ${v.message||v}`);l=!1,t&&r.length>0&&t(Ke("loading_tickets",100,{count:r.length,total:r.length,warning:`Загружено частично: ${r.length} тикетов. Ошибка при загрузке остальных.`}))}if(g&&r.length===0)throw g;if(a){const v=Oe.getTicketsCacheKey(e);Oe.set(v,r,Oe.TICKETS_TTL)}return r}static async getTicket(e){return(await Dt.call("crm.item.get",{entityTypeId:Gt,id:e})).result||null}static async getTicketsByStageWithFilter(e,a,t="UF_CRM_7_TYPE_PRODUCT",r=!0,i=null){Ee.info(`Loading tickets for stage ${e} with filter ${t} = ${a}`,"TicketRepository");const n=`tickets_${e}_${t}_${JSON.stringify(a)}`;if(r){const p=Oe.get(n);if(p!==null)return Ee.info(`Cache hit for filtered tickets: ${e} with ${t} = ${a}`,"TicketRepository"),i&&i({step:"loading_tickets",percent:100,count:p.length,total:p.length}),p}const l=[];let d=0;const g=50;let v=!0,C=0;const f={stageId:e};for(Array.isArray(a),f[t]=a;v;)try{const p=await Dt.call("crm.item.list",{entityTypeId:Gt,filter:f,select:["*"],order:{id:"DESC"},start:d,useOriginalUfNames:"Y"});let y=[];p&&p.result&&(Array.isArray(p.result)?y=p.result:p.result.items&&Array.isArray(p.result.items)?y=p.result.items:p.result.data&&Array.isArray(p.result.data)&&(y=p.result.data)),y.length>0?(l.push(...y),d+=y.length,C=Math.max(C,d+y.length),i&&i({step:"loading_tickets",percent:Math.min(d/Math.max(C,d)*100,95),count:d,total:C}),v=y.length===g&&p.next):v=!1}catch(p){throw Ee.error(`Error loading batch for stage ${e} with filter ${t} = ${a}`,"TicketRepository",p),v=!1,p}r&&(Oe.set(n,l),Ee.info(`Cached ${l.length} filtered tickets for stage ${e}`,"TicketRepository"));try{const p=tt();p&&ct()&&p.logTicketsLoading(`${e}_${a}`,l.length,l.length,null)}catch(p){Ee.warn("Diagnostics logging error in getTicketsByStageWithFilter","TicketRepository",p)}return i&&i({step:"loading_tickets",percent:100,count:l.length,total:l.length}),Ee.info(`Loaded ${l.length} tickets for stage ${e} with filter ${t} = ${a}`,"TicketRepository"),l}static async updateTicket(e,a){const r=(await Dt.call("crm.item.update",{entityTypeId:Gt,id:e,fields:a})).result===!0;return r&&Oe.invalidateTicketsCache(),r}static async createTicket(e){const a=await Dt.call("crm.item.add",{entityTypeId:Gt,fields:e}),t=a.result?parseInt(a.result):0;return t>0&&Oe.invalidateTicketsCache(),t}static async assignTicket(e,a,t){return await this.updateTicket(e,{assignedById:a,stageId:t})}}class Jo{static async getEmployeesByIds(e,a=!0){if(!Array.isArray(e)||e.length===0)return[];if(a){const t=Oe.getEmployeesCacheKey(e),r=Oe.get(t);if(r!==null)return Ee.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),r}try{const t=await Dt.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let r=[];if(t&&t.result&&(Array.isArray(t.result)?r=t.result:Ee.warn("Unexpected user.get result format","EmployeeRepository",t)),a){const i=Oe.getEmployeesCacheKey(e);Oe.set(i,r,Oe.EMPLOYEES_TTL)}return r}catch(t){return Ee.error("Error getting employees by IDs","EmployeeRepository",t),[]}}}const Xt=new Map;function Cs(){Xt.clear()}function Zo(o){if(!o)return[];if(Array.isArray(o))return o.filter(a=>typeof a=="number"||!isNaN(parseInt(a))).map(a=>typeof a=="number"?a:parseInt(a));if(typeof o=="number")return[o];const e=parseInt(o);return isNaN(e)?[]:[e]}function Qo(o,e=!0){const a=o.id||o.ID;if(!o||!a)return null;if(e&&Xt.has(a))return Xt.get(a);const t=o.UF_DEPARTMENT||o.departmentId,r=Zo(t);for(const i of r)if(mo(i)){const l=i;return e&&Xt.set(a,l),l}return e&&Xt.set(a,null),null}function en(o){const e=Qo(o);return{id:parseInt(o.ID||o.id||0),name:`${o.NAME||o.name||""} ${o.LAST_NAME||o.lastName||""}`.trim()||o.EMAIL||o.email||"Неизвестный",position:o.WORK_POSITION||o.workPosition||"Сотрудник",email:o.EMAIL||o.email||"",sectorId:e,departmentId:o.UF_DEPARTMENT||null,tickets:[]}}function tn(o){return Array.isArray(o)?o.map(e=>en(e)):[]}const Ea="dashboard-sectors-logger-level",Kt={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class an{static getLevel(){if(typeof localStorage<"u"){const a=localStorage.getItem(Ea);if(a&&Kt[a]!==void 0)return a}return!0?"ERROR":"DEBUG"}static setLevel(e){return Kt[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(Ea,e),!0):!1}static isEnabled(e,a=null){const t=a||this.getLevel();if(t==="NONE")return!1;const r=Kt[e]||0,i=Kt[t]||0;return r<=i}static getLevels(){return{...Kt}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(Ea)}}let Nt=class{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,a,t=""){const r=new Date().toISOString(),i=this.getLevelColor(e),n=`%c[${r}] %c[${e}] %c[${t||"Unknown"}] %c${a}`,l=["color: #6c757d; font-weight: normal",`color: ${i}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:n,styles:l}}static log(e,a,t="",r=null){if(!an.isEnabled(e))return;const i=this.formatMessage(e,a,t),n=[i.formatted,...i.styles];switch(r!=null&&n.push(r),e){case"ERROR":console.error(...n);break;case"WARN":console.warn(...n);break;case"INFO":console.info(...n);break;case"DEBUG":console.log(...n);break;default:console.log(...n)}}static error(e,a="",t=null){this.log("ERROR",e,a,t)}static warn(e,a="",t=null){this.log("WARN",e,a,t)}static info(e,a="",t=null){this.log("INFO",e,a,t)}static debug(e,a="",t=null){this.log("DEBUG",e,a,t)}};const Qt=new Map,ss=100;function sn(o,e){if(!Array.isArray(o))return Nt.warn("filterTicketsBySector: tickets is not an array","sector-filter"),[];if(!e||!e.id)return Nt.error("filterTicketsBySector: invalid sectorConfig","sector-filter",e),[];const a=ln(o,e),t=Qt.get(a);if(t!==void 0)return Nt.debug(`Filter cache hit for sector ${e.id}`,"sector-filter"),t;const r=on(e);if(r.length===0)return Nt.warn(`No filter values for sector ${e.id}`,"sector-filter"),[];const i=o.filter(n=>nn(n,r,e));return Nt.info(`Filtered ${i.length}/${o.length} tickets for sector ${e.id}`,"sector-filter",{sectorId:e.id,sectorName:e.name,totalTickets:o.length,filteredTickets:i.length,filterValues:r,filterField:e.filterField||"UF_CRM_7_TYPE_PRODUCT"}),Qt.set(a,i),cn(),i}function on(o){const{filterValue:e}=o;return e?(Array.isArray(e)?e:Array.isArray(o.filterValues)?o.filterValues:[e]).filter(t=>t!=null).map(t=>Ts(t)).filter(Boolean):[]}function nn(o,e,a){if(!o||typeof o!="object")return!1;const t=rn(o,a.filterField||"UF_CRM_7_TYPE_PRODUCT"),r=Ts(t);return r?e.some(i=>r===i):!1}function rn(o,e){return o[e]||o[e.toLowerCase()]||o[dn(e)]||o[e.replace(/_/g,"").toLowerCase()]||null}function Ts(o){return o==null?null:(typeof o=="object"&&o.value!==void 0&&(o=o.value),Array.isArray(o)&&o.length>0&&(o=o[0]),String(o).trim().toUpperCase().replace(/С/g,"C").replace(/с/g,"c")||null)}function ln(o,e){const a=o.map(i=>i.id||i.ID||"").sort().join(","),t=JSON.stringify({id:e.id,filterValue:e.filterValue,filterValues:e.filterValues,filterField:e.filterField}),r=btoa(a+"|"+t).slice(0,50);return`filter:${e.id}:${r}`}function cn(){if(Qt.size>ss){const o=Math.floor(ss*.2);Array.from(Qt.keys()).slice(0,o).forEach(a=>Qt.delete(a)),Nt.debug(`Cleaned ${o} entries from filter cache`,"sector-filter")}}function dn(o){return o.toLowerCase().replace(/_([a-z])/g,(e,a)=>a.toUpperCase())}const ta=1051;function ma(o){if(!o||typeof o!="object")return null;let e=o.assignedById||o.ASSIGNED_BY_ID||o.assignedByIdId||o.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function Ua(o){if(o==null)return null;typeof o=="object"&&(o=o.id||o.ID||o.value||null);const e=typeof o=="number"?o:parseInt(o);return isNaN(e)||e<=0?null:e}function un(o,e=ta){const a=ma(o),t=Ua(a);return t===null||t===e}function gn(o,e){Array.isArray(o)||(Ee.warn("Tickets is not an array","TicketGrouper",o),o=[]),Array.isArray(e)||(Ee.warn("Employees is not an array","TicketGrouper",e),e=[]);const a=e.filter(d=>(d.id?parseInt(d.id):null)!==ta),t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:a.map(d=>({...d,isFromSector1C:d.sectorId===Jt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:a.map(d=>({...d,isFromSector1C:d.sectorId===Jt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:a.map(d=>({...d,isFromSector1C:d.sectorId===Jt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],r=new Map(t.map(d=>[d.id,d])),i=new Map;t.forEach(d=>{const g=new Map(d.employees.map(v=>[v.id,v]));i.set(d.id,g)});const n=[],l=[];o.forEach(d=>{const g=Zt(d.stageId||d.STAGE_ID||""),v=r.get(g);if(!v){l.push({id:d.id||d.ID,title:d.title||d.TITLE||"Без названия",stageId:d.stageId||d.STAGE_ID,assignedById:ma(d)});return}const C=ma(d),f=Ua(C);if(f!==ta)if(f){const p=i.get(g);let y=p.get(f);y||(y={id:f,name:`Сотрудник #${f}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},v.employees.push(y),p.set(f,y));const S=Ba(d),T={...S,stageId:d.stageId||d.STAGE_ID||S.stageId||null,departmentHead:S.departmentHead||null,departmentHeadFull:S.departmentHeadFull||S.departmentHead||null};y.tickets.push(T),y.isFromSector1C?y.ticketsInsideSector.push(T):y.ticketsOutsideSector.push(T)}else n.push({id:d.id||d.ID,title:d.title||d.TITLE||"Без названия",stageId:g,assignedById:C})}),t.forEach(d=>{d.employees.sort((g,v)=>g.isFromSector1C&&!v.isFromSector1C?-1:!g.isFromSector1C&&v.isFromSector1C?1:(g.id||0)-(v.id||0))});try{const d=tt();if(d&&ct()){const g={};t.forEach(C=>{let f=0,p=0;C.employees.forEach(y=>{f+=(y.ticketsInsideSector||[]).length,p+=(y.ticketsOutsideSector||[]).length}),g[C.id]={insideSector:f,outsideSector:p,total:f+p}});const v=d.metrics.grouping;Object.keys(g).forEach(C=>{v.distributionByStages[C]||(v.distributionByStages[C]={employees:{},total:0}),v.distributionByStages[C].insideSector=g[C].insideSector,v.distributionByStages[C].outsideSector=g[C].outsideSector,v.distributionByStages[C].total=g[C].total}),d.logGrouping(t,n,l)}}catch(d){Ee.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",d)}return t}function mn(o){const e={formed:[],review:[],execution:[]};if(!Array.isArray(o))return Ee.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",o),e;o.filter(a=>un(a)).forEach(a=>{const t=Zt(a.stageId||a.STAGE_ID||"");if(e[t]){const r=Ba(a),i={...r,stageId:a.stageId||a.STAGE_ID||r.stageId||null,departmentHead:r.departmentHead||null,departmentHeadFull:r.departmentHeadFull||r.departmentHead||null};e[t].push(i)}});try{const a=tt();a&&ct()&&a.logZeroPoint(e)}catch(a){Ee.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",a)}return e}function hn(o){if(!Array.isArray(o))return[];const e=new Set,a=[],t=[];o.forEach(i=>{const n=ma(i),l=Ua(n);!n||n===null||n===void 0?a.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}):l===ta&&t.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}),l&&e.add(l)});const r=Array.from(e);try{const i=tt();i&&ct()&&i.logEmployees(r,a,t)}catch(i){Ee.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",i)}return r}const na=new Map,fn=10*60*1e3;function vn(o){if(!o||typeof o!="object")return{};const e={},a=Object.keys(o);for(const t of a)t.toUpperCase().startsWith("UF_")&&(e[t]=o[t]);return e}function pn(o,e=null,a=!0){if(a&&e&&na.has(e)){const i=na.get(e),n=Date.now();if(i.timestamp&&n-i.timestamp<fn)return i.data;na.delete(e)}const t=vn(o),r={typeProduct:t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||null,all:t};return a&&e&&na.set(e,{data:r,timestamp:Date.now()}),r}class yn{static async getTicketDetails(e,a={}){const{select:t=["*"],useOriginalUfNames:r=!0,useCache:i=!0}=a;try{const n=await Lt.getTicket(e);if(!n)throw new Error(`Тикет с ID ${e} не найден`);const l=pn(n,e,i),d=n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.ufCrm7UfPriority||n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.priority||n.PRIORITY||null,g=La(d),v=bs(g);return{id:n.id||n.ID,title:n.title||n.TITLE,stageId:n.stageId||n.STAGE_ID,assignedById:n.assignedById||n.ASSIGNED_BY_ID,createdAt:n.createdTime||n.CREATED_TIME||n.CREATED_DATE,updatedAt:n.updatedTime||n.UPDATED_TIME||n.MODIFY_DATE,priorityId:g.id,priorityLabel:g.label,priorityColors:v,priority:g.id,priorityBitrixValue:g.bitrixValue||null,opportunity:n.opportunity||n.OPPORTUNITY,currencyId:n.currencyId||n.CURRENCY_ID,comments:n.comments||n.COMMENTS,additionalFields:l,rawData:n}}catch(n){throw Ee.error("Error getting ticket details","TicketDetailsService",n),n}}}let Bt=class{static async getSectorData(e=!0,a=!1,t=null){let r=!1;try{if(ct()){const i=tt();i&&i.reset()}}catch(i){Ee.warn("Error resetting diagnostics","DashboardSector1CService",i)}if(t&&t(Ke("cache_check",0,{description:"Инициализация загрузки..."})),e){const i=Oe.getSectorDataCacheKey(),n=Oe.get(i);if(n!==null)return t&&t(Ke("cache_hit",100,{description:"Данные загружены из in-memory кеша"})),n}try{t&&t(Ke("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const i=ho(),n=await Lt.getAllTickets(i,p=>{if(t){const y=ga(p),S=Pa(10,40,y.progress||0);t(Ke(y.step||"loading_tickets",S,{...y.details,warning:y.details.warning}))}},e);t&&t(Ke("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const l=sn(n,{id:"1c",name:"1C",filterValue:"1C",filterField:"UF_CRM_7_TYPE_PRODUCT"});t&&t(Ke("filtering",50,{totalTickets:n.length,filteredTickets:l.length,description:`Отфильтровано ${l.length} тикетов из ${n.length}`})),t&&t(Ke("extracting_employees",60,{filteredTickets:l.length,description:`Анализ ${l.length} тикетов для определения сотрудников...`}));const d=hn(l);t&&t(Ke("extracting_employees",60,{employeeCount:d.length,description:`Найдено ${d.length} уникальных сотрудников`})),t&&t(Ke("loading_employees",65,{employeeCount:d.length,description:`Загрузка данных ${d.length} сотрудников...`})),Cs();const g=await Jo.getEmployeesByIds(d),v=tn(g);t&&t(Ke("loading_employees",90,{employeeCount:v.length,description:`Загружено данных ${v.length} сотрудников`})),t&&t(Ke("grouping",90,{filteredTickets:l.length,employeeCount:v.length,description:`Группировка ${l.length} тикетов по этапам и ${v.length} сотрудникам...`}));const f={stages:gn(l,v),employees:v,zeroPointTickets:mn(l)};if(t&&t(Ke("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),e){const p=Oe.getSectorDataCacheKey();Oe.set(p,f,Oe.TICKETS_TTL),r=!0}return t&&t(Ke("complete",100,{description:"Загрузка завершена"})),r&&!a&&CacheNotificationService.notifyCacheCreationSuccess("Дашборд сектора 1С"),f}catch(i){throw Ee.error("Error getting sector data","DashboardSector1CService",i),t&&t({step:"error",progress:0,error:i.message}),i}}static async assignTicket(e,a,t){try{const r=Za(t),i=await Lt.assignTicket(e,a,r);return i&&Oe.invalidateTicketsCache(),i}catch(r){throw Ee.error("Error assigning ticket","DashboardSector1CService",r),r}}static async createTicket(e){try{const a=Za(e.stageId||"formed"),t={title:e.title,stageId:a};e.employeeId&&(t.assignedById=e.employeeId);const r=await Lt.createTicket(t);return r>0&&Oe.invalidateTicketsCache(),r}catch(a){throw Ee.error("Error creating ticket","DashboardSector1CService",a),a}}static async getTicket(e){try{const a=await Lt.getTicket(e);return Ba(a)}catch(a){throw Ee.error("Error getting ticket","DashboardSector1CService",a),a}}static async getTicketDetails(e,a={}){try{return await yn.getTicketDetails(e,a)}catch(t){throw Ee.error("Error getting ticket details","DashboardSector1CService",t),t}}static async addComment(e,a){try{return(await Dt.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+fo,comment:a}})).result!==void 0}catch(t){throw Ee.error("Error adding comment","DashboardSector1CService",t),t}}};const Ss=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:Bt},Symbol.toStringTag,{value:"Module"}));class Ds{static normalizeSectorData(e,a){return e?{stages:this.normalizeStages(e.stages||[],a),employees:this.normalizeEmployees(e.employees||[],a),zeroPointTickets:this.normalizeTickets(e.zeroPointTickets||[],a),metrics:this.calculateMetrics(e,a),metadata:this.createMetadata(e,a)}:this.getEmptySectorData(a)}static normalizeStages(e,a){return Array.isArray(e)?e.map((t,r)=>{const i=a.stages?.[t.id]||{},n=r%this.STAGE_COLORS.length;return{id:t.id||`stage_${r}`,name:i.name||t.name||t.title||`Этап ${r+1}`,color:i.color||t.color||this.STAGE_COLORS[n],order:i.order||t.order||r,tickets:this.normalizeTickets(t.tickets||[],a),employees:this.normalizeEmployees(t.employees||[],a),metrics:this.calculateStageMetrics(t,a)}}).sort((t,r)=>(t.order||0)-(r.order||0)):[]}static normalizeEmployees(e,a){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`emp_${Math.random()}`,name:this.normalizeEmployeeName(t),department:t.department||t.UF_DEPARTMENT||a.defaultDepartment||"Unknown",load:t.load||t.currentLoad||0,avatar:t.avatar||t.PERSONAL_PHOTO||null,status:t.status||t.ACTIVE||"active",color:this.assignEmployeeColor(t,a)})):[]}static normalizeTickets(e,a){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`ticket_${Math.random()}`,title:this.normalizeTicketTitle(t),status:t.status||t.STATUS_ID||"new",priority:this.normalizePriority(t),assignedTo:t.assignedTo||t.ASSIGNED_BY_ID||t.assigned_to,createdAt:this.normalizeDate(t.createdAt||t.CREATED_DATE||t.DATE_CREATE),updatedAt:this.normalizeDate(t.updatedAt||t.UPDATED_DATE||t.TIMESTAMP_X),deadline:this.normalizeDate(t.deadline||t.DEADLINE),tags:this.extractTags(t,a),description:t.description||t.DETAIL_TEXT||t.COMMENTS||""})):[]}static normalizeEmployeeName(e){if(!e)return"Неизвестный сотрудник";const a=e.LAST_NAME||e.lastName||"",t=e.NAME||e.firstName||e.FIRST_NAME||"",r=`${a} ${t}`.trim();return r&&r!==" "?r:t||(e.LOGIN||e.login?e.LOGIN||e.login:`Сотрудник #${e.id||e.ID||"unknown"}`)}static normalizeTicketTitle(e){return e.title||e.TITLE||e.name||e.NAME||e.subject||e.SUBJECT||`Тикет ${e.id||e.ID||"без названия"}`}static normalizePriority(e){const a=e.priority||e.PRIORITY;return typeof a=="number"?Math.max(1,Math.min(5,a)):typeof a=="string"&&{low:1,lowest:1,normal:3,medium:3,high:4,highest:5,urgent:5,critical:5}[a.toLowerCase()]||3}static normalizeDate(e){if(!e)return null;try{const a=new Date(e);return isNaN(a.getTime())?null:a.toISOString()}catch{return null}}static extractTags(e,a){const t=[];return e.UF_CRM_7_TYPE_PRODUCT&&t.push(e.UF_CRM_7_TYPE_PRODUCT),(e.category||e.CATEGORY)&&t.push(e.category||e.CATEGORY),(e.type||e.TYPE)&&t.push(e.type||e.TYPE),e.priority&&typeof e.priority=="string"&&t.push(`priority:${e.priority}`),[...new Set(t)]}static assignEmployeeColor(e,a){const t=["#007bff","#28a745","#ffc107","#dc3545","#6c757d","#17a2b8"];if(e.department){const i=e.department.split("").reduce((n,l)=>(n=(n<<5)-n+l.charCodeAt(0),n&n),0);return t[Math.abs(i)%t.length]}const r=e.id||e.ID||0;return t[Math.abs(r)%t.length]}static calculateStageMetrics(e,a){const t=e.tickets||[],r=e.employees||[];return{ticketCount:t.length,employeeCount:r.length,averageLoad:r.length>0?t.length/r.length:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateMetrics(e,a){const t=[...e.zeroPointTickets||[],...(e.stages||[]).flatMap(l=>l.tickets||[])],r=t.length,i=e.employees?.length||0,n=(e.stages||[]).filter(l=>(l.tickets||[]).length>0).length;return{totalTickets:r,totalEmployees:i,activeStages:n,averageTicketsPerEmployee:i>0?r/i:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateCompletionRate(e){if(!e.length)return 0;const a=e.filter(t=>t.status==="closed"||t.status==="completed"||t.status==="done").length;return Math.round(a/e.length*100)}static countOverdueTickets(e){const a=new Date;return e.filter(t=>t.deadline?new Date(t.deadline)<a&&t.status!=="closed"&&t.status!=="completed":!1).length}static createMetadata(e,a){return{sectorId:a.id,sectorName:a.name,lastUpdated:new Date().toISOString(),dataVersion:"2.0",source:"universal-normalizer"}}static getEmptySectorData(e){return{stages:[],employees:[],zeroPointTickets:[],metrics:{totalTickets:0,totalEmployees:0,activeStages:0,averageTicketsPerEmployee:0,completionRate:0,overdueCount:0},metadata:this.createMetadata({},e)}}}Fe(Ds,"STAGE_COLORS",["#007bff","#ffc107","#28a745","#dc3545","#6c757d","#17a2b8","#e83e8c","#fd7e14"]);class Es{static async create(e){if(this.serviceCache.has(e))return this.serviceCache.get(e);const a=await this.createServiceInstance(e);return this.serviceCache.set(e,a),a}static async createServiceInstance(e){switch(e){case"1c":console.log("[SectorServiceFactory] Creating DashboardSector1CService for sector 1c");const{DashboardSector1CService:a}=await Ce(async()=>{const{DashboardSector1CService:n}=await Promise.resolve().then(()=>Ss);return{DashboardSector1CService:n}},void 0,import.meta.url);return new a;case"pdm":console.log("[SectorServiceFactory] Creating DashboardSectorPDMService for sector pdm");const{DashboardSectorPDMService:t}=await Ce(async()=>{const{DashboardSectorPDMService:n}=await import("./DashboardSectorPDMService-B0QQE_Wk.js");return{DashboardSectorPDMService:n}},__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);return new t;case"bitrix24":console.log("[SectorServiceFactory] Creating DashboardSectorBitrix24Service for sector bitrix24");const{DashboardSectorBitrix24Service:r}=await Ce(async()=>{const{DashboardSectorBitrix24Service:n}=await import("./DashboardSectorBitrix24Service-CfTuOUuw.js");return{DashboardSectorBitrix24Service:n}},__vite__mapDeps([8,1,2,3,4,5,6,7]),import.meta.url);return new r;case"infrastructure":console.log("[SectorServiceFactory] Creating DashboardSectorInfrastructureService for sector infrastructure");const{DashboardSectorInfrastructureService:i}=await Ce(async()=>{const{DashboardSectorInfrastructureService:n}=await import("./DashboardSectorInfrastructureService-DKTYy2to.js");return{DashboardSectorInfrastructureService:n}},__vite__mapDeps([9,1,2,3,4,5,6,7]),import.meta.url);return new i;default:throw new Error(`Unknown sector: ${e}`)}}static isServiceAvailable(e){return["1c","pdm","bitrix24","infrastructure"].includes(e)}static clearCache(){this.serviceCache.clear(),console.log("[SectorServiceFactory] Service cache cleared")}static getAvailableServices(){return{"1c":{type:"full",description:"Полнофункциональный сервис сектора 1С"},pdm:{type:"stub",description:"Заглушка сервиса сектора PDM"},bitrix24:{type:"stub",description:"Заглушка сервиса сектора Битрикс24"},infrastructure:{type:"stub",description:"Заглушка сервиса сектора Инфраструктура"}}}}Fe(Es,"serviceCache",new Map);class As{constructor(e){this.sectorId=e,this.cache=new Map,this.sectorService=null,this.initialized=!1}async initialize(){if(!this.initialized)try{this.sectorService=await Es.create(this.sectorId),this.initialized=!0,console.log(`[UniversalSectorDashboardService] Initialized for sector: ${this.sectorId}`)}catch(e){throw console.error(`[UniversalSectorDashboardService] Failed to initialize for sector ${this.sectorId}:`,e),e}}async getSectorDashboardData(e={}){const a=`dashboard:${this.sectorId}:${JSON.stringify(e)}`;if(!e.forceRefresh&&this.cache.has(a))return console.log(`[UniversalSectorDashboardService] Cache hit for dashboard data: ${this.sectorId}`),this.cache.get(a);try{console.log(`[UniversalSectorDashboardService] Loading dashboard data for sector: ${this.sectorId}`);let t;if(this.sectorId==="1c"){const{DashboardSector1CService:i}=await Ce(async()=>{const{DashboardSector1CService:n}=await Promise.resolve().then(()=>Ss);return{DashboardSector1CService:n}},void 0,import.meta.url);t=await i.getSectorData(!e.forceRefresh,!1,null)}else t=await this.sectorService.getSectorData(e);const r=this.normalizeSectorDataToDashboard(t);return this.cache.set(a,r),setTimeout(()=>{this.cache.delete(a)},5*60*1e3),console.log(`[UniversalSectorDashboardService] Returning dashboard data for ${this.sectorId}:`,{stages:r.stages?.length||0,employees:r.employees?.length||0,totalTickets:r.metadata?.totalTickets||0}),r}catch(t){throw console.error(`[UniversalSectorDashboardService] Failed to get dashboard data for ${this.sectorId}:`,t),t}}normalizeSectorDataToDashboard(e){const a=Ds.normalizeSectorData(e,{id:this.sectorId});return{stages:this.convertStagesToDashboardFormat(a.stages),employees:a.employees,zeroPointTickets:this.extractZeroPointTickets(a),metadata:{sectorId:this.sectorId,totalTickets:a.metrics?.totalTickets||0,totalEmployees:a.employees?.length||0,lastUpdated:new Date().toISOString()}}}convertStagesToDashboardFormat(e){return e.map(a=>({id:this.mapStageIdToDashboardId(a.id),name:a.name,color:a.color||"#666",employees:a.employees||[],tickets:a.tickets||[],metrics:{ticketCount:a.tickets?.length||0,employeeCount:a.employees?.length||0}}))}mapStageIdToDashboardId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution",formed:"formed",review:"review",execution:"execution",request:"formed",assessment:"review",deployment:"execution"}[e]||e}extractZeroPointTickets(e){const a={};return e.stages.forEach(t=>{const r=this.mapStageIdToDashboardId(t.id),i=t.tickets.filter(n=>!n.assignedTo||n.assignedTo===null||n.assignedTo==="");a[r]=i}),a}async updateTicketAssignment(e,a,t){try{const r=this.mapDashboardIdToStageId(a),i=await this.sectorService.updateTicketAssignment(e,r,t);return this.clearCache(),i}catch(r){throw console.error("[UniversalSectorDashboardService] Failed to update ticket assignment:",r),r}}mapDashboardIdToStageId(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||e}clearCache(){this.cache.clear(),console.log(`[UniversalSectorDashboardService] Cache cleared for sector: ${this.sectorId}`)}async createTicket(e){try{const a=await this.sectorService.createTicket({...e,sectorId:this.sectorId});return this.clearCache(),a}catch(a){throw console.error("[UniversalSectorDashboardService] Failed to create ticket:",a),a}}async getSectorStats(){try{const e=await this.getSectorDashboardData();return{totalTickets:e.metadata.totalTickets,totalEmployees:e.metadata.totalEmployees,stagesCount:e.stages.length,unassignedTickets:Object.values(e.zeroPointTickets).reduce((a,t)=>a+t.length,0),lastUpdated:e.metadata.lastUpdated}}catch(e){throw console.error("[UniversalSectorDashboardService] Failed to get sector stats:",e),e}}}Fe(As,"services",new Map);class $s{static async getService(e){if(!this.services.has(e)){const a=new As(e);await a.initialize(),this.services.set(e,a)}return this.services.get(e)}static clearAll(){this.services.clear()}}Fe($s,"services",new Map);function kn(o,e){if(console.log(`🔧 [useUniversalDashboardActions] Initialized for sector: ${e}`),!e)return console.error("❌ [useUniversalDashboardActions] Invalid sectorId:",e),bn(e,o);let a=null,t=null;const r=async()=>{if(!a&&!t)try{console.log(`🏭 [useUniversalDashboardActions] Creating service for sector: ${e}`),a=await $s.getService(e),console.log("✅ [useUniversalDashboardActions] Service created successfully")}catch(_){console.error("❌ [useUniversalDashboardActions] Failed to create service:",_),t=_,a={getSectorDashboardData:async()=>({stages:[],employees:[],zeroPointTickets:{},metadata:{sectorId:e,totalTickets:0,totalEmployees:0}})}}return a},i=async(_={})=>{try{console.log(`📡 [useUniversalDashboardActions] Starting data load for sector: ${e}`);const A=await r();console.log("🏭 [useUniversalDashboardActions] Service obtained:",A);const U=await A.getSectorDashboardData(_);return console.log("✅ [useUniversalDashboardActions] Dashboard data received:",U),o.updateStages&&o.updateStages(U.stages||[]),o.updateEmployees&&o.updateEmployees(U.employees||[]),o.updateZeroPointTickets&&o.updateZeroPointTickets(U.zeroPointTickets||{}),o.updateSectorStats&&o.updateSectorStats(U.metadata||{}),console.log(`✅ [useUniversalDashboardActions] Sector data loaded successfully for ${e}`,{stagesCount:(U.stages||[]).length,employeesCount:(U.employees||[]).length,ticketsCount:U.metadata?.totalTickets||0}),U}catch(A){throw console.error(`❌ [useUniversalDashboardActions] Failed to load sector data for ${e}:`,A),console.error("🔍 [useUniversalDashboardActions] Error details:",{message:A.message,stack:A.stack}),o.setError&&o.setError(A.message),A}},n=async(_,A,U=null)=>{try{await(await r()).updateTicketAssignment(_,A,U),console.log("✅ [useUniversalDashboardActions] Ticket assignment updated successfully"),await i({forceRefresh:!0})}catch(x){throw console.error("[useUniversalDashboardActions] Failed to update ticket assignment:",x),console.error("❌ [useUniversalDashboardActions] Failed to update ticket assignment:",x.message),x}},l=async _=>{try{const U=await(await r()).createTicket(_);return console.log(`✅ [useUniversalDashboardActions] Ticket created successfully: "${U.title}"`),await i({forceRefresh:!0}),U}catch(A){throw console.error("[useUniversalDashboardActions] Failed to create ticket:",A),console.error("❌ [useUniversalDashboardActions] Failed to create ticket:",A.message),A}},d=async(_,A,U=null)=>{try{if(!S(_,A))throw new Error("Перемещение тикета невозможно");await n(_.id,A,U),console.log(`✅ [useUniversalDashboardActions] Ticket moved to stage: "${k(A)}"`)}catch(x){throw console.error("[useUniversalDashboardActions] Failed to move ticket:",x),console.error("❌ [useUniversalDashboardActions] Failed to move ticket:",x.message),x}},g=async(_,A)=>{try{const U=await r(),x=T(_);if(!x)throw new Error("Тикет не найден");await U.updateTicketAssignment(_,x.stageId,A);const D=o.getEmployeeById(A),E=D?D.name:"сотруднику";console.log(`✅ [useUniversalDashboardActions] Ticket assigned to: ${E}`),await i({forceRefresh:!0})}catch(U){throw console.error("[useUniversalDashboardActions] Failed to assign ticket:",U),console.error("❌ [useUniversalDashboardActions] Failed to assign ticket:",U.message),U}},v=async()=>{try{(await r()).clearCache(),console.log("✅ [useUniversalDashboardActions] Sector cache cleared successfully"),await i({forceRefresh:!0})}catch(_){throw console.error("[useUniversalDashboardActions] Failed to clear cache:",_),console.error("❌ [useUniversalDashboardActions] Failed to clear cache:",_.message),_}},C=async()=>{try{return await(await r()).getSectorStats()}catch(_){throw console.error("[useUniversalDashboardActions] Failed to get sector stats:",_),_}},f=()=>{Ce(async()=>{const{useRouter:_}=await import("./chunk-DgW6SZr3.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/state")}).catch(_=>{console.error("Failed to navigate to graph state:",_)})},p=()=>{Ce(async()=>{const{useRouter:_}=await import("./chunk-DgW6SZr3.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/admission-closure")}).catch(_=>{console.error("Failed to navigate to admission closure:",_)})},y=()=>{Ce(async()=>{const{useRouter:_}=await import("./chunk-DgW6SZr3.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/tickets/time-tracking")}).catch(_=>{console.error("Failed to navigate to tickets management:",_)})},S=(_,A)=>!(!_||!A||_.stageId===A),T=_=>{for(const A of o.stages){const U=A.tickets?.find(x=>x.id===_);if(U)return{...U,stageId:A.id}}for(const[A,U]of Object.entries(o.zeroPointTickets)){const x=U.find(D=>D.id===_);if(x)return{...x,stageId:A}}return null},k=_=>{const A=o.getStageById(_);return A?A.name:_};return{loadSectorData:i,updateTicketAssignment:n,createTicket:l,moveTicket:d,assignTicketToEmployee:g,clearCache:v,getSectorStats:C,navigateToGraphState:f,navigateToAdmissionClosure:p,navigateToTicketsManagement:y,canMoveTicket:S,findTicket:T,getStageName:k}}function bn(o,e){return console.warn(`⚠️ [useUniversalDashboardActions] Using fallback actions for sector: ${o}`),{loadSectorData:async(t={})=>{console.log(`📡 [FallbackActions] Loading data for sector: ${o}`);try{return e?.setLoading&&e.setLoading(!0),await new Promise(r=>setTimeout(r,500)),e?.updateStages&&e.updateStages([]),e?.updateEmployees&&e.updateEmployees([]),e?.updateZeroPointTickets&&e.updateZeroPointTickets({}),e?.updateSectorStats&&e.updateSectorStats({sectorId:o,totalTickets:0,totalEmployees:0,name:o.toUpperCase()}),e?.setLoading&&e.setLoading(!1),console.log(`✅ [FallbackActions] Fallback data loaded for sector: ${o}`),{stages:[],employees:[],zeroPointTickets:{},metadata:{sectorId:o,totalTickets:0,totalEmployees:0,name:o.toUpperCase()}}}catch(r){throw console.error("❌ [FallbackActions] Error in fallback loadSectorData:",r),e?.setError&&e.setError("Ошибка загрузки данных"),r}},updateTicketAssignment:async()=>{throw new Error("Service unavailable")},createTicket:async()=>{throw new Error("Service unavailable")},moveTicket:async()=>{throw new Error("Service unavailable")},assignTicketToEmployee:async()=>{throw new Error("Service unavailable")},clearCache:async()=>{console.log("Cache cleared (fallback)")},navigateToGraphState:()=>{},navigateToAdmissionClosure:()=>{},navigateToTicketsManagement:()=>{},canMoveTicket:()=>!1,findTicket:()=>null,getStageName:()=>o}}const _n={name:"SectorDashboard",components:{BackButton:_s},props:{sectorId:{type:String,required:!0}},setup(o){const e=Xe(),a=qo(o.sectorId),t=kn(a,o.sectorId),r=I(()=>a.sectorStats?.name||o.sectorId.toUpperCase()),i=I(()=>a.totalTickets||0),n=I(()=>a.isLoading||!1),l=I(()=>a.error||null),d=I(()=>a.hasData||!1),g=I(()=>a.stages||[]),v=()=>{e.push("/")},C=()=>{t.loadSectorData()};return $e(()=>{console.log(`[SectorDashboard] Mounted for sector: ${o.sectorId}`),t.loadSectorData()}),{isLoading:n,error:l,hasData:d,totalTickets:i,stages:g,sectorName:r,handleGoHome:v,handleRetry:C,...t}}},wn={style:{background:"yellow",padding:"10px","margin-bottom":"10px",border:"2px solid red"}},Cn={class:"dashboard-header"},Tn={key:0,class:"sector-stats"},Sn={class:"stat-item"},Dn={class:"stat-value"},En={class:"dashboard-content"},An={key:0,class:"loading-indicator"},$n={key:1,class:"error-indicator"},In={key:2,class:"empty-state"},Mn={class:"empty-state-content"},Nn={key:3,class:"stages-container"},xn={class:"stage-header"},Ln={class:"stage-stats"},Pn={class:"stat"};function On(o,e,a,t,r,i){const n=be("BackButton");return c(),u("div",{class:X(`dashboard-sector-${a.sectorId}`)},[s("div",wn," 🚨 DEBUG: SectorDashboard RENDERED for sector: "+m(a.sectorId)+" at "+m(new Date().toISOString()),1),s("div",Cn,[s("h1",null,"Дашборд - Сектор "+m(t.sectorName),1)]),t.isLoading?$("",!0):(c(),u("div",Tn,[s("div",Sn,[s("div",Dn,m(t.totalTickets),1),e[2]||(e[2]=s("div",{class:"stat-label"},"Всего тикетов",-1))])])),s("div",En,[t.isLoading?(c(),u("div",An,[...e[3]||(e[3]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка данных сектора...",-1)])])):t.error?(c(),u("div",$n,[e[4]||(e[4]=s("div",{class:"error-icon"},"⚠️",-1)),s("p",null,"Ошибка загрузки: "+m(t.error),1),s("button",{onClick:e[0]||(e[0]=(...l)=>t.handleRetry&&t.handleRetry(...l)),class:"btn-retry"},"Повторить")])):t.hasData?(c(),u("div",Nn,[(c(!0),u(ee,null,te(t.stages,l=>(c(),u("div",{key:l.id,class:"stage-card",style:we({borderLeftColor:l.color})},[s("div",xn,[s("h3",null,m(l.name),1),s("div",Ln,[s("span",Pn,m(l.tickets?.length||0)+" тикетов",1)])])],4))),128))])):(c(),u("div",In,[s("div",Mn,[e[5]||(e[5]=s("div",{class:"empty-icon"},"📋",-1)),s("h3",null,'Сектор "'+m(t.sectorName)+'" в разработке',1),e[6]||(e[6]=s("p",null,"Этот сектор находится в стадии разработки.",-1)),s("button",{onClick:e[1]||(e[1]=(...l)=>t.handleRetry&&t.handleRetry(...l)),class:"btn-retry"},"Обновить данные")])]))]),ne(n,{variant:"floating"})],2)}const Rn=ce(_n,[["render",On],["__scopeId","data-v-a5b8e8cc"]]),Is="/api/tickets-time-tracking-sector-1c.php";function Bn(o){if(!o)return{meta:null,data:{totalElapsedTime:0,totalElapsedTimeUnit:"hours",totalRecordsCount:0,weeks:[],employeesSummary:[]}};const e=o.data||o.result||o,a=e.meta||o.meta||null;return{meta:{weekNumber:a?.weekNumber??null,weekStartUtc:a?.weekStartUtc??null,weekEndUtc:a?.weekEndUtc??null,totalWeeks:a?.totalWeeks??0,sector1CEmployeesCount:a?.sector1CEmployeesCount??0},data:{totalElapsedTime:e.data?.totalElapsedTime??e.totalElapsedTime??0,totalElapsedTimeUnit:e.data?.totalElapsedTimeUnit??e.totalElapsedTimeUnit??"hours",totalRecordsCount:e.data?.totalRecordsCount??e.totalRecordsCount??0,weeks:e.data?.weeks??e.weeks??[],employeesSummary:e.data?.employeesSummary??e.employeesSummary??[]}}}async function Un(o={}){const{product:e="1C",weekStartUtc:a=null,weekEndUtc:t=null,weeksCount:r=4}=o;try{const i=et(Is),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:e,weekStartUtc:a,weekEndUtc:t,weeksCount:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(l.error)throw new Error(l.error_description||l.error||"Unknown error");const d=Bn(l);if(l.cache_used===!0){const{CacheNotificationService:g}=await Ce(async()=>{const{CacheNotificationService:v}=await Promise.resolve().then(()=>ZA);return{CacheNotificationService:v}},void 0,import.meta.url);g.notifyCacheUsed("Трудозатраты на Тикеты сектора 1С")}return d}catch(i){throw console.error("[TimeTrackingService] Error fetching time tracking data:",i),i}}async function Wn({taskIds:o,employeeId:e,weekNumber:a,page:t=1,perPage:r=10}){if(!o||!Array.isArray(o)||o.length===0)return{tasks:[],pagination:{totalTasks:0,currentPage:1,perPage:r,totalPages:0}};try{const i=et(Is),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:"1C",includeTaskDetails:!0,taskIds:o,employeeId:e||void 0,weekNumber:a||void 0,page:t,perPage:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.error||l.error_description||"Ошибка получения данных о задачах");return{tasks:l.data.tasks||[],pagination:l.data.pagination||{totalTasks:0,currentPage:1,perPage:r,totalPages:0}}}catch(i){throw console.error("[timeTrackingService] Error loading tasks details:",i),i}}const Ms={getTimeTrackingData:Un,getTasksDetails:Wn};function qe(o,e=1){return typeof o!="number"||isNaN(o)?"0 ч":`${o.toFixed(e)} ч`}function ra(o,e){if(!o||!e)return`Неделя ${o||"?"}`;try{const a=new Date(e),t=new Date(a);t.setDate(t.getDate()+6);const r=a.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),i=t.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"});return`Неделя ${o} (${r} - ${i})`}catch(a){return console.error("[TimeTrackingUtils] Error formatting week label:",a),`Неделя ${o}`}}function Fn(o){return!o||!o.data?!1:o.data.totalRecordsCount>0||o.data.weeks&&o.data.weeks.length>0}const Hn={class:"ttt-summary"},jn={class:"summary-cards"},Vn={class:"summary-card summary-card--total"},zn={class:"summary-card__content"},Gn={class:"summary-card__value"},Kn={class:"summary-card summary-card--employees"},qn={class:"summary-card__content"},Yn={class:"summary-card__value"},Xn={class:"summary-card summary-card--average"},Jn={class:"summary-card__content"},Zn={class:"summary-card__value"},Qn={__name:"TicketsTimeTrackingSummary",props:{data:{type:Object,required:!0}},setup(o){const e=o,a=I(()=>e.data?.data?.totalElapsedTime||0),t=I(()=>e.data?.meta?.sector1CEmployeesCount||0),r=I(()=>{const l=a.value,d=t.value;return d>0?l/d:0}),i=I(()=>a.value===0?"0.0 ч":qe(a.value,1)),n=I(()=>r.value===0?"0.00 ч":qe(r.value,2));return(l,d)=>(c(),u("div",Hn,[s("div",jn,[s("div",Vn,[d[1]||(d[1]=s("div",{class:"summary-card__icon"},"⏱",-1)),s("div",zn,[d[0]||(d[0]=s("div",{class:"summary-card__label"},"Общая сумма трудозатрат",-1)),s("div",Gn,m(i.value),1)])]),s("div",Kn,[d[3]||(d[3]=s("div",{class:"summary-card__icon"},"👥",-1)),s("div",qn,[d[2]||(d[2]=s("div",{class:"summary-card__label"},"Сотрудников в секторе",-1)),s("div",Yn,m(t.value),1)])]),s("div",Xn,[d[5]||(d[5]=s("div",{class:"summary-card__icon"},"📊",-1)),s("div",Jn,[d[4]||(d[4]=s("div",{class:"summary-card__label"},"Средняя на сотрудника",-1)),s("div",Zn,m(n.value),1)])])])]))}},er=ce(Qn,[["__scopeId","data-v-51b124c7"]]),tr={class:"ttt-table-container"},ar={key:0,class:"ttt-table-loading"},sr={key:1,class:"ttt-table-error"},or={key:2,class:"ttt-table-empty"},nr={key:3,class:"ttt-table-wrapper"},rr={class:"ttt-table"},ir=["onClick"],lr={class:"ttt-table__header-week-date"},cr=["onClick"],dr={class:"ttt-table__cell-employee"},ur=["onClick"],gr={class:"ttt-table__cell-total"},mr={class:"ttt-table__row-total"},hr=["onClick"],fr={class:"ttt-table__cell-total"},vr={__name:"TicketsTimeTrackingTable",props:{data:{type:Object,required:!0},loading:{type:Boolean,default:!1},error:{type:String,default:null}},emits:["cell-click","employee-click","week-click"],setup(o,{emit:e}){const a=o,t=e,r=I(()=>a.data?.data?.weeks||[]),i=I(()=>{if(!a.data||!a.data.data||!a.data.data.weeks)return null;const f=a.data.data.weeks||[],y=(a.data.data.employeesSummary||[]).map(k=>{const _={};let A=0;return f.forEach(U=>{const D=U.employees?.find(E=>E.id===k.id)?.elapsedTime||0;_[U.weekNumber]=D,A+=D}),{id:k.id,name:k.name,weeks:_,total:A}}),S={};let T=0;return f.forEach(k=>{S[k.weekNumber]=k.totalElapsedTime||0,T+=k.totalElapsedTime||0}),{employees:y,weekTotals:S,grandTotal:T}}),n=(f,p)=>i.value?.employees.find(S=>S.id===f)?.weeks[p]||0,l=f=>i.value?.weekTotals[f]||0,d=f=>{if(!f)return"";try{return new Date(f).toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}catch{return""}},g=(f,p)=>{const y=i.value?.employees.find(T=>T.id===f),S=a.data?.data?.weeks?.find(T=>T.weekNumber===p);y&&S&&t("cell-click",{employee:y,week:S,elapsedTime:n(f,p)})},v=f=>{const p=i.value?.employees.find(y=>y.id===f);p&&t("employee-click",{employee:p,weeks:r.value.map(y=>({week:y,elapsedTime:n(f,y.weekNumber)}))})},C=f=>{const p=r.value.find(y=>y.weekNumber===f);p&&t("week-click",{week:p,employees:i.value?.employees.map(y=>({employee:y,elapsedTime:n(y.id,f)})).filter(y=>y.elapsedTime>0)})};return(f,p)=>(c(),u("div",tr,[o.loading?(c(),u("div",ar," Загрузка данных... ")):o.error?(c(),u("div",sr,m(o.error),1)):!i.value||i.value.employees.length===0?(c(),u("div",or," Нет данных о трудозатратах за выбранный период ")):(c(),u("div",nr,[s("table",rr,[s("thead",null,[s("tr",null,[p[1]||(p[1]=s("th",{class:"ttt-table__header-employee"},"Сотрудник",-1)),(c(!0),u(ee,null,te(r.value,y=>(c(),u("th",{key:y.weekNumber,class:X(["ttt-table__header-week",{"ttt-table__header--clickable":!0}]),onClick:S=>C(y.weekNumber)},[ge(" Неделя "+m(y.weekNumber),1),p[0]||(p[0]=s("br",null,null,-1)),s("span",lr,m(d(y.weekStartUtc)),1)],8,ir))),128)),p[2]||(p[2]=s("th",{class:"ttt-table__header-total"},"Итого",-1))])]),s("tbody",null,[(c(!0),u(ee,null,te(i.value.employees,y=>(c(),u("tr",{key:y.id,class:X(["ttt-table__row",{"ttt-table__row--clickable":!0}]),onClick:S=>v(y.id)},[s("td",dr,m(y.name),1),(c(!0),u(ee,null,te(r.value,S=>(c(),u("td",{key:`${y.id}-${S.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:Te(T=>g(y.id,S.weekNumber),["stop"])},m(Ue(qe)(n(y.id,S.weekNumber))),9,ur))),128)),s("td",gr,[s("strong",null,m(Ue(qe)(y.total)),1)])],8,cr))),128)),s("tr",mr,[p[3]||(p[3]=s("td",{class:"ttt-table__cell-employee"},[s("strong",null,"ВСЕГО")],-1)),(c(!0),u(ee,null,te(r.value,y=>(c(),u("td",{key:`total-${y.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:S=>C(y.weekNumber)},[s("strong",null,m(Ue(qe)(l(y.weekNumber))),1)],8,hr))),128)),s("td",fr,[s("strong",null,m(Ue(qe)(i.value.grandTotal)),1)])])])])]))]))}},pr=ce(vr,[["__scopeId","data-v-8021e5e4"]]),yr={class:"modal-header"},kr={class:"modal-body"},br={key:"level-1",class:"detail-cell"},_r={class:"detail-info"},wr={key:0,class:"tasks-list"},Cr={class:"task-header"},Tr={class:"task-label"},Sr={class:"task-time"},Dr={key:0,class:"ticket-info"},Er={class:"ticket-label"},Ar=["title"],$r={key:1,class:"ticket-title"},Ir={key:1,class:"ticket-info ticket-info--no-ticket"},Mr={class:"detail-total"},Nr={key:0,class:"detail-actions"},xr={key:"level-2",class:"tasks-list-level"},Lr={class:"tasks-list-header"},Pr={class:"tasks-list-title"},Or={class:"tasks-list-content"},Rr={key:"loading",class:"loading-state"},Br={key:"error",class:"error-state"},Ur={class:"error-message"},Wr={key:"empty",class:"empty-state"},Fr={key:"tasks",class:"tasks-cards-container"},Hr=["onClick"],jr={class:"task-card__header"},Vr={class:"task-card__number"},zr={key:0,class:"task-card__time"},Gr={class:"task-card__title"},Kr={class:"task-card__dates"},qr={class:"task-card__date-item"},Yr={class:"date-value"},Xr={class:"task-card__date-item"},Jr={class:"task-card__date-item"},Zr={class:"date-value"},Qr={key:0,class:"task-card__ticket"},ei={class:"ticket-header"},ti={class:"ticket-header__left"},ai={class:"ticket-id"},si=["title"],oi={class:"ticket-title"},ni={class:"ticket-meta"},ri={class:"ticket-meta__row"},ii={class:"ticket-meta__item"},li={class:"meta-value"},ci={class:"ticket-meta__item"},di={class:"meta-value"},ui={class:"ticket-meta__row"},gi={class:"ticket-meta__item"},mi={class:"meta-value"},hi={class:"ticket-meta__item"},fi={class:"meta-value"},vi={class:"ticket-dates"},pi={class:"ticket-date-item"},yi={class:"date-value"},ki={key:1,class:"task-card__no-ticket"},bi={key:0,class:"tasks-pagination"},_i=["disabled"],wi={class:"pagination-pages"},Ci=["onClick"],Ti=["disabled"],Si={key:"employee",class:"detail-employee"},Di={class:"detail-info"},Ei={class:"weeks-list"},Ai={class:"week-header"},$i={class:"week-label"},Ii={class:"week-time"},Mi={key:"week",class:"detail-week"},Ni={class:"detail-info"},xi={class:"employees-list"},Li={class:"employee-header"},Pi={class:"employee-label"},Oi={class:"employee-time"},Ri={__name:"TimeTrackingDetailModal",props:{cellData:{type:Object,default:null}},emits:["close"],setup(o,{emit:e}){const a=o,t=e,r=M(1),i=M([]),n=M(!1),l=M(null),d=M(1),g=M(10),v=I(()=>{if(!a.cellData)return"Детализация трудозатрат";if(r.value===2)return`Список задач: ${a.cellData.employee?.name||"Сотрудник"}, Неделя ${a.cellData.week?.weekNumber||"?"}`;if(a.cellData.type==="employee")return`Детализация: ${a.cellData.employee?.name||"Сотрудник"}`;if(a.cellData.type==="week")return`Детализация: Неделя ${a.cellData.week?.weekNumber||"?"}`;const Y=a.cellData.employee?.name||"Сотрудник",H=a.cellData.week?.weekNumber||"?",Z=qe(a.cellData.elapsedTime||0);return`Детализация: ${Y}, Неделя ${H} (${Z})`}),C=I(()=>a.cellData?.week?.employees&&a.cellData.week.employees.find(H=>H.id===a.cellData.employee?.id)?.tasksCount||0),f=I(()=>a.cellData?.week?.employees&&a.cellData.week.employees.find(H=>H.id===a.cellData.employee?.id)?.ticketsCount||0);I(()=>a.cellData?.week?.weekNumber||null);const p=M({totalTasks:0,currentPage:1,perPage:10,totalPages:0}),y=I(()=>p.value.totalPages),S=I(()=>i.value),T=I(()=>{const Y=[];let Z=Math.max(1,p.value.currentPage-Math.floor(2.5)),fe=Math.min(y.value,Z+5-1);fe-Z<4&&(Z=Math.max(1,fe-5+1));for(let P=Z;P<=fe;P++)Y.push(P);return Y}),k=Y=>{if(!Y||Y.length===0)return"Период не указан";if(Y.length===1)return ra(Y[0].week.weekNumber,Y[0].week.weekStartUtc);const H=Y[0].week,Z=Y[Y.length-1].week;return`${ra(H.weekNumber,H.weekStartUtc)} - ${ra(Z.weekNumber,Z.weekStartUtc)}`},_=Y=>Y?ra(Y.weekNumber,Y.weekStartUtc):"Период не указан",A=Y=>{if(!Y)return"-";try{const H=new Date(Y);return isNaN(H.getTime())?"-":H.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})}catch(H){return console.warn("[TimeTrackingDetailModal] Error formatting date:",Y,H),"-"}},U=(Y,H)=>{if(H)try{const Z=new Date(H);if(!isNaN(Z.getTime()))return!1}catch{}if(!Y)return!1;try{const Z=new Date(Y);return isNaN(Z.getTime())?!1:new Date>Z}catch(Z){return console.warn("[TimeTrackingDetailModal] Error checking overdue:",Y,Z),!1}},x=Y=>{const H=Y.closedDate?new Date(Y.closedDate):null,Z=U(Y.deadline,Y.closedDate);return{"task-card--completed":!!H,"task-card--overdue":Z,"task-card--in-progress":!H&&!Z}},D=async()=>{r.value=2,await R()},E=()=>{r.value=1,i.value=[],l.value=null,d.value=1,p.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0}},L=Y=>!Y||typeof Y!="object"?!1:!Y.id||typeof Y.id!="number"?(console.warn("[TimeTrackingDetailModal] Invalid task (no ID):",Y),!1):!0,R=async()=>{if(!a.cellData?.week?.employees||!a.cellData.employee){l.value="Недостаточно данных для загрузки задач";return}n.value=!0,l.value=null;try{const Y=a.cellData.week.employees.find(fe=>fe.id===a.cellData.employee?.id);if(!Y){i.value=[];return}let H=[];if(Array.isArray(Y.tasks)&&Y.tasks.length>0&&(H=Y.tasks.map(fe=>typeof fe=="object"&&fe!==null&&fe.id?fe.id:typeof fe=="number"?fe:null).filter(fe=>fe!==null&&fe>0)),H.length===0){i.value=[];return}const Z=await Ms.getTasksDetails({taskIds:H,employeeId:a.cellData.employee.id,weekNumber:a.cellData.week.weekNumber,page:d.value,perPage:g.value});if(!Z||!Array.isArray(Z.tasks)){console.error("[TimeTrackingDetailModal] Invalid response format:",Z),l.value="Некорректный формат данных от сервера",i.value=[];return}i.value=Z.tasks.filter(L),p.value=Z.pagination||{totalTasks:0,currentPage:1,perPage:g.value,totalPages:0},d.value=p.value.currentPage}catch(Y){console.error("[TimeTrackingDetailModal] Error loading tasks details:",{error:Y,taskIds:a.cellData?.week?.employees?.find(Z=>Z.id===a.cellData.employee?.id)?.tasks?.map(Z=>Z.id)||[],employeeId:a.cellData.employee?.id,weekNumber:a.cellData.week?.weekNumber,timestamp:new Date().toISOString()});const H=Y.message||"";H.includes("network")||H.includes("fetch")||H.includes("Failed to fetch")?l.value="Ошибка сети. Проверьте подключение к интернету.":H.includes("timeout")?l.value="Превышено время ожидания. Попробуйте позже.":H.includes("403")||H.includes("401")?l.value="Ошибка доступа. Проверьте права доступа.":H.includes("404")?l.value="Данные не найдены.":H.includes("500")?l.value="Ошибка сервера. Попробуйте позже.":l.value=H||"Ошибка загрузки задач",i.value=[]}finally{n.value=!1}},W=()=>{d.value=1,R()};Ne(d,()=>{r.value===2&&R()});const G=Y=>{if(Y>=1&&Y<=y.value&&Y!==d.value){d.value=Y;const H=document.querySelector(".tasks-cards-container");H&&(H.scrollTop=0)}},q=Y=>{console.log("[TimeTrackingDetailModal] Task clicked:",Y.id)},oe=()=>{t("close")};return Ne(()=>a.cellData,Y=>{Y||(r.value=1,i.value=[],l.value=null,d.value=1,p.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0})}),(Y,H)=>(c(),he(It,{to:"body"},[o.cellData?(c(),u("div",{key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true",onClick:Te(oe,["self"]),onKeydown:Be(oe,["esc"])},[s("div",{class:"modal-content",onClick:H[2]||(H[2]=Te(()=>{},["stop"]))},[s("div",yr,[s("h2",null,m(v.value),1),s("button",{class:"close-button",onClick:oe,"aria-label":"Закрыть"},"×")]),s("div",kr,[ne(Ae,{name:"level",mode:"out-in"},{default:ye(()=>[r.value===1&&(o.cellData.type==="cell"||!o.cellData.type&&o.cellData.employee&&o.cellData.week)?(c(),u("div",br,[s("div",_r,[s("p",null,[H[3]||(H[3]=s("strong",null,"Сотрудник:",-1)),ge(" "+m(o.cellData.employee?.name||"Неизвестно"),1)]),s("p",null,[H[4]||(H[4]=s("strong",null,"Неделя:",-1)),ge(" "+m(o.cellData.week?.weekNumber||"?"),1)]),s("p",null,[H[5]||(H[5]=s("strong",null,"Трудозатраты:",-1)),ge(" "+m(Ue(qe)(o.cellData.elapsedTime||0)),1)])]),o.cellData.week?.employees?(c(),u("div",wr,[H[8]||(H[8]=s("h3",null,"Задачи и связанные тикеты:",-1)),(c(!0),u(ee,null,te(o.cellData.week.employees.filter(Z=>Z.id===o.cellData.employee?.id),Z=>(c(),u("div",{key:Z.id,class:"employee-tasks"},[(c(!0),u(ee,null,te(Z.tasks,(fe,P)=>(c(),u("div",{class:"task-item",key:P},[s("div",Cr,[s("span",Tr,"Задача #"+m(fe.id||P+1),1),s("span",Sr,m(Ue(qe)(fe.elapsedTime||0)),1)]),fe.ticket?(c(),u("div",Dr,[s("span",Er,"Тикет #"+m(fe.ticket.id),1),fe.ticket.createdWeek&&fe.ticket.createdWeek!==o.cellData.week.weekNumber?(c(),u("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${fe.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week.weekNumber}`}," (создан в неделе "+m(fe.ticket.createdWeek)+") ",9,Ar)):$("",!0),fe.ticket.title?(c(),u("div",$r,m(fe.ticket.title),1)):$("",!0)])):(c(),u("div",Ir,[...H[6]||(H[6]=[s("span",{class:"no-ticket-label"},"Тикет не связан",-1)])]))]))),128))]))),128)),s("div",Mr,[s("p",null,[H[7]||(H[7]=s("strong",null,"Итого:",-1)),ge(" "+m(Ue(qe)(o.cellData.elapsedTime||0))+" ("+m(C.value)+" задач, "+m(f.value)+" тикетов) ",1)])]),C.value>0?(c(),u("div",Nr,[s("button",{class:"btn btn-primary btn-tasks-list",onClick:D}," 📋 Список задач ")])):$("",!0)])):$("",!0)])):r.value===2?(c(),u("div",xr,[s("div",Lr,[s("button",{class:"btn-back",onClick:E,"aria-label":"Назад"}," ← Назад "),s("h3",Pr," Список задач: "+m(o.cellData.employee?.name||"Сотрудник")+", Неделя "+m(o.cellData.week?.weekNumber||"?"),1)]),s("div",Or,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[n.value?(c(),u("div",Rr,[...H[9]||(H[9]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка задач...",-1)])])):l.value?(c(),u("div",Br,[H[10]||(H[10]=s("div",{class:"error-icon"},"⚠️",-1)),H[11]||(H[11]=s("p",{class:"error-title"},"Ошибка загрузки",-1)),s("p",Ur,m(l.value),1),s("button",{class:"btn btn-retry",onClick:W},"Повторить")])):i.value.length===0?(c(),u("div",Wr,[...H[12]||(H[12]=[s("div",{class:"empty-state-icon"},"📋",-1),s("p",{class:"empty-state-message"},"Нет задач для отображения",-1)])])):(c(),u("div",Fr,[ne(Qe,{name:"task-card",tag:"div",class:"tasks-cards-list"},{default:ye(()=>[(c(!0),u(ee,null,te(S.value.filter(L),Z=>(c(),u("div",{key:Z.id,class:X(["task-card",x(Z)]),onClick:fe=>q(Z)},[s("div",jr,[s("span",Vr,"Задача #"+m(Z.id),1),Z.elapsedTime?(c(),u("span",zr,m(Ue(qe)(Z.elapsedTime)),1)):$("",!0)]),s("div",Gr,m(Z.title||"Без названия"),1),s("div",Kr,[s("div",qr,[H[13]||(H[13]=s("span",{class:"date-icon"},"📅",-1)),H[14]||(H[14]=s("span",{class:"date-label"},"Начало:",-1)),s("span",Yr,m(A(Z.startDate)),1)]),s("div",Xr,[H[15]||(H[15]=s("span",{class:"date-icon"},"⏰",-1)),H[16]||(H[16]=s("span",{class:"date-label"},"Дедлайн:",-1)),s("span",{class:X(["date-value",{"date-value--overdue":U(Z.deadline,Z.closedDate)}])},m(A(Z.deadline)||"-"),3)]),s("div",Jr,[H[17]||(H[17]=s("span",{class:"date-icon"},"✓",-1)),H[18]||(H[18]=s("span",{class:"date-label"},"Завершено:",-1)),s("span",Zr,m(A(Z.closedDate)||"-"),1)])]),Z.ticket?(c(),u("div",Qr,[s("div",ei,[s("div",ti,[s("span",ai,"Тикет #"+m(Z.ticket.id),1),Z.ticket.createdWeek&&Z.ticket.createdWeek!==o.cellData.week?.weekNumber?(c(),u("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${Z.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week?.weekNumber}`}," Создан в нед. "+m(Z.ticket.createdWeek),9,si)):$("",!0)])]),s("div",oi,m(Z.ticket.title||Z.ticket.ufSubject||"Без названия"),1),s("div",ni,[s("div",ri,[s("div",ii,[H[19]||(H[19]=s("span",{class:"meta-label"},"Сектор:",-1)),s("span",li,m(Z.ticket.ufSlaBlockStr||"Не указан"),1)]),s("div",ci,[H[20]||(H[20]=s("span",{class:"meta-label"},"Сервис:",-1)),s("span",di,m(Z.ticket.ufSlaServiceStr||"Не указан"),1)])]),s("div",ui,[s("div",gi,[H[21]||(H[21]=s("span",{class:"meta-label"},"Действие:",-1)),s("span",mi,m(Z.ticket.ufActionStr||"Не указано"),1)]),s("div",hi,[H[22]||(H[22]=s("span",{class:"meta-label"},"Приоритет:",-1)),s("span",fi,m(Z.ticket.ufCrm7UfPriority||"Не указан"),1)])])]),s("div",vi,[s("div",pi,[H[23]||(H[23]=s("span",{class:"date-icon"},"📅",-1)),H[24]||(H[24]=s("span",{class:"date-label"},"Создан:",-1)),s("span",yi,m(A(Z.ticket.createdTime)),1)])])])):(c(),u("div",ki,[...H[25]||(H[25]=[s("span",{class:"no-ticket-label"},"Тикет не связан",-1)])])),H[26]||(H[26]=s("div",{class:"task-card__status-placeholder"},null,-1))],10,Hr))),128))]),_:1}),y.value>1?(c(),u("div",bi,[s("button",{class:"pagination-btn",disabled:p.value.currentPage===1,onClick:H[0]||(H[0]=Z=>G(p.value.currentPage-1))}," ← Предыдущая ",8,_i),s("div",wi,[(c(!0),u(ee,null,te(T.value,Z=>(c(),u("button",{key:Z,class:X(["pagination-page",{"pagination-page--active":Z===p.value.currentPage}]),onClick:fe=>G(Z)},m(Z),11,Ci))),128))]),s("button",{class:"pagination-btn",disabled:p.value.currentPage===y.value,onClick:H[1]||(H[1]=Z=>G(p.value.currentPage+1))}," Следующая → ",8,Ti)])):$("",!0)]))]),_:1})])])):r.value===1&&o.cellData.type==="employee"?(c(),u("div",Si,[s("div",Di,[s("p",null,[H[27]||(H[27]=s("strong",null,"Сотрудник:",-1)),ge(" "+m(o.cellData.employee?.name||"Неизвестно"),1)]),s("p",null,[H[28]||(H[28]=s("strong",null,"Период:",-1)),ge(" "+m(k(o.cellData.weeks)),1)])]),s("div",Ei,[H[29]||(H[29]=s("h3",null,"Трудозатраты по неделям:",-1)),(c(!0),u(ee,null,te(o.cellData.weeks,Z=>(c(),u("div",{key:Z.week.weekNumber,class:"week-item"},[s("div",Ai,[s("span",$i,"Неделя "+m(Z.week.weekNumber),1),s("span",Ii,m(Ue(qe)(Z.elapsedTime||0)),1)])]))),128))])])):r.value===1&&o.cellData.type==="week"?(c(),u("div",Mi,[s("div",Ni,[s("p",null,[H[30]||(H[30]=s("strong",null,"Неделя:",-1)),ge(" "+m(o.cellData.week?.weekNumber||"?"),1)]),s("p",null,[H[31]||(H[31]=s("strong",null,"Период:",-1)),ge(" "+m(_(o.cellData.week)),1)]),s("p",null,[H[32]||(H[32]=s("strong",null,"Общие трудозатраты:",-1)),ge(" "+m(Ue(qe)(o.cellData.week?.totalElapsedTime||0)),1)])]),s("div",xi,[H[33]||(H[33]=s("h3",null,"Трудозатраты по сотрудникам:",-1)),(c(!0),u(ee,null,te(o.cellData.employees,Z=>(c(),u("div",{key:Z.employee.id,class:"employee-item"},[s("div",Li,[s("span",Pi,m(Z.employee.name),1),s("span",Oi,m(Ue(qe)(Z.elapsedTime||0)),1)])]))),128))])])):$("",!0)]),_:1})]),s("div",{class:"modal-footer"},[s("button",{class:"close-btn",onClick:oe},"Закрыть")])])],32)):$("",!0)]))}},Bi=ce(Ri,[["__scopeId","data-v-fc33390b"]]),Ui={class:"tickets-time-tracking-dashboard"},Wi={class:"dashboard-header"},Fi={class:"breadcrumbs-row"},Hi=["aria-label","aria-disabled","data-fallback","disabled"],ji={class:"breadcrumbs","aria-label":"Навигация"},Vi={key:"preloader",class:"time-tracking-preloader"},zi={key:"error",class:"error-state"},Gi={key:"empty",class:"empty-state"},Ki={key:"content",class:"dashboard-content"},qi={__name:"TicketsTimeTrackingDashboard",setup(o){const e=Xe(),a=M(!0),t=M(null),r=M(null),i=M(null),n=M(!1),l=I(()=>Fn(r.value)),d=async()=>{a.value=!0,t.value=null;const k=new Promise(_=>setTimeout(_,300));try{const[_,A]=await Promise.all([k,Ms.getTimeTrackingData({product:"1C",weeksCount:4})]);r.value=A}catch(_){console.error("[TicketsTimeTrackingDashboard] Error loading data:",_),t.value=_.message||"Не удалось загрузить данные"}finally{a.value=!1}},g=k=>{i.value=k},v=k=>{i.value={type:"employee",...k}},C=k=>{i.value={type:"week",...k}},f=()=>{i.value=null},p=I(()=>typeof window>"u"?!1:window.history.length>1),y=I(()=>p.value?"Вернуться назад":"Вернуться на главную"),S=()=>{n.value||(n.value=!0,p.value?e.go(-1):e.push({name:"dashboard-sector-1c"}),setTimeout(()=>{n.value=!1},300))},T=()=>{e.push("/")};return $e(()=>{d()}),(k,_)=>{const A=be("router-link");return c(),u("div",Ui,[s("div",Wi,[s("div",Fi,[s("button",{class:"btn-home-link",type:"button",onClick:T,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),_[7]||(_[7]=s("span",{class:"breadcrumb-separator"},"/",-1)),s("button",{class:"btn-back-link",type:"button",onClick:S,"aria-label":y.value,"aria-disabled":!p.value,"data-fallback":!p.value,disabled:n.value,title:"Назад"}," ← ",8,Hi),s("nav",ji,[ne(A,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:ye(()=>[..._[0]||(_[0]=[ge(" Дашборд сектора 1С ",-1)])]),_:1}),_[3]||(_[3]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:ye(()=>[..._[1]||(_[1]=[ge(" График состояния ",-1)])]),_:1}),_[4]||(_[4]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:ye(()=>[..._[2]||(_[2]=[ge(" График приёма и закрытий ",-1)])]),_:1}),_[5]||(_[5]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),_[6]||(_[6]=s("span",{class:"breadcrumb-current"},"Трудозатраты",-1))])])]),_[10]||(_[10]=s("h1",{class:"dashboard-title"},"Трудозатраты на Тикеты сектора 1С",-1)),$("",!0),ne(Ae,{name:"fade",mode:"out-in"},{default:ye(()=>[a.value?(c(),u("div",Vi,[..._[8]||(_[8]=[s("div",{class:"preloader-content"},[s("div",{class:"preloader-spinner"},[s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"})]),s("h3",{class:"preloader-title"},"Загрузка данных"),s("p",{class:"preloader-message"},"Получение данных о трудозатратах..."),s("div",{class:"preloader-dots"},[s("span",{class:"dot"}),s("span",{class:"dot"}),s("span",{class:"dot"})])],-1)])])):t.value?(c(),u("div",zi,[s("p",null,"Ошибка загрузки данных: "+m(t.value),1),s("button",{onClick:d,class:"retry-button"},"Повторить попытку")])):l.value?(c(),u("div",Ki,[r.value?(c(),he(er,{key:0,data:r.value},null,8,["data"])):$("",!0),r.value?(c(),he(pr,{key:1,data:r.value,loading:a.value,error:t.value,onCellClick:g,onEmployeeClick:v,onWeekClick:C},null,8,["data","loading","error"])):$("",!0)])):(c(),u("div",Gi,[..._[9]||(_[9]=[s("p",null,"Нет данных о трудозатратах за выбранный период",-1)])]))]),_:1}),i.value?(c(),he(Bi,{key:1,"cell-data":i.value,onClose:f},null,8,["cell-data"])):$("",!0)])}}},Ns=ce(qi,[["__scopeId","data-v-2f7848de"]]),Yi=Object.freeze(Object.defineProperty({__proto__:null,default:Ns},Symbol.toStringTag,{value:"Module"}));Je.register(Xs,Js,Zs,Qs,eo,to,ao,so,oo,no);Je.defaults.responsive=!0;Je.defaults.maintainAspectRatio=!1;Je.defaults.plugins.legend.display=!0;Je.defaults.plugins.legend.position="top";const J={primary:"#007bff",success:"#28a745",danger:"#dc3545",warning:"#ffc107",info:"#17a2b8",carryover:"#ff9800",successLight:"#6cbf47",carryoverLight:"#ffb74d",carryoverDark:"#f57c00"},ht={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class pt{static getApiBaseUrl(){return go()}static async createSnapshot(e,a,t={}){try{if(!e||typeof e!="object")throw new St("sectorData должен быть объектом","VALIDATION_ERROR");if(!a||!["week_start","week_end","manual","current"].includes(a))throw new St("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(e);if(!r.isValid)throw new St(`Ошибка валидации данных сектора: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const i=this.normalizeSectorData(e),l={metadata:this.generateSnapshotMetadata(a,t.createdBy,t.sectorId||ht.defaultSectorId),statistics:i.statistics,ticketIds:i.ticketIds,tickets:i.tickets},d=this.validateSnapshot(l);if(!d.isValid)throw new St(`Ошибка валидации слепка: ${d.errors.join(", ")}`,"VALIDATION_ERROR",{validation:d});d.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",d.warnings);const g=this.getApiBaseUrl(),v=await fetch(`${g}${ht.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:a,date:this.formatDate(new Date)})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const C=await v.json();if(!C.success)throw new Error(C.message||"Ошибка создания слепка");return C.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof St?r:new St(`Ошибка создания слепка: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(e,a){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?action=get&date=${t}&type=${a}`,n=await fetch(i,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success){if(l.message&&l.message.includes("не найден"))return null;throw new Error(l.message||"Ошибка получения слепка")}return l.data.snapshot}catch(t){throw console.error("SnapshotService.getSnapshot error:",t),t}}static async getAllSnapshots(e={}){try{const a=new URLSearchParams;a.append("action","list"),e.startDate&&a.append("startDate",this.formatDate(e.startDate)),e.endDate&&a.append("endDate",this.formatDate(e.endDate)),e.type&&a.append("type",e.type),e.sectorId?a.append("sectorId",e.sectorId):a.append("sectorId",ht.defaultSectorId);const r=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?${a.toString()}`,i=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=await i.json();if(!n.success)throw new Error(n.message||"Ошибка получения списка слепков");return(await Promise.all(n.data.snapshots.map(async d=>{try{return await this.getSnapshot(d.date,d.type)}catch(g){return console.warn(`Ошибка загрузки слепка ${d.date}/${d.type}:`,g),null}}))).filter(d=>d!==null).sort((d,g)=>new Date(d.metadata.createdAt)-new Date(g.metadata.createdAt))}catch(a){throw console.error("SnapshotService.getAllSnapshots error:",a),a}}static normalizeSectorData(e){const{stages:a=[],employees:t=[],zeroPointTickets:r={}}=e,i={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},n=[],l=[],d=[];a.forEach(C=>{const f=C.id;if(i[f]){let p=0;C.employees.forEach(y=>{const S=y.tickets||[];p+=S.length;let T=n.find(k=>k.id===y.id);T||(T={id:y.id,name:y.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(T)),S.forEach(k=>{l.push(k.id),d.push({id:k.id,title:k.title||"Без названия",assignedTo:{id:y.id,name:y.name},createdAt:k.createdAt||"",updatedAt:k.modifiedAt||k.updatedAt||""}),T.ticketsByStage[f]=(T.ticketsByStage[f]||0)+1,T.totalTickets+=1})}),i[f].count=p}});const g={unassigned:0,keeper:0,total:0};Object.values(r).forEach(C=>{Array.isArray(C)&&C.forEach(f=>{g.total+=1,f.assigneeId===1051||f.assignedById===1051?g.keeper+=1:g.unassigned+=1,l.push(f.id),d.push({id:f.id,title:f.title||"Без названия",assignedTo:f.assignedTo||f.assignedById?{id:f.assignedById||f.assigneeId,name:"Неизвестный"}:null,createdAt:f.createdAt||"",updatedAt:f.modifiedAt||f.updatedAt||""})})});const v=Object.values(i).reduce((C,f)=>C+f.count,0)+g.total;return{statistics:{stages:{...i,total:v},employees:n,zeroPoint:g},ticketIds:[...new Set(l)],tickets:d}}static generateSnapshotMetadata(e,a,t){const r=new Date,i=-r.getTimezoneOffset(),n=Math.floor(i/60),l=i%60,d=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(l).padStart(2,"0")}`,g=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${d}`;return{version:ht.snapshotVersion,createdAt:g,createdBy:a||{id:0,name:"Система"},type:e,sectorId:t,sectorName:t==="1C"?"Сектор 1С":`Сектор ${t}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("Некорректная дата");const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${r}`}static buildFilePath(e,a){const t=typeof e=="string"?new Date(e):e,r=t.getFullYear(),i=this.getWeekNumber(t),n=this.formatDate(e);let l;if(a==="current"){const d=new Date,g=`${String(d.getHours()).padStart(2,"0")}-${String(d.getMinutes()).padStart(2,"0")}-${String(d.getSeconds()).padStart(2,"0")}`;l=`current-state-${n}-${g}.json`}else if(a==="manual"){const d=new Date,g=`${String(d.getHours()).padStart(2,"0")}-${String(d.getMinutes()).padStart(2,"0")}-${String(d.getSeconds()).padStart(2,"0")}`;l=`manual-${n}-${g}.json`}else l=`${a}-${n}.json`;return a==="current"?`current/${l}`:`${r}/week-${i}/${l}`}static getWeekNumber(e){const a=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),t=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-t);const r=new Date(Date.UTC(a.getUTCFullYear(),0,1));return Math.ceil(((a-r)/864e5+1)/7)}static validateSnapshot(e){const a=[],t=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&a.push("Неверная версия формата данных"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&a.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(e.metadata.type)||a.push("Неверный тип слепка"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&a.push("Неверный идентификатор сектора"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&a.push("Неверная информация о создателе")):a.push("Отсутствуют метаданные слепка"),!e.statistics)a.push("Отсутствует статистика");else{if(!e.statistics.stages)a.push("Отсутствует статистика по этапам");else{const r=e.statistics.stages,i=(r.formed?.count||0)+(r.review?.count||0)+(r.execution?.count||0);r.total!==i&&t.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${r.total}`)}if(Array.isArray(e.statistics.employees)||a.push("Статистика по сотрудникам должна быть массивом"),!e.statistics.zeroPoint)a.push("Отсутствует статистика нулевой точки");else{const r=e.statistics.zeroPoint,i=(r.unassigned||0)+(r.keeper||0);r.total!==i&&t.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${r.total}`)}}if(Array.isArray(e.ticketIds)||a.push("ticketIds должен быть массивом"),!Array.isArray(e.tickets))a.push("tickets должен быть массивом");else{const r=new Set(e.ticketIds),i=new Set(e.tickets.map(n=>n.id));r.size!==i.size&&t.push("Количество ID в ticketIds не совпадает с количеством тикетов"),e.tickets.forEach((n,l)=>{n.id||a.push(`Тикет #${l}: отсутствует ID`),n.title||a.push(`Тикет #${l}: отсутствует заголовок`),(!n.assignedTo||!n.assignedTo.id)&&t.push(`Тикет #${l}: отсутствует ответственный (может быть в нулевой точке)`),n.createdAt||a.push(`Тикет #${l}: отсутствует дата создания`),n.updatedAt||a.push(`Тикет #${l}: отсутствует дата обновления`)})}return{isValid:a.length===0,errors:a,warnings:t}}static validateSectorData(e){const a=[],t=[];return!e||typeof e!="object"?(a.push("sectorData должен быть объектом"),{isValid:!1,errors:a,warnings:t}):(Array.isArray(e.stages)||a.push("stages должен быть массивом"),Array.isArray(e.employees)||a.push("employees должен быть массивом"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&a.push("zeroPointTickets должен быть объектом"),{isValid:a.length===0,errors:a,warnings:t})}static isValidISODate(e){if(typeof e!="string")return!1;const a=new Date(e);return!isNaN(a.getTime())&&e.includes("T")}static async deleteSnapshot(e,a){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}`,n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:t,type:a})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка удаления слепка");return!0}catch(t){throw console.error("SnapshotService.deleteSnapshot error:",t),t}}static async deleteSnapshotsByPeriod(e){try{const a=await this.getAllSnapshots(e);let t=0;for(const r of a)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&t++}catch(i){console.warn(`Ошибка удаления слепка ${r.metadata.createdAt}:`,i)}return t}catch(a){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",a),a}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,a=ht.snapshotVersion){const t=this.getSnapshotVersion(e);return t===a||t==="1.0"&&a==="1.0"?e:(console.warn(`Миграция с версии ${t} на ${a} пока не реализована`),{...e,metadata:{...e.metadata,version:a}})}static getWeekNumberInfo(e){const a=typeof e=="string"?new Date(e):e,t=this.getWeekNumber(a);return{year:a.getFullYear(),week:t}}static getWeekStartDate(e){const a=typeof e=="string"?new Date(e):e,r=(a.getDay()||7)-1,i=new Date(a);return i.setDate(a.getDate()-r),i.setHours(0,0,0,0),i}static getWeekEndDate(e){const a=typeof e=="string"?new Date(e):e,r=7-(a.getDay()||7),i=new Date(a);return i.setDate(a.getDate()+r),i.setHours(23,59,59,999),i}static async getSnapshotsForWeek(e){try{const a=this.getWeekStartDate(e),t=this.getWeekEndDate(e),r=this.getWeekNumberInfo(e),i=await this.getAllSnapshots({startDate:a,endDate:t}),n=i.find(g=>g.metadata.type==="week_start")||null,l=i.find(g=>g.metadata.type==="week_end")||null,d=i.filter(g=>g.metadata.type==="manual");return{weekStart:n,weekEnd:l,manual:d,weekInfo:r}}catch(a){throw console.error("SnapshotService.getSnapshotsForWeek error:",a),a}}static handleError(e){if(e instanceof St)return{message:e.message,code:e.code,details:e.details};let a="UNKNOWN_ERROR";return e.message.includes("валидац")?a="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("не найден")?a="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?a="API_ERROR":e.message.includes("версия")||e.message.includes("version")?a="VERSION_MISMATCH":(e.message.includes("доступ")||e.message.includes("permission"))&&(a="PERMISSION_DENIED"),{message:e.message||"Неизвестная ошибка",code:a,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const a=await this.getAllSnapshots(e),t={week_start:0,week_end:0,manual:0,current:0},r=new Map;let i=null,n=null;a.forEach(d=>{const g=d.metadata.type;t.hasOwnProperty(g)&&t[g]++;const v=this.getWeekNumberInfo(d.metadata.createdAt),C=`${v.year}-W${v.week}`;r.set(C,(r.get(C)||0)+1);const f=new Date(d.metadata.createdAt);(!i||f<new Date(i.metadata.createdAt))&&(i=d),(!n||f>new Date(n.metadata.createdAt))&&(n=d)});const l=Array.from(r.entries()).map(([d,g])=>{const[v,C]=d.split("-W");return{year:parseInt(v),week:parseInt(C),count:g}}).sort((d,g)=>d.year!==g.year?d.year-g.year:d.week-g.week);return{total:a.length,byType:t,byWeek:l,oldest:i,newest:n}}catch(a){throw console.error("SnapshotService.getSnapshotsStatistics error:",a),a}}}class St extends Error{constructor(e,a,t={}){super(e),this.name="SnapshotError",this.code=a,this.details=t}}const ft={formed:{bitrixId:Ta.formed,name:Ca.FORMED.name},review:{bitrixId:Ta.review,name:Ca.REVIEW.name},execution:{bitrixId:Ta.execution,name:Ca.EXECUTION.name}},ea=ta;function Xi(o){if(!o||typeof o!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!o.stages||!Array.isArray(o.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Ji(o.stages),a=Zi(o.stages),t=Qi(o.zeroPointTickets||{}),r=el(o.zeroPointTickets||{}),i=tl(o.stages,o.zeroPointTickets||{});return{statistics:{stages:e,employees:a,zeroPoint:t,zeroPointByStage:r},ticketIds:i.ticketIds,tickets:i.tickets}}function Ji(o){const e={formed:{count:0,stageId:ft.formed.bitrixId,stageName:ft.formed.name},review:{count:0,stageId:ft.review.bitrixId,stageName:ft.review.name},execution:{count:0,stageId:ft.execution.bitrixId,stageName:ft.execution.name},total:0};return o.forEach(a=>{if(!ft[a.id]){console.warn(`Unknown stage ID: ${a.id}`);return}let t=0;a.employees&&Array.isArray(a.employees)&&a.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(t+=r.tickets.length)}),e[a.id].count=t,e.total+=t}),e}function Zi(o){const e=new Map;return o.forEach(a=>{!a.employees||!Array.isArray(a.employees)||a.employees.forEach(t=>{if(!t||!t.id)return;e.has(t.id)||e.set(t.id,{id:t.id,name:t.name||`Сотрудник #${t.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=e.get(t.id),i=t.tickets&&Array.isArray(t.tickets)?t.tickets.length:0;ft[a.id]&&(r.ticketsByStage[a.id]=(r.ticketsByStage[a.id]||0)+i),r.totalTickets+=i})}),Array.from(e.values())}function Qi(o){let e=0,a=0;return!o||typeof o!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(o).forEach(t=>{Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e++:(typeof i=="object"?i.id:i)===ea?a++:e++})}),{unassigned:e,keeper:a,total:e+a})}function el(o){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!o||typeof o!="object"||Object.keys(e).forEach(a=>{const t=o[a];Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e[a].unassigned++:(typeof i=="object"?i.id:i)===ea?e[a].keeper++:e[a].unassigned++,e[a].total++})}),e}function tl(o,e){const a=new Set,t=new Map;return Array.isArray(o)&&o.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(i=>{!i.tickets||!Array.isArray(i.tickets)||i.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID:",n.id);return}a.add(l);let d=n.assignedTo;!d&&i.id&&(d={id:i.id,name:i.name||`Сотрудник #${i.id}`}),t.set(l,{id:l,title:n.title||"Без названия",assignedTo:d||null,createdAt:ia(n.createdAt||n.createdTime),updatedAt:ia(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||r.id||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(r=>{Array.isArray(r)&&r.forEach(i=>{if(!i||!i.id){console.warn("Ticket without ID found in zero point:",i);return}const n=parseInt(i.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",i.id);return}a.add(n);let l=i.assignedTo;if(!l&&i.assignedById){const d=typeof i.assignedById=="object"?i.assignedById.id||i.assignedById.value:i.assignedById;d&&d!==ea?l={id:d,name:"Неизвестный"}:d===ea&&(l={id:ea,name:"Хранитель объектов"})}t.set(n,{id:n,title:i.title||"Без названия",assignedTo:l||null,createdAt:ia(i.createdAt||i.createdTime),updatedAt:ia(i.updatedAt||i.modifiedAt||i.updatedTime),stageId:i.stageId||null,departmentHead:i.departmentHead||null,departmentHeadFull:i.departmentHeadFull||i.departmentHead||null,priorityId:i.priorityId||null,priorityLabel:i.priorityLabel||null,service:i.service||null,serviceLabel:i.serviceLabel||null})})}),{ticketIds:Array.from(a).sort((r,i)=>r-i),tickets:Array.from(t.values())}}function ia(o){if(!o)return null;if(o instanceof Date)return o.toISOString();if(typeof o=="string"){if(o.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return o;const e=new Date(o);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",o),null}class Wa{static async getSectorDataForSnapshot(e={}){const{useCache:a=!0,useBackendCache:t=!1,onProgress:r=null,normalize:i=!0,includeTicketDetails:n=!1}=e;try{const l=await Bt.getSectorData(a,t,r);return i?Xi(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const e=await Bt.getSectorData(!0);return e!=null}catch{return!1}}}class Aa{static compareTwoSnapshots(e,a,t={}){const{includeTickets:r=!1,includeEmployees:i=!0}=t,n=this.validateSnapshot(e),l=this.validateSnapshot(a);if(!n.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...l.errors].join(", "));const d=this.buildComparisonMetadata(e,a),g=this.compareStages(e.statistics.stages,a.statistics.stages),v=i?this.compareEmployees(e.statistics.employees||[],a.statistics.employees||[]):[],C=this.compareZeroPoint(e.statistics.zeroPoint||{},a.statistics.zeroPoint||{}),f=r?this.compareTickets(e.ticketIds||[],a.ticketIds||[],e.tickets||[],a.tickets||[]):null,p=this.buildSummary(g,v,C,f);return{metadata:d,stages:g,employees:v,zeroPoint:C,tickets:f,summary:p}}static calculateDelta(e,a){const t=this.normalizeValue(e),r=this.normalizeValue(a),i=r-t;let n=0;t!==0?n=i/t*100:r!==0&&(n=r>0?1/0:-1/0);const l=this.getTrend(i);return{value1:t,value2:r,delta:i,deltaPercent:Math.round(n*100)/100,trend:l}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,a){const t=["formed","review","execution"],r={};for(const l of t){const d=e[l]?.count||0,g=a[l]?.count||0;r[l]=this.calculateDelta(d,g)}const i=e.total||0,n=a.total||0;return r.total=this.calculateDelta(i,n),r}static compareEmployees(e,a){const t=new Map(e.map(l=>[l.id,l])),r=new Map(a.map(l=>[l.id,l])),i=new Set([...t.keys(),...r.keys()]),n=[];for(const l of i){const d=t.get(l)||null,g=r.get(l)||null;if(!d||!g){n.push({id:l,name:d?.name||g?.name||"Неизвестный",snapshot1:d?{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(d,g),trend:d?"removed":"new"});continue}const v={},C=["formed","review","execution"];for(const p of C){const y=d.ticketsByStage?.[p]||0,S=g.ticketsByStage?.[p]||0;v[p]=this.calculateDelta(y,S)}const f=this.calculateDelta(d.totalTickets||0,g.totalTickets||0);n.push({id:l,name:d.name,snapshot1:{ticketsByStage:d.ticketsByStage||{},totalTickets:d.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:v,totalTickets:f},trend:f.trend})}return n}static calculateEmployeeDelta(e,a){if(!e&&!a)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const t={},r=["formed","review","execution"];for(const n of r){const l=e?.ticketsByStage?.[n]||0,d=a?.ticketsByStage?.[n]||0;t[n]=this.calculateDelta(l,d)}const i=this.calculateDelta(e?.totalTickets||0,a?.totalTickets||0);return{ticketsByStage:t,totalTickets:i}}static compareZeroPoint(e,a){return{unassigned:this.calculateDelta(e?.unassigned||0,a?.unassigned||0),keeper:this.calculateDelta(e?.keeper||0,a?.keeper||0),total:this.calculateDelta(e?.total||0,a?.total||0)}}static compareTickets(e,a,t,r){const i=new Set(e),n=new Set(a),l=a.filter(p=>!i.has(p)),d=e.filter(p=>!n.has(p)),g=[],v=[],C=new Map(t.map(p=>[p.id,p])),f=new Map(r.map(p=>[p.id,p]));for(const p of e){if(!n.has(p))continue;const y=C.get(p),S=f.get(p);if(!y||!S)continue;const T=(y.assignedTo?.id||null)!==(S.assignedTo?.id||null),k=(y.stageId||null)!==(S.stageId||null);T||k?g.push(p):v.push(p)}return{new:l,removed:d,changed:g,unchanged:v}}static buildComparisonMetadata(e,a){const t=new Date(e.metadata.createdAt),r=new Date(a.metadata.createdAt),i=new Date,n=r.getTime()-t.getTime(),l=Math.floor(n/(1e3*60*60*24)),d=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),g=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:a.metadata.createdAt,comparisonDate:i.toISOString(),timeDiff:{days:l,hours:d,minutes:g,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,a,t,r){const i=e.total.delta,n=Object.keys(e).filter(g=>g==="total"?!1:e[g].delta!==0).length,l=a.filter(g=>g.trend==="new"||g.trend==="removed"?!0:g.delta.totalTickets.delta!==0).length,d=i!==0||n>0||l>0;return{totalDelta:i,stagesChanged:n,employeesChanged:l,hasChanges:d,newTicketsCount:r?.new?.length||0,removedTicketsCount:r?.removed?.length||0,changedTicketsCount:r?.changed?.length||0}}static validateSnapshot(e){const a=[],t=[];if(!e)return a.push("Snapshot is null or undefined"),{valid:!1,errors:a,warnings:t};if(e.metadata?(e.metadata.createdAt||a.push("Missing metadata.createdAt"),e.metadata.type||a.push("Missing metadata.type")):a.push("Missing metadata field"),!e.statistics)a.push("Missing statistics field");else{if(!e.statistics.stages)a.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const i of r)e.statistics.stages[i]||t.push(`Missing stage: ${i}`)}e.statistics.employees||t.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||t.push("Missing statistics.zeroPoint")}return{valid:a.length===0,errors:a,warnings:t}}static compareMultipleSnapshots(e,a={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const l=this.validateSnapshot(n);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const t=[...e].sort((n,l)=>{const d=new Date(n.metadata.createdAt),g=new Date(l.metadata.createdAt);return d-g}),r=[];for(let n=0;n<t.length-1;n++)r.push({from:n,to:n+1,result:this.compareTwoSnapshots(t[n],t[n+1],a)});const i=this.buildTrends(t);return{snapshots:t.map((n,l)=>({index:l,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:r,trends:i}}static buildTrends(e){const a={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const t of e){const r=t.statistics;a.stages.formed.push(r.stages?.formed?.count||0),a.stages.review.push(r.stages?.review?.count||0),a.stages.execution.push(r.stages?.execution?.count||0),a.stages.total.push(r.stages?.total||0),a.zeroPoint.unassigned.push(r.zeroPoint?.unassigned||0),a.zeroPoint.keeper.push(r.zeroPoint?.keeper||0),a.zeroPoint.total.push(r.zeroPoint?.total||0)}return a}}const qt=M([]);let al=0;function mt(){const o=(l,d="info",g=3e3)=>{const v=++al,C={id:v,message:l,type:d,duration:g,timestamp:Date.now()};return qt.value.push(C),g>0&&setTimeout(()=>{e(v)},g),v},e=l=>{const d=qt.value.findIndex(g=>g.id===l);d>-1&&qt.value.splice(d,1)};return{notifications:qt,showNotification:o,removeNotification:e,clearNotifications:()=>{qt.value=[]},success:(l,d=3e3)=>o(l,"success",d),error:(l,d=5e3)=>o(l,"error",d),warning:(l,d=4e3)=>o(l,"warning",d),info:(l,d=3e3)=>o(l,"info",d)}}const sl={class:"stages-container"},ol={class:"stages-chips"},nl=["checked","disabled","onChange"],rl={class:"stage-chip-label"},il={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:o=>o.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(o,{emit:e}){const a=o,t=e;function r(i,n){const l={...a.selected};l[i]=n,t("update:selected",l),t("change",i,n)}return(i,n)=>(c(),u("div",sl,[n[0]||(n[0]=s("h4",{class:"stages-title"},"Этапы для отображения:",-1)),s("div",ol,[(c(!0),u(ee,null,te(o.stages,l=>(c(),u("label",{key:l.id,class:X(["stage-chip",{"stage-chip--active":o.selected[l.id],"stage-chip--disabled":o.disabled}])},[s("input",{type:"checkbox",checked:o.selected[l.id],disabled:o.disabled,onChange:d=>r(l.id,d.target.checked)},null,40,nl),s("span",{class:"stage-chip-color",style:we({backgroundColor:l.color})},null,4),s("span",rl,m(l.name),1)],2))),128))])]))}},ll=ce(il,[["__scopeId","data-v-fe03c03c"]]),cl={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(o,{emit:e}){const a=M(!1),t=I(()=>!1),r={color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d"},i={color:"#ced4da",backgroundColor:"#f8f9fa",textColor:"#6c757d"},n={color:"#dee2e6",backgroundColor:"#f8f9fa",textColor:"#6c757d"},l=I(()=>({label:o.ticket.priorityLabel||"Не указано",colors:o.ticket.priorityColors||r})),d=I(()=>l.value.label||"Не указано"),g=I(()=>({color:l.value.colors.textColor||r.textColor,backgroundColor:l.value.colors.backgroundColor||r.backgroundColor,borderColor:l.value.colors.color||r.color})),v=I(()=>({borderLeftColor:l.value.colors.color||r.color})),C=I(()=>{const E=o.ticket.service||{};return{label:E.label||o.ticket.serviceLabel||"Не указано",colors:E.colors||o.ticket.serviceColors||i}}),f=I(()=>C.value.label||"Не указано"),p=I(()=>({color:C.value.colors.textColor||i.textColor,backgroundColor:C.value.colors.backgroundColor||i.backgroundColor,borderColor:C.value.colors.color||i.color})),y=I(()=>{const E=o.ticket.actionStr||o.ticket.ufActionStr||null;if(!E)return null;const L=String(E).trim();return L.length>0?L:null}),S=I(()=>({color:n.textColor,backgroundColor:n.backgroundColor,borderColor:n.color})),T=I(()=>{if(!o.ticket.createdAt)return"";const E=Qa(o.ticket.createdAt);return E?vo(E):""}),k=I(()=>{if(!o.ticket.createdAt)return null;const E=Qa(o.ticket.createdAt);return po(E)}),_=I(()=>{const E=k.value;return E&&yo[E]||null}),A=I(()=>{const E=_.value;return E?{color:E.textColor,backgroundColor:E.backgroundColor,borderColor:E.color,border:`1px solid ${E.color}`}:{}});return{handleDragStart:E=>{t.value&&(E.dataTransfer.effectAllowed="move",E.dataTransfer.setData("application/json",JSON.stringify(o.ticket)),E.dataTransfer.setDragImage(E.target,0,0),a.value=!0,e("drag-start",o.ticket))},handleDragEnd:()=>{t.value&&(a.value=!1,e("drag-end"))},handleCardClick:E=>{if(a.value)return;const L=aa(o.ticket.id);window.open(L,"_blank"),e("click",o.ticket)},isDragEnabled:t,priorityChipStyle:g,displayPriorityLabel:d,priorityBorderStyle:v,displayServiceLabel:f,serviceChipStyle:p,actionStrValue:y,actionChipStyle:S,formattedCreatedDate:T,dateAccentCategory:k,dateAccentConfig:_,dateAccentStyle:A}}},dl=["draggable"],ul={key:0,class:"ticket-department"},gl={class:"ticket-header"},ml={class:"ticket-id"},hl={class:"ticket-title"},fl={class:"ticket-meta"},vl={key:1,class:"ticket-action"},pl={key:2,class:"ticket-description"},yl={class:"ticket-date-label"},kl={class:"ticket-date-value"};function bl(o,e,a,t,r,i){return c(),u("div",{class:"ticket-card",draggable:t.isDragEnabled,style:we(t.priorityBorderStyle),onClick:e[0]||(e[0]=(...n)=>t.handleCardClick&&t.handleCardClick(...n)),onDragstart:e[1]||(e[1]=(...n)=>t.handleDragStart&&t.handleDragStart(...n)),onDragend:e[2]||(e[2]=(...n)=>t.handleDragEnd&&t.handleDragEnd(...n))},[a.ticket.departmentHead?(c(),u("div",ul,m(a.ticket.departmentHead),1)):$("",!0),s("div",gl,[e[3]||(e[3]=s("span",{class:"ticket-icon"},"🎫",-1)),s("span",ml,"#"+m(a.ticket.id),1)]),s("div",hl,m(a.ticket.ufSubject||a.ticket.title||"Без названия"),1),s("div",fl,[s("span",{class:"ticket-priority",style:we(t.priorityChipStyle)},m(t.displayPriorityLabel),5),s("span",{class:"ticket-service",style:we(t.serviceChipStyle)},m(t.displayServiceLabel),5)]),t.actionStrValue?(c(),u("div",vl,[s("span",{class:"ticket-action-chip",style:we(t.actionChipStyle)},m(t.actionStrValue),5)])):$("",!0),a.ticket.description?(c(),u("div",pl,m(a.ticket.description),1)):$("",!0),t.formattedCreatedDate?(c(),u("div",{key:3,class:"ticket-created-date",style:we(t.dateAccentStyle)},[s("span",yl,m(t.dateAccentConfig?.label||""),1),s("span",kl,m(t.formattedCreatedDate),1)],4)):$("",!0)],44,dl)}const Ct=ce(cl,[["render",bl],["__scopeId","data-v-9cda001c"]]),Ht=10;function ha(o,e){if(!e||!e.statistics)return[];const a=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(r=>r.ticketsByStage&&r.ticketsByStage[o]>0).forEach(r=>{a.push({id:r.id,name:r.name,count:r.ticketsByStage[o]||0})});const t=_l(o,e);return t>0&&a.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:t,isKeeper:!0}),a.sort((r,i)=>i.count-r.count)}function _l(o,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[o])return e.statistics.zeroPointByStage[o].keeper||0;if(e.statistics.zeroPoint){const a=e.statistics.zeroPoint.keeper||0;return Math.floor(a/3)}return 0}function xs(o,e){return!e||!e.statistics||!e.statistics.stages?0:e.statistics.stages[o]?.count||0}function fa(o,e=Ht){if(!o||o.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const a=[...o].sort((n,l)=>l.count-n.count),t=a.slice(0,e),r=a.slice(e),i=r.reduce((n,l)=>n+l.count,0);return{visible:t,others:{employees:r,count:i,employeeCount:r.length}}}function Ls(o,e){return!o||o.length===0?[]:e===0?o.map(a=>({...a,percentage:0})):o.map(a=>({...a,percentage:parseFloat((a.count/e*100).toFixed(1))}))}function oa(o,e,a="#007bff",t=Ht){if(!o||o.length===0)return{employees:[],others:null};const{visible:r,others:i}=fa(o,t),n=Ls(r,e).map(d=>({...d,progressBarWidth:d.percentage,progressBarColor:d.isKeeper?"#f59e0b":a}));let l=null;if(i.count>0){const d=parseFloat((i.count/e*100).toFixed(1));l={...i,percentage:d,progressBarWidth:d,progressBarColor:"#6c757d"}}return{employees:n,others:l}}function wl(o,e){const a={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(r=>{const i=e[r];if(!i)return;const n=ha(o,i),l=xs(o,i);if(n.length===0)return;const{visible:d,others:g}=fa(n,Ht),v=Ls(d,l);a[r]=v,g.count>0&&(a.others[r]={count:g.count,employeeCount:g.employeeCount,percentage:parseFloat((g.count/l*100).toFixed(1))})}),a}function Cl(o,e="current",a=[]){const t=o[e];if(!t)return{labels:[],datasets:[]};const r=new Map;a.forEach(C=>{ha(C.id,t).forEach(p=>{r.has(p.id)||r.set(p.id,{id:p.id,name:p.name,isKeeper:p.isKeeper||!1,ticketsByStage:{}}),r.get(p.id).ticketsByStage[C.id]=p.count})});const i=Array.from(r.values()).map(C=>{const f=Object.values(C.ticketsByStage).reduce((p,y)=>p+y,0);return{...C,totalTickets:f}});i.sort((C,f)=>f.totalTickets-C.totalTickets);const{visible:n,others:l}=fa(i,Ht),d=a.map(()=>""),g={};a.forEach(C=>{const f=ha(C.id,t),{visible:p}=fa(f,Ht);g[C.id]=p.map(y=>({id:y.id,name:y.name,count:y.count}))});const v=n.map((C,f)=>{const p=a.map(S=>C.ticketsByStage[S.id]||0),y=a.map(S=>{if((C.ticketsByStage[S.id]||0)===0)return"transparent";const _=S.color.replace("#",""),A=parseInt(_.substring(0,2),16),U=parseInt(_.substring(2,4),16),x=parseInt(_.substring(4,6),16),D=.6+f*.05;return`rgba(${A}, ${U}, ${x}, ${Math.min(D,.95)})`});return{label:C.name,data:p,backgroundColor:y,borderColor:a.map(S=>{const T=S.color.replace("#",""),k=parseInt(T.substring(0,2),16),_=parseInt(T.substring(2,4),16),A=parseInt(T.substring(4,6),16);return`rgba(${k}, ${_}, ${A}, 0.8)`}),borderWidth:1,meta:{employeeId:C.id,employeeName:C.name}}});if(l.count>0){const C=a.map(f=>l.employees.reduce((p,y)=>p+(y.ticketsByStage[f.id]||0),0));v.push({label:`Другие (${l.employeeCount})`,data:C,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:d,datasets:v,meta:{employeesByStage:g}}}function Tl(o,e,a=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const t=a.find(g=>g.id===o),r=t?t.name:"",i=t?t.color:"#007bff",n=ha(o,e),l=xs(o,e);if(n.length===0)return{stageName:r,totalCount:0,employees:[],others:null};const d=oa(n,l,i,Ht);return{stageName:r,totalCount:l,employees:d.employees,others:d.others}}function Sl(o,e){return e?.[o]||o}function Dl(o,e){return e?.[o]||"#007bff"}function Fa({snapshots:o,graphType:e,timePoint:a,snapshotType:t}){return o?e==="line"&&a?o[a]||null:e==="bar"&&t?o[t]||null:o.current||o.weekEnd||o.weekStart||null:null}function Ha(o,e){return e?.statistics?.stages?.[o]?.count||0}function El({stageId:o,timePoint:e,meta:a,snapshots:t,stageColor:r,maxVisible:i}){if(!a?.employees||!e)return null;const n=a.employees[e];if(!n||n.length===0)return null;const l=t?.[e]||null,d=Ha(o,l)||n.reduce((v,C)=>v+(C.count||0),0),g=oa(n,d,r,i);return{stageId:o,totalCount:d,employees:g.employees,others:g.others,snapshot:l}}function Al({stageId:o,meta:e,snapshots:a,stageColor:t,maxVisible:r}){const i=e?.employees?.[o];if(!i||!i.employees||i.employees.length===0)return null;const n=Fa({snapshots:a,graphType:"doughnut"}),l=i.totalCount??Ha(o,n)??i.employees.reduce((g,v)=>g+(v.count||0),0),d=oa(i.employees,l,t,r);return{stageId:o,totalCount:l,employees:d.employees,others:d.others,snapshot:n}}function $l({stageId:o,meta:e,snapshots:a,stageColor:t,maxVisible:r,snapshotType:i}){const n=e?.employeesByStage?.[o];if(!n||n.length===0)return null;const l=Fa({snapshots:a,graphType:"bar",snapshotType:i}),d=Ha(o,l)||n.reduce((v,C)=>v+(C.count||0),0),g=oa(n,d,t,r);return{stageId:o,totalCount:d,employees:g.employees,others:g.others,snapshot:l}}async function Ps({stageId:o,graphType:e,timePoint:a=null,snapshotType:t=null,snapshots:r=null,meta:i=null,stageColorMap:n=null,stageNameMap:l=null,maxVisible:d=10,restLoader:g=null}){if(!o)throw new Error("stageId обязателен для загрузки данных уровня 1");const v=Sl(o,l),C=Dl(o,n);let f=null;if(e==="line"?f=El({stageId:o,timePoint:a,meta:i?.line,snapshots:r,stageColor:C,maxVisible:d}):e==="doughnut"?f=Al({stageId:o,meta:i?.doughnut,snapshots:r,stageColor:C,maxVisible:d}):e==="bar"&&(f=$l({stageId:o,meta:i?.bar,snapshots:r,stageColor:C,maxVisible:d,snapshotType:t})),f)return{stageId:o,stageName:v,color:C,totalCount:f.totalCount,employees:f.employees,others:f.others,snapshot:f.snapshot};if(typeof g=="function"){const p=await g({stageId:o,graphType:e,timePoint:a,snapshotType:t,snapshots:r});if(p&&Array.isArray(p.employees)){const y=p.totalCount??p.employees.reduce((T,k)=>T+(k.count||0),0),S=oa(p.employees,y,C,d);return{stageId:o,stageName:v,color:C,totalCount:y,employees:S.employees,others:S.others,snapshot:p.snapshot||Fa({snapshots:r,graphType:e,timePoint:a,snapshotType:t})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const Il={key:"level-1",class:"level-1"},Ml={class:"modal-header"},Nl={class:"stage-header"},xl=["aria-expanded","onKeydown"],Ll={class:"stage-title"},Pl=["aria-selected","onClick","onKeydown"],Ol={class:"stage-name"},Rl={class:"modal-total"},Bl={class:"view-switcher"},Ul={class:"modal-body"},Wl={key:0,class:"load-error"},Fl={key:1,class:"stage-loader"},Hl={key:2},jl={key:0,class:"no-employees"},Vl={key:1,class:"employees-list"},zl=["onClick"],Gl={class:"employee-name"},Kl={class:"employee-progress"},ql={class:"employee-count"},Yl={key:0,class:"employee-item employee-others"},Xl={class:"employee-name"},Jl={class:"employee-progress"},Zl={class:"employee-count"},Ql={key:3,class:"view-time"},ec={key:0,class:"no-data"},tc={key:1,class:"date-categories-list"},ac=["onClick"],sc={class:"category-label"},oc={class:"category-progress"},nc={class:"category-count"},rc={key:4,class:"view-departments"},ic={key:0,class:"no-data"},lc={key:1,class:"departments-table-container"},cc={class:"departments-table"},dc=["onClick"],uc={class:"col-department"},gc={class:"department-name"},mc={class:"col-count"},hc={class:"count-value"},fc={key:"level-2",class:"level-2"},vc={class:"modal-header"},pc={class:"modal-total"},yc={class:"modal-body"},kc={class:"stage-info level2-stage-row"},bc={class:"stage-badge"},_c={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},wc={key:0},Cc={key:0,class:"no-data"},Tc={key:1,class:"date-categories-list"},Sc=["onClick"],Dc={class:"category-label"},Ec={class:"category-progress"},Ac={class:"category-count"},$c={key:1,class:"view-departments"},Ic={key:0,class:"no-data"},Mc={key:1,class:"departments-table-container"},Nc={class:"departments-table"},xc=["onClick"],Lc={class:"col-department"},Pc={class:"department-name"},Oc={class:"col-count"},Rc={class:"count-value"},Bc={key:"level-3",class:"level-3"},Uc={class:"modal-header"},Wc={class:"header-info"},Fc={class:"header-badges"},Hc={class:"date-badge"},jc={class:"stage-badge"},Vc={class:"modal-total"},zc={class:"modal-body"},Gc={key:0,class:"no-data"},Kc={key:1,class:"departments-table-container"},qc={class:"departments-table"},Yc=["onClick"],Xc={class:"col-department"},Jc={class:"department-name"},Zc={class:"col-count"},Qc={class:"count-value"},ed={key:"level-4",class:"level-4"},td={class:"modal-header"},ad={class:"header-info"},sd={key:0,class:"header-badges"},od={key:0,class:"date-badge"},nd={key:1,class:"department-badge"},rd={class:"stage-badge"},id={class:"modal-total"},ld={class:"modal-body"},cd={key:"loading",class:"loading-state"},dd={key:"error-fallback",class:"error-state-with-fallback"},ud={class:"tickets-list-container"},gd={key:"error",class:"error-state"},md={class:"error-message"},hd={key:"empty",class:"empty-state"},fd={class:"empty-state-title"},vd={class:"empty-state-message"},pd={key:"tickets",class:"tickets-list-container"},yd={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(o,{expose:e,emit:a}){const t=o,r=a,i=mt(),n=M(1),l=M("time"),d=M("employees"),g=M(null),v=M([]),C=M([]),f=M(null),p=M(null),y=M(null),S=M(t.stageSwitchContext||null),T=M(!1),k=M(null),_=M(null),A=M(!1),U=M(null),x=M(null),D=I(()=>{const z=S.value?.stageNameMap||{},N=S.value?.stageColorMap||{};return Object.keys(z).map(b=>({id:b,name:z[b],color:N[b]||"#007bff",disabled:b===(g.value?.stageId||t.stageId)}))});I(()=>n.value>1);const E=I(()=>{switch(n.value){case 1:return g.value?.stageName||t.stageName;case 2:return f.value?.employeeName||"";case 3:return`${f.value?.employeeName||""} — ${p.value?.dateCategoryLabel||""}`;case 4:if(!y.value?.context)return"Список тикетов";const z=y.value.context,N=[];return z.employeeName&&N.push(z.employeeName),z.dateCategoryLabel&&N.push(z.dateCategoryLabel),z.departmentName&&N.push(z.departmentName),z.stageName&&N.push(z.stageName),N.length>0?N.join(" — "):"Список тикетов";default:return""}});function L(){console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employeesCount:t.employees?.length||0,hasSnapshot:!!t.snapshot,snapshotTicketIds:t.snapshot?.ticketIds?.length||0,hasTicketDetails:!!t.ticketDetails,snapshotKeys:t.snapshot?Object.keys(t.snapshot):[]}),g.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:g.value.stageId,hasSnapshot:!!g.value.snapshot,employeesCount:g.value.employees.length,snapshotType:g.value.snapshot?typeof g.value.snapshot:"null"}),f.value=null,p.value=null,y.value=null,n.value=1,l.value="time",d.value="employees",R(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function R(){if(!g.value||!g.value.snapshot||!g.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const z=g.value.snapshot.tickets||[],N=g.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:z.length,currentStageId:N,sampleTicket:z[0]?{id:z[0].id,stageId:z[0].stageId,hasDepartmentHead:!!z[0].departmentHead,departmentHead:z[0].departmentHead,hasDepartmentHeadFull:!!z[0].departmentHeadFull,departmentHeadFull:z[0].departmentHeadFull,allKeys:Object.keys(z[0])}:null});let b=z.filter(K=>K.stageId?Zt(K.stageId)===N:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:z.length,afterFilter:b.length,stageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length});const O=b.filter(K=>!K.departmentHead&&!K.departmentHeadFull);if(O.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:O.length,totalTickets:b.length,ticketsWithDepartment:b.filter(j=>j.departmentHead||j.departmentHeadFull).length});const K=O.map(j=>j.id).filter(j=>j);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:K.length,ticketIdsSample:K.slice(0,10)});const j=await bo.getTicketsDetails(K),V=new Map;j.forEach(F=>{F&&F.id&&V.set(F.id,F)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:j.length,detailsMapSize:V.size,sampleDetail:j[0]?{id:j[0].id,departmentHead:j[0].departmentHead,departmentHeadFull:j[0].departmentHeadFull}:null}),b=b.map(F=>{const ie=V.get(F.id);return ie?{...F,stageId:ie.stageId||F.stageId||null,departmentHead:ie.departmentHead||F.departmentHead||null,departmentHeadFull:ie.departmentHeadFull||ie.departmentHead||F.departmentHead||null}:F}),b=b.filter(F=>F.stageId?Zt(F.stageId)===N:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:b.length,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,ticketsWithStageId:b.filter(F=>F.stageId).length,ticketsWithoutStageId:b.filter(F=>!F.stageId).length});const ae=b.length,ue=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));b=b.filter(F=>F.stageId?Zt(F.stageId)===N:!0);const pe=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:ae,afterStageFilter:b.length,filteredOut:ae-b.length,currentStageId:N,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,sampleBeforeFilter:ue,sampleAfterFilter:pe,sampleWithDepartment:b.find(F=>F.departmentHead||F.departmentHeadFull)?{id:b.find(F=>F.departmentHead||F.departmentHeadFull).id,departmentHead:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHead,departmentHeadFull:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(b.find(F=>F.departmentHead||F.departmentHeadFull)).filter(F=>F.toLowerCase().includes("department"))}:null})}catch(j){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",j),console.error("[EmployeeDetailsModal] Error details:",{message:j.message,stack:j.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:b.length,currentStageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length,ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const Q=es(b);v.value=Q,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:b.length,sampleTickets:b.slice(0,5).map(K=>({id:K.id,departmentHead:K.departmentHead,departmentHeadFull:K.departmentHeadFull,hasDepartmentHead:!!K.departmentHead,hasDepartmentHeadFull:!!K.departmentHeadFull,allKeys:Object.keys(K).filter(j=>j.toLowerCase().includes("department"))})),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const de=ts(b);C.value=de;const ke=Q.reduce((K,j)=>K+j.count,0),_e=de.reduce((K,j)=>K+j.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:N,totalTicketsForGrouping:b.length,timeCategoriesCount:Q.length,totalTicketsInTimeCategories:ke,departmentsCount:de.length,totalTicketsInDepartments:_e,departmentsSample:de.slice(0,5),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length,consistencyCheck:{totalTickets:b.length,timeCategoriesTotal:ke,departmentsTotal:_e,isConsistent:b.length===ke&&b.length===_e}})}catch(z){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",z),console.error("[EmployeeDetailsModal] Error stack:",z.stack)}}async function W(z){if(!z){i.error("Не указан stageId для загрузки данных");return}if(g.value?.stageId===z)return;if(!S.value){i.error("Нет контекста для смены стадии (stageSwitchContext)");return}T.value=!0,k.value=null;const N=g.value?{...g.value}:null;_.value=N?.stageId||null;try{const b=await Ps({...S.value,stageId:z});g.value={stageId:b.stageId,stageName:b.stageName,stageColor:b.color,totalCount:b.totalCount,employees:b.employees,others:b.others,snapshot:b.snapshot||N?.snapshot||null,ticketDetails:b.ticketDetails||null},f.value=null,p.value=null,y.value=null,n.value=1,l.value="time",d.value="employees",await R()}catch(b){console.error("[EmployeeDetailsModal] Failed to reload stage data:",b),k.value=b?.message||"Не удалось загрузить данные стадии",N&&(g.value=N),i.error(k.value)}finally{T.value=!1}}async function G(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),i.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:N}=await Ce(async()=>{const{createContextFromLevel3:O}=await import("./chunk-qDiINO2f.js").then(Q=>Q.t);return{createContextFromLevel3:O}},__vite__mapDeps([6,7,4,5,3]),import.meta.url),b=await N(p.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function q(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!g.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:N}=await Ce(async()=>{const{createContextFromLevel1Department:O}=await import("./chunk-qDiINO2f.js").then(Q=>Q.t);return{createContextFromLevel1Department:O}},__vite__mapDeps([6,7,4,5,3]),import.meta.url),b=N(g.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:b.stageName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function oe(z){if(!z||z.count===0){i.info(`В категории "${z?.label||"неизвестная"}" нет тикетов`);return}if(!z.tickets||z.tickets.length===0){i.info(`В категории "${z.label}" нет тикетов`);return}if(!g.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:N}=await Ce(async()=>{const{createContextFromLevel1Time:O}=await import("./chunk-qDiINO2f.js").then(Q=>Q.t);return{createContextFromLevel1Time:O}},__vite__mapDeps([6,7,4,5,3]),import.meta.url),b=N(g.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:b.stageName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}Ne(()=>t.isVisible,z=>{z?L():(h(),De())}),Ne(()=>t.stageSwitchContext,z=>{S.value=z},{deep:!0}),$e(()=>{t.isVisible&&L()});async function Y(z,N=null){if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",z),console.log("[EmployeeDetailsModal] Current popup level:",n.value),N&&N.currentTarget&&(N.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{N.currentTarget&&(N.currentTarget.style.transform="")},150)),!z||!z.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",z);return}if(g.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),g.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:g.value.stageId,stageName:g.value.stageName,hasSnapshot:!!g.value.snapshot,snapshotType:g.value.snapshot?typeof g.value.snapshot:"null",snapshotKeys:g.value.snapshot?Object.keys(g.value.snapshot):[]}),!g.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),i.warning("ID стадии не указан");return}if(!g.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",t.snapshot),i.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",z.id,"stage:",g.value.stageId);const{filterTicketsByDepartment:b}=await Ce(async()=>{const{filterTicketsByDepartment:ke}=await import("./chunk-BuX-LpxK.js").then(_e=>_e.l);return{filterTicketsByDepartment:ke}},__vite__mapDeps([5,3]),import.meta.url).then(ke=>ke.LazyServiceLoader.loadTicketListUtils()),O=await ko(z.id,g.value.stageId,g.value.snapshot,g.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",O?.length||0,O),!O||O.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),i.info(`У сотрудника "${z.name}" нет тикетов на стадии "${g.value.stageName}"`);return}const Q=es(O);console.log("[EmployeeDetailsModal] Date categories:",Q?.length||0,Q);const de=ts(O).map(ke=>({...ke,tickets:b(O,ke.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",de?.length||0,de),f.value={employeeId:z.id,employeeName:z.name,stageId:g.value.stageId,stageName:g.value.stageName,totalCount:O.length,dateCategories:Q,departments:de,tickets:O,snapshot:g.value.snapshot,ticketDetails:g.value.ticketDetails},l.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:f.value.employeeName,totalCount:f.value.totalCount,dateCategoriesCount:f.value.dateCategories.length,departmentsCount:f.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",f.value),n.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",n.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",f.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!f.value,employeeName:f.value?.employeeName,dateCategoriesCount:f.value?.dateCategories?.length||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",n.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",f.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(b){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",b),console.error("[EmployeeDetailsModal] Error stack:",b.stack),i.error("Ошибка загрузки данных о тикетах: "+b.message)}}async function H(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!f.value){i.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:N}=await Ce(async()=>{const{createContextFromLevel2Department:O}=await import("./chunk-qDiINO2f.js").then(Q=>Q.t);return{createContextFromLevel2Department:O}},__vite__mapDeps([6,7,4,5,3]),import.meta.url),b=N(f.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:b.employeeName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function Z(z){if(!z||z.count===0){i.info(`В категории "${z?.label||"неизвестная"}" нет тикетов`);return}if(!z.tickets||z.tickets.length===0){i.info(`В категории "${z.label}" нет тикетов`);return}if(!f.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),i.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:N}=await Ce(async()=>{const{createContextFromLevel2:O}=await import("./chunk-qDiINO2f.js").then(Q=>Q.t);return{createContextFromLevel2:O}},__vite__mapDeps([6,7,4,5,3]),import.meta.url),b=N(f.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function fe(z){if(console.time("[Performance] goToLevel4"),!z){console.error("[EmployeeDetailsModal] Context is required for level 4"),i.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:z.sourceLevel,employeeId:z.employeeId,stageId:z.stageId,dateCategory:z.dateCategory,departmentName:z.departmentName,ticketsCount:z.tickets?.length||0});try{y.value={context:z,tickets:[],totalCount:0,isLoading:!0,error:null};let N=z.tickets||[];if(N.length===0&&z.snapshot){const{filterTicketsByContext:O}=await Ce(async()=>{const{filterTicketsByContext:Q}=await import("./chunk-qDiINO2f.js").then(de=>de.t);return{filterTicketsByContext:Q}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);N=await O(z)}(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),N=z.tickets||[]),(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),z.snapshot&&z.snapshot.tickets&&(N=z.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",N.length)));let b=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:O}=await Ce(async()=>{const{prepareTicketsForDisplay:Q}=await import("./chunk-qDiINO2f.js").then(de=>de.t);return{prepareTicketsForDisplay:Q}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);b=await O(N,z.snapshot,z.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(O){console.error("[EmployeeDetailsModal] Error preparing tickets:",O),console.timeEnd("[Performance] prepareTicketsForDisplay"),b=N||[],i.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:N.length,preparedCount:b.length}),y.value={context:z,tickets:b,totalCount:b.length,isLoading:!1,error:null},n.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:y.value.totalCount,ticketsCount:y.value.tickets.length,isLoading:y.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,context:z});let b=[];if(z.snapshot&&z.snapshot.tickets)try{const O=z.stageId;O?b=(z.snapshot.tickets||[]).filter(Q=>Q.stageId===O):b=z.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",b.length)}catch(O){console.error("[EmployeeDetailsModal] Error using fallback tickets:",O)}y.value={context:z,tickets:b,totalCount:b.length,isLoading:!1,error:{message:N.message,hasFallback:b.length>0}},b.length>0?(i.warning("Ошибка загрузки данных. Отображаются данные из кеша."),n.value=4):(i.error("Ошибка загрузки тикетов: "+N.message),P()),console.timeEnd("[Performance] goToLevel4")}}function P(){if(n.value===4){if(y.value&&y.value.context){const z=y.value.context.sourceLevel;n.value=z}else n.value=1;y.value=null}else n.value===3?(n.value=2,p.value=null,y.value=null):n.value===2&&(n.value=1,f.value=null,p.value=null,y.value=null)}function h(){n.value=1,g.value=null,f.value=null,p.value=null,y.value=null,l.value="time"}function w(){if(!y.value?.context)return"Нет тикетов";const{sourceLevel:z,employeeName:N,dateCategoryLabel:b,departmentName:O}=y.value.context;return z===2&&N&&b?`Нет тикетов у ${N} в категории "${b}"`:z===2&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:z===3&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:z===1&&b?`Нет тикетов в категории "${b}"`:z===1&&O?`Нет тикетов у заказчика "${O}"`:"Нет тикетов для отображения"}function B(){if(!y.value?.context)return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:z}=y.value.context;return z?`На стадии "${z}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function re(){if(!y.value?.context){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const z=y.value.context;await fe(z)}function le(z){if(!z){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),i.warning("Ошибка: тикет не найден");return}if(!z.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",z),i.error("Ошибка: ID тикета не указан");return}try{const N=aa(z.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:z.id,iframeUrl:N}),!N||typeof N!="string"||N.length===0)throw new Error("Не удалось сформировать URL для тикета");const b=window.open(N,"_blank","noopener,noreferrer");if(!b||b.closed||typeof b.closed>"u")try{const O=document.createElement("a");O.href=N,O.target="_blank",O.rel="noopener noreferrer",O.style.display="none",document.body.appendChild(O),O.click(),document.body.removeChild(O),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:z.id,iframeUrl:N})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:z.id,iframeUrl:N})}catch(N){console.error("[EmployeeDetailsModal] Error opening ticket:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,ticket:z}),i.error("Ошибка открытия тикета: "+N.message)}}function se(){h(),r("close")}e({reloadLevel1ForStage:W});function me(z){z&&z.stopPropagation(),A.value=!A.value}function De(){A.value&&(A.value=!1)}function Ie(z){if(!A.value)return;const N=U.value,b=x.value;N&&N.contains(z.target)||b&&b.contains(z.target)||(A.value=!1)}async function xe(z){if(z.disabled){A.value=!1;return}A.value=!1,await W(z.id)}function He(z){if(A.value){z.stopPropagation(),De();return}se()}return(z,N)=>(c(),he(It,{to:"body"},[o.isVisible?(c(),u("div",{key:0,class:"employee-details-modal",onClick:Te(se,["self"]),onKeydown:Be(He,["esc"])},[s("div",{class:"modal-content",onClick:Ie},[ne(Ae,{name:"level",mode:"out-in"},{default:ye(()=>[n.value===1?(c(),u("div",Il,[s("div",Ml,[s("div",Nl,[s("button",{ref_key:"stageTriggerRef",ref:x,class:"stage-trigger","aria-expanded":A.value,"aria-haspopup":"listbox",onClick:Te(me,["stop"]),onKeydown:[Be(Te(me,["prevent"]),["enter"]),Be(Te(me,["prevent"]),["space"]),Be(Te(De,["stop","prevent"]),["esc"])]},[s("span",{class:"stage-color",style:we({backgroundColor:g.value?.stageColor||S.value?.stageColorMap?.[g.value?.stageId]||S.value?.stageColorMap?.[o.stageId]||"#007bff"})},null,4),s("span",Ll,m(g.value?.stageName||o.stageName),1),s("span",{class:X(["stage-caret",{open:A.value}])},"▾",2)],40,xl),A.value?(c(),u("div",{key:0,ref_key:"stageDropdownRef",ref:U,class:"stage-dropdown",role:"listbox"},[(c(!0),u(ee,null,te(D.value,b=>(c(),u("div",{key:b.id,class:X(["stage-option",{disabled:b.disabled}]),role:"option","aria-selected":b.disabled,onClick:Te(O=>xe(b),["stop"]),onKeydown:Be(Te(O=>xe(b),["prevent"]),["enter"])},[s("span",{class:"stage-color",style:we({backgroundColor:b.color})},null,4),s("span",Ol,m(b.name),1)],42,Pl))),128))],512)):$("",!0)]),s("span",Rl,"Всего: "+m(g.value?.totalCount||o.totalCount)+" тикетов",1),s("button",{class:"modal-close",onClick:se,"aria-label":"Закрыть"},"×")]),s("div",Bl,[s("button",{class:X(["view-switch-btn",{active:d.value==="employees"}]),onClick:N[0]||(N[0]=b=>d.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),s("button",{class:X(["view-switch-btn",{active:d.value==="time"}]),onClick:N[1]||(N[1]=b=>d.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),s("button",{class:X(["view-switch-btn",{active:d.value==="departments"}]),onClick:N[2]||(N[2]=b=>d.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),s("div",Ul,[k.value?(c(),u("div",Wl,[s("span",null,"Ошибка: "+m(k.value),1),s("button",{class:"btn-retry-stage",onClick:N[3]||(N[3]=b=>W(g.value?.stageId||o.stageId))}," Повторить ")])):$("",!0),T.value?(c(),u("div",Fl,[...N[7]||(N[7]=[s("div",{class:"loading-spinner small"},null,-1),s("span",null,"Загрузка стадии...",-1)])])):$("",!0),d.value==="employees"?(c(),u("div",Hl,[(g.value?.employees||o.employees).length===0&&(!(g.value?.others||o.others)||(g.value?.others||o.others).count===0)?(c(),u("div",jl," Нет данных о сотрудниках ")):(c(),u("div",Vl,[(c(!0),u(ee,null,te(g.value?.employees||o.employees,b=>(c(),u("div",{key:b.id,class:X(["employee-item",{"employee-keeper":b.isKeeper}]),onClick:Te(O=>Y(b,O),["stop"]),title:"Кликните для детализации по временным градациям"},[s("span",Gl,m(b.name),1),s("div",Kl,[s("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),s("span",ql,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1),N[8]||(N[8]=s("span",{class:"employee-arrow"},"→",-1))],10,zl))),128)),(g.value?.others||o.others)&&(g.value?.others||o.others).count>0?(c(),u("div",Yl,[s("span",Xl,"Другие ("+m((g.value?.others||o.others).employeeCount)+")",1),s("div",Jl,[s("div",{class:"progress-bar",style:we({width:(g.value?.others||o.others).progressBarWidth+"%",backgroundColor:(g.value?.others||o.others).progressBarColor})},null,4)]),s("span",Zl,m((g.value?.others||o.others).count)+" тикетов ("+m((g.value?.others||o.others).percentage)+"%) ",1)])):$("",!0)]))])):d.value==="time"?(c(),u("div",Ql,[v.value.length===0?(c(),u("div",ec," Загрузка данных... ")):(c(),u("div",tc,[(c(!0),u(ee,null,te(v.value,b=>(c(),u("div",{key:b.category,class:"category-item",onClick:Te(O=>oe(b),["stop"])},[s("span",sc,m(b.label),1),s("div",oc,[s("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),s("span",nc,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1),N[9]||(N[9]=s("span",{class:"category-arrow"},"→",-1))],8,ac))),128))]))])):d.value==="departments"?(c(),u("div",rc,[C.value.length===0?(c(),u("div",ic," Загрузка данных... ")):(c(),u("div",lc,[s("table",cc,[N[11]||(N[11]=s("thead",null,[s("tr",null,[s("th",{class:"col-department"},"Заказчик"),s("th",{class:"col-count"},"Количество тикетов"),s("th",{class:"col-action"})])],-1)),s("tbody",null,[(c(!0),u(ee,null,te(C.value,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Te(Q=>q(b),["stop"]),title:"Кликните для просмотра тикетов"},[s("td",uc,[s("span",gc,m(b.departmentName),1)]),s("td",mc,[s("span",hc,m(b.count),1)]),N[10]||(N[10]=s("td",{class:"col-action"},[s("span",{class:"department-arrow"},"→")],-1))],8,dc))),128))])])]))])):$("",!0)])])):n.value===2&&f.value?(c(),u("div",fc,[s("div",vc,[s("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),s("h3",null,m(f.value.employeeName),1),s("span",pc,"Всего: "+m(f.value.totalCount)+" тикетов",1),s("button",{class:"modal-close",onClick:se,"aria-label":"Закрыть"},"×")]),s("div",yc,[s("div",kc,[s("span",bc,m(f.value.stageName),1),s("div",_c,[s("button",{class:X(["level2-sort-btn",{active:l.value==="time"}]),onClick:N[4]||(N[4]=b=>l.value="time"),title:"Сортировка по времени"}," По времени ",2),s("button",{class:X(["level2-sort-btn",{active:l.value==="departments"}]),onClick:N[5]||(N[5]=b=>l.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),l.value==="time"?(c(),u("div",wc,[f.value.dateCategories.length===0?(c(),u("div",Cc," Нет данных о тикетах ")):(c(),u("div",Tc,[(c(!0),u(ee,null,te(f.value.dateCategories,b=>(c(),u("div",{key:b.category,class:"category-item",onClick:Te(O=>Z(b),["stop"])},[s("span",Dc,m(b.label),1),s("div",Ec,[s("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),s("span",Ac,m(b.count)+" тикетов ("+m(b.percentage)+"%) ",1)],8,Sc))),128))]))])):(c(),u("div",$c,[!f.value.departments||f.value.departments.length===0?(c(),u("div",Ic,[N[12]||(N[12]=ge(" Для выбранного сотрудника заказчики не найдены ",-1)),s("button",{class:"btn-retry-stage",onClick:N[6]||(N[6]=b=>Y({id:f.value.employeeId,name:f.value.employeeName}))}," Обновить ")])):(c(),u("div",Mc,[s("table",Nc,[N[14]||(N[14]=s("thead",null,[s("tr",null,[s("th",{class:"col-department"},"Заказчик"),s("th",{class:"col-count"},"Количество тикетов"),s("th",{class:"col-action"})])],-1)),s("tbody",null,[(c(!0),u(ee,null,te(f.value.departments,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Te(Q=>H(b),["stop"]),title:"Кликните для просмотра тикетов"},[s("td",Lc,[s("span",Pc,m(b.departmentName),1)]),s("td",Oc,[s("span",Rc,m(b.count),1)]),N[13]||(N[13]=s("td",{class:"col-action"},[s("span",{class:"department-arrow"},"→")],-1))],8,xc))),128))])])]))]))])])):n.value===3&&p.value?(c(),u("div",Bc,[s("div",Uc,[s("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),s("div",Wc,[s("h3",null,m(p.value.employeeName),1),s("div",Fc,[s("span",Hc,m(p.value.dateCategoryLabel),1),s("span",jc,m(p.value.stageName),1)])]),s("span",Vc,"Всего: "+m(p.value.totalCount)+" тикетов",1),s("button",{class:"modal-close",onClick:se,"aria-label":"Закрыть"},"×")]),s("div",zc,[p.value.departments.length===0?(c(),u("div",Gc," Нет данных о заказчиках ")):(c(),u("div",Kc,[s("table",qc,[N[16]||(N[16]=s("thead",null,[s("tr",null,[s("th",{class:"col-department"},"Заказчик"),s("th",{class:"col-count"},"Количество тикетов"),s("th",{class:"col-action"})])],-1)),s("tbody",null,[(c(!0),u(ee,null,te(p.value.departments,(b,O)=>(c(),u("tr",{key:O,class:"department-row",onClick:Te(Q=>G(b),["stop"]),title:"Кликните для просмотра тикетов"},[s("td",Xc,[s("span",Jc,m(b.departmentName),1)]),s("td",Zc,[s("span",Qc,m(b.count),1)]),N[15]||(N[15]=s("td",{class:"col-action"},[s("span",{class:"department-arrow"},"→")],-1))],8,Yc))),128))])])]))])])):n.value===4&&y.value?(c(),u("div",ed,[s("div",td,[s("button",{class:"btn-back",onClick:P,"aria-label":"Назад"}," ← "),s("div",ad,[s("h3",null,m(E.value),1),y.value.context?(c(),u("div",sd,[y.value.context.dateCategoryLabel?(c(),u("span",od,m(y.value.context.dateCategoryLabel),1)):$("",!0),y.value.context.departmentName?(c(),u("span",nd,m(y.value.context.departmentName),1)):$("",!0),s("span",rd,m(y.value.context.stageName),1)])):$("",!0)]),s("span",id,"Всего: "+m(y.value.totalCount)+" тикетов",1),s("button",{class:"modal-close",onClick:se,"aria-label":"Закрыть"},"×")]),s("div",ld,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[y.value.isLoading?(c(),u("div",cd,[...N[17]||(N[17]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка тикетов...",-1)])])):y.value.error&&y.value.error.hasFallback?(c(),u("div",dd,[N[18]||(N[18]=s("div",{class:"error-banner"},[s("span",{class:"error-icon"},"⚠️"),s("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),s("div",ud,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(y.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):y.value.error&&!y.value.error.hasFallback?(c(),u("div",gd,[N[19]||(N[19]=s("div",{class:"error-icon"},"❌",-1)),N[20]||(N[20]=s("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),s("p",md,m(y.value.error.message),1),s("button",{class:"btn-retry",onClick:re},"Повторить попытку")])):!y.value.tickets||y.value.tickets.length===0?(c(),u("div",hd,[N[21]||(N[21]=s("div",{class:"empty-state-icon"},"📭",-1)),s("h3",fd,m(w()),1),s("p",vd,m(B()),1)])):(c(),u("div",pd,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(y.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])],32)):$("",!0)]))}},kd=ce(yd,[["__scopeId","data-v-7fbd8a12"]]);function bd(o,e,a=.5){if(!e||!Array.isArray(e)||e.length===0||typeof o!="number"||o<0)return 0;(typeof a!="number"||a<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),a=.5);const t=[];if(e.forEach((n,l)=>{if(!n||!n.data||!Array.isArray(n.data))return;const d=n.data[o];d!=null&&!isNaN(d)&&t.push({datasetIndex:l,value:Number(d),y:Number(d)})}),t.length<2)return 0;const r=[];return t.forEach(n=>{let l=!1;for(const d of r){const g=d.y;if(Math.abs(n.y-g)<a){d.points.push(n),d.y=d.points.reduce((C,f)=>C+f.y,0)/d.points.length,l=!0;break}}l||r.push({points:[n],y:n.y})}),r.length===0?0:r.reduce((n,l)=>l.points.length>n.points.length?l:n,r[0]).points.length}function _d(o,e){const a=[];return o.forEach(t=>{let r=!1;for(const i of a){const n=i.y;if(Math.abs(t.value-n)<e){i.points.push(t),i.y=i.points.reduce((l,d)=>l+d.value,0)/i.points.length,r=!0;break}}r||a.push({points:[t],y:t.value})}),a}function wd(o,e=.5){if(!o)return console.warn("findOverlappingPoints: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];const a=o.data?.datasets,t=o.data?.labels||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(t)||t.length===0)return[];(typeof e!="number"||e<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),e=.5);const r=[];return t.forEach((i,n)=>{try{if(bd(n,a,e)<2)return;const d=[];if(a.forEach((p,y)=>{if(!p||!p.data||!Array.isArray(p.data))return;const S=p.data[n];S==null||isNaN(S)||d.push({datasetIndex:y,value:Number(S),label:p.label||`Dataset ${y}`})}),d.length<2)return;const g=_d(d,e);if(g.length===0)return;const v=g.reduce((p,y)=>y.points.length>p.points.length?y:p,g[0]);if(v.points.length<2)return;let C=null,f=null;for(let p=0;p<a.length;p++)try{const y=o.getDatasetMeta(p);if(y&&y.data&&y.data[n]){C=y,f=y.data[n];break}}catch{continue}if(!f||typeof f.x!="number"||typeof f.y!="number")return;r.push({position:n,count:v.points.length,x:f.x,y:f.y,value:v.y,points:v.points.map(p=>({datasetIndex:p.datasetIndex,value:p.value,label:p.label}))})}catch(l){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${n}:`,l)}}),r}function Cd(o,e){const a=[];return o.forEach(t=>{let r=!1;for(const i of a){const n=i.y;if(Math.abs(t.y-n)<e){i.points.push(t),i.y=i.points.reduce((l,d)=>l+d.y,0)/i.points.length,r=!0;break}}r||a.push({points:[t],y:t.y})}),a}function Td(o,e,a=.5){if(!o)return console.warn("calculatePointJitter: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];if(typeof e!="number"||e<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof a!="number"||a<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),a=.5);const t=o.data?.datasets,r=o.data?.labels||[];if(!t||!Array.isArray(t)||t.length===0)return[];if(!Array.isArray(r)||e>=r.length)return[];const i=[];if(t.forEach((g,v)=>{if(!g||!g.data||!Array.isArray(g.data))return;const C=g.data[e];if(!(C==null||isNaN(C)))try{const f=o.getDatasetMeta(v);if(f&&f.data&&f.data[e]){const p=f.data[e];p&&typeof p.x=="number"&&typeof p.y=="number"&&i.push({datasetIndex:v,value:Number(C),x:p.x,y:p.y})}}catch(f){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${v}:`,f)}}),i.length===0)return[];const n=Cd(i,a),l=[];n.forEach(g=>{const v=g.points||[];v.length>1?v.forEach((f,p)=>{const y=(p-(v.length-1)/2)*4;l.push({datasetIndex:f.datasetIndex,jitterX:y,value:f.value})}):v.length===1&&l.push({datasetIndex:v[0].datasetIndex,jitterX:0,value:v[0].value})});const d=new Set(l.map(g=>g.datasetIndex));return i.forEach(g=>{d.has(g.datasetIndex)||l.push({datasetIndex:g.datasetIndex,jitterX:0,value:g.value})}),l}const Sd=.5,os=6,Dd=2;function Ed(o){return typeof o!="number"||o<2?os:os+(o-1)*Dd}function Ad(o,e){if(!o||!o.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!e||typeof e.x!="number"||typeof e.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",e);return}const a=e.count;if(typeof a!="number"||a<2)return;const t=o.ctx,{x:r,y:i,points:n}=e,l=Ed(a);if(t.canvas){t.save();try{t.beginPath(),t.arc(r,i,l,0,2*Math.PI);let g="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&o.data&&o.data.datasets){const v=n[0].datasetIndex,C=o.data.datasets[v];if(C&&C.pointBackgroundColor){const f=Array.isArray(C.pointBackgroundColor)?C.pointBackgroundColor[e.position]||C.pointBackgroundColor[0]:C.pointBackgroundColor;if(f)if(f.startsWith("#")){const p=parseInt(f.slice(1,3),16),y=parseInt(f.slice(3,5),16),S=parseInt(f.slice(5,7),16);g=`rgba(${p}, ${y}, ${S}, 0.4)`}else f.startsWith("rgba")?g=f.replace(/rgba?\(([^)]+)\)/,(p,y)=>{const S=y.split(",").map(T=>T.trim());return`rgba(${S[0]}, ${S[1]}, ${S[2]}, 0.4)`}):g=f+"66"}}t.fillStyle=g,t.fill(),t.strokeStyle=g.replace("0.4","0.6").replace("66","99"),t.lineWidth=1,t.stroke()}catch(g){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",g)}finally{t.restore()}}}const $d={id:"overlappingPointsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=wd(o,Sd);if(!Array.isArray(e)||e.length===0)return;e.filter(t=>!(!t||typeof t!="object"||typeof t.count!="number"||t.count<2||typeof t.x!="number"||typeof t.y!="number"||!isFinite(t.x)||!isFinite(t.y))).forEach(t=>{try{Ad(o,t)}catch(r){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${t.position}:`,r)}})}catch(e){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",e)}}},Id=.5,Md={id:"pointJitterPlugin",beforeDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")){o._jitterData||(o._jitterData={});try{const e=o.data?.datasets,a=o.data?.labels||[];if(!e||!Array.isArray(e)||e.length===0||!Array.isArray(a)||a.length===0)return;o._jitterData={},a.forEach((t,r)=>{const i=Td(o,r,Id);i&&i.length>0&&i.forEach(n=>{const l=`${n.datasetIndex}_${r}`;o._jitterData[l]=n.jitterX})})}catch(e){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",e)}}},afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx&&!(!o._jitterData||Object.keys(o._jitterData).length===0))try{const e=o.ctx,a=o.data?.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((t,r)=>{const i=o.getDatasetMeta(r);!i||i.hidden||!t.data||!Array.isArray(t.data)||t.data.forEach((n,l)=>{const d=i.data[l];if(!d||typeof d.x!="number"||typeof d.y!="number"||n==null||isNaN(n))return;const g=`${r}_${l}`,v=o._jitterData[g];if(!(v===void 0||v===0)){e.save();try{const C=t.pointStyle||"circle",f=(t.pointRadius||7)+1,p=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[l]||t.pointBackgroundColor[0]:t.pointBackgroundColor,y=Array.isArray(t.pointBorderColor)?t.pointBorderColor[l]||t.pointBorderColor[0]:t.pointBorderColor,S=t.pointBorderWidth||1,T=d.x+v,k=d.y;switch(e.fillStyle=p||"#007bff",e.strokeStyle=y||"#ffffff",e.lineWidth=S,e.beginPath(),C){case"circle":e.arc(T,k,f,0,2*Math.PI);break;case"triangle":e.moveTo(T,k-f),e.lineTo(T-f,k+f),e.lineTo(T+f,k+f),e.closePath();break;case"rect":case"rectRounded":const _=f*1.4;e.rect(T-_/2,k-_/2,_,_);break;case"rectRot":const A=f*1.4;e.moveTo(T,k-A/2),e.lineTo(T+A/2,k),e.lineTo(T,k+A/2),e.lineTo(T-A/2,k),e.closePath();break;case"star":const U=f;for(let E=0;E<5;E++){const L=E*4*Math.PI/5-Math.PI/2,R=T+U*Math.cos(L),W=k+U*Math.sin(L);E===0?e.moveTo(R,W):e.lineTo(R,W)}e.closePath();break;case"cross":const x=f;e.moveTo(T-x,k-x),e.lineTo(T+x,k+x),e.moveTo(T+x,k-x),e.lineTo(T-x,k+x);break;case"crossRot":const D=f;e.moveTo(T-D,k),e.lineTo(T+D,k),e.moveTo(T,k-D),e.lineTo(T,k+D);break;default:e.arc(T,k,f,0,2*Math.PI)}C!=="cross"&&C!=="crossRot"&&e.fill(),e.stroke(),d._originalX||(d._originalX=d.x,d._originalY=d.y),d._jitterX=v,d._jitteredX=T,d._jitteredY=k}catch(C){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${r}_${l}:`,C)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:o=>{o._jitterData}},Nd={id:"pointLabelsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=o.ctx,a=o.data?.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((t,r)=>{const i=o.getDatasetMeta(r);if(!i||i.hidden||!t.data||!Array.isArray(t.data))return;const n=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[0]||"#6b7280":t.pointBackgroundColor||"#6b7280";t.data.forEach((l,d)=>{const g=i.data[d];if(!g||typeof g.x!="number"||typeof g.y!="number"||l==null||isNaN(l))return;const v=g._jitteredX!==void 0?g._jitteredX:g.x,C=g._jitteredY!==void 0?g._jitteredY:g.y,f=v+8,p=C-5,y=String(Math.round(l));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const T=e.measureText(y).width,k=11,_=3,A=f-_,U=p-k/2-_,x=T+_*2,D=k+_*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(A,U,x,D),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(A,U,x,D),e.fillStyle=n,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(y,f,p)}catch(S){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${r}_${d}:`,S)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},xd={class:"graph-state-chart"},Ld={class:"chart-header"},Pd={class:"chart-type-selector"},Od=["onClick","title"],Rd={class:"chart-type-icon"},Bd={class:"chart-type-label"},Ud={key:0,class:"comparison-type-selector"},Wd={class:"radio-group"},Fd={key:0},Hd={key:1},jd={key:2,class:"graph-legend"},Vd={key:4,class:"error-container"},zd={class:"error-message"},Gd={class:"chart-wrapper"},Kd={class:"chart-canvas-container"},qd={key:0,class:"bar-chart-stage-labels"},Yd={key:6,class:"no-data"},Xd={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(o,{emit:e}){const a=(j,V)=>typeof window>"u"?V:getComputedStyle(document.documentElement).getPropertyValue(j).trim()||V,t=o,r=e,i=M(!1),n=M(null),l=M(null),d=M({weekStart:null,weekEnd:null,current:null}),g=M(null),v=M("weekStartToWeekEnd"),C=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],f=M("line"),p=M(!1),y=M(""),S=M(""),T=M(0),k=M([]),_=M(null),A=M(null),U=M(null),x=M(null),D=M([]),E=I(()=>{switch(f.value){case"line":return yt;case"bar":return vs;case"doughnut":return fs;default:return yt}}),L={formed:a("--b24-primary","#007bff"),review:a("--b24-warning","#ffc107"),execution:a("--b24-success","#28a745")},R=[{id:"formed",name:"Сформировано обращение",color:L.formed},{id:"review",name:"Рассмотрение ТЗ",color:L.review},{id:"execution",name:"Исполнение",color:L.execution}],W=I(()=>R.reduce((j,V)=>(j[V.id]=V.name,j),{})),G=["circle","triangle","rect","rectRot","star","cross","crossRot"],q=M({formed:!0,review:!0,execution:!0}),oe=mt(),Y={id:"employeeLabelsPlugin",afterDatasetsDraw:j=>{if(j.config.type==="bar")try{const V=j.ctx;if(!j.data||!j.data.datasets)return;const ae=j.data.datasets,ue=j.scales.y;ae.forEach((pe,F)=>{const ie=j.getDatasetMeta(F);if(!ie||ie.hidden)return;const ve=pe.label||"";if(!ve||ve.includes("Другие"))return;const Se=ve.trim().split(/\s+/);let Me="";if(Se.length===1)Me=Se[0];else{const Le=Se[0],We=Se.slice(1).join(" ");Me=`${Le}
${We}`}const ze=Me.split(`
`);pe.data.forEach((Le,We)=>{if(Le===0||!Le)return;const Ge=ie.data[We];if(!Ge||typeof Ge.x!="number"||typeof Ge.y!="number")return;const je=Ge.x,Tt=Ge.y+Ge.height+25;V.save(),V.font="bold 9px Arial, sans-serif",V.fillStyle="#6b7280",V.textAlign="center",V.textBaseline="top",V.translate(je,Tt),V.rotate(-12*Math.PI/180),ze.forEach((Gs,Ks)=>{const Ya=Gs.trim();Ya&&V.fillText(Ya,0,Ks*11)}),V.restore()})})}catch(V){console.error("Error in employeeLabelsPlugin:",V)}}},H={id:"doughnutCenterTextPlugin",afterDraw:j=>{if(j.config.type!=="doughnut")return;const{ctx:V,chartArea:ae,width:ue,height:pe}=j;if(!j.data||!j.data.datasets||j.data.datasets.length===0)return;const ie=j.data.datasets[0].meta?.totals?.overall??null;if(ie===null||typeof ie>"u")return;const ve=["Всего в секторе 1С","тикетов в работе:",`${ie}`];V.save(),V.font='600 16px "Roboto", sans-serif',V.fillStyle=a("--b24-text-primary","#1f2937"),V.textAlign="center",V.textBaseline="middle";const Se=(ae.left+ae.right)/2,Me=(ae.top+ae.bottom)/2,ze=18,Le=ze*ve.length,We=Me-Le/2+4;ve.forEach((Ge,je)=>{je===ve.length-1&&`${Ge}`.length>4?V.font='700 18px "Roboto", sans-serif':V.font='600 16px "Roboto", sans-serif',V.fillText(Ge,Se,We+je*ze)}),V.restore()}};Je.register(Y),Je.register(H);function Z(){const j=new Map;[d.value.weekStart,d.value.weekEnd,d.value.current].forEach(V=>{!V||!V.statistics||!V.statistics.employees||V.statistics.employees.forEach(ae=>{j.has(ae.id)||j.set(ae.id,{id:ae.id,name:ae.name})})}),D.value=Array.from(j.values()).sort((V,ae)=>V.name.localeCompare(ae.name))}function fe(j,V="background"){return{increase:{background:a("--b24-success","#28a745"),border:a("--b24-success-hover","#218838"),point:a("--b24-success","#28a745")},decrease:{background:a("--b24-danger","#dc3545"),border:a("--b24-danger-hover","#c82333"),point:a("--b24-danger","#dc3545")},stable:{background:a("--b24-text-muted","#9ca3af"),border:a("--b24-text-secondary","#6b7280"),point:a("--b24-text-muted","#9ca3af")}}[j]?.[V]||a("--b24-text-secondary","#6c757d")}function P(){if(!(!d.value.weekStart||!d.value.weekEnd))try{const j=Aa.compareTwoSnapshots(d.value.weekStart,d.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let V=null,ae=null;d.value.current&&(V=Aa.compareTwoSnapshots(d.value.weekEnd,d.value.current,{includeTickets:!1,includeEmployees:!0}),ae=Aa.compareTwoSnapshots(d.value.weekStart,d.value.current,{includeTickets:!1,includeEmployees:!0})),g.value={weekStartToWeekEnd:j,weekEndToCurrent:V,weekStartToCurrent:ae}}catch(j){console.error("Ошибка сравнения слепков:",j),oe.warning("Не удалось выполнить сравнение слепков: "+j.message)}}function h(j){return j?j.replace(/\s*\(\d+\)\s*$/,"").trim():""}function w(j){const V=h(j);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[V]||"formed"}function B(j){return w(j)}function re(j){return j===0?"weekStart":j===1?"weekEnd":j===2?"current":"weekEnd"}function le(j,V,ae,ue,pe=null,F=null,ie=null,ve=null){console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:j,stageId:V,totalCount:ae,employeesCount:ue?.length||0,hasSnapshot:!!F,snapshotTicketIds:F?.ticketIds?.length||0}),y.value=j,S.value=V||"",T.value=ae,k.value=ue||[],_.value=pe&&pe.count>0?pe:null,A.value=F,U.value=ie,x.value=ve,p.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:S.value,hasCurrentSnapshot:!!A.value})}async function se(j,V,ae){console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:j,timePoint:V,hasMeta:!!ae});const ue=R.find(F=>F.id===j);if(!ue){console.warn("[GraphStateChart] Stage not found:",j);return}const pe={graphType:"line",stageId:j,stageName:ue.name,timePoint:V,snapshots:d.value,meta:{line:ae||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:W.value};try{const F=await Ps({stageId:j,graphType:"line",timePoint:V,snapshots:d.value,meta:{line:ae||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:W.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:F.stageName,stageId:j,totalCount:F.totalCount,employeesCount:F.employees?.length||0,hasSnapshot:!!F.snapshot}),le(F.stageName,j,F.totalCount,F.employees,F.others,F.snapshot,null,pe)}catch(F){console.error("[GraphStateChart] Failed to open modal for line point:",F),oe.error("Не удалось открыть попап для выбранной точки графика")}}function me(j,V){if(!V||!V.employees||V.employees.length===0){oe.warning("Нет данных о сотрудниках для этого этапа");return}const ae=d.value.current||d.value.weekEnd||d.value.weekStart,ue={graphType:"doughnut",stageId:j,stageName:V.stageName,snapshots:d.value,meta:{doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:L,stageNameMap:W.value};le(V.stageName,j,V.totalCount,V.employees,V.others,ae,null,ue)}function De(){p.value=!1,y.value="",S.value="",T.value=0,k.value=[],_.value=null,A.value=null,U.value=null}async function Ie(j,V,ae){if(f.value!=="line"||V.length===0)return;const ue=V[0],pe=ue.datasetIndex,F=ue.index,ie=ae.data.datasets[pe];if(!ie)return;const ve=B(ie.label),Se=re(F);await se(ve,Se,ie.meta||null)}function xe(j,V,ae){if(f.value!=="doughnut"||V.length===0)return;const pe=V[0].index,F=ae.data,ie=F.labels[pe],ve=B(ie),Me=F.datasets[0]?.meta?.employees?.[ve];if(!Me){console.warn("Данные о сотрудниках не найдены для этапа:",ve);return}me(ve,Me)}function He(j){const V=R[j];if(!V)return 0;const ae=d.value.current||d.value.weekEnd||d.value.weekStart;return!ae||!ae.statistics||!ae.statistics.stages?0:ae.statistics.stages[V.id]?.count||0}function z(j){const V=R.find(pe=>pe.id===j);if(!V)return"";const ae=d.value.current||d.value.weekEnd||d.value.weekStart;if(!ae||!ae.statistics||!ae.statistics.stages)return V.name;const ue=ae.statistics.stages[j]?.count||0;return`${V.name} (${ue})`}const N=I(()=>{if(!l.value)return null;if(f.value==="doughnut"||f.value==="bar")return l.value;const j=l.value.datasets.filter(V=>{const ae=R.find(ue=>ue.name===V.label);return ae?q.value[ae.id]:!0});return{...l.value,datasets:j}});I(()=>f.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const b=I(()=>{const j={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:f.value==="bar"?{bottom:80}:{}},onClick:(V,ae,ue)=>{f.value==="line"?Ie(V,ae,ue):f.value==="doughnut"&&xe(V,ae,ue)},onHover:(V,ae,ue)=>{f.value==="doughnut"&&(V.native.target.style.cursor=ae.length>0?"pointer":"default")},plugins:{legend:{display:f.value!=="bar",position:f.value==="doughnut"?"right":"top",labels:{font:{size:f.value==="doughnut"?14:12,weight:f.value==="doughnut"?"600":"500"},boxWidth:f.value==="doughnut"?18:12,boxHeight:f.value==="doughnut"?18:12,padding:f.value==="doughnut"?14:10},onClick:(V,ae,ue)=>{if(f.value==="bar"){const F=ae.datasetIndex;if(F!==void 0){const ie=ue.chart.getDatasetMeta(F);ie.hidden=!ie.hidden,ue.chart.update()}return}const pe=ae.datasetIndex;if(pe!==void 0){const F=ue.chart.getDatasetMeta(pe);F.hidden=!F.hidden,ue.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:V=>{if(f.value==="bar"){const ae=V[0].dataIndex,ue=R[ae];return ue?ue.name:""}return V[0].label||""},label:V=>{const ae=V.dataset.label||"",ue=V.parsed.y||V.parsed||0,pe=V.dataIndex;if(f.value==="bar"){const F=V.dataset,ie=V.dataIndex,ve=R[ie],Se=ve?ve.name:"";return`${F.label}: ${ue} тикетов на этапе "${Se}"`}if(f.value==="doughnut"){const F=V.dataset.data.reduce((ve,Se)=>ve+Se,0),ie=F>0?(ue/F*100).toFixed(1):0;return`${ae}: ${ue} тикетов (${ie}%)`}else{if(!g.value||pe===0)return`${ae}: ${ue} тикетов`;let F=null;const ie=w(ae);if(v.value==="weekStartToWeekEnd"&&pe===1?F=g.value.weekStartToWeekEnd?.stages?.[ie]:v.value==="weekEndToCurrent"&&pe===2&&d.value.current?F=g.value.weekEndToCurrent?.stages?.[ie]:v.value==="weekStartToCurrent"&&pe===2&&d.value.current&&(F=g.value.weekStartToCurrent?.stages?.[ie]),!F)return`${ae}: ${ue} тикетов`;const ve=F.delta,Se=F.deltaPercent,Me=F.trend;let ze=`${ae}: ${ue} тикетов`;if(ve!==0){const Le=ve>0?"+":"",We=Me==="increase"?"↑":Me==="decrease"?"↓":"→";ze+=` (${Le}${ve}, ${Le}${Se.toFixed(1)}%) ${We}`}else ze+=" (без изменений)";return ze}},afterBody:V=>{if(f.value==="bar"&&V.length>0){const F=V[0];F.dataset;const ie=F.parsed.y||0,ve=F.dataIndex,Se=He(ve);return[`${Se>0?(ie/Se*100).toFixed(1):0}% от общего количества этапа`]}if(f.value==="doughnut"&&V.length>0)return["Кликните для детализации по сотрудникам"];if(f.value==="line"){const F=[];if(g.value){const ie=V[0].dataIndex;if(ie!==0){let ve=null;if(w(V[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&ie===1?ve=g.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&ie===2?ve=g.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&ie===2&&(ve=g.value.weekStartToCurrent),ve&&ve.metadata){const Se=ve.metadata.timeDiff;F.push(`Период: ${Se.days} дн. ${Se.hours} ч. ${Se.minutes} мин.`)}}}return F.push("Кликните для детализации по сотрудникам"),F}if(!g.value)return[];const ae=V[0].dataIndex;if(ae===0)return[];let ue=null;if(w(V[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&ae===1?ue=g.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&ae===2?ue=g.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&ae===2&&(ue=g.value.weekStartToCurrent),!ue||!ue.metadata)return[];const pe=ue.metadata.timeDiff;return[`Период: ${pe.days} дн. ${pe.hours} ч. ${pe.minutes} мин.`]}}},title:{display:!1}}};return f.value==="line"||f.value==="bar"?{...j,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:f.value==="doughnut"?{...j,cutout:"60%"}:j});function O(j){const V=new Date(j),ae=V.getFullYear(),ue=String(V.getMonth()+1).padStart(2,"0"),pe=String(V.getDate()).padStart(2,"0");return`${ae}-${ue}-${pe}`}function Q(j){const{current:V,weekEnd:ae}=j,ue=V||ae;if(!ue||!ue.statistics||!ue.statistics.stages)return null;const pe=[],F=[],ie=[],ve=[],Se={},Me={};if(R.forEach(Le=>{const We=ue.statistics.stages[Le.id]?.count||0;if(We>0){pe.push(`${Le.name} (${We})`),F.push(We),ie.push(Le.color+"80"),ve.push(Le.color),Me[Le.id]=We;const Ge=Tl(Le.id,ue,R);Ge&&Ge.employees&&(Se[Le.id]=Ge)}}),F.length===0)return null;const ze=F.reduce((Le,We)=>Le+We,0);return{labels:pe,datasets:[{label:"Распределение по этапам",data:F,backgroundColor:ie,borderColor:ve,borderWidth:2,meta:{employees:Se,totals:{overall:ze,stages:Me}}}]}}function de(j){if(f.value==="doughnut")return Q(j);if(f.value==="bar"){const ie=t.showCurrentState&&j.current?"current":j.weekEnd?"weekEnd":"weekStart";return Cl(j,ie,R)}const{weekStart:V,weekEnd:ae,current:ue}=j,pe=[],F=[];return R.forEach((ie,ve)=>{const Se=[];if(V&&V.statistics&&V.statistics.stages){const je=V.statistics.stages[ie.id];if(pe.length===0){const Tt=V.metadata?.createdAt?new Date(V.metadata.createdAt):null;pe.push(Tt?O(Tt):"Начало недели")}Se.push(je?.count||0)}else pe.length===0&&pe.push("Начало недели"),Se.push(0);if(ae&&ae.statistics&&ae.statistics.stages){const je=ae.statistics.stages[ie.id];if(pe.length===1){const Tt=ae.metadata?.createdAt?new Date(ae.metadata.createdAt):null;pe.push(Tt?O(Tt):"Конец недели")}Se.push(je?.count||0)}else pe.length===1&&pe.push("Конец недели"),Se.push(0);if(ue&&t.showCurrentState&&ue.statistics&&ue.statistics.stages){const je=ue.statistics.stages[ie.id];pe.length===2&&pe.push("Текущее состояние"),Se.push(je?.count||0)}const Me=["stable"];g.value?v.value==="weekStartToWeekEnd"?(Me.push(g.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),ue&&Me.push(g.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekEndToCurrent"&&ue?(Me.push("stable"),Me.push(g.value.weekEndToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekStartToCurrent"&&ue?(Me.push(g.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),Me.push(g.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):(Me.push("stable"),ue&&Me.push("stable")):(Me.push("stable"),ue&&Me.push("stable"));let ze,Le,We;g.value&&f.value!=="doughnut"?(ze=Me.map(je=>fe(je,"background")+"40"),Le=Me.map(je=>fe(je,"border")),We=Me.map(je=>fe(je,"point"))):(ze=ie.color+"40",Le=ie.color,We=ie.color);let Ge=null;f.value==="line"&&(Ge={employees:wl(ie.id,j)}),F.push({label:ie.name,data:Se,backgroundColor:(Array.isArray(ze),ze),borderColor:(Array.isArray(Le),Le),borderWidth:2,...f.value==="line"&&{pointStyle:G[ve%G.length]},pointBackgroundColor:(Array.isArray(We),We),pointBorderColor:(Array.isArray(Le),Le),pointRadius:7,pointHoverRadius:10,fill:f.value!=="line",tension:f.value==="line"?.4:0,meta:Ge})}),pe.length===0&&(pe.push("Начало недели","Конец недели"),t.showCurrentState&&pe.push("Текущее состояние")),{labels:pe,datasets:F}}const ke=async()=>{i.value=!0,n.value=null;try{const j=t.period?.endDate?new Date(t.period.endDate):new Date,V=t.period?.startDate?new Date(t.period.startDate):pt.getWeekStartDate(j),ae=t.period?.endDate?new Date(t.period.endDate):pt.getWeekEndDate(j),ue=pt.formatDate(V),pe=pt.formatDate(ae),[F,ie]=await Promise.all([pt.getSnapshot(ue,"week_start"),pt.getSnapshot(pe,"week_end")]);let ve=null;t.showCurrentState&&(ve=await Wa.getSectorDataForSnapshot({useCache:!1,normalize:!0})),d.value={weekStart:F,weekEnd:ie,current:ve},Z(),P(),K(),r("data-loaded",{weekStart:F,weekEnd:ie,current:ve})}catch(j){console.error("Error loading chart data:",j),n.value=j.message||"Ошибка загрузки данных графика",oe.error("Ошибка загрузки данных графика: "+n.value),r("error",n.value)}finally{i.value=!1}};$e(()=>{Je.register($d),Je.register(Md),Je.register(Nd),ke()});function _e(j){q.value=j}const K=()=>{const j=de({weekStart:d.value.weekStart,weekEnd:d.value.weekEnd,current:d.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==j?.labels?.length)l.value=j;else if(j){const V=JSON.stringify(l.value),ae=JSON.stringify(j);V!==ae&&(l.value=j)}};return Ne(()=>[t.period,t.showCurrentState],()=>{ke()},{deep:!0}),Ne(f,()=>{(d.value.weekStart||d.value.weekEnd||d.value.current)&&K()}),Ne(v,()=>{(d.value.weekStart||d.value.weekEnd||d.value.current)&&K()}),(j,V)=>(c(),u("div",xd,[s("div",Ld,[V[3]||(V[3]=s("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),s("div",Pd,[(c(),u(ee,null,te(C,ae=>s("button",{key:ae.value,onClick:ue=>f.value=ae.value,class:X(["chart-type-btn",{active:f.value===ae.value}]),title:ae.label},[s("span",Rd,m(ae.icon),1),s("span",Bd,m(ae.label),1)],10,Od)),64))])]),!i.value&&!n.value&&g.value&&f.value!=="doughnut"?(c(),u("div",Ud,[V[7]||(V[7]=s("h4",{class:"comparison-title"},"Тип сравнения:",-1)),s("div",Wd,[s("label",null,[Re(s("input",{type:"radio","onUpdate:modelValue":V[0]||(V[0]=ae=>v.value=ae),value:"weekStartToWeekEnd",onChange:K},null,544),[[Et,v.value]]),V[4]||(V[4]=s("span",null,"Начало недели → Конец недели",-1))]),d.value.current?(c(),u("label",Fd,[Re(s("input",{type:"radio","onUpdate:modelValue":V[1]||(V[1]=ae=>v.value=ae),value:"weekEndToCurrent",onChange:K},null,544),[[Et,v.value]]),V[5]||(V[5]=s("span",null,"Конец недели → Текущее состояние",-1))])):$("",!0),d.value.current?(c(),u("label",Hd,[Re(s("input",{type:"radio","onUpdate:modelValue":V[2]||(V[2]=ae=>v.value=ae),value:"weekStartToCurrent",onChange:K},null,544),[[Et,v.value]]),V[6]||(V[6]=s("span",null,"Начало недели → Текущее состояние",-1))])):$("",!0)])])):$("",!0),!i.value&&!n.value&&l.value?(c(),he(ll,{key:1,stages:R,selected:q.value,"onUpdate:selected":_e,onChange:K},null,8,["selected"])):$("",!0),!i.value&&!n.value&&g.value&&f.value!=="doughnut"?(c(),u("div",jd,[...V[8]||(V[8]=[_t('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):$("",!0),i.value?(c(),he(_a,{key:3,message:"Загрузка данных графика..."})):n.value?(c(),u("div",Vd,[s("p",zd,"❌ "+m(n.value),1),s("button",{onClick:ke,class:"btn-retry"},"Повторить загрузку")])):N.value?(c(),u("div",{key:5,class:X(["chart-container",`chart-type-${f.value}`])},[s("div",Gd,[s("div",Kd,[(c(),he(wt(E.value),{data:N.value,options:b.value},null,8,["data","options"]))]),f.value==="bar"?(c(),u("div",qd,[(c(),u(ee,null,te(R,ae=>s("div",{key:ae.id,class:"stage-label-item"},m(z(ae.id)),1)),64))])):$("",!0)])],2)):(c(),u("div",Yd,[...V[9]||(V[9]=[s("p",null,"📊 Нет данных для отображения",-1),s("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ne(kd,{"is-visible":p.value,"stage-name":y.value,"stage-id":S.value,"total-count":T.value,employees:k.value,others:_.value,snapshot:A.value,"ticket-details":U.value,"stage-switch-context":x.value,onClose:De},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},Jd=ce(Xd,[["__scopeId","data-v-cbba196a"]]),nt={USER_NOT_DETERMINED:"USER_NOT_DETERMINED",ACCESS_DENIED:"ACCESS_DENIED",API_ERROR:"API_ERROR"};class lt{constructor(e,a=null,t=null,r=null){this.allowed=e,this.errorCode=a,this.errorMessage=t,this.user=r}}class rt{static async checkAccess(){try{const e=Rt();if(console.log("AccessControlService.checkAccess - isInsideBitrix24:",e),console.log("AccessControlService.checkAccess - window.self === window.top:",window.self===window.top),console.log("AccessControlService.checkAccess - typeof BX24:",typeof BX24),e)console.log("AccessControlService.checkAccess - Inside Bitrix24, skipping direct access check");else{console.log("AccessControlService.checkAccess - Not inside Bitrix24, checking direct access config...");const{isDirectAccessAllowed:i,getDenyMessage:n}=await Ce(async()=>{const{isDirectAccessAllowed:d,getDenyMessage:g}=await import("./direct-access-config-Bm3k8CvE.js");return{isDirectAccessAllowed:d,getDenyMessage:g}},__vite__mapDeps([10,3]),import.meta.url),l=await i();if(console.log("AccessControlService.checkAccess - allowDirectAccess:",l),!l){const d=await n();return console.warn("Direct access denied: Application opened directly in browser, but direct access is disabled in config"),console.warn("Deny message:",d),new lt(!1,nt.ACCESS_DENIED,d,null)}console.log("Direct access allowed: Using primary administrator token from settings.php")}if(e)try{await Promise.race([kt.init(),new Promise((i,n)=>setTimeout(()=>n(new Error("Инициализация Bitrix24 API превысила 5 секунд")),5e3))])}catch(i){console.warn("BX24.init() failed, will try proxy API:",i)}let a;try{a=await Promise.race([kt.getCurrentUser(),new Promise((i,n)=>setTimeout(()=>n(new Error("Получение информации о пользователе превысило 10 секунд")),1e4))])}catch(i){console.warn("Bitrix24BxApi.getCurrentUser() failed, trying proxy API:",i);const{Bitrix24ApiProvider:n}=await Ce(async()=>{const{Bitrix24ApiProvider:l}=await import("./chunk-BuX-LpxK.js").then(d=>d.b);return{Bitrix24ApiProvider:l}},__vite__mapDeps([5,3]),import.meta.url);try{const l=await n.getInstance();a=await Promise.race([l.getCurrentUser(),new Promise((d,g)=>setTimeout(()=>g(new Error("Прокси API превысило 5 секунд")),5e3))]),console.log("Got user from proxy API:",a?.ID||"unknown")}catch(l){throw console.error("Both BX24 API and proxy API failed:",l),new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}if(!a||!a.ID)return console.warn("AccessControlService.checkAccess - user not determined:",a),new lt(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.");console.log("AccessControlService.checkAccess - user determined:",{id:a.ID,name:a.NAME,departments:a.UF_DEPARTMENT});const t=a.UF_DEPARTMENT||[];if(console.log("AccessControlService.checkAccess - departmentIds:",t),!Array.isArray(t)||t.length===0){if(console.log("AccessControlService.checkAccess - user has no departments"),!e){const{isDirectAccessAllowed:i}=await Ce(async()=>{const{isDirectAccessAllowed:l}=await import("./direct-access-config-Bm3k8CvE.js");return{isDirectAccessAllowed:l}},__vite__mapDeps([10,3]),import.meta.url);if(await i())return console.log("AccessControlService.checkAccess - Direct access allowed, granting access despite no departments"),new lt(!0,null,null,a)}return console.warn("AccessControlService.checkAccess - Access denied: user has no departments"),new lt(!1,nt.ACCESS_DENIED,"Доступ запрещён. Пользователь не привязан к отделу.")}const r=t.some(i=>ws(i));return console.log("AccessControlService.checkAccess - hasAccess:",r),r?(console.log("AccessControlService.checkAccess - Access granted"),new lt(!0,null,null,a)):(console.warn("AccessControlService.checkAccess - Access denied: no allowed departments"),new lt(!1,nt.ACCESS_DENIED,"Доступ запрещён"))}catch(e){return console.error("AccessControlService.checkAccess error:",e),e.message&&(e.message.includes("CORS")||e.message.includes("blocked")||e.message.includes("ERR_FAILED")||e.message.includes("unknown address space"))&&Rt()?(console.error("CORS error inside Bitrix24: Cannot determine interface user."),new lt(!1,nt.API_ERROR,"Ошибка CORS: не удалось определить пользователя интерфейса. Обратитесь в Поддержку приложения в ИТ отдел.")):e.message&&e.message.includes("not loaded")?new lt(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел."):new lt(!1,nt.API_ERROR,"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел.")}}static async getCurrentUser(){try{return Rt()&&await kt.init(),await kt.getCurrentUser()}catch(e){return console.error("AccessControlService.getCurrentUser error:",e),null}}}const Zd={key:0,class:"create-snapshot-button-container"},Qd=["disabled"],eu={class:"modal-content"},tu={class:"modal-header"},au=["disabled"],su={class:"modal-body"},ou={key:0,class:"progress-container"},nu={class:"progress-bar-wrapper"},ru={class:"progress-text"},iu={class:"progress-percent"},lu={class:"progress-description"},cu={key:1},du={class:"modal-footer"},uu=["disabled"],gu=["disabled"],mu={key:0},hu={key:0},fu={key:1},vu={key:2},pu={key:1},yu={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(o,{emit:e}){const a=o,t=e,r=M(a.user),i=M(!1),n=M(!1),l=M(0),d=M("idle"),g=M(""),v=mt(),C=I(()=>r.value?sa(r.value):!1);$e(async()=>{if(!a.user)try{const T=await rt.checkAccess();T.allowed&&(r.value=T.user)}catch(T){console.error("Error loading user:",T)}});const f=()=>{if(!C.value){v.warning("Только администраторы могут создавать слепки");return}i.value=!0},p=()=>{n.value||(i.value=!1,d.value="idle",l.value=0,g.value="")},y=async()=>{if(!n.value){if(!C.value){v.warning("Только администраторы могут создавать слепки");return}n.value=!0,d.value="loading_data",l.value=0,g.value="Инициализация загрузки данных...";try{g.value="Загрузка данных сектора из Bitrix24...";const T=await Wa.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:A=>{const U=Math.min(80,(A.progress||0)*.8);l.value=U,d.value="loading_data",g.value=A.description||A.details?.description||"Загрузка данных сектора..."}});d.value="creating_snapshot",l.value=85,g.value="Создание слепка...";const k=r.value;if(!k)throw new Error("Пользователь не определён");const _=await pt.createSnapshot(T,"manual",{createdBy:{id:k.ID,name:`${k.NAME||""} ${k.LAST_NAME||""}`.trim()||k.EMAIL||`User ${k.ID}`},sectorId:"1C"});d.value="success",l.value=100,g.value="Слепок успешно создан!",v.success("Слепок состояния сектора успешно создан"),t("snapshot-created",_),setTimeout(()=>{p()},1500)}catch(T){d.value="error",l.value=0,g.value="Ошибка создания слепка",console.error("Error creating snapshot:",T);let k="Ошибка создания слепка";T.message&&(T.message.includes("загрузки данных")||T.message.includes("sector data")?k="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":T.message.includes("создания слепка")||T.message.includes("snapshot")?k="Не удалось создать слепок. Обратитесь в поддержку.":T.message.includes("валидац")||T.message.includes("validation")?k="Ошибка валидации данных. Проверьте данные сектора.":k=T.message),v.error(k)}finally{n.value=!1}}},S=T=>{T.key==="Escape"&&i.value&&!n.value&&p()};return $e(()=>{window.addEventListener("keydown",S)}),at(()=>{window.removeEventListener("keydown",S)}),(T,k)=>C.value?(c(),u("div",Zd,[s("button",{class:"create-snapshot-btn",onClick:f,disabled:n.value,title:"Создать слепок состояния сектора"},[...k[1]||(k[1]=[s("span",{class:"btn-icon"},"📸",-1),s("span",{class:"btn-text"},"Создать слепок",-1)])],8,Qd),(c(),he(It,{to:"body"},[ne(Ae,{name:"modal"},{default:ye(()=>[i.value?(c(),u("div",{key:0,class:"modal-overlay",onClick:k[0]||(k[0]=Te(_=>!n.value&&p(),["self"]))},[s("div",eu,[s("div",tu,[k[2]||(k[2]=s("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),s("button",{class:"modal-close",onClick:p,disabled:n.value,"aria-label":"Закрыть"}," ✕ ",8,au)]),s("div",su,[d.value!=="idle"?(c(),u("div",ou,[s("div",nu,[s("div",{class:"progress-bar",style:we({width:`${l.value}%`})},null,4)]),s("div",ru,[s("span",iu,m(Math.round(l.value))+"%",1),s("span",lu,m(g.value),1)])])):(c(),u("div",cu,[...k[3]||(k[3]=[s("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),s("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),s("div",du,[s("button",{class:"btn btn-secondary",onClick:p,disabled:n.value}," Отмена ",8,uu),s("button",{class:"btn btn-primary",onClick:y,disabled:n.value},[n.value?(c(),u("span",mu,[d.value==="loading_data"?(c(),u("span",hu,"Загрузка данных...")):d.value==="creating_snapshot"?(c(),u("span",fu,"Создание...")):(c(),u("span",vu,"Обработка..."))])):(c(),u("span",pu,"Создать"))],8,gu)])])])):$("",!0)]),_:1})]))])):$("",!0)}},ku=ce(yu,[["__scopeId","data-v-09bccee2"]]),bu=20,_u=5*60*1e3;async function wu({search:o="",limit:e=bu,sectorDepartmentId:a=Jt.SECTOR_1C}={}){const t=`sector1c_employees_${o}_${e}_${a||"all"}`,r=sessionStorage.getItem(t);if(r)try{const{data:i,timestamp:n}=JSON.parse(r);if(Date.now()-n<_u)return i}catch(i){console.warn("[sector1cEmployees] Cache parse error:",i)}try{const i={ACTIVE:"Y"};a?Array.isArray(a)?i.UF_DEPARTMENT=a:i.UF_DEPARTMENT=[a]:i.UF_DEPARTMENT=[Jt.SECTOR_1C],o&&o.length>=2&&(i["%NAME"]=o,i["%LAST_NAME"]=o,i["%WORK_POSITION"]=o);const g=((await new vt().call("user.get",{filter:i,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,e).map(v=>({id:parseInt(v.ID),name:Cu(v),position:v.WORK_POSITION||"",department:v.UF_DEPARTMENT||null}));try{sessionStorage.setItem(t,JSON.stringify({data:g,timestamp:Date.now()}))}catch(v){console.warn("[sector1cEmployees] Cache write error:",v)}return g}catch(i){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",i),new Error(`Не удалось загрузить сотрудников: ${i.message}`)}}function Cu(o){const e=[o.LAST_NAME,o.NAME,o.SECOND_NAME].filter(Boolean);return e.length>0?e.join(" "):o.NAME||"Без имени"}function Tu(o,e=300){let a;return function(...r){const i=()=>{clearTimeout(a),o(...r)};clearTimeout(a),a=setTimeout(i,e)}}const Su={class:"employee-select-field-text"},Du={key:0,class:"employee-select-dropdown"},Eu={class:"employee-select-dropdown-search"},Au={key:0,class:"employee-select-state"},$u={key:1,class:"employee-select-state employee-select-state--error"},Iu={key:2,class:"employee-select-state"},Mu=["checked"],Nu=["checked","onChange"],xu={class:"employee-select-item-content"},Lu={class:"employee-select-item-name"},Pu={key:0,class:"employee-select-item-position"},Ou={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(o,{emit:e}){const a=o,t=e,r=M(null),i=M(null),n=M(""),l=M([]),d=M(!1),g=M(null),v=M(!1),C=I(()=>{if(!n.value)return l.value;const D=n.value.toLowerCase();return l.value.filter(E=>E.name.toLowerCase().includes(D)||E.position&&E.position.toLowerCase().includes(D))}),f=I(()=>{if(a.selected.includes("all")||a.selected.length===0)return a.placeholder;if(a.selected.length===1){const D=l.value.find(E=>E.id===a.selected[0]);return D?D.name:a.placeholder}return`Выбрано: ${a.selected.length} ${U(a.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function p(D=""){d.value=!0,g.value=null;try{l.value=await wu({search:D})}catch(E){g.value=E,t("error",E)}finally{d.value=!1}}function y(){t("search",n.value)}function S(){d.value||(v.value=!v.value,v.value?(l.value.length===0&&p(),Wt(()=>{i.value&&i.value.focus()})):n.value="")}function T(D){r.value&&!r.value.contains(D.target)&&(v.value=!1,n.value="")}function k(D){const E=[...a.selected],L=E.indexOf(D);if(D==="all")if(L>-1)E.splice(L,1);else return t("update:selected",["all"]);else if(L>-1)E.splice(L,1);else{const R=E.indexOf("all");R>-1&&E.splice(R,1),E.push(D)}t("update:selected",E)}function _(D){return D==="all"?a.selected.includes("all"):a.selected.includes(D)||a.selected.includes("all")}const A=I(()=>n.value?`Нет сотрудников по запросу "${n.value}"`:"Нет сотрудников сектора 1С");function U(D,E,L,R){const W=D%10,G=D%100;return G>=11&&G<=19?R:W===1?E:W>=2&&W<=4?L:R}function x(){p(n.value)}return Ne(()=>a.selected,D=>{(!D||D.length===0)&&t("update:selected",["all"])},{immediate:!0}),$e(()=>{document.addEventListener("click",T),(!a.selected||a.selected.length===0)&&t("update:selected",["all"])}),at(()=>{document.removeEventListener("click",T)}),(D,E)=>(c(),u("div",{class:"employee-select",ref_key:"selectContainer",ref:r},[s("div",{class:X(["employee-select-field",{"employee-select-field--open":v.value,"employee-select-field--disabled":d.value}]),onClick:S},[s("span",Su,m(f.value),1),s("span",{class:X(["employee-select-field-icon",{open:v.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:ye(()=>[v.value?(c(),u("div",Du,[s("div",Eu,[Re(s("input",{"onUpdate:modelValue":E[0]||(E[0]=L=>n.value=L),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:y,onClick:E[1]||(E[1]=Te(()=>{},["stop"])),ref_key:"searchInput",ref:i},null,544),[[At,n.value]])]),d.value?(c(),u("div",Au,[...E[6]||(E[6]=[s("span",{class:"spinner"},"⏳",-1),s("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):g.value?(c(),u("div",$u,[s("span",null,"❌ "+m(g.value.message||"Ошибка загрузки сотрудников"),1),s("button",{onClick:[x,E[2]||(E[2]=Te(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!d.value&&C.value.length===0&&!g.value?(c(),u("div",Iu,[s("span",null,"📭 "+m(A.value),1)])):(c(),u("div",{key:3,class:"employee-select-list",style:we({maxHeight:`${o.maxHeight}px`})},[s("label",{class:X(["employee-select-item",{"employee-select-item--selected":_("all")}]),onClick:E[4]||(E[4]=Te(()=>{},["stop"]))},[s("input",{type:"checkbox",checked:_("all"),onChange:E[3]||(E[3]=L=>k("all"))},null,40,Mu),E[7]||(E[7]=s("div",{class:"employee-select-item-content"},[s("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(c(!0),u(ee,null,te(C.value,L=>(c(),u("label",{key:L.id,class:X(["employee-select-item",{"employee-select-item--selected":_(L.id)}]),onClick:E[5]||(E[5]=Te(()=>{},["stop"]))},[s("input",{type:"checkbox",checked:_(L.id),onChange:R=>k(L.id)},null,40,Nu),s("div",xu,[s("span",Lu,m(L.name),1),L.position?(c(),u("span",Pu,m(L.position),1)):$("",!0)])],2))),128))],4))])):$("",!0)]),_:1})],512))}},Ru=ce(Ou,[["__scopeId","data-v-6b8c949b"]]),Bu={class:"stage-select-field-text"},Uu={key:0,class:"stage-select-dropdown"},Wu={class:"stage-select-list"},Fu=["checked"],Hu=["checked","onChange"],ju={class:"stage-select-item-content"},Vu={class:"stage-select-item-name"},zu={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(o,{emit:e}){const a=o,t=e,r=M(null),i=M(!1),n=I(()=>Object.values(a.selected).every(f=>f===!0)),l=I(()=>{if(n.value)return a.placeholder;const f=a.stages.filter(p=>a.selected[p.id]);return f.length===0?"Этапы не выбраны":f.length===1?f[0].name:`Выбрано: ${f.length} этапа(ов)`});function d(){i.value=!i.value,i.value}function g(f){r.value&&!r.value.contains(f.target)&&(i.value=!1)}function v(f,p){const y={...a.selected};y[f]=p,t("update:selected",y),t("change",f,p)}function C(){const f=n.value,p={};a.stages.forEach(y=>{p[y.id]=!f}),t("update:selected",p),t("change","all",!f)}return $e(()=>{document.addEventListener("click",g)}),at(()=>{document.removeEventListener("click",g)}),(f,p)=>(c(),u("div",{class:"stage-select",ref_key:"selectContainer",ref:r},[s("div",{class:X(["stage-select-field",{"stage-select-field--open":i.value,"stage-select-field--disabled":!1}]),onClick:d},[s("span",Bu,m(l.value),1),s("span",{class:X(["stage-select-field-icon",{open:i.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:ye(()=>[i.value?(c(),u("div",Uu,[s("div",Wu,[s("label",{class:X(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:p[0]||(p[0]=Te(()=>{},["stop"]))},[s("input",{type:"checkbox",checked:n.value,onChange:C},null,40,Fu),p[2]||(p[2]=s("div",{class:"stage-select-item-content"},[s("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(c(!0),u(ee,null,te(o.stages,y=>(c(),u("label",{key:y.id,class:X(["stage-select-item",{"stage-select-item--selected":o.selected[y.id]}]),onClick:p[1]||(p[1]=Te(()=>{},["stop"]))},[s("input",{type:"checkbox",checked:o.selected[y.id],onChange:S=>v(y.id,S.target.checked)},null,40,Hu),s("div",ju,[s("span",{class:"stage-select-item-color",style:we({backgroundColor:y.color})},null,4),s("span",Vu,m(y.name),1)])],2))),128))])])):$("",!0)]),_:1})],512))}},Gu=ce(zu,[["__scopeId","data-v-ce2229b2"]]),Ku={class:"trigger-text"},qu={class:"week-picker-items"},Yu=["data-week-number","onClick"],Xu={class:"week-item-content"},Ju={class:"week-number"},Zu={class:"week-dates"},Qu={class:"week-picker-actions"},eg=["disabled"],tg={__name:"WeekPicker",props:{selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52}},emits:["update:selectedWeek","change"],setup(o,{emit:e}){const a=o,t=e,r=M(null),i=M(null),n=M([]),l=M(!1),d=M(!1),g=M(null);function v(x=52,D=4){const E=[],L=new Date,R=C(L),W=f(L);for(let G=0;G<x;G++){const q=new Date(R.start);q.setUTCDate(q.getUTCDate()-G*7);const oe=C(q),Y=f(q);E.unshift({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}(E.length===0||E[E.length-1].weekNumber!==W)&&E.push({weekNumber:W,startUtc:R.start.toISOString(),endUtc:R.end.toISOString(),start:R.start,end:R.end});for(let G=1;G<=D;G++){const q=new Date(R.start);q.setUTCDate(q.getUTCDate()+G*7);const oe=C(q),Y=f(q);E.push({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}return E.sort((G,q)=>G.start-q.start),E}function C(x){const D=new Date(x),E=D.getUTCDay(),L=D.getUTCDate()-E+(E===0?-6:1),R=new Date(Date.UTC(D.getUTCFullYear(),D.getUTCMonth(),L,0,0,0)),W=new Date(R);return W.setUTCDate(W.getUTCDate()+6),W.setUTCHours(23,59,59,999),{start:R,end:W}}function f(x){const D=new Date(Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()));D.setUTCDate(D.getUTCDate()+4-(D.getUTCDay()||7));const E=new Date(Date.UTC(D.getUTCFullYear(),0,1));return Math.ceil(((D-E)/864e5+1)/7)}function p(x){const D=new Date(x),E=D.getUTCFullYear(),L=String(D.getUTCMonth()+1).padStart(2,"0"),R=String(D.getUTCDate()).padStart(2,"0");return`${E}-${L}-${R}`}function y(){d.value=!d.value,d.value&&(n.value=v(a.weeksCount,4),g.value=a.selectedWeek||n.value.find(x=>{const E=f(new Date);return x.weekNumber===E})||n.value[0],Wt(()=>{g.value&&_(g.value.weekNumber)}))}function S(x){g.value=x,_(x.weekNumber)}function T(){g.value&&(t("update:selectedWeek",g.value),t("change",g.value),d.value=!1)}function k(){g.value=a.selectedWeek||null,d.value=!1}function _(x){if(!i.value)return;const D=i.value.querySelector(`[data-week-number="${x}"]`);if(D){const E=i.value,L=D.offsetTop,R=E.clientHeight,W=D.clientHeight,G=L-R/2+W/2;E.scrollTo({top:G,behavior:"smooth"})}}function A(){l.value||!d.value||(l.value=!0,clearTimeout(window.weekPickerScrollTimeout),window.weekPickerScrollTimeout=setTimeout(()=>{if(!i.value){l.value=!1;return}const x=i.value,D=x.getBoundingClientRect(),E=D.top+D.height/2,L=x.querySelectorAll(".week-picker-item");let R=null,W=1/0;if(L.forEach(G=>{const q=G.getBoundingClientRect(),oe=q.top+q.height/2,Y=Math.abs(oe-E);Y<W&&(W=Y,R=G)}),R){const G=parseInt(R.dataset.weekNumber),q=n.value.find(oe=>oe.weekNumber===G);q&&(!g.value||q.weekNumber!==g.value.weekNumber)&&(g.value=q)}l.value=!1},150))}function U(x){r.value&&!r.value.contains(x.target)&&d.value&&k()}return $e(()=>{if(n.value=v(a.weeksCount,4),a.selectedWeek)g.value=a.selectedWeek;else{const D=f(new Date),E=n.value.find(L=>L.weekNumber===D);E?g.value=E:g.value=n.value[0]}document.addEventListener("click",U)}),at(()=>{window.weekPickerScrollTimeout&&clearTimeout(window.weekPickerScrollTimeout),document.removeEventListener("click",U)}),Ne(()=>a.selectedWeek,x=>{x&&(g.value=x,d.value&&!l.value&&Wt(()=>{_(x.weekNumber)}))},{deep:!0}),(x,D)=>(c(),u("div",{class:"week-picker",ref_key:"pickerContainer",ref:r},[D[1]||(D[1]=s("div",{class:"week-picker-label"},[s("span",{class:"section-icon"},"📅"),s("span",null,"Период")],-1)),s("div",{class:X(["week-picker-trigger",{"is-open":d.value}]),onClick:y},[s("span",Ku,[o.selectedWeek?(c(),u(ee,{key:0},[ge(" Неделя "+m(o.selectedWeek.weekNumber)+" · "+m(p(o.selectedWeek.startUtc))+" — "+m(p(o.selectedWeek.endUtc)),1)],64)):(c(),u(ee,{key:1},[ge(" Выберите неделю ")],64))]),s("span",{class:X(["trigger-icon",{"is-open":d.value}])},"▼",2)],2),ne(Ae,{name:"dropdown-fade"},{default:ye(()=>[d.value?(c(),u("div",{key:0,class:"week-picker-dropdown",onClick:D[0]||(D[0]=Te(()=>{},["stop"]))},[s("div",{class:"week-picker-wheel",ref_key:"wheelContainer",ref:i,onScroll:A},[s("div",qu,[(c(!0),u(ee,null,te(n.value,(E,L)=>(c(),u("div",{key:E.weekNumber,class:X(["week-picker-item",{active:E.weekNumber===g.value?.weekNumber}]),"data-week-number":E.weekNumber,onClick:R=>S(E)},[s("div",Xu,[s("div",Ju,"Неделя "+m(E.weekNumber),1),s("div",Zu,m(p(E.startUtc))+" — "+m(p(E.endUtc)),1)])],10,Yu))),128))])],544),s("div",Qu,[s("button",{class:"btn-cancel",onClick:k},"Отмена"),s("button",{class:"btn-apply",onClick:T,disabled:!g.value},"Применить",8,eg)])])):$("",!0)]),_:1})],512))}},ag=ce(tg,[["__scopeId","data-v-daae25a6"]]),sg={class:"filters-panel"},og={class:"filters-header"},ng=["disabled"],rg={class:"filters-content"},ig={key:0,class:"filter-section"},lg={class:"section-content"},cg={class:"filter-section"},dg={class:"section-content"},ug={class:"filter-section"},gg={key:0,class:"section-content"},mg={class:"section-content"},hg={key:0,class:"period-mode-group"},fg=["value"],vg=["disabled"],pg=["disabled"],yg={key:0,class:"period-mode-hint"},kg={key:1,class:"period-mode-hint"},bg=["value"],_g={key:0,class:"custom-date-range"},wg={class:"date-range-inputs"},Cg={class:"date-input-group"},Tg=["value","max"],Sg={class:"date-input-group"},Dg=["value","min","max"],Eg={key:0,class:"filter-error"},Ag={key:1,class:"filter-hint"},$g={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1},hideStages:{type:Boolean,default:!1},weekPickerMode:{type:Boolean,default:!1},selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52},showPeriodMode:{type:Boolean,default:!1},periodMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","update:selectedWeek","update:periodMode","reset","apply"],setup(o,{emit:e}){const a=o,t=e,r=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],i=M(null),n=I(()=>{const T=new Date;return T.setFullYear(T.getFullYear()-1),T.toISOString().split("T")[0]}),l=I(()=>new Date().toISOString().split("T")[0]);function d(T){t("update:stages",T),t("apply")}function g(T,k){t("apply")}function v(T){t("update:employees",T),t("apply")}function C(T){t("update:dateRange",T),i.value=null,t("apply")}function f(T,k){const _={...a.customDateRange};if(_[T]=k,_.startDate&&_.endDate){const A=new Date(_.startDate),U=new Date(_.endDate);if(A>U){i.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((U-A)/(1e3*60*60*24))>365){i.value="Период не может превышать 365 дней";return}}i.value=null,t("update:customDateRange",_),t("apply")}function p(T){t("update:selectedWeek",T),t("apply")}function y(T){if(!["weeks","months"].includes(T)){console.warn("[FiltersPanel] Invalid periodMode:",T);return}T!==a.periodMode&&(t("update:periodMode",T),t("apply"))}function S(){i.value=null,t("reset")}return(T,k)=>(c(),u("div",sg,[s("div",og,[k[4]||(k[4]=s("h2",null,"Фильтры",-1)),s("button",{onClick:S,class:"btn-reset-filters",disabled:!o.hasActiveFilters}," Сбросить фильтры ",8,ng)]),s("div",rg,[o.hideStages?$("",!0):(c(),u("div",ig,[k[5]||(k[5]=s("h3",{class:"section-title"},[s("span",{class:"section-icon"},"📊"),ge(" Этапы ")],-1)),s("div",lg,[ne(Gu,{selected:o.stages,stages:r,placeholder:"Выберите этапы","onUpdate:selected":d,onChange:g},null,8,["selected"])])])),s("div",cg,[k[6]||(k[6]=s("h3",{class:"section-title"},[s("span",{class:"section-icon"},"👥"),ge(" Сотрудники сектора 1С ")],-1)),s("div",dg,[ne(Ru,{selected:o.employees,"onUpdate:selected":v},null,8,["selected"])])]),s("div",ug,[o.weekPickerMode?(c(),u("div",gg,[ne(ag,{selectedWeek:o.selectedWeek,weeksCount:o.weeksCount,"onUpdate:selectedWeek":p,onChange:p},null,8,["selectedWeek","weeksCount"])])):(c(),u(ee,{key:1},[k[11]||(k[11]=s("h3",{class:"section-title"},[s("span",{class:"section-icon"},"📅"),ge(" Период ")],-1)),s("div",mg,[o.showPeriodMode?(c(),u("div",hg,[k[7]||(k[7]=s("label",{class:"period-mode-label"},"Режим отображения:",-1)),s("select",{value:o.periodMode,onChange:k[0]||(k[0]=_=>y(_.target.value)),class:X(["period-mode-select",{"period-mode-select--current-weeks":o.periodMode==="weeks","period-mode-select--current-months":o.periodMode==="months"}])},[s("option",{value:"weeks",disabled:o.periodMode==="weeks"}," 4 последние недели ",8,vg),s("option",{value:"months",disabled:o.periodMode==="months"}," 3 последних месяца ",8,pg)],42,fg),o.periodMode==="weeks"?(c(),u("small",yg," Текущий режим: 4 последние недели ")):o.periodMode==="months"?(c(),u("small",kg," Текущий режим: 3 последних месяца ")):$("",!0)])):$("",!0),o.showPeriodMode?$("",!0):(c(),u(ee,{key:1},[s("select",{value:o.dateRange,onChange:k[1]||(k[1]=_=>C(_.target.value)),class:"date-range-select"},[...k[8]||(k[8]=[s("option",{value:"last-week"},"Последняя неделя",-1),s("option",{value:"last-2-weeks"},"Последние 2 недели",-1),s("option",{value:"last-month"},"Последний месяц",-1),s("option",{value:"custom"},"Произвольный период",-1)])],40,bg),o.dateRange==="custom"?(c(),u("div",_g,[s("div",wg,[s("div",Cg,[k[9]||(k[9]=s("label",null,"С:",-1)),s("input",{type:"date",value:o.customDateRange.startDate,onChange:k[2]||(k[2]=_=>f("startDate",_.target.value)),max:o.customDateRange.endDate||l.value,class:"date-input"},null,40,Tg)]),s("div",Sg,[k[10]||(k[10]=s("label",null,"По:",-1)),s("input",{type:"date",value:o.customDateRange.endDate,onChange:k[3]||(k[3]=_=>f("endDate",_.target.value)),min:o.customDateRange.startDate||n.value,max:l.value,class:"date-input"},null,40,Dg)])]),i.value?(c(),u("small",Eg,m(i.value),1)):(c(),u("small",Ag," Выберите начальную и конечную дату для отображения данных "))])):$("",!0)],64))])],64))])])]))}},ja=ce($g,[["__scopeId","data-v-5970a362"]]);function Ig(){const o=M(!1),e=M(null),a=M(null),t=M(0),r=mt(),i=async(T=!0,k=null)=>{o.value=!0,e.value=null,t.value=0;try{const _=await Wa.getSectorDataForSnapshot({useCache:T,onProgress:A=>{A&&typeof A.progress=="number"&&(t.value=A.progress),k&&k(A)},normalize:!0});return a.value=_,_}catch(_){throw e.value=_.message||"Ошибка загрузки данных сектора",r.error("Ошибка загрузки данных сектора: "+e.value),_}finally{o.value=!1,t.value=100}},n=async(T,k={})=>{if(!a.value){const _="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw e.value=_,r.error(_),new Error(_)}o.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(T))throw new Error(`Неверный тип слепка: ${T}. Допустимые значения: week_start, week_end, manual, current`);const _=await pt.createSnapshot(a.value,T,k);return r.success("Слепок успешно создан"),_}catch(_){throw e.value=_.message||"Ошибка создания слепка",r.error("Ошибка создания слепка: "+e.value),_}finally{o.value=!1}},l=()=>{o.value=!1,e.value=null,a.value=null,t.value=0},d=I(()=>a.value!==null&&a.value!==void 0),g=M({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),v=I(()=>{const T=new Date;let k,_;switch(g.value.dateRange){case"last-week":k=new Date(T),k.setDate(T.getDate()-7),_=T;break;case"last-2-weeks":k=new Date(T),k.setDate(T.getDate()-14),_=T;break;case"last-month":k=new Date(T),k.setMonth(T.getMonth()-1),_=T;break;case"custom":k=g.value.customDateRange.startDate?new Date(g.value.customDateRange.startDate):null,_=g.value.customDateRange.endDate?new Date(g.value.customDateRange.endDate):null;break;default:k=new Date(T),k.setDate(T.getDate()-7),_=T}return{startDate:k?k.toISOString().split("T")[0]:null,endDate:_?_.toISOString().split("T")[0]:null}}),C=()=>{p()},f=()=>{g.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},p()},p=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(g.value))}catch(T){console.error("Ошибка сохранения фильтров в localStorage:",T)}},y=()=>{try{const T=localStorage.getItem("graphStateFilters");if(T){const k=JSON.parse(T);k&&typeof k=="object"&&(g.value={stages:k.stages||{formed:!0,review:!0,execution:!0},employees:k.employees||["all"],dateRange:k.dateRange||"last-week",customDateRange:k.customDateRange||{startDate:null,endDate:null}})}}catch(T){console.error("Ошибка загрузки фильтров из localStorage:",T)}},S=I(()=>{const T=Object.values(g.value.stages).some(A=>!A),k=!g.value.employees.includes("all"),_=g.value.dateRange!=="last-week";return T||k||_});return{isLoading:o,error:e,currentSectorData:a,loadingProgress:t,hasSectorData:d,filters:g,selectedPeriod:v,hasActiveFilters:S,loadSectorDataForSnapshot:i,createSnapshot:n,resetState:l,applyFilters:C,resetFilters:f,saveFiltersToLocalStorage:p,loadFiltersFromLocalStorage:y}}const Mg={class:"graph-state-dashboard"},Ng={key:1,class:"error-message-container"},xg={class:"error-message"},Lg={class:"error-text"},Pg={key:0,class:"error-details"},Og={class:"dashboard-header"},Rg={class:"header-content"},Bg={class:"breadcrumbs-row"},Ug=["aria-disabled","data-fallback","disabled"],Wg={class:"breadcrumbs","aria-label":"Навигация"},Fg={class:"header-actions"},Hg=["disabled"],jg={key:0},Vg={key:1},zg={key:3,class:"dashboard-content"},Gg={class:"chart-container"},Kg="Назад",qg={__name:"GraphStateDashboard",setup(o){const e=(se,me)=>typeof window>"u"?me:getComputedStyle(document.documentElement).getPropertyValue(se).trim()||me,a=mt(),t=Xe(),r={name:"dashboard-sector-1c"},{filters:i,selectedPeriod:n,hasActiveFilters:l,applyFilters:d,resetFilters:g,loadFiltersFromLocalStorage:v}=Ig(),C=M(null),f=M(!0),p=M(!1),y=M("Загрузка данных..."),S=M(null),T=M(!1),k=M(!1),_=M(typeof window<"u"?window.innerWidth:1024),A=M(null),U=M(!1),x=I(()=>_.value<768);I(()=>_.value>=768&&_.value<1024),I(()=>_.value>=1024);const D=I(()=>typeof window>"u"?!1:window.history.length>1);I(()=>{const se=new Date;return se.setFullYear(se.getFullYear()-1),se.toISOString().split("T")[0]}),I(()=>new Date().toISOString().split("T")[0]);function E(se){i.value.stages=se}function L(se){i.value.employees=se}function R(se){i.value.dateRange=se}function W(se){i.value.customDateRange=se}function G(){d()}function q(){g(),A.value=null,G(),a.info("Фильтры сброшены")}function oe(se){a.success("Слепок успешно создан")}function Y(se){p.value=!1,y.value="",console.log("Данные графика загружены:",se)}function H(se){p.value=!1,Z({message:se||"Ошибка загрузки графика",details:null,type:"error"})}function Z(se){S.value={message:se.message||"Произошла ошибка",details:se.details||null,type:se.type||"error",timestamp:new Date},console.error("Dashboard error:",S.value),a.error(S.value.message)}function fe(){S.value=null}function P(){S.value=null,p.value=!0,y.value="Повторная загрузка данных..."}async function h(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){a.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}T.value=!0;try{const se=document.querySelector(".chart-container");if(!se)throw new Error("График не найден");const me=window.html2canvas,De=await me(se,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),Ie=window.jsPDF,xe=new Ie("landscape","mm","a4"),He=297,z=De.height*He/De.width;xe.setFontSize(18),xe.text("График состояния сектора 1С",148.5,15,{align:"center"});const N=new Date().toLocaleDateString("ru-RU");xe.setFontSize(10);const b=n.value.startDate&&n.value.endDate?`Период: ${n.value.startDate} - ${n.value.endDate}`:"Период: не указан";xe.text(b,148.5,25,{align:"center"}),xe.text(`Экспорт от ${N}`,148.5,30,{align:"center"}),xe.addImage(De.toDataURL("image/png"),"PNG",10,35,He-20,z-20),xe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${N}`,author:"Bitrix24 Dashboard"});const O=`graph-state-${N.replace(/\//g,"-")}.pdf`;xe.save(O),a.success("График успешно экспортирован в PDF")}catch(se){console.error("Ошибка экспорта в PDF:",se),Z({message:"Ошибка экспорта в PDF: "+(se.message||"Неизвестная ошибка"),details:se.stack,type:"error"})}finally{T.value=!1}}function w(se){if(se?.preventDefault?.(),!U.value){U.value=!0;try{if(D.value){t.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),t.push(r)}finally{U.value=!1}}}function B(){t.push("/")}function re(){typeof window<"u"&&(_.value=window.innerWidth)}async function le(){try{const se=await rt.checkAccess();se.allowed&&(C.value=se.user)}catch(se){console.error("Error loading user:",se)}}return $e(()=>{v(),le(),typeof window<"u"&&(_.value=window.innerWidth,window.addEventListener("resize",re))}),at(()=>{typeof window<"u"&&window.removeEventListener("resize",re)}),(se,me)=>{const De=be("router-link");return c(),u("div",Mg,[p.value?(c(),he(_a,{key:0,message:y.value},null,8,["message"])):$("",!0),S.value?(c(),u("div",Ng,[s("div",xg,[s("div",{class:"error-header"},[me[1]||(me[1]=s("span",{class:"error-icon"},"❌",-1)),me[2]||(me[2]=s("h3",null,"Ошибка",-1)),s("button",{onClick:fe,class:"error-close","aria-label":"Закрыть"},"✕")]),s("p",Lg,m(S.value.message),1),S.value.details?(c(),u("div",Pg,[s("details",null,[me[3]||(me[3]=s("summary",null,"Детали ошибки",-1)),s("pre",null,m(S.value.details),1)])])):$("",!0),s("div",{class:"error-actions"},[s("button",{onClick:P,class:"btn-retry"},"Повторить попытку")])])])):$("",!0),s("div",Og,[s("div",Rg,[s("div",Bg,[s("button",{class:"btn-home-link",type:"button",onClick:B,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),me[9]||(me[9]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),s("button",{class:"btn-back-link",type:"button",onClick:w,"aria-label":Kg,"aria-disabled":!D.value,"data-fallback":!D.value,disabled:U.value,title:"Назад"}," ← ",8,Ug),s("nav",Wg,[ne(De,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:ye(()=>[...me[4]||(me[4]=[ge(" Дашборд сектора 1С ",-1)])]),_:1}),me[6]||(me[6]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),me[7]||(me[7]=s("span",{class:"breadcrumb-current"},"График состояния",-1)),me[8]||(me[8]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(De,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:ye(()=>[...me[5]||(me[5]=[ge(" График приёма и закрытий ",-1)])]),_:1})])]),me[10]||(me[10]=s("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),me[11]||(me[11]=s("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),s("div",Fg,[s("button",{onClick:h,class:"btn-export-pdf",disabled:T.value||p.value,title:"Экспортировать график в PDF"},[T.value?(c(),u("span",Vg,"⏳ Экспорт...")):(c(),u("span",jg,"📄 Экспорт в PDF"))],8,Hg),ne(ku,{user:C.value,onSnapshotCreated:oe},null,8,["user"])])]),x.value?(c(),u("button",{key:2,class:"mobile-filters-toggle",onClick:me[0]||(me[0]=Ie=>k.value=!k.value)},[me[12]||(me[12]=s("span",null,"Фильтры",-1)),s("span",{class:X(["toggle-icon",{open:k.value}])},"▼",2)])):$("",!0),s("div",{class:X({"mobile-open":k.value&&x.value,"mobile-closed":!k.value&&x.value})},[ne(ja,{stages:Ue(i).stages,employees:Ue(i).employees,dateRange:Ue(i).dateRange,customDateRange:Ue(i).customDateRange,hasActiveFilters:Ue(l),"onUpdate:stages":E,"onUpdate:employees":L,"onUpdate:dateRange":R,"onUpdate:customDateRange":W,onReset:q,onApply:G},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!p.value&&!S.value?(c(),u("div",zg,[s("div",Gg,[ne(Jd,{period:Ue(n),"show-current-state":f.value,onDataLoaded:Y,onError:H},null,8,["period","show-current-state"])])])):$("",!0)])}}},Os=ce(qg,[["__scopeId","data-v-831b0079"]]),Yg=Object.freeze(Object.defineProperty({__proto__:null,default:Os},Symbol.toStringTag,{value:"Module"})),Xg={key:0,class:"modal-overlay"},Jg={class:"modal-container",role:"dialog","aria-labelledby":"modal-title","aria-modal":"true"},Zg={class:"modal-body"},Qg={class:"mode-description"},em={__name:"PeriodModeInfoModal",props:{isVisible:{type:Boolean,required:!0},currentMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["close","start-loading","select-mode"],setup(o,{emit:e}){const a=o,t=e,r=M(a.currentMode);function i(d){if(!["weeks","months"].includes(d)){console.warn("[PeriodModeInfoModal] Invalid mode:",d);return}r.value=d,console.log("[DEBUG Modal] handleModeSelect: mode =",d),console.log("[DEBUG Modal] Emitting select-mode event"),t("select-mode",d),console.log("[DEBUG Modal] Emitting close event"),t("close"),console.log("[DEBUG Modal] Scheduling start-loading event in 100ms"),setTimeout(()=>{console.log("[DEBUG Modal] Emitting start-loading event"),t("start-loading")},100)}function n(){console.log("[DEBUG Modal] handleClose called, selectedMode =",r.value),console.log("[DEBUG Modal] Emitting select-mode event with",r.value),t("select-mode",r.value),console.log("[DEBUG Modal] Emitting close event"),t("close")}function l(d){d.key==="Escape"&&a.isVisible&&n()}return Ne(()=>a.currentMode,d=>{["weeks","months"].includes(d)&&(r.value=d)}),$e(()=>{a.isVisible&&document.addEventListener("keydown",l)}),at(()=>{document.removeEventListener("keydown",l)}),Ne(()=>a.isVisible,d=>{d?(document.addEventListener("keydown",l),r.value=a.currentMode):document.removeEventListener("keydown",l)}),(d,g)=>(c(),he(It,{to:"body"},[ne(Ae,{name:"modal-fade"},{default:ye(()=>[o.isVisible?(c(),u("div",Xg,[s("div",Jg,[s("div",{class:"modal-header"},[g[2]||(g[2]=s("h2",{id:"modal-title",class:"modal-title"},[s("span",{class:"modal-icon"},"ℹ️"),ge(" Выбор режима отображения ")],-1)),s("button",{class:"modal-close-btn",onClick:n,"aria-label":"Закрыть",type:"button"}," × ")]),s("div",Zg,[g[5]||(g[5]=s("p",{class:"modal-description"}," Выберите режим отображения данных для графика приёма и закрытий: ",-1)),s("div",Qg,[s("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="weeks"}]),onClick:g[0]||(g[0]=v=>i("weeks")),type:"button"},[...g[3]||(g[3]=[s("div",{class:"mode-header"},[s("span",{class:"mode-icon"},"📅"),s("h3",{class:"mode-title"},"4 последние недели")],-1),s("p",{class:"mode-text"}," Отображение данных за последние 4 недели с детализацией по неделям. Подходит для краткосрочного анализа динамики поступления и закрытия тикетов. ",-1)])],2),s("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="months"}]),onClick:g[1]||(g[1]=v=>i("months")),type:"button"},[...g[4]||(g[4]=[s("div",{class:"mode-header"},[s("span",{class:"mode-icon"},"📊"),s("h3",{class:"mode-title"},"3 последних месяца")],-1),s("p",{class:"mode-text"}," Отображение данных за последние 3 месяца с детализацией по месяцам и неделям внутри месяцев. Подходит для долгосрочного анализа и выявления трендов. ",-1)])],2)])])])])):$("",!0)]),_:1})]))}},tm=ce(em,[["__scopeId","data-v-4a42a9a6"]]),am={class:"ac-chart"},sm={class:"ac-chart__header"},om={class:"ac-chart__subtitle"},nm={class:"ac-chart__controls"},rm={class:"chart-type-selector"},im=["onClick"],lm={class:"chart-type-icon"},cm={class:"chart-type-label"},dm={class:"ac-chart__summary"},um={class:"summary-week-block summary-week-block--current"},gm={class:"summary-week-block__title"},mm={class:"summary-week-block__title-week"},hm={key:0,class:"summary-week-block__title-dates"},fm={class:"summary-week-block__cards"},vm={class:"summary-card__value-wrapper"},pm={class:"summary-card__value"},ym=["title"],km={class:"percentage-indicator__arrow"},bm={class:"percentage-indicator__value"},_m={class:"percentage-indicator__label"},wm={class:"summary-card__value-wrapper"},Cm={class:"summary-card__value-main"},Tm=["title"],Sm={class:"percentage-indicator__arrow"},Dm={class:"percentage-indicator__value"},Em={class:"percentage-indicator__label"},Am={class:"summary-card__breakdown"},$m={class:"breakdown-item breakdown-item--this-week"},Im={class:"breakdown-item__value"},Mm={class:"breakdown-item breakdown-item--other-week"},Nm={class:"breakdown-item__value"},xm={class:"summary-card__value-wrapper"},Lm={class:"summary-card__value-main"},Pm=["title"],Om={class:"percentage-indicator__arrow"},Rm={class:"percentage-indicator__value"},Bm={class:"percentage-indicator__label"},Um={class:"summary-card__breakdown"},Wm={class:"breakdown-item breakdown-item--this-week"},Fm={class:"breakdown-item__value"},Hm={class:"breakdown-item breakdown-item--previous-week"},jm={class:"breakdown-item__value"},Vm={class:"breakdown-item breakdown-item--older"},zm={class:"breakdown-item__value"},Gm={class:"summary-card summary-card--stages"},Km={class:"summary-card__tags"},qm={key:0,class:"stage-tag stage-tag--empty"},Ym={key:0,class:"summary-week-divider"},Xm={key:1,class:"summary-week-block summary-week-block--previous"},Jm={class:"summary-week-block__title"},Zm={class:"summary-week-block__title-week"},Qm={key:0,class:"summary-week-block__title-dates"},eh={class:"summary-week-block__cards"},th={class:"summary-card__value-wrapper"},ah={class:"summary-card__values-comparison"},sh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},oh={class:"summary-card__value"},nh={class:"value-label"},rh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},ih={class:"summary-card__value summary-card__value--current-week"},lh={class:"value-label"},ch=["title"],dh={class:"percentage-indicator__arrow"},uh={class:"percentage-indicator__value"},gh={class:"percentage-indicator__label"},mh={class:"summary-card__value-wrapper"},hh={class:"summary-card__values-comparison"},fh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},vh={class:"summary-card__value-main"},ph={class:"value-label"},yh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},kh={class:"summary-card__value-main summary-card__value-main--current-week"},bh={class:"value-label"},_h=["title"],wh={class:"percentage-indicator__arrow"},Ch={class:"percentage-indicator__value"},Th={class:"percentage-indicator__label"},Sh={class:"summary-card__breakdown"},Dh={class:"breakdown-item breakdown-item--this-week"},Eh={class:"breakdown-item__value"},Ah={class:"breakdown-item breakdown-item--other-week"},$h={class:"breakdown-item__value"},Ih={class:"summary-card__value-wrapper"},Mh={class:"summary-card__values-comparison"},Nh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},xh={class:"summary-card__value-main"},Lh={class:"value-label"},Ph={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},Oh={class:"summary-card__value-main summary-card__value-main--current-week"},Rh={class:"value-label"},Bh=["title"],Uh={class:"percentage-indicator__arrow"},Wh={class:"percentage-indicator__value"},Fh={class:"percentage-indicator__label"},Hh={class:"summary-card__breakdown"},jh={class:"breakdown-item breakdown-item--this-week"},Vh={class:"breakdown-item__value"},zh={class:"breakdown-item breakdown-item--previous-week"},Gh={class:"breakdown-item__value"},Kh={class:"breakdown-item breakdown-item--older"},qh={class:"breakdown-item__value"},Yh={class:"summary-card summary-card--stages summary-card--previous"},Xh={class:"summary-card__tags"},Jh={key:0,class:"stage-tag stage-tag--empty"},Zh={class:"ac-chart__body"},Qh={key:0,class:"split-charts-container"},ef={class:"chart-wrapper chart-wrapper--left"},tf={class:"chart-canvas-wrapper"},af={class:"chart-wrapper chart-wrapper--right"},sf={class:"chart-canvas-wrapper"},of={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:()=>({weekNumber:null,weekStartUtc:null,weekEndUtc:null})},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,closedTicketsCreatedThisWeek:0,closedTicketsCreatedOtherWeek:0,carryoverTickets:0,carryoverTicketsCreatedThisWeek:0,carryoverTicketsCreatedPreviousWeek:0,carryoverTicketsCreatedOlder:0,carryoverTicketsCreatedOtherWeek:0,series:{new:[0],closed:[0],closedCreatedThisWeek:[0],closedCreatedOtherWeek:[0],carryover:[0],carryoverCreatedThisWeek:[0],carryoverCreatedPreviousWeek:[0],carryoverCreatedOlder:[0],carryoverCreatedOtherWeek:[0]},stagesByWeek:[],stages:[],responsible:[]})}},emits:["open-responsible","open-stages","open-carryover"],setup(o,{emit:e}){Je.register(ps);const a=o,t=e,r=I(()=>{const h=a.meta?.weeks||[];return h.length>=2?h[h.length-2]:null}),i=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],n=M("line"),l={color:"#111827",font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:h=>h?.dataset?.borderColor||"#111827",borderWidth:1,borderRadius:4,padding:4,offset:8,formatter:h=>h==null||isNaN(h)?"":k(h),display:h=>{if(h?.chart?.config?.type!=="line")return!1;const B=h?.dataset?.data?.[h.dataIndex];return B!=null&&!isNaN(B)&&isFinite(B)}};I(()=>a.meta?.weekNumber??"—");const d=()=>{const h=a.meta?.weeks||[];return h.length>0?h.map(w=>`Неделя ${w.weekNumber}`):[a.meta?.weekNumber?`Неделя ${a.meta.weekNumber}`:"Неделя"]};function g(h,w,B,re=.3,le=0){if(!w)return((Ie,xe)=>{const He=parseInt(Ie.slice(1,3),16),z=parseInt(Ie.slice(3,5),16),N=parseInt(Ie.slice(5,7),16);return`rgba(${He}, ${z}, ${N}, ${xe})`})(B,re);const se=(De,Ie)=>{const xe=parseInt(De.slice(1,3),16),He=parseInt(De.slice(3,5),16),z=parseInt(De.slice(5,7),16);return`rgba(${xe}, ${He}, ${z}, ${Ie})`},me=h.createLinearGradient(0,w.bottom,0,w.top);return me.addColorStop(0,se(B,re)),me.addColorStop(1,se(B,le)),me}const v=I(()=>{const h=d(),w=Array.isArray(a.data.series?.new)&&a.data.series.new.length>0?a.data.series.new:[a.data.newTickets??0],B=Array.isArray(a.data.series?.closed)&&a.data.series.closed.length>0?a.data.series.closed:[a.data.closedTickets??0],re=Array.isArray(a.data.series?.closedCreatedThisWeek)&&a.data.series.closedCreatedThisWeek.length>0?a.data.series.closedCreatedThisWeek:[a.data.closedTicketsCreatedThisWeek??0],le=Array.isArray(a.data.series?.closedCreatedOtherWeek)&&a.data.series.closedCreatedOtherWeek.length>0?a.data.series.closedCreatedOtherWeek:[a.data.closedTicketsCreatedOtherWeek??0];return{labels:h,datasets:[{label:"Новые",data:w,backgroundColor:se=>{const me=se.chart,{ctx:De,chartArea:Ie}=me;return g(De,Ie,J.primary)},borderColor:J.primary,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:B,backgroundColor:se=>{const me=se.chart,{ctx:De,chartArea:Ie}=me;return g(De,Ie,J.success)},borderColor:J.success,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:re,backgroundColor:J.successLight,borderColor:J.successLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:le,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}}]}}),C=I(()=>{const h=d(),w=Array.isArray(a.data.series?.carryover)&&a.data.series.carryover.length>0?a.data.series.carryover:[a.data.carryoverTickets??0],B=Array.isArray(a.data.series?.carryoverCreatedThisWeek)&&a.data.series.carryoverCreatedThisWeek.length>0?a.data.series.carryoverCreatedThisWeek:[a.data.carryoverTicketsCreatedThisWeek??0],re=Array.isArray(a.data.series?.carryoverCreatedPreviousWeek)&&a.data.series.carryoverCreatedPreviousWeek.length>0?a.data.series.carryoverCreatedPreviousWeek:[a.data.carryoverTicketsCreatedPreviousWeek??0],le=Array.isArray(a.data.series?.carryoverCreatedOlder)&&a.data.series.carryoverCreatedOlder.length>0?a.data.series.carryoverCreatedOlder:[a.data.carryoverTicketsCreatedOlder??0];return Array.isArray(a.data.series?.carryoverCreatedOtherWeek)&&a.data.series.carryoverCreatedOtherWeek.length>0?a.data.series.carryoverCreatedOtherWeek:a.data.carryoverTicketsCreatedOtherWeek,{labels:h,datasets:[{label:"Переходящие (все)",data:w,backgroundColor:se=>{const me=se.chart,{ctx:De,chartArea:Ie}=me;return g(De,Ie,J.carryover)},borderColor:J.carryover,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:B,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:re,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:le,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),f=I(()=>{const h=a.meta?.weeks||[],w=h.length>0?h.map(He=>`Неделя ${He.weekNumber}`):[a.meta?.weekNumber?`Неделя ${a.meta.weekNumber}`:"Неделя"],B=Array.isArray(a.data.series?.new)&&a.data.series.new.length>0?a.data.series.new:[a.data.newTickets??0],re=Array.isArray(a.data.series?.closed)&&a.data.series.closed.length>0?a.data.series.closed:[a.data.closedTickets??0],le=Array.isArray(a.data.series?.closedCreatedThisWeek)&&a.data.series.closedCreatedThisWeek.length>0?a.data.series.closedCreatedThisWeek:[a.data.closedTicketsCreatedThisWeek??0],se=Array.isArray(a.data.series?.closedCreatedOtherWeek)&&a.data.series.closedCreatedOtherWeek.length>0?a.data.series.closedCreatedOtherWeek:[a.data.closedTicketsCreatedOtherWeek??0],me=Array.isArray(a.data.series?.carryover)&&a.data.series.carryover.length>0?a.data.series.carryover:[a.data.carryoverTickets??0],De=Array.isArray(a.data.series?.carryoverCreatedThisWeek)&&a.data.series.carryoverCreatedThisWeek.length>0?a.data.series.carryoverCreatedThisWeek:[a.data.carryoverTicketsCreatedThisWeek??0],Ie=Array.isArray(a.data.series?.carryoverCreatedPreviousWeek)&&a.data.series.carryoverCreatedPreviousWeek.length>0?a.data.series.carryoverCreatedPreviousWeek:[a.data.carryoverTicketsCreatedPreviousWeek??0],xe=Array.isArray(a.data.series?.carryoverCreatedOlder)&&a.data.series.carryoverCreatedOlder.length>0?a.data.series.carryoverCreatedOlder:[a.data.carryoverTicketsCreatedOlder??0];return Array.isArray(a.data.series?.carryoverCreatedOtherWeek)&&a.data.series.carryoverCreatedOtherWeek.length>0?a.data.series.carryoverCreatedOtherWeek:a.data.carryoverTicketsCreatedOtherWeek,{labels:w,datasets:[{label:"Новые",data:B,backgroundColor:J.primary,borderColor:J.primary,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:re,backgroundColor:J.success,borderColor:J.success,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:le,backgroundColor:J.successLight,borderColor:J.successLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:se,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}},{label:"Переходящие (все)",data:me,backgroundColor:J.carryover,borderColor:J.carryover,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:De,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:Ie,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:xe,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),p=I(()=>({labels:["Новые","Закрытые","Переходящие"],datasets:[{data:[a.data.newTickets??0,a.data.closedTickets??0,a.data.carryoverTickets??0],backgroundColor:[J.primary,J.success,J.carryover],borderWidth:1}]})),y=I(()=>{switch(n.value){case"line":return yt;case"bar":return vs;case"doughnut":return fs;default:return yt}}),S=I(()=>n.value==="doughnut"?p.value:f.value),T=h=>{if(!h)return"—";try{return new Date(h).toLocaleDateString("ru-RU",{day:"2-digit",month:"short"})}catch{return h}};function k(h){return h==null||isNaN(h)?"0":h>=1e3?h.toLocaleString("ru-RU"):h.toString()}function _(h){const w=h%10,B=h%100;return B>=11&&B<=14?"тикетов":w===1?"тикет":w>=2&&w<=4?"тикета":"тикетов"}const A=I(()=>({responsive:!0,maintainAspectRatio:!1,resizeDelay:0,animation:{duration:800,easing:"easeOutQuart"},interaction:{intersect:!1,mode:"index"},plugins:{datalabels:{...l,anchor:"end",align:"top"},tooltip:{enabled:!0,backgroundColor:"rgba(255, 255, 255, 0.98)",titleColor:"#111827",bodyColor:"#374151",borderColor:"#e5e7eb",borderWidth:1,cornerRadius:8,padding:16,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},displayColors:!0,boxPadding:6,usePointStyle:!0,animation:{duration:300,easing:"easeOutQuart"},callbacks:{title:h=>{if(!h||h.length===0)return"";const w=h[0]?.dataIndex,B=a.meta?.weeks||[];if(B.length>0&&w!==void 0&&B[w]){const me=B[w];return`Неделя ${me.weekNumber} (${T(me.weekStartUtc)} — ${T(me.weekEndUtc)})`}const re=a.meta?.weekNumber,le=a.meta?.weekStartUtc,se=a.meta?.weekEndUtc;return re&&le&&se?`Неделя ${re} (${T(le)} — ${T(se)})`:h[0]?.label||""},label:h=>{const w=h.parsed.y,B=h.dataset.label||"";if(w==null||isNaN(w))return`${B}: 0 тикетов`;const re=k(w),le=_(w);return`${B}: ${re} ${le}`}}},legend:{position:"bottom",labels:{font:{size:13,weight:"500"},padding:12,boxWidth:18,boxHeight:12,usePointStyle:!0,pointStyle:"circle",generateLabels:h=>Je.defaults.plugins.legend.labels.generateLabels(h).map((B,re)=>{const le=h.data.datasets[re],se=h.getDatasetMeta(re),me=le.borderDash&&Array.isArray(le.borderDash)&&le.borderDash.length>0||le.borderWidth===2||le.fill===!1;return se.hidden?(B.fontColor="#9ca3af",B.textDecoration="line-through",B.opacity=.5):me?B.fontColor="#6b7280":B.fontColor="#111827",B})},onClick:(h,w)=>{const B=w.datasetIndex;if(B==null){console.warn("[Legend] Invalid datasetIndex:",B);return}const re=h.chart;if(!re){console.warn("[Legend] Chart not found");return}const le=re.getDatasetMeta(B);if(!le){console.warn("[Legend] Dataset meta not found for index:",B);return}le.hidden=!le.hidden,re.update("active")},onHover:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="pointer")},onLeave:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="default")}}},scales:n.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10,color:"#374151",callback:h=>h==null||isNaN(h)?"0":k(h)},title:{display:!1},grid:{color:h=>{if(!h||!h.tick||h.tick.value===void 0)return"#e5e7eb";const w=h.tick.value;return isNaN(w)||!isFinite(w)?"#e5e7eb":w===0||w%5===0?"#d1d5db":"#e5e7eb"},lineWidth:h=>{if(!h||!h.tick||h.tick.value===void 0)return 1;const w=h.tick.value;return isNaN(w)||!isFinite(w)?1:w===0||w%5===0?1.5:1}}},x:{ticks:{maxRotation:45,minRotation:45,font:{size:14},padding:10,color:"#374151"},title:{display:!1},grid:{color:"#e5e7eb",lineWidth:1}}}})),U=I(()=>{if(a.data?.series){const h=a.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=0){const B={newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0};if(B.carryoverTickets>0&&console.log("[DEBUG currentWeekData]",{total:B.carryoverTickets,thisWeek:B.carryoverTicketsCreatedThisWeek,previousWeek:B.carryoverTicketsCreatedPreviousWeek,older:B.carryoverTicketsCreatedOlder,otherWeek:B.carryoverTicketsCreatedOtherWeek,sum:B.carryoverTicketsCreatedThisWeek+B.carryoverTicketsCreatedPreviousWeek+B.carryoverTicketsCreatedOlder,lastIndex:w,series:{carryoverCreatedPreviousWeek:h.carryoverCreatedPreviousWeek,carryoverCreatedOlder:h.carryoverCreatedOlder,carryoverCreatedPreviousWeekLength:h.carryoverCreatedPreviousWeek?.length,carryoverCreatedOlderLength:h.carryoverCreatedOlder?.length,carryoverCreatedPreviousWeekLast:h.carryoverCreatedPreviousWeek?.[w],carryoverCreatedOlderLast:h.carryoverCreatedOlder?.[w]},currentWeek:a.data.currentWeek,data:{carryoverTicketsCreatedPreviousWeek:a.data.carryoverTicketsCreatedPreviousWeek,carryoverTicketsCreatedOlder:a.data.carryoverTicketsCreatedOlder}}),B.newTickets>0||B.closedTickets>0||B.carryoverTickets>0)return B}}if(a.data?.currentWeek&&typeof a.data.currentWeek=="object"){const h=a.data.currentWeek;if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(a.data?.weeksData&&Array.isArray(a.data.weeksData)&&a.data.weeksData.length>0){const h=a.data.weeksData[a.data.weeksData.length-1];if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(a.data?.series){const h=a.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=0)return{newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0}}return a.data||{}}),x=I(()=>{const h=a.meta?.weeks||[];return h.length>0?h[h.length-1]:{weekNumber:a.meta?.currentWeek?.weekNumber??a.meta?.weekNumber??null,weekStartUtc:a.meta?.currentWeek?.weekStartUtc??a.meta?.weekStartUtc??null,weekEndUtc:a.meta?.currentWeek?.weekEndUtc??a.meta?.weekEndUtc??null}}),D=I(()=>{if(a.data?.series){const h=a.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=1){const B=w-1,re=a.meta?.weeks?.[B],le={weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[B]!==void 0?h.new[B]:0,closedTickets:Array.isArray(h.closed)&&h.closed[B]!==void 0?h.closed[B]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[B]!==void 0?h.closedCreatedThisWeek[B]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[B]!==void 0?h.closedCreatedOtherWeek[B]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[B]!==void 0?h.carryover[B]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[B]!==void 0?h.carryoverCreatedThisWeek[B]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[B]!==void 0?h.carryoverCreatedPreviousWeek[B]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[B]!==void 0?h.carryoverCreatedOlder[B]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[B]!==void 0?h.carryoverCreatedOtherWeek[B]:0};if(le.newTickets>0||le.closedTickets>0||le.carryoverTickets>0)return le}}if(a.data?.weeksData&&Array.isArray(a.data.weeksData)&&a.data.weeksData.length>=2){const h=a.data.weeksData.length-2,w=a.data.weeksData[h],B=a.meta?.weeks?.[h];if((w.newTickets??0)>0||(w.closedTickets??0)>0||(w.carryoverTickets??0)>0)return{weekNumber:w.weekNumber??B?.weekNumber??null,weekStartUtc:B?.weekStartUtc??null,weekEndUtc:B?.weekEndUtc??null,newTickets:w.newTickets??0,closedTickets:w.closedTickets??0,closedTicketsCreatedThisWeek:w.closedTicketsCreatedThisWeek??0,closedTicketsCreatedOtherWeek:w.closedTicketsCreatedOtherWeek??0,carryoverTickets:w.carryoverTickets??0,carryoverTicketsCreatedThisWeek:w.carryoverTicketsCreatedThisWeek??0,carryoverTicketsCreatedOtherWeek:w.carryoverTicketsCreatedOtherWeek??0}}if(a.data?.series){const h=a.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=1){const B=w-1,re=a.meta?.weeks?.[B];return{weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[B]!==void 0?h.new[B]:0,closedTickets:Array.isArray(h.closed)&&h.closed[B]!==void 0?h.closed[B]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[B]!==void 0?h.closedCreatedThisWeek[B]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[B]!==void 0?h.closedCreatedOtherWeek[B]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[B]!==void 0?h.carryover[B]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[B]!==void 0?h.carryoverCreatedThisWeek[B]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[B]!==void 0?h.carryoverCreatedPreviousWeek[B]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[B]!==void 0?h.carryoverCreatedOlder[B]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[B]!==void 0?h.carryoverCreatedOtherWeek[B]:0}}}return null}),E=I(()=>{const h=a.data?.stagesByWeek;return Array.isArray(h)?h:null}),L=I(()=>{const h=E.value;if(h&&h.length>0){const w=h.length-1,B=h[w];if(Array.isArray(B))return B}return a.data?.stages??[]}),R=I(()=>{const h=E.value;if(h&&h.length>=2){const w=h.length-2,B=h[w];if(Array.isArray(B))return B}return[]}),W=I(()=>D.value?.weekNumber?`Нет данных для недели ${D.value.weekNumber}`:"Нет данных");function G(h,w){if(typeof h!="number"||isNaN(h)||w==null||typeof w!="number"||isNaN(w)||w===0)return null;if(h===w)return 0;const B=(h-w)/w*100;return!isFinite(B)||isNaN(B)?null:B}function q(h){return h==null||isNaN(h)?"":`${h>=0?"+":""}${h.toFixed(1)}%`}const oe=I(()=>{if(a.data?.series){const h=a.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=2){const B=w-2;return{weekNumber:a.meta?.weeks?.[B]?.weekNumber??null,newTickets:Array.isArray(h.new)&&h.new[B]!==void 0?h.new[B]:0,closedTickets:Array.isArray(h.closed)&&h.closed[B]!==void 0?h.closed[B]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[B]!==void 0?h.carryover[B]:0}}}return null}),Y=I(()=>{const h=U.value,w=D.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}}),H=I(()=>{const h=D.value,w=oe.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}});function Z(h,w){if(!h||!w)return"";try{const B=new Date(h),re=new Date(w),le=B.getUTCDate(),se=B.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),me=B.getUTCFullYear(),De=re.getUTCDate(),Ie=re.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),xe=re.getUTCFullYear();return me===xe&&se===Ie?`${le} — ${De} ${se}`:me===xe?`${le} ${se} — ${De} ${Ie}`:`${le} ${se} ${me} — ${De} ${Ie} ${xe}`}catch(B){return console.error("[formatWeekDates] Error:",B),""}}const fe=h=>{const w=U.value,B=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,se=x.value;h==="new"&&B>0?t("open-stages",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc})},P=h=>{const w=D.value;if(!w)return;const B=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,se=r.value;se&&(h==="new"&&B>0?t("open-stages",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:se.weekNumber,weekStartUtc:se.weekStartUtc,weekEndUtc:se.weekEndUtc}))};return(h,w)=>(c(),u("div",am,[s("header",sm,[s("div",null,[w[6]||(w[6]=s("h2",{class:"ac-chart__title"},"График приёма и закрытий сектора 1С",-1)),s("p",om," Неделя "+m(o.meta?.currentWeek?.weekNumber??o.meta?.weekNumber??"—")+" · "+m((o.meta?.currentWeek?.weekStartUtc??o.meta?.weekStartUtc)||"—")+" — "+m((o.meta?.currentWeek?.weekEndUtc??o.meta?.weekEndUtc)||"—")+" (UTC) ",1)]),s("div",nm,[s("div",rm,[(c(),u(ee,null,te(i,B=>s("button",{key:B.value,class:X(["chart-type-btn",{active:n.value===B.value}]),onClick:re=>n.value=B.value},[s("span",lm,m(B.icon),1),s("span",cm,m(B.label),1)],10,im)),64))])])]),s("section",dm,[s("div",um,[s("h3",gm,[w[7]||(w[7]=s("span",{class:"summary-week-block__title-text"},"Текущая неделя",-1)),s("span",mm," Неделя "+m(x.value.weekNumber??"—"),1),x.value.weekStartUtc?(c(),u("span",hm,m(Z(x.value.weekStartUtc,x.value.weekEndUtc)),1)):$("",!0)]),s("div",fm,[s("div",{class:"summary-card summary-card--new",onClick:w[0]||(w[0]=B=>fe("new"))},[w[8]||(w[8]=s("div",{class:"summary-card__label"},"Новые за неделю",-1)),s("div",vm,[s("div",pm,m(U.value?.newTickets??0),1),Y.value.newTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.newTickets)}`},[s("span",km,m(Y.value.newTickets>=0?"↑":"↓"),1),s("span",bm,m(q(Y.value.newTickets)),1),s("span",_m,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,ym)):$("",!0)])]),s("div",{class:"summary-card summary-card--closed-breakdown",onClick:w[1]||(w[1]=B=>fe("closed"))},[w[13]||(w[13]=s("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),s("div",wm,[s("div",Cm,m(U.value?.closedTickets??0),1),Y.value.closedTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.closedTickets)}`},[s("span",Sm,m(Y.value.closedTickets>=0?"↑":"↓"),1),s("span",Dm,m(q(Y.value.closedTickets)),1),s("span",Em,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,Tm)):$("",!0)]),s("div",Am,[s("div",$m,[w[9]||(w[9]=s("span",{class:"breakdown-item__icon"},"✓",-1)),s("span",Im,m(U.value?.closedTicketsCreatedThisWeek??0),1),w[10]||(w[10]=s("span",{class:"breakdown-item__label"},"этой неделей",-1))]),s("div",Mm,[w[11]||(w[11]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",Nm,m(U.value?.closedTicketsCreatedOtherWeek??0),1),w[12]||(w[12]=s("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),s("div",{class:"summary-card summary-card--carryover-breakdown",onClick:w[2]||(w[2]=B=>fe("carryover"))},[w[20]||(w[20]=s("div",{class:"summary-card__label"},"Переходящие",-1)),s("div",xm,[s("div",Lm,m(U.value?.carryoverTickets??0),1),Y.value.carryoverTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",Y.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.carryoverTickets)}`},[s("span",Om,m(Y.value.carryoverTickets>=0?"↑":"↓"),1),s("span",Rm,m(q(Y.value.carryoverTickets)),1),s("span",Bm,"к неделе "+m(D.value?.weekNumber??"—"),1)],10,Pm)):$("",!0)]),s("div",Um,[s("div",Wm,[w[14]||(w[14]=s("span",{class:"breakdown-item__icon"},"✓",-1)),s("span",Fm,m(U.value?.carryoverTicketsCreatedThisWeek??0),1),w[15]||(w[15]=s("span",{class:"breakdown-item__label"},"этой недели",-1))]),s("div",Hm,[w[16]||(w[16]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",jm,m(U.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[17]||(w[17]=s("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),s("div",Vm,[w[18]||(w[18]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",zm,m(U.value?.carryoverTicketsCreatedOlder??0),1),w[19]||(w[19]=s("span",{class:"breakdown-item__label"},"остальные",-1))])])]),s("div",Gm,[w[21]||(w[21]=s("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),s("div",Km,[(c(!0),u(ee,null,te(L.value,B=>(c(),u("span",{key:B.stageId,class:"stage-tag"},m(B.stageName||B.stageId)+" — "+m(B.count),1))),128)),!L.value||L.value.length===0?(c(),u("span",qm," Нет данных ")):$("",!0)])])])]),D.value?(c(),u("div",Ym,[...w[22]||(w[22]=[s("div",{class:"summary-week-divider__line"},null,-1),s("div",{class:"summary-week-divider__label"},"Предыдущая неделя",-1)])])):$("",!0),D.value?(c(),u("div",Xm,[s("h3",Jm,[w[23]||(w[23]=s("span",{class:"summary-week-block__title-text"},"Предыдущая неделя",-1)),s("span",Zm," Неделя "+m(D.value.weekNumber??"—"),1),D.value.weekStartUtc?(c(),u("span",Qm,m(Z(D.value.weekStartUtc,D.value.weekEndUtc)),1)):$("",!0)]),s("div",eh,[s("div",{class:"summary-card summary-card--new summary-card--previous summary-card--clickable",onClick:w[3]||(w[3]=B=>P("new"))},[w[24]||(w[24]=s("div",{class:"summary-card__label"},"Новые за неделю",-1)),s("div",th,[s("div",ah,[s("div",sh,[s("div",oh,m(D.value?.newTickets??0),1),s("span",nh,"Неделя "+m(D.value?.weekNumber??"—"),1)]),s("div",rh,[s("div",ih,m(oe.value?.newTickets??0),1),s("span",lh,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.newTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.newTickets)}`},[s("span",dh,m(H.value.newTickets>=0?"↑":"↓"),1),s("span",uh,m(q(H.value.newTickets)),1),s("span",gh,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,ch)):$("",!0)])]),s("div",{class:"summary-card summary-card--closed-breakdown summary-card--previous summary-card--clickable",onClick:w[4]||(w[4]=B=>P("closed"))},[w[29]||(w[29]=s("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),s("div",mh,[s("div",hh,[s("div",fh,[s("div",vh,m(D.value?.closedTickets??0),1),s("span",ph,"Неделя "+m(D.value?.weekNumber??"—"),1)]),s("div",yh,[s("div",kh,m(oe.value?.closedTickets??0),1),s("span",bh,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.closedTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.closedTickets)}`},[s("span",wh,m(H.value.closedTickets>=0?"↑":"↓"),1),s("span",Ch,m(q(H.value.closedTickets)),1),s("span",Th,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,_h)):$("",!0)]),s("div",Sh,[s("div",Dh,[w[25]||(w[25]=s("span",{class:"breakdown-item__icon"},"✓",-1)),s("span",Eh,m(D.value?.closedTicketsCreatedThisWeek??0),1),w[26]||(w[26]=s("span",{class:"breakdown-item__label"},"этой неделей",-1))]),s("div",Ah,[w[27]||(w[27]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",$h,m(D.value?.closedTicketsCreatedOtherWeek??0),1),w[28]||(w[28]=s("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),s("div",{class:"summary-card summary-card--carryover-breakdown summary-card--previous summary-card--clickable",onClick:w[5]||(w[5]=B=>P("carryover"))},[w[36]||(w[36]=s("div",{class:"summary-card__label"},"Переходящие",-1)),s("div",Ih,[s("div",Mh,[s("div",Nh,[s("div",xh,m(D.value?.carryoverTickets??0),1),s("span",Lh,"Неделя "+m(D.value?.weekNumber??"—"),1)]),s("div",Ph,[s("div",Oh,m(oe.value?.carryoverTickets??0),1),s("span",Rh,"Неделя "+m(oe.value?.weekNumber??"—"),1)])]),H.value.carryoverTickets!==null?(c(),u("div",{key:0,class:X(["percentage-indicator",H.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.carryoverTickets)}`},[s("span",Uh,m(H.value.carryoverTickets>=0?"↑":"↓"),1),s("span",Wh,m(q(H.value.carryoverTickets)),1),s("span",Fh,"к неделе "+m(oe.value?.weekNumber??"—"),1)],10,Bh)):$("",!0)]),s("div",Hh,[s("div",jh,[w[30]||(w[30]=s("span",{class:"breakdown-item__icon"},"✓",-1)),s("span",Vh,m(D.value?.carryoverTicketsCreatedThisWeek??0),1),w[31]||(w[31]=s("span",{class:"breakdown-item__label"},"этой недели",-1))]),s("div",zh,[w[32]||(w[32]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",Gh,m(D.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[33]||(w[33]=s("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),s("div",Kh,[w[34]||(w[34]=s("span",{class:"breakdown-item__icon"},"↻",-1)),s("span",qh,m(D.value?.carryoverTicketsCreatedOlder??0),1),w[35]||(w[35]=s("span",{class:"breakdown-item__label"},"остальные",-1))])])]),s("div",Yh,[w[37]||(w[37]=s("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),s("div",Xh,[(c(!0),u(ee,null,te(R.value,B=>(c(),u("span",{key:B.stageId,class:"stage-tag"},m(B.stageName||B.stageId)+" — "+m(B.count),1))),128)),!R.value||R.value.length===0?(c(),u("span",Jh,m(W.value),1)):$("",!0)])])])])):$("",!0)]),s("div",Zh,[n.value==="line"?(c(),u("div",Qh,[s("div",ef,[w[38]||(w[38]=s("h3",{class:"chart-subtitle"},"Новые и Закрытые тикеты",-1)),s("div",tf,[ne(Ue(yt),{data:v.value,options:A.value},null,8,["data","options"])])]),s("div",af,[w[39]||(w[39]=s("h3",{class:"chart-subtitle"},"Переходящие тикеты",-1)),s("div",sf,[ne(Ue(yt),{data:C.value,options:A.value},null,8,["data","options"])])])])):(c(),he(wt(y.value),{key:1,data:S.value,options:A.value},null,8,["data","options"]))])]))}},nf=ce(of,[["__scopeId","data-v-3666e13a"]]),rf={class:"summary-cards-months"},lf={class:"summary-card summary-card--new"},cf={class:"card-content"},df={class:"card-main-value"},uf=["title"],gf={class:"card-month-breakdown"},mf={class:"month-name"},hf={class:"month-value"},ff={key:0,class:"month-item month-item--empty"},vf={class:"summary-card summary-card--closed"},pf={class:"card-content"},yf={class:"card-main-value"},kf=["title"],bf={class:"card-month-breakdown-hierarchical"},_f={class:"month-header"},wf={class:"month-name"},Cf={class:"month-value"},Tf={class:"month-breakdown"},Sf={class:"breakdown-item breakdown-this-week"},Df={class:"breakdown-value"},Ef={class:"breakdown-item breakdown-other-week"},Af={class:"breakdown-value"},$f={key:0,class:"month-item-hierarchical month-item--empty"},If={class:"summary-card summary-card--carryover"},Mf={class:"card-content"},Nf={class:"card-current-value"},xf={class:"current-value"},Lf=["title"],Pf={class:"card-month-breakdown"},Of={class:"month-name"},Rf={class:"month-value"},Bf={key:0,class:"month-item month-item--empty"},Uf={class:"summary-card summary-card--stages"},Wf={class:"card-content"},Ff={class:"stages-list"},Hf={class:"stage-icon"},jf={class:"stage-name"},Vf={class:"stage-value"},zf={key:0,class:"stage-item stage-item--empty"},Gf={__name:"SummaryCardsMonths",props:{data:{type:Object,required:!0,default:()=>({newTickets:0,newTicketsByMonth:[],closedTickets:0,closedTicketsByMonth:[],carryoverTickets:0,carryoverTicketsByMonth:[],stages:[]})}},setup(o){const e=o;function a(T){return T==null||isNaN(T)?"0":T>=1e6?(T/1e6).toFixed(1)+"M":T>=1e3?T.toLocaleString("ru-RU"):T.toString()}function t(T){return T==null||isNaN(T)?"":`${T>=0?"+":""}${T.toFixed(1)}%`}function r(T,k){if(typeof T!="number"||isNaN(T)||k==null||typeof k!="number"||isNaN(k)||k===0)return null;if(T===k)return 0;const _=(T-k)/k*100;return!isFinite(_)||isNaN(_)?null:_}const i=I(()=>e.data?.newTickets||0),n=I(()=>a(i.value)),l=I(()=>e.data?.newTicketsByMonth||[]),d=I(()=>e.data?.closedTicketsByMonth||[]),g=I(()=>e.data?.carryoverTicketsByMonth||[]),v=I(()=>{const T=g.value;return T.length===0?0:T[T.length-1]?.count||0}),C=I(()=>{const T=typeof e.data?.newTickets=="number"?e.data.newTickets:parseInt(e.data?.newTickets)||0,k=e.data?.previousPeriodData?.newTickets;return r(T,k)}),f=I(()=>{const T=typeof e.data?.closedTickets=="number"?e.data.closedTickets:parseInt(e.data?.closedTickets)||0,k=e.data?.previousPeriodData?.closedTickets;return r(T,k)}),p=I(()=>{const T=v.value,k=g.value,_=k.length>0?k[0]?.count||0:null;return r(T,_)});function y(T){return{"DT140_12:SUCCESS":"stage-success","DT140_12:FAIL":"stage-fail","DT140_12:UC_0GBU8Z":"stage-other"}[T]||""}function S(T){return{"DT140_12:SUCCESS":"✓","DT140_12:FAIL":"✗","DT140_12:UC_0GBU8Z":"⚠"}[T]||"•"}return(T,k)=>(c(),u("div",rf,[s("div",lf,[k[0]||(k[0]=s("h3",{class:"card-title"},"Новые за период",-1)),s("div",cf,[s("div",df,[ge(m(n.value)+" ",1),C.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",C.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(C.value)}`},m(t(C.value)),11,uf)):$("",!0)]),s("div",gf,[(c(!0),u(ee,null,te(l.value,_=>(c(),u("div",{key:`new-${_.month}`,class:"month-item"},[s("span",mf,m(_.monthName)+":",1),s("span",hf,m(a(_.count)),1)]))),128)),l.value.length===0?(c(),u("div",ff," Нет данных ")):$("",!0)])])]),s("div",vf,[k[5]||(k[5]=s("h3",{class:"card-title"},"Закрытые всего",-1)),s("div",pf,[s("div",yf,[ge(m(a(o.data.closedTickets||0))+" ",1),f.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",f.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(f.value)}`},m(t(f.value)),11,kf)):$("",!0)]),s("div",bf,[(c(!0),u(ee,null,te(d.value,_=>(c(),u("div",{key:`closed-${_.month}`,class:"month-item-hierarchical"},[s("div",_f,[s("span",wf,m(_.monthName)+":",1),s("span",Cf,m(a(_.count||0)),1)]),s("div",Tf,[s("div",Sf,[k[1]||(k[1]=s("span",{class:"breakdown-icon"},"✓",-1)),k[2]||(k[2]=s("span",{class:"breakdown-label"},"этого месяца:",-1)),s("span",Df,m(a(_.closedCreatedThisWeek||0)),1)]),s("div",Ef,[k[3]||(k[3]=s("span",{class:"breakdown-icon"},"↻",-1)),k[4]||(k[4]=s("span",{class:"breakdown-label"},"другого месяца:",-1)),s("span",Af,m(a(_.closedCreatedOtherWeek||0)),1)])])]))),128)),d.value.length===0?(c(),u("div",$f," Нет данных ")):$("",!0)])])]),s("div",If,[k[7]||(k[7]=s("h3",{class:"card-title"},"Переходящие всего",-1)),k[8]||(k[8]=s("p",{class:"card-hint"},"Активные тикеты сектора в трех основных рабочих стадиях (текущее состояние)",-1)),s("div",Mf,[s("div",Nf,[k[6]||(k[6]=s("span",{class:"current-label"},"Текущее состояние:",-1)),s("span",xf,[ge(m(a(v.value))+" ",1),p.value!==null?(c(),u("span",{key:0,class:X(["percentage-badge",p.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(p.value)}`},m(t(p.value)),11,Lf)):$("",!0)])]),s("div",Pf,[(c(!0),u(ee,null,te(g.value,_=>(c(),u("div",{key:`carryover-${_.month}`,class:"month-item"},[s("span",Of,m(_.monthName)+":",1),s("span",Rf,m(a(_.count||0)),1)]))),128)),g.value.length===0?(c(),u("div",Bf," Нет данных ")):$("",!0)])])]),s("div",Uf,[k[10]||(k[10]=s("h3",{class:"card-title"},"Закрытия по стадиям",-1)),s("div",Wf,[s("div",Ff,[(c(!0),u(ee,null,te(o.data.stages||[],_=>(c(),u("div",{key:_.stageId,class:X(["stage-item",y(_.stageId)])},[s("span",Hf,m(S(_.stageId)),1),s("span",jf,m(_.stageName||_.stageId)+":",1),s("span",Vf,m(a(_.count||0)),1)],2))),128)),!o.data.stages||o.data.stages.length===0?(c(),u("div",zf,[...k[9]||(k[9]=[s("span",{class:"stage-name"},"Нет данных",-1)])])):$("",!0)])])])]))}},Kf=ce(Gf,[["__scopeId","data-v-15d88b90"]]),qf={class:"line-chart-months"},Yf={class:"chart-section"},Xf={class:"chart-title"},Jf={key:0,class:"chart-period"},Zf={class:"chart-wrapper"},Qf={class:"chart-container"},ev={class:"chart-summary"},tv={class:"summary-numbers"},av={class:"summary-row"},sv={class:"summary-values"},ov={class:"summary-row"},nv={class:"summary-values"},rv={class:"summary-analysis"},iv=["innerHTML"],lv={class:"chart-section"},cv={class:"chart-title"},dv={key:0,class:"chart-period"},uv={class:"chart-wrapper"},gv={class:"chart-container"},mv={class:"chart-analysis"},hv={class:"analysis-content"},fv=["innerHTML"],vv={class:"chart-table-section"},pv={class:"chart-table-wrapper"},yv={class:"data-table"},kv={class:"data-row data-row--new"},bv={class:"data-row data-row--closed"},_v={class:"data-row data-row--carryover"},wv={__name:"LineChartMonths",props:{data:{type:Object,required:!0,default:()=>({newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[]})},meta:{type:Object,default:()=>({months:[]})}},setup(o){Je.register(ps);const e=o;function a(y){return y==null||isNaN(y)?"0":y>=1e3?y.toLocaleString("ru-RU"):y.toString()}const t=I(()=>{const y=new Set;return e.data.newTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(T=>{T&&T.weekNumber&&y.add(T.weekNumber)})}),e.data.closedTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(T=>{T&&T.weekNumber&&y.add(T.weekNumber)})}),e.data.carryoverTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(T=>{T&&T.weekNumber&&y.add(T.weekNumber)})}),Array.from(y).sort((S,T)=>S-T)}),r=I(()=>{const y=e.data.newTicketsByMonth||[],S=y.map(_=>_.monthName||`Месяц ${_.month}`),T=y.map(_=>_.count||0),k=(e.data.closedTicketsByMonth||[]).map(_=>_.count||0);return{labels:S,datasets:[{label:"Новые тикеты",data:T,borderColor:J.primary,backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:10,color:J.primary,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.primary,borderWidth:1,borderRadius:4,padding:4}},{label:"Закрытые тикеты",data:k,borderColor:J.success,backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"start",align:"bottom",offset:10,color:J.success,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.success,borderWidth:1,borderRadius:4,padding:4}}]}}),i=I(()=>{const y=e.data.carryoverTicketsByMonth||[],S=y.map(k=>k.monthName||`Месяц ${k.month}`),T=y.map(k=>k.count||0);return{labels:S,datasets:[{label:"Переходящие тикеты",data:T,borderColor:J.carryover,backgroundColor:"rgba(255, 152, 0, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:4,color:J.carryover}}]}}),n={responsive:!0,maintainAspectRatio:!1,layout:{padding:{left:16,right:0,top:56,bottom:0}},plugins:{legend:{position:"left",labels:{font:{size:14,weight:"500"},padding:16,boxWidth:20,boxHeight:12}},tooltip:{enabled:!0,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:12},datalabels:{anchor:"end",align:"top",formatter:(y,S)=>y==null||isNaN(y)?"":y.toString(),color:"#333",font:{size:12,weight:"bold"},padding:{top:4,bottom:4},display:function(y){const S=y.dataset.data[y.dataIndex];return S!=null&&!isNaN(S)&&isFinite(S)},backgroundColor:"rgba(255, 255, 255, 0.8)",borderColor:"#333",borderWidth:1,borderRadius:4,padding:4}},scales:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10},grid:{lineWidth:1.5}},x:{ticks:{maxRotation:0,minRotation:0,font:{size:14},padding:10},grid:{lineWidth:1.5}}}};function l(y){if(!y||y.length===0)return null;const S=y[0],T=y[y.length-1];if(!S||!T)return null;const k=S.monthName||`Месяц ${S.month}`,_=T.monthName||`Месяц ${T.month}`,A=S.year||new Date().getFullYear();return`${k} — ${_} ${A}`}const d=I(()=>l(e.data?.newTicketsByMonth||[])),g=I(()=>l(e.data?.carryoverTicketsByMonth||[])),v=I(()=>{const y=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(y.length===0)return{new:"—",closed:"—"};const T=y.map(_=>`${a(_.count||0)} (${_.monthName||_.month})`).join(" → "),k=S.map(_=>`${a(_.count||0)} (${_.monthName||_.month})`).join(" → ");return{new:T,closed:k}}),C=I(()=>{const y=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(y.length<2)return["Недостаточно данных для анализа"];const T=[],k=[],_=[];if(y.length>=2){const A=y[0],U=y[1],x=y[2];if(U&&A&&typeof A.count=="number"&&typeof U.count=="number"){const D=A.monthName||A.month,E=U.monthName||U.month,L=a(A.count||0),R=a(U.count||0);if(A.count>0){const W=(U.count-A.count)/A.count*100;if(isFinite(W)&&!isNaN(W)){const G=W>=0?"Рост":"Снижение",q=Math.abs(W),oe=W>=0?"+":"-",Y=W>=0?"#28a745":"#dc3545",H=W>=0?"#28a745":"#dc3545";k.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${R} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&U.count>0&&k.push(`  • Появление тикетов: с 0 (${D}) до ${R} (${E})`)}if(x&&U&&typeof U.count=="number"&&typeof x.count=="number"){const D=U.monthName||U.month,E=x.monthName||x.month,L=a(U.count||0),R=a(x.count||0);if(U.count>0){const W=(x.count-U.count)/U.count*100;if(isFinite(W)&&!isNaN(W))if(Math.abs(W)<.1)k.push(`  • Без изменений: ${L} (${D}) → ${R} (${E}) — 0.0%`);else{const G=W>=0?"Рост":"Снижение",q=Math.abs(W),oe=W>=0?"+":"-",Y=W>=0?"#28a745":"#dc3545",H=W>=0?"#28a745":"#dc3545";k.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${R} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else U.count===0&&x.count>0&&k.push(`  • Появление тикетов: с 0 (${D}) до ${R} (${E})`)}}if(S.length>=2){const A=S[0],U=S[1],x=S[2];if(U&&A&&typeof A.count=="number"&&typeof U.count=="number"){const D=A.monthName||A.month,E=U.monthName||U.month,L=a(A.count||0),R=a(U.count||0);if(A.count>0){const W=(U.count-A.count)/A.count*100;if(isFinite(W)&&!isNaN(W))if(Math.abs(W)<.1)_.push(`  • Без изменений: ${L} (${D}) → ${R} (${E}) — 0.0%`);else{const G=W>=0?"Рост":"Снижение",q=Math.abs(W),oe=W>=0?"+":"-",Y=W>=0?"#28a745":"#dc3545",H=W>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${R} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&U.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${R} (${E})`)}if(x&&U&&typeof U.count=="number"&&typeof x.count=="number"){const D=U.monthName||U.month,E=x.monthName||x.month,L=a(U.count||0),R=a(x.count||0);if(U.count>0){const W=(x.count-U.count)/U.count*100;if(isFinite(W)&&!isNaN(W))if(Math.abs(W)<.1)_.push(`  • Без изменений: ${L} (${D}) → ${R} (${E}) — 0.0%`);else{const G=W>=0?"Рост":"Снижение",q=Math.abs(W),oe=W>=0?"+":"-",Y=W>=0?"#28a745":"#dc3545",H=W>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${R} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else U.count===0&&x.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${R} (${E})`)}}if(k.length>0&&(T.push("Новые тикеты:"),T.push(...k)),_.length>0&&(T.push("Закрытые тикеты:"),T.push(..._)),y.length>=3&&S.length>=3){const A=y[0],U=y[y.length-1],x=S[0],D=S[S.length-1],E=A.count||0,L=U.count||0,R=x.count||0,W=D.count||0;if(E>0&&R>0){const G=(L-E)/E*100,q=(W-R)/R*100;if(isFinite(G)&&isFinite(q)){const oe=A.monthName||A.month,Y=U.monthName||U.month,H=x.monthName||x.month,Z=D.monthName||D.month,fe=G>=0?"#28a745":"#dc3545",P=G>=0?"#28a745":"#dc3545",h=q>=0?"#28a745":"#dc3545",w=q>=0?"#28a745":"#dc3545";T.push("Общая динамика за период:"),T.push(`  • Новые тикеты: <span style="color: ${fe}; font-weight: 600;">${G>=0?"рост":"снижение"}</span> с ${a(E)} (${oe}) до ${a(L)} (${Y}) — <span style="color: ${P}; font-weight: 600;">${G>=0?"+":"-"}${Math.abs(G).toFixed(1)}%</span>`),T.push(`  • Закрытые тикеты: <span style="color: ${h}; font-weight: 600;">${q>=0?"рост":"снижение"}</span> с ${a(R)} (${H}) до ${a(W)} (${Z}) — <span style="color: ${w}; font-weight: 600;">${q>=0?"+":"-"}${Math.abs(q).toFixed(1)}%</span>`)}}}return T.length>0?T:["Недостаточно данных для анализа"]}),f=I(()=>{const y=e.data?.carryoverTicketsByMonth||[];if(y.length===0)return["Нет данных для анализа"];const S=[],T=[],k=y.filter(_=>_&&typeof _.count=="number").map(_=>`${a(_.count||0)} (${_.monthName||_.month||"Неизвестно"})`).join(" → ");if(k&&S.push(`Переходящие тикеты: ${k}`),y.length>=2){const _=y[0],A=y[1],U=y[2];if(A&&_&&typeof _.count=="number"&&typeof A.count=="number"){const x=_.monthName||_.month,D=A.monthName||A.month,E=a(_.count||0),L=a(A.count||0);if(_.count>0){const R=(A.count-_.count)/_.count*100;if(isFinite(R)&&!isNaN(R))if(Math.abs(R)<.1)T.push(`  • Без изменений: ${E} (${x}) → ${L} (${D}) — 0.0%`);else{const W=R>=0?"Рост":"Снижение",G=Math.abs(R),q=R>=0?"+":"-",oe=R>=0?"#28a745":"#dc3545",Y=R>=0?"#28a745":"#dc3545";T.push(`  • <span style="color: ${oe}; font-weight: 600;">${W}</span> с ${E} (${x}) до ${L} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else _.count===0&&A.count>0&&T.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${L} (${D})`)}if(U&&A&&typeof A.count=="number"&&typeof U.count=="number"){const x=A.monthName||A.month,D=U.monthName||U.month,E=a(A.count||0),L=a(U.count||0);if(A.count>0){const R=(U.count-A.count)/A.count*100;if(isFinite(R)&&!isNaN(R))if(Math.abs(R)<.1)T.push(`  • Без изменений: ${E} (${x}) → ${L} (${D}) — 0.0%`);else{const W=R>=0?"Рост":"Снижение",G=Math.abs(R),q=R>=0?"+":"-",oe=R>=0?"#28a745":"#dc3545",Y=R>=0?"#28a745":"#dc3545";T.push(`  • <span style="color: ${oe}; font-weight: 600;">${W}</span> с ${E} (${x}) до ${L} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else A.count===0&&U.count>0&&T.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${L} (${D})`)}}if(T.length>0&&(S.push("Динамика по месяцам:"),S.push(...T)),y.length>=3){const _=y[0],A=y[y.length-1];if(_&&A&&typeof _.count=="number"&&typeof A.count=="number"){const U=_.count||0,x=A.count||0,D=_.monthName||_.month,E=A.monthName||A.month,L=a(U),R=a(x);if(U>0){const W=(x-U)/U*100;if(isFinite(W)&&!isNaN(W))if(Math.abs(W)<1)S.push("Тенденция за период:"),S.push(`  • Стабильное количество: ${L} (${D}) → ${R} (${E}) — изменение менее 1%`);else{const G=W>=0?"Рост":"Снижение",q=Math.abs(W),oe=W>=0?"+":"-",Y=W>=0?"#28a745":"#dc3545",H=W>=0?"#28a745":"#dc3545";S.push("Тенденция за период:"),S.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${L} (${D}) до ${R} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else U===0&&x>0?(S.push("Тенденция за период:"),S.push(`  • Появление переходящих тикетов: с 0 (${D}) до ${R} (${E})`)):U>0&&x===0&&(S.push("Тенденция за период:"),S.push(`  • Полное отсутствие переходящих тикетов: с ${L} (${D}) до 0 (${E})`))}}return S.length>0?S:["Недостаточно данных для анализа"]});function p(y,S){let T=[];switch(y){case"new":T=e.data.newTicketsByMonth||[];break;case"closed":T=e.data.closedTicketsByMonth||[];break;case"carryover":T=e.data.carryoverTicketsByMonth||[];break;default:return"-"}for(const k of T){if(!k.weeks||!Array.isArray(k.weeks))continue;const _=k.weeks.find(A=>A&&A.weekNumber===S);if(_){const A=_.count||0;return A>0?a(A):"-"}}return"-"}return(y,S)=>(c(),u("div",qf,[s("div",Yf,[s("h3",Xf,[S[0]||(S[0]=ge(" Новые и Закрытые тикеты ",-1)),d.value?(c(),u("span",Jf,"("+m(d.value)+")",1)):$("",!0)]),s("div",Zf,[s("div",Qf,[ne(Ue(yt),{data:r.value,options:n},null,8,["data"])]),s("div",ev,[S[3]||(S[3]=s("h4",{class:"summary-title"},"Сводный итог",-1)),s("div",tv,[s("div",av,[S[1]||(S[1]=s("span",{class:"summary-label"},"Новые:",-1)),s("span",sv,m(v.value.new),1)]),s("div",ov,[S[2]||(S[2]=s("span",{class:"summary-label"},"Закрытые:",-1)),s("span",nv,m(v.value.closed),1)])]),s("div",rv,[(c(!0),u(ee,null,te(C.value,(T,k)=>(c(),u("p",{key:k,innerHTML:T},null,8,iv))),128))])])])]),s("div",lv,[s("h3",cv,[S[4]||(S[4]=ge(" Переходящие тикеты ",-1)),g.value?(c(),u("span",dv,"("+m(g.value)+")",1)):$("",!0)]),s("div",uv,[s("div",gv,[ne(Ue(yt),{data:i.value,options:n},null,8,["data"])]),s("div",mv,[S[5]||(S[5]=s("h4",{class:"analysis-title"},"Анализ",-1)),s("div",hv,[(c(!0),u(ee,null,te(f.value,(T,k)=>(c(),u("p",{key:k,innerHTML:T},null,8,fv))),128))])])])]),s("div",vv,[S[10]||(S[10]=s("h3",{class:"chart-title"},"Детализация по месяцам и неделям",-1)),s("div",pv,[s("table",yv,[s("thead",null,[s("tr",null,[S[6]||(S[6]=s("th",{class:"month-header-cell"},"Месяц",-1)),(c(!0),u(ee,null,te(t.value,T=>(c(),u("th",{key:`week-${T}`,class:"week-header-cell"}," Неделя "+m(T),1))),128))])]),s("tbody",null,[s("tr",kv,[S[7]||(S[7]=s("td",{class:"data-type-cell"},"Новые",-1)),(c(!0),u(ee,null,te(t.value,T=>(c(),u("td",{key:`new-${T}`,class:"week-data-cell"},m(p("new",T)),1))),128))]),s("tr",bv,[S[8]||(S[8]=s("td",{class:"data-type-cell"},"Закрытые",-1)),(c(!0),u(ee,null,te(t.value,T=>(c(),u("td",{key:`closed-${T}`,class:"week-data-cell"},m(p("closed",T)),1))),128))]),s("tr",_v,[S[9]||(S[9]=s("td",{class:"data-type-cell"},"Переходящие",-1)),(c(!0),u(ee,null,te(t.value,T=>(c(),u("td",{key:`carryover-${T}`,class:"week-data-cell"},m(p("carryover",T)),1))),128))])])])])])]))}},Cv=ce(wv,[["__scopeId","data-v-31a3d565"]]),Tv={class:"months-preloader"},Sv={class:"preloader-content"},Dv={class:"progress-container"},Ev={class:"progress-bar"},Av={class:"progress-text"},$v={class:"preloader-message"},Iv={class:"stages-list"},Mv={class:"stage-icon"},Nv={class:"stage-text"},xv={__name:"MonthsModePreloader",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},currentStage:{type:String,default:""}},setup(o){const e=o,a=[{label:"Подготовка данных...",threshold:5},{label:"Загрузка данных за период (запрос 1)...",threshold:35},{label:"Загрузка данных за период (запрос 2)...",threshold:65},{label:"Загрузка данных за период (запрос 3)...",threshold:85},{label:"Агрегация данных...",threshold:90},{label:"Формирование графиков...",threshold:100}];function t(i){return e.progress>=a[i].threshold}function r(i){const n=a[i].threshold,l=i>0?a[i-1].threshold:0;return e.progress>=l&&e.progress<n}return(i,n)=>(c(),u("div",Tv,[s("div",Sv,[n[0]||(n[0]=_t('<div class="preloader-spinner" data-v-b571fe67><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div></div><h3 class="preloader-title" data-v-b571fe67>Загрузка данных за 3 месяца</h3>',2)),s("div",Dv,[s("div",Ev,[s("div",{class:"progress-fill",style:we({width:`${o.progress}%`})},null,4)]),s("div",Av,m(Math.round(o.progress))+"%",1)]),s("p",$v,m(o.currentStage),1),s("div",Iv,[(c(),u(ee,null,te(a,(l,d)=>s("div",{key:d,class:X(["stage-item",{"stage-completed":t(d),"stage-current":r(d)}])},[s("span",Mv,m(t(d)?"✓":r(d)?"→":"○"),1),s("span",Nv,m(l.label),1)],2)),64))])])]))}},Lv=ce(xv,[["__scopeId","data-v-b571fe67"]]),Pv={class:"ac-dashboard-months"},Ov={key:"content"},Rv={class:"dashboard-header"},Bv={class:"header-content"},Uv={class:"breadcrumbs-row"},Wv=["aria-label","aria-disabled","data-fallback","disabled"],Fv={class:"breadcrumbs","aria-label":"Навигация"},Hv={class:"dashboard-layout"},jv={class:"filters-container"},Vv={class:"chart-container"},zv={__name:"GraphAdmissionClosureMonthsDashboard",setup(o){const e=Xe(),a=M(!0),t=M(0),r=M("Подготовка данных..."),i=M(null),n=M(null),l=M({newTickets:0,closedTickets:0,carryoverTickets:0,newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[],previousPeriodData:{newTickets:null,closedTickets:null,carryoverTickets:null}}),d=M(!1),g=I(()=>typeof window>"u"?!1:window.history.length>1),v=I(()=>g.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),C={name:"dashboard-sector-1c"};function f(L){if(L?.preventDefault?.(),!d.value){d.value=!0;try{if(g.value){e.back();return}console.warn("GraphAdmissionClosureMonthsDashboard: fallback navigation to dashboard-sector-1c"),e.push(C)}finally{d.value=!1}}}const p=M({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),y=I(()=>{const L=p.value.customDateRange.startDate||p.value.customDateRange.endDate,R=p.value.employees.length===1&&p.value.employees.includes("all");return L||!R});async function S(L,R,W=500){const G=t.value,q=10,oe=(L-G)/q,Y=W/q;for(let H=0;H<q;H++)await new Promise(Z=>setTimeout(Z,Y)),t.value=Math.min(G+oe*(H+1),L);t.value=L,r.value=R}async function T(){console.log("[DEBUG MonthsDashboard] loadData called"),console.log("[DEBUG MonthsDashboard] isLoading before:",a.value),a.value=!0,i.value=null,t.value=0,r.value="Подготовка данных...",console.log("[DEBUG MonthsDashboard] isLoading set to true");let L=null,R=null;try{console.log("[DEBUG MonthsDashboard] Starting API call"),await S(5,"Подготовка данных...",200);const W=Date.now(),G=2e4;L=setInterval(()=>{const H=Date.now()-W,Z=Math.min(5+H/G*85,90);t.value=Z,Z<35?r.value="Загрузка данных за период (запрос 1)...":Z<65?r.value="Загрузка данных за период (запрос 2)...":Z<85?r.value="Загрузка данных за период (запрос 3)...":r.value="Агрегация данных..."},500),R=setTimeout(()=>{L&&(clearInterval(L),L=null)},G+1e4);const q=await Ft({product:"1C",periodMode:"months",includeTickets:!0});clearTimeout(R),L&&(clearInterval(L),L=null),t.value=90,r.value="Агрегация данных завершена",await S(100,"Формирование графиков...",300),console.log("[DEBUG MonthsDashboard] API call successful, result:",q);const{meta:oe,data:Y}=q;n.value=oe,l.value=Y,console.log("[DEBUG MonthsDashboard] Data set, meta:",oe,"data keys:",Object.keys(Y)),await new Promise(H=>setTimeout(H,200))}catch(W){L&&(clearInterval(L),L=null),R&&(clearTimeout(R),R=null),console.error("[DEBUG MonthsDashboard] API call failed:",W),i.value=W instanceof Error?W:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureMonthsDashboard] loadData error:",W),t.value=100,r.value="Ошибка загрузки данных"}finally{console.log("[DEBUG MonthsDashboard] Finally block: setting isLoading to false"),a.value=!1,console.log("[DEBUG MonthsDashboard] isLoading after:",a.value)}}function k(L){p.value.stages=L}function _(L){p.value.employees=L}function A(L){p.value.dateRange=L}function U(L){p.value.customDateRange=L}function x(){p.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},D()}function D(){T()}function E(L){if(!["weeks","months"].includes(L)){console.warn("[GraphAdmissionClosureMonthsDashboard] Invalid periodMode:",L);return}L==="weeks"&&window.dispatchEvent(new CustomEvent("period-mode-change",{detail:{mode:L}}))}return $e(()=>{console.log("[DEBUG MonthsDashboard] onMounted called"),console.log("[DEBUG MonthsDashboard] isLoading before loadData:",a.value),T()}),(L,R)=>{const W=be("router-link");return c(),u("div",Pv,[ne(Ae,{name:"fade",mode:"out-in"},{default:ye(()=>[a.value?(c(),he(Lv,{key:"preloader",progress:t.value,"current-stage":r.value},null,8,["progress","current-stage"])):(c(),u("div",Ov,[s("div",Rv,[s("div",Bv,[s("div",Uv,[s("button",{class:"btn-back-link",type:"button",onClick:f,"aria-label":v.value,"aria-disabled":!g.value,"data-fallback":!g.value,disabled:d.value,title:"Назад"}," ← ",8,Wv),s("nav",Fv,[ne(W,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:ye(()=>[...R[0]||(R[0]=[ge(" Дашборд сектора 1С ",-1)])]),_:1}),R[2]||(R[2]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(W,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:ye(()=>[...R[1]||(R[1]=[ge(" График состояния ",-1)])]),_:1}),R[3]||(R[3]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),R[4]||(R[4]=s("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),R[5]||(R[5]=s("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),R[6]||(R[6]=s("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),s("div",Hv,[s("div",jv,[ne(ja,{stages:p.value.stages,employees:p.value.employees,dateRange:p.value.dateRange,customDateRange:p.value.customDateRange,hasActiveFilters:y.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":"months","onUpdate:stages":k,"onUpdate:employees":_,"onUpdate:dateRange":A,"onUpdate:customDateRange":U,"onUpdate:periodMode":E,onReset:x,onApply:D},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),s("div",Vv,[i.value?(c(),he(ba,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),u(ee,{key:1},[ne(Kf,{data:l.value},null,8,["data"]),ne(Cv,{data:l.value,meta:n.value},null,8,["data","meta"])],64))])])]))]),_:1})])}}},Gv=ce(zv,[["__scopeId","data-v-fe3ca7ed"]]);class va{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const a=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",a);const t=await this.getEmployeesByIds(a);return console.log("Loaded employees:",t.length),{stages:this.groupTicketsByStages(e,t),employees:t,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],a=[];for(const t of e){console.log(`Loading tickets for stage: ${t}`);const r=await this.getTicketsByStage(t);a.push(...r),console.log(`Loaded ${r.length} tickets for stage ${t}`)}return a}static async getTicketsByStage(e){const a=[];let t=0;const r=50;let i=!0;for(;i;)try{const d=await new vt().call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:t,useOriginalUfNames:"Y"});let g=[];d&&d.result&&(Array.isArray(d.result)?g=d.result:d.result.items&&Array.isArray(d.result.items)?g=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(g=d.result.data)),g.length>0?(a.push(...g),t+=g.length,i=g.length===r):i=!1}catch(l){console.error(`Error loading tickets batch for stage ${e} (start: ${t}):`,l),i=!1}a.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(a[0],null,2)),console.log("Sample ticket keys:",Object.keys(a[0])),console.log("Sample ticket assignedById variants:",{assignedById:a[0].assignedById,assignedByIdId:a[0].assignedByIdId,ASSIGNED_BY_ID:a[0].ASSIGNED_BY_ID}));const n=a.filter(l=>{const d=l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product||l.ufCrm7TypeProduct||l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product;return Array.isArray(d)?d.includes(this.SECTOR_TAG):typeof d=="object"&&d!==null?d.value===this.SECTOR_TAG||d===this.SECTOR_TAG:d===this.SECTOR_TAG});return console.log(`Filtered ${n.length} tickets from ${a.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),n}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const a=new Set;return e.forEach(t=>{const r=t.assignedById||t.assignedByIdId||t.ASSIGNED_BY_ID||t.assignedById||t.assignedById&&typeof t.assignedById=="object"&&(t.assignedById.id||t.assignedById.ID)||t.assignedById&&typeof t.assignedById=="object"&&t.assignedById.value;if(r){const i=parseInt(r);i&&!isNaN(i)&&i>0&&a.add(i)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(a))),Array.from(a)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await new vt().call("user.get",{filter:{ID:e}});let r=[];return t&&t.result&&(Array.isArray(t.result)?r=t.result:console.warn("Unexpected user.get result format:",t)),r.map(i=>({id:parseInt(i.ID||i.id||0),name:`${i.NAME||i.name||""} ${i.LAST_NAME||i.lastName||""}`.trim()||i.EMAIL||i.email||"Неизвестный",position:i.WORK_POSITION||i.workPosition||"Сотрудник",email:i.EMAIL||i.email||"",tickets:[]}))}catch(a){return console.error("Error getting employees by IDs:",a),[]}}static groupTicketsByStages(e,a){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(a)||(console.warn("Employees is not an array:",a),a=[]);const t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:a.map(r=>({...r,tickets:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:a.map(r=>({...r,tickets:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:a.map(r=>({...r,tickets:[]}))}];return e.forEach(r=>{const i=this.mapStageId(r.stageId||r.STAGE_ID||""),n=t.find(l=>l.id===i);if(n){const l=r.assignedById||r.ASSIGNED_BY_ID||null,d=l?parseInt(l):null;if(d){let g=n.employees.find(v=>v.id===d);g||(g={id:d,name:`Сотрудник #${d}`,position:"Неизвестно",email:"",tickets:[]},n.employees.push(g)),g.tickets.push(this.mapTicket(r))}}}),t}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const a=parseInt(e.id||e.ID||0),t=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",i=e.assignedById||e.ASSIGNED_BY_ID||null,n=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",l=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",d=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,g=La(d),v=bs(g);return{id:a,title:t,priorityId:g.id,priorityLabel:g.label,priorityColors:v,priority:g.id,priorityBitrixValue:g.bitrixValue||null,status:this.mapStatus(r),assigneeId:i?parseInt(i):null,stageId:this.mapStageId(r),createdAt:n,modifiedAt:l,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return La(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const a=as(e);if(a&&a.bitrixValue)return a.bitrixValue;const t={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return t[e]?t[e]:as(_o).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const a={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(t=>!(t.assignedById||t.ASSIGNED_BY_ID)).forEach(t=>{const r=this.mapStageId(t.stageId||t.STAGE_ID||"");a[r]&&a[r].push(this.mapTicket(t))}),a):(console.warn("Tickets is not an array in getZeroPointTickets:",e),a)}static async assignTicket(e,a,t){try{const r=this.mapStageIdToBitrix(t);return(await new vt().call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:a,stageId:r}})).result===!0}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(e){try{const t=await new vt().call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(a){throw console.error("Error creating ticket:",a),a}}static async getTicket(e){try{const t=await new vt().call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(a){throw console.error("Error getting ticket:",a),a}}static async addComment(e,a){try{return(await new vt().call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:a}})).result!==void 0}catch(t){throw console.error("Error adding comment:",t),t}}}Fe(va,"ENTITY_TYPE_ID",140),Fe(va,"SECTOR_TAG","1C");const Kv=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:va},Symbol.toStringTag,{value:"Module"}));function qv(o){if(!o)return null;try{const e=new Date(o);return isNaN(e.getTime())?null:e}catch{return console.warn("Invalid date format:",o),null}}function Yv(o,e){return Math.floor((o-e)/864e5)}function Xv(o){return!o||isNaN(o.getTime())?!1:o<=new Date}const it={ONE_MONTH:"one_month",TWO_MONTHS:"two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},Ut={[it.ONE_MONTH]:"Один месяц",[it.TWO_MONTHS]:"Два месяца",[it.MORE_THAN_HALF_YEAR]:"Более полугода",[it.MORE_THAN_YEAR]:"Более года"},ns={[it.ONE_MONTH]:30,[it.TWO_MONTHS]:60,[it.MORE_THAN_HALF_YEAR]:180,[it.MORE_THAN_YEAR]:365};function pa(o,e,a=new Date){if(!Array.isArray(o))return console.warn("filterTicketsByTimePeriod: tickets must be an array"),[];if(!ns[e])return console.warn(`filterTicketsByTimePeriod: Unknown period "${e}"`),o;const t=ns[e],r=e.includes("more_than");return o.filter(i=>{try{if(!i||!i.id||!i.created_at)return console.warn("Ticket missing required fields:",i),!1;const n=qv(i.created_at);if(!n)return console.warn(`Invalid date for ticket ${i.id}: ${i.created_at}`),!1;if(!Xv(n))return console.warn(`Future or invalid date for ticket ${i.id}: ${i.created_at}`),!1;const l=Yv(a,n);return r?l>t:l<=t}catch(n){return console.error(`Error filtering ticket ${i?.id||"unknown"}:`,n),!1}})}const Jv={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Zv={class:"modal"},Qv={key:0,class:"modal__tabs"},ep={key:"level-0-categories",class:"level-0"},tp={class:"modal__header"},ap={class:"modal__title"},sp={key:0},op={class:"modal__body"},np={class:"categories-list"},rp=["onClick"],ip={class:"category-item"},lp={class:"category-item__icon"},cp={key:0},dp={key:1},up={class:"category-item__content"},gp={class:"category-item__label"},mp={class:"category-item__count"},hp={key:0,class:"category-item__arrow"},fp={class:"modal__footer"},vp={key:"level-1-categories",class:"level-1"},pp={class:"modal__header"},yp={class:"modal__body"},kp={key:"loading",class:"loading-names"},bp={key:"empty",class:"modal__empty"},_p={key:"list",class:"responsible-list"},wp=["onClick"],Cp={class:"responsible-list__name"},Tp={class:"responsible-list__count"},Sp={key:0,class:"responsible-list__arrow"},Dp={class:"modal__footer"},Ep={key:"level-2-categories",class:"level-2"},Ap={class:"modal__header"},$p={class:"modal__title"},Ip={class:"modal__body"},Mp={class:"time-sort-controls"},Np={class:"time-sort-buttons"},xp=["onClick"],Lp={class:"count"},Pp={key:"loading",class:"loading-state"},Op={key:"error",class:"error-state"},Rp={class:"error-message"},Bp={key:"empty",class:"empty-state"},Up={class:"empty-state-message"},Wp={key:"tickets",class:"tickets-list-container"},Fp={key:"level-0-employees",class:"level-0"},Hp={class:"modal__header"},jp={class:"modal__title"},Vp={key:0},zp={class:"modal__body"},Gp={key:"loading",class:"loading-names"},Kp={key:"empty",class:"modal__empty"},qp={key:"list",class:"responsible-list"},Yp=["onClick"],Xp={class:"responsible-list__name"},Jp={class:"responsible-list__count"},Zp={key:0,class:"responsible-list__arrow"},Qp={class:"modal__footer"},ey={key:"level-1-employees",class:"level-1"},ty={class:"modal__header"},ay={class:"modal__title"},sy={class:"modal__body"},oy={class:"categories-list"},ny=["onClick"],ry={class:"category-item"},iy={class:"category-item__icon"},ly={key:0},cy={key:1},dy={class:"category-item__content"},uy={class:"category-item__label"},gy={class:"category-item__count"},my={key:0,class:"category-item__arrow"},hy={class:"modal__footer"},fy={key:"level-2-employees",class:"level-2"},vy={class:"modal__header"},py={class:"modal__title"},yy={class:"modal__body"},ky={key:"loading",class:"loading-state"},by={key:"error",class:"error-state"},_y={class:"error-message"},wy={key:"empty",class:"empty-state"},Cy={class:"empty-state-message"},Ty={key:"tickets",class:"tickets-list-container"},Sy={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]},closedTicketsCreatedThisWeek:{type:Number,default:0},closedTicketsCreatedOtherWeek:{type:Number,default:0},responsibleCreatedThisWeek:{type:Array,default:()=>[]},responsibleCreatedOtherWeek:{type:Array,default:()=>[]},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},setup(o){const e=o,a=M(0),t=M("categories"),r=M(null),i=M(null),n=M(null),l=M([]),d=M(!1),g=M(null),v=M([]),C=M([]),f=M(!1),p=M(it.ONE_MONTH),y=I(()=>[{id:"created-this-week",label:"Тикеты закрытые этой неделью и созданные этой неделью",count:e.closedTicketsCreatedThisWeek??0,responsible:e.responsibleCreatedThisWeek??[]},{id:"created-other-week",label:"Тикеты закрытые этой неделью и созданные ранее",count:e.closedTicketsCreatedOtherWeek??0,responsible:e.responsibleCreatedOtherWeek??[]}]),S=I(()=>{const P=new Map;return(e.responsibleCreatedThisWeek||[]).forEach(h=>{const w=h.id??"unassigned";P.has(w)||P.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const B=P.get(w);B.thisWeekCount=h.count??0,B.thisWeekTickets=h.tickets||[],B.totalCount+=B.thisWeekCount}),(e.responsibleCreatedOtherWeek||[]).forEach(h=>{const w=h.id??"unassigned";P.has(w)||P.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const B=P.get(w);B.otherWeekCount=h.count??0,B.otherWeekTickets=h.tickets||[],B.totalCount+=B.otherWeekCount}),Array.from(P.values())}),T=I(()=>{if(!i.value)return[];const P=i.value.thisWeekTickets||[],h=i.value.otherWeekTickets||[];return console.log("[ResponsibleModal] Computing gradations for employee:",{id:i.value.id,name:i.value.name,thisWeekCount:i.value.thisWeekCount,otherWeekCount:i.value.otherWeekCount,thisWeekTickets:P.length,otherWeekTickets:h.length,employee:i.value}),[{id:"this-week",label:"На этой неделе",count:i.value.thisWeekCount??0,tickets:P,employeeId:i.value.id},{id:"other-week",label:"На другой неделе",count:i.value.otherWeekCount??0,tickets:h,employeeId:i.value.id}]}),k=I(()=>(C.value||[]).length>0),_=I(()=>{if(!l.value||l.value.length===0)return[];try{const P=performance.now(),h=pa(l.value,p.value),w=performance.now();return console.log(`[ResponsibleModal] Filtering took ${(w-P).toFixed(2)}ms, results: ${h.length}`),h}catch(P){return console.error("[ResponsibleModal] Error filtering tickets:",P),[]}}),A=I(()=>Object.keys(Ut).map(P=>({key:P,label:Ut[P],count:pa(l.value,P).length})));async function U(P){const h=P.filter(w=>w.id!==null&&w.id!==void 0).map(w=>w.id);if(h.length===0)return P;try{const w=await va.getEmployeesByIds(h),B=new Map;return w.forEach(re=>{B.set(re.id,re.name)}),P.map(re=>re.id&&B.has(re.id)?{...re,name:B.get(re.id)}:re)}catch(w){return console.error("[ResponsibleModal] Error enriching names:",w),P}}Ne([()=>t.value,()=>S.value],async([P,h])=>{if(!(P!=="employees"||a.value!==0)){if(!h||h.length===0){C.value=[];return}f.value=!0;try{C.value=await U(h)}catch(w){console.error("[ResponsibleModal] Error loading employee names:",w),C.value=h}finally{f.value=!1}}},{immediate:!0}),Ne(()=>e.responsible,async P=>{if(!(a.value!==0||r.value||t.value!=="categories")){if(!P||P.length===0){v.value=[];return}f.value=!0;try{v.value=await U(P)}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=P}finally{f.value=!1}}},{immediate:!1});const x=I(()=>(v.value||[]).length>0);function D(P){t.value!==P&&(t.value=P,a.value=0,r.value=null,i.value=null,n.value=null,l.value=[],g.value=null,v.value=[],C.value=[])}async function E(P){if(!P||P.count===0){console.warn("[ResponsibleModal] handleCategoryClick: Invalid category or count is 0",{category:P,count:P?.count});return}console.log("[ResponsibleModal] handleCategoryClick called:",{categoryId:P.id,categoryLabel:P.label,categoryCount:P.count,responsibleCount:P.responsible?.length||0,responsibleWithTickets:P.responsible?.filter(h=>h.tickets&&h.tickets.length>0).length||0,responsibleSample:P.responsible?.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))}),r.value=P,a.value=1,f.value=!0;try{v.value=await U(P.responsible),console.log("[ResponsibleModal] After enrichResponsibleWithNames:",{enrichedCount:v.value.length,enrichedSample:v.value.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))})}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=P.responsible}finally{f.value=!1}}async function L(P,h=null){!P||!P.id||P.totalCount===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),console.log("[ResponsibleModal] Employee selected from list:",{id:P.id,name:P.name,thisWeekCount:P.thisWeekCount,otherWeekCount:P.otherWeekCount,thisWeekTickets:P.thisWeekTickets?.length||0,otherWeekTickets:P.otherWeekTickets?.length||0,employee:P}),i.value={...P,thisWeekTickets:P.thisWeekTickets||[],otherWeekTickets:P.otherWeekTickets||[]},a.value=1)}async function R(P){if(!P||P.count===0)return;n.value=P,a.value=2;const h=P.tickets||[];console.log("[ResponsibleModal] Gradation clicked:",{id:P.id,label:P.label,count:P.count,ticketsInGradation:h.length,selectedEmployee:i.value?.id}),h.length>0?(console.log("[ResponsibleModal] Loading tickets from gradation:",h.length),await W(h)):(console.log("[ResponsibleModal] Tickets not in gradation, loading from API"),await G(P))}async function W(P){d.value=!0,g.value=null;try{try{const{prepareTicketsForDisplay:h}=await Ce(async()=>{const{prepareTicketsForDisplay:w}=await import("./chunk-qDiINO2f.js").then(B=>B.t);return{prepareTicketsForDisplay:w}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);l.value=await h(P,null,null)}catch(h){console.error("[ResponsibleModal] Error preparing tickets:",h),l.value=P}l.value.length===0&&(g.value=null)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),l.value=[]}finally{d.value=!1}}async function G(P){d.value=!0,g.value=null;try{if(!e.weekStartUtc||!e.weekEndUtc||!i.value)throw new Error("Не указаны границы недели или выбранный сотрудник");const h=await Ft({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0}),re=(P.id==="this-week"?h.data.responsibleCreatedThisWeek:h.data.responsibleCreatedOtherWeek)?.find(le=>le.id===i.value.id)?.tickets||[];try{const{prepareTicketsForDisplay:le}=await Ce(async()=>{const{prepareTicketsForDisplay:se}=await import("./chunk-qDiINO2f.js").then(me=>me.t);return{prepareTicketsForDisplay:se}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);l.value=await le(re,null,null)}catch(le){console.error("[ResponsibleModal] Error preparing tickets:",le),l.value=re}l.value.length===0&&(g.value=null)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets from API:",h),l.value=[]}finally{d.value=!1}}async function q(P,h=null){!P||!P.id||P.count===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),i.value=P,a.value=2,await oe(P.id))}async function oe(P){d.value=!0,g.value=null;try{let h=[];if(console.log("[ResponsibleModal] loadEmployeeTickets called:",{employeeId:P,selectedCategory:r.value?.id,hasSelectedCategory:!!r.value,hasResponsible:!!r.value?.responsible,responsibleCount:r.value?.responsible?.length||0,categoryData:r.value?{id:r.value.id,label:r.value.label,count:r.value.count,responsibleSample:r.value.responsible?.slice(0,2).map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0}))}:null}),r.value&&r.value.responsible){const w=r.value.responsible.find(B=>B.id===P);console.log("[ResponsibleModal] Employee found in category:",{employee:w,hasTickets:!!w?.tickets,ticketsCount:w?.tickets?.length||0,tickets:w?.tickets?w.tickets.slice(0,2):null}),h=w?.tickets||[]}if(h.length===0&&e.weekStartUtc&&e.weekEndUtc){console.log("[ResponsibleModal] Tickets not found in category, loading from API",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,categoryId:r.value?.id});const w=await Ft({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0});console.log("[ResponsibleModal] API response:",{hasResponsibleCreatedThisWeek:!!w.data.responsibleCreatedThisWeek,hasResponsibleCreatedOtherWeek:!!w.data.responsibleCreatedOtherWeek,thisWeekCount:w.data.responsibleCreatedThisWeek?.length||0,otherWeekCount:w.data.responsibleCreatedOtherWeek?.length||0,thisWeekSample:w.data.responsibleCreatedThisWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0})),otherWeekSample:w.data.responsibleCreatedOtherWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const B=r.value?.id==="created-this-week"?w.data.responsibleCreatedThisWeek:w.data.responsibleCreatedOtherWeek;console.log("[ResponsibleModal] Category data:",{categoryId:r.value?.id,categoryDataCount:B?.length||0,categoryDataSample:B?.slice(0,2).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const re=B?.find(le=>le.id===P);console.log("[ResponsibleModal] Employee found in API response:",{employee:re?{id:re.id,name:re.name,count:re.count,hasTickets:!!re.tickets,ticketsCount:re.tickets?.length||0,ticketsSample:re.tickets?.slice(0,2)}:null}),h=re?.tickets||[]}console.log("[ResponsibleModal] Final employeeTickets before prepareTicketsForDisplay:",{ticketsCount:h.length,ticketsSample:h.slice(0,2).map(w=>({id:w.id,title:w.title||w.ufSubject||"No title",stageId:w.stageId}))});try{const{prepareTicketsForDisplay:w}=await Ce(async()=>{const{prepareTicketsForDisplay:B}=await import("./chunk-qDiINO2f.js").then(re=>re.t);return{prepareTicketsForDisplay:B}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);l.value=await w(h,null,null),console.log("[ResponsibleModal] Tickets after prepareTicketsForDisplay:",{ticketsCount:l.value.length,ticketsSample:l.value.slice(0,2).map(B=>({id:B.id,title:B.title||B.ufSubject||"No title",stageId:B.stageId}))})}catch(w){console.error("[ResponsibleModal] Error preparing tickets:",w),console.error("[ResponsibleModal] prepareError details:",{message:w.message,stack:w.stack,employeeTicketsCount:h.length}),l.value=h,console.log("[ResponsibleModal] Using fallback tickets (without enrichment):",l.value.length)}l.value.length===0?(console.warn("[ResponsibleModal] No tickets after loading and preparation",{employeeId:P,categoryId:r.value?.id,employeeTicketsCount:h.length,finalTicketsCount:l.value.length}),g.value=null):console.log("[ResponsibleModal] Successfully loaded tickets:",l.value.length)}catch(h){g.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),console.error("[ResponsibleModal] Error details:",{message:h.message,stack:h.stack,employeeId:P,categoryId:r.value?.id}),l.value=[]}finally{d.value=!1}}function Y(){a.value===2?(a.value=1,t.value==="categories"?i.value=null:n.value=null,l.value=[],g.value=null):a.value===1&&(a.value=0,t.value==="categories"?(r.value=null,v.value=[]):i.value=null)}function H(P){console.log(`[ResponsibleModal] Sort mode changed: ${p.value} -> ${P}`);const h=performance.now();p.value=P,setTimeout(()=>{const w=_.value,B=performance.now();console.log(`[ResponsibleModal] Filtering completed in ${(B-h).toFixed(2)}ms, ${w.length} tickets shown`)},0)}function Z(P){const h=aa(P.id);window.open(h,"_blank")}function fe(){t.value==="employees"&&n.value?W(n.value.tickets):t.value==="categories"&&i.value&&oe(i.value.id)}return Ne(()=>e.isVisible,P=>{if(P){console.log("[TASK-070] ResponsibleModal opened for week",e.weekNumber),console.log("[TASK-070] ResponsibleModal props types:",{responsibleCreatedThisWeekType:typeof e.responsibleCreatedThisWeek,responsibleCreatedThisWeekIsArray:Array.isArray(e.responsibleCreatedThisWeek),responsibleCreatedThisWeekLength:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:"not array",responsibleCreatedOtherWeekType:typeof e.responsibleCreatedOtherWeek,responsibleCreatedOtherWeekIsArray:Array.isArray(e.responsibleCreatedOtherWeek),responsibleCreatedOtherWeekLength:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:"not array"}),console.log("[TASK-070] ResponsibleModal data:",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,responsibleCreatedThisWeek:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:e.responsibleCreatedThisWeek?"not array":"null/undefined",responsibleCreatedOtherWeek:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:e.responsibleCreatedOtherWeek?"not array":"null/undefined",closedTicketsCreatedThisWeek:e.closedTicketsCreatedThisWeek,closedTicketsCreatedOtherWeek:e.closedTicketsCreatedOtherWeek}),console.log("[TASK-070] ResponsibleModal detailed data:",{responsibleCreatedThisWeek:e.responsibleCreatedThisWeek,responsibleCreatedOtherWeek:e.responsibleCreatedOtherWeek,responsibleCreatedThisWeekWithTickets:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null",responsibleCreatedOtherWeekWithTickets:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null"});const h=e.weekNumber;h&&console.log("[TASK-070] ResponsibleModal: Week number",h)}else a.value=0,t.value="categories",r.value=null,i.value=null,n.value=null,l.value=[],g.value=null,v.value=[],C.value=[]}),(P,h)=>o.isVisible?(c(),u("div",Jv,[s("div",Zv,[a.value===0?(c(),u("div",Qv,[s("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="categories"}]),onClick:h[0]||(h[0]=w=>D("categories"))}," По категориям ",2),s("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="employees"}]),onClick:h[1]||(h[1]=w=>D("employees"))}," По сотрудникам ",2)])):$("",!0),ne(Ae,{name:"level",mode:"out-in"},{default:ye(()=>[t.value==="categories"&&a.value===0?(c(),u("div",ep,[s("header",tp,[s("h3",ap,[h[12]||(h[12]=ge(" Закрытые за неделю",-1)),o.weekNumber?(c(),u("span",sp," · Неделя "+m(o.weekNumber),1)):$("",!0)]),s("button",{class:"modal__close",onClick:h[2]||(h[2]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",op,[s("ul",np,[(c(!0),u(ee,null,te(y.value,w=>(c(),u("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:B=>E(w)},[s("div",ip,[s("div",lp,[w.id==="created-this-week"?(c(),u("span",cp,"✓")):(c(),u("span",dp,"↻"))]),s("div",up,[s("div",gp,m(w.label),1),s("div",mp,m(w.count)+" тикетов",1)]),w.count>0?(c(),u("span",hp,"→")):$("",!0)])],10,rp))),128))])]),s("footer",fp,[s("button",{class:"btn",onClick:h[3]||(h[3]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="categories"&&a.value===1?(c(),u("div",vp,[s("header",pp,[s("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),h[13]||(h[13]=s("h3",{class:"modal__title"},"Ответственные за неделю",-1)),s("button",{class:"modal__close",onClick:h[4]||(h[4]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",yp,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[f.value?(c(),u("div",kp,[...h[14]||(h[14]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка имён сотрудников...",-1)])])):x.value?(c(),u("ul",_p,[(c(!0),u(ee,null,te(v.value,w=>(c(),u("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.count>0}]),onClick:B=>q(w,B),title:"Кликните для просмотра тикетов сотрудника"},[s("span",Cp,m(w.name||"Не назначен"),1),s("span",Tp,m(w.count??0)+" тикетов ",1),w.id&&w.count>0?(c(),u("span",Sp,"→")):$("",!0)],10,wp))),128))])):(c(),u("p",bp,"Нет данных по ответственным"))]),_:1})]),s("footer",Dp,[s("button",{class:"btn",onClick:h[5]||(h[5]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="categories"&&a.value===2?(c(),u("div",Ep,[s("header",Ap,[s("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),s("h3",$p,"Тикеты сотрудника: "+m(i.value?.name||"Неизвестно"),1),s("button",{class:"modal__close",onClick:h[6]||(h[6]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",Ip,[s("div",Mp,[h[15]||(h[15]=s("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),s("div",Np,[(c(!0),u(ee,null,te(A.value,w=>(c(),u("button",{key:w.key,class:X(["time-sort-btn",{active:p.value===w.key}]),onClick:B=>H(w.key)},[ge(m(w.label)+" ",1),s("span",Lp,"("+m(w.count)+")",1)],10,xp))),128))])]),ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[d.value?(c(),u("div",Pp,[...h[16]||(h[16]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка тикетов...",-1)])])):g.value?(c(),u("div",Op,[h[17]||(h[17]=s("div",{class:"error-icon"},"⚠️",-1)),h[18]||(h[18]=s("p",{class:"error-title"},"Ошибка загрузки",-1)),s("p",Rp,m(g.value),1),s("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):_.value.length===0?(c(),u("div",Bp,[h[19]||(h[19]=s("div",{class:"empty-state-icon"},"📋",-1)),s("p",Up," У сотрудника нет тикетов за выбранный период ("+m(Ue(Ut)[p.value])+") ",1)])):(c(),u("div",Wp,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(_.value,(w,B)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":B}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):t.value==="employees"&&a.value===0?(c(),u("div",Fp,[s("header",Hp,[s("h3",jp,[h[20]||(h[20]=ge(" Закрытые за неделю",-1)),o.weekNumber?(c(),u("span",Vp," · Неделя "+m(o.weekNumber),1)):$("",!0)]),s("button",{class:"modal__close",onClick:h[7]||(h[7]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",zp,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[f.value?(c(),u("div",Gp,[...h[21]||(h[21]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка имён сотрудников...",-1)])])):k.value?(c(),u("ul",qp,[(c(!0),u(ee,null,te(C.value,w=>(c(),u("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.totalCount>0}]),onClick:B=>L(w,B),title:"Кликните для просмотра градации тикетов сотрудника"},[s("span",Xp,m(w.name||"Не назначен"),1),s("span",Jp,m(w.totalCount??0)+" тикетов ",1),w.id&&w.totalCount>0?(c(),u("span",Zp,"→")):$("",!0)],10,Yp))),128))])):(c(),u("p",Kp,"Нет данных по сотрудникам"))]),_:1})]),s("footer",Qp,[s("button",{class:"btn",onClick:h[8]||(h[8]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="employees"&&a.value===1?(c(),u("div",ey,[s("header",ty,[s("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),s("h3",ay,"Тикеты сотрудника: "+m(i.value?.name||"Неизвестно"),1),s("button",{class:"modal__close",onClick:h[9]||(h[9]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",sy,[s("ul",oy,[(c(!0),u(ee,null,te(T.value,w=>(c(),u("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:B=>R(w)},[s("div",ry,[s("div",iy,[w.id==="this-week"?(c(),u("span",ly,"✓")):(c(),u("span",cy,"↻"))]),s("div",dy,[s("div",uy,m(w.label),1),s("div",gy,m(w.count)+" тикетов",1)]),w.count>0?(c(),u("span",my,"→")):$("",!0)])],10,ny))),128))])]),s("footer",hy,[s("button",{class:"btn",onClick:h[10]||(h[10]=w=>P.$emit("close"))},"Закрыть")])])):t.value==="employees"&&a.value===2?(c(),u("div",fy,[s("header",vy,[s("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),s("h3",py," Тикеты сотрудника: "+m(i.value?.name||"Неизвестно")+" ("+m(n.value?.label||"")+") ",1),s("button",{class:"modal__close",onClick:h[11]||(h[11]=w=>P.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",yy,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[d.value?(c(),u("div",ky,[...h[22]||(h[22]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка тикетов...",-1)])])):g.value?(c(),u("div",by,[h[23]||(h[23]=s("div",{class:"error-icon"},"⚠️",-1)),h[24]||(h[24]=s("p",{class:"error-title"},"Ошибка загрузки",-1)),s("p",_y,m(g.value),1),s("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):l.value.length===0?(c(),u("div",wy,[h[25]||(h[25]=s("div",{class:"empty-state-icon"},"📋",-1)),s("p",Cy,m(t.value==="employees"?`У сотрудника нет тикетов в категории "${n.value?.label||""}"`:"У сотрудника нет закрытых тикетов за выбранную неделю"),1)])):(c(),u("div",Ty,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(_.value,(w,B)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":B}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Dy=ce(Sy,[["__scopeId","data-v-6f43202a"]]),Ey={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Ay={class:"modal"},$y={key:"level-1",class:"level-1"},Iy={class:"modal__header"},My={class:"modal__title"},Ny={key:0},xy={class:"modal__body"},Ly={key:"loading",class:"loading-names"},Py={key:"empty",class:"modal__empty"},Oy={key:"list",class:"stages-list"},Ry=["onClick"],By={class:"stages-list__name"},Uy={class:"stages-list__count"},Wy={key:0,class:"stages-list__arrow"},Fy={class:"modal__footer"},Hy={key:"level-2",class:"level-2"},jy={class:"modal__header"},Vy={class:"modal__title"},zy={class:"modal__body"},Gy={class:"time-sort-controls"},Ky={class:"time-sort-buttons"},qy=["onClick"],Yy={class:"count"},Xy={key:"loading",class:"loading-state"},Jy={key:"error",class:"error-state"},Zy={class:"error-message"},Qy={key:"empty",class:"empty-state"},ek={class:"empty-state-message"},tk={key:"tickets",class:"tickets-list-container"},ak={__name:"StagesModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const a=o,t=M(1),r=M(null),i=M([]),n=M(!1),l=M(!1),d=M(null),g=M([]),v=M(it.ONE_MONTH),C=I(()=>g.value.length>0&&g.value.some(x=>x.count>0)),f=I(()=>{if(!i.value||i.value.length===0)return[];try{const x=performance.now(),D=pa(i.value,v.value),E=performance.now();return console.log(`[StagesModal] Filtering took ${(E-x).toFixed(2)}ms, results: ${D.length}`),D}catch(x){return console.error("[StagesModal] Error filtering tickets:",x),[]}}),p=I(()=>Object.keys(Ut).map(x=>({key:x,label:Ut[x],count:pa(i.value,x).length})));async function y(){if(console.log("[TASK-070] StagesModal: loadStages called",{weekNumber:a.weekNumber,weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc}),!a.weekStartUtc||!a.weekEndUtc){console.warn("[TASK-070] StagesModal: Missing week boundaries, cannot load stages"),g.value=[];return}l.value=!0,d.value=null;try{console.log("[TASK-070] StagesModal: Fetching stages from API...");const x=await Ft({product:"1C",weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc,includeNewTicketsByStages:!0});console.log("[TASK-070] StagesModal: API response received",{hasNewTicketsByStages:!!x.data.newTicketsByStages,stagesCount:x.data.newTicketsByStages?.length||0}),g.value=x.data.newTicketsByStages||[],g.value.length===0?console.warn("[TASK-070] StagesModal: API returned empty stages array for week",a.weekNumber):console.log("[TASK-070] StagesModal: Stages loaded successfully",g.value.length,"stages")}catch(x){d.value=x.message||"Ошибка загрузки стадий",console.error("[TASK-070] StagesModal: Error loading stages:",x),g.value=[]}finally{l.value=!1}}async function S(x,D=null){!x||x.count===0||(D&&D.currentTarget&&(D.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{D.currentTarget&&(D.currentTarget.style.transform="")},150)),r.value=x,t.value=2,await T(x.stageId))}async function T(x){n.value=!0,d.value=null;try{const D=g.value.find(W=>W.stageId===x);if(D&&Array.isArray(D.tickets)&&D.tickets.length>0){console.log("[TASK-070] StagesModal: Using preloaded tickets for stage",x,"count:",D.tickets.length);const W=D.tickets;try{const{prepareTicketsForDisplay:G}=await Ce(async()=>{const{prepareTicketsForDisplay:q}=await import("./chunk-qDiINO2f.js").then(oe=>oe.t);return{prepareTicketsForDisplay:q}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);i.value=await G(W,null,null)}catch(G){console.error("[TASK-070] StagesModal: Error preparing tickets:",G),i.value=W}n.value=!1;return}if(console.log("[TASK-070] StagesModal: Tickets not preloaded, loading from API for stage",x),!a.weekStartUtc||!a.weekEndUtc)throw new Error("Не указаны границы недели");const R=(await Ft({product:"1C",weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc,includeNewTicketsByStages:!0,includeTickets:!0})).data.newTicketsByStages?.find(W=>W.stageId===x)?.tickets||[];try{const{prepareTicketsForDisplay:W}=await Ce(async()=>{const{prepareTicketsForDisplay:G}=await import("./chunk-qDiINO2f.js").then(q=>q.t);return{prepareTicketsForDisplay:G}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);i.value=await W(R,null,null)}catch(W){console.error("[StagesModal] Error preparing tickets:",W),i.value=R}i.value.length===0&&(d.value=null)}catch(D){d.value=D.message||"Ошибка загрузки тикетов",console.error("[StagesModal] Error loading tickets:",D),i.value=[]}finally{n.value=!1}}function k(){t.value=1,r.value=null,i.value=[],d.value=null}function _(x){const D=aa(x.id);window.open(D,"_blank")}function A(){r.value&&T(r.value.stageId)}function U(x){console.log(`[StagesModal] Sort mode changed: ${v.value} -> ${x}`);const D=performance.now();v.value=x,setTimeout(()=>{const E=f.value,L=performance.now();console.log(`[StagesModal] Filtering completed in ${(L-D).toFixed(2)}ms, ${E.length} tickets shown`)},0)}return Ne(()=>a.isVisible,async x=>{x?(t.value=1,r.value=null,i.value=[],d.value=null,console.log("[TASK-070] StagesModal opened:",{weekNumber:a.weekNumber,weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc,preloadedData:a.preloadedData?Array.isArray(a.preloadedData)?`Array(${a.preloadedData.length})`:typeof a.preloadedData:"null"}),a.preloadedData&&Array.isArray(a.preloadedData)&&a.preloadedData.length>0?(console.log("[TASK-070] StagesModal: Using preloaded data, stages count:",a.preloadedData.length),a.preloadedData.every(E=>E.stageId&&E.stageName&&typeof E.count=="number")?(g.value=a.preloadedData,l.value=!1,console.log("[TASK-070] StagesModal: Preloaded data set, stages:",g.value.length)):(console.warn("[TASK-070] StagesModal: Invalid preloaded data structure, falling back to API"),await y())):(console.log("[TASK-070] StagesModal: No preloaded data, loading from API",{weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc}),await y())):(t.value=1,r.value=null,i.value=[],d.value=null,g.value=[])},{immediate:!1}),Ne([()=>a.weekNumber,()=>a.preloadedData],async([x,D])=>{a.isVisible&&x&&(D&&Array.isArray(D)&&D.length>0?D.every(L=>L.stageId&&L.stageName&&typeof L.count=="number")?(console.log("[TASK-070] StagesModal: Week changed, updating with preloaded data for week",x),g.value=D,l.value=!1):(console.log("[TASK-070] StagesModal: Week changed, invalid preloaded data, loading from API for week",x),await y()):(console.log("[TASK-070] StagesModal: Week changed, loading from API for week",x),await y()))}),(x,D)=>o.isVisible?(c(),u("div",Ey,[s("div",Ay,[ne(Ae,{name:"level",mode:"out-in"},{default:ye(()=>[t.value===1?(c(),u("div",$y,[s("header",Iy,[s("h3",My,[D[3]||(D[3]=ge(" Новые тикеты по стадиям",-1)),o.weekNumber?(c(),u("span",Ny," · Неделя "+m(o.weekNumber),1)):$("",!0)]),s("button",{class:"modal__close",onClick:D[0]||(D[0]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",xy,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[l.value?(c(),u("div",Ly,[...D[4]||(D[4]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка стадий...",-1)])])):C.value?(c(),u("ul",Oy,[(c(!0),u(ee,null,te(g.value,E=>(c(),u("li",{key:E.stageId,class:X(["stages-list__item",{"stages-list__item--clickable":E.count>0}]),style:we({"--stage-color":E.color}),onClick:L=>S(E,L),title:"Кликните для просмотра тикетов стадии"},[s("span",{class:"stages-list__color",style:we({backgroundColor:E.color})},null,4),s("span",By,m(E.stageName),1),s("span",Uy,m(E.count)+" тикетов ",1),E.count>0?(c(),u("span",Wy,"→")):$("",!0)],14,Ry))),128))])):(c(),u("p",Py," Нет новых тикетов за выбранную неделю "))]),_:1})]),s("footer",Fy,[s("button",{class:"btn",onClick:D[1]||(D[1]=E=>x.$emit("close"))},"Закрыть")])])):t.value===2?(c(),u("div",Hy,[s("header",jy,[s("button",{class:"btn-back",onClick:k,"aria-label":"Назад"},"← Назад"),s("h3",Vy," Тикеты стадии: "+m(r.value?.stageName||"Неизвестно"),1),s("button",{class:"modal__close",onClick:D[2]||(D[2]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",zy,[s("div",Gy,[D[5]||(D[5]=s("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),s("div",Ky,[(c(!0),u(ee,null,te(p.value,E=>(c(),u("button",{key:E.key,class:X(["time-sort-btn",{active:v.value===E.key}]),onClick:L=>U(E.key)},[ge(m(E.label)+" ",1),s("span",Yy,"("+m(E.count)+")",1)],10,qy))),128))])]),ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[n.value?(c(),u("div",Xy,[...D[6]||(D[6]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка тикетов стадии...",-1),s("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):d.value?(c(),u("div",Jy,[D[7]||(D[7]=s("div",{class:"error-icon"},"⚠️",-1)),D[8]||(D[8]=s("p",{class:"error-title"},"Ошибка загрузки",-1)),s("p",Zy,m(d.value),1),s("button",{class:"btn btn-retry",onClick:A},"Повторить")])):f.value.length===0?(c(),u("div",Qy,[D[9]||(D[9]=s("div",{class:"empty-state-icon"},"📋",-1)),s("p",ek," На стадии «"+m(r.value?.stageName)+"» нет тикетов за выбранный период ("+m(Ue(Ut)[v.value])+") ",1)])):(c(),u("div",tk,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(f.value,(E,L)=>(c(),he(Ct,{key:E.id,ticket:E,draggable:!1,style:we({"--ticket-index":L}),onClick:_},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},sk=ce(ak,[["__scopeId","data-v-0dacaef9"]]),Pt=new Map,ok=5*60*1e3;function nk(o,e){return`${o}:${JSON.stringify(e)}`}function rs(o){return Date.now()-o.timestamp<ok}function rk(o,e){if(Pt.set(o,{data:e,timestamp:Date.now()}),Pt.size>20){const a=Pt.keys().next().value;Pt.delete(a)}}function ik(o){const e=Pt.get(o);return e&&rs(e)?(console.log("[API-CACHE] Cache hit for key:",o),e.data):(e&&!rs(e)&&(console.log("[API-CACHE] Cache expired for key:",o),Pt.delete(o)),null)}async function lk(o={}){const e="/api/graph-1c-admission-closure.php",a=nk(e,o),t=ik(e);if(t)return t;console.log("[API-CACHE] Cache miss, making API request for:",a);const{LazyServiceLoader:r}=await Ce(async()=>{const{LazyServiceLoader:l}=await import("./chunk-BuX-LpxK.js").then(d=>d.l);return{LazyServiceLoader:l}},__vite__mapDeps([5,3]),import.meta.url),{fetchAdmissionClosureStats:i}=await r.loadAdmissionClosureService(),n=await i(o);return rk(a,n),n}async function ck(o,e){return lk({product:"1C",weekStartUtc:o,weekEndUtc:e,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!0})}const dk={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},uk={class:"modal"},gk={key:"level-1",class:"level-1"},mk={class:"modal__header"},hk={class:"modal__title"},fk={key:0},vk={class:"modal__body"},pk={key:"loading",class:"loading-names"},yk={key:"empty",class:"modal__empty"},kk={key:"list",class:"duration-list"},bk=["onClick"],_k={class:"duration-list__name"},wk={class:"duration-list__count"},Ck={key:0,class:"duration-list__arrow"},Tk={class:"modal__footer"},Sk={key:"level-2",class:"level-2"},Dk={class:"modal__header"},Ek={class:"modal__title"},Ak={class:"modal__body"},$k={key:"loading",class:"loading-state"},Ik={key:"error",class:"error-state"},Mk={class:"error-message"},Nk={key:"empty",class:"empty-state"},xk={class:"empty-state-message"},Lk={key:"tickets",class:"tickets-list-container"},Pk={__name:"CarryoverDurationModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const a=o,t=M(1),r=M(null),i=M([]),n=M(!1),l=M(!1),d=M(null),g=M([]),v=I(()=>g.value.length>0&&g.value.some(k=>k.count>0));async function C(){if(!a.weekStartUtc||!a.weekEndUtc){g.value=[];return}l.value=!0,d.value=null;try{const k=await Ft({product:"1C",weekStartUtc:a.weekStartUtc,weekEndUtc:a.weekEndUtc,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0});g.value=k.data.carryoverTicketsByDuration||[]}catch(k){d.value=k.message||"Ошибка загрузки категорий",console.error("[CarryoverDurationModal] Error loading categories:",k),g.value=[]}finally{l.value=!1}}async function f(k,_=null){!k||k.count===0||(_&&_.currentTarget&&(_.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{_.currentTarget&&(_.currentTarget.style.transform="")},150)),r.value=k,t.value=2,await p(k.durationCategory))}async function p(k){n.value=!0,d.value=null;try{const _=g.value.find(D=>D.durationCategory===k);if(_&&Array.isArray(_.tickets)&&_.tickets.length>0){console.log("[TASK-070] CarryoverDurationModal: Using preloaded tickets for category",k,"count:",_.tickets.length);const D=_.tickets;try{const{prepareTicketsForDisplay:E}=await Ce(async()=>{const{prepareTicketsForDisplay:L}=await import("./chunk-qDiINO2f.js").then(R=>R.t);return{prepareTicketsForDisplay:L}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);i.value=await E(D,null,null)}catch(E){console.error("[TASK-070] CarryoverDurationModal: Error preparing tickets:",E),i.value=D}n.value=!1;return}if(console.log("[TASK-070] CarryoverDurationModal: Tickets not preloaded, loading from API for category",k),!a.weekStartUtc||!a.weekEndUtc)throw new Error("Не указаны границы недели");const x=(await ck(a.weekStartUtc,a.weekEndUtc)).data.carryoverTicketsByDuration?.find(D=>D.durationCategory===k)?.tickets||[];try{const{prepareTicketsForDisplay:D}=await Ce(async()=>{const{prepareTicketsForDisplay:E}=await import("./chunk-qDiINO2f.js").then(L=>L.t);return{prepareTicketsForDisplay:E}},__vite__mapDeps([6,7,4,5,3]),import.meta.url);i.value=await D(x,null,null)}catch(D){console.error("[CarryoverDurationModal] Error preparing tickets:",D),i.value=x}i.value.length===0&&(d.value=null)}catch(_){d.value=_.message||"Ошибка загрузки тикетов",console.error("[CarryoverDurationModal] Error loading tickets:",_),i.value=[]}finally{n.value=!1}}function y(){t.value=1,r.value=null,i.value=[],d.value=null}function S(k){const _=aa(k.id);window.open(_,"_blank")}function T(){r.value&&p(r.value.durationCategory)}return Ne(()=>a.isVisible,async k=>{k?(t.value=1,r.value=null,i.value=[],d.value=null,a.preloadedData&&Array.isArray(a.preloadedData)&&a.preloadedData.length>0?(console.log("[TASK-070] CarryoverDurationModal: Using preloaded data, categories count:",a.preloadedData.length),a.preloadedData.every(A=>A.durationCategory&&A.durationLabel&&typeof A.count=="number")?(g.value=a.preloadedData,l.value=!1):(console.warn("[TASK-070] CarryoverDurationModal: Invalid preloaded data structure, falling back to API"),await C())):(console.log("[TASK-070] CarryoverDurationModal: No preloaded data, loading from API"),await C())):(t.value=1,r.value=null,i.value=[],d.value=null,g.value=[])},{immediate:!1}),Ne([()=>a.weekNumber,()=>a.preloadedData],async([k,_])=>{a.isVisible&&k&&(_&&Array.isArray(_)&&_.length>0?_.every(U=>U.durationCategory&&U.durationLabel&&typeof U.count=="number")?(console.log("[TASK-070] CarryoverDurationModal: Week changed, updating with preloaded data for week",k),g.value=_,l.value=!1):(console.log("[TASK-070] CarryoverDurationModal: Week changed, invalid preloaded data, loading from API for week",k),await C()):(console.log("[TASK-070] CarryoverDurationModal: Week changed, loading from API for week",k),await C()))}),(k,_)=>o.isVisible?(c(),u("div",dk,[s("div",uk,[ne(Ae,{name:"level",mode:"out-in"},{default:ye(()=>[t.value===1?(c(),u("div",gk,[s("header",mk,[s("h3",hk,[_[3]||(_[3]=ge(" Переходящие тикеты по срокам",-1)),o.weekNumber?(c(),u("span",fk," · Неделя "+m(o.weekNumber),1)):$("",!0)]),s("button",{class:"modal__close",onClick:_[0]||(_[0]=A=>k.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",vk,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[l.value?(c(),u("div",pk,[..._[4]||(_[4]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка категорий...",-1)])])):v.value?(c(),u("ul",kk,[(c(!0),u(ee,null,te(g.value,A=>(c(),u("li",{key:A.durationCategory,class:X(["duration-list__item",{"duration-list__item--clickable":A.count>0}]),style:we({"--duration-color":A.color}),onClick:U=>f(A,U),title:"Кликните для просмотра тикетов категории"},[s("span",{class:"duration-list__color",style:we({backgroundColor:A.color})},null,4),s("span",_k,m(A.durationLabel),1),s("span",wk,m(A.count)+" тикетов ",1),A.count>0?(c(),u("span",Ck,"→")):$("",!0)],14,bk))),128))])):(c(),u("p",yk," Нет переходящих тикетов за выбранную неделю "))]),_:1})]),s("footer",Tk,[s("button",{class:"btn",onClick:_[1]||(_[1]=A=>k.$emit("close"))},"Закрыть")])])):t.value===2?(c(),u("div",Sk,[s("header",Dk,[s("button",{class:"btn-back",onClick:y,"aria-label":"Назад"},"← Назад"),s("h3",Ek," Тикеты: "+m(r.value?.durationLabel||"Неизвестно"),1),s("button",{class:"modal__close",onClick:_[2]||(_[2]=A=>k.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),s("section",Ak,[ne(Ae,{name:"loading",mode:"out-in"},{default:ye(()=>[n.value?(c(),u("div",$k,[..._[5]||(_[5]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Загрузка тикетов категории...",-1),s("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):d.value?(c(),u("div",Ik,[_[6]||(_[6]=s("div",{class:"error-icon"},"⚠️",-1)),_[7]||(_[7]=s("p",{class:"error-title"},"Ошибка загрузки",-1)),s("p",Mk,m(d.value),1),s("button",{class:"btn btn-retry",onClick:T},"Повторить")])):i.value.length===0?(c(),u("div",Nk,[_[8]||(_[8]=s("div",{class:"empty-state-icon"},"📋",-1)),s("p",xk," В категории «"+m(r.value?.durationLabel)+"» нет тикетов ",1)])):(c(),u("div",Lk,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(c(!0),u(ee,null,te(i.value,(A,U)=>(c(),he(Ct,{key:A.id,ticket:A,draggable:!1,style:we({"--ticket-index":U}),onClick:S},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Ok=ce(Pk,[["__scopeId","data-v-f199806c"]]);function Rk(){const o=M(null),e=M(!1),a=M(null),t=async()=>{if(o.value)return o.value;try{e.value=!0,a.value=null;const{fetchAdmissionClosureStats:n,...l}=await wo.loadAdmissionClosureService();o.value={fetchAdmissionClosureStats:n,...l}}catch(n){throw a.value=n,console.error("Failed to load admission service:",n),n}finally{e.value=!1}return o.value},r=async(n={})=>(await t()).fetchAdmissionClosureStats(n),i=()=>{o.value=null,a.value=null};return{service:wa(o),loading:wa(e),error:wa(a),loadService:t,fetchStats:r,clearService:i}}const Bk={class:"ac-dashboard"},Uk={key:"preloader",class:"chart-preloader"},Wk={class:"preloader-content"},Fk={class:"preloader-message"},Hk={key:"content"},jk={key:1,class:"weeks-dashboard"},Vk={class:"dashboard-header"},zk={class:"header-content"},Gk={class:"breadcrumbs-row"},Kk=["aria-label","aria-disabled","data-fallback","disabled"],qk={class:"breadcrumbs","aria-label":"Навигация"},Yk={class:"dashboard-layout"},Xk={class:"filters-container"},Jk={class:"chart-container"},Zk={__name:"GraphAdmissionClosureDashboard",setup(o){const e=Xe(),{fetchStats:a}=Rk(),t=async b=>await a(b),r=M(!1),i=M(null),n=M(null),l=M({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),d=M(!1),g=M(!1),v=M(!1),C=M(!0),f=M(null),p=M({weeks:new Map,currentWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null},previousWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null}}),y=I(()=>{const b=n.value?.weeks||[];return b.length>=2?b[b.length-2]:null}),S=M(!1),T=I(()=>typeof window>"u"?!1:window.history.length>1),k=I(()=>T.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),_={name:"dashboard-sector-1c"};function A(b){if(b?.preventDefault?.(),!S.value){S.value=!0;try{if(T.value){e.back();return}console.warn("GraphAdmissionClosureDashboard: fallback navigation to dashboard-sector-1c"),e.push(_)}finally{S.value=!1}}}function U(){e.push("/")}const x=M({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),D=M("weeks"),E=I(()=>{const b=x.value.customDateRange.startDate||x.value.customDateRange.endDate,O=x.value.employees.length===1&&x.value.employees.includes("all");return b||!O});async function L(){if(console.log("[DEBUG] loadData called"),console.log("[DEBUG] periodMode:",D.value),console.log("[DEBUG] isLoading before:",r.value),D.value!=="weeks"){console.log("[DEBUG] loadData: periodMode is not weeks, returning and resetting isLoading"),r.value=!1;return}console.log("[DEBUG] Setting isLoading to true"),r.value=!0,i.value=null;const b=new Promise(O=>setTimeout(O,300));try{console.log("[DEBUG] Starting API call");const O=N(),Q=O.weekStartUtc,de=O.weekEndUtc;console.log("[DEBUG] Week bounds:",{weekStartUtc:Q,weekEndUtc:de});const[ke,_e]=await Promise.all([b,t({product:"1C",periodMode:"weeks",weekStartUtc:Q,weekEndUtc:de,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0})]);console.log("[DEBUG] API call successful, result:",_e);const{meta:K,data:j,carryoverDebug:V}=_e;n.value=K;const ae=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:j.responsibleCreatedThisWeek?Object.values(j.responsibleCreatedThisWeek):[],ue=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:j.responsibleCreatedOtherWeek?Object.values(j.responsibleCreatedOtherWeek):[];l.value={...j,responsibleCreatedThisWeek:ae,responsibleCreatedOtherWeek:ue},console.log("[DEBUG] Data set, meta:",K,"data keys:",Object.keys(j)),console.log("[TASK-070] chartData.value.responsibleCreatedThisWeek after normalization:",{isArray:Array.isArray(ae),length:ae.length,sample:ae.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] chartData.value.responsibleCreatedOtherWeek after normalization:",{isArray:Array.isArray(ue),length:ue.length,sample:ue.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedThisWeek from API:",{count:j.responsibleCreatedThisWeek?.length||0,data:j.responsibleCreatedThisWeek,details:j.responsibleCreatedThisWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedOtherWeek from API:",{count:j.responsibleCreatedOtherWeek?.length||0,data:j.responsibleCreatedOtherWeek,details:j.responsibleCreatedOtherWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] closedTicketsCreatedThisWeek:",j.closedTicketsCreatedThisWeek),console.log("[TASK-070] closedTicketsCreatedOtherWeek:",j.closedTicketsCreatedOtherWeek);const pe=K?.weeks||[];if(console.log("[PERF-OPTIMIZATION] Preloading popup data for",pe.length,"weeks"),pe.forEach((F,ie)=>{p.value.weeks.has(F.weekNumber)||p.value.weeks.set(F.weekNumber,{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:F});const ve=p.value.weeks.get(F.weekNumber);ie===pe.length-1&&(j.newTicketsByStages&&(ve.newTicketsByStages=j.newTicketsByStages,console.log("[PERF-OPTIMIZATION] Preloaded newTicketsByStages for week",F.weekNumber,":",j.newTicketsByStages.length,"stages")),j.carryoverTicketsByDuration&&(ve.carryoverTicketsByDuration=j.carryoverTicketsByDuration,console.log("[PERF-OPTIMIZATION] Preloaded carryoverTicketsByDuration for week",F.weekNumber,":",j.carryoverTicketsByDuration.length,"categories")))}),j.newTicketsByStages&&(p.value.currentWeek.newTicketsByStages=j.newTicketsByStages),j.carryoverTicketsByDuration&&(p.value.currentWeek.carryoverTicketsByDuration=j.carryoverTicketsByDuration),pe.length>1&&G(pe.slice(0,-1)),j.responsibleCreatedThisWeek){const F=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:Object.values(j.responsibleCreatedThisWeek);p.value.currentWeek.responsibleCreatedThisWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedThisWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(j.responsibleCreatedOtherWeek){const F=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:Object.values(j.responsibleCreatedOtherWeek);p.value.currentWeek.responsibleCreatedOtherWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedOtherWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(V&&(console.log("[CARRYOVER-DEBUG] ========================================"),console.log("[CARRYOVER-DEBUG] Total:",V.total),console.log("[CARRYOVER-DEBUG] ThisWeek:",V.thisWeek),console.log("[CARRYOVER-DEBUG] PreviousWeek:",V.previousWeek),console.log("[CARRYOVER-DEBUG] Older:",V.older),console.log("[CARRYOVER-DEBUG] Sum:",V.sum,"(expected:",V.total,")"),console.log("[CARRYOVER-DEBUG] Series:",V.series),console.log("[CARRYOVER-DEBUG] CurrentWeekData:",V.currentWeekData),console.log("[CARRYOVER-DEBUG] WeeksData:",V.weeksData),console.log("[CARRYOVER-DEBUG] Full object:",V),console.log("[CARRYOVER-DEBUG] ========================================")),y.value){const F=y.value.weekStartUtc,ie=y.value.weekEndUtc;console.log("[TASK-070] Starting preload for previous week:",{weekNumber:y.value.weekNumber,weekStartUtc:F,weekEndUtc:ie}),t({product:"1C",periodMode:"weeks",weekStartUtc:F,weekEndUtc:ie,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0}).then(ve=>{if(console.log("[TASK-070] Preload successful for previous week"),ve.data.newTicketsByStages&&(p.value.previousWeek.newTicketsByStages=ve.data.newTicketsByStages,console.log("[TASK-070] Preloaded newTicketsByStages for previous week:",ve.data.newTicketsByStages.length,"stages")),ve.data.carryoverTicketsByDuration&&(p.value.previousWeek.carryoverTicketsByDuration=ve.data.carryoverTicketsByDuration,console.log("[TASK-070] Preloaded carryoverTicketsByDuration for previous week:",ve.data.carryoverTicketsByDuration.length,"categories")),ve.data.responsibleCreatedThisWeek){const Se=Array.isArray(ve.data.responsibleCreatedThisWeek)?ve.data.responsibleCreatedThisWeek:Object.values(ve.data.responsibleCreatedThisWeek);p.value.previousWeek.responsibleCreatedThisWeek=Se,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for previous week:",Se.length,"employees")}if(ve.data.responsibleCreatedOtherWeek){const Se=Array.isArray(ve.data.responsibleCreatedOtherWeek)?ve.data.responsibleCreatedOtherWeek:Object.values(ve.data.responsibleCreatedOtherWeek);p.value.previousWeek.responsibleCreatedOtherWeek=Se,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for previous week:",Se.length,"employees")}}).catch(ve=>{console.warn("[TASK-070] Failed to preload previous week data (non-critical):",ve)})}}catch(O){console.error("[DEBUG] API call failed:",O),i.value=O instanceof Error?O:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureDashboard] loadData error:",O)}finally{console.log("[DEBUG] Finally block: setting isLoading to false"),r.value=!1,console.log("[DEBUG] isLoading after:",r.value)}}function R(b){if(!b||!n.value)return console.log("[TASK-070] getPreloadedStagesData: Missing weekMeta or chartMeta"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,de=O.length>=2?O[O.length-2].weekNumber:null;console.log("[TASK-070] getPreloadedStagesData:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:de,weeksInMeta:O.length});const ke=b.weekNumber===Q,_e=b.weekNumber===de;let K=null;if(ke)K=p.value.currentWeek.newTicketsByStages,console.log("[TASK-070] Requested week is current week, checking currentWeek data:",K?`Array(${K.length})`:"null");else if(_e)K=p.value.previousWeek.newTicketsByStages,console.log("[TASK-070] Requested week is previous week, checking previousWeek data:",K?`Array(${K.length})`:"null");else return console.log("[TASK-070] Requested week",b.weekNumber,"is neither current nor previous, no preloaded data available"),null;return Array.isArray(K)&&K.length>0?(console.log("[TASK-070] Using preloaded stages data for week",b.weekNumber,":",K.length,"stages"),K):(console.log("[TASK-070] No preloaded stages data for week",b.weekNumber,", will use API fallback"),null)}function W(b){if(!b)return null;const O=p.value.weeks.get(b.weekNumber);if(O?.carryoverTicketsByDuration&&Array.isArray(O.carryoverTicketsByDuration))return console.log("[PERF-OPTIMIZATION] Using preloaded carryover data for week",b.weekNumber,":",O.carryoverTicketsByDuration.length,"categories"),O.carryoverTicketsByDuration;const Q=n.value?.weeks||[],de=Q.length>0?Q[Q.length-1].weekNumber:n.value.weekNumber,_e=b.weekNumber===de?p.value.currentWeek.carryoverTicketsByDuration:p.value.previousWeek.carryoverTicketsByDuration;return Array.isArray(_e)&&_e.length>0?(console.log("[TASK-070] Using fallback preloaded carryover data for week",b.weekNumber,":",_e.length,"categories"),_e):(console.log("[PERF-ISSUE] No preloaded carryover data for week",b.weekNumber,", will use slow API fallback"),null)}async function G(b){if(!(!b||b.length===0)){console.log("[PERF-OPTIMIZATION] Starting background preload for",b.length,"weeks");for(const O of b)try{await new Promise(ke=>setTimeout(ke,500)),console.log("[PERF-OPTIMIZATION] Preloading data for week",O.weekNumber);const Q=await t({product:"1C",periodMode:"weeks",weekStartUtc:O.weekStartUtc,weekEndUtc:O.weekEndUtc,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!1}),de={newTicketsByStages:Q.data.newTicketsByStages||null,carryoverTicketsByDuration:Q.data.carryoverTicketsByDuration||null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:O};p.value.weeks.set(O.weekNumber,de),console.log("[PERF-OPTIMIZATION] Successfully preloaded data for week",O.weekNumber)}catch(Q){console.warn("[PERF-OPTIMIZATION] Failed to preload data for week",O.weekNumber,":",Q)}console.log("[PERF-OPTIMIZATION] Background preload completed")}}function q(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber;return b.weekNumber===Q&&l.value.responsible||null}function oe(b){if(!b){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedThisWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,de=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===de;if(console.log("[TASK-070] getResponsibleCreatedThisWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:de,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=p.value.previousWeek.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedThisWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function Y(b){if(!b){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedOtherWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,de=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===de;if(console.log("[TASK-070] getResponsibleCreatedOtherWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:de,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=p.value.previousWeek.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedOtherWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function H(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,de=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===de;return ke?l.value.closedTicketsCreatedThisWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===de)?.closedTicketsCreatedThisWeek??null:null}function Z(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,de=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===de;return ke?l.value.closedTicketsCreatedOtherWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===de)?.closedTicketsCreatedOtherWeek??null:null}function fe(b){x.value.stages=b}function P(b){x.value.employees=b}function h(b){x.value.dateRange=b}function w(b){x.value.customDateRange=b}function B(b){if(!["weeks","months"].includes(b)){console.warn("[GraphAdmissionClosureDashboard] Invalid periodMode:",b);return}b!==D.value&&(D.value=b,b==="weeks"?L():b==="months"&&(r.value=!1))}function re(b){const{mode:O}=b.detail;["weeks","months"].includes(O)&&B(O)}function le(){x.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},se()}function se(){D.value==="weeks"&&L()}function me(b){["weeks","months"].includes(b)&&(D.value=b)}function De(){console.log("[DEBUG] handleCloseModal called"),console.log("[DEBUG] showPeriodModeInfo before:",C.value),console.log("[DEBUG] isLoading before:",r.value),console.log("[DEBUG] periodMode:",D.value),C.value=!1,r.value=!0,console.log("[DEBUG] showPeriodModeInfo after:",C.value),console.log("[DEBUG] isLoading after:",r.value),Wt(()=>{console.log("[DEBUG] handleCloseModal: calling handleStartLoading in nextTick"),Ie()})}function Ie(){console.log("[DEBUG] handleStartLoading called"),console.log("[DEBUG] periodMode before check:",D.value),console.log("[DEBUG] showPeriodModeInfo:",C.value),console.log("[DEBUG] isLoading:",r.value),(!D.value||!["weeks","months"].includes(D.value))&&(console.warn('[GraphAdmissionClosureDashboard] Period mode not set, using default "weeks"'),D.value="weeks"),console.log("[GraphAdmissionClosureDashboard] Starting loading, periodMode:",D.value),Wt(()=>{console.log("[DEBUG] nextTick callback, periodMode:",D.value),console.log("[DEBUG] isLoading in nextTick:",r.value),D.value==="weeks"?(console.log("[GraphAdmissionClosureDashboard] Loading data for weeks mode"),L()):D.value==="months"&&(console.log("[GraphAdmissionClosureDashboard] Months mode - data will be loaded by GraphAdmissionClosureMonthsDashboard"),r.value=!1,console.log("[DEBUG] Reset parent isLoading to false for months mode"))})}function xe(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},g.value=!0}function He(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},d.value=!0}function z(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},v.value=!0}$e(()=>{try{const b="graph-admission-closure-period-mode-info-shown";localStorage.getItem(b)&&localStorage.removeItem(b);const O="graph-admission-closure-period-mode";localStorage.getItem(O)&&localStorage.removeItem(O)}catch(b){console.warn("[GraphAdmissionClosureDashboard] Failed to clean localStorage:",b)}window.addEventListener("period-mode-change",re)}),at(()=>{window.removeEventListener("period-mode-change",re)});function N(){const b=new Date,O=new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate())),Q=O.getUTCDay(),de=O.getUTCDate()-Q+(Q===0?-6:1),ke=new Date(Date.UTC(O.getUTCFullYear(),O.getUTCMonth(),de,0,0,0)),_e=new Date(ke);return _e.setUTCDate(_e.getUTCDate()+6),_e.setUTCHours(23,59,59,999),{weekStartUtc:ke.toISOString(),weekEndUtc:_e.toISOString()}}return(b,O)=>{const Q=be("router-link");return c(),u("div",Bk,[ne(Ae,{name:"fade",mode:"out-in"},{default:ye(()=>[r.value?(c(),u("div",Uk,[s("div",Wk,[O[3]||(O[3]=s("div",{class:"preloader-spinner"},[s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"})],-1)),O[4]||(O[4]=s("h3",{class:"preloader-title"},"Загрузка графика",-1)),s("p",Fk," Получение данных за "+m(D.value==="weeks"?"4 недели":"3 месяца")+"... ",1),O[5]||(O[5]=s("div",{class:"preloader-dots"},[s("span",{class:"dot"}),s("span",{class:"dot"}),s("span",{class:"dot"})],-1))])])):!C.value&&!r.value?(c(),u("div",Hk,[D.value==="months"?(c(),he(Gv,{key:0})):(c(),u("div",jk,[s("div",Vk,[s("div",zk,[s("div",Gk,[s("button",{class:"btn-home-link",type:"button",onClick:U,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),O[11]||(O[11]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),s("button",{class:"btn-back-link",type:"button",onClick:A,"aria-label":k.value,"aria-disabled":!T.value,"data-fallback":!T.value,disabled:S.value,title:"Назад"}," ← ",8,Kk),s("nav",qk,[ne(Q,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:ye(()=>[...O[6]||(O[6]=[ge(" Дашборд сектора 1С ",-1)])]),_:1}),O[8]||(O[8]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(Q,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:ye(()=>[...O[7]||(O[7]=[ge(" График состояния ",-1)])]),_:1}),O[9]||(O[9]=s("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),O[10]||(O[10]=s("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),O[12]||(O[12]=s("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),O[13]||(O[13]=s("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),s("div",Yk,[s("div",Xk,[ne(ja,{stages:x.value.stages,employees:x.value.employees,dateRange:x.value.dateRange,customDateRange:x.value.customDateRange,hasActiveFilters:E.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":D.value,"onUpdate:stages":fe,"onUpdate:employees":P,"onUpdate:dateRange":h,"onUpdate:customDateRange":w,"onUpdate:periodMode":B,onReset:le,onApply:se},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","period-mode"])]),s("div",Jk,[i.value?(c(),he(ba,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),he(nf,{key:1,meta:n.value,data:l.value,onOpenResponsible:He,onOpenStages:xe,onOpenCarryover:z},null,8,["meta","data"]))])])]))])):$("",!0)]),_:1}),ne(Dy,{"is-visible":d.value,responsible:q(f.value)||l.value.responsible||[],"closed-tickets-created-this-week":H(f.value)??l.value.closedTicketsCreatedThisWeek??0,"closed-tickets-created-other-week":Z(f.value)??l.value.closedTicketsCreatedOtherWeek??0,"responsible-created-this-week":oe(f.value)||l.value.responsibleCreatedThisWeek||[],"responsible-created-other-week":Y(f.value)||l.value.responsibleCreatedOtherWeek||[],"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,onClose:O[0]||(O[0]=de=>{d.value=!1,f.value.value=null})},null,8,["is-visible","responsible","closed-tickets-created-this-week","closed-tickets-created-other-week","responsible-created-this-week","responsible-created-other-week","week-number","week-start-utc","week-end-utc"]),ne(sk,{"is-visible":g.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":R(f.value),onClose:O[1]||(O[1]=de=>{g.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),ne(Ok,{"is-visible":v.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":W(f.value),onClose:O[2]||(O[2]=de=>{v.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),C.value?(c(),he(tm,{key:0,"is-visible":C.value,"current-mode":D.value,onClose:De,onSelectMode:me},null,8,["is-visible","current-mode"])):$("",!0)])}}},Rs=ce(Zk,[["__scopeId","data-v-2fa9296d"]]),Qk=Object.freeze(Object.defineProperty({__proto__:null,default:Rs},Symbol.toStringTag,{value:"Module"})),e0={name:"ZeroPoint",components:{TicketCard:Ct},props:{tickets:{type:Array,required:!0,default:()=>[]},stageId:{type:String,required:!0}},emits:{"ticket-dragged":o=>typeof o=="object"&&o!==null,"ticket-assigned":o=>typeof o=="object"&&o!==null,"ticket-clicked":o=>typeof o=="object"&&o!==null},setup(o,{emit:e}){return{hasTickets:I(()=>Array.isArray(o.tickets)&&o.tickets.length>0),handleTicketDragStart:r=>{e("ticket-dragged",r)}}}},t0={class:"zero-point"},a0={key:0,class:"empty-state"};function s0(o,e,a,t,r,i){const n=be("TicketCard");return c(),u("div",t0,[e[3]||(e[3]=s("div",{class:"zero-point-header"},[s("h3",null,"Нулевая точка")],-1)),la([a.tickets.length,a.tickets.map(l=>l.id).join(",")],()=>(c(),u("div",{class:"zero-point-tickets"},[(c(!0),u(ee,null,te(a.tickets,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onDragStart:d=>t.handleTicketDragStart(l),onClick:d=>o.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128))])),e,0),e[1]||(Xa(-1,!0),(e[1]=t.hasTickets?$("",!0):(c(),u("div",a0,[...e[2]||(e[2]=[s("p",null,"Нет неразобранных тикетов в стадии",-1)])]))).cacheIndex=1,Xa(1),e[1])])}const o0=ce(e0,[["render",s0],["__scopeId","data-v-c5370e55"]]);function n0(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Bs(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Us(o){return typeof o=="string"&&["formed","review","execution"].includes(o)}function r0(o){return!o||typeof o!="object"?!1:n0(o.id)&&typeof o.title=="string"&&o.title.trim().length>0}function Ws(o,e,a){return!(!r0(o)||!Bs(e)||!Us(a)||o.assigneeId===e&&o.stageId===a)}function i0(o){const e=[];return!o||typeof o!="object"?(e.push("Данные тикета должны быть объектом"),{valid:!1,errors:e}):((!o.title||typeof o.title!="string"||o.title.trim().length===0)&&e.push("Название тикета обязательно"),o.stageId&&!Us(o.stageId)&&e.push("Некорректный ID стадии"),o.employeeId&&!Bs(o.employeeId)&&e.push("Некорректный ID сотрудника"),{valid:e.length===0,errors:e})}function l0(o){const e=mt(),a=M(!1);return{isDropZoneActive:a,handleDragStart:(d,g)=>{d.dataTransfer.effectAllowed="move",d.dataTransfer.setData("application/json",JSON.stringify(g)),d.dataTransfer.setDragImage(d.target,0,0)},handleDragOver:d=>{d.preventDefault(),d.dataTransfer.dropEffect="move",a.value=!0},handleDragLeave:d=>{const g=d.currentTarget.getBoundingClientRect(),v=d.clientX,C=d.clientY;(v<g.left||v>g.right||C<g.top||C>g.bottom)&&(a.value=!1)},handleDrop:async(d,g,v)=>{d.preventDefault(),a.value=!1;const C=d.dataTransfer.getData("application/json");if(C)try{const f=JSON.parse(C);if(!Ws(f,g,v)){e.warning("Нельзя переместить тикет сюда");return}o&&typeof o=="function"&&await o(f,g,v)}catch(f){Ee.error("Error parsing ticket data","useDragAndDrop",f),e.error("Ошибка обработки данных тикета")}},handleDragEnd:d=>{a.value=!1}}}function Fs(o=null){const e=ro(),a=e?.type?.name||e?.type?.__name||null,t=o||a||"Unknown",r=(g,v,C=null)=>{Ee.log(g,v,t,C)};return{error:(g,v=null)=>{r("ERROR",g,v)},warn:(g,v=null)=>{r("WARN",g,v)},info:(g,v=null)=>{r("INFO",g,v)},debug:(g,v=null)=>{r("DEBUG",g,v)},log:r,context:t}}const c0={name:"EmployeeColumn",components:{TicketCard:Ct},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(o,{emit:e}){Fs("EmployeeColumn");const t=l0(async(v,C,f)=>{e("ticket-dropped",v,C)}),r=I(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:Array.isArray(o.employee.ticketsInsideSector)?o.employee.ticketsInsideSector:[]),i=I(()=>o.employee.isFromSector1C?[]:Array.isArray(o.employee.ticketsOutsideSector)?o.employee.ticketsOutsideSector:Array.isArray(o.employee.tickets)?o.employee.tickets:[]),n=I(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:[]),l=I(()=>r.value.length+i.value.length),d=v=>{t.handleDrop(v,o.employee.id,o.stageId)},g=v=>{};return{isDropZoneActive:t.isDropZoneActive,handleDragOver:t.handleDragOver,handleDragLeave:t.handleDragLeave,handleDrop:d,ticketsInsideSector:r,ticketsOutsideSector:i,ticketsToDisplay:n,totalTicketsCount:l,handleTicketDragStart:g}}},d0={class:"employee-header"},u0={class:"employee-info"},g0={class:"employee-details"},m0={class:"employee-name"},h0={key:0,class:"employee-position"},f0={class:"tickets-count"},v0={class:"tickets-list"},p0={class:"section-header"},y0={class:"section-count"},k0={key:2,class:"empty-state"};function b0(o,e,a,t,r,i){const n=be("TicketCard");return c(),u("div",{class:X(["employee-column",{"drop-zone-active":t.isDropZoneActive}]),onDragover:e[3]||(e[3]=Te((...l)=>t.handleDragOver&&t.handleDragOver(...l),["prevent"])),onDragleave:e[4]||(e[4]=(...l)=>t.handleDragLeave&&t.handleDragLeave(...l)),onDrop:e[5]||(e[5]=(...l)=>t.handleDrop&&t.handleDrop(...l))},[s("div",d0,[s("div",u0,[e[6]||(e[6]=s("span",{class:"employee-icon"},"👤",-1)),s("div",g0,[s("div",m0,m(a.employee.name),1),a.employee.position?(c(),u("div",h0,m(a.employee.position),1)):$("",!0)])]),s("div",f0," 📊 Тикетов: "+m(t.totalTicketsCount),1)]),s("div",v0,[a.employee.isFromSector1C?la([t.ticketsToDisplay.length,t.ticketsToDisplay.map(l=>l.id).join(",")],()=>(c(),u("div",{key:0},[ne(Qe,{name:"ticket",tag:"div"},{default:ye(()=>[(c(!0),u(ee,null,te(t.ticketsToDisplay,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,0):(c(),u(ee,{key:1},[t.ticketsInsideSector.length>0?la([t.ticketsInsideSector.length,t.ticketsInsideSector.map(l=>l.id).join(",")],()=>(c(),u("div",{key:0,class:"tickets-section tickets-inside-sector"},[ne(Qe,{name:"ticket",tag:"div"},{default:ye(()=>[(c(!0),u(ee,null,te(t.ticketsInsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,1):$("",!0),t.ticketsOutsideSector.length>0?la([t.ticketsOutsideSector.length,t.ticketsOutsideSector.map(l=>l.id).join(",")],()=>(c(),u("div",{key:1,class:"tickets-section tickets-outside-sector"},[s("div",p0,[e[7]||(e[7]=s("span",{class:"section-badge"},"Вне сектора",-1)),s("span",y0,m(t.ticketsOutsideSector.length),1)]),ne(Qe,{name:"ticket",tag:"div"},{default:ye(()=>[(c(!0),u(ee,null,te(t.ticketsOutsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:d=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,2):$("",!0)],64)),t.totalTicketsCount===0?(c(),u("div",k0,[...e[8]||(e[8]=[s("p",null,"Нет тикетов",-1)])])):$("",!0)])],34)}const _0=ce(c0,[["render",b0],["__scopeId","data-v-cdec5b5c"]]),w0={name:"DashboardStage",components:{ZeroPoint:o0,EmployeeColumn:_0},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(o,{emit:e}){const a=Fs("DashboardStage"),t=M(!1),r=I(()=>{const f=Array.isArray(o.zeroPointTickets)?o.zeroPointTickets.length:0,p=Array.isArray(o.stage.employees)?o.stage.employees.reduce((y,S)=>Array.isArray(S.ticketsInsideSector)?y+S.ticketsInsideSector.length:S.isFromSector1C&&Array.isArray(S.tickets)?y+S.tickets.length:y,0):0;return f+p}),i=I(()=>Array.isArray(o.stage.employees)?o.stage.employees.reduce((f,p)=>Array.isArray(p.ticketsOutsideSector)?f+p.ticketsOutsideSector.length:!p.isFromSector1C&&Array.isArray(p.tickets)?f+p.tickets.length:f,0):0),n=I(()=>r.value+i.value),l=I(()=>{const f=o.stage?.name||"Стадия",p=r.value,y=i.value;return y===0?`${f} (${p})`:`${f} (${p} / ${y})`});return{isDragging:t,ticketsCountInsideSector:r,ticketsCountOutsideSector:i,totalTicketsCount:n,stageNameWithCount:l,handleTicketDragged:f=>{t.value=!0},handleTicketAssigned:(f,p)=>{e("ticket-assigned",f,p)},handleTicketDropped:(f,p)=>{e("ticket-moved",f,p,o.stage.id),t.value=!1},handleTicketClicked:f=>{a.debug("Ticket clicked",f),e("ticket-clicked",f)}}}},C0={class:"stage-header"},T0={class:"stage-content"},S0={class:"employees-container"};function D0(o,e,a,t,r,i){const n=be("ZeroPoint"),l=be("EmployeeColumn");return c(),u("div",{class:"dashboard-stage",style:we({borderLeftColor:a.stage.color})},[s("div",C0,[s("h2",null,m(t.stageNameWithCount),1)]),s("div",T0,[ne(n,{tickets:a.zeroPointTickets,"stage-id":a.stage.id,onTicketDragged:t.handleTicketDragged,onTicketAssigned:t.handleTicketAssigned,onTicketClicked:t.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),s("div",S0,[(c(!0),u(ee,null,te(a.stage.employees,d=>(c(),he(l,{key:d.id,employee:d,"stage-id":a.stage.id,onTicketClicked:t.handleTicketClicked,onTicketDropped:t.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const E0=ce(w0,[["render",D0],["__scopeId","data-v-c6fbde76"]]),$a={cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},A0={loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},$0={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(o,{emit:e}){const a=I(()=>{const{currentStep:g,stepDetails:v}=o;return v?.description?{title:g?$a[g]?.title||g:"Загрузка...",description:v.description}:g?$a[g]?$a[g]:A0[g]||{title:"Загрузка...",description:"Пожалуйста, подождите..."}:{title:"Загрузка...",description:"Инициализация..."}}),t=I(()=>a.value.title),r=I(()=>a.value.description),i=I(()=>o.stepDetails),n=I(()=>{const g=o.progress;return g==null||isNaN(g)?0:Math.round(Math.max(0,Math.min(100,g)))});return{stepTitle:t,stepDescription:r,details:i,displayProgress:n,getStageDisplayName:g=>g?{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение","Сформировано обращение":"Сформировано обращение","Рассмотрение ТЗ":"Рассмотрение ТЗ",Исполнение:"Исполнение"}[g]||g:"",handleRetry:()=>{e("retry")}}}},I0={class:"preloader-backdrop"},M0={class:"preloader-container"},N0={class:"preloader-content-scrollable"},x0={key:0,class:"spinner-container"},L0={class:"preloader-content"},P0={class:"step-title"},O0={key:0,class:"step-description"},R0={key:1,class:"progress-container"},B0={class:"progress-bar"},U0={class:"progress-text"},W0={key:2,class:"step-details"},F0={key:0,class:"detail-description"},H0={key:1,class:"detail-item"},j0={class:"detail-value"},V0={key:0,class:"detail-total"},z0={key:2,class:"detail-item"},G0={class:"detail-value"},K0={key:0,class:"detail-total"},q0={key:3,class:"detail-item"},Y0={class:"detail-value"},X0={key:0,class:"detail-total"},J0={key:4,class:"detail-item"},Z0={class:"detail-value"},Q0={key:5,class:"detail-warning"},e1={key:0,class:"error-container"},t1={class:"error-content"},a1={class:"error-message"};function s1(o,e,a,t,r,i){return c(),u("div",{class:X(["loading-preloader",{"has-error":a.error}])},[s("div",I0,[s("div",M0,[s("div",N0,[a.error?$("",!0):(c(),u("div",x0,[...e[1]||(e[1]=[s("div",{class:"spinner"},null,-1)])])),s("div",L0,[s("h3",P0,m(t.stepTitle),1),t.stepDescription?(c(),u("p",O0,m(t.stepDescription),1)):$("",!0),a.error?$("",!0):(c(),u("div",R0,[s("div",B0,[s("div",{class:"progress-fill",style:we({width:t.displayProgress+"%"})},null,4)]),s("span",U0,m(t.displayProgress)+"%",1)])),a.error?$("",!0):(c(),u("div",W0,[t.details.description?(c(),u("div",F0,m(t.details.description),1)):$("",!0),t.details.count!==void 0?(c(),u("div",H0,[e[2]||(e[2]=s("span",{class:"detail-label"},"Загружено тикетов:",-1)),s("span",j0,m(t.details.count),1),t.details.total!==void 0?(c(),u("span",V0," из "+m(t.details.total),1)):$("",!0)])):$("",!0),t.details.filteredTickets!==void 0?(c(),u("div",z0,[e[3]||(e[3]=s("span",{class:"detail-label"},"Отфильтровано тикетов:",-1)),s("span",G0,m(t.details.filteredTickets),1),t.details.totalTickets!==void 0?(c(),u("span",K0," из "+m(t.details.totalTickets),1)):$("",!0)])):$("",!0),t.details.stage?(c(),u("div",q0,[e[4]||(e[4]=s("span",{class:"detail-label"},"Стадия:",-1)),s("span",Y0,m(t.getStageDisplayName(t.details.stage)),1),t.details.stageIndex&&t.details.totalStages?(c(),u("span",X0," ("+m(t.details.stageIndex)+"/"+m(t.details.totalStages)+") ",1)):$("",!0)])):$("",!0),t.details.employeeCount!==void 0?(c(),u("div",J0,[e[5]||(e[5]=s("span",{class:"detail-label"},"Сотрудников:",-1)),s("span",Z0,m(t.details.employeeCount),1)])):$("",!0),t.details.warning?(c(),u("div",Q0,[s("span",null,"⚠️ "+m(t.details.warning),1)])):$("",!0)]))])])])]),a.error?(c(),u("div",e1,[s("div",t1,[e[6]||(e[6]=s("div",{class:"error-icon"},"⚠️",-1)),s("p",a1,m(a.error),1),s("button",{onClick:e[0]||(e[0]=(...n)=>t.handleRetry&&t.handleRetry(...n)),class:"retry-button"}," Повторить попытку ")])])):$("",!0)],2)}const o1=ce($0,[["render",s1],["__scopeId","data-v-d129ff19"]]),n1={name:"LoggerControl",props:{showControl:{type:Boolean,default:!1}},setup(){const o=M(!1),e=M("ERROR"),a=M(!0),t=d=>({NONE:"Отключено",ERROR:"Только ошибки",WARN:"Предупреждения и ошибки",INFO:"Информация, предупреждения и ошибки",DEBUG:"Все логи (отладка)"})[d]||d;return $e(()=>{const d=Mt.getLevel();e.value=d,o.value=d!=="NONE"}),{enabled:o,level:e,isExpanded:a,getLevelDescription:t,handleToggle:()=>{o.value?(e.value==="NONE"&&(e.value="ERROR"),Mt.setLevel(e.value)):(Mt.setLevel("NONE"),e.value="NONE")},handleLevelChange:()=>{o.value&&Mt.setLevel(e.value)},resetToDefault:()=>{const d="ERROR";e.value=d,o.value=!0,Mt.setLevel(d)},toggleVisibility:()=>{a.value=!a.value}}}},r1={key:0,class:"logger-control"},i1={class:"logger-control-header"},l1=["aria-label"],c1={key:0,class:"logger-control-content"},d1={class:"logger-control-section"},u1={class:"logger-control-label"},g1={key:0,class:"logger-control-section"},m1={class:"logger-control-label"},h1={key:1,class:"logger-control-info"},f1={class:"logger-control-info-text"},v1={key:2,class:"logger-control-section"};function p1(o,e,a,t,r,i){return a.showControl?(c(),u("div",r1,[s("div",i1,[e[6]||(e[6]=s("h3",{class:"logger-control-title"},"Управление логированием",-1)),s("button",{class:"logger-control-toggle",onClick:e[0]||(e[0]=(...n)=>t.toggleVisibility&&t.toggleVisibility(...n)),"aria-label":t.isExpanded?"Свернуть":"Развернуть"},m(t.isExpanded?"▼":"▶"),9,l1)]),t.isExpanded?(c(),u("div",c1,[s("div",d1,[s("label",u1,[Re(s("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=n=>t.enabled=n),onChange:e[2]||(e[2]=(...n)=>t.handleToggle&&t.handleToggle(...n)),class:"logger-control-checkbox"},null,544),[[ka,t.enabled]]),e[7]||(e[7]=s("span",{class:"logger-control-label-text"},"Включить логирование",-1))])]),t.enabled?(c(),u("div",g1,[s("label",m1,[e[9]||(e[9]=s("span",{class:"logger-control-label-text"},"Уровень логирования:",-1)),Re(s("select",{"onUpdate:modelValue":e[3]||(e[3]=n=>t.level=n),onChange:e[4]||(e[4]=(...n)=>t.handleLevelChange&&t.handleLevelChange(...n)),class:"logger-control-select"},[...e[8]||(e[8]=[_t('<option value="NONE" data-v-ed57067c>Отключено</option><option value="ERROR" data-v-ed57067c>Только ошибки</option><option value="WARN" data-v-ed57067c>Предупреждения и ошибки</option><option value="INFO" data-v-ed57067c>Информация, предупреждения и ошибки</option><option value="DEBUG" data-v-ed57067c>Все логи (отладка)</option>',5)])],544),[[dt,t.level]])])])):$("",!0),t.enabled?(c(),u("div",h1,[s("span",f1,[e[10]||(e[10]=ge(" Текущий уровень: ",-1)),s("strong",null,m(t.getLevelDescription(t.level)),1)])])):$("",!0),t.enabled?(c(),u("div",v1,[s("button",{onClick:e[5]||(e[5]=(...n)=>t.resetToDefault&&t.resetToDefault(...n)),class:"logger-control-reset-btn",title:"Сбросить к значению по умолчанию"}," Сбросить к умолчанию ")])):$("",!0)])):$("",!0)])):$("",!0)}const y1=ce(n1,[["render",p1],["__scopeId","data-v-ed57067c"]]),k1={name:"DiagnosticsPanel",props:{isEnabled:{type:Boolean,default:!1},isUserAdmin:{type:Boolean,default:!1}},setup(o){const e=M(!0),a=tt(),t=I(()=>!o.isEnabled||!o.isUserAdmin?{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}:a?a.getMetrics():(console.warn("[DiagnosticsPanel] Diagnostics service not available"),{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}})),r=I(()=>!o.isEnabled||!o.isUserAdmin||!a?{withoutAssignedById:[],withAssignedById1051:[],withoutSectorTag:[],notInColumn:[],unknownStage:[]}:a.getProblematicTickets()),i=I(()=>{const g=r.value;return g.withoutAssignedById.length===0&&g.withAssignedById1051.length===0&&g.withoutSectorTag.length===0&&g.notInColumn.length===0&&g.unknownStage.length===0});return{isExpanded:e,metrics:t,problematicTickets:r,hasNoProblems:i,toggleExpanded:()=>{e.value=!e.value},downloadJSON:()=>{if(!a)return;const g=a.exportToJSON(),v=new Blob([g],{type:"application/json"}),C=URL.createObjectURL(v),f=document.createElement("a");f.href=C,f.download=`dashboard-diagnostics-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(C)},getStageName:g=>Lt.getStageName(g)||g}}},b1={key:0,class:"diagnostics-panel"},_1={class:"diagnostics-header"},w1={class:"header-actions"},C1=["title"],T1={key:0,class:"diagnostics-content"},S1={class:"diagnostics-section"},D1={class:"metrics-grid"},E1={class:"metric-card"},A1={class:"metric-value"},$1={class:"metric-label"},I1={class:"metric-value"},M1={class:"metric-detail"},N1={class:"diagnostics-section"},x1={class:"metrics-grid"},L1={class:"metric-card"},P1={class:"metric-value"},O1={class:"metric-card",style:{"border-left-color":"#28a745"}},R1={class:"metric-value"},B1={class:"metric-card",style:{"border-left-color":"#dc3545"}},U1={class:"metric-value"},W1={key:0,class:"metric-detail"},F1={key:0,class:"warning-box"},H1={key:1,class:"examples-box"},j1={class:"example-type"},V1={key:0,class:"normalized"},z1={class:"diagnostics-section"},G1={class:"metrics-grid"},K1={class:"metric-card"},q1={class:"metric-value"},Y1={class:"metric-card"},X1={class:"metric-value"},J1={class:"metric-card"},Z1={class:"metric-value"},Q1={class:"diagnostics-section"},eb={class:"metrics-grid"},tb={class:"metric-card"},ab={class:"metric-value"},sb={class:"metric-card",style:{"border-left-color":"#28a745"}},ob={class:"metric-value"},nb={class:"metric-card",style:{"border-left-color":"#ffc107"}},rb={class:"metric-value"},ib={key:0,class:"employees-list"},lb={class:"diagnostics-section"},cb={class:"metrics-grid"},db={class:"metric-label"},ub={class:"metric-value"},gb={class:"diagnostics-section problematic-tickets"},mb={key:0,class:"problem-group"},hb={class:"tickets-list"},fb={class:"ticket-id"},vb={class:"ticket-title"},pb={class:"ticket-stage"},yb={key:0,class:"more-items"},kb={key:1,class:"problem-group"},bb={class:"tickets-list"},_b={class:"ticket-id"},wb={class:"ticket-title"},Cb={class:"ticket-stage"},Tb={key:0,class:"more-items"},Sb={key:2,class:"problem-group"},Db={class:"tickets-list"},Eb={class:"ticket-id"},Ab={class:"ticket-title"},$b={class:"ticket-stage"},Ib={key:0,class:"more-items"},Mb={key:3,class:"problem-group"},Nb={class:"tickets-list"},xb={class:"ticket-id"},Lb={class:"ticket-title"},Pb={class:"ticket-stage"},Ob={key:0,class:"more-items"},Rb={key:4,class:"problem-group"},Bb={class:"tickets-list"},Ub={class:"ticket-id"},Wb={class:"ticket-title"},Fb={class:"ticket-stage"},Hb={key:0,class:"more-items"},jb={key:5,class:"no-problems"};function Vb(o,e,a,t,r,i){return a.isEnabled&&a.isUserAdmin?(c(),u("div",b1,[s("div",_1,[e[2]||(e[2]=s("h2",null,"🔍 Диагностика дашборда",-1)),s("div",w1,[s("button",{onClick:e[0]||(e[0]=(...n)=>t.downloadJSON&&t.downloadJSON(...n)),class:"btn-download",title:"Скачать JSON"}," 📥 Скачать JSON "),s("button",{onClick:e[1]||(e[1]=(...n)=>t.toggleExpanded&&t.toggleExpanded(...n)),class:"btn-toggle",title:t.isExpanded?"Свернуть":"Развернуть"},m(t.isExpanded?"▼":"▶"),9,C1)])]),t.isExpanded?(c(),u("div",T1,[s("section",S1,[e[4]||(e[4]=s("h3",null,"📊 Загрузка тикетов",-1)),s("div",D1,[s("div",E1,[e[3]||(e[3]=s("div",{class:"metric-label"},"Всего загружено",-1)),s("div",A1,m(t.metrics.ticketsLoading.totalLoaded),1)]),(c(!0),u(ee,null,te(t.metrics.ticketsLoading.stages,(n,l)=>(c(),u("div",{key:l,class:"metric-card"},[s("div",$1,m(t.getStageName(l)),1),s("div",I1,m(n.total),1),s("div",M1,"Батчей: "+m(n.batches.length),1)]))),128))])]),s("section",N1,[e[10]||(e[10]=s("h3",null,"🔍 Фильтрация по сектору 1С",-1)),s("div",x1,[s("div",L1,[e[5]||(e[5]=s("div",{class:"metric-label"},"Всего тикетов загружено",-1)),s("div",P1,m(t.metrics.filtering.total),1)]),s("div",O1,[e[6]||(e[6]=s("div",{class:"metric-label"},"Прошло фильтр (тег 1С)",-1)),s("div",R1,m(t.metrics.filtering.filtered),1)]),s("div",B1,[e[7]||(e[7]=s("div",{class:"metric-label"},"Отклонено (нет тега 1С)",-1)),s("div",U1,m(t.metrics.filtering.rejected.length),1),t.metrics.filtering.total>0?(c(),u("div",W1,m(Math.round(t.metrics.filtering.rejected.length/t.metrics.filtering.total*100))+"% от всех ",1)):$("",!0)])]),t.metrics.filtering.rejected.length>0?(c(),u("div",F1,[e[8]||(e[8]=s("strong",null,"⚠️ Внимание:",-1)),ge(" "+m(t.metrics.filtering.rejected.length)+" тикетов не имеют тега сектора 1С (UF_CRM_7_TYPE_PRODUCT = '1C') и поэтому не отображаются в дашборде. Эти тикеты есть в Bitrix24, но не попали в интерфейс. ",1)])):$("",!0),t.metrics.filtering.tagValueExamples.length>0?(c(),u("div",H1,[e[9]||(e[9]=s("h4",null,"Примеры значений UF_CRM_7_TYPE_PRODUCT:",-1)),s("ul",null,[(c(!0),u(ee,null,te(t.metrics.filtering.tagValueExamples.slice(0,10),(n,l)=>(c(),u("li",{key:l},[s("code",null,m(JSON.stringify(n.value)),1),s("span",j1,"("+m(n.type)+m(n.isArray?", массив":"")+")",1),n.normalized&&n.normalized.length?(c(),u("span",V1," → нормализовано: "+m(n.normalized.join(", ")),1)):$("",!0)]))),128))])])):$("",!0)]),s("section",z1,[e[14]||(e[14]=s("h3",null,"👥 Сотрудники",-1)),s("div",G1,[s("div",K1,[e[11]||(e[11]=s("div",{class:"metric-label"},"Уникальных ID",-1)),s("div",q1,m(t.metrics.employees.totalUnique),1)]),s("div",Y1,[e[12]||(e[12]=s("div",{class:"metric-label"},"Без assignedById",-1)),s("div",X1,m(t.metrics.employees.ticketsWithoutAssignedById.length),1)]),s("div",J1,[e[13]||(e[13]=s("div",{class:"metric-label"},"С assignedById=1051",-1)),s("div",Z1,m(t.metrics.employees.ticketsWithAssignedById1051.length),1)])])]),s("section",Q1,[e[18]||(e[18]=s("h3",null,"📦 Группировка по стадиям",-1)),(c(!0),u(ee,null,te(t.metrics.grouping.distributionByStages,(n,l)=>(c(),u("div",{key:l,class:"stage-distribution"},[s("h4",null,m(t.getStageName(l)),1),s("div",eb,[s("div",tb,[e[15]||(e[15]=s("div",{class:"metric-label"},"Всего тикетов в стадии",-1)),s("div",ab,m(n.total||0),1)]),s("div",sb,[e[16]||(e[16]=s("div",{class:"metric-label"},"Внутри сектора 1С",-1)),s("div",ob,m(n.insideSector||0),1)]),s("div",nb,[e[17]||(e[17]=s("div",{class:"metric-label"},"Вне сектора 1С",-1)),s("div",rb,m(n.outsideSector||0),1)])]),Object.keys(n.employees||{}).length>0?(c(),u("div",ib,[(c(!0),u(ee,null,te(n.employees,(d,g)=>(c(),u("div",{key:g,class:"employee-item"}," Сотрудник #"+m(g)+": "+m(d)+" тикетов ",1))),128))])):$("",!0)]))),128))]),s("section",lb,[e[19]||(e[19]=s("h3",null,"🎯 Нулевая точка",-1)),s("div",cb,[(c(!0),u(ee,null,te(t.metrics.zeroPoint.byStage,(n,l)=>(c(),u("div",{key:l,class:"metric-card"},[s("div",db,m(t.getStageName(l)),1),s("div",ub,m(n),1)]))),128))])]),s("section",gb,[e[20]||(e[20]=s("h3",null,"⚠️ Проблемные тикеты",-1)),t.problematicTickets.withoutAssignedById.length>0?(c(),u("div",mb,[s("h4",null,"Без assignedById ("+m(t.problematicTickets.withoutAssignedById.length)+")",1),s("div",hb,[(c(!0),u(ee,null,te(t.problematicTickets.withoutAssignedById.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[s("span",fb,"#"+m(n.id),1),s("span",vb,m(n.title),1),s("span",pb,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withoutAssignedById.length>10?(c(),u("div",yb," ... и ещё "+m(t.problematicTickets.withoutAssignedById.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withAssignedById1051.length>0?(c(),u("div",kb,[s("h4",null,"С assignedById=1051 ("+m(t.problematicTickets.withAssignedById1051.length)+")",1),s("div",bb,[(c(!0),u(ee,null,te(t.problematicTickets.withAssignedById1051.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[s("span",_b,"#"+m(n.id),1),s("span",wb,m(n.title),1),s("span",Cb,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withAssignedById1051.length>10?(c(),u("div",Tb," ... и ещё "+m(t.problematicTickets.withAssignedById1051.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withoutSectorTag.length>0?(c(),u("div",Sb,[s("h4",null,"Без/неверный тег сектора ("+m(t.problematicTickets.withoutSectorTag.length)+")",1),s("div",Db,[(c(!0),u(ee,null,te(t.problematicTickets.withoutSectorTag.slice(0,10),n=>(c(),u("div",{key:n.id||n.ID,class:"ticket-item"},[s("span",Eb,"#"+m(n.id||n.ID),1),s("span",Ab,m(n.title||n.TITLE||"Без названия"),1),s("span",$b,m(t.getStageName(n.stageId||n.STAGE_ID)),1)]))),128)),t.problematicTickets.withoutSectorTag.length>10?(c(),u("div",Ib," ... и ещё "+m(t.problematicTickets.withoutSectorTag.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.notInColumn.length>0?(c(),u("div",Mb,[s("h4",null,"Не попали в колонку ("+m(t.problematicTickets.notInColumn.length)+")",1),s("div",Nb,[(c(!0),u(ee,null,te(t.problematicTickets.notInColumn.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[s("span",xb,"#"+m(n.id),1),s("span",Lb,m(n.title),1),s("span",Pb,m(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.notInColumn.length>10?(c(),u("div",Ob," ... и ещё "+m(t.problematicTickets.notInColumn.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.unknownStage.length>0?(c(),u("div",Rb,[s("h4",null,"Неизвестная стадия ("+m(t.problematicTickets.unknownStage.length)+")",1),s("div",Bb,[(c(!0),u(ee,null,te(t.problematicTickets.unknownStage.slice(0,10),n=>(c(),u("div",{key:n.id,class:"ticket-item"},[s("span",Ub,"#"+m(n.id),1),s("span",Wb,m(n.title),1),s("span",Fb,"Стадия: "+m(n.stageId),1)]))),128)),t.problematicTickets.unknownStage.length>10?(c(),u("div",Hb," ... и ещё "+m(t.problematicTickets.unknownStage.length-10),1)):$("",!0)])])):$("",!0),t.hasNoProblems?(c(),u("div",jb," ✅ Проблемных тикетов не обнаружено ")):$("",!0)])])):$("",!0)])):$("",!0)}const zb=ce(k1,[["render",Vb],["__scopeId","data-v-74a5e138"]]);function Gb(){const o=M(!1),e=M(null),a=M([{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}]),t=M({formed:[],review:[],execution:[]}),r=M([]),i=M(null);return{isLoading:o,error:e,stages:a,zeroPointTickets:t,employees:r,draggedTicket:i,updateState:v=>{v.stages&&(a.value=v.stages),v.employees&&(r.value=v.employees),v.zeroPointTickets&&(t.value=v.zeroPointTickets)},resetState:()=>{o.value=!1,e.value=null,a.value=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}],t.value={formed:[],review:[],execution:[]},r.value=[],i.value=null},updateLocalStateAfterMove:(v,C,f)=>{const p=a.value.find(S=>S.employees.some(T=>T.tickets.some(k=>k.id===v.id)));if(p){const S=p.employees.find(T=>T.tickets.some(k=>k.id===v.id));S&&(S.tickets=S.tickets.filter(T=>T.id!==v.id))}const y=a.value.find(S=>S.id===f);if(y){const S=y.employees.find(T=>T.id===C);if(S){const T={...v,assigneeId:C,stageId:f};S.tickets.push(T)}}Object.keys(t.value).forEach(S=>{t.value[S]=t.value[S].filter(T=>T.id!==v.id)})},getEmployeeTickets:(v,C)=>{const f=a.value.find(y=>y.id===C);if(!f)return[];const p=f.employees.find(y=>y.id===v);return p?p.tickets||[]:[]}}}function Kb(){const o=M(null),e=M(0),a=M(null),t=M(null),r=M({}),i=(f,p={})=>{o.value=f,r.value=p},n=f=>{const p=typeof f=="number"&&!isNaN(f)?f:0;e.value=Math.min(100,Math.max(0,p))},l=f=>{a.value=f,t.value=null},d=f=>{t.value=f},g=()=>{t.value=null},v=()=>{o.value=null,e.value=0,a.value=null,t.value=null,r.value={}},C=I(()=>a.value||t.value);return{currentStep:o,progress:e,error:a,temporaryError:t,displayError:C,stepDetails:r,updateStep:i,updateProgress:n,setError:l,setTemporaryError:d,clearTemporaryError:g,reset:v}}const ut={fadeOutDuration:400,fadeInDuration:400,delayBetween:150,readyDisplayTime:800,fadeOutEasing:"ease-out",fadeInEasing:"ease-in",fadeOutTransform:"scale(0.95)",fadeInTransform:"translateY(10px)"},is={fadeInDuration:400,fadeInEasing:"ease-in"};function Hs(o,e,a="opacity, transform"){return`${a} ${o}ms ${e}`}function qb(){return Hs(ut.fadeOutDuration,ut.fadeOutEasing)}function Yb(){return Hs(is.fadeInDuration,is.fadeInEasing)}function Xb(){const o=M(!1),e=M(null),a=n=>{o.value=!0,e.value=Date.now(),n&&n()},t=n=>{o.value=!1,e.value=null,n&&n()},r=(n,l,d=ut)=>{a(()=>{n&&n(),setTimeout(()=>{l&&l()},d.delayBetween),setTimeout(()=>{t()},d.fadeOutDuration)})},i=I(()=>e.value?Date.now()-e.value:0);return{isTransitioning:I(()=>o.value),startTransition:a,endTransition:t,executeTransition:r,transitionDuration:i}}function Jb(o,e=""){if(Logger.error(`API Error ${e?`(${e})`:""}`,"ErrorHandler",o),o.message){if(o.message.includes("HTTP error"))return"Ошибка соединения с сервером. Проверьте подключение к интернету.";if(o.message.includes("timeout"))return"Превышено время ожидания ответа. Попробуйте позже.";if(o.message.includes("403")||o.message.includes("401"))return"Ошибка доступа. Проверьте права доступа.";if(o.message.includes("500"))return"Ошибка на сервере. Обратитесь к администратору."}return o.message||"Произошла неизвестная ошибка"}function Zb(o,e="",a={}){const t={message:o.message,stack:o.stack,context:e,...a,timestamp:new Date().toISOString()};Logger.error("Error logged","ErrorHandler",t)}function Ia(o,e="",a=null){const t=Jb(o,e);Zb(o,e),a&&typeof a=="function"?a(t,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:t,autoHideDelay:5e3})}function Qb(o){const e=mt(),a=Kb(),{isTransitioning:t,executeTransition:r}=Xb();function i(p,y){const S=ga(p);S.step&&y.updateStep(S.step,S.details||{}),S.progress!==void 0&&S.progress!==null&&(y.updateProgress(S.progress),y.clearTemporaryError())}const n=async(p=!0)=>{o.isLoading.value=!0,o.error.value=null,a.reset(),a.updateStep("cache_check",{description:"Инициализация загрузки данных..."}),a.updateProgress(0);try{const y=await Bt.getSectorData(p,S=>{i(S,a)});o.updateState(y)}catch(y){o.error.value=y.message,a.setError(y.message),Ia(y,"loading sector data",e.error)}finally{if(o.error.value)o.isLoading.value=!1;else{a.updateStep("complete",{description:"Дашборд загружен"}),a.updateProgress(100);const y=ut.readyDisplayTime||800;setTimeout(()=>{r(()=>{},()=>{o.isLoading.value=!1},ut),setTimeout(()=>{a.reset()},ut.fadeOutDuration)},y)}}},l=async(p,y,S)=>{if(!Ws(p,y,S))return e.warning("Нельзя переместить тикет сюда"),!1;try{const T=await Bt.assignTicket(p.id,y,S);return T&&(o.updateLocalStateAfterMove(p,y,S),e.success("Тикет перемещён")),T}catch(T){return Ia(T,"assigning ticket",e.error),!1}finally{o.draggedTicket.value=null}};return{loadSectorData:n,assignTicket:l,moveTicketToStage:async(p,y)=>await l(p,p.assigneeId,y),assignTicketToEmployee:async(p,y)=>await l(p,y,p.stageId),createTicket:async p=>{const y=i0(p);if(!y.valid){const S=y.errors.join(", ");return e.error(S),0}try{const S=await Bt.createTicket(p);return S>0&&(await n(!1),e.success("Тикет создан")),S}catch(S){return Ia(S,"creating ticket",e.error),0}},handleTicketDragStart:p=>{o.draggedTicket.value=p},handleTicketDrop:async(p,y,S)=>{await l(p,y,S)},loadingProgress:a,isTransitioning:t}}const Va={name:"DashboardSector1C",components:{DashboardStage:E0,LoadingPreloader:o1,LoggerControl:y1,BackButton:_s,DiagnosticsPanel:zb},setup(){const o=Xe(),e=Ra(),a=Gb(),t=Qb(a),r=M(null),i=I(()=>r.value?sa(r.value):!1),n=I(()=>ct(e,r.value)),l=()=>{o.push({name:"dashboard-sector-1c",query:{...e.query,diagnostics:"true"}}),typeof localStorage<"u"&&localStorage.setItem("dashboard-sector-1c-diagnostics","true");const x=tt();x&&x.reset(),t.loadSectorData(!1)},d=()=>{Oe.invalidateTicketsCache(),Oe.invalidateEmployeesCache(),Cs();const x=tt();x&&x.reset(),t.loadSectorData(!1)};$e(async()=>{try{r.value=await rt.getCurrentUser()}catch(x){console.error("Error getting current user:",x),r.value=null}if(n.value){const x=tt();x&&x.reset()}t.loadSectorData()});const g=qb(),v=Yb(),C=`${ut.delayBetween}ms`,f=ut.fadeOutTransform,p=ut.fadeInTransform,y=()=>{t.loadSectorData(!1)},S=()=>{o.push({name:"dashboard-graph-state"})},T=()=>{o.push({name:"dashboard-graph-admission-closure"})},k=()=>{o.push({name:"dashboard-tickets-time-tracking"})},_=()=>{o.push("/")},A=t.loadingProgress,U=I(()=>typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-show-logger-control")==="true":!1);return{isLoading:a.isLoading,error:a.error,stages:a.stages,zeroPointTickets:a.zeroPointTickets,employees:a.employees,draggedTicket:a.draggedTicket,currentStep:A.currentStep,progress:A.progress,stepDetails:A.stepDetails,loadingProgress:A,loadSectorData:t.loadSectorData,handleTicketDragStart:t.handleTicketDragStart,handleTicketDrop:t.handleTicketDrop,assignTicketToEmployee:t.assignTicketToEmployee,moveTicketToStage:t.moveTicketToStage,createTicket:t.createTicket,getEmployeeTickets:a.getEmployeeTickets,showLoggerControl:U,handleRetry:y,isTransitioning:t.isTransitioning,preloaderFadeOutTransition:g,dashboardFadeInTransition:v,transitionDelay:C,preloaderFadeOutTransform:f,dashboardFadeInTransform:p,navigateToGraphState:S,navigateToAdmissionClosure:T,navigateToTimeTracking:k,handleGoHome:_,isDiagnosticsEnabled:n,enableDiagnostics:l,clearCache:d,isUserAdmin:i}}},ls=()=>{io(o=>({e25fa6d4:o.preloaderFadeOutTransition,v2de4400b:o.preloaderFadeOutTransform,v66f66a76:o.dashboardFadeInTransition,e224f3ee:o.transitionDelay,v171b9ffc:o.dashboardFadeInTransform}))},cs=Va.setup;Va.setup=cs?(o,e)=>(ls(),cs(o,e)):ls;const e_={class:"dashboard-header"},t_={class:"breadcrumbs-row"},a_={class:"header-actions"},s_={key:0,class:"dashboard-content"},o_={class:"stages-container"};function n_(o,e,a,t,r,i){const n=be("BackButton"),l=be("LoadingPreloader"),d=be("DashboardStage"),g=be("LoggerControl"),v=be("DiagnosticsPanel");return c(),u("div",{class:X(["dashboard-sector-1c",{"is-dragging":t.draggedTicket}])},[s("div",e_,[s("div",t_,[s("button",{class:"btn-home-link",type:"button",onClick:e[0]||(e[0]=(...C)=>t.handleGoHome&&t.handleGoHome(...C)),title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),e[6]||(e[6]=s("span",{class:"breadcrumb-separator"},"/",-1)),e[7]||(e[7]=s("span",{class:"breadcrumb-current"},"Дашборд сектора 1С",-1))]),ne(n,{variant:"header"}),e[13]||(e[13]=s("h1",null,"Дашборд - Сектор 1С",-1)),s("div",a_,[t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...C)=>t.clearCache&&t.clearCache(...C)),class:"btn-clear-cache",title:"Сбросить кеш сектора и тикетов"},[...e[8]||(e[8]=[s("span",{class:"icon"},"♻️",-1),s("span",null,"Сбросить кеш",-1)])])):$("",!0),!t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),u("button",{key:1,onClick:e[2]||(e[2]=(...C)=>t.enableDiagnostics&&t.enableDiagnostics(...C)),class:"btn-enable-diagnostics",title:"Включить диагностический режим"},[...e[9]||(e[9]=[s("span",{class:"icon"},"🔍",-1),s("span",null,"Диагностика",-1)])])):$("",!0),s("button",{onClick:e[3]||(e[3]=(...C)=>t.navigateToGraphState&&t.navigateToGraphState(...C)),class:"btn-navigate-graph-state",title:"Перейти к графику состояния сектора"},[...e[10]||(e[10]=[s("span",{class:"icon"},"📊",-1),s("span",null,"График состояния",-1)])]),s("button",{onClick:e[4]||(e[4]=(...C)=>t.navigateToAdmissionClosure&&t.navigateToAdmissionClosure(...C)),class:"btn-navigate-admission-closure",title:"Перейти к графику приёма и закрытий сектора"},[...e[11]||(e[11]=[s("span",{class:"icon"},"📈",-1),s("span",null,"График приёма и закрытий",-1)])]),s("button",{onClick:e[5]||(e[5]=(...C)=>t.navigateToTimeTracking&&t.navigateToTimeTracking(...C)),class:"btn-navigate-time-tracking",title:"Перейти к трудозатратам на тикеты сектора"},[...e[12]||(e[12]=[s("span",{class:"icon"},"⏱",-1),s("span",null,"Трудозатраты",-1)])])])]),ne(Ae,{name:"preloader-fade"},{default:ye(()=>[t.isLoading||t.error||t.currentStep?(c(),he(l,{key:0,"current-step":t.currentStep,progress:t.progress,"step-details":t.stepDetails,error:t.error||null,onRetry:t.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):$("",!0)]),_:1}),ne(Ae,{name:"dashboard-fade"},{default:ye(()=>[!t.isLoading&&!t.error&&!t.currentStep?(c(),u("div",s_,[s("div",o_,[(c(!0),u(ee,null,te(t.stages,C=>(c(),he(d,{key:C.id,stage:C,"zero-point-tickets":t.zeroPointTickets[C.id]||[],onTicketMoved:t.handleTicketDrop,onTicketAssigned:t.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):$("",!0)]),_:1}),ne(n,{variant:"floating"}),ne(g,{"show-control":t.showLoggerControl},null,8,["show-control"]),ne(v,{"is-enabled":t.isDiagnosticsEnabled,"is-user-admin":t.isUserAdmin},null,8,["is-enabled","is-user-admin"])],2)}const js=ce(Va,[["render",n_],["__scopeId","data-v-11e84363"]]),Vs=Object.freeze(Object.defineProperty({__proto__:null,default:js},Symbol.toStringTag,{value:"Module"})),r_={name:"ModuleAdapter",props:{moduleConfig:{type:Object,required:!0,validator:o=>o.id&&o.title&&o.component},sectorId:{type:String,required:!0},isCompact:{type:Boolean,default:!0}},emits:["module-ready","module-error","module-navigate"],setup(o,{emit:e}){const a=Xe(),t=M(!1),r=M(null),i=M(null),n=M(null),l={SectorDashboard:Rn,TicketsTimeTrackingDashboard:Ns,GraphStateDashboard:Os,GraphAdmissionClosureDashboard:Rs,DashboardSector1C:js},d=I(()=>{const S={isCompact:o.isCompact,sectorId:o.sectorId,moduleId:o.moduleConfig.id};switch(o.moduleConfig.component){case"SectorDashboard":return{sectorId:o.sectorId};case"DashboardSector1C":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphStateDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0,autoLoad:!1};case"TicketsTimeTrackingDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphAdmissionClosureDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};default:return S}}),g=async()=>{try{t.value=!0,r.value=null;const S=o.moduleConfig.component;l[S]?(i.value=l[S],console.log(`[ModuleAdapter] ✅ Loading real component ${S} for module ${o.moduleConfig.id} in sector ${o.sectorId}`),console.log("[ModuleAdapter] Component loaded:",i.value)):(i.value="div",console.log(`[ModuleAdapter] ⚠️ Loading module ${o.moduleConfig.id} for sector ${o.sectorId} - using placeholder (component ${S} not found)`)),e("module-ready",{moduleId:o.moduleConfig.id,sectorId:o.sectorId})}catch(S){console.error(`Failed to load module ${o.moduleConfig.id}:`,S),r.value=S.message,e("module-error",{moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})}finally{t.value=!1}},v=()=>{console.log("🔗 [ModuleAdapter] Opening full view for module:",o.moduleConfig.id),console.log("🔗 [ModuleAdapter] Route:",o.moduleConfig.route),console.log("🔗 [ModuleAdapter] Module config:",o.moduleConfig),o.moduleConfig.route?(console.log("🔗 [ModuleAdapter] Navigating to:",o.moduleConfig.route),a.push(o.moduleConfig.route)):console.warn(`No route defined for module ${o.moduleConfig.id}`)},C=()=>{g()},f=S=>{e("module-navigate",{type:"ready",moduleId:o.moduleConfig.id,sectorId:o.sectorId,data:S})},p=S=>{e("module-navigate",{type:"error",moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})},y=S=>{e("module-navigate",{type:"navigate",moduleId:o.moduleConfig.id,sectorId:o.sectorId,navigation:S})};return $e(()=>{g()}),{isLoading:t,error:r,moduleComponent:i,moduleInstance:n,moduleProps:d,openFullView:v,retryLoad:C,onModuleReady:f,onModuleError:p,onModuleNavigate:y}}},i_={class:"module-header"},l_={class:"module-icon"},c_={class:"module-info"},d_={class:"module-actions"},u_=["aria-label"],g_={class:"module-content"},m_={key:0,class:"module-loading"},h_={key:1,class:"module-error"},f_={key:2,class:"module-body"},v_={class:"module-placeholder"},p_={class:"placeholder-icon"};function y_(o,e,a,t,r,i){return c(),u("div",{class:X(["sector-module-adapter",`module-${a.moduleConfig.id}`])},[s("div",i_,[s("div",l_,m(a.moduleConfig.icon),1),s("div",c_,[s("h3",null,m(a.moduleConfig.title),1),s("p",null,m(a.moduleConfig.description),1)]),s("div",d_,[s("button",{onClick:e[0]||(e[0]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-module-fullscreen",title:"Открыть в полном размере","aria-label":`Открыть ${a.moduleConfig.title} в полном размере`}," ⛶ ",8,u_)])]),s("div",g_,[t.isLoading?(c(),u("div",m_,[e[3]||(e[3]=s("div",{class:"loading-spinner"},null,-1)),s("p",null,"Загрузка "+m(a.moduleConfig.title)+"...",1)])):t.error?(c(),u("div",h_,[e[4]||(e[4]=s("div",{class:"error-icon"},"⚠️",-1)),e[5]||(e[5]=s("p",null,"Ошибка загрузки модуля",-1)),s("button",{onClick:e[1]||(e[1]=(...n)=>t.retryLoad&&t.retryLoad(...n)),class:"btn-retry"},"Повторить")])):(c(),u("div",f_,[s("div",v_,[s("div",p_,m(a.moduleConfig.icon),1),s("h4",null,m(a.moduleConfig.title),1),s("p",null,m(a.moduleConfig.description),1),e[6]||(e[6]=s("div",{class:"placeholder-status"},[s("span",{class:"status-badge"},"В разработке"),s("small",null,"Модуль готовится к интеграции")],-1)),s("button",{onClick:e[2]||(e[2]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-open-full"}," Открыть в полном размере ")])]))])],2)}const k_=ce(r_,[["render",y_],["__scopeId","data-v-df66ddb2"]]),b_={name:"SectorContainer",components:{ModuleAdapter:k_},props:{sectorConfig:{type:Object,required:!0,validator:o=>o.id&&o.name&&o.icon}},emits:["module-ready","module-error","module-event","sector-expanded","sector-collapsed"],setup(o,{emit:e}){Xe();const a=M(!1),t=M(!1),r=M([]),i=I(()=>o.sectorConfig.modules&&o.sectorConfig.modules.length>0),n=I(()=>!1);$e(async()=>{i.value&&await l()});const l=async()=>{t.value=!0;try{r.value=o.sectorConfig.modules||[],e("module-ready",{sectorId:o.sectorConfig.id,modulesCount:r.value.length})}catch(p){console.error(`Failed to load modules for sector ${o.sectorConfig.id}:`,p),e("module-error",{sectorId:o.sectorConfig.id,error:p.message})}finally{t.value=!1}};return{expanded:a,loading:t,sectorModules:r,hasModules:i,canNavigateToDashboard:n,toggleExpanded:()=>{a.value=!a.value,a.value?e("sector-expanded",{sectorId:o.sectorConfig.id}):e("sector-collapsed",{sectorId:o.sectorConfig.id})},onModuleReady:p=>{e("module-ready",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,data:p})},onModuleError:p=>{e("module-error",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,error:p.error})},onModuleNavigate:p=>{e("module-event",{sectorId:o.sectorConfig.id,moduleId:p.moduleId,event:p})},navigateToSectorDashboard:()=>{console.log(`Navigate to dashboard for sector: ${o.sectorConfig.id}`)}}}},__={class:"sector-header"},w_={class:"sector-header-left"},C_={class:"sector-icon"},T_={class:"sector-title"},S_={class:"sector-actions"},D_={key:0,class:"sector-content"},E_={key:0,class:"sector-loading"},A_={key:1,class:"sector-modules-grid"},$_={key:2,class:"no-modules"},I_={key:3,class:"sector-dashboard-link"};function M_(o,e,a,t,r,i){const n=be("ModuleAdapter");return c(),u("div",{class:X(["sector-container",`sector-${a.sectorConfig.id}`])},[s("div",__,[s("div",w_,[s("div",C_,m(a.sectorConfig.icon),1),s("div",T_,[s("h2",null,m(a.sectorConfig.name),1),s("p",null,m(a.sectorConfig.description),1)])]),s("div",S_,[s("button",{onClick:e[0]||(e[0]=(...l)=>t.toggleExpanded&&t.toggleExpanded(...l)),class:"btn-toggle-sector"},m(t.expanded?"Свернуть":"Развернуть"),1)])]),t.expanded?(c(),u("div",D_,[t.loading?(c(),u("div",E_,[e[3]||(e[3]=s("div",{class:"loading-spinner"},null,-1)),s("p",null,"Загрузка сектора "+m(a.sectorConfig.name)+"...",1)])):t.sectorModules.length>0?(c(),u("div",A_,[(c(!0),u(ee,null,te(t.sectorModules,l=>(c(),he(n,{key:l.id,"module-config":l,"sector-id":a.sectorConfig.id,"is-compact":!0,onModuleReady:t.onModuleReady,onModuleError:t.onModuleError,onModuleNavigate:t.onModuleNavigate},null,8,["module-config","sector-id","onModuleReady","onModuleError","onModuleNavigate"]))),128))])):(c(),u("div",$_,[s("p",null,'Модули для сектора "'+m(a.sectorConfig.name)+'" находятся в разработке',1),t.canNavigateToDashboard?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[4]||(e[4]=[s("span",{class:"icon"},"📊",-1),ge(" Открыть полный дашборд сектора ",-1)])])):$("",!0)])),t.sectorModules.length>0&&t.canNavigateToDashboard?(c(),u("div",I_,[s("button",{onClick:e[2]||(e[2]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[5]||(e[5]=[s("span",{class:"icon"},"📊",-1),ge(" Открыть полный дашборд сектора ",-1)])])])):$("",!0)])):$("",!0)],2)}const N_=ce(b_,[["render",M_],["__scopeId","data-v-0fa90bab"]]);class ca{static async logAppEntry(e,a=null){if(!e||!e.ID)return console.warn("[ActivityLoggingService] Invalid user object for app entry logging"),!1;const t={timestamp:new Date().toISOString(),type:"app_entry",user_id:e.ID,user_name:this.getUserName(e),user_email:e.EMAIL||null,ip:a||this.getClientIp(),user_agent:navigator.userAgent,session_id:this.getSessionId()};return await this.saveLog(t)}static async logPageVisit(e,a,t=null){if(!a||!a.ID)return console.warn("[ActivityLoggingService] Invalid user object for page visit logging"),!1;if(!e||!e.path)return console.warn("[ActivityLoggingService] Invalid route object for page visit logging"),!1;const r={timestamp:new Date().toISOString(),type:"page_visit",user_id:a.ID,user_name:this.getUserName(a),route_path:e.path,route_name:e.name||null,route_title:e.meta?.title||null,from_path:t?.path||null,from_name:t?.name||null,session_id:this.getSessionId()};return await this.saveLog(r)}static async saveLog(e){try{const a=et("/api/user-activity-log.php"),t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e),signal:AbortSignal.timeout(5e3)});if(!t.ok){const i=await t.text();return console.error("[ActivityLoggingService] Failed to save log:",{status:t.status,statusText:t.statusText,error:i}),!1}const r=await t.json();return r.success?!0:(console.error("[ActivityLoggingService] API returned error:",r.error),!1)}catch(a){return a.name==="AbortError"?console.warn("[ActivityLoggingService] Request timeout (activity logging skipped)"):console.error("[ActivityLoggingService] Error saving log:",a),!1}}static getSessionId(){const e="activity_session_id";if(sessionStorage.getItem(e))return sessionStorage.getItem(e);const a=this.generateSessionId();return sessionStorage.setItem(e,a),a}static generateSessionId(){const e=Date.now(),a=Math.random().toString(36).substring(2,11);return`${e}-${a}`}static getUserName(e){const a=e.NAME||"",t=e.LAST_NAME||"";return`${a} ${t}`.trim()||e.EMAIL||`User #${e.ID}`}static getClientIp(){return null}static isAppEntryLogged(){return sessionStorage.getItem("app_entry_logged")==="true"}static markAppEntryLogged(){sessionStorage.setItem("app_entry_logged","true")}}const x_={reports:[{id:1,title:"Отчёт по тикетам",icon:"📊",route:"/reports/tickets",description:"Статистика по тикетам и обращениям",active:!1},{id:2,title:"Отчёт по производительности",icon:"📈",route:"/reports/performance",description:"Анализ производительности работы отдела",active:!1},{id:3,title:"Отчёт по срокам",icon:"📉",route:"/reports/deadlines",description:"Анализ соблюдения сроков выполнения задач",active:!1},{id:4,title:"Сводный отчёт",icon:"📋",route:"/reports/summary",description:"Общая сводка по всем показателям",active:!1},{id:5,title:"Дашборд сектора 1С",icon:"📋",route:"/dashboard/sector-1c",description:"Управление тикетами сектора 1С",active:!0},{id:6,title:"График состояния",icon:"📊",route:"/dashboard/graph-state",description:"Визуализация изменений состояния сектора 1С во времени",active:!0,category:"analytics",order:6},{id:7,title:"График приёма/закрытий 1С",icon:"📈",route:"/dashboard/graph-admission-closure",description:"Недельные новые и закрытые тикеты сектора 1С",active:!0,category:"analytics",order:7},{id:8,title:"Трудозатраты на Тикеты сектора 1С",icon:"⏱",route:"/dashboard/tickets-time-tracking",description:"Трудозатраты сотрудников сектора 1С по неделям",active:!0,category:"analytics",order:8}]};function L_(){return x_.reports.filter(o=>o.active===!0)}const P_={adminInterfaces:[{id:1,title:"Управление пользователями",icon:"👥",route:"/admin/users",description:"Управление доступом пользователей к приложению"},{id:2,title:"Настройки системы",icon:"⚙️",route:"/admin/settings",description:"Конфигурация системы и параметров приложения"},{id:3,title:"Логи вебхуков",icon:"📋",route:"/admin/webhook-logs",description:"Просмотр и анализ логов вебхуков"},{id:4,title:"Статистика использования",icon:"📊",route:"/admin/usage-stats",description:"Аналитика использования приложения"},{id:5,title:"Ручное управление кешем",icon:"🗑️",route:"/admin/cache",description:"Управление кешем модулей приложения"}]};function O_(){return[...P_.adminInterfaces]}const Yt={sector1c:{id:"1c",name:"Сектор 1С",description:"Модули для работы с системами 1С:Предприятие",icon:"⚙️",color:"#007bff",borderColor:"#0056b3",backgroundColor:"#f8f9fa",filterValue:"1C",modules:[{id:"dashboard-sector-1c",title:"Дашборд сектора 1С",description:"Панель управления сектором 1С с основными метриками",icon:"⚙️",component:"SectorDashboard",route:"/dashboard/sector-1c",category:"management"}],features:["smart-process-140","1c-integration"],order:1},sectorPdm:{id:"pdm",name:"Сектор PDM",description:"Управление системами PDM (Product Data Management) - управление данными о продукции",icon:"🔧",color:"#28a745",borderColor:"#1e7e34",backgroundColor:"#f8fff8",filterValue:"PDM",modules:[{id:"dashboard-sector-pdm",title:"Дашборд сектора PDM",description:"Панель управления сектором PDM с основными метриками и задачами",icon:"🔧",component:"SectorDashboardPDM",route:"/dashboard/sector-pdm",category:"management"}],features:["pdm-integration"],order:2},sectorBitrix24:{id:"bitrix24",name:"Сектор Битрикс24",description:"Управление и поддержка платформы Битрикс24 - интеграции и разработка",icon:"🌐",color:"#ffc107",borderColor:"#d39e00",backgroundColor:"#fffef8",filterValue:"Bitrix24",modules:[{id:"dashboard-sector-bitrix24",title:"Дашборд сектора Битрикс24",description:"Панель управления сектором Битрикс24 с задачами интеграции и поддержки",icon:"🌐",component:"SectorDashboardBitrix24",route:"/dashboard/sector-bitrix24",category:"management"}],features:["bitrix24-integration"],order:3},sectorInfrastructure:{id:"infrastructure",name:"Сектор Инфраструктура",description:"Управление инфраструктурой, оборудованием и техническими задачами",icon:"🖥️",color:"#dc3545",borderColor:"#bd2130",backgroundColor:"#fff8f8",filterValue:["Железо","Прочее"],modules:[{id:"dashboard-sector-infrastructure",title:"Дашборд сектора Инфраструктура",description:"Панель управления инфраструктурой с задачами по оборудованию и технике",icon:"🖥️",component:"SectorDashboardInfrastructure",route:"/dashboard/sector-infrastructure",category:"management"}],features:["infrastructure-management"],order:4}};class R_{static getAllSectors(){return Object.values(Yt).sort((e,a)=>(e.order||0)-(a.order||0))}static getSectorById(e){return Yt[e]||null}static getSectorsWithModules(){return this.getAllSectors().filter(e=>e.modules&&e.modules.length>0)}static getSectorColors(){const e={};return Object.values(Yt).forEach(a=>{e[a.id]=a.color}),e}static sectorExists(e){return Object.values(Yt).some(a=>a.id===e)}static getNextOrder(){return Math.max(...Object.values(Yt).map(a=>a.order||0))+1}}const B_={name:"IndexPage",components:{StatusMessage:ba,LoadingSpinner:_a,SectorContainer:N_},beforeCreate(){console.log("[IndexPage] beforeCreate() called")},created(){console.log("[IndexPage] created() called")},beforeMount(){console.log("[IndexPage] beforeMount() called")},setup(){console.log("[IndexPage] setup() called");const o=Xe(),e=M(!0),a=M(null),t=M(!1),r=M(!1),i=M(""),n=M(null),l=M(null),d=M(!1);console.log("[IndexPage] Initial state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value});const g=M(L_()),v=M(R_.getAllSectors()),C=M(!1),f=M(O_()),p=I(()=>n.value?sa(n.value):!1),y=I(()=>{if(!n.value)return"Пользователь";const W=n.value.FIRST_NAME?n.value.FIRST_NAME.trim():"",G=n.value.LAST_NAME?n.value.LAST_NAME.trim():"",q=n.value.NAME?n.value.NAME.trim():"";return W&&G?`${W} ${G}`:q&&G&&q!==G?`${q} ${G}`:W&&q&&W!==q?`${W} ${q}`:q&&q.includes(" ")?q:W||G||q||`Пользователь #${n.value.ID}`}),S=I(()=>a.value?a.value.includes("no_install_app")?"Приложение не установлено":"Ошибка API":null),T=I(()=>a.value?a.value.includes("no_install_app")?"Приложение не установлено в Bitrix24. Необходимо выполнить установку.":a.value:null),k=I(()=>a.value&&a.value.includes("no_install_app")),_=I(()=>ks("/install.php"));$e(async()=>{console.log("[IndexPage] onMounted() called");try{console.log("[IndexPage] Calling AccessControlService.checkAccess()...");const W=await rt.checkAccess();if(console.log("[IndexPage] Access result:",{allowed:W.allowed,hasUser:!!W.user,user:W.user,errorCode:W.errorCode,errorMessage:W.errorMessage}),W.allowed){if(console.log("[IndexPage] Setting accessAllowed to true"),t.value=!0,n.value=W.user,console.log("[IndexPage] Access allowed, setting state:",{accessAllowed:t.value,hasUser:!!n.value,loading:e.value,accessDenied:r.value}),!ca.isAppEntryLogged())try{W.user&&await ca.logAppEntry(W.user)&&ca.markAppEntryLogged()}catch(G){console.error("[IndexPage] Error logging app entry:",G)}}else{r.value=!0;const G=Rt(),q=!G&&W.errorCode===nt.ACCESS_DENIED&&W.errorMessage&&W.errorMessage.includes("Прямой доступ");if(console.log("IndexPage - accessResult:",{errorCode:W.errorCode,errorMessage:W.errorMessage,isInsideB24:G,isDirectAccessDeniedCheck:q}),d.value=q,q&&(i.value=W.errorMessage,console.log("IndexPage - Set direct access denied message:",W.errorMessage)),console.log("IndexPage - State after check:",{accessDenied:r.value,isDirectAccessDenied:d.value,accessErrorMessage:i.value}),!q){if(W.user){const{getAllowedDepartmentIds:oe}=await Ce(async()=>{const{getAllowedDepartmentIds:Y}=await import("./access-config-async-Bqc9SW93.js");return{getAllowedDepartmentIds:Y}},__vite__mapDeps([11,2,3,4,5,6,7]),import.meta.url);l.value={userId:W.user.ID,departmentIds:W.user.UF_DEPARTMENT||[],allowedIds:oe()}}W.errorCode===nt.USER_NOT_DETERMINED?i.value="Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.":W.errorCode===nt.ACCESS_DENIED?i.value="Доступ запрещён":i.value=W.errorMessage||"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел."}}}catch(W){a.value=W.message,console.error("Error checking access:",W)}finally{e.value=!1,console.log("[IndexPage] Final state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value,hasUser:!!n.value,error:a.value})}});const A=W=>{if(!W){console.error("Route is not defined for report");return}o.push(W)},U=()=>{C.value=!0},x=()=>{C.value=!1};return{loading:e,error:a,accessAllowed:t,accessDenied:r,accessErrorMessage:i,currentUser:n,userName:y,debugInfo:l,isDirectAccessDenied:d,errorTitle:S,errorMessage:T,showInstallLink:k,installPageUrl:_,reportsButtons:g,navigateToReport:A,sectors:v,handleModuleEvent:W=>{console.log("Module event:",W)},handleSectorExpanded:W=>{console.log("Sector expanded:",W.sectorId)},handleSectorCollapsed:W=>{console.log("Sector collapsed:",W.sectorId)},isAdmin:p,showAdminPopup:C,adminButtons:f,openAdminPopup:U,closeAdminPopup:x,navigateToAdmin:W=>{if(!W){console.error("Route is not defined for admin interface");return}o.push(W),x()}}}},U_={class:"index-page"},W_={class:"container"},F_={key:0,class:"install-link"},H_=["href"],j_={key:0,class:"direct-access-denied-info",style:{"margin-top":"15px",padding:"15px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px"}},V_={key:1,class:"debug-info",style:{"margin-top":"15px",padding:"10px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px","font-size":"12px"}},z_={key:3,class:"main-content"},G_={class:"greeting-section"},K_={class:"greeting-header"},q_={class:"greeting-header-content"},Y_={class:"greeting-text"},X_={class:"sectors-section"},J_={class:"admin-popup-header"},Z_={class:"admin-popup-content"},Q_={class:"admin-buttons-grid"},ew=["onClick"],tw={class:"admin-icon"},aw={class:"admin-title"},sw={key:0,class:"admin-description"};function ow(o,e,a,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner"),d=be("SectorContainer");return c(),u("div",U_,[s("div",W_,[t.error?(c(),he(n,{key:0,type:"error",title:t.errorTitle,message:t.errorMessage},{default:ye(()=>[t.showInstallLink?(c(),u("div",F_,[s("a",{href:t.installPageUrl},"Установить приложение",8,H_)])):$("",!0)]),_:1},8,["title","message"])):$("",!0),t.loading?(c(),he(l,{key:1,message:"Проверка доступа..."})):$("",!0),!t.loading&&t.accessDenied?(c(),he(n,{key:2,type:"error",title:"Доступ запрещён",message:t.accessErrorMessage},{default:ye(()=>[t.isDirectAccessDenied?(c(),u("div",j_,[...e[4]||(e[4]=[s("p",{style:{margin:"0 0 10px 0","font-weight":"600",color:"#856404"}},[s("strong",null,"Как открыть приложение:")],-1),s("ol",{style:{margin:"0","padding-left":"20px",color:"#856404"}},[s("li",null,"Войдите в Bitrix24"),s("li",null,"Откройте приложение через интерфейс Bitrix24 (placement, виджет или вкладку)")],-1)])])):t.debugInfo?(c(),u("div",V_,[e[5]||(e[5]=s("strong",null,"Отладочная информация:",-1)),e[6]||(e[6]=s("br",null,null,-1)),ge(" ID пользователя: "+m(t.debugInfo.userId),1),e[7]||(e[7]=s("br",null,null,-1)),ge(" ID отделов пользователя: "+m(t.debugInfo.departmentIds),1),e[8]||(e[8]=s("br",null,null,-1)),ge(" Разрешённые ID отделов: "+m(t.debugInfo.allowedIds),1),e[9]||(e[9]=s("br",null,null,-1)),e[10]||(e[10]=s("small",{style:{color:"#856404"}},"Добавьте ID отдела в файл vue-app/src/config/access-config.js",-1))])):$("",!0)]),_:1},8,["message"])):$("",!0),!t.loading&&!t.accessDenied&&t.accessAllowed?(c(),u("div",z_,[s("div",G_,[s("div",K_,[s("div",q_,[e[13]||(e[13]=s("h2",{class:"greeting-title"},"Страница Аналитики ИТ отдела для Планерки Генеральной дирекции",-1)),s("p",Y_,[e[11]||(e[11]=ge(" Добро пожаловать, ",-1)),s("strong",null,m(t.userName),1),e[12]||(e[12]=ge("! ",-1))])]),t.isAdmin?(c(),u("button",{key:0,class:"admin-button-header",onClick:e[0]||(e[0]=(...g)=>t.openAdminPopup&&t.openAdminPopup(...g)),title:"Администрирование"}," ⚙️ ")):$("",!0)])]),s("div",X_,[(c(!0),u(ee,null,te(t.sectors,g=>(c(),he(d,{key:g.id,"sector-config":g,onModuleEvent:t.handleModuleEvent,onSectorExpanded:t.handleSectorExpanded,onSectorCollapsed:t.handleSectorCollapsed},null,8,["sector-config","onModuleEvent","onSectorExpanded","onSectorCollapsed"]))),128))]),t.showAdminPopup&&t.isAdmin?(c(),u("div",{key:0,class:"admin-popup-overlay",onClick:e[3]||(e[3]=(...g)=>t.closeAdminPopup&&t.closeAdminPopup(...g))},[s("div",{class:"admin-popup",onClick:e[2]||(e[2]=Te(()=>{},["stop"]))},[s("div",J_,[e[14]||(e[14]=s("h3",{class:"admin-popup-title"},"⚙️ Администрирование",-1)),s("button",{class:"admin-popup-close",onClick:e[1]||(e[1]=(...g)=>t.closeAdminPopup&&t.closeAdminPopup(...g))}," ✕ ")]),s("div",Z_,[s("div",Q_,[(c(!0),u(ee,null,te(t.adminButtons,g=>(c(),u("div",{key:g.id,class:"admin-interface-button",onClick:v=>t.navigateToAdmin(g.route)},[s("div",tw,m(g.icon),1),s("div",aw,m(g.title),1),g.description?(c(),u("div",sw,m(g.description),1)):$("",!0)],8,ew))),128))])])])])):$("",!0)])):$("",!0)])])}const nw=ce(B_,[["render",ow],["__scopeId","data-v-12137466"]]),Ze=M(new Map),st=M({hits:0,misses:0,sets:0,invalidations:0}),Ma={defaultTTL:5*60*1e3,maxSize:100,enableStats:!0};function rw(o={}){const{ttl:e=Ma.defaultTTL,maxSize:a=Ma.maxSize,enableStats:t=Ma.enableStats}=o,r=T=>{const k=new WeakSet;return JSON.stringify(T,(_,A)=>{if(typeof A=="object"&&A!==null){if(k.has(A))return"[Circular]";k.add(A)}return typeof A=="function"||A===void 0?null:A})},i=(T,k={})=>{const _=Object.keys(k).sort().reduce((A,U)=>{const x=k[U];if(x==null)A[U]=null;else if(typeof x=="object")try{A[U]=r(x)}catch{A[U]=String(x)}else A[U]=x;return A},{});try{return`${T}_${r(_)}`}catch{const U=Object.keys(_).sort().map(x=>`${x}=${_[x]}`).join("&");return`${T}_${U}`}},n=T=>{const k=Ze.value.get(T);return k?Date.now()-k.timestamp>k.ttl?(Ze.value.delete(T),t&&st.value.misses++,null):(k.lastAccessed=Date.now(),t&&st.value.hits++,k.data):(t&&st.value.misses++,null)},l=(T,k,_=null)=>{Ze.value.size>=a&&d(),Ze.value.set(T,{data:k,timestamp:Date.now(),lastAccessed:Date.now(),ttl:_||e}),t&&st.value.sets++},d=()=>{let T=null,k=1/0;for(const[_,A]of Ze.value.entries())A.lastAccessed<k&&(k=A.lastAccessed,T=_);T&&Ze.value.delete(T)},g=()=>{Ze.value.clear(),t&&(st.value={hits:0,misses:0,sets:0,invalidations:0})},v=T=>{const k=typeof T=="string"?new RegExp(T):T;let _=0;for(const A of Ze.value.keys())k.test(A)&&(Ze.value.delete(A),_++);return t&&(st.value.invalidations+=_),_},C=()=>{const T=Date.now();let k=0;for(const[_,A]of Ze.value.entries())T-A.timestamp>A.ttl&&(Ze.value.delete(_),k++);return k},f=()=>{const T=st.value.hits+st.value.misses,k=T>0?(st.value.hits/T*100).toFixed(2):0;return{...st.value,size:Ze.value.size,hitRate:`${k}%`}};let p=null;const y=(T=5*60*1e3)=>{p&&clearInterval(p),p=setInterval(()=>{C()},T)},S=()=>{p&&(clearInterval(p),p=null)};return y(),{get:n,set:l,clear:g,invalidate:v,cleanup:C,getCacheKey:i,getStats:f,startAutoCleanup:y,stopAutoCleanup:S}}function gt(o){if(!o||typeof o!="object"||!o.timestamp||typeof o.timestamp!="string"||!o.event||typeof o.event!="string"||!o.category||typeof o.category!="string"||!["tasks","smart-processes","errors"].includes(o.category))return!1;try{new Date(o.timestamp)}catch{return!1}return!0}function iw(o){if(!o||typeof o!="object")return!1;for(const[e,a]of Object.entries(o))if(typeof a=="function")return!1;return!0}function jt(o){if(!gt(o))return null;const e={timestamp:o.timestamp,event:o.event,category:o.category};return o.ip&&typeof o.ip=="string"&&(e.ip=o.ip),o.payload&&typeof o.payload=="object"&&(e.payload=o.payload),o.details&&iw(o.details)&&(e.details=o.details),e}function za(o){return Array.isArray(o)?o.map(e=>jt(e)).filter(e=>e!==null):[]}const{get:lw,set:cw,getCacheKey:dw,invalidate:ds}=rw({ttl:2*60*1e3,maxSize:50});class us{static getBaseUrl(){return et("/api/webhook-logs.php")}static get BASE_URL(){return this.getBaseUrl()}static async getLogs(e={},a=1,t=50,r=!1){if(a<1)throw new Error("Page must be greater than 0");if(t<1||t>1e3)throw new Error("Limit must be between 1 and 1000");const i={category:e.category||null,event:e.event||null,date:e.date||null,hour:e.hour!==void 0?e.hour:null,dateFrom:e.dateFrom||null,dateTo:e.dateTo||null,ip:e.ip||null,status:e.status||null},n=this.getBaseUrl(),l=dw(n,{filters:i,page:a,limit:t});if(!r){const g=lw(l);if(g)return console.log("[WebhookLogsApiService] Cache hit:",l.substring(0,50)+"..."),g}console.log("[WebhookLogsApiService] Cache miss:",l.substring(0,50)+"...");const d=new URLSearchParams({page:a.toString(),limit:t.toString()});i.category&&d.append("category",i.category),i.event&&d.append("event",i.event),i.date&&d.append("date",i.date),i.hour!==null&&d.append("hour",i.hour.toString()),i.dateFrom&&d.append("dateFrom",i.dateFrom),i.dateTo&&d.append("dateTo",i.dateTo),i.ip&&d.append("ip",i.ip),i.status&&d.append("status",i.status);try{const g=this.getBaseUrl(),v=await fetch(`${g}?${d.toString()}`);if(!v.ok){const y=await v.text();let S;try{S=JSON.parse(y)}catch{S={error:y}}throw new Error(S.error_description||S.error||`HTTP error! status: ${v.status}`)}const C=await v.json();if(console.log("[WebhookLogsApiService] API response:",{success:C.success,logsCount:C.logs?.length||0,pagination:C.pagination,hasError:!!C.error}),C.error)throw new Error(C.error_description||C.error);if(!C.success)throw console.warn("[WebhookLogsApiService] API returned success=false:",C),new Error("API request failed");if(!Array.isArray(C.logs))throw console.error("[WebhookLogsApiService] Invalid logs format:",C.logs),new Error("Invalid logs format: expected array");const f=za(C.logs);(!C.pagination||typeof C.pagination!="object")&&(console.warn("[WebhookLogsApiService] Invalid pagination format:",C.pagination),C.pagination={page:a,limit:t,total:f.length,pages:Math.ceil(f.length/t)});const p={success:!0,logs:f,pagination:{page:C.pagination.page||a,limit:C.pagination.limit||t,total:C.pagination.total||f.length,pages:C.pagination.pages||Math.ceil((C.pagination.total||f.length)/t)}};return cw(l,p),p}catch(g){throw console.error("[WebhookLogsApiService] Error:",g),g}}static invalidateCacheOnFilterChange(e={},a={}){const t=ds(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Invalidated ${t} entries on filter change`)}static clearCache(){const e=ds(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Cleared ${e} entries`)}static async getLogDetails(e,a=null){const t={};return a&&(t.date=a),(await this.getLogs(t,1,1e3)).logs.find(n=>`${n.timestamp}_${n.event}`===e)||null}static async getErrors(e={},a=1,t=50){return this.getLogs({...e,category:"errors"},a,t)}static async getStats(e={}){const a=await this.getLogs(e,1,1e3),t={total:a.pagination.total||a.logs.length,tasks:0,smartProcesses:0,errors:0,byEvent:{},byDate:{}};return a.logs.forEach(r=>{r.category==="tasks"?t.tasks++:r.category==="smart-processes"?t.smartProcesses++:r.category==="errors"&&t.errors++,t.byEvent[r.event]||(t.byEvent[r.event]=0),t.byEvent[r.event]++;const i=r.timestamp.split("T")[0];t.byDate[i]||(t.byDate[i]=0),t.byDate[i]++}),t}}function uw(){const o=Ra(),e=Xe(),a=new Date().toISOString().split("T")[0],t=M({category:null,event:null,dateFrom:a,dateTo:null,hour:null,ip:null,search:null,status:null}),r=()=>{const g=o.query;t.value={category:g.category||null,event:g.event||null,dateFrom:g.dateFrom||g.date||a,dateTo:g.dateTo||null,hour:g.hour?parseInt(g.hour):null,ip:g.ip||null,search:g.search||null,status:g.status||null}},i=g=>{if(d)return;const v={...o.query};Object.keys(g).forEach(f=>{const p=g[f];p!==null&&p!==""&&p!==void 0?v[f]=p.toString():delete v[f]}),JSON.stringify(v)!==JSON.stringify(o.query)&&(d=!0,e.replace({path:o.path,query:v}).finally(()=>{setTimeout(()=>{d=!1},100)}))},n=g=>{const v={...t.value,...g};JSON.stringify(t.value)!==JSON.stringify(v)&&(t.value=v,i(t.value))},l=()=>{t.value={category:null,event:null,dateFrom:a,dateTo:null,hour:null,ip:null,search:null,status:null},i(t.value)};$e(()=>{r()});let d=!1;return Ne(()=>o.query,(g,v)=>{if(d)return;JSON.stringify(g)!==JSON.stringify(v)&&r()},{deep:!0}),{filters:t,updateFilters:n,clearFilters:l,loadFiltersFromUrl:r}}function gw(o,e,a={}){if(!e||!e.trim())return o;const{caseSensitive:t=!1,searchInEvent:r=!0,searchInPayload:i=!0,searchInDetails:n=!0,searchInIp:l=!0,searchInTimestamp:d=!1}=a,g=t?e.trim():e.trim().toLowerCase();return o.filter(v=>{if(r&&v.event&&(t?v.event:v.event.toLowerCase()).includes(g))return!0;if(i&&v.payload)try{const C=JSON.stringify(v.payload);if((t?C:C.toLowerCase()).includes(g))return!0}catch(C){console.warn("Error searching in payload:",C)}if(n&&v.details)try{const C=JSON.stringify(v.details);if((t?C:C.toLowerCase()).includes(g))return!0}catch(C){console.warn("Error searching in details:",C)}return!!(l&&v.ip&&(t?v.ip:v.ip.toLowerCase()).includes(g)||d&&v.timestamp&&(t?v.timestamp:v.timestamp.toLowerCase()).includes(g))})}function Oa(o){if(!o||typeof o!="object"||o.category!==void 0&&o.category!==null&&!["tasks","smart-processes","errors"].includes(o.category)||o.date!==void 0&&o.date!==null&&!/^\d{4}-\d{2}-\d{2}$/.test(o.date))return!1;if(o.hour!==void 0&&o.hour!==null){const e=parseInt(o.hour,10);if(isNaN(e)||e<0||e>23)return!1}return!(o.ip!==void 0&&o.ip!==null&&(typeof o.ip!="string"||o.ip.length===0))}function mw(o){if(!o||typeof o!="object")return!1;const e=parseInt(o.page,10),a=parseInt(o.limit,10),t=parseInt(o.total,10),r=parseInt(o.pages,10);return!(isNaN(e)||e<1||isNaN(a)||a<1||a>1e3||isNaN(t)||t<0||isNaN(r)||r<0)}function gs(o){if(o==null)return"";const e=String(o),a=e.replace(/"/g,'""');return e.includes(",")||e.includes(`
`)||e.includes('"')?`"${a}"`:a}function hw(o){return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}function fw(o,e="webhook-logs.csv",a={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{columns:i=null,onProgress:n=null}=a,l=i||Object.keys(o[0]),g=[l.map(y=>gs(y)).join(",")],v=o.length,C=1e3;for(let y=0;y<v;y+=C){const S=o.slice(y,y+C);if(S.forEach(T=>{const k=l.map(_=>{const A=T[_];return gs(hw(A))});g.push(k.join(","))}),n){const T=Math.min(100,Math.round((y+S.length)/v*100));n(T)}}const f="\uFEFF"+g.join(`
`),p=new Blob([f],{type:"text/csv;charset=utf-8;"});zs(p,e),n&&n(100),t()}catch(i){r(i)}})}function vw(o,e="webhook-logs.json",a={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{pretty:i=!0,onProgress:n=null}=a,l=i?JSON.stringify(o,null,2):JSON.stringify(o);n&&n(50);const d=new Blob([l],{type:"application/json;charset=utf-8;"});zs(d,e),n&&n(100),t()}catch(i){r(i)}})}function zs(o,e){const a=URL.createObjectURL(o),t=document.createElement("a");t.href=a,t.download=e,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t),URL.revokeObjectURL(a)},100)}function pw(o,e={},a=0){const t=new Date().toISOString().split("T")[0],r=new Date().toTimeString().split(" ")[0].replace(/:/g,"-");let i=`webhook-logs_${t}_${r}`;const n=[];return e.category&&n.push(`cat-${e.category}`),e.event&&n.push(`evt-${e.event.substring(0,10)}`),e.dateFrom&&n.push(`from-${e.dateFrom}`),e.dateTo&&n.push(`to-${e.dateTo}`),n.length>0&&(i+=`_${n.join("-")}`),a>0&&(i+=`_${a}records`),`${i}.${o}`}function yw(o){const e=[];if(!Array.isArray(o))return e.push("Данные должны быть массивом"),{valid:!1,errors:e,estimatedSize:0};if(o.length===0)return e.push("Нет данных для экспорта"),{valid:!1,errors:e,estimatedSize:0};const a=JSON.stringify(o).length,t=50*1024*1024;return a>t&&e.push(`Большой объём данных (${Math.round(a/1024/1024)} MB). Экспорт может занять время.`),{valid:e.length===0,errors:e,estimatedSize:a}}function Ga(o,e="short"){if(!o)return"—";try{const a=new Date(o);if(isNaN(a.getTime()))return"Invalid date";switch(e){case"short":return a.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});case"long":return a.toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});case"relative":return kw(a);default:return a.toLocaleString("ru-RU")}}catch{return"Invalid date"}}function kw(o){const a=new Date-o,t=Math.floor(a/1e3),r=Math.floor(t/60),i=Math.floor(r/60),n=Math.floor(i/24);return t<60?"только что":r<60?`${r} ${Na(r,"минуту","минуты","минут")} назад`:i<24?`${i} ${Na(i,"час","часа","часов")} назад`:n<7?`${n} ${Na(n,"день","дня","дней")} назад`:Ga(o.toISOString(),"short")}function Na(o,e,a,t){const r=o%10,i=o%100;return r===1&&i!==11?e:r>=2&&r<=4&&(i<10||i>=20)?a:t}function Vt(o){return o?o.replace(/^ON/,"").split(/(?=[A-Z])/).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):"—"}function bt(o){return{tasks:"Задачи","smart-processes":"Смарт-процессы",errors:"Ошибки"}[o]||o}function Ka(o){if(!o||typeof o!="object")return"—";const e=[];if(o.task_id&&e.push(`Задача #${o.task_id}`),o.entity_id&&e.push(`Сущность #${o.entity_id}`),o.task_title&&e.push(`"${o.task_title}"`),o.title&&e.push(`"${o.title}"`),o.comment_text){const a=o.comment_text.length>50?o.comment_text.substring(0,50)+"...":o.comment_text;e.push(`Комментарий: ${a}`)}return e.length>0?e.join(" • "):"—"}const bw={name:"WebhookLogsExport",props:{logs:{type:Array,default:()=>[]},selectedLogs:{type:Array,default:()=>[]},filters:{type:Object,default:()=>({})},totalCount:{type:Number,default:0}},emits:["export-start","export-complete","export-error"],setup(o,{emit:e}){const a=M(!1),t=M("csv"),r=M("all"),i=M(!0),n=M(!1),l=M(0),d=M([]),g=M(null),v=I(()=>o.selectedLogs.length),C=I(()=>o.logs.length>0||o.totalCount>0),f=I(()=>o.filters.category||o.filters.event||o.filters.dateFrom||o.filters.dateTo),p=I(()=>r.value==="selected"?v.value:o.logs.length||o.totalCount),y=I(()=>r.value==="selected"?v.value>0:C.value),S=()=>{l.value=0,d.value=[],g.value=null,v.value>0?r.value="selected":r.value="all",a.value=!0,k()},T=()=>{n.value||(a.value=!1)},k=()=>{const x=_(),D=yw(x);d.value=D.errors,g.value=D.estimatedSize},_=()=>(r.value==="selected"?o.selectedLogs:o.logs).map(E=>jt(E)).filter(E=>gt(E)?!0:(console.warn("[WebhookLogsExport] Skipping invalid log:",E),!1)),A=async()=>{try{n.value=!0,l.value=0;let x=_();if(x.length===0)throw new Error("Нет валидных данных для экспорта");const D=x.map(R=>({timestamp:R.timestamp,event:R.event,category:R.category,ip:R.ip||null,details:R.details||null,payload:R.payload||null,formatted:{timestamp:Ga(R.timestamp),event:Vt(R.event),category:bt(R.category),details:Ka(R.details)}}));e("export-start",{format:t.value,scope:r.value,count:D.length});const E=pw(t.value,o.filters,D.length),L=R=>{l.value=R};t.value==="csv"?await fw(D,E,{onProgress:L}):await vw(D,E,{pretty:i.value,onProgress:L}),e("export-complete",{format:t.value,filename:E,count:D.length}),setTimeout(()=>{n.value=!1,a.value=!1,l.value=0},500)}catch(x){console.error("[WebhookLogsExport] Export error:",x),e("export-error",x),n.value=!1,l.value=0,alert(`Ошибка экспорта: ${x.message}`)}},U=x=>x<1024?`${x} B`:x<1024*1024?`${(x/1024).toFixed(2)} KB`:`${(x/1024/1024).toFixed(2)} MB`;return Ne([r,()=>o.logs,()=>o.selectedLogs],()=>{a.value&&k()}),{showExportModal:a,exportFormat:t,exportScope:r,jsonPretty:i,exporting:n,exportProgress:l,exportWarnings:d,estimatedSize:g,selectedCount:v,hasAllLogs:C,hasFilters:f,exportCount:p,canExport:y,openExportModal:S,closeExportModal:T,handleExport:A,formatSize:U}}},_w={class:"webhook-logs-export"},ww=["disabled","title"],Cw={key:0,class:"selected-badge"},Tw={class:"export-modal-header"},Sw={class:"export-modal-body"},Dw={class:"export-section"},Ew={class:"radio-group"},Aw={class:"export-section"},$w={class:"radio-group"},Iw=["disabled"],Mw={class:"radio-label"},Nw={key:0},xw={key:1},Lw=["disabled"],Pw={class:"radio-label"},Ow={key:0,class:"export-section"},Rw={class:"checkbox-option"},Bw={class:"export-info"},Uw={class:"info-item"},Ww={class:"info-value"},Fw={key:0,class:"info-item"},Hw={class:"info-value"},jw={key:1,class:"export-warnings"},Vw={key:0,class:"export-progress"},zw={class:"progress-bar"},Gw={class:"progress-text"},Kw={class:"export-modal-footer"},qw=["disabled"],Yw={key:0},Xw={key:1},Jw=["disabled"];function Zw(o,e,a,t,r,i){return c(),u("div",_w,[s("button",{onClick:e[0]||(e[0]=(...n)=>t.openExportModal&&t.openExportModal(...n)),class:"btn-export",disabled:!t.canExport,title:t.canExport?"Экспорт данных":"Нет данных для экспорта"},[e[11]||(e[11]=s("span",{class:"btn-icon"},"📥",-1)),e[12]||(e[12]=s("span",{class:"btn-text"},"Экспорт",-1)),t.selectedCount>0?(c(),u("span",Cw,m(t.selectedCount),1)):$("",!0)],8,ww),ne(Ae,{name:"modal"},{default:ye(()=>[t.showExportModal?(c(),u("div",{key:0,class:"export-modal-overlay",onClick:e[10]||(e[10]=(...n)=>t.closeExportModal&&t.closeExportModal(...n))},[s("div",{class:"export-modal",onClick:e[9]||(e[9]=Te(()=>{},["stop"]))},[s("div",Tw,[e[13]||(e[13]=s("h3",null,"Экспорт данных",-1)),s("button",{onClick:e[1]||(e[1]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),class:"btn-close"},"✕")]),s("div",Sw,[s("div",Dw,[e[16]||(e[16]=s("h4",null,"Формат файла",-1)),s("div",Ew,[s("label",{class:X(["radio-option",{active:t.exportFormat==="csv"}])},[Re(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=n=>t.exportFormat=n),value:"csv",class:"radio-input"},null,512),[[Et,t.exportFormat]]),e[14]||(e[14]=s("span",{class:"radio-label"},[s("strong",null,"CSV"),s("small",null,"Для Excel, LibreOffice")],-1))],2),s("label",{class:X(["radio-option",{active:t.exportFormat==="json"}])},[Re(s("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=n=>t.exportFormat=n),value:"json",class:"radio-input"},null,512),[[Et,t.exportFormat]]),e[15]||(e[15]=s("span",{class:"radio-label"},[s("strong",null,"JSON"),s("small",null,"Для разработчиков, API")],-1))],2)])]),s("div",Aw,[e[19]||(e[19]=s("h4",null,"Что экспортировать",-1)),s("div",$w,[s("label",{class:X(["radio-option",{active:t.exportScope==="all",disabled:!t.hasAllLogs}])},[Re(s("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=n=>t.exportScope=n),value:"all",disabled:!t.hasAllLogs,class:"radio-input"},null,8,Iw),[[Et,t.exportScope]]),s("span",Mw,[e[17]||(e[17]=s("strong",null,"Все записи",-1)),t.hasFilters?(c(),u("small",Nw,"С применёнными фильтрами ("+m(t.exportCount)+" записей)",1)):(c(),u("small",xw,"Всего: "+m(t.exportCount)+" записей",1))])],2),s("label",{class:X(["radio-option",{active:t.exportScope==="selected",disabled:t.selectedCount===0}])},[Re(s("input",{type:"radio","onUpdate:modelValue":e[5]||(e[5]=n=>t.exportScope=n),value:"selected",disabled:t.selectedCount===0,class:"radio-input"},null,8,Lw),[[Et,t.exportScope]]),s("span",Pw,[e[18]||(e[18]=s("strong",null,"Выбранные записи",-1)),s("small",null,m(t.selectedCount)+" записей выбрано",1)])],2)])]),t.exportFormat==="json"?(c(),u("div",Ow,[e[21]||(e[21]=s("h4",null,"Опции JSON",-1)),s("label",Rw,[Re(s("input",{type:"checkbox","onUpdate:modelValue":e[6]||(e[6]=n=>t.jsonPretty=n),class:"checkbox-input"},null,512),[[ka,t.jsonPretty]]),e[20]||(e[20]=s("span",{class:"checkbox-label"},"Красивое форматирование (с отступами)",-1))])])):$("",!0),s("div",Bw,[s("div",Uw,[e[22]||(e[22]=s("span",{class:"info-label"},"Записей к экспорту:",-1)),s("span",Ww,m(t.exportCount),1)]),t.estimatedSize?(c(),u("div",Fw,[e[23]||(e[23]=s("span",{class:"info-label"},"Примерный размер:",-1)),s("span",Hw,m(t.formatSize(t.estimatedSize)),1)])):$("",!0)]),t.exportWarnings.length>0?(c(),u("div",jw,[(c(!0),u(ee,null,te(t.exportWarnings,(n,l)=>(c(),u("div",{key:l,class:"warning-item"}," ⚠️ "+m(n),1))),128))])):$("",!0)]),t.exporting?(c(),u("div",Vw,[s("div",zw,[s("div",{class:"progress-fill",style:we({width:`${t.exportProgress}%`})},null,4)]),s("div",Gw," Экспорт: "+m(t.exportProgress)+"% ",1)])):$("",!0),s("div",Kw,[s("button",{onClick:e[7]||(e[7]=(...n)=>t.handleExport&&t.handleExport(...n)),disabled:t.exporting||!t.canExport,class:"btn-primary"},[t.exporting?(c(),u("span",Yw,"Экспорт...")):(c(),u("span",Xw,"Экспортировать"))],8,qw),s("button",{onClick:e[8]||(e[8]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),disabled:t.exporting,class:"btn-secondary"}," Отмена ",8,Jw)])])])):$("",!0)]),_:1})])}const Qw=ce(bw,[["render",Zw],["__scopeId","data-v-7ae66f8c"]]),eC={name:"WebhookLogSearch",props:{modelValue:{type:String,default:""}},emits:["update:modelValue","search"],setup(o,{emit:e}){const a=M(o.modelValue||""),t=M(!1),r=M(null),i=Tu(p=>{t.value=!1,e("search",p)},400),n=()=>{t.value=!0,e("update:modelValue",a.value),i(a.value)},l=()=>{t.value=!1,e("search",a.value)},d=()=>{a.value="",t.value=!1,r.value=null,e("update:modelValue",""),e("search","")};return Ne(()=>o.modelValue,p=>{p!==a.value&&(a.value=p)}),{searchQuery:a,isSearching:t,searchResultsCount:r,handleSearchInput:n,handleSearch:l,clearSearch:d,setResultsCount:p=>{r.value=p},getResultsText:p=>{const y=p%10,S=p%100;return S>=11&&S<=19?"записей":y===1?"запись":y>=2&&y<=4?"записи":"записей"},performSearch:(p,y)=>{if(!p||!y||!Array.isArray(y))return[];const S=p.toLowerCase().trim();return S.length===0?y:y.map(k=>jt(k)).filter(k=>gt(k)).filter(k=>{if(k.event&&k.event.toLowerCase().includes(S)||k.category&&k.category.toLowerCase().includes(S)||k.ip&&k.ip.toLowerCase().includes(S)||k.details&&typeof k.details=="object"&&(k.details.task_id&&String(k.details.task_id).includes(S)||k.details.task_title&&k.details.task_title.toLowerCase().includes(S)||k.details.entity_id&&String(k.details.entity_id).includes(S)||k.details.title&&k.details.title.toLowerCase().includes(S)||k.details.comment_text&&k.details.comment_text.toLowerCase().includes(S)))return!0;if(k.payload&&typeof k.payload=="object")try{if(JSON.stringify(k.payload).toLowerCase().includes(S))return!0}catch{}return!1})},formatSearchResult:p=>{const y=[];if(p.event&&y.push(Vt(p.event)),p.category&&y.push(bt(p.category)),p.details){const S=Ka(p.details);S!=="—"&&y.push(S)}return y.join(" • ")}}}},tC={class:"webhook-search"},aC={class:"search-wrapper"},sC={key:0,class:"search-indicator"},oC={key:1,class:"search-results"};function nC(o,e,a,t,r,i){return c(),u("div",tC,[s("div",aC,[e[5]||(e[5]=s("span",{class:"search-icon"},"🔍",-1)),Re(s("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>t.searchQuery=n),type:"text",placeholder:"Поиск по содержимому логов (событие, payload, IP, детали)...",class:"search-input",onInput:e[1]||(e[1]=(...n)=>t.handleSearchInput&&t.handleSearchInput(...n)),onKeyup:[e[2]||(e[2]=Be((...n)=>t.handleSearch&&t.handleSearch(...n),["enter"])),e[3]||(e[3]=Be((...n)=>t.clearSearch&&t.clearSearch(...n),["esc"]))]},null,544),[[At,t.searchQuery]]),t.searchQuery?(c(),u("button",{key:0,onClick:e[4]||(e[4]=(...n)=>t.clearSearch&&t.clearSearch(...n)),class:"clear-button",title:"Очистить поиск (Esc)","aria-label":"Очистить поиск"}," ✕ ")):$("",!0)]),t.isSearching?(c(),u("div",sC,[...e[6]||(e[6]=[s("span",{class:"spinner"},null,-1),ge(" Поиск... ",-1)])])):$("",!0),t.searchQuery&&t.searchResultsCount!==null?(c(),u("div",oC," Найдено: "+m(t.searchResultsCount)+" "+m(t.getResultsText(t.searchResultsCount)),1)):$("",!0)])}const rC=ce(eC,[["render",nC],["__scopeId","data-v-db228863"]]);function iC(o,e=null){const a=()=>{try{const n=localStorage.getItem(o);return n?JSON.parse(n):e}catch(n){return console.error(`Error loading ${o} from localStorage:`,n),e}},t=n=>{try{localStorage.setItem(o,JSON.stringify(n))}catch(l){console.error(`Error saving ${o} to localStorage:`,l)}},r=()=>{try{localStorage.removeItem(o)}catch(n){console.error(`Error clearing ${o} from localStorage:`,n)}},i=M(a());return Ne(i,n=>{t(n)},{deep:!0}),{value:i,save:t,load:a,clear:r}}const lC={name:"WebhookLogFilters",props:{filters:{type:Object,required:!0}},emits:["update:filters","reset"],setup(o,{emit:e}){const a=M(null),t=iC("webhook-filters",{category:null,event:null,dateFrom:null,dateTo:null,hour:null,ip:null,status:null}),r=E=>(a.value=null,Oa(E)?(e("update:filters",E),!0):(a.value="Некорректные параметры фильтрации",console.error("[WebhookLogFilters] Validation error:",a.value),!1)),i=new Date().toISOString().split("T")[0],n=M({category:t.value.category||o.filters.category||null,event:t.value.event||o.filters.event||null,dateFrom:t.value.dateFrom||o.filters.dateFrom||o.filters.date||i,dateTo:t.value.dateTo||o.filters.dateTo||null,hour:t.value.hour!==void 0?t.value.hour:o.filters.hour!==void 0?o.filters.hour:null,ip:t.value.ip||o.filters.ip||null,status:t.value.status||o.filters.status||null}),l=M(null),d=[{id:"today",label:"Сегодня",getDates:()=>({from:i,to:i})},{id:"yesterday",label:"Вчера",getDates:()=>{const E=new Date;E.setDate(E.getDate()-1);const L=E.toISOString().split("T")[0];return{from:L,to:L}}},{id:"last7days",label:"Последние 7 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-7),{from:E.toISOString().split("T")[0],to:i}}},{id:"last30days",label:"Последние 30 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-30),{from:E.toISOString().split("T")[0],to:i}}}],g=E=>{const L=d.find(R=>R.id===E);if(L){const R=L.getDates();n.value.dateFrom=R.from,n.value.dateTo=R.to,l.value=E,x()}};Ne(()=>o.filters,E=>{n.value={category:E.category||null,event:E.event||null,dateFrom:E.dateFrom||E.date||i,dateTo:E.dateTo||null,hour:E.hour!==void 0?E.hour:null,ip:E.ip||null,status:E.status||null}},{deep:!0}),Ne(n,E=>{t.value={...E},e("update:filters",{...E})},{deep:!0});const v=I(()=>{const E={};return n.value.category&&(E.category=n.value.category),n.value.event&&(E.event=n.value.event),n.value.hour!==null&&(E.hour=n.value.hour),n.value.ip&&(E.ip=n.value.ip),n.value.status&&(E.status=n.value.status),n.value.dateFrom&&n.value.dateFrom!==i&&(E.dateFrom=n.value.dateFrom),n.value.dateTo&&(E.dateTo=n.value.dateTo),E}),C=I(()=>Object.keys(v.value).length>0),f=E=>({category:"Категория",event:"Событие",hour:"Час",ip:"IP адрес",status:"Статус",dateFrom:"Дата от",dateTo:"Дата до"})[E]||E,p=(E,L)=>E==="category"?bt(L)||L:E==="hour"?`${String(L).padStart(2,"0")}:00`:E==="event"?Vt(L)||L:E==="status"&&{success:"Успешно",error:"Ошибка",warning:"Предупреждение"}[L]||L,y=I(()=>[{value:null,label:"Все категории"},{value:"tasks",label:bt("tasks")},{value:"smart-processes",label:bt("smart-processes")},{value:"errors",label:bt("errors")}]),S=I(()=>[{value:null,label:"Все события"},...["ONTASKADD","ONTASKUPDATE","ONTASKDELETE","ONTASKCOMMENTADD","ONTASKCOMMENTUPDATE","ONTASKCOMMENTDELETE","ONCRMDYNAMICITEMADD","ONCRMDYNAMICITEMUPDATE","ONCRMDYNAMICITEMDELETE"].map(L=>({value:L,label:Vt(L)}))]),T=E=>{E==="hour"?n.value[E]=null:E==="dateFrom"?n.value[E]=i:n.value[E]=null,l.value=null},k=E=>{const L={...n.value,category:E||null};r(L)&&(n.value.category=E)},_=E=>{const L={...n.value,event:E||null};r(L)&&(n.value.event=E)},A=(E,L)=>{if(E&&!/^\d{4}-\d{2}-\d{2}$/.test(E)){console.error("[WebhookLogFilters] Invalid date format:",E),a.value="Некорректный формат даты";return}const R={...n.value,[L]:E||null};r(R)&&(n.value[L]=E)},U=E=>{if(E!=null){const R=parseInt(E,10);if(isNaN(R)||R<0||R>23){console.error("[WebhookLogFilters] Invalid hour:",E),a.value="Некорректный час (должен быть от 0 до 23)";return}}const L={...n.value,hour:E!=null?parseInt(E,10):null};r(L)&&(n.value.hour=E!=null?parseInt(E,10):null)},x=()=>{r({...n.value})},D=()=>{n.value={category:null,event:null,dateFrom:i,dateTo:null,hour:null,ip:null,status:null},l.value=null,t.clear(),e("reset")};return $e(()=>{t.value&&Object.keys(t.value).length>0&&e("update:filters",{...t.value})}),{localFilters:n,activeFilters:v,hasActiveFilters:C,getFilterLabel:f,getFilterValue:p,clearFilter:T,handleFilterChange:x,handleCategoryChange:k,handleEventChange:_,handleDateChange:A,handleHourChange:U,handleReset:D,quickFilters:d,activeQuickFilter:l,applyQuickFilter:g,categoryOptions:y,eventOptions:S,validationError:a}}},cC={class:"webhook-log-filters"},dC={key:0,class:"active-filters-indicator"},uC=["onClick"],gC={key:1,class:"validation-error"},mC={class:"quick-filters"},hC=["onClick"],fC={class:"filters-row"},vC={class:"filter-group"},pC=["value"],yC={class:"filter-group"},kC=["value"],bC={class:"filter-group"},_C={class:"filter-group"},wC={class:"filter-group"},CC={class:"filter-group"},TC={class:"filter-group"};function SC(o,e,a,t,r,i){return c(),u("div",cC,[t.hasActiveFilters?(c(),u("div",dC,[e[14]||(e[14]=s("span",{class:"indicator-text"},"Активные фильтры:",-1)),(c(!0),u(ee,null,te(t.activeFilters,(n,l)=>(c(),u("span",{key:l,class:"filter-badge"},[ge(m(t.getFilterLabel(l))+": "+m(t.getFilterValue(l,n))+" ",1),s("button",{onClick:d=>t.clearFilter(l),class:"filter-badge-remove",title:"Удалить фильтр"}," × ",8,uC)]))),128)),s("button",{onClick:e[0]||(e[0]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-clear-all"}," Очистить все ")])):$("",!0),t.validationError?(c(),u("div",gC," ⚠️ "+m(t.validationError),1)):$("",!0),s("div",mC,[e[15]||(e[15]=s("span",{class:"quick-filters-label"},"Быстрые фильтры:",-1)),(c(!0),u(ee,null,te(t.quickFilters,n=>(c(),u("button",{key:n.id,onClick:l=>t.applyQuickFilter(n.id),class:X(["quick-filter-btn",{active:t.activeQuickFilter===n.id}])},m(n.label),11,hC))),128))]),s("div",fC,[s("div",vC,[e[16]||(e[16]=s("label",{for:"category-filter"},"Категория:",-1)),Re(s("select",{id:"category-filter","onUpdate:modelValue":e[1]||(e[1]=n=>t.localFilters.category=n),onChange:e[2]||(e[2]=n=>t.handleCategoryChange(t.localFilters.category)),class:"filter-select"},[(c(!0),u(ee,null,te(t.categoryOptions,n=>(c(),u("option",{key:n.value,value:n.value},m(n.label),9,pC))),128))],544),[[dt,t.localFilters.category]])]),s("div",yC,[e[17]||(e[17]=s("label",{for:"event-filter"},"Тип события:",-1)),Re(s("select",{id:"event-filter","onUpdate:modelValue":e[3]||(e[3]=n=>t.localFilters.event=n),onChange:e[4]||(e[4]=n=>t.handleEventChange(t.localFilters.event)),class:"filter-select"},[(c(!0),u(ee,null,te(t.eventOptions,n=>(c(),u("option",{key:n.value,value:n.value},m(n.label),9,kC))),128))],544),[[dt,t.localFilters.event]])]),s("div",bC,[e[18]||(e[18]=s("label",{for:"date-from-filter"},"Дата от:",-1)),Re(s("input",{id:"date-from-filter","onUpdate:modelValue":e[5]||(e[5]=n=>t.localFilters.dateFrom=n),type:"date",onChange:e[6]||(e[6]=n=>t.handleDateChange(t.localFilters.dateFrom,"dateFrom")),class:"filter-input"},null,544),[[At,t.localFilters.dateFrom]])]),s("div",_C,[e[19]||(e[19]=s("label",{for:"date-to-filter"},"Дата до:",-1)),Re(s("input",{id:"date-to-filter","onUpdate:modelValue":e[7]||(e[7]=n=>t.localFilters.dateTo=n),type:"date",onChange:e[8]||(e[8]=n=>t.handleDateChange(t.localFilters.dateTo,"dateTo")),class:"filter-input"},null,544),[[At,t.localFilters.dateTo]])]),s("div",wC,[e[20]||(e[20]=s("label",{for:"ip-filter"},"IP адрес:",-1)),Re(s("input",{id:"ip-filter","onUpdate:modelValue":e[9]||(e[9]=n=>t.localFilters.ip=n),type:"text",placeholder:"192.168.1.1",onInput:e[10]||(e[10]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-input"},null,544),[[At,t.localFilters.ip]])]),s("div",CC,[e[22]||(e[22]=s("label",{for:"status-filter"},"Статус:",-1)),Re(s("select",{id:"status-filter","onUpdate:modelValue":e[11]||(e[11]=n=>t.localFilters.status=n),onChange:e[12]||(e[12]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-select"},[...e[21]||(e[21]=[s("option",{value:null},"Все статусы",-1),s("option",{value:"success"},"Успешно",-1),s("option",{value:"error"},"Ошибка",-1),s("option",{value:"warning"},"Предупреждение",-1)])],544),[[dt,t.localFilters.status]])]),s("div",TC,[s("button",{onClick:e[13]||(e[13]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-reset"}," Сбросить ")])])])}const DC=ce(lC,[["render",SC],["__scopeId","data-v-2a150a46"]]),EC={name:"WebhookLogList",props:{logs:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},error:{type:String,default:null},pagination:{type:Object,default:null},selectedLogs:{type:Array,default:()=>[]}},emits:["select-log","page-change","update:selectedLogs"],setup(o,{emit:e}){const a=I(()=>!o.logs||!Array.isArray(o.logs)?(console.warn("[WebhookLogList] Invalid logs prop:",o.logs),[]):o.logs.map(L=>jt(L)).filter(L=>gt(L)?!0:(console.warn("[WebhookLogList] Invalid log entry:",L),!1))),t=M("timestamp"),r=M("desc"),i=L=>{t.value===L?r.value=r.value==="asc"?"desc":"asc":(t.value=L,r.value="desc")},n=I(()=>!a.value||a.value.length===0?[]:[...a.value].sort((R,W)=>{let G,q;switch(t.value){case"timestamp":G=new Date(R.timestamp||0).getTime(),q=new Date(W.timestamp||0).getTime();break;case"event":G=(R.event||"").toLowerCase(),q=(W.event||"").toLowerCase();break;case"category":G=(R.category||"").toLowerCase(),q=(W.category||"").toLowerCase();break;case"ip":G=(R.ip||"").toLowerCase(),q=(W.ip||"").toLowerCase();break;default:return 0}return G<q?r.value==="asc"?-1:1:G>q?r.value==="asc"?1:-1:0})),l=L=>t.value!==L?"↕️":r.value==="asc"?"↑":"↓",d=L=>L.category==="errors"?"status-error":"status-success",g=L=>L.category==="errors"?"❌":"✅",v=L=>L.category==="errors"?"Ошибка обработки":"Успешно обработано",C=L=>`${L.timestamp}_${L.event}_${L.ip||"unknown"}`,f=L=>L?Ga(L,"short"):"—",p=L=>L?Vt(L):"—",y=L=>L?bt(L):"—",S=L=>!L||typeof L!="object"?"—":Ka(L),T=L=>`category-${L}`,k=L=>L?.startsWith("ONTASK")?"event-task":L?.startsWith("ONCRMDYNAMIC")?"event-smart-process":"event-other",_=L=>{e("select-log",L)},A=L=>{L>=1&&L<=o.pagination.pages&&e("page-change",L)},U=L=>o.selectedLogs.some(R=>C(R)===C(L)),x=(L,R)=>{R.stopPropagation();const W=[...o.selectedLogs],G=C(L),q=W.findIndex(oe=>C(oe)===G);R.target.checked?q===-1&&W.push(L):q!==-1&&W.splice(q,1),e("update:selectedLogs",W)},D=L=>{L.target.checked?e("update:selectedLogs",[...o.logs]):e("update:selectedLogs",[])},E=I(()=>a.value.length>0&&a.value.every(L=>U(L)));return Ne(()=>o.logs,L=>{if(L&&Array.isArray(L)){const R=L.filter(W=>!gt(W)).length;R>0&&console.warn(`[WebhookLogList] Received ${R} invalid log entries out of ${L.length}`)}},{immediate:!0}),{validatedLogs:a,sortBy:t,sortOrder:r,sortedLogs:n,handleSort:i,getSortIcon:l,getStatusClass:d,getStatusIcon:g,getStatusTitle:v,getLogId:C,formatTimestamp:f,formatEvent:p,formatCategoryLabel:y,formatDetailsPreview:S,getCategoryClass:T,getEventClass:k,handleLogClick:_,handlePageChange:A,isSelected:U,handleSelectLog:x,handleSelectAll:D,allSelected:E}}},AC={class:"webhook-log-list"},$C={key:0,class:"logs-table-container"},IC={class:"logs-table"},MC={class:"checkbox-header"},NC=["checked"],xC={class:"sort-icon"},LC={class:"sort-icon"},PC={class:"sort-icon"},OC={class:"sort-icon"},RC=["onClick"],BC=["checked","onChange"],UC=["title"],WC={class:"details-preview"},FC=["onClick"],HC={key:0,class:"pagination"},jC=["disabled"],VC={class:"pagination-info"},zC=["disabled"];function GC(o,e,a,t,r,i){return c(),u("div",AC,[a.logs.length>0?(c(),u("div",$C,[s("table",IC,[s("thead",null,[s("tr",null,[s("th",MC,[s("input",{type:"checkbox",checked:t.allSelected,onChange:e[0]||(e[0]=(...n)=>t.handleSelectAll&&t.handleSelectAll(...n)),onClick:e[1]||(e[1]=Te(()=>{},["stop"])),class:"checkbox-input",title:"Выбрать все"},null,40,NC)]),s("th",{onClick:e[2]||(e[2]=n=>t.handleSort("timestamp")),class:X(["sortable",{"sort-asc":t.sortBy==="timestamp"&&t.sortOrder==="asc","sort-desc":t.sortBy==="timestamp"&&t.sortOrder==="desc"}])},[e[9]||(e[9]=ge(" Дата и время ",-1)),s("span",xC,m(t.getSortIcon("timestamp")),1)],2),s("th",{onClick:e[3]||(e[3]=n=>t.handleSort("event")),class:X(["sortable",{"sort-asc":t.sortBy==="event"&&t.sortOrder==="asc","sort-desc":t.sortBy==="event"&&t.sortOrder==="desc"}])},[e[10]||(e[10]=ge(" Тип события ",-1)),s("span",LC,m(t.getSortIcon("event")),1)],2),s("th",{onClick:e[4]||(e[4]=n=>t.handleSort("category")),class:X(["sortable",{"sort-asc":t.sortBy==="category"&&t.sortOrder==="asc","sort-desc":t.sortBy==="category"&&t.sortOrder==="desc"}])},[e[11]||(e[11]=ge(" Категория ",-1)),s("span",PC,m(t.getSortIcon("category")),1)],2),s("th",{onClick:e[5]||(e[5]=n=>t.handleSort("ip")),class:X(["sortable",{"sort-asc":t.sortBy==="ip"&&t.sortOrder==="asc","sort-desc":t.sortBy==="ip"&&t.sortOrder==="desc"}])},[e[12]||(e[12]=ge(" IP ",-1)),s("span",OC,m(t.getSortIcon("ip")),1)],2),e[13]||(e[13]=s("th",null,"Детали",-1)),e[14]||(e[14]=s("th",null,"Действия",-1))])]),s("tbody",null,[(c(!0),u(ee,null,te(t.sortedLogs,n=>(c(),u("tr",{key:t.getLogId(n),onClick:l=>t.handleLogClick(n),class:X(["log-row",{"row-selected":t.isSelected(n)}])},[s("td",{onClick:e[6]||(e[6]=Te(()=>{},["stop"]))},[s("input",{type:"checkbox",checked:t.isSelected(n),onChange:l=>t.handleSelectLog(n,l),class:"checkbox-input"},null,40,BC)]),s("td",null,m(t.formatTimestamp(n.timestamp)),1),s("td",null,[s("span",{class:X(["status-indicator",t.getStatusClass(n)]),title:t.getStatusTitle(n)},m(t.getStatusIcon(n)),11,UC),s("span",{class:X(["event-badge",t.getEventClass(n.event)])},m(t.formatEvent(n.event)),3)]),s("td",null,[s("span",{class:X(["category-badge",t.getCategoryClass(n.category)])},m(t.formatCategoryLabel(n.category)),3)]),s("td",null,m(n.ip||"N/A"),1),s("td",null,[s("div",WC,m(t.formatDetailsPreview(n.details)),1)]),s("td",null,[s("button",{onClick:Te(l=>t.handleLogClick(n),["stop"]),class:"btn-view"}," Просмотр ",8,FC)])],10,RC))),128))])]),a.pagination&&a.pagination.pages>1?(c(),u("div",HC,[s("button",{onClick:e[7]||(e[7]=n=>t.handlePageChange(a.pagination.page-1)),disabled:a.pagination.page<=1,class:"btn-pagination"}," Назад ",8,jC),s("span",VC," Страница "+m(a.pagination.page)+" из "+m(a.pagination.pages)+" (всего: "+m(a.pagination.total)+") ",1),s("button",{onClick:e[8]||(e[8]=n=>t.handlePageChange(a.pagination.page+1)),disabled:a.pagination.page>=a.pagination.pages,class:"btn-pagination"}," Вперёд ",8,zC)])):$("",!0)])):$("",!0)])}const KC=ce(EC,[["render",GC],["__scopeId","data-v-fddd3018"]]),qC={name:"LoadingSkeleton",props:{width:{type:[String,Number],default:"100%"},height:{type:[String,Number],default:"20px"},variant:{type:String,default:"rect",validator:o=>["rect","circle","text","table-row"].includes(o)},animated:{type:Boolean,default:!0},borderRadius:{type:String,default:null}},setup(o){return{skeletonStyle:I(()=>{const a={width:typeof o.width=="number"?`${o.width}px`:o.width,height:typeof o.height=="number"?`${o.height}px`:o.height};return o.borderRadius&&(a.borderRadius=o.borderRadius),a})}}},YC={key:0,class:"skeleton-shimmer"};function XC(o,e,a,t,r,i){return c(),u("div",{class:X(["skeleton",[`skeleton-${a.variant}`,{"skeleton-animated":a.animated}]]),style:we(t.skeletonStyle)},[a.animated?(c(),u("div",YC)):$("",!0)],6)}const JC=ce(qC,[["render",XC],["__scopeId","data-v-014f86e6"]]),ZC={name:"SkeletonLogList",components:{LoadingSkeleton:JC},props:{rows:{type:Number,default:5}},setup(){return{getColumnWidth:e=>["40px","15%","20%","15%","15%","20%","15%"][e-1]||"100%"}}},QC={class:"skeleton-log-list"},eT={class:"skeleton-table-header"};function tT(o,e,a,t,r,i){const n=be("LoadingSkeleton");return c(),u("div",QC,[s("div",eT,[(c(),u(ee,null,te(7,l=>ne(n,{key:l,width:"120px",height:"16px",variant:"text"})),64))]),(c(!0),u(ee,null,te(a.rows,l=>(c(),u("div",{key:l,class:"skeleton-table-row"},[(c(),u(ee,null,te(7,d=>ne(n,{key:d,width:"100%",height:"20px",variant:"text",style:we({width:t.getColumnWidth(d)})},null,8,["style"])),64))]))),128))])}const aT=ce(ZC,[["render",tT],["__scopeId","data-v-475c4e73"]]),sT={name:"EmptyState",props:{icon:{type:String,default:"📭"},title:{type:String,required:!0},description:{type:String,required:!0},actionLabel:{type:String,default:null},actions:{type:Array,default:null},hints:{type:Array,default:()=>[]},variant:{type:String,default:"default",validator:o=>["default","error","warning","info"].includes(o)}},emits:["action","action-click"]},oT={class:"empty-icon"},nT={class:"empty-title"},rT={class:"empty-description"},iT={key:0,class:"empty-hints"},lT={key:1,class:"empty-actions"},cT=["onClick"];function dT(o,e,a,t,r,i){return c(),u("div",{class:X(["empty-state",`empty-state-${a.variant}`])},[s("div",oT,m(a.icon),1),s("h3",nT,m(a.title),1),s("p",rT,m(a.description),1),a.hints&&a.hints.length>0?(c(),u("div",iT,[(c(!0),u(ee,null,te(a.hints,(n,l)=>(c(),u("div",{key:l,class:"hint-item"}," 💡 "+m(n),1))),128))])):$("",!0),a.actionLabel||a.actions?(c(),u("div",lT,[a.actionLabel?(c(),u("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("action")),class:"btn-primary"},m(a.actionLabel),1)):$("",!0),(c(!0),u(ee,null,te(a.actions,(n,l)=>(c(),u("button",{key:l,onClick:d=>o.$emit("action-click",n.id),class:X(["btn",`btn-${n.variant||"secondary"}`])},m(n.label),11,cT))),128))])):$("",!0)],2)}const uT=ce(sT,[["render",dT],["__scopeId","data-v-081c13b9"]]),gT={name:"ErrorDisplay",props:{title:{type:String,default:"Произошла ошибка"},message:{type:String,required:!0},details:{type:String,default:null},severity:{type:String,default:"error",validator:o=>["error","warning","critical"].includes(o)},retryable:{type:Boolean,default:!1}},emits:["retry"],setup(){return{showDetails:M(!1)}}},mT={class:"error-icon"},hT={class:"error-content"},fT={class:"error-title"},vT={class:"error-message"},pT={key:0,class:"error-details"},yT={class:"error-actions"};function kT(o,e,a,t,r,i){return c(),u("div",{class:X(["error-display",`error-${a.severity}`])},[s("div",mT,m(a.severity==="critical"?"🚨":"⚠️"),1),s("div",hT,[s("h4",fT,m(a.title),1),s("p",vT,m(a.message),1),a.details&&t.showDetails?(c(),u("div",pT,[s("pre",null,m(a.details),1)])):$("",!0),s("div",yT,[a.retryable?(c(),u("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("retry")),class:"btn-retry"}," 🔄 Повторить ")):$("",!0),a.details?(c(),u("button",{key:1,onClick:e[1]||(e[1]=n=>t.showDetails=!t.showDetails),class:"btn-details"},m(t.showDetails?"Скрыть":"Показать")+" детали ",1)):$("",!0)])])],2)}const bT=ce(gT,[["render",kT],["__scopeId","data-v-3f2f4c14"]]),_T={name:"Notification",props:{notification:{type:Object,required:!0}},emits:["close"],setup(o,{emit:e}){const a=M(100),t=I(()=>o.notification.duration>0);let r=null;const i={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},n=I(()=>i[o.notification.type]||"ℹ️"),l=()=>{e("close")},d=()=>{o.notification.onClick&&o.notification.onClick()};return $e(()=>{if(t.value&&o.notification.duration>0){const g=Date.now(),v=o.notification.duration;r=setInterval(()=>{const C=Date.now()-g;a.value=Math.max(0,100-C/v*100),a.value<=0&&(clearInterval(r),l())},50)}}),at(()=>{r&&clearInterval(r)}),{icon:n,progress:a,showProgress:t,close:l,handleClick:d}}},wT={class:"notification-content"},CT={class:"notification-icon"},TT={class:"notification-message"},ST={key:0,class:"notification-progress"};function DT(o,e,a,t,r,i){return c(),u("div",{class:X(["notification",`notification-${a.notification.type}`]),onClick:e[1]||(e[1]=(...n)=>t.handleClick&&t.handleClick(...n))},[s("div",wT,[s("span",CT,m(t.icon),1),s("span",TT,m(a.notification.message),1)]),s("button",{onClick:e[0]||(e[0]=Te((...n)=>t.close&&t.close(...n),["stop"])),class:"notification-close"},"✕"),t.showProgress?(c(),u("div",ST,[s("div",{class:"progress-bar",style:we({width:`${t.progress}%`})},null,4)])):$("",!0)],2)}const ET=ce(_T,[["render",DT],["__scopeId","data-v-1b602bdf"]]),AT={name:"NotificationContainer",components:{Notification:ET},setup(){const{notifications:o,removeNotification:e}=mt();return{notifications:o,removeNotification:e}}},$T={class:"notification-container"};function IT(o,e,a,t,r,i){const n=be("Notification");return c(),he(It,{to:"body"},[s("div",$T,[ne(Qe,{name:"notification",tag:"div"},{default:ye(()=>[(c(!0),u(ee,null,te(t.notifications,l=>(c(),he(n,{key:l.id,notification:l,onClose:d=>t.removeNotification(l.id)},null,8,["notification","onClose"]))),128))]),_:1})])])}const MT=ce(AT,[["render",IT],["__scopeId","data-v-dd8772c8"]]),NT={name:"RealtimeControls",props:{enabled:{type:Boolean,default:!1},connectionState:{type:String,default:"disconnected"},error:{type:String,default:null}},emits:["toggle"],setup(o,{emit:e}){const a=M(o.enabled);Ne(()=>o.enabled,C=>{a.value=C});const t=I(()=>o.connectionState==="connecting"),r=I(()=>!!o.error),i=I(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),n=I(()=>{switch(o.connectionState){case"connected":return"Подключено";case"connecting":return"Подключение...";case"disconnected":return"Отключено";case"error":return"Ошибка соединения";default:return"Неизвестное состояние"}}),l=I(()=>n.value),d=I(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),g=I(()=>o.error?typeof o.error=="string"?o.error:o.error.message?o.error.message:"Неизвестная ошибка":null);return{localEnabled:a,isConnecting:t,hasError:r,statusClass:i,statusText:n,connectionStatusText:l,connectionStatusClass:d,displayError:g,handleToggle:()=>{e("toggle",a.value)}}}},xT={class:"realtime-controls"},LT={class:"control-toggle"},PT=["disabled"],OT={class:"status-text"},RT={key:0,class:"error-message"};function BT(o,e,a,t,r,i){return c(),u("div",xT,[s("label",LT,[Re(s("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=n=>t.localEnabled=n),onChange:e[1]||(e[1]=(...n)=>t.handleToggle&&t.handleToggle(...n)),disabled:t.isConnecting},null,40,PT),[[ka,t.localEnabled]]),e[2]||(e[2]=s("span",{class:"toggle-label"},"Автообновление",-1))]),s("div",{class:X(["status-indicator",t.statusClass])},[e[3]||(e[3]=s("span",{class:"status-dot"},null,-1)),s("span",OT,m(t.statusText),1)],2),t.hasError&&t.displayError?(c(),u("div",RT," ⚠️ "+m(t.displayError),1)):$("",!0)])}const UT=ce(NT,[["render",BT],["__scopeId","data-v-af36f073"]]),WT={name:"NewLogsIndicator",props:{count:{type:Number,default:0},newLogs:{type:Array,default:()=>[]}},emits:["apply","dismiss"],setup(o,{emit:e}){const a=(n,l,d,g)=>{const v=n%10,C=n%100;return C>=11&&C<=19?g:v===1?l:v>=2&&v<=4?d:g},t=I(()=>!o.newLogs||!Array.isArray(o.newLogs)||o.newLogs.length===0?[]:o.newLogs.map(l=>jt(l)).filter(l=>gt(l)).slice(0,5).map(l=>({...l,formatted:{event:Vt(l.event),category:bt(l.category)}})));return{pluralize:a,newLogsPreview:t,handleApply:()=>{if(!o.newLogs||o.newLogs.length===0)return;const n=o.newLogs.map(l=>jt(l)).filter(l=>gt(l));if(n.length===0){console.warn("[NewLogsIndicator] No valid logs to apply");return}e("apply",n)},handleDismiss:()=>{e("dismiss")}}}},FT={key:0,class:"new-logs-indicator"},HT={class:"indicator-content"},jT={class:"indicator-text"},VT={class:"indicator-actions"};function zT(o,e,a,t,r,i){return c(),he(Ae,{name:"slide-down"},{default:ye(()=>[a.count>0?(c(),u("div",FT,[s("div",HT,[e[2]||(e[2]=s("span",{class:"indicator-icon"},"🔔",-1)),s("span",jT,m(a.count)+" "+m(t.pluralize(a.count,"новое событие","новых события","новых событий")),1),s("div",VT,[s("button",{onClick:e[0]||(e[0]=(...n)=>t.handleApply&&t.handleApply(...n)),class:"btn-apply"}," Применить "),s("button",{onClick:e[1]||(e[1]=(...n)=>t.handleDismiss&&t.handleDismiss(...n)),class:"btn-dismiss"}," ✕ ")])])])):$("",!0)]),_:1})}const GT=ce(WT,[["render",zT],["__scopeId","data-v-19791dbc"]]);class KT{constructor(e,a={}){this.url=e,this.options={reconnectInterval:3e3,maxReconnectAttempts:10,reconnectDelay:1e3,lastTimestamp:null,...a},this.eventSource=null,this.listeners=new Map,this.reconnectAttempts=0,this.reconnectTimer=null,this.isManualDisconnect=!1,this.connectionState="disconnected"}updateOptions(e){this.options={...this.options,...e}}connect(){if(this.connectionState==="connected"||this.connectionState==="connecting"){console.warn("[RealtimeService] Already connected or connecting");return}this.isManualDisconnect=!1,this.connectionState="connecting",this.notifyListeners("state-change",{state:this.connectionState});try{let e=this.url;if(!e.startsWith("http://")&&!e.startsWith("https://")){const a=new URL(e,window.location.origin);this.options.lastTimestamp&&a.searchParams.set("last_timestamp",this.options.lastTimestamp),e=a.toString()}else{const a=new URL(e);this.options.lastTimestamp&&a.searchParams.set("last_timestamp",this.options.lastTimestamp),e=a.toString()}console.log("[RealtimeService] Connecting to:",e),this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{console.log("[RealtimeService] EventSource opened"),this.notifyListeners("open",{timestamp:new Date().toISOString()})},this.eventSource.onmessage=a=>{try{const t=JSON.parse(a.data);this.notifyListeners("message",t)}catch(t){console.error("[RealtimeService] Error parsing message:",t)}},this.eventSource.addEventListener("connected",a=>{try{const t=JSON.parse(a.data);console.log("[RealtimeService] Connected event received:",t),this.connectionState="connected",this.reconnectAttempts=0,this.notifyListeners("connected",t),this.notifyListeners("state-change",{state:this.connectionState})}catch(t){console.error("[RealtimeService] Error parsing connected event:",t)}}),this.eventSource.addEventListener("new_logs",a=>{const t=JSON.parse(a.data);if(t.logs&&t.logs.length>0){const r=t.logs[t.logs.length-1];r.timestamp&&(this.options.lastTimestamp=r.timestamp)}this.notifyListeners("new_logs",t)}),this.eventSource.addEventListener("error",a=>{try{const t=JSON.parse(a.data);this.notifyListeners("error",t)}catch{this.notifyListeners("error",{message:"Server error"})}}),this.eventSource.addEventListener("timeout",a=>{try{const t=JSON.parse(a.data);this.notifyListeners("timeout",t)}catch{this.notifyListeners("timeout",{message:"Connection timeout"})}this.reconnect()}),this.eventSource.addEventListener("closed",a=>{try{const t=JSON.parse(a.data);this.notifyListeners("closed",t)}catch{this.notifyListeners("closed",{message:"Connection closed"})}this.isManualDisconnect||this.reconnect()}),this.eventSource.onerror=a=>{console.error("[RealtimeService] Connection error:",a),console.error("[RealtimeService] EventSource readyState:",this.eventSource?.readyState),this.eventSource?.readyState===EventSource.CLOSED?(console.log("[RealtimeService] EventSource closed by server"),this.connectionState="disconnected",this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()):this.eventSource?.readyState===EventSource.CONNECTING?console.log("[RealtimeService] Still connecting..."):(this.connectionState="error",this.notifyListeners("error",{error:a,type:"connection",message:"Failed to connect to realtime stream",readyState:this.eventSource?.readyState}),this.notifyListeners("state-change",{state:this.connectionState}),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.isManualDisconnect||this.reconnect())}}catch(e){console.error("[RealtimeService] Error creating EventSource:",e),this.connectionState="error",this.notifyListeners("error",{error:e,type:"initialization"}),this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()}}reconnect(){if(this.isManualDisconnect)return;if(this.reconnectAttempts>=this.options.maxReconnectAttempts){console.error("[RealtimeService] Max reconnect attempts reached"),this.notifyListeners("max-reconnect-attempts",{attempts:this.reconnectAttempts});return}this.reconnectAttempts++;const e=Math.min(this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),this.options.reconnectInterval);console.log(`[RealtimeService] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.connect()},e)}disconnect(){this.isManualDisconnect=!0,this.connectionState="disconnected",this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.notifyListeners("disconnected",{timestamp:new Date().toISOString()}),this.notifyListeners("state-change",{state:this.connectionState})}on(e,a){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(a)}off(e,a){if(this.listeners.has(e)){const t=this.listeners.get(e),r=t.indexOf(a);r>-1&&t.splice(r,1)}}notifyListeners(e,a){this.listeners.has(e)&&this.listeners.get(e).forEach(t=>{try{t(a)}catch(r){console.error(`[RealtimeService] Error in listener for ${e}:`,r)}})}getState(){return this.connectionState}isConnected(){return this.connectionState==="connected"}}function qT(o,e={}){const{autoConnect:a=!1,enableSound:t=!1,onNewLogs:r=null,validateLogs:i=!0}=e,n=new KT(o,e),l=M("disconnected"),d=M([]),g=M(0),v=M(null),C=M(null),f=M(0),p=I(()=>l.value==="connected"),y=I(()=>l.value==="connecting"),S=I(()=>l.value==="error"),T=I(()=>g.value>0),k=G=>{l.value=G.state,G.state==="connected"&&(f.value=0,C.value=null)},_=G=>{let q=G.logs||[];if(i){q=za(q);const oe=q.filter(Y=>gt(Y));oe.length!==q.length&&console.warn("[useRealtime] Filtered out invalid logs:",q.length-oe.length),q=oe}q.length!==0&&(d.value.push(...q),g.value+=q.length,v.value=new Date().toISOString(),t&&q.length>0&&W(),r&&r(q))},A=G=>{const q=G.message||G.error?.message||"Connection error";C.value=q,l.value="error",console.error("[useRealtime] Error:",G)},U=G=>{console.warn("[useRealtime] Connection timeout:",G)},x=G=>{C.value=`Max reconnect attempts reached (${G.attempts})`,console.error("[useRealtime] Max reconnect attempts:",G)},D=(G={})=>{C.value=null,G.lastTimestamp!==void 0&&n.updateOptions({lastTimestamp:G.lastTimestamp}),n.on("state-change",k),n.on("new_logs",_),n.on("error",A),n.on("timeout",U),n.on("max-reconnect-attempts",x),n.connect()},E=()=>{n.off("state-change",k),n.off("new_logs",_),n.off("error",A),n.off("timeout",U),n.off("max-reconnect-attempts",x),n.disconnect()},L=()=>{d.value=[],g.value=0},R=G=>{G&&Array.isArray(G)&&(G.unshift(...d.value),L())},W=()=>{try{const G=new Audio("/sounds/notification.mp3");G.volume=.3,G.play().catch(q=>{console.warn("[useRealtime] Failed to play sound:",q)})}catch(G){console.warn("[useRealtime] Sound not available:",G)}};return a&&$e(()=>{D()}),at(()=>{E()}),{connectionState:l,isConnected:p,isConnecting:y,hasError:S,newLogs:d,newLogsCount:g,hasNewLogs:T,lastUpdateTime:v,error:C,reconnectAttempts:f,connect:D,disconnect:E,clearNewLogs:L,applyNewLogs:R}}const YT=ys(()=>Ce(()=>import("./WebhookLogsDashboard.vue-B_gD4AD5.js"),__vite__mapDeps([12,2,3,4,5,6,7]),import.meta.url)),XT=ys(()=>Ce(()=>import("./WebhookLogDetails.vue-Cqyr97zA.js"),__vite__mapDeps([13,2,3,4,5,6,7]),import.meta.url)),JT={name:"WebhookLogsPage",components:{WebhookLogsDashboard:YT,WebhookLogsExport:Qw,WebhookLogSearch:rC,WebhookLogFilters:DC,WebhookLogList:KC,WebhookLogDetails:XT,SkeletonLogList:aT,EmptyState:uT,ErrorDisplay:bT,NotificationContainer:MT,RealtimeControls:UT,NewLogsIndicator:GT},setup(){const o=Xe(),{success:e,error:a}=mt(),t=M(!1),r=M(!1),i=M(null),n=M(null),l=M([]),d=(N,b=2)=>{if(N==null)return String(N);if(typeof N=="string")return N;const O=(Q,de=0)=>{if(de>10)return"[Max Depth]";if(Q==null||typeof Q!="object")return Q;if(Array.isArray(Q))return Q.map(_e=>O(_e,de+1));const ke={};try{for(const _e in Q)if(Object.prototype.hasOwnProperty.call(Q,_e))try{const K=Q[_e];if(typeof K=="function"||K===void 0)continue;ke[_e]=O(K,de+1)}catch{ke[_e]="[Error reading property]"}}catch{return"[Error reading object]"}return ke};try{const Q=O(N),de=new WeakSet;return JSON.stringify(Q,(ke,_e)=>{if(typeof _e=="object"&&_e!==null){if(de.has(_e))return"[Circular]";de.add(_e)}return _e},b)}catch(Q){return console.error("[WebhookLogsPage] Error in safeStringify:",Q),`[Error: ${Q.message}]`}},g=M(null),v=M([]),C=M(""),f=M(null),p=M(null),y=M(!1),{connectionState:S,newLogsCount:T,error:k,connect:_,disconnect:A,applyNewLogs:U,clearNewLogs:x}=qT(et("/api/webhook-realtime.php"),{autoConnect:!1,enableSound:!0,validateLogs:!0,onNewLogs:N=>{console.log("[WebhookLogsPage] New logs received:",N.length),N.length>0&&(l.value.unshift(...N),R.value.total+=N.length,e(`Получено ${N.length} новых событий`))}}),{filters:D,updateFilters:E,clearFilters:L}=uw(),R=M({page:1,limit:50,total:0,pages:0}),W=I(()=>{let N=[...l.value];return C.value&&C.value.trim()&&(N=gw(N,C.value,{caseSensitive:!1,searchInEvent:!0,searchInPayload:!0,searchInDetails:!0,searchInIp:!0})),D.value.category&&(N=N.filter(b=>b.category===D.value.category)),D.value.event&&(N=N.filter(b=>b.event===D.value.event)),D.value.ip&&(N=N.filter(b=>b.ip&&b.ip.includes(D.value.ip))),D.value.status&&(N=N.filter(b=>D.value.status==="error"?b.category==="errors":D.value.status==="success"?b.category!=="errors":!0)),D.value.dateFrom&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]>=D.value.dateFrom:!1)),D.value.dateTo&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]<=D.value.dateTo:!1)),D.value.hour!==null&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).getHours()===D.value.hour:!1)),N});Ne(W,N=>{f.value&&C.value&&f.value.setResultsCount(N.length)});const G=async()=>{try{await kt.init();const N=await kt.getCurrentUser();if(console.log("[WebhookLogsPage] User data:",N),!N||!N.ID){console.warn("[WebhookLogsPage] User not determined"),n.value=d({error:"User not determined",userId:N?.ID||null,userName:N?`${N.NAME||""} ${N.LAST_NAME||""}`.trim():null}),t.value=!1;return}const b=N?.UF_DEPARTMENT||[];if(console.log("[WebhookLogsPage] User departments:",b),console.log("[WebhookLogsPage] Allowed departments:",xt.allowedDepartmentIds),b.length>0){const O=b.some(Q=>ws(Q));console.log("[WebhookLogsPage] Has access:",O),t.value=O,O||(n.value=d({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:b,allowedDepartments:xt.allowedDepartmentIds,message:"User departments do not match allowed departments"}))}else console.warn("[WebhookLogsPage] User has no departments"),n.value=d({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:[],allowedDepartments:xt.allowedDepartmentIds,message:"User has no departments assigned"}),t.value=!1}catch(N){console.error("[WebhookLogsPage] Error checking access:",N),n.value=d({error:N.message,stack:N.stack}),t.value=!1}},q=I(()=>xt.allowedDepartmentIds.join(", ")),oe=async(N=!1)=>{if(t.value&&!(Z&&!N)){Z=!0,r.value=!0,i.value=null;try{const b=new Date().toISOString().split("T")[0],O={category:D.value.category||null,event:D.value.event||null,date:D.value.dateFrom||b,hour:D.value.hour!==null&&D.value.hour!==void 0?D.value.hour:null,ip:D.value.ip||null,status:D.value.status||null,dateFrom:D.value.dateFrom||b,dateTo:D.value.dateTo||null};if(!Oa(O))throw new Error("Некорректные параметры фильтрации");console.log("[WebhookLogsPage] Loading logs with filters:",O);const Q=await us.getLogs(O,R.value.page,R.value.limit,N);if(console.log("[WebhookLogsPage] API result:",Q),console.log("[WebhookLogsPage] Logs count:",Q?.logs?.length||0),console.log("[WebhookLogsPage] Pagination:",Q?.pagination),!Q.success)throw new Error(Q.error||"Ошибка загрузки логов");mw(Q.pagination)?R.value=Q.pagination:(console.warn("[WebhookLogsPage] Invalid pagination format, using defaults"),R.value={page:R.value.page,limit:R.value.limit,total:Q.logs.length,pages:Math.ceil(Q.logs.length/R.value.limit)});const de=za(Q.logs),ke=de.filter(_e=>gt(_e));ke.length!==de.length&&console.warn("[WebhookLogsPage] Filtered out invalid logs:",de.length-ke.length),l.value=ke,N&&e("Логи обновлены")}catch(b){Y(b)}finally{r.value=!1,Z=!1}}},Y=N=>{console.error("[WebhookLogsPage] API Error:",N),N.status===403?(i.value="Доступ запрещён",a("У вас нет доступа к логам вебхуков")):N.status===404?(i.value="Логи не найдены",a("Логи для указанных фильтров не найдены")):N.status>=500?(i.value="Ошибка сервера",a("Произошла ошибка на сервере. Попробуйте позже.")):(i.value=N.message||"Неизвестная ошибка",a(i.value)),N.status>=500&&(l.value=[])},H=N=>{C.value=N,E({search:N||null})};let Z=!1;const fe=N=>{if(!Oa(N)){a("Некорректные параметры фильтрации");return}const b={category:D.value.category,event:D.value.event,dateFrom:D.value.dateFrom,dateTo:D.value.dateTo,hour:D.value.hour,ip:D.value.ip,status:D.value.status},O={category:N?.category||null,event:N?.event||null,dateFrom:N?.dateFrom||null,dateTo:N?.dateTo||null,hour:N?.hour!==void 0?N.hour:null,ip:N?.ip||null,status:N?.status||null},Q=Object.keys(O).some(de=>{const ke=b[de],_e=O[de];return ke!==_e});if(!(!Q&&!Z)){if(E(O),R.value.page=1,Q)try{us.invalidateCacheOnFilterChange(b,O)}catch(de){console.error("[WebhookLogsPage] Error invalidating cache:",de)}Z||(Z=!0,oe(!0).finally(()=>{Z=!1}))}},P=()=>{L(),C.value="",R.value.page=1,oe()},h=N=>{g.value=N},w=()=>{g.value=null},B=N=>{R.value.page=N,oe()},re=()=>{try{o.push("/")}catch(N){console.error("Navigation error:",N),window.location.hash="#/"}},le=N=>{v.value=N},se=N=>{console.log("Экспорт начат:",N)},me=N=>{console.log("Экспорт завершён:",N),e(`Экспорт завершён: ${N.count} записей в файле ${N.filename}`)},De=N=>{console.error("Ошибка экспорта:",N),a(`Ошибка экспорта: ${N.message||"Неизвестная ошибка"}`)},Ie=()=>{C.value="",P()},xe=N=>{if(console.log("[WebhookLogsPage] Toggle auto-update:",N),y.value=N,N){let b=null;if(l.value.length>0){const O=l.value[0];O.timestamp&&(b=O.timestamp,console.log("[WebhookLogsPage] Using lastTimestamp:",b))}_({lastTimestamp:b})}else A()},He=()=>{U(l.value),e("Новые события применены")},z=()=>{x()};return $e(async()=>{await G(),t.value&&(D.value.search&&(C.value=D.value.search),await oe())}),{hasAccess:t,loading:r,error:i,logs:l,filteredLogs:W,selectedLog:g,selectedLogs:v,filters:D,searchQuery:C,searchComponent:f,pagination:R,previousPeriodStats:p,handleFiltersUpdate:fe,handleFiltersReset:P,handleSearch:H,handleLogSelect:h,handleLogClose:w,handlePageChange:B,handleSelectedLogsUpdate:le,handleExportStart:se,handleExportComplete:me,handleExportError:De,handleClearSearch:Ie,autoUpdateEnabled:y,connectionState:S,newLogsCount:T,realtimeError:k,handleToggleAutoUpdate:xe,handleApplyNewLogs:He,handleDismissNewLogs:z,allowedDepartmentsText:q,accessDebugInfo:n,goBack:re}}},ZT={class:"webhook-logs-page"},QT={class:"page-header"},eS={class:"page-header-top"},tS={key:0,class:"access-denied"},aS={class:"access-denied-content"},sS={class:"access-hint"},oS={key:0,class:"access-debug"},nS={key:1,class:"page-content"},rS={class:"actions-bar"};function iS(o,e,a,t,r,i){const n=be("WebhookLogsDashboard"),l=be("WebhookLogsExport"),d=be("WebhookLogSearch"),g=be("RealtimeControls"),v=be("NewLogsIndicator"),C=be("WebhookLogFilters"),f=be("SkeletonLogList"),p=be("WebhookLogList"),y=be("EmptyState"),S=be("ErrorDisplay"),T=be("WebhookLogDetails"),k=be("NotificationContainer");return c(),u("div",ZT,[s("div",QT,[s("div",eS,[s("button",{onClick:e[0]||(e[0]=(..._)=>t.goBack&&t.goBack(..._)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[3]||(e[3]=[s("span",{class:"back-icon","aria-hidden":"true"},"←",-1),s("span",{class:"back-text"},"Назад",-1)])])]),e[4]||(e[4]=s("h1",null,"Логи вебхуков Bitrix24",-1))]),t.hasAccess?(c(),u("div",nS,[ne(n,{logs:t.logs,pagination:t.pagination,"previous-period-stats":t.previousPeriodStats},null,8,["logs","pagination","previous-period-stats"]),s("div",rS,[ne(l,{logs:t.filteredLogs,"selected-logs":t.selectedLogs,filters:t.filters,"total-count":t.filteredLogs.length,onExportStart:t.handleExportStart,onExportComplete:t.handleExportComplete,onExportError:t.handleExportError},null,8,["logs","selected-logs","filters","total-count","onExportStart","onExportComplete","onExportError"]),ne(d,{modelValue:t.searchQuery,"onUpdate:modelValue":e[1]||(e[1]=_=>t.searchQuery=_),onSearch:t.handleSearch,ref:"searchComponent"},null,8,["modelValue","onSearch"])]),ne(g,{enabled:t.autoUpdateEnabled,"connection-state":t.connectionState,error:t.realtimeError,onToggle:t.handleToggleAutoUpdate},null,8,["enabled","connection-state","error","onToggle"]),ne(v,{count:t.newLogsCount,onApply:t.handleApplyNewLogs,onDismiss:t.handleDismissNewLogs},null,8,["count","onApply","onDismiss"]),ne(C,{filters:t.filters,"onUpdate:filters":t.handleFiltersUpdate,onReset:t.handleFiltersReset},null,8,["filters","onUpdate:filters","onReset"]),ne(Ae,{name:"fade"},{default:ye(()=>[t.loading&&t.logs.length===0?(c(),he(f,{key:0,rows:5})):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:ye(()=>[!t.loading&&t.filteredLogs.length>0?(c(),he(p,{key:0,logs:t.filteredLogs,loading:!1,error:null,pagination:t.pagination,"selected-logs":t.selectedLogs,onSelectLog:t.handleLogSelect,onPageChange:t.handlePageChange,"onUpdate:selectedLogs":t.handleSelectedLogsUpdate},null,8,["logs","pagination","selected-logs","onSelectLog","onPageChange","onUpdate:selectedLogs"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:ye(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length===0?(c(),he(y,{key:0,icon:"📭",title:"Логи не найдены",description:"Логи вебхуков пока отсутствуют. Они появятся здесь после получения событий от Bitrix24.",hints:["Проверьте фильтры по категории и типу события","Убедитесь, что выбран правильный период","Попробуйте очистить все фильтры"],"action-label":"Очистить фильтры",onAction:t.handleFiltersReset},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:ye(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length>0?(c(),he(y,{key:0,icon:"🔍",title:"Ничего не найдено",description:"По вашему запросу ничего не найдено. Попробуйте изменить параметры поиска или фильтры.",hints:["Проверьте правильность написания поискового запроса","Попробуйте использовать другие фильтры","Очистите поиск и попробуйте снова"],"action-label":"Очистить поиск",onAction:t.handleClearSearch},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ae,{name:"fade"},{default:ye(()=>[t.error?(c(),he(S,{key:0,title:"Ошибка загрузки логов",message:t.error,retryable:!0,onRetry:o.loadLogs},null,8,["message","onRetry"])):$("",!0)]),_:1}),t.selectedLog?(c(),u("div",{key:0,class:"modal-overlay",onClick:e[2]||(e[2]=(..._)=>t.handleLogClose&&t.handleLogClose(..._))})):$("",!0),ne(Ae,{name:"modal"},{default:ye(()=>[t.selectedLog?(c(),he(T,{key:0,log:t.selectedLog,onClose:t.handleLogClose},null,8,["log","onClose"])):$("",!0)]),_:1})])):(c(),u("div",tS,[s("div",aS,[e[7]||(e[7]=s("h2",null,"Доступ запрещён",-1)),e[8]||(e[8]=s("p",null,"У вас нет доступа к просмотру логов вебхуков.",-1)),s("p",sS,[e[5]||(e[5]=ge(" Доступ разрешён только пользователям из отделов: ",-1)),s("strong",null,m(t.allowedDepartmentsText),1)]),e[9]||(e[9]=s("p",{class:"access-hint"}," Если вы считаете, что у вас должен быть доступ, обратитесь к администратору системы. ",-1)),t.accessDebugInfo?(c(),u("details",oS,[e[6]||(e[6]=s("summary",null,"Отладочная информация",-1)),s("pre",null,m(t.accessDebugInfo),1)])):$("",!0)])])),ne(k)])}const lS=ce(JT,[["render",iS],["__scopeId","data-v-628bf174"]]),cS={name:"DrillDownNavigation",props:{breadcrumbs:{type:Array,default:()=>[],validator:o=>Array.isArray(o)&&o.every(e=>typeof e=="object"&&typeof e.id=="string"&&typeof e.label=="string")},separator:{type:String,default:">"},showBackButton:{type:Boolean,default:!0},additionalActions:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},maxLabelLength:{type:Number,default:30}},emits:["navigate","back","action"],setup(o,{emit:e}){const a=I(()=>o.breadcrumbs.map(d=>({...d,label:r(d.label,o.maxLabelLength)}))),t=I(()=>{const d=a.value;return d.length<=5?d:[d[0],{id:"ellipsis-start",label:"...",isEllipsis:!0},...d.slice(-3)]}),r=(d,g)=>d.length<=g?d:d.substring(0,g-3)+"...";return{visibleBreadcrumbs:t,handleNavigate:d=>{d.action&&e("navigate",d)},handleBack:()=>{e("back")},handleAction:d=>{e("action",d)}}}},dS={class:"drilldown-navigation",role:"navigation","aria-label":"Навигация по разделам управления пользователями"},uS={class:"breadcrumb-list"},gS={key:0,class:"breadcrumb-separator","aria-hidden":"true"},mS=["onClick","onKeydown","aria-label","title"],hS={class:"breadcrumb-text"},fS={key:2,class:"breadcrumb-current-text","aria-current":"page"},vS={class:"breadcrumb-text"},pS={key:3,class:"breadcrumb-loading","aria-label":"Загрузка данных"},yS=["aria-label","title"],kS={key:1,class:"breadcrumb-actions"},bS=["onClick","onKeydown","aria-label","title","disabled"],_S={key:1,class:"action-text"};function wS(o,e,a,t,r,i){return c(),u("nav",dS,[s("ol",uS,[(c(!0),u(ee,null,te(a.breadcrumbs,(n,l)=>(c(),u("li",{key:n.id,class:X(["breadcrumb-item",{"breadcrumb-current":l===a.breadcrumbs.length-1,"breadcrumb-interactive":l<a.breadcrumbs.length-1}])},[l>0?(c(),u("span",gS,m(a.separator),1)):$("",!0),l<a.breadcrumbs.length-1&&n.action?(c(),u("button",{key:1,class:"breadcrumb-link",onClick:d=>t.handleNavigate(n),onKeydown:[Be(d=>t.handleNavigate(n),["enter"]),Be(d=>t.handleNavigate(n),["space"])],"aria-label":`Перейти к разделу ${n.label}`,title:`Вернуться к ${n.label}`},[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),s("span",hS,m(n.label),1)],40,mS)):(c(),u("span",fS,[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),s("span",vS,m(n.label),1)])),l===a.breadcrumbs.length-1&&a.isLoading?(c(),u("div",pS,[...e[3]||(e[3]=[s("div",{class:"loading-spinner","aria-hidden":"true"},null,-1)])])):$("",!0)],2))),128))]),a.showBackButton&&a.breadcrumbs.length>1?(c(),u("button",{key:0,class:"back-button",onClick:e[0]||(e[0]=(...n)=>t.handleBack&&t.handleBack(...n)),onKeydown:[e[1]||(e[1]=Be((...n)=>t.handleBack&&t.handleBack(...n),["enter"])),e[2]||(e[2]=Be((...n)=>t.handleBack&&t.handleBack(...n),["space"]))],"aria-label":`Вернуться к ${a.breadcrumbs[a.breadcrumbs.length-2]?.label||"предыдущему разделу"}`,title:`Вернуться к ${a.breadcrumbs[a.breadcrumbs.length-2]?.label||"предыдущему разделу"}`},[...e[4]||(e[4]=[s("svg",{class:"back-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[s("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1),s("span",{class:"back-text"},"Назад",-1)])],40,yS)):$("",!0),a.additionalActions.length>0?(c(),u("div",kS,[(c(!0),u(ee,null,te(a.additionalActions,n=>(c(),u("button",{key:n.id,class:X(["action-button",n.class]),onClick:l=>t.handleAction(n),onKeydown:[Be(l=>t.handleAction(n),["enter"]),Be(l=>t.handleAction(n),["space"])],"aria-label":n.label,title:n.title||n.label,disabled:n.disabled},[n.icon?(c(),he(wt(n.icon),{key:0,class:"action-icon","aria-hidden":"true"})):$("",!0),n.text?(c(),u("span",_S,m(n.text),1)):$("",!0)],42,bS))),128))])):$("",!0)])}const CS=ce(cS,[["render",wS],["__scopeId","data-v-e0da3deb"]]),TS={name:"MetricCard",emits:["click"],props:{metric:{type:Object,default:()=>({})},title:{type:String,required:!0},value:{type:[Number,String],required:!0},unit:{type:String,default:""},subtitle:{type:String,default:""},icon:{type:String,default:""},trend:{type:Number,default:null},trendPeriod:{type:String,default:""},progress:{type:Number,default:null},size:{type:String,default:"medium",validator:o=>["small","medium","large","compact"].includes(o)},interactive:{type:Boolean,default:!1}},computed:{formattedValue(){return typeof this.value=="number"?this.value>=1e6?`${(this.value/1e6).toFixed(1)}M`:this.value>=1e3?`${(this.value/1e3).toFixed(1)}K`:this.value.toLocaleString():this.value}}},SS={class:"metric-header"},DS=["innerHTML"],ES={class:"metric-title"},AS={class:"metric-value-section"},$S={class:"metric-value"},IS={key:0,class:"metric-unit"},MS={key:0,class:"metric-subtitle"},NS={key:1,class:"metric-trend"},xS={class:"trend-indicator"},LS={key:0,viewBox:"0 0 24 24",width:"12",height:"12"},PS={key:1,viewBox:"0 0 24 24",width:"12",height:"12"},OS={key:2,viewBox:"0 0 24 24",width:"12",height:"12"},RS={class:"trend-value"},BS={class:"trend-period"},US={key:2,class:"metric-progress"},WS={class:"progress-bar"},FS={class:"progress-text"};function HS(o,e,a,t,r,i){return c(),u("div",{class:X(["metric-card",{[`size-${a.size}`]:!0,"has-trend":a.trend!==null,"trend-up":a.trend>0,"trend-down":a.trend<0,"trend-neutral":a.trend===0,interactive:a.interactive}]),onClick:e[0]||(e[0]=n=>a.interactive?o.$emit("click",a.metric):null)},[s("div",SS,[a.icon?(c(),u("div",{key:0,class:"metric-icon",innerHTML:a.icon},null,8,DS)):$("",!0),s("div",ES,m(a.title),1)]),s("div",AS,[s("div",$S,m(i.formattedValue),1),a.unit?(c(),u("div",IS,m(a.unit),1)):$("",!0)]),a.subtitle?(c(),u("div",MS,m(a.subtitle),1)):$("",!0),a.trend!==null?(c(),u("div",NS,[s("div",xS,[a.trend>0?(c(),u("svg",LS,[...e[1]||(e[1]=[s("path",{d:"M7 14l5-5 5 5z",fill:"currentColor"},null,-1)])])):a.trend<0?(c(),u("svg",PS,[...e[2]||(e[2]=[s("path",{d:"M7 10l5 5 5-5z",fill:"currentColor"},null,-1)])])):(c(),u("svg",OS,[...e[3]||(e[3]=[s("path",{d:"M7 12h10v-2H7z",fill:"currentColor"},null,-1)])]))]),s("span",RS,m(Math.abs(a.trend))+"%",1),s("span",BS,m(a.trendPeriod||"vs prev"),1)])):$("",!0),a.progress!==null?(c(),u("div",US,[s("div",WS,[s("div",{class:"progress-fill",style:we({width:`${Math.min(a.progress,100)}%`})},null,4)]),s("span",FS,m(a.progress)+"%",1)])):$("",!0)],2)}const jS=ce(TS,[["render",HS],["__scopeId","data-v-b8d66bef"]]),VS={name:"ContextSidebar",components:{MetricCard:jS},props:{context:{type:String,default:"global",validator:o=>["global","user","management"].includes(o)},selectedUser:{type:Object,default:null},selectedUsers:{type:Array,default:()=>[]},globalMetrics:{type:Array,default:()=>[]},userStats:{type:Object,default:()=>({})},userFilters:{type:Object,default:()=>({timeRange:"week",activity_types:[]})},filterPresets:{type:Array,default:()=>[]},activePreset:{type:String,default:null},recentActivity:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},activityTypes:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},collapsed:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},emits:["toggle-collapse","metric-click","filter-preset-apply","activity-click","filter-change","view-profile","export-data","edit-permissions","bulk-action","user-select"],setup(o,{emit:e}){const a=M(o.collapsed),t=I(()=>{if(!o.selectedUser?.name)return"";const[A,U]=o.selectedUser.name.split(" ");return`${A?.[0]||""}${U?.[0]||""}`.toUpperCase()}),r=()=>{a.value=!a.value,e("toggle-collapse",a.value)},i=()=>{switch(o.context){case"global":return"Обзор";case"user":return"Анализ пользователя";case"management":return"Управление";default:return"Обзор"}},n=()=>`${i()} - боковая панель с дополнительной информацией`,l=A=>{switch(A){case"online":return"Онлайн";case"away":return"Отошёл";case"offline":return"Оффлайн";default:return"Неизвестно"}},d=A=>{if(!A)return"";const[U,x]=A.split(" ");return`${U?.[0]||""}${x?.[0]||""}`.toUpperCase()},g=A=>{const U=Math.floor(A/60),x=A%60;return`${U}:${x.toString().padStart(2,"0")}`},v=A=>{const U=new Date(A),D=new Date-U,E=Math.floor(D/(1e3*60)),L=Math.floor(D/(1e3*60*60)),R=Math.floor(D/(1e3*60*60*24));return E<1?"только что":E<60?`${E} мин назад`:L<24?`${L} ч назад`:R<7?`${R} д назад`:U.toLocaleDateString()},C=A=>{e("metric-click",A)},f=A=>{e("filter-preset-apply",A)},p=A=>{e("activity-click",A)},y=()=>{e("filter-change",o.userFilters)},S=()=>{e("view-profile",o.selectedUser)},T=()=>{e("export-data",o.selectedUser)},k=()=>{e("edit-permissions",o.selectedUser)},_=A=>{e("bulk-action",{action:A,users:o.selectedUsers})};return Ne(()=>o.collapsed,A=>{a.value=A}),{isCollapsed:a,userInitials:t,toggleCollapse:r,getContextTitle:i,getAriaLabel:n,getStatusText:l,getUserInitials:d,formatDuration:g,formatTime:v,handleMetricClick:C,applyFilterPreset:f,handleActivityClick:p,handleFilterChange:y,viewDetailedProfile:S,exportUserData:T,editPermissions:k,performBulkAction:_}}},zS=["aria-label"],GS=["aria-label","title"],KS={class:"sidebar-header"},qS={class:"context-title"},YS={key:0,class:"user-indicator"},XS={class:"user-avatar"},JS=["src","alt"],ZS={key:1,class:"avatar-placeholder"},QS={class:"user-info"},eD={class:"user-name"},tD={key:0,class:"global-context-content"},aD={class:"metrics-section"},sD={class:"metrics-grid"},oD={class:"filters-section"},nD={class:"filter-presets"},rD=["onClick","aria-label"],iD={class:"preset-label"},lD={key:0,class:"preset-count"},cD={class:"recent-activity-section"},dD={class:"recent-activity-list"},uD=["onClick"],gD={class:"activity-content"},mD={class:"activity-text"},hD={class:"activity-time"},fD={key:1,class:"user-context-content"},vD={class:"user-stats-section"},pD={class:"user-stats-grid"},yD={class:"stat-item"},kD={class:"stat-value"},bD={class:"stat-item"},_D={class:"stat-value"},wD={class:"stat-item"},CD={class:"stat-value"},TD={class:"stat-item"},SD={class:"stat-value"},DD={class:"analysis-filters-section"},ED={class:"filter-controls"},AD={class:"filter-group"},$D={class:"filter-group"},ID={class:"checkbox-group"},MD=["value"],ND={class:"user-actions-section"},xD={class:"action-buttons"},LD=["aria-label"],PD=["aria-label"],OD=["aria-label"],RD={key:2,class:"management-context-content"},BD={key:0,class:"selected-users-section"},UD={class:"section-title"},WD={class:"selected-users-list"},FD={class:"user-avatar small"},HD=["src","alt"],jD={key:1,class:"avatar-placeholder small"},VD={class:"user-name"},zD={key:0,class:"more-users"},GD={class:"bulk-operations-section"},KD={class:"bulk-actions"},qD=["disabled"],YD=["disabled"],XD=["disabled"],JD={class:"audit-log-section"},ZD={class:"audit-log-list"},QD={class:"audit-content"},e2={class:"audit-text"},t2={class:"audit-time"},a2={key:0,class:"sidebar-loading-overlay"};function s2(o,e,a,t,r,i){const n=be("MetricCard");return c(),u("aside",{class:X(["context-sidebar",{collapsed:t.isCollapsed,"context-global":a.context==="global","context-user":a.context==="user","context-management":a.context==="management"}]),role:"complementary","aria-label":t.getAriaLabel()},[s("button",{class:"collapse-toggle",onClick:e[0]||(e[0]=(...l)=>t.toggleCollapse&&t.toggleCollapse(...l)),onKeydown:[e[1]||(e[1]=Be((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["enter"])),e[2]||(e[2]=Be((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["space"]))],"aria-label":t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель",title:t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель"},[(c(),u("svg",{class:X(["collapse-icon",{rotated:t.isCollapsed}]),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[13]||(e[13]=[s("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"},null,-1)])],2))],40,GS),s("header",KS,[s("h3",qS,m(t.getContextTitle()),1),a.context==="user"&&a.selectedUser?(c(),u("div",YS,[s("div",XS,[a.selectedUser.avatar?(c(),u("img",{key:0,src:a.selectedUser.avatar,alt:`Аватар ${a.selectedUser.name}`},null,8,JS)):(c(),u("div",ZS,m(t.userInitials),1))]),s("div",QS,[s("div",eD,m(a.selectedUser.name),1),s("div",{class:X(["user-status",a.selectedUser.status])},m(t.getStatusText(a.selectedUser.status)),3)])])):$("",!0)]),s("div",{class:X(["sidebar-content",{"content-collapsed":t.isCollapsed}])},[a.context==="global"?(c(),u("div",tD,[s("section",aD,[e[14]||(e[14]=s("h4",{class:"section-title"},"Общая статистика",-1)),s("div",sD,[(c(!0),u(ee,null,te(a.globalMetrics,l=>(c(),he(n,{key:l.id,metric:l,size:"compact",onClick:t.handleMetricClick},null,8,["metric","onClick"]))),128))])]),s("section",oD,[e[15]||(e[15]=s("h4",{class:"section-title"},"Быстрые фильтры",-1)),s("div",nD,[(c(!0),u(ee,null,te(a.filterPresets,l=>(c(),u("button",{key:l.id,class:X(["filter-preset",{active:a.activePreset===l.id}]),onClick:d=>t.applyFilterPreset(l),"aria-label":`Применить фильтр: ${l.label}`},[(c(),he(wt(l.icon),{class:"preset-icon"})),s("span",iD,m(l.label),1),l.count!==void 0?(c(),u("span",lD,m(l.count),1)):$("",!0)],10,rD))),128))])]),s("section",cD,[e[16]||(e[16]=s("h4",{class:"section-title"},"Недавние действия",-1)),s("div",dD,[(c(!0),u(ee,null,te(a.recentActivity,l=>(c(),u("div",{key:l.id,class:"activity-item",onClick:d=>t.handleActivityClick(l)},[s("div",{class:X(["activity-icon",l.type])},[(c(),he(wt(l.icon)))],2),s("div",gD,[s("div",mD,m(l.text),1),s("div",hD,m(t.formatTime(l.timestamp)),1)])],8,uD))),128))])])])):a.context==="user"?(c(),u("div",fD,[s("section",vD,[e[21]||(e[21]=s("h4",{class:"section-title"},"Статистика пользователя",-1)),s("div",pD,[s("div",yD,[s("div",kD,m(a.userStats.total_actions||0),1),e[17]||(e[17]=s("div",{class:"stat-label"},"действий",-1)),a.userStats.actions_change!==0?(c(),u("div",{key:0,class:X(["stat-change",{positive:a.userStats.actions_change>0,negative:a.userStats.actions_change<0}])},m(a.userStats.actions_change>0?"+":"")+m(a.userStats.actions_change)+"% ",3)):$("",!0)]),s("div",bD,[s("div",_D,m(t.formatDuration(a.userStats.avg_session_duration||0)),1),e[18]||(e[18]=s("div",{class:"stat-label"},"средняя сессия",-1))]),s("div",wD,[s("div",CD,m(a.userStats.total_sessions||0),1),e[19]||(e[19]=s("div",{class:"stat-label"},"сессий",-1))]),s("div",TD,[s("div",SD,m(a.userStats.activity_score||0)+"/100",1),e[20]||(e[20]=s("div",{class:"stat-label"},"активность",-1))])])]),s("section",DD,[e[26]||(e[26]=s("h4",{class:"section-title"},"Фильтры анализа",-1)),s("div",ED,[s("div",AD,[e[23]||(e[23]=s("label",{class:"filter-label"},"Период:",-1)),Re(s("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.userFilters.timeRange=l),class:"filter-select",onChange:e[4]||(e[4]=(...l)=>t.handleFilterChange&&t.handleFilterChange(...l))},[...e[22]||(e[22]=[_t('<option value="today" data-v-abccaced>Сегодня</option><option value="week" data-v-abccaced>Неделя</option><option value="month" data-v-abccaced>Месяц</option><option value="quarter" data-v-abccaced>Квартал</option><option value="year" data-v-abccaced>Год</option>',5)])],544),[[dt,a.userFilters.timeRange]])]),s("div",$D,[e[25]||(e[25]=s("label",{class:"filter-label"},"Типы действий:",-1)),s("div",ID,[(c(!0),u(ee,null,te(a.activityTypes,l=>(c(),u("label",{key:l.id,class:"checkbox-label"},[Re(s("input",{type:"checkbox",value:l.id,"onUpdate:modelValue":e[5]||(e[5]=d=>a.userFilters.activity_types=d),onChange:e[6]||(e[6]=(...d)=>t.handleFilterChange&&t.handleFilterChange(...d))},null,40,MD),[[ka,a.userFilters.activity_types]]),e[24]||(e[24]=s("span",{class:"checkmark"},null,-1)),ge(" "+m(l.label),1)]))),128))])])])]),s("section",ND,[e[30]||(e[30]=s("h4",{class:"section-title"},"Действия",-1)),s("div",xD,[s("button",{class:"action-button primary",onClick:e[7]||(e[7]=(...l)=>t.viewDetailedProfile&&t.viewDetailedProfile(...l)),"aria-label":`Просмотреть детальный профиль ${a.selectedUser?.name}`},[...e[27]||(e[27]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.6C18.8 6 18.5 5.4 18.1 4.9L19 3L17 1L15.4 1.9C14.9 1.5 14.3 1.2 13.7 1L13 0V2C12.4 2 11.8 2.2 11.3 2.6L10.6 1.9L8.6 3L9.5 4.9C9.1 5.4 8.8 6 8.6 6.6L7 7V9L8.6 8.4C8.8 9 9.1 9.6 9.5 10.1L8.6 12L10.6 13.9L11.3 13.2C11.8 13.6 12.4 13.8 13 14V16H11V18H13V20H11V22H13V20H15V18H13V16H15V14C15.6 14 16.2 13.6 16.7 13.2L17.4 13.9L19.4 12L18.5 10.1C18.9 9.6 19.2 9 19.4 8.4L21 9ZM12 8C10.9 8 10 7.1 10 6C10 4.9 10.9 4 12 4C13.1 4 14 4.9 14 6C14 7.1 13.1 8 12 8Z"})],-1),ge(" Детальный профиль ",-1)])],8,LD),s("button",{class:"action-button secondary",onClick:e[8]||(e[8]=(...l)=>t.exportUserData&&t.exportUserData(...l)),"aria-label":`Экспортировать данные ${a.selectedUser?.name}`},[...e[28]||(e[28]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ge(" Экспорт данных ",-1)])],8,PD),a.canEditPermissions?(c(),u("button",{key:0,class:"action-button warning",onClick:e[9]||(e[9]=(...l)=>t.editPermissions&&t.editPermissions(...l)),"aria-label":`Изменить права ${a.selectedUser?.name}`},[...e[29]||(e[29]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ge(" Изменить права ",-1)])],8,OD)):$("",!0)])])])):a.context==="management"?(c(),u("div",RD,[a.selectedUsers.length>0?(c(),u("section",BD,[s("h4",UD,"Выбрано пользователей: "+m(a.selectedUsers.length),1),s("div",WD,[(c(!0),u(ee,null,te(a.selectedUsers.slice(0,3),l=>(c(),u("div",{key:l.id,class:"selected-user-item"},[s("div",FD,[l.avatar?(c(),u("img",{key:0,src:l.avatar,alt:l.name},null,8,HD)):(c(),u("div",jD,m(t.getUserInitials(l.name)),1))]),s("span",VD,m(l.name),1)]))),128)),a.selectedUsers.length>3?(c(),u("div",zD," +"+m(a.selectedUsers.length-3)+" ещё ",1)):$("",!0)])])):$("",!0),s("section",GD,[e[34]||(e[34]=s("h4",{class:"section-title"},"Массовые операции",-1)),s("div",KD,[s("button",{class:"bulk-action-button",onClick:e[10]||(e[10]=l=>t.performBulkAction("change_department")),disabled:a.selectedUsers.length===0},[...e[31]||(e[31]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ge(" Изменить отдел ",-1)])],8,qD),s("button",{class:"bulk-action-button",onClick:e[11]||(e[11]=l=>t.performBulkAction("toggle_admin")),disabled:a.selectedUsers.length===0},[...e[32]||(e[32]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ge(" Изменить права администратора ",-1)])],8,YD),s("button",{class:"bulk-action-button",onClick:e[12]||(e[12]=l=>t.performBulkAction("export")),disabled:a.selectedUsers.length===0},[...e[33]||(e[33]=[s("svg",{class:"action-icon",viewBox:"0 0 24 24"},[s("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ge(" Экспорт ",-1)])],8,XD)])]),s("section",JD,[e[35]||(e[35]=s("h4",{class:"section-title"},"Последние изменения",-1)),s("div",ZD,[(c(!0),u(ee,null,te(a.auditLog.slice(0,5),l=>(c(),u("div",{key:l.id,class:"audit-entry"},[s("div",{class:X(["audit-icon",l.type])},[(c(),he(wt(l.icon)))],2),s("div",QD,[s("div",e2,m(l.text),1),s("div",t2,m(t.formatTime(l.timestamp)),1)])]))),128))])])])):$("",!0)],2),a.isLoading?(c(),u("div",a2,[...e[36]||(e[36]=[s("div",{class:"loading-spinner","aria-label":"Загрузка данных"},null,-1)])])):$("",!0)],10,zS)}const o2=ce(VS,[["render",s2],["__scopeId","data-v-abccaced"]]),ms=o=>new Date(o),n2=(o,e,a={})=>{const t=new Date(o),r=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return e.replace("yyyy",r).replace("MM",i).replace("dd",n)},r2={name:"UnifiedUserCard",props:{user:{type:Object,required:!0,validator:o=>o&&typeof o=="object"&&o.id&&o.name&&o.email},isSelected:{type:Boolean,default:!1},showExtendedMetrics:{type:Boolean,default:!1},compactView:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1},canDelete:{type:Boolean,default:!1},maxDepartments:{type:Number,default:2}},emits:["select","view-profile","edit-permissions","toggle-hidden","view-analytics","export-data","send-notification","view-audit","delete-user"],setup(o,{emit:e}){const a=M(!1),t=M(null),r=I(()=>{const[P,h]=o.user.name.split(" ");return`${P?.[0]||""}${h?.[0]||""}`.toUpperCase()}),i=I(()=>{const P=["#2196F3","#4CAF50","#FF9800","#F44336","#9C27B0","#00BCD4","#8BC34A","#FFC107","#E91E63","#3F51B5"];return P[Math.abs(o.user.id)%P.length]}),n=I(()=>(o.user.departments||[]).slice(0,o.maxDepartments).map(h=>({...h,shortName:h.name.length>10?h.name.substring(0,8)+"...":h.name}))),l=I(()=>{const P=o.user.departments||[];return Math.max(0,P.length-o.maxDepartments)}),d=I(()=>{const P=o.user.activity_stats?.total_actions||0;return P>=1e6?`${(P/1e6).toFixed(1)}M`:P>=1e3?`${(P/1e3).toFixed(1)}K`:P.toLocaleString()}),g=I(()=>{const P=o.user.activity_stats?.total_sessions||0;return P>=1e3?`${(P/1e3).toFixed(1)}K`:P.toString()}),v=I(()=>{const P=o.user.activity_stats?.avg_session_duration||0,h=Math.floor(P/60),w=Math.floor(P%60);return`${h}:${w.toString().padStart(2,"0")}`}),C=I(()=>{const P=o.user.activity_stats?.last_activity;if(!P)return"Никогда";let h;try{h=typeof P=="string"?ms(P):new Date(P)}catch{return"Неизвестно"}const B=new Date-h,re=Math.floor(B/(1e3*60*60*24)),le=Math.floor(B/(1e3*60*60)),se=Math.floor(B/(1e3*60));return se<1?"только что":se<60?`${se} мин`:le<24?`${le} ч`:re<7?`${re} д`:re<30?`${Math.floor(re/7)} нед`:n2(h,"dd.MM.yyyy")}),f=I(()=>Math.min(100,Math.max(0,o.user.activity_stats?.activity_score||0))),p=I(()=>o.user.activity_stats?.actions_change_percent||0),y=I(()=>o.user.status||"offline"),S=I(()=>!!o.user.is_admin),T=I(()=>{if(!o.user.created_at)return!1;try{const P=typeof o.user.created_at=="string"?ms(o.user.created_at):new Date(o.user.created_at);return Math.floor((new Date-P)/(1e3*60*60*24))<=7}catch{return!1}}),k=I(()=>!!o.user.is_hidden),_=I(()=>o.user.name||"Неизвестный пользователь"),A=I(()=>o.user.email||""),U=I(()=>o.user.avatar||null),x=()=>{e("select",o.user)},D=()=>{e("view-profile",o.user)},E=()=>{e("edit-permissions",o.user)},L=()=>{e("toggle-hidden",o.user)},R=()=>{a.value=!0;const P=h=>{t.value&&!t.value.contains(h.target)&&(a.value=!1,document.removeEventListener("click",P))};setTimeout(()=>{document.addEventListener("click",P)},0)},W=()=>{a.value=!1,e("view-analytics",o.user)},G=()=>{a.value=!1,e("export-data",o.user)},q=()=>{a.value=!1,e("send-notification",o.user)},oe=()=>{a.value=!1,e("view-audit",o.user)},Y=()=>{a.value=!1,confirm(`Вы уверены, что хотите удалить пользователя ${o.user.name}?`)&&e("delete-user",o.user)},H=()=>{console.warn(`Failed to load avatar for user ${o.user.id}`)},Z=P=>{switch(P){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},fe=P=>{if(P.key==="Enter"||P.key===" ")P.preventDefault(),x();else if(P.key==="ArrowDown"){P.preventDefault();const h=P.target.nextElementSibling;h&&h.focus()}else if(P.key==="ArrowUp"){P.preventDefault();const h=P.target.previousElementSibling;h&&h.focus()}};return $e(()=>{const P=document.querySelector(`[data-user-id="${o.user.id}"]`);P&&P.addEventListener("keydown",fe)}),at(()=>{const P=document.querySelector(`[data-user-id="${o.user.id}"]`);P&&P.removeEventListener("keydown",fe)}),{showContextMenuFlag:a,contextMenuRef:t,userInitials:r,avatarColor:i,visibleDepartments:n,hiddenDepartmentsCount:l,totalActionsFormatted:d,totalSessionsFormatted:g,avgSessionDurationFormatted:v,lastActivityFormatted:C,activityScore:f,actionsChange:p,userStatus:y,isAdmin:S,isNew:T,isHidden:k,userName:_,userEmail:A,userAvatar:U,handleSelect:x,viewProfile:D,editPermissions:E,toggleHidden:L,showContextMenu:R,viewDetailedAnalytics:W,exportUserData:G,sendNotification:q,viewAuditLog:oe,deleteUser:Y,handleAvatarError:H,getStatusText:Z}}},i2=["aria-label","aria-selected","aria-describedby"],l2={class:"user-avatar-section"},c2={class:"avatar-container"},d2=["src","alt"],u2=["title"],g2={key:2,class:"new-indicator",title:"Новый пользователь"},m2={class:"user-info-section"},h2={class:"user-header"},f2={class:"user-name"},v2={class:"user-badges"},p2={key:0,class:"badge admin",title:"Администратор"},y2={key:1,class:"badge hidden",title:"Скрытый пользователь"},k2={class:"user-email"},b2={key:0,class:"user-departments"},_2=["title"],w2=["title"],C2={class:"user-metrics-section"},T2={class:"metric primary"},S2={class:"metric-value"},D2=["title"],E2={class:"metric secondary"},A2={class:"metric-value"},$2={key:0,class:"activity-score"},I2={class:"score-bar"},M2=["title"],N2={key:1,class:"mini-metrics"},x2={class:"mini-metric"},L2={class:"mini-metric"},P2={class:"user-actions-section"},O2=["aria-label","title"],R2=["aria-label","title"],B2=["aria-label","title"],U2=["aria-label"],W2=["aria-label"],F2=["aria-label"],H2=["aria-label"],j2=["aria-label"],V2=["aria-label"],z2=["aria-label"],G2=["id"],K2={key:1,class:"selection-indicator","aria-hidden":"true"};function q2(o,e,a,t,r,i){return c(),u("div",{class:X(["unified-user-card",{selected:a.isSelected,"activity-high":t.activityScore>=80,"activity-medium":t.activityScore>=50&&t.activityScore<80,"activity-low":t.activityScore<50,"status-online":t.userStatus==="online","status-away":t.userStatus==="away","status-offline":t.userStatus==="offline","has-departments":t.visibleDepartments.length>0,"is-admin":t.isAdmin,"is-new":t.isNew,"is-hidden":t.isHidden,"compact-view":a.compactView}]),onClick:e[10]||(e[10]=(...n)=>t.handleSelect&&t.handleSelect(...n)),onDblclick:e[11]||(e[11]=(...n)=>t.viewProfile&&t.viewProfile(...n)),onKeydown:[e[12]||(e[12]=Be((...n)=>t.handleSelect&&t.handleSelect(...n),["enter"])),e[13]||(e[13]=Be((...n)=>t.handleSelect&&t.handleSelect(...n),["space"]))],onContextmenu:e[14]||(e[14]=Te((...n)=>t.showContextMenu&&t.showContextMenu(...n),["prevent"])),tabindex:"0",role:"button","aria-label":`Выбрать пользователя ${t.userName}`,"aria-selected":a.isSelected,"aria-describedby":`user-card-${a.user.id}-description`},[s("div",l2,[s("div",c2,[t.userAvatar?(c(),u("img",{key:0,src:t.userAvatar,alt:`Аватар ${t.userName}`,class:"user-avatar",onError:e[0]||(e[0]=(...n)=>t.handleAvatarError&&t.handleAvatarError(...n))},null,40,d2)):(c(),u("div",{key:1,class:"avatar-placeholder",style:we({backgroundColor:t.avatarColor})},m(t.userInitials),5)),s("div",{class:X(["status-indicator",t.userStatus]),title:`Статус: ${t.getStatusText(t.userStatus)}`},null,10,u2),t.isNew?(c(),u("div",g2," NEW ")):$("",!0)])]),s("div",m2,[s("div",h2,[s("h4",f2,m(t.userName),1),s("div",v2,[t.isAdmin?(c(),u("span",p2," Админ ")):$("",!0),t.isHidden?(c(),u("span",y2," Скрыт ")):$("",!0)])]),s("p",k2,m(t.userEmail),1),t.visibleDepartments.length>0?(c(),u("div",b2,[(c(!0),u(ee,null,te(t.visibleDepartments,n=>(c(),u("span",{key:n.id,class:"dept-tag",style:we({backgroundColor:n.color}),title:n.name},m(n.shortName||n.name),13,_2))),128)),t.hiddenDepartmentsCount>0?(c(),u("span",{key:0,class:"dept-more",title:`Ещё ${t.hiddenDepartmentsCount} отделов`}," +"+m(t.hiddenDepartmentsCount),9,w2)):$("",!0)])):$("",!0)]),s("div",C2,[s("div",T2,[s("div",S2,m(t.totalActionsFormatted),1),e[15]||(e[15]=s("div",{class:"metric-label"},"действий",-1)),t.actionsChange!==0?(c(),u("div",{key:0,class:X(["metric-change",{positive:t.actionsChange>0,negative:t.actionsChange<0}]),title:`Изменение: ${t.actionsChange>0?"+":""}${t.actionsChange}%`},m(t.actionsChange>0?"+":"")+m(t.actionsChange)+"% ",11,D2)):$("",!0)]),s("div",E2,[s("div",A2,m(t.lastActivityFormatted),1),e[16]||(e[16]=s("div",{class:"metric-label"},"активность",-1))]),a.compactView?$("",!0):(c(),u("div",$2,[s("div",I2,[s("div",{class:X(["score-fill",{"high-score":t.activityScore>=80,"medium-score":t.activityScore>=50&&t.activityScore<80,"low-score":t.activityScore<50}]),style:we({width:`${t.activityScore}%`})},null,6)]),s("div",{class:"score-label",title:`Уровень активности: ${t.activityScore}/100`},m(t.activityScore)+"/100 ",9,M2)])),a.compactView?(c(),u("div",N2,[s("span",x2,m(t.totalSessionsFormatted)+" сессий",1),s("span",L2,m(t.avgSessionDurationFormatted),1)])):$("",!0)]),s("div",P2,[s("button",{onClick:e[1]||(e[1]=Te((...n)=>t.viewProfile&&t.viewProfile(...n),["stop"])),class:"action-btn primary","aria-label":`Просмотреть профиль ${t.userName}`,title:`Просмотреть профиль ${t.userName}`}," 👁️ ",8,O2),a.canEditPermissions?(c(),u("button",{key:0,onClick:e[2]||(e[2]=Te((...n)=>t.editPermissions&&t.editPermissions(...n),["stop"])),class:"action-btn secondary","aria-label":`Изменить права ${t.userName}`,title:`Изменить права ${t.userName}`}," ⚙️ ",8,R2)):$("",!0),s("button",{onClick:e[3]||(e[3]=Te((...n)=>t.toggleHidden&&t.toggleHidden(...n),["stop"])),class:X(["action-btn tertiary",{active:t.isHidden}]),"aria-label":`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`,title:`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`},m(t.isHidden?"👁️‍🗨️":"🙈"),11,B2),s("button",{onClick:e[4]||(e[4]=Te((...n)=>t.showContextMenu&&t.showContextMenu(...n),["stop"])),class:"action-btn menu","aria-label":`Меню действий для ${t.userName}`,title:"Дополнительные действия"}," ⋮ ",8,U2)]),t.showContextMenuFlag?(c(),u("div",{key:0,class:"context-menu",ref:"contextMenu",role:"menu","aria-label":`Меню действий для ${t.userName}`},[s("button",{onClick:e[5]||(e[5]=(...n)=>t.viewDetailedAnalytics&&t.viewDetailedAnalytics(...n)),class:"menu-item",role:"menuitem","aria-label":`Детальная аналитика для ${t.userName}`}," 📊 Детальная аналитика ",8,F2),s("button",{onClick:e[6]||(e[6]=(...n)=>t.exportUserData&&t.exportUserData(...n)),class:"menu-item",role:"menuitem","aria-label":`Экспорт данных ${t.userName}`}," 📥 Экспорт данных ",8,H2),s("button",{onClick:e[7]||(e[7]=(...n)=>t.sendNotification&&t.sendNotification(...n)),class:"menu-item",role:"menuitem","aria-label":`Отправить уведомление ${t.userName}`}," 📧 Уведомление ",8,j2),s("button",{onClick:e[8]||(e[8]=(...n)=>t.viewAuditLog&&t.viewAuditLog(...n)),class:"menu-item",role:"menuitem","aria-label":`Журнал аудита для ${t.userName}`}," 📋 Журнал аудита ",8,V2),e[17]||(e[17]=s("hr",{class:"menu-divider",role:"separator"},null,-1)),a.canDelete?(c(),u("button",{key:0,onClick:e[9]||(e[9]=(...n)=>t.deleteUser&&t.deleteUser(...n)),class:"menu-item danger",role:"menuitem","aria-label":`Удалить пользователя ${t.userName}`}," 🗑️ Удалить пользователя ",8,z2)):$("",!0)],8,W2)):$("",!0),s("div",{id:`user-card-${a.user.id}-description`,class:"sr-only"}," Пользователь "+m(t.userName)+", email "+m(t.userEmail)+", статус "+m(t.getStatusText(t.userStatus))+", "+m(t.totalActionsFormatted)+" действий, последняя активность "+m(t.lastActivityFormatted)+", уровень активности "+m(t.activityScore)+" из 100. "+m(t.isAdmin?"Администратор.":"")+" "+m(t.isHidden?"Скрытый пользователь.":"")+" "+m(t.visibleDepartments.length>0?`Отделы: ${t.visibleDepartments.map(n=>n.name).join(", ")}.`:""),9,G2),a.isSelected?(c(),u("div",K2,[...e[18]||(e[18]=[s("svg",{viewBox:"0 0 24 24",width:"16",height:"16"},[s("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})],-1)])])):$("",!0)],42,i2)}const Y2=ce(r2,[["render",q2],["__scopeId","data-v-5e790fbc"]]),X2={name:"BulkActionsBar",emits:["execute","clear-selection"],props:{selectedUsers:{type:Array,default:()=>[]},availableActions:{type:Array,default:()=>[]}}},J2={key:0,class:"bulk-actions-bar"},Z2={class:"bar-content"},Q2={class:"selection-info"},eE={class:"selection-count"},tE={class:"selection-text"},aE={class:"actions-list"},sE=["onClick","title"],oE={key:0,class:"action-icon"},nE={class:"action-text"};function rE(o,e,a,t,r,i){return a.selectedUsers.length>0?(c(),u("div",J2,[s("div",Z2,[s("div",Q2,[s("span",eE," Выбрано: "+m(a.selectedUsers.length),1),s("span",tE,m(a.selectedUsers.length===1?"пользователь":"пользователей"),1)]),s("div",aE,[(c(!0),u(ee,null,te(a.availableActions,n=>(c(),u("button",{key:n.id,onClick:l=>o.$emit("execute",n),class:X(["action-btn",n.class]),title:n.description},[n.icon?(c(),u("span",oE,m(n.icon),1)):$("",!0),s("span",nE,m(n.label),1)],10,sE))),128))]),s("button",{onClick:e[0]||(e[0]=n=>o.$emit("clear-selection")),class:"clear-btn",title:"Очистить выбор"}," ✕ ")])])):$("",!0)}const iE=ce(X2,[["render",rE],["__scopeId","data-v-56b78081"]]),lE={name:"VirtualList",emits:["item-click"],props:{items:{type:Array,default:()=>[]},itemHeight:{type:Number,default:50},containerHeight:{type:Number,default:400},bufferSize:{type:Number,default:5}},data(){return{scrollTop:0}},computed:{totalItems(){return this.items.length},totalHeight(){return this.totalItems*this.itemHeight},visibleCount(){return Math.ceil(this.containerHeight/this.itemHeight)+this.bufferSize*2},startIndex(){const o=Math.floor(this.scrollTop/this.itemHeight)-this.bufferSize;return Math.max(0,o)},endIndex(){const o=this.startIndex+this.visibleCount;return Math.min(this.totalItems,o)},visibleItems(){return this.items.slice(this.startIndex,this.endIndex)},offsetTop(){return this.startIndex*this.itemHeight},offsetBottom(){return Math.max(0,this.totalHeight-this.offsetTop-this.visibleItems.length*this.itemHeight)},listHeight(){return Math.min(this.totalHeight,this.containerHeight)}},methods:{handleScroll(o){this.scrollTop=o.target.scrollTop},getItemKey(o,e){return o.id||o.key||e},scrollToIndex(o){const e=Math.max(0,o*this.itemHeight-this.containerHeight/2);this.$refs.container?.scrollTo({top:e,behavior:"smooth"})},scrollToTop(){this.$refs.container?.scrollTo({top:0,behavior:"smooth"})},scrollToBottom(){const o=this.totalHeight-this.containerHeight;this.$refs.container?.scrollTo({top:o,behavior:"smooth"})}}},cE={class:"virtual-list-container",ref:"container"};function dE(o,e,a,t,r,i){return c(),u("div",cE,[s("div",{class:"virtual-list",style:we({height:`${i.listHeight}px`}),onScroll:e[0]||(e[0]=(...n)=>i.handleScroll&&i.handleScroll(...n))},[s("div",{class:"virtual-spacer top",style:we({height:`${i.offsetTop}px`})},null,4),(c(!0),u(ee,null,te(i.visibleItems,(n,l)=>(c(),u("div",{key:i.getItemKey(n,i.startIndex+l),class:"virtual-item"},[hs(o.$slots,"item",{item:n,index:i.startIndex+l},void 0)]))),128)),s("div",{class:"virtual-spacer bottom",style:we({height:`${i.offsetBottom}px`})},null,4)],36)],512)}const uE=ce(lE,[["render",dE],["__scopeId","data-v-302c06ef"]]),gE={name:"PaginationControls",emits:["page-change","per-page-change"],props:{currentPage:{type:Number,required:!0},totalPages:{type:Number,required:!0},totalItems:{type:Number,required:!0},perPage:{type:Number,default:50},showPerPageSelector:{type:Boolean,default:!0},perPageOptions:{type:Array,default:()=>[10,25,50,100]},maxVisiblePages:{type:Number,default:7}},computed:{startItem(){return(this.currentPage-1)*this.perPage+1},endItem(){return Math.min(this.currentPage*this.perPage,this.totalItems)},visiblePages(){const o=[],e=this.totalPages,a=this.currentPage,t=this.maxVisiblePages;if(e<=t)for(let r=1;r<=e;r++)o.push(r);else{const r=Math.max(1,a-Math.floor(t/2)),i=Math.min(e,r+t-1),n=Math.max(1,i-t+1);n>1&&(o.push(1),n>2&&o.push("..."));for(let l=n;l<=i;l++)o.push(l);i<e&&(i<e-1&&o.push("..."),o.push(e))}return o}}},mE={key:0,class:"pagination-controls"},hE={class:"pagination-info"},fE={class:"pagination-text"},vE={class:"pagination-nav"},pE=["disabled"],yE=["disabled"],kE={key:0,class:"page-btn ellipsis",disabled:"","aria-hidden":"true"},bE=["onClick","aria-label","aria-current"],_E=["disabled"],wE=["disabled"],CE={key:0,class:"per-page-selector"},TE=["value"],SE=["value"];function DE(o,e,a,t,r,i){return a.totalPages>1?(c(),u("div",mE,[s("div",hE,[s("span",fE,m(i.startItem)+"-"+m(i.endItem)+" из "+m(a.totalItems.toLocaleString()),1)]),s("div",vE,[s("button",{onClick:e[0]||(e[0]=n=>o.$emit("page-change",1)),disabled:a.currentPage===1,class:"page-btn first","aria-label":"Перейти на первую страницу",title:"Первая страница"}," «« ",8,pE),s("button",{onClick:e[1]||(e[1]=n=>o.$emit("page-change",a.currentPage-1)),disabled:a.currentPage===1,class:"page-btn prev","aria-label":"Перейти на предыдущую страницу",title:"Предыдущая страница"}," ‹ ",8,yE),(c(!0),u(ee,null,te(i.visiblePages,n=>(c(),u(ee,{key:n},[n==="..."?(c(),u("button",kE,m(n),1)):(c(),u("button",{key:1,onClick:l=>o.$emit("page-change",n),class:X({"page-btn":!0,current:n===a.currentPage}),"aria-label":`Перейти на страницу ${n}`,"aria-current":n===a.currentPage?"page":null},m(n),11,bE))],64))),128)),s("button",{onClick:e[2]||(e[2]=n=>o.$emit("page-change",a.currentPage+1)),disabled:a.currentPage===a.totalPages,class:"page-btn next","aria-label":"Перейти на следующую страницу",title:"Следующая страница"}," › ",8,_E),s("button",{onClick:e[3]||(e[3]=n=>o.$emit("page-change",a.totalPages)),disabled:a.currentPage===a.totalPages,class:"page-btn last","aria-label":"Перейти на последнюю страницу",title:"Последняя страница"}," »» ",8,wE)]),a.showPerPageSelector?(c(),u("div",CE,[e[5]||(e[5]=s("label",{for:"per-page-select",class:"per-page-label"},"Показывать:",-1)),s("select",{id:"per-page-select",value:a.perPage,onChange:e[4]||(e[4]=n=>o.$emit("per-page-change",parseInt(n.target.value))),class:"per-page-select","aria-label":"Количество элементов на странице"},[(c(!0),u(ee,null,te(a.perPageOptions,n=>(c(),u("option",{key:n,value:n},m(n),9,SE))),128))],40,TE)])):$("",!0)])):$("",!0)}const EE=ce(gE,[["render",DE],["__scopeId","data-v-59d0e153"]]),AE={name:"UserListPanel",components:{UnifiedUserCard:Y2,BulkActionsBar:iE,VirtualList:uE,PaginationControls:EE},props:{users:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},pagination:{type:Object,default:()=>({current_page:1,per_page:50,total:0,total_pages:0})},filters:{type:Object,default:()=>({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"})},viewOptions:{type:Object,default:()=>({compactView:!1,showExtendedMetrics:!1,itemsPerPage:50})},canEditPermissions:{type:Boolean,default:!1},canDeleteUsers:{type:Boolean,default:!1}},emits:["user-select","user-select-multiple","filters-change","pagination-change","view-options-change","user-action"],setup(o,{emit:e}){const a=M(!1),t=M([]),r=M({...o.filters}),i=M(null),n=M(null),l=I(()=>o.users),d=I(()=>{let P=0;return r.value.search&&P++,r.value.department_ids.length>0&&P++,r.value.activity_filter!=="all"&&P++,r.value.time_range!=="week"&&P++,P}),g=I(()=>{if(!n.value)return 400;const P=n.value.getBoundingClientRect();return Math.max(400,window.innerHeight-P.top-200)}),v=I(()=>[{id:369,name:"Битрикс24 отдел",color:"#2196F3"},{id:366,name:"Сектор 1С",color:"#4CAF50"},{id:370,name:"Отдел аналитики",color:"#FF9800"},{id:371,name:"Техническая поддержка",color:"#F44336"}]),C=I(()=>[{id:"change_department",label:"Изменить отдел",icon:"BuildingIcon",description:"Назначить пользователей в другой отдел"},{id:"toggle_admin",label:"Изменить права администратора",icon:"ShieldIcon",description:"Предоставить или отозвать права администратора"},{id:"export",label:"Экспорт данных",icon:"DownloadIcon",description:"Экспортировать данные выбранных пользователей"},{id:"hide_users",label:"Скрыть пользователей",icon:"EyeOffIcon",description:"Скрыть выбранных пользователей из списка"}]),f=()=>{a.value=!a.value},p=()=>{e("filters-change",{...r.value})},y=()=>{r.value={search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"},p()},S=P=>{const h=r.value.department_ids.indexOf(P);h>-1?r.value.department_ids.splice(h,1):r.value.department_ids.push(P),p()},T=()=>{r.value.sort_order=r.value.sort_order==="asc"?"desc":"asc",p()},k=()=>{const P={...o.viewOptions,compactView:!o.viewOptions.compactView};e("view-options-change",P)},_=()=>{i.value&&clearTimeout(i.value),i.value=setTimeout(A,300)},A=()=>{p()},U=()=>{r.value.search="",p()},x=P=>{D(P)},D=P=>{e("user-select",P)},E=P=>{t.value=P,e("user-select-multiple",P)},L=()=>{t.value=[]},R=P=>{e("user-action","view-profile",P)},W=P=>{e("user-action","edit-permissions",P)},G=P=>{e("user-action","toggle-visibility",P)},q=P=>{e("user-action","view-analytics",P)},oe=P=>{e("user-action","export-data",P)},Y=P=>{e("user-action","delete",P)},H=P=>{e("user-action","bulk-action",{action:P,users:t.value})},Z=P=>{e("pagination-change",P)},fe=P=>{e("pagination-change",1,P)};return Ne(()=>o.filters,P=>{r.value={...P}},{deep:!0}),$e(()=>{Wt(()=>{n.value&&(n.value.style.height=`${g.value}px`)})}),{showFilters:a,selectedUsers:t,localFilters:r,filteredUsers:l,activeFiltersCount:d,listHeight:g,departments:v,bulkActions:C,listContainer:n,toggleFilters:f,applyFilters:p,resetFilters:y,toggleDepartmentFilter:S,toggleSortOrder:T,toggleCompactView:k,debounceSearch:_,applySearch:A,clearSearch:U,handleUserClick:x,handleUserSelect:D,handleUserSelectMultiple:E,clearSelection:L,handleViewProfile:R,handleEditPermissions:W,handleToggleHidden:G,handleViewAnalytics:q,handleExportUserData:oe,handleDeleteUser:Y,handleBulkAction:H,handlePageChange:Z,handlePerPageChange:fe}}},$E={class:"panel-header"},IE={class:"header-content"},ME={class:"panel-title"},NE={key:0,class:"users-count"},xE={class:"header-actions"},LE={class:"search-container"},PE=["aria-expanded"],OE={key:0,class:"filters-count"},RE={class:"view-options"},BE={key:0,class:"filters-panel",role:"region","aria-label":"Панель фильтров"},UE={class:"filters-grid"},WE={class:"filter-group"},FE={class:"departments-filter"},HE=["onClick","aria-label"],jE={class:"filter-group"},VE={class:"filter-group"},zE={class:"filter-group"},GE={class:"sort-controls"},KE=["aria-label"],qE={class:"filter-actions"},YE={class:"users-list-container",role:"list","aria-label":"Список пользователей"},XE={key:0,class:"loading-state"},JE={key:1,class:"empty-state"},ZE={class:"empty-title"},QE={class:"empty-description"};function eA(o,e,a,t,r,i){const n=be("BulkActionsBar"),l=be("UnifiedUserCard"),d=be("VirtualList"),g=be("PaginationControls");return c(),u("div",{class:X(["user-list-panel",{loading:a.loading,empty:!a.loading&&t.filteredUsers.length===0,"compact-view":a.viewOptions.compactView}]),role:"region","aria-label":"Список пользователей"},[s("div",$E,[s("div",IE,[s("h2",ME,[e[16]||(e[16]=ge(" Пользователи ",-1)),a.loading?$("",!0):(c(),u("span",NE," ("+m(a.pagination.total.toLocaleString())+") ",1))]),s("div",xE,[s("div",LE,[Re(s("input",{"onUpdate:modelValue":e[0]||(e[0]=v=>t.localFilters.search=v),type:"text",class:"search-input",placeholder:"Поиск по имени или email...",onInput:e[1]||(e[1]=(...v)=>t.debounceSearch&&t.debounceSearch(...v)),onKeydown:e[2]||(e[2]=Be((...v)=>t.applySearch&&t.applySearch(...v),["enter"])),"aria-label":"Поиск пользователей"},null,544),[[At,t.localFilters.search]]),t.localFilters.search?(c(),u("button",{key:0,onClick:e[3]||(e[3]=(...v)=>t.clearSearch&&t.clearSearch(...v)),class:"search-clear","aria-label":"Очистить поиск"}," ✕ ")):$("",!0),e[17]||(e[17]=s("div",{class:"search-icon","aria-hidden":"true"},"🔍",-1))]),s("button",{onClick:e[4]||(e[4]=(...v)=>t.toggleFilters&&t.toggleFilters(...v)),class:X(["filters-toggle",{active:t.showFilters}]),"aria-label":"Показать/скрыть фильтры","aria-expanded":t.showFilters},[e[18]||(e[18]=s("svg",{class:"filter-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[s("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"})],-1)),e[19]||(e[19]=ge(" Фильтры ",-1)),t.activeFiltersCount>0?(c(),u("span",OE,m(t.activeFiltersCount),1)):$("",!0)],10,PE),s("div",RE,[s("button",{onClick:e[5]||(e[5]=(...v)=>t.toggleCompactView&&t.toggleCompactView(...v)),class:X(["view-toggle",{active:a.viewOptions.compactView}]),"aria-label":"Переключить компактный вид",title:"Компактный вид"},[...e[20]||(e[20]=[s("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[s("path",{d:"M3 3h18v2H3V3zm0 16h18v2H3v16zm0-8h18v2H3v-2z"})],-1)])],2)])])])]),t.showFilters?(c(),u("div",BE,[s("div",UE,[s("div",WE,[e[21]||(e[21]=s("label",{class:"filter-label"},"Отделы:",-1)),s("div",FE,[(c(!0),u(ee,null,te(t.departments,v=>(c(),u("button",{key:v.id,onClick:C=>t.toggleDepartmentFilter(v.id),class:X(["department-chip",{active:t.localFilters.department_ids.includes(v.id)}]),style:we({borderColor:v.color}),"aria-label":`Фильтр по отделу ${v.name}`},[s("span",{class:"dept-dot",style:we({backgroundColor:v.color}),"aria-hidden":"true"},null,4),ge(" "+m(v.name),1)],14,HE))),128))])]),s("div",jE,[e[23]||(e[23]=s("label",{class:"filter-label"},"Активность:",-1)),Re(s("select",{"onUpdate:modelValue":e[6]||(e[6]=v=>t.localFilters.activity_filter=v),class:"filter-select",onChange:e[7]||(e[7]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Фильтр по уровню активности"},[...e[22]||(e[22]=[_t('<option value="all" data-v-8c6ab554>Все пользователи</option><option value="active" data-v-8c6ab554>Активные (80%+)</option><option value="moderate" data-v-8c6ab554>Средне активные (50-80%)</option><option value="inactive" data-v-8c6ab554>Неактивные (&lt;50%)</option><option value="new" data-v-8c6ab554>Новые (за неделю)</option>',5)])],544),[[dt,t.localFilters.activity_filter]])]),s("div",VE,[e[25]||(e[25]=s("label",{class:"filter-label"},"Период:",-1)),Re(s("select",{"onUpdate:modelValue":e[8]||(e[8]=v=>t.localFilters.time_range=v),class:"filter-select",onChange:e[9]||(e[9]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Временной диапазон для фильтрации"},[...e[24]||(e[24]=[_t('<option value="today" data-v-8c6ab554>Сегодня</option><option value="week" data-v-8c6ab554>Эта неделя</option><option value="month" data-v-8c6ab554>Этот месяц</option><option value="quarter" data-v-8c6ab554>Этот квартал</option><option value="year" data-v-8c6ab554>Этот год</option>',5)])],544),[[dt,t.localFilters.time_range]])]),s("div",zE,[e[28]||(e[28]=s("label",{class:"filter-label"},"Сортировка:",-1)),s("div",GE,[Re(s("select",{"onUpdate:modelValue":e[10]||(e[10]=v=>t.localFilters.sort_by=v),class:"filter-select sort-select",onChange:e[11]||(e[11]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Поле сортировки"},[...e[26]||(e[26]=[s("option",{value:"last_activity"},"Последняя активность",-1),s("option",{value:"name"},"Имя",-1),s("option",{value:"email"},"Email",-1),s("option",{value:"total_actions"},"Количество действий",-1)])],544),[[dt,t.localFilters.sort_by]]),s("button",{onClick:e[12]||(e[12]=(...v)=>t.toggleSortOrder&&t.toggleSortOrder(...v)),class:"sort-order-toggle","aria-label":`Изменить порядок сортировки на ${t.localFilters.sort_order==="asc"?"убывающий":"возрастающий"}`},[(c(),u("svg",{class:X({rotated:t.localFilters.sort_order==="desc"}),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[27]||(e[27]=[s("path",{d:"M7 14l5-5 5 5z"},null,-1)])],2))],8,KE)])])]),s("div",qE,[s("button",{onClick:e[13]||(e[13]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"filter-reset-btn"}," Сбросить "),s("button",{onClick:e[14]||(e[14]=(...v)=>t.applyFilters&&t.applyFilters(...v)),class:"filter-apply-btn"}," Применить ")])])):$("",!0),t.selectedUsers.length>0?(c(),he(n,{key:1,"selected-users":t.selectedUsers,"available-actions":t.bulkActions,onExecute:t.handleBulkAction,onClearSelection:t.clearSelection},null,8,["selected-users","available-actions","onExecute","onClearSelection"])):$("",!0),s("div",YE,[a.loading?(c(),u("div",XE,[(c(!0),u(ee,null,te(a.viewOptions.itemsPerPage,v=>(c(),u("div",{key:v,class:"user-skeleton","aria-hidden":"true"},[...e[29]||(e[29]=[_t('<div class="skeleton-avatar" data-v-8c6ab554></div><div class="skeleton-content" data-v-8c6ab554><div class="skeleton-line" data-v-8c6ab554></div><div class="skeleton-line short" data-v-8c6ab554></div></div><div class="skeleton-actions" data-v-8c6ab554><div class="skeleton-button" data-v-8c6ab554></div><div class="skeleton-button" data-v-8c6ab554></div></div>',3)])]))),128))])):t.filteredUsers.length===0?(c(),u("div",JE,[e[30]||(e[30]=s("div",{class:"empty-icon","aria-hidden":"true"},"👥",-1)),s("h3",ZE,m(t.localFilters.search?"Пользователи не найдены":"Нет пользователей"),1),s("p",QE,m(t.localFilters.search?`По запросу "${t.localFilters.search}" ничего не найдено. Попробуйте изменить поиск или сбросить фильтры.`:"В системе ещё нет зарегистрированных пользователей."),1),t.activeFiltersCount>0?(c(),u("button",{key:0,onClick:e[15]||(e[15]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"empty-action-btn"}," Сбросить фильтры ")):$("",!0)])):(c(),he(d,{key:2,items:t.filteredUsers,"item-height":a.viewOptions.compactView?80:120,"container-height":t.listHeight,class:"virtual-users-list",onItemClick:t.handleUserClick},{item:ye(({item:v,index:C})=>[(c(),he(l,{key:v.id,user:v,"is-selected":t.selectedUsers.some(f=>f.id===v.id),"compact-view":a.viewOptions.compactView,"can-edit-permissions":a.canEditPermissions,"can-delete":a.canDeleteUsers,"show-extended-metrics":!a.viewOptions.compactView,onSelect:t.handleUserSelect,onViewProfile:t.handleViewProfile,onEditPermissions:t.handleEditPermissions,onToggleHidden:t.handleToggleHidden,onViewAnalytics:t.handleViewAnalytics,onExportData:t.handleExportUserData,onDeleteUser:t.handleDeleteUser},null,8,["user","is-selected","compact-view","can-edit-permissions","can-delete","show-extended-metrics","onSelect","onViewProfile","onEditPermissions","onToggleHidden","onViewAnalytics","onExportData","onDeleteUser"]))]),_:1},8,["items","item-height","container-height","onItemClick"]))]),!a.loading&&a.pagination.total_pages>1?(c(),he(g,{key:2,"current-page":a.pagination.current_page,"total-pages":a.pagination.total_pages,"total-items":a.pagination.total,"per-page":a.pagination.per_page,onPageChange:t.handlePageChange,onPerPageChange:t.handlePerPageChange},null,8,["current-page","total-pages","total-items","per-page","onPageChange","onPerPageChange"])):$("",!0)],2)}const tA=ce(AE,[["render",eA],["__scopeId","data-v-8c6ab554"]]),aA={name:"AnalysisPanel",emits:["back","filter-change","export"],props:{user:{type:Object,default:null},activityData:{type:Object,default:()=>({})},filters:{type:Object,default:()=>({})},timeRange:{type:String,default:"week"},isLoading:{type:Boolean,default:!1}},methods:{getStatusText(o){switch(o){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},formatDuration(o){const e=Math.floor(o/60),a=Math.floor(o%60);return`${e}:${a.toString().padStart(2,"0")}`},formatLastActivity(o){if(!o)return"Никогда";const e=new Date(o),t=new Date-e,r=Math.floor(t/(1e3*60)),i=Math.floor(t/(1e3*60*60)),n=Math.floor(t/(1e3*60*60*24));return r<1?"только что":r<60?`${r} мин назад`:i<24?`${i} ч назад`:n<7?`${n} д назад`:e.toLocaleDateString("ru-RU")}}},sA={class:"analysis-panel"},oA={class:"analysis-header"},nA={class:"user-summary"},rA={class:"user-avatar"},iA=["src","alt"],lA={key:1,class:"avatar-placeholder"},cA={class:"user-info"},dA={class:"user-email"},uA={class:"user-status"},gA={key:0,class:"admin-badge"},mA={class:"header-actions"},hA={class:"analysis-content"},fA={class:"stats-section"},vA={class:"stats-grid"},pA={class:"stat-card"},yA={class:"stat-value"},kA={class:"stat-card"},bA={class:"stat-value"},_A={class:"stat-card"},wA={class:"stat-value"},CA={class:"stat-card"},TA={class:"stat-value"},SA={class:"activity-section"},DA={class:"last-activity"},EA={key:0,class:"departments-section"},AA={class:"departments-list"};function $A(o,e,a,t,r,i){return c(),u("div",sA,[s("div",oA,[s("div",nA,[s("div",rA,[a.user.avatar?(c(),u("img",{key:0,src:a.user.avatar,alt:`Аватар ${a.user.name}`},null,8,iA)):(c(),u("div",lA,m(a.user.name.charAt(0)),1))]),s("div",cA,[s("h2",null,m(a.user.name),1),s("p",dA,m(a.user.email),1),s("div",uA,[s("span",{class:X(`status-${a.user.status}`)},m(i.getStatusText(a.user.status)),3),a.user.is_admin?(c(),u("span",gA,"Администратор")):$("",!0)])])]),s("div",mA,[s("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку")])]),s("div",hA,[s("div",fA,[e[5]||(e[5]=s("h3",null,"📊 Статистика активности",-1)),s("div",vA,[s("div",pA,[s("div",yA,m(a.user.activity_stats?.total_actions||0),1),e[1]||(e[1]=s("div",{class:"stat-label"},"Всего действий",-1))]),s("div",kA,[s("div",bA,m(a.user.activity_stats?.total_sessions||0),1),e[2]||(e[2]=s("div",{class:"stat-label"},"Сессий",-1))]),s("div",_A,[s("div",wA,m(i.formatDuration(a.user.activity_stats?.avg_session_duration||0)),1),e[3]||(e[3]=s("div",{class:"stat-label"},"Средняя сессия",-1))]),s("div",CA,[s("div",TA,m(a.user.activity_stats?.activity_score||0)+"/100",1),e[4]||(e[4]=s("div",{class:"stat-label"},"Уровень активности",-1))])])]),s("div",SA,[e[6]||(e[6]=s("h3",null,"🕒 Последняя активность",-1)),s("div",DA,[s("p",null,m(i.formatLastActivity(a.user.activity_stats?.last_activity)),1)])]),a.user.departments&&a.user.departments.length>0?(c(),u("div",EA,[e[7]||(e[7]=s("h3",null,"🏢 Отделы",-1)),s("div",AA,[(c(!0),u(ee,null,te(a.user.departments,n=>(c(),u("span",{key:n.id,class:"department-tag",style:we({backgroundColor:n.color})},m(n.name),5))),128))])])):$("",!0),e[8]||(e[8]=s("div",{class:"placeholder-note"},[s("strong",null,"🚧 Следующие возможности в разработке:"),s("ul",null,[s("li",null,"График активности по времени"),s("li",null,"Анализ паттернов использования"),s("li",null,"Сравнение с другими пользователями"),s("li",null,"Экспорт детальной статистики")])],-1))])])}const IA=ce(aA,[["render",$A],["__scopeId","data-v-15fd9d64"]]),MA={name:"ManagementPanel",emits:["back","permissions-change","bulk-update"],props:{selectedUsers:{type:Array,default:()=>[]},allUsers:{type:Array,default:()=>[]},departments:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},methods:{handleBulkPermissions(){this.$emit("bulk-update","change_permissions",{is_admin:!1,department_id:369})}}},NA={class:"management-panel"},xA={class:"panel-placeholder"},LA={key:0,class:"selected-info"},PA={class:"selected-list"},OA={class:"user-name"},RA={class:"user-email"},BA={class:"placeholder-actions"};function UA(o,e,a,t,r,i){return c(),u("div",NA,[s("div",xA,[e[2]||(e[2]=s("div",{class:"placeholder-icon"},"⚙️",-1)),e[3]||(e[3]=s("h3",null,"Панель управления правами",-1)),e[4]||(e[4]=s("p",null,"Управление правами доступа и ролями пользователей",-1)),e[5]||(e[5]=s("div",{class:"placeholder-note"},[s("strong",null,"Статус:"),ge(" В разработке (TASK-089 - Этап 5) ")],-1)),a.selectedUsers.length>0?(c(),u("div",LA,[s("h4",null,"Выбрано пользователей: "+m(a.selectedUsers.length),1),s("div",PA,[(c(!0),u(ee,null,te(a.selectedUsers.slice(0,3),n=>(c(),u("div",{key:n.id,class:"selected-user"},[s("span",OA,m(n.name),1),s("span",RA,m(n.email),1)]))),128))])])):$("",!0),s("div",BA,[s("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку"),a.selectedUsers.length>0?(c(),u("button",{key:0,onClick:e[1]||(e[1]=(...n)=>i.handleBulkPermissions&&i.handleBulkPermissions(...n)),class:"permissions-btn"}," Изменить права ("+m(a.selectedUsers.length)+") ",1)):$("",!0)])])])}const WA=ce(MA,[["render",UA],["__scopeId","data-v-7dfddba5"]]),FA={name:"UnifiedUserManagement",components:{DrillDownNavigation:CS,ContextSidebar:o2,UserListPanel:tA,AnalysisPanel:IA,ManagementPanel:WA},props:{config:{type:Object,default:()=>({enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"})}},setup(o){console.log("[UnifiedUserManagement] Component loaded successfully",o.config);const e=M("global"),a=M(null),t=M(!1),r=M([{id:1,name:"Иван Иванов",email:"ivan@example.com",departments:[{id:369,name:"Битрикс24 отдел",color:"#2196F3"}],is_admin:!0,activity_stats:{total_actions:156,last_activity:new Date().toISOString(),activity_score:85},status:"online"},{id:2,name:"Петр Петров",email:"petr@example.com",departments:[{id:366,name:"Сектор 1С",color:"#4CAF50"}],is_admin:!1,activity_stats:{total_actions:89,last_activity:new Date(Date.now()-864e5).toISOString(),activity_score:67},status:"away"},{id:3,name:"Анна Сидорова",email:"anna@example.com",departments:[],is_admin:!1,activity_stats:{total_actions:23,last_activity:new Date(Date.now()-6048e5).toISOString(),activity_score:35},status:"offline"}]),i=M({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc"}),n=M([{id:"total_users",label:"Всего пользователей",value:r.value.length,change:5.2},{id:"active_users",label:"Активных сегодня",value:r.value.filter(y=>y.status==="online").length,change:12.1},{id:"new_users",label:"Новых сегодня",value:1,change:-2.3}]),l=I(()=>{const y=[{id:"global",label:"Управление пользователями",icon:"UsersIcon",action:()=>d("global")}];return e.value==="user"&&a.value&&y.push({id:`user-${a.value.id}`,label:a.value.name,icon:"UserIcon",action:()=>g(a.value)}),e.value==="management"&&y.push({id:"management",label:"Управление правами",icon:"SettingsIcon",action:()=>d("management")}),y}),d=(y,S={})=>{e.value=y,S.user&&(a.value=S.user),console.log(`[UnifiedUserManagement] Switched to context: ${y}`,S)},g=y=>{a.value=y,d("user",{user:y})};return{currentContext:e,selectedUser:a,loading:t,users:r,filters:i,globalMetrics:n,breadcrumbs:l,handleUserSelect:y=>{g(y)},handleBreadcrumbNavigate:y=>{y.action&&y.action()},handleGoBack:()=>{(e.value==="user"||e.value==="management")&&(d("global"),a.value=null),console.log("[UnifiedUserManagement] Returned to global context")},handleMetricClick:y=>{console.log("Metric clicked:",y)}}}},HA={class:"unified-user-management"},jA={class:"management-grid"},VA={class:"main-content-area"};function zA(o,e,a,t,r,i){const n=be("DrillDownNavigation"),l=be("ContextSidebar"),d=be("UserListPanel"),g=be("AnalysisPanel"),v=be("ManagementPanel");return c(),u("div",HA,[ne(n,{breadcrumbs:t.breadcrumbs,"is-loading":t.loading,onNavigate:t.handleBreadcrumbNavigate,onBack:t.handleGoBack},null,8,["breadcrumbs","is-loading","onNavigate","onBack"]),s("div",jA,[ne(l,{context:t.currentContext,"global-metrics":t.globalMetrics,"selected-user":t.selectedUser,onMetricClick:t.handleMetricClick},null,8,["context","global-metrics","selected-user","onMetricClick"]),s("div",VA,[t.currentContext==="global"?(c(),he(d,{key:0,users:t.users,loading:t.loading,pagination:{current_page:1,total:t.users.length,total_pages:1},filters:t.filters,"can-edit-permissions":!0,"can-delete":!1,onUserSelect:t.handleUserSelect},null,8,["users","loading","pagination","filters","onUserSelect"])):t.currentContext==="user"?(c(),he(g,{key:1,user:t.selectedUser,onBack:t.handleGoBack},null,8,["user","onBack"])):t.currentContext==="management"?(c(),he(v,{key:2,onBack:t.handleGoBack},null,8,["onBack"])):$("",!0)])])])}const GA=ce(FA,[["render",zA],["__scopeId","data-v-953cd27b"]]),KA={name:"UsersManagementPage",components:{UnifiedUserManagement:GA},setup(){const o=Xe();return $e(async()=>{try{if(!(await rt.checkAccess()).allowed){o.push("/");return}if(!await rt.getCurrentUser()){o.push("/");return}console.log("[UsersManagementPage] Access granted - loading unified interface")}catch(e){console.error("[UsersManagementPage] Access check failed:",e),o.push("/")}}),{}}},qA={class:"users-management-page"};function YA(o,e,a,t,r,i){const n=be("UnifiedUserManagement");return c(),u("div",qA,[ne(n,{config:{enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"}})])}const XA=ce(KA,[["render",YA],["__scopeId","data-v-3ef05244"]]);class Pe{static async getCacheStatus(){try{const e=et("/api/admin/cache-status.php");console.log("[CacheManagementService] Fetching cache status from:",e);const a=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(console.log("[CacheManagementService] Response status:",a.status),!a.ok){const r=await a.text();throw console.error("[CacheManagementService] HTTP error:",r),new Error(`HTTP error! status: ${a.status}, message: ${r}`)}const t=await a.json();if(console.log("[CacheManagementService] API result:",t),t.success){let r=t.modules||[];console.log("[CacheManagementService] Modules from API:",r.length,r),r.length===0&&(console.log("[CacheManagementService] Using mock data for UI demonstration"),r=this.getMockModules(),console.log("[CacheManagementService] Mock modules:",r.length));const i=this.categorizeAndSortModules(r);return console.log("[CacheManagementService] Categorized result:",i),i}else throw new Error(t.error||"Failed to get cache status")}catch(e){console.error("[CacheManagementService] Error getting cache status:",e),console.log("[CacheManagementService] Using mock data due to API error");const a=this.getMockModules(),t=this.categorizeAndSortModules(a);return console.log("[CacheManagementService] Mock categorized result:",t),t}}static async clearCache(e){try{const a=et("/api/admin/cache-clear.php"),t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,confirm:!0})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return!0;throw new Error(r.error||"Failed to clear cache")}catch(a){throw console.error("[CacheManagementService] Error clearing cache:",a),a}}static async getCacheStats(){try{const e=et("/api/admin/cache-stats.php"),a=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const t=await a.json();if(t.success)return t.stats||{};throw new Error(t.error||"Failed to get cache stats")}catch(e){throw console.error("[CacheManagementService] Error getting cache stats:",e),e}}static formatCacheSize(e){if(e===0)return"0 B";const a=1024,t=["B","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(a));return Math.round(e/Math.pow(a,r)*100)/100+" "+t[r]}static categorizeAndSortModules(e,a={}){const t=this.generateCacheKey(e),r=this.getCachedResult(t);if(r&&!a.forceRefresh)return r;const i=performance.now(),n=this.performCategorization(e),l=performance.now();return n.metadata={processingTime:l-i,totalModules:e.length,primaryCount:n.primaryModules.length,secondaryCount:n.secondaryModules.length,cached:!1},this.setCachedResult(t,n),n}static performCategorization(e){const a=[],t=[];return e.forEach(r=>{this.validateModule(r),this.PRIMARY_MODULE_IDS.includes(r.id)?a.push({...r,category:"primary",priority:this.PRIMARY_MODULE_PRIORITIES[r.id]||999}):t.push({...r,category:"secondary",groupType:this.getModuleType(r.id)})}),{primaryModules:this.sortPrimaryModules(a),secondaryModules:this.sortSecondaryModules(t)}}static sortPrimaryModules(e){return e.sort((a,t)=>{const r=this.PRIMARY_MODULE_PRIORITIES[a.id]||999,i=this.PRIMARY_MODULE_PRIORITIES[t.id]||999;return r-i})}static sortSecondaryModules(e){return e.sort((a,t)=>{const r=this.getModuleType(a.id),i=this.getModuleType(t.id);return r!==i?this.compareModuleTypes(r,i):a.name.localeCompare(t.name)})}static compareModuleTypes(e,a){const t=["users","activity","webhooks","other"],r=t.indexOf(e),i=t.indexOf(a);return(r===-1?999:r)-(i===-1?999:i)}static getModuleType(e){for(const[a,t]of Object.entries(this.SECONDARY_MODULE_TYPES))if(e.startsWith(t.prefix))return a;return e.includes("time-tracking")?"time-tracking":e.includes("graph")?"graphs":e.includes("dashboard")?"dashboards":"other"}static getModuleTypeConfig(e){return this.SECONDARY_MODULE_TYPES[e]||{title:"🔧 Прочие модули",description:"Дополнительные модули системы"}}static validateModule(e){if(!e||typeof e!="object")throw new Error("Module must be an object");if(!e.id||typeof e.id!="string")throw new Error("Module must have a valid id");if(!e.name||typeof e.name!="string")throw new Error("Module must have a valid name");return!0}static generateCacheKey(e){const a=e.map(t=>t.id).sort().join(",");return btoa(a).substring(0,16)}static getCachedResult(e){const a=this.categorizationCache.get(e);return a?Date.now()-a.timestamp>this.CACHE_TTL?(this.categorizationCache.delete(e),null):{...a.data,metadata:{...a.data.metadata,cached:!0}}:null}static setCachedResult(e,a){if(this.categorizationCache.set(e,{data:{...a,metadata:{...a.metadata,cached:!1}},timestamp:Date.now()}),this.categorizationCache.size>10){const t=this.categorizationCache.keys().next().value;this.categorizationCache.delete(t)}}static clearCategorizationCache(){this.categorizationCache.clear()}static invalidateCacheAfterModuleOperation(){this.clearCategorizationCache()}static getCategorizationStats(){return{cacheSize:this.categorizationCache.size,cacheEntries:Array.from(this.categorizationCache.entries()).map(([e,a])=>({key:e,age:Date.now()-a.timestamp,modulesCount:a.data.primaryModules.length+a.data.secondaryModules.length}))}}static formatTTL(e){return e<60?`${e} сек`:e<3600?`${Math.floor(e/60)} мин`:`${Math.floor(e/3600)} ч`}static formatCreationTime(e){return e<1e3?`${Math.round(e)}мс`:e<6e4?`${Math.round(e/1e3*10)/10}сек`:`${Math.round(e/6e4*10)/10}мин`}static formatCacheHitRatio(e){return`${Math.round(e*100)}%`}static formatDataFreshness(e){return`${Math.round(e*100)}%`}static getExpiryColor(e){if(!e)return"gray";const a=Date.now()/1e3,t=(e-a)/3600;return t>2?"green":t>.5?"yellow":"red"}static getEfficiencyColor(e){return e>=.85?"green":e>=.7?"yellow":"red"}static getCreationTimeColor(e){return e<=2e3?"green":e<=1e4?"yellow":"red"}static getFreshnessColor(e){return e>=.9?"green":e>=.7?"yellow":"red"}static generateModuleMetadata(e){const a=Math.floor(Date.now()/1e3),t=e.metadata||{},r=this.PRIMARY_MODULE_IDS.includes(e.id);return{version:t.version||"1.0",module_id:e.id,module_name:e.name,created_at:t.created_at||a-Math.random()*86400*7,created_by:t.created_by||(Math.random()>.5?"system":"cron"),creation_time_ms:t.creation_time_ms||500+Math.random()*9500,last_accessed_at:t.last_accessed_at||a-Math.random()*3600,access_count:t.access_count||Math.floor(Math.random()*100)+1,expires_at:t.expires_at||a+(e.ttl||3600),ttl_seconds:e.ttl||3600,file_size_bytes:e.total_size||Math.floor(Math.random()*1e7)+1e6,compression_ratio:t.compression_ratio||.7+Math.random()*.3,data_version:t.data_version||`2026.01.12.v${Math.floor(Math.random()*10)+1}`,source_params:t.source_params||{period:r?Math.random()>.5?"weeks":"months":"default",sector_id:e.id.includes("sector-1c")?"1c":"all",filters:Math.random()>.5?["active_only"]:[],limit:Math.floor(Math.random()*1e3)+500},performance_metrics:t.performance_metrics||{avg_response_time_ms:20+Math.random()*80,cache_hit_ratio:.7+Math.random()*.3,data_freshness_score:.8+Math.random()*.2}}}static getMockModules(){const e=Math.floor(Date.now()/1e3);return[{id:"dashboard-sector-1c",name:"Дашборд сектора 1С",status:"active",file_count:5,total_size:1024e3,ttl:600,created_at:e-7200,expires_at:e+1800,cache_dir:"api/cache/dashboard-sector-1c"},{id:"graph-state",name:"График состояния",status:"active",file_count:3,total_size:512e3,ttl:3600,created_at:e-3600,expires_at:e+7200,cache_dir:"api/cache/graph-state"},{id:"graph-admission-closure-weeks",name:"График приема/закрытий 1С (4 недели)",status:"active",file_count:8,total_size:2048e3,ttl:300,created_at:e-1800,expires_at:e+120,cache_dir:"api/cache/graph-admission-closure/weeks"},{id:"graph-admission-closure-months",name:"График приема/закрытий 1С (3 месяца)",status:"active",file_count:12,total_size:3072e3,ttl:300,created_at:e-3600,expires_at:e+240,cache_dir:"api/cache/graph-admission-closure/months"},{id:"time-tracking-default",name:"Трудозатраты (режим по умолчанию)",status:"active",file_count:4,total_size:768e3,ttl:300,created_at:e-900,expires_at:e+2100,cache_dir:"api/cache/time-tracking-sector-1c/default"},{id:"time-tracking-detailed",name:"Трудозатраты (детальный режим)",status:"active",file_count:6,total_size:1536e3,ttl:120,created_at:e-600,expires_at:e+3540,cache_dir:"api/cache/time-tracking-sector-1c/detailed"},{id:"time-tracking-summary",name:"Трудозатраты (сводный режим)",status:"active",file_count:2,total_size:384e3,ttl:600,created_at:e-1800,expires_at:e+4200,cache_dir:"api/cache/time-tracking-sector-1c/summary"},{id:"users-management-departments",name:"Управление пользователями (отделы)",status:"active",file_count:2,total_size:256e3,ttl:3600,created_at:e-7200,expires_at:e+28800,cache_dir:"api/cache/users-management/departments"},{id:"webhook-logs-api",name:"Логи вебхуков (API запросы)",status:"active",file_count:15,total_size:512e4,ttl:300,created_at:e-3600,expires_at:e+2400,cache_dir:"api/cache/webhook-logs/api"}]}static enrichModulesWithMetadata(e){return e.map(a=>({...a,metadata:this.generateModuleMetadata(a)}))}}Fe(Pe,"PRIMARY_MODULE_IDS",["dashboard-sector-1c","graph-state","graph-admission-closure-weeks","graph-admission-closure-months","time-tracking-default","time-tracking-detailed","time-tracking-summary"]),Fe(Pe,"PRIMARY_MODULE_PRIORITIES",{"dashboard-sector-1c":1,"graph-state":2,"graph-admission-closure-weeks":3,"graph-admission-closure-months":4,"time-tracking-default":5,"time-tracking-detailed":6,"time-tracking-summary":7}),Fe(Pe,"SECONDARY_MODULE_TYPES",{users:{prefix:"users-management",title:"👥 Управление пользователями",description:"Модули для управления пользователями и отделами"},activity:{prefix:"user-activity",title:"📊 Отслеживание активности",description:"Мониторинг активности пользователей"},webhooks:{prefix:"webhook-logs",title:"🔗 Логи вебхуков",description:"Логирование и мониторинг вебхуков"}}),Fe(Pe,"categorizationCache",new Map),Fe(Pe,"CACHE_TTL",3e4);function JA(o){const e=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}class xa{static async createCache(e,a=null,t={}){try{const r=et("/api/admin/cache-create.php"),i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,mode:a,params:t})});if(!i.ok){const l=await i.json().catch(()=>({}));throw new Error(l.error||`HTTP error! status: ${i.status}`)}const n=await i.json();if(n.success)return n;throw new Error(n.error||"Failed to create cache")}catch(r){throw console.error("[CacheCreationService] Error creating cache:",r),r}}static async getCreationStatus(e){try{const a=et(`/api/admin/cache-create-status.php?task_id=${e}`),t=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return r;throw new Error(r.error||"Failed to get creation status")}catch(a){throw console.error("[CacheCreationService] Error getting creation status:",a),a}}static getDefaultParams(e){if(e.includes("graph-admission-closure"))if((e.includes("weeks")?"weeks":"months")==="weeks"){const t=new Date,r=t.getUTCFullYear(),i=JA(t),n=new Date(r,0,1+(i-1)*7),l=n.getUTCDay(),d=n.getUTCDate()-l+(l===0?-6:1);n.setUTCDate(d),n.setUTCHours(0,0,0,0);const g=new Date(n);return g.setUTCDate(n.getUTCDate()+6),g.setUTCHours(23,59,59,999),{product:"1C",periodMode:"weeks",weekStartUtc:n.toISOString(),weekEndUtc:g.toISOString(),includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,useCache:!0,forceRefresh:!0}}else return{product:"1C",periodMode:"months",includeTickets:!0,includeNewTicketsByStages:!1,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!1};if(e.includes("dashboard-sector-1c"))return{forceRefresh:!0,ttl:600};if(e.includes("graph-state"))return{type:"current",forceRefresh:!0,ttl:3600};if(e.includes("time-tracking")){const a=e.includes("detailed")?"detailed":e.includes("summary")?"summary":"default";return{product:"1C",includeTaskDetails:a==="detailed",summary:a==="summary"}}return{}}}let da=class{static notifyCacheCreationStarted(e){this.showNotification({content:`Начато создание кеша для модуля "${e}"...`,type:"info",autoHideDelay:3e3})}static notifyCacheCreationSuccess(e){this.showNotification({content:`✅ Кеш для модуля "${e}" успешно создан`,type:"success",autoHideDelay:5e3})}static notifyCacheCreationError(e,a){this.showNotification({content:`❌ Ошибка создания кеша для модуля "${e}": ${a}`,type:"error",autoHideDelay:7e3})}static notifyCacheUpdated(e,a="auto"){const t=a==="manual"?"вручную":"автоматически";this.showNotification({content:`🔄 Кеш для модуля "${e}" обновлён ${t}`,type:"info",autoHideDelay:4e3})}static notifyCacheUsed(e){this.showNotification({content:`⚡ Использован кеш для модуля "${e}"`,type:"success",autoHideDelay:3e3})}static showNotification(e){typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:e.content,autoHideDelay:e.autoHideDelay||3e3}):console.log("[CacheNotification]",e.content)}};const ZA=Object.freeze(Object.defineProperty({__proto__:null,CacheNotificationService:da},Symbol.toStringTag,{value:"Module"})),QA={name:"CacheCreateProgress",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},message:{type:String,default:"Создание кеша..."}}},e$={class:"cache-create-progress"},t$={class:"progress-bar"},a$={class:"progress-text"};function s$(o,e,a,t,r,i){return c(),u("div",e$,[s("div",t$,[s("div",{class:"progress-fill",style:we({width:a.progress+"%"})},null,4)]),s("div",a$,m(a.progress)+"% - "+m(a.message),1)])}const o$=ce(QA,[["render",s$],["__scopeId","data-v-7071de3b"]]),n$={name:"CacheCreateModal",components:{CacheCreateProgress:o$},props:{module:{type:Object,required:!0}},emits:["close","create"],setup(o,{emit:e}){const a=M(!1),t=M(0),r=M(""),i=M(null),n=M(""),l=I(()=>o.module.id.includes("graph-admission-closure")||o.module.id.includes("time-tracking")),d=I(()=>o.module.id.includes("graph-admission-closure")?["months","weeks"]:o.module.id.includes("time-tracking")?["default","detailed","summary"]:[]),g=()=>{e("close")},v=f=>{f.preventDefault(),f.stopPropagation(),f.target===f.currentTarget&&g()},C=async()=>{a.value=!0,t.value=0,r.value="Начало создания кеша...";try{let f={};if(n.value.trim())try{f=JSON.parse(n.value)}catch{throw new Error("Неверный формат JSON параметров")}else f=xa.getDefaultParams(o.module.id);da.notifyCacheCreationStarted(o.module.name),t.value=25,r.value="Загрузка данных из Bitrix24...";const p=await xa.createCache(o.module.id,i.value,f);t.value=75,r.value="Сохранение кеша...",await new Promise(y=>setTimeout(y,500)),t.value=100,r.value="Кеш успешно создан!",da.notifyCacheCreationSuccess(o.module.name),setTimeout(()=>{e("create",p),g()},1e3)}catch(f){console.error("[CacheCreateModal] Error creating cache:",f),da.notifyCacheCreationError(o.module.name,f.message),a.value=!1}};return $e(()=>{d.value.length>0&&(i.value=d.value[0]);const f=xa.getDefaultParams(o.module.id);n.value=JSON.stringify(f,null,2)}),{creating:a,progress:t,progressMessage:r,selectedMode:i,paramsJson:n,supportsModes:l,availableModes:d,close:g,handleOverlayClick:v,handleCreate:C}}},r$={class:"modal-header"},i$={class:"modal-body"},l$={key:1,class:"create-form"},c$={key:0,class:"form-group"},d$=["value"],u$={class:"form-group"},g$={class:"modal-footer"},m$=["disabled"],h$=["disabled"],f$={key:0},v$={key:1};function p$(o,e,a,t,r,i){const n=be("CacheCreateProgress");return c(),he(It,{to:"body"},[s("div",{class:"modal-overlay",onClick:e[6]||(e[6]=(...l)=>t.handleOverlayClick&&t.handleOverlayClick(...l))},[s("div",{class:"modal-content",onClick:e[5]||(e[5]=Te(()=>{},["stop"])),style:{"pointer-events":"auto"}},[s("div",r$,[s("h2",null,"Создание кеша: "+m(a.module.name),1),s("button",{onClick:e[0]||(e[0]=(...l)=>t.close&&t.close(...l)),class:"btn-close"},"×")]),s("div",i$,[t.creating?(c(),he(n,{key:0,progress:t.progress,message:t.progressMessage},null,8,["progress","message"])):(c(),u("div",l$,[t.supportsModes?(c(),u("div",c$,[e[7]||(e[7]=s("label",null,"Режим кеша:",-1)),Re(s("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>t.selectedMode=l),class:"form-control"},[(c(!0),u(ee,null,te(t.availableModes,l=>(c(),u("option",{key:l,value:l},m(l),9,d$))),128))],512),[[dt,t.selectedMode]])])):$("",!0),s("div",u$,[e[8]||(e[8]=s("label",null,"Параметры (JSON):",-1)),Re(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=l=>t.paramsJson=l),placeholder:'{"product": "1C", ...}',rows:"5",class:"form-control"},null,512),[[At,t.paramsJson]]),e[9]||(e[9]=s("small",{class:"form-text"},"Оставьте пустым для использования параметров по умолчанию",-1))])]))]),s("div",g$,[s("button",{onClick:e[3]||(e[3]=(...l)=>t.close&&t.close(...l)),class:"btn-cancel",disabled:t.creating},"Отмена",8,m$),s("button",{onClick:e[4]||(e[4]=(...l)=>t.handleCreate&&t.handleCreate(...l)),disabled:t.creating,class:"btn-create"},[t.creating?(c(),u("span",f$,"Создание...")):(c(),u("span",v$,"Создать кеш"))],8,h$)])])])])}const y$=ce(n$,[["render",p$],["__scopeId","data-v-1fa7d83b"]]),k$={name:"CacheCreateButton",components:{CacheCreateModal:y$},props:{module:{type:Object,required:!0}},emits:["created"],setup(o,{emit:e}){const a=M(!1),t=M(!1);return{showModal:a,creating:t,openModal:()=>{a.value=!0},closeModal:()=>{a.value=!1},handleCreate:async l=>{t.value=!0;try{e("created",l)}finally{t.value=!1}}}}},b$={class:"cache-create-button"},_$=["disabled"],w$={key:0},C$={key:1};function T$(o,e,a,t,r,i){const n=be("CacheCreateModal");return c(),u("div",b$,[s("button",{onClick:e[0]||(e[0]=(...l)=>t.openModal&&t.openModal(...l)),disabled:t.creating,class:X(["btn-create",{"btn-disabled":t.creating}])},[t.creating?(c(),u("span",w$,"Создание...")):(c(),u("span",C$,"➕ Создать кеш"))],10,_$),t.showModal?(c(),he(n,{key:0,module:a.module,onClose:t.closeModal,onCreate:t.handleCreate},null,8,["module","onClose","onCreate"])):$("",!0)])}const S$=ce(k$,[["render",T$],["__scopeId","data-v-45e7d308"]]);class Ye{static success(e,a,t={}){this.show("success",e,a,t)}static error(e,a,t={}){this.show("error",e,a,t)}static warning(e,a,t={}){this.show("warning",e,a,t)}static info(e,a,t={}){this.show("info",e,a,t)}static show(e,a,t,r={}){const i={autoHideDelay:r.autoHideDelay||5e3,position:r.position||"top-right",...r};this.isBitrix24Available()?this.showBitrix24Notification(e,a,t,i):this.showFallbackNotification(e,a,t,i)}static isBitrix24Available(){return typeof window<"u"&&window.BX&&window.BX.UI&&window.BX.UI.Notification&&window.BX.UI.Notification.Center&&typeof window.BX.UI.Notification.Center.notify=="function"}static showBitrix24Notification(e,a,t,r){try{const n={success:"success",error:"error",warning:"warning",info:"info"}[e]||"info",l=a?`${a}: ${t}`:t;window.BX.UI.Notification.Center.notify({content:l,autoHideDelay:r.autoHideDelay,category:`cache-management-${e}`,position:r.position}),console.log(`[NotificationSystem] Bitrix24 notification shown: ${e}`,{title:a,message:t,config:r})}catch(i){console.error("[NotificationSystem] Error showing Bitrix24 notification:",i),this.showFallbackNotification(e,a,t,r)}}static showFallbackNotification(e,a,t,r){if("Notification"in window&&Notification.permission==="granted")try{const i=new Notification(a||"Уведомление",{body:t,icon:this.getIconForType(e),tag:`cache-management-${e}`});setTimeout(()=>{i.close()},r.autoHideDelay),console.log(`[NotificationSystem] Browser notification shown: ${e}`,{title:a,message:t});return}catch(i){console.warn("[NotificationSystem] Browser notification failed:",i)}this.showCustomNotification(e,a,t,r)}static showCustomNotification(e,a,t,r){let i=document.getElementById("notification-container");if(!i){i=document.createElement("div"),i.id="notification-container",i.className="notification-container",document.body.appendChild(i);const d=document.createElement("style");d.textContent=this.getNotificationStyles(),document.head.appendChild(d)}const n=document.createElement("div");n.className=`custom-notification notification-${e}`,n.innerHTML=`
      <div class="notification-content">
        <div class="notification-title">${a||""}</div>
        <div class="notification-message">${t}</div>
      </div>
      <button class="notification-close" aria-label="Закрыть уведомление">×</button>
    `,n.querySelector(".notification-close").addEventListener("click",()=>{this.removeCustomNotification(n)}),i.appendChild(n),setTimeout(()=>{this.removeCustomNotification(n)},r.autoHideDelay),console.log(`[NotificationSystem] Custom notification shown: ${e}`,{title:a,message:t})}static removeCustomNotification(e){e&&e.parentNode&&(e.classList.add("notification-hiding"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}static getIconForType(e){const a={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"};return a[e]||a.info}static getNotificationStyles(){return`
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        pointer-events: none;
      }

      .custom-notification {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        min-width: 300px;
        max-width: 500px;
        pointer-events: auto;
        opacity: 0;
        transform: translateX(100%);
        animation: notificationSlideIn 0.3s ease forwards;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 16px;
        gap: 12px;
      }

      .custom-notification.notification-success {
        border-left-color: #28a745;
      }

      .custom-notification.notification-error {
        border-left-color: #dc3545;
      }

      .custom-notification.notification-warning {
        border-left-color: #ffc107;
      }

      .custom-notification.notification-info {
        border-left-color: #17a2b8;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #333;
      }

      .notification-message {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
      }

      .notification-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        flex-shrink: 0;
      }

      .notification-close:hover {
        color: #333;
      }

      .notification-hiding {
        animation: notificationSlideOut 0.3s ease forwards;
      }

      @keyframes notificationSlideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes notificationSlideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      @media (max-width: 768px) {
        .notification-container {
          left: 10px;
          right: 10px;
          top: 10px;
        }

        .custom-notification {
          min-width: auto;
          max-width: none;
        }
      }
    `}static clearAll(){try{this.isBitrix24Available()&&window.BX.UI.Notification.Center.clearAll&&window.BX.UI.Notification.Center.clearAll()}catch(a){console.warn("[NotificationSystem] Error clearing Bitrix24 notifications:",a)}const e=document.getElementById("notification-container");if(e&&(e.innerHTML=""),"Notification"in window&&"getNotifications"in Notification)try{Notification.getNotifications().forEach(t=>{t.tag&&t.tag.startsWith("cache-management-")&&t.close()})}catch(a){console.warn("[NotificationSystem] Error clearing browser notifications:",a)}}}Ye.show.bind(Ye);Ye.success.bind(Ye);Ye.error.bind(Ye);Ye.warning.bind(Ye);Ye.info.bind(Ye);let Ve=null,ot=null;const Ot=class Ot{static show(e={}){return new Promise((a,t)=>{ot=a,Ve||(Ve=this.createModal(),document.body.appendChild(Ve)),this.configureModal(e),this.showModal()})}static hide(){Ve&&(this.hideModal(),ot&&(ot(!1),ot=null))}static createModal(){const e=document.createElement("div");return e.className="cache-confirmation-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","confirmation-title"),e.setAttribute("aria-describedby","confirmation-message"),e.innerHTML=`
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="confirmation-title" class="modal-title"></h3>
          <button
            class="modal-close"
            data-action="cancel"
            aria-label="Закрыть окно подтверждения"
          >
            ×
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-icon">
            <span class="icon-symbol"></span>
          </div>
          <p id="confirmation-message" class="modal-message"></p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-cancel" data-action="cancel"></button>
          <button class="btn btn-confirm" data-action="confirm"></button>
        </div>
      </div>
    `,this.attachEventListeners(e),this.addStyles(),e}static configureModal(e){const{title:a="Подтверждение действия",message:t="Вы уверены, что хотите выполнить это действие?",type:r="warning",confirmText:i="Подтвердить",cancelText:n="Отмена",showCancel:l=!0}=e,d=Ve.querySelector(".modal-title");d.textContent=a;const g=Ve.querySelector(".modal-message");g.textContent=t;const v=Ve.querySelector(".icon-symbol"),C={danger:"⚠️",warning:"⚠️",info:"ℹ️",success:"✅"};v.textContent=C[r]||C.warning;const f=Ve.querySelector(".btn-cancel"),p=Ve.querySelector(".btn-confirm");f.textContent=n,p.textContent=i,l?f.style.display="inline-block":f.style.display="none",Ve.className=`cache-confirmation-modal modal-${r}`}static showModal(){document.body.style.overflow="hidden",Ve.style.display="flex",Ve.classList.add("modal-visible"),setTimeout(()=>{const e=Ve.querySelector(".btn-confirm");e&&e.focus()},100),document.addEventListener("keydown",this.handleKeyDown)}static hideModal(){document.body.style.overflow="",Ve.classList.remove("modal-visible"),document.removeEventListener("keydown",this.handleKeyDown),setTimeout(()=>{Ve&&(Ve.style.display="none")},300)}static attachEventListeners(e){e.addEventListener("click",a=>{const t=a.target.closest("[data-action]")?.getAttribute("data-action");t==="confirm"?this.handleConfirm():t==="cancel"&&this.handleCancel()})}static handleConfirm(){ot&&(ot(!0),ot=null),this.hideModal()}static handleCancel(){ot&&(ot(!1),ot=null),this.hideModal()}static handleTabNavigation(e){const t=Ve.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=t[0],i=t[t.length-1];e.shiftKey?document.activeElement===r&&(e.preventDefault(),i.focus()):document.activeElement===i&&(e.preventDefault(),r.focus())}static addStyles(){if(document.getElementById("cache-confirmation-styles"))return;const e=document.createElement("style");e.id="cache-confirmation-styles",e.textContent=`
      .cache-confirmation-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .cache-confirmation-modal.modal-visible {
        display: flex;
      }

      .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        z-index: 10001;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: #f0f0f0;
        color: #333;
      }

      .modal-body {
        padding: 24px;
        text-align: center;
      }

      .modal-icon {
        margin-bottom: 16px;
      }

      .icon-symbol {
        font-size: 48px;
        display: block;
      }

      .modal-message {
        margin: 0;
        font-size: 16px;
        color: #555;
        line-height: 1.5;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px 24px;
        border-top: 1px solid #e0e0e0;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
      }

      .btn-cancel {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
      }

      .btn-cancel:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }

      .btn-confirm {
        background: #007bff;
        color: white;
      }

      .btn-confirm:hover {
        background: #0056b3;
      }

      /* Типы модальных окон */
      .modal-danger .btn-confirm {
        background: #dc3545;
      }

      .modal-danger .btn-confirm:hover {
        background: #c82333;
      }

      .modal-warning .btn-confirm {
        background: #ffc107;
        color: #212529;
      }

      .modal-warning .btn-confirm:hover {
        background: #e0a800;
      }

      .modal-info .btn-confirm {
        background: #17a2b8;
      }

      .modal-info .btn-confirm:hover {
        background: #138496;
      }

      .modal-success .btn-confirm {
        background: #28a745;
      }

      .modal-success .btn-confirm:hover {
        background: #1e7e34;
      }

      /* Адаптивность */
      @media (max-width: 480px) {
        .modal-content {
          margin: 20px;
          width: calc(100% - 40px);
        }

        .modal-header,
        .modal-body,
        .modal-footer {
          padding-left: 20px;
          padding-right: 20px;
        }

        .modal-footer {
          flex-direction: column-reverse;
        }

        .btn {
          width: 100%;
        }
      }

      /* Доступность */
      @media (prefers-reduced-motion: reduce) {
        .modal-content,
        .modal-close,
        .btn {
          animation: none;
          transition: none;
        }
      }

      /* Высокий контраст */
      @media (prefers-contrast: high) {
        .modal-content {
          border: 2px solid #000;
        }

        .btn-cancel {
          border: 2px solid #000;
        }

        .btn-confirm {
          border: 2px solid #000;
        }
      }
    `,document.head.appendChild(e)}};Fe(Ot,"handleKeyDown",e=>{switch(e.key){case"Enter":e.preventDefault(),Ot.handleConfirm();break;case"Escape":e.preventDefault(),Ot.handleCancel();break;case"Tab":Ot.handleTabNavigation(e);break}});let $t=Ot;$t.show.bind($t);$t.hide.bind($t);const D$={name:"CacheModuleCard",components:{CacheCreateButton:S$},props:{module:{type:Object,required:!0,validator:o=>o&&typeof o.id=="string"&&typeof o.name=="string"},isPrimary:{type:Boolean,default:!1},priority:{type:Number,default:999},groupType:{type:String,default:null}},emits:["clear","refresh","details"],setup(o,{emit:e}){const a=M(!1),t=M(!1),r=M(!1),i=M(!1),n=b=>{if(!b.target.closest(".action-button"))switch(b.key){case"Enter":case" ":b.preventDefault();const O=b.currentTarget.querySelector(".action-button:not([disabled])");O&&O.focus();break}};$e(()=>{const b=()=>{i.value=window.innerWidth<768};b(),window.addEventListener("resize",b);const O=document.querySelector(`[data-module-id="${o.module.id}"]`);O&&O.addEventListener("keydown",n)}),at(()=>{const b=document.querySelector(`[data-module-id="${o.module.id}"]`);b&&b.removeEventListener("keydown",n)});const l=I(()=>({"cache-module-card":!0,"primary-module":o.isPrimary,"secondary-module":!o.isPrimary,"high-priority":o.priority<=3,"expiring-soon":S.value,"empty-cache":p.value,loading:a.value||t.value,[w.value]:!0})),d=I(()=>o.isPrimary?"🏆":{users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"}[o.groupType]||"🔧"),g=I(()=>({"primary-icon":o.isPrimary,"secondary-icon":!o.isPrimary})),v=I(()=>o.isPrimary?"Основной модуль":o.groupType?Pe.getModuleTypeConfig(o.groupType).title||"Неизвестная группа":""),C=I(()=>o.priority?`priority-${o.priority}`:""),f=I(()=>`status-${o.module.status||"empty"}`),p=I(()=>(o.module.file_count||0)===0),y=I(()=>o.module.expires_at?new Date(o.module.expires_at*1e3)<=new Date:!1),S=I(()=>{if(!o.module.expires_at)return!1;const Q=(new Date(o.module.expires_at*1e3)-new Date)/(1e3*60*60);return Q>0&&Q<=2}),T=I(()=>{const b=o.module.status;return b==="active"?"Активен":b==="expired"?"Просрочен":b==="empty"?"Пуст":"Неизвестен"}),k=I(()=>Pe.formatCacheSize(o.module.total_size||0)),_=I(()=>Pe.formatTTL(o.module.ttl||0)),A=I(()=>{if(!o.module.cache_dir)return"";const b=o.module.cache_dir.split("/");return b.length>2?"..."+b.slice(-2).join("/"):o.module.cache_dir}),U=I(()=>o.module.metadata?.creation_time_ms?Pe.formatCreationTime(o.module.metadata.creation_time_ms):"—"),x=I(()=>{if(!o.module.metadata?.last_accessed_at)return"—";const b=new Date(o.module.metadata.last_accessed_at*1e3),Q=new Date-b;return Q<6e4?"Только что":Q<36e5?`${Math.floor(Q/6e4)} мин назад`:b.toLocaleString("ru-RU",{hour:"2-digit",minute:"2-digit"})}),D=I(()=>o.module.metadata?.access_count||0),E=I(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?Pe.formatCacheHitRatio(o.module.metadata.performance_metrics.cache_hit_ratio):"—"),L=I(()=>o.module.metadata?.performance_metrics?.data_freshness_score?Pe.formatDataFreshness(o.module.metadata.performance_metrics.data_freshness_score):"—"),R=I(()=>o.module.expires_at?`metric-${Pe.getExpiryColor(o.module.expires_at)}`:""),W=I(()=>o.module.metadata?.creation_time_ms?`metric-${Pe.getCreationTimeColor(o.module.metadata.creation_time_ms)}`:""),G=I(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?`metric-${Pe.getEfficiencyColor(o.module.metadata.performance_metrics.cache_hit_ratio)}`:""),q=I(()=>o.module.metadata?.performance_metrics?.data_freshness_score?`metric-${Pe.getFreshnessColor(o.module.metadata.performance_metrics.data_freshness_score)}`:""),oe=I(()=>{if(!o.module.expires_at)return null;const b=new Date(o.module.expires_at*1e3);return Math.max(0,Math.floor((b-new Date)/1e3))}),Y=I(()=>{if(oe.value===null)return"—";if(oe.value<=0)return"Истек";const b=Math.floor(oe.value/3600),O=Math.floor(oe.value%3600/60),Q=oe.value%60;return b>0?`${b}ч ${O}м`:O>0?`${O}м ${Q}с`:`${Q}с`}),H=I(()=>oe.value===null?"":oe.value<=0||oe.value<=1800?"metric-red":oe.value<=7200?"metric-orange":"metric-green"),Z=b=>{if(b===0)return"0 B";const O=1024,Q=["B","KB","MB","GB","TB"],de=Math.floor(Math.log(b)/Math.log(O));return parseFloat((b/Math.pow(O,de)).toFixed(1))+" "+Q[de]},fe=b=>b<60?`${b}с`:b<3600?`${Math.floor(b/60)}м`:b<86400?`${Math.floor(b/3600)}ч`:`${Math.floor(b/86400)}д`,P=I(()=>{if(p.value)return"empty";if(y.value)return"expired";const b=oe.value;return b===null?"fresh":b<=0?"expired":b<=30*60*1e3?"critical":b<=2*60*60*1e3?"warning":"fresh"}),h=I(()=>{const b=P.value;return{fresh:"Свежий кеш",warning:"Истекает скоро",critical:"Критически истекает",expired:"Просрочен",empty:"Кеш пуст"}[b]||"Неизвестное состояние"}),w=I(()=>`cache-state-${P.value}`),B=I(()=>({fresh:"🟢",warning:"🟡",critical:"🔴",expired:"⚫",empty:"⚪"})[P.value]||"❓"),re=I(()=>!p.value&&!a.value),le=I(()=>o.isPrimary&&!p.value),se=I(()=>p.value?"Кеш модуля пуст":`Очистить кеш модуля ${o.module.name}`),me=I(()=>{if(!o.module.created_at)return"—";const b=new Date(o.module.created_at*1e3),O=new Date,Q=O-b;if(Q<6e4)return"Только что";if(Q<36e5){const ke=Math.floor(Q/6e4);return`${ke} ${ke===1?"минуту":ke<5?"минуты":"минут"} назад`}if(b.toDateString()===O.toDateString())return`Сегодня в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`;const de=new Date(O);return de.setDate(de.getDate()-1),b.toDateString()===de.toDateString()?`Вчера в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`:b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),De=I(()=>{if(!o.module.expires_at)return"—";const b=new Date(o.module.expires_at*1e3),Q=b-new Date;if(Q<0)return`Просрочен (${b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})`;const de=Math.floor(Q/6e4),ke=Math.floor(de/60);return ke>0?`${ke} ч ${de%60} мин`:de>0?`${de} мин`:"Менее минуты"});return{clearing:a,creating:t,showDetailModal:r,isMobile:i,moduleClasses:l,moduleIcon:d,iconClass:g,moduleTypeText:v,priorityClass:C,statusClass:f,isEmpty:p,isExpired:y,isExpiringSoon:S,statusText:T,formattedSize:k,formattedTTL:_,shortCacheDir:A,formattedCreationTime:U,formattedLastAccess:x,accessCount:D,cacheEfficiency:E,dataFreshness:L,expiresClass:R,creationTimeClass:W,cacheEfficiencyClass:G,dataFreshnessClass:q,cacheState:P,cacheStateText:h,cacheStateClass:w,cacheStateIcon:B,timeToExpiry:oe,formatTimeToExpiry:Y,timeToExpiryClass:H,formatBytes:Z,formatTTL:fe,canClear:re,canShowDetails:le,clearButtonLabel:se,formattedCreatedAt:me,formattedExpiresAt:De,handleClear:async()=>{if(re.value)try{if(!await $t.show({title:"Подтверждение очистки кеша",message:`Вы действительно хотите очистить кеш модуля "${o.module.name}"?

Это действие нельзя отменить.`,type:"danger",confirmText:"🗑️ Очистить кеш",cancelText:"Отмена"}))return;a.value=!0,await Pe.clearCache(o.module.id),e("clear",o.module.id),Ye.success("Кеш успешно очищен",`Кеш модуля "${o.module.name}" был полностью очищен`)}catch(b){console.error("[CacheModuleCard] Error clearing cache:",b),Ye.error("Ошибка очистки кеша",`Не удалось очистить кеш модуля "${o.module.name}": ${b.message}`)}finally{a.value=!1}},handleCacheCreated:()=>{Pe.invalidateCacheAfterModuleOperation(),e("refresh")},handleCreatingState:b=>{t.value=b},showDetails:()=>{r.value=!0,e("details",o.module)},closeDetails:()=>{r.value=!1}}}},E$=["aria-labelledby","aria-describedby","data-module-id"],A$={class:"card-header"},$$={class:"module-identity"},I$={class:"module-info"},M$=["id"],N$={class:"module-type"},x$={class:"header-meta"},L$=["id"],P$={class:"card-content"},O$={class:"data-grid",role:"region","aria-label":"Информация о кеше"},R$={class:"data-section statistics"},B$={class:"data-items"},U$={class:"data-item"},W$={class:"data-value"},F$={class:"data-item"},H$={class:"data-value"},j$={key:0,class:"data-item full-width"},V$=["title"],z$={class:"data-section lifetime"},G$={class:"data-items"},K$={class:"data-item"},q$={class:"data-value"},Y$={key:0,class:"data-item"},X$={class:"data-value"},J$={key:1,class:"data-item"},Z$={class:"data-section cache-state"},Q$={class:"section-header"},eI=["aria-label"],tI={class:"data-items"},aI={class:"data-value cache-state-text"},sI={key:0,class:"data-section performance"},oI={class:"data-items"},nI={key:0,class:"data-item"},rI={key:1,class:"data-item"},iI={class:"data-value"},lI={key:2,class:"data-item"},cI={class:"data-value"},dI={key:3,class:"data-item"},uI={key:4,class:"data-item"},gI={key:5,class:"data-item"},mI={class:"data-value"},hI={key:6,class:"data-item"},fI={class:"data-value"},vI={key:7,class:"data-item"},pI=["aria-label"],yI={class:"primary-actions"},kI={class:"secondary-actions"},bI=["disabled","aria-label"],_I={key:0,class:"button-content"},wI={key:1,class:"button-content"},CI={key:2,class:"button-content"},TI=["aria-label"],SI={class:"detail-modal",role:"dialog","aria-modal":"true"},DI={class:"modal-header"},EI={class:"modal-content"},AI={class:"json-data"};function $I(o,e,a,t,r,i){const n=be("CacheCreateButton");return c(),u("article",{class:X(["cache-module-card",t.moduleClasses]),role:"article","aria-labelledby":`module-${a.module.id}-title`,"aria-describedby":`module-${a.module.id}-status`,"data-module-id":a.module.id,tabindex:"0"},[s("div",A$,[s("div",$$,[s("div",{class:X(["module-icon",t.iconClass])},m(t.moduleIcon),3),s("div",I$,[s("h3",{class:"module-name",id:`module-${a.module.id}-title`},m(a.module.name),9,M$),s("span",N$,m(t.moduleTypeText),1)])]),s("div",x$,[a.isPrimary&&a.priority?(c(),u("span",{key:0,class:X(["priority-badge",t.priorityClass])},m(a.priority),3)):$("",!0),s("span",{class:X(["status-badge",t.statusClass]),id:`module-${a.module.id}-status`,role:"status"},m(t.statusText),11,L$)])]),s("div",P$,[s("div",O$,[s("div",R$,[e[14]||(e[14]=s("div",{class:"section-header"},[s("span",{class:"section-icon","aria-hidden":"true"},"📊"),s("h4",{class:"section-title"},"Статистика")],-1)),s("div",B$,[s("div",U$,[e[11]||(e[11]=s("span",{class:"data-label"},"Файлов:",-1)),s("span",W$,m(a.module.file_count||0),1)]),s("div",F$,[e[12]||(e[12]=s("span",{class:"data-label"},"Размер:",-1)),s("span",H$,m(t.formattedSize),1)]),a.module.cache_dir?(c(),u("div",j$,[e[13]||(e[13]=s("span",{class:"data-label"},"Директория:",-1)),s("span",{class:"data-value cache-dir",title:a.module.cache_dir},m(t.shortCacheDir),9,V$)])):$("",!0)])]),s("div",z$,[e[18]||(e[18]=s("div",{class:"section-header"},[s("span",{class:"section-icon","aria-hidden":"true"},"⏰"),s("h4",{class:"section-title"},"Время жизни")],-1)),s("div",G$,[s("div",K$,[e[15]||(e[15]=s("span",{class:"data-label"},"TTL:",-1)),s("span",q$,m(t.formattedTTL),1)]),a.module.created_at?(c(),u("div",Y$,[e[16]||(e[16]=s("span",{class:"data-label"},"Создан:",-1)),s("span",X$,m(t.formattedCreatedAt),1)])):$("",!0),a.module.expires_at?(c(),u("div",J$,[e[17]||(e[17]=s("span",{class:"data-label"},"Истекает:",-1)),s("span",{class:X(["data-value",t.expiresClass])},m(t.formattedExpiresAt),3)])):$("",!0)])]),s("div",Z$,[s("div",Q$,[s("span",{class:"section-icon","aria-label":t.cacheStateText,"aria-hidden":"false"},m(t.cacheStateIcon),9,eI),e[19]||(e[19]=s("h4",{class:"section-title"},"Состояние кеша",-1))]),s("div",tI,[s("div",{class:X(["data-item cache-state-indicator",t.cacheStateClass])},[e[20]||(e[20]=s("span",{class:"data-label"},"Статус:",-1)),s("span",aI,m(t.cacheStateText),1)],2)])]),a.module.metadata||a.module.created_at?(c(),u("div",sI,[e[29]||(e[29]=s("div",{class:"section-header"},[s("span",{class:"section-icon","aria-hidden":"true"},"⚡"),s("h4",{class:"section-title"},"Производительность")],-1)),s("div",oI,[t.formattedCreationTime?(c(),u("div",nI,[e[21]||(e[21]=s("span",{class:"data-label"},"Время создания:",-1)),s("span",{class:X(["data-value",t.creationTimeClass])},m(t.formattedCreationTime),3)])):$("",!0),t.formattedLastAccess?(c(),u("div",rI,[e[22]||(e[22]=s("span",{class:"data-label"},"Последний доступ:",-1)),s("span",iI,m(t.formattedLastAccess),1)])):$("",!0),t.accessCount!==null?(c(),u("div",lI,[e[23]||(e[23]=s("span",{class:"data-label"},"Обращений:",-1)),s("span",cI,m(t.accessCount),1)])):$("",!0),t.cacheEfficiency?(c(),u("div",dI,[e[24]||(e[24]=s("span",{class:"data-label"},"Эффективность:",-1)),s("span",{class:X(["data-value",t.cacheEfficiencyClass])},m(t.cacheEfficiency),3)])):$("",!0),t.dataFreshness?(c(),u("div",uI,[e[25]||(e[25]=s("span",{class:"data-label"},"Свежесть данных:",-1)),s("span",{class:X(["data-value",t.dataFreshnessClass])},m(t.dataFreshness),3)])):$("",!0),a.module.total_size?(c(),u("div",gI,[e[26]||(e[26]=s("span",{class:"data-label"},"Общий размер:",-1)),s("span",mI,m(t.formatBytes(a.module.total_size)),1)])):$("",!0),a.module.ttl?(c(),u("div",hI,[e[27]||(e[27]=s("span",{class:"data-label"},"TTL:",-1)),s("span",fI,m(t.formatTTL(a.module.ttl)),1)])):$("",!0),t.timeToExpiry!==null?(c(),u("div",vI,[e[28]||(e[28]=s("span",{class:"data-label"},"Истекает через:",-1)),s("span",{class:X(["data-value",t.timeToExpiryClass])},m(t.formatTimeToExpiry),3)])):$("",!0)])])):$("",!0)])]),s("div",{class:X(["card-actions",{"mobile-layout":t.isMobile}]),role:"group","aria-label":`Действия с кешем ${a.module.name}`},[s("div",yI,[ne(n,{module:a.module,disabled:t.creating,onCreated:t.handleCacheCreated,onCreating:t.handleCreatingState,class:X({loading:t.creating})},null,8,["module","disabled","onCreated","onCreating","class"])]),s("div",kI,[s("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClear&&t.handleClear(...l)),onKeydown:[e[1]||(e[1]=Be((...l)=>t.handleClear&&t.handleClear(...l),["enter"])),e[2]||(e[2]=Be(Te((...l)=>t.handleClear&&t.handleClear(...l),["prevent"]),["space"]))],disabled:!t.canClear,class:X(["action-button clear-button",{disabled:!t.canClear,loading:t.clearing}]),"aria-label":t.clearButtonLabel,tabindex:"0"},[t.clearing?(c(),u("span",_I,[...e[30]||(e[30]=[s("span",{class:"spinner"},null,-1),ge(" Очистка... ",-1)])])):t.isEmpty?(c(),u("span",wI," 📁 Кеш пуст ")):(c(),u("span",CI," 🗑️ Очистить "))],42,bI),t.canShowDetails?(c(),u("button",{key:0,onClick:e[3]||(e[3]=(...l)=>t.showDetails&&t.showDetails(...l)),onKeydown:[e[4]||(e[4]=Be((...l)=>t.showDetails&&t.showDetails(...l),["enter"])),e[5]||(e[5]=Be(Te((...l)=>t.showDetails&&t.showDetails(...l),["prevent"]),["space"]))],class:"action-button details-button","aria-label":`Показать детали кеша ${a.module.name}`,title:"Показать детали кеша",tabindex:"0"}," 📊 ",40,TI)):$("",!0)])],10,pI),(c(),he(It,{to:"body"},[t.showDetailModal?(c(),u("div",{key:0,class:"detail-modal-overlay",onClick:e[9]||(e[9]=Te((...l)=>t.closeDetails&&t.closeDetails(...l),["self"])),onKeydown:e[10]||(e[10]=Be((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))},[s("div",SI,[s("div",DI,[s("h3",null,"Детали кеша: "+m(a.module.name),1),s("button",{onClick:e[6]||(e[6]=(...l)=>t.closeDetails&&t.closeDetails(...l)),onKeydown:[e[7]||(e[7]=Be((...l)=>t.closeDetails&&t.closeDetails(...l),["enter"])),e[8]||(e[8]=Be((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))],class:"close-button","aria-label":"Закрыть",tabindex:"0"}," ✕ ",32)]),s("div",EI,[s("pre",AI,m(JSON.stringify(a.module,null,2)),1)])])],32)):$("",!0)]))],10,E$)}const II=ce(D$,[["render",$I],["__scopeId","data-v-bc59cd77"]]),MI={name:"CacheStats",props:{modules:{type:Array,required:!1,default:()=>[]}},setup(o){console.log("[CacheStats] setup called with modules:",o.modules);const e=I(()=>o.modules||[]),a=I(()=>{console.log("[CacheStats] Computing primaryModules, total modules:",e.value?.length||0);const y=e.value.filter(S=>Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Primary modules count:",y.length),y}),t=I(()=>{console.log("[CacheStats] Computing secondaryModules, total modules:",e.value?.length||0);const y=e.value.filter(S=>!Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Secondary modules count:",y.length),y}),r=I(()=>a.value?.length||0),i=I(()=>t.value?.length||0),n=I(()=>e.value?.length||0),l=I(()=>e.value.reduce((y,S)=>y+(S.file_count||0),0)),d=I(()=>(o.modules||[]).reduce((y,S)=>y+(S.total_size||0),0)),g=I(()=>Pe.formatCacheSize(d.value)),v=I(()=>{const y=o.modules||[];if(y.length===0)return"0 мин";const S=y.reduce((k,_)=>k+(_.ttl||0),0),T=Math.round(S/y.length);return Pe.formatTTL(T)}),C=I(()=>(e.value||[]).filter(y=>y.status==="active").length),f=I(()=>{if((i.value||0)===0)return[];const y={};(t.value||[]).forEach(T=>{const k=Pe.getModuleType(T.id);if(!y[k]){const _=Pe.getModuleTypeConfig(k);y[k]={type:k,title:_.title||"Неизвестная группа",icon:p(k),count:0}}y[k].count++});const S=i.value||0;return Object.values(y).map(T=>({...T,percentage:S>0?Math.round(T.count/S*100):0})).sort((T,k)=>k.count-T.count)}),p=y=>{const S={users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"};return S[y]||S.other};return{modules:e,primaryModulesCount:r,secondaryModulesCount:i,totalModules:n,totalFiles:l,totalSizeFormatted:g,avgTTL:v,activeModules:C,groupStats:f}}},NI={key:0,class:"cache-stats"},xI={class:"stats-overview"},LI={class:"overview-grid"},PI={class:"overview-card primary"},OI={class:"overview-content"},RI={class:"overview-value"},BI={class:"overview-card secondary"},UI={class:"overview-content"},WI={class:"overview-value"},FI={class:"overview-card total"},HI={class:"overview-content"},jI={class:"overview-value"},VI={class:"detailed-stats"},zI={class:"stats-grid"},GI={class:"stat-card"},KI={class:"stat-content"},qI={class:"stat-value"},YI={class:"stat-card"},XI={class:"stat-content"},JI={class:"stat-value"},ZI={class:"stat-card"},QI={class:"stat-content"},eM={class:"stat-value"},tM={class:"stat-card"},aM={class:"stat-content"},sM={class:"stat-value"},oM={key:0,class:"group-distribution"},nM={class:"distribution-grid"},rM={class:"group-icon"},iM={class:"group-info"},lM={class:"group-name"},cM={class:"group-count"},dM={class:"group-percentage"},uM={key:1,class:"cache-stats-loading"};function gM(o,e,a,t,r,i){return(t.modules||[]).length>0?(c(),u("div",NI,[e[18]||(e[18]=s("h2",{class:"stats-title"},"📊 Статистика кеша по категориям",-1)),s("div",xI,[s("div",LI,[s("div",PI,[e[2]||(e[2]=s("div",{class:"overview-icon"},"🏆",-1)),s("div",OI,[s("div",RI,m(t.primaryModulesCount),1),e[0]||(e[0]=s("div",{class:"overview-label"},"Основных модулей",-1)),e[1]||(e[1]=s("div",{class:"overview-desc"},"Приоритетные",-1))])]),s("div",BI,[e[5]||(e[5]=s("div",{class:"overview-icon"},"🔧",-1)),s("div",UI,[s("div",WI,m(t.secondaryModulesCount),1),e[3]||(e[3]=s("div",{class:"overview-label"},"Побочных модулей",-1)),e[4]||(e[4]=s("div",{class:"overview-desc"},"Служебные",-1))])]),s("div",FI,[e[8]||(e[8]=s("div",{class:"overview-icon"},"📦",-1)),s("div",HI,[s("div",jI,m(t.totalModules),1),e[6]||(e[6]=s("div",{class:"overview-label"},"Всего модулей",-1)),e[7]||(e[7]=s("div",{class:"overview-desc"},"Активных",-1))])])])]),s("div",VI,[s("div",zI,[s("div",GI,[e[10]||(e[10]=s("div",{class:"stat-icon"},"📄",-1)),s("div",KI,[s("div",qI,m(t.totalFiles),1),e[9]||(e[9]=s("div",{class:"stat-label"},"Всего файлов",-1))])]),s("div",YI,[e[12]||(e[12]=s("div",{class:"stat-icon"},"💾",-1)),s("div",XI,[s("div",JI,m(t.totalSizeFormatted),1),e[11]||(e[11]=s("div",{class:"stat-label"},"Общий размер",-1))])]),s("div",ZI,[e[14]||(e[14]=s("div",{class:"stat-icon"},"⏱️",-1)),s("div",QI,[s("div",eM,m(t.avgTTL),1),e[13]||(e[13]=s("div",{class:"stat-label"},"Средний TTL",-1))])]),s("div",tM,[e[16]||(e[16]=s("div",{class:"stat-icon"},"⚡",-1)),s("div",aM,[s("div",sM,m(t.activeModules),1),e[15]||(e[15]=s("div",{class:"stat-label"},"Активных кешей",-1))])])])]),t.secondaryModulesCount>0?(c(),u("div",oM,[e[17]||(e[17]=s("h3",{class:"distribution-title"},"Распределение побочных модулей",-1)),s("div",nM,[(c(!0),u(ee,null,te(t.groupStats,n=>(c(),u("div",{key:n.type,class:"distribution-item"},[s("div",rM,m(n.icon),1),s("div",iM,[s("div",lM,m(n.title),1),s("div",cM,m(n.count)+" модулей",1)]),s("div",dM,m(n.percentage)+"%",1)]))),128))])])):$("",!0)])):(c(),u("div",uM,[...e[19]||(e[19]=[s("p",null,"📊 Загрузка статистики...",-1)])]))}const mM=ce(MI,[["render",gM],["__scopeId","data-v-9fa190bb"]]),hM={name:"CacheManagement",components:{CacheModuleCard:II,CacheStats:mM},setup(){const o=M([]),e=M([]),a=M(!0),t=M(null),r=M(!1),i=I(()=>(o.value?.length||0)+(e.value?.length||0)),n=I(()=>{const k=l.value?.length||0,_=(d.value?.length||0)>0?1:0;return k+_}),l=I(()=>{const k=(o.value||[]).filter(_=>!_.id.includes("time-tracking"));return console.log("[CacheManagement] individualPrimaryModules:",k.length,k.map(_=>_.id)),k}),d=I(()=>{const k=(o.value||[]).filter(_=>_.id.includes("time-tracking")).sort((_,A)=>{const U=["time-tracking-default","time-tracking-detailed","time-tracking-summary"];return U.indexOf(_.id)-U.indexOf(A.id)});return console.log("[CacheManagement] timeTrackingModules:",k.length,k.map(_=>_.id)),k}),g=I(()=>{const k={};return(e.value||[]).forEach(A=>{const U=Pe.getModuleType(A.id);k[U]||(k[U]={type:U,title:C(U),modules:[]}),k[U].modules.push(A)}),Object.values(k).sort((A,U)=>{const x=["users","activity","webhooks","other"],D=x.indexOf(A.type),E=x.indexOf(U.type);return(D===-1?999:D)-(E===-1?999:E)})}),v=async()=>{a.value=!0,t.value=null;try{const k=await Pe.getCacheStatus();o.value=k.primaryModules||[],e.value=k.secondaryModules||[],console.log("[CacheManagement] Primary modules:",o.value.length,o.value.map(_=>({id:_.id,name:_.name}))),console.log("[CacheManagement] Secondary modules:",e.value.length,e.value.map(_=>({id:_.id,name:_.name})))}catch(k){console.error("[CacheManagement] Error loading modules:",k),t.value=k.message}finally{a.value=!1}},C=k=>{const _={users:"👥 Управление пользователями",activity:"📊 Отслеживание активности",webhooks:"🔗 Логи вебхуков",other:"🔧 Прочие модули"};return _[k]||_.other},f=async k=>{console.log(`[CacheManagement] Clearing module: ${k}`),Pe.invalidateCacheAfterModuleOperation(),await v()},p=async()=>{console.log("[CacheManagement] Clearing all cache"),r.value=!0;try{await Pe.clearCache("all"),Pe.invalidateCacheAfterModuleOperation(),Ye.success("Кеш полностью очищен","Все файлы кеша были успешно удалены"),await v()}catch(k){console.error("[CacheManagement] Error clearing all cache:",k),Ye.error("Ошибка очистки кеша",`Не удалось очистить весь кеш: ${k.message}`)}finally{r.value=!1}},y=async k=>{console.log(`[CacheManagement] Creating cache for: ${k.name} (${k.id})`),alert(`Создание кеша для модуля: ${k.name}
ID: ${k.id}
Это mock функция для тестирования интерфейса.`)},S=async k=>{console.log(`[CacheManagement] Clearing cache for: ${k.name} (${k.id})`),alert(`Очистка кеша для модуля: ${k.name}
ID: ${k.id}
Это mock функция для тестирования интерфейса.`)},T=()=>{v()};return $e(()=>{v()}),{primaryModules:o,secondaryModules:e,loading:a,error:t,totalModules:i,groupedSecondaryModules:g,individualPrimaryModules:l,timeTrackingModules:d,logicalPrimaryCount:n,clearingAll:r,handleModuleClear:f,handleClearAllCache:p,handleCreateMock:y,handleClearMock:S,refreshModules:T}}},fM={class:"cache-management"},vM={key:0,class:"header-section"},pM={class:"stats-bar"},yM={class:"stat-item"},kM={class:"stat-item"},bM={class:"stat-item"},_M={key:0,class:"global-actions"},wM=["disabled"],CM={key:0},TM={key:1},SM={class:"section-header"},DM={class:"section-meta"},EM={class:"module-count","aria-label":"{{ logicalPrimaryCount }} основных модулей"},AM={key:0,class:"modules-container"},$M={key:0,class:"modules-grid"},IM={key:1,class:"time-tracking-group"},MM={class:"modules-grid"},NM={key:1,class:"empty-state"},xM={key:2,class:"section-divider"},LM={key:3,class:"cache-section secondary-modules","aria-labelledby":"secondary-modules-heading"},PM={class:"section-header"},OM={class:"section-meta"},RM={class:"module-count","aria-label":"{{ (secondaryModules || []).length }} второстепенных модулей"},BM={class:"grouped-modules"},UM={class:"group-header"},WM={class:"group-title"},FM={class:"group-badge secondary"},HM={class:"modules-grid"},jM={key:4,class:"error-message",role:"alert","aria-live":"assertive"},VM={key:5,class:"loading-overlay",role:"status","aria-live":"polite","aria-label":"Загрузка модулей кеша"};function zM(o,e,a,t,r,i){const n=be("CacheModuleCard");return c(),u("div",fM,[!t.loading&&!t.error?(c(),u("div",vM,[e[6]||(e[6]=s("h1",null,"🗑️ Ручное управление кешем",-1)),e[7]||(e[7]=s("p",{class:"description"}," Управление кешем системы сгруппировано по важности для удобства администрирования ",-1)),s("div",pM,[s("span",yM,[s("strong",null,m(t.totalModules),1),e[3]||(e[3]=ge(" всего модулей ",-1))]),s("span",kM,[s("strong",null,m(t.logicalPrimaryCount),1),e[4]||(e[4]=ge(" основных ",-1))]),s("span",bM,[s("strong",null,m((t.secondaryModules||[]).length),1),e[5]||(e[5]=ge(" дополнительных ",-1))])]),!t.loading&&!t.error?(c(),u("div",_M,[s("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClearAllCache&&t.handleClearAllCache(...l)),disabled:t.clearingAll,class:X(["btn-clear-all",{"btn-disabled":t.clearingAll}])},[t.clearingAll?(c(),u("span",CM,"🧹 Очистка всего кеша...")):(c(),u("span",TM,"🗑️ Очистить весь кеш"))],10,wM)])):$("",!0)])):$("",!0),!t.loading&&!t.error?(c(),u("section",{key:1,class:X(["cache-section primary-modules",{empty:(t.primaryModules||[]).length===0}]),"aria-labelledby":"primary-modules-heading"},[s("div",SM,[e[9]||(e[9]=s("h2",{id:"primary-modules-heading"},"🏆 Основные модули кеша",-1)),s("div",DM,[s("span",EM,m(t.logicalPrimaryCount),1),e[8]||(e[8]=s("span",{class:"section-badge primary",role:"status","aria-label":"Приоритетные модули"},"Приоритет",-1))])]),e[13]||(e[13]=s("p",{class:"section-description"}," 5 основных модулей для оперативного анализа и мониторинга системы: дашборд сектора 1С, график состояния, графики приема-закрытия и трудозатраты на тикеты сектора 1С. ",-1)),(t.primaryModules||[]).length>0?(c(),u("div",AM,[t.individualPrimaryModules.length>0?(c(),u("div",$M,[(c(!0),u(ee,null,te(t.individualPrimaryModules,l=>(c(),u("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])):$("",!0),(t.timeTrackingModules||[]).length>0?(c(),u("div",IM,[e[10]||(e[10]=s("div",{class:"group-header"},[s("h3",{class:"group-title"},"⏱️ Трудозатраты на тикеты сектора 1С"),s("span",{class:"group-badge"},"Основная группа")],-1)),e[11]||(e[11]=s("p",{class:"group-description"},"Анализ времени работы с задачами в разных режимах отображения",-1)),s("div",MM,[(c(!0),u(ee,null,te(t.timeTrackingModules,l=>(c(),u("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])])):$("",!0)])):(c(),u("div",NM,[e[12]||(e[12]=s("p",null,"⚠️ Основные модули кеша не найдены",-1)),s("button",{onClick:e[1]||(e[1]=(...l)=>t.refreshModules&&t.refreshModules(...l)),class:"refresh-btn"},"Обновить список")]))],2)):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),u("div",xM,[...e[14]||(e[14]=[_t('<div class="divider-line" data-v-6a4e8216></div><div class="divider-content" data-v-6a4e8216><span class="divider-icon" data-v-6a4e8216>🔧</span><span class="divider-text" data-v-6a4e8216>Дополнительные модули</span><span class="divider-subtitle" data-v-6a4e8216>Вспомогательные функции системы</span></div><div class="divider-line" data-v-6a4e8216></div>',3)])])):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),u("section",LM,[s("div",PM,[e[16]||(e[16]=s("h2",{id:"secondary-modules-heading"},"🔧 Побочные модули кеша",-1)),s("div",OM,[s("span",RM,m((t.secondaryModules||[]).length),1),e[15]||(e[15]=s("span",{class:"section-badge secondary",role:"status","aria-label":"Служебные модули"},"Служебные",-1))])]),e[17]||(e[17]=s("p",{class:"section-description"}," Модули для администрирования и детального мониторинга системы. ",-1)),s("div",BM,[(c(!0),u(ee,null,te(t.groupedSecondaryModules,l=>(c(),u("div",{key:l.type,class:X(["module-group",`group-${l.type}`])},[s("div",UM,[s("h3",WM,m(l.title),1),s("span",FM,m(l.modules.length),1)]),s("div",HM,[(c(!0),u(ee,null,te(l.modules,d=>(c(),u("div",{key:d.id,class:"module-wrapper"},[ne(n,{module:d,"is-primary":!1,"group-type":l.type,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","group-type","onClear","onRefresh"])]))),128))])],2))),128))])])):$("",!0),t.error?(c(),u("div",jM,[e[18]||(e[18]=s("h3",null,"❌ Ошибка загрузки модулей кеша",-1)),s("p",null,m(t.error),1),s("button",{onClick:e[2]||(e[2]=(...l)=>o.loadModules&&o.loadModules(...l)),class:"retry-btn","aria-label":"Повторить загрузку модулей кеша"},"Повторить попытку")])):$("",!0),t.loading?(c(),u("div",VM,[...e[19]||(e[19]=[s("div",{class:"loading-spinner","aria-hidden":"true"},null,-1),s("p",null,"Загрузка модулей кеша...",-1)])])):$("",!0)])}const GM=ce(hM,[["render",zM],["__scopeId","data-v-6a4e8216"]]),KM={name:"CacheManagementPage",components:{CacheManagement:GM},beforeCreate(){console.log("[CacheManagementPage] beforeCreate() called")},created(){console.log("[CacheManagementPage] created() called")},beforeMount(){console.log("[CacheManagementPage] beforeMount() called")},setup(){console.log("[CacheManagementPage] setup() called with new hierarchical UI");const o=Xe(),e=M(!1),a=M(null),t=()=>{o.push({name:"index"})};return $e(()=>{console.log("[CacheManagementPage] onMounted() called - hierarchical cache management ready")}),{loading:e,error:a,goBack:t}}},qM={class:"cache-management-page"},YM={class:"page-header"},XM={class:"page-header-top"},JM={key:0,class:"loading"},ZM={key:1,class:"error"},QM={key:2,class:"cache-content"};function e4(o,e,a,t,r,i){const n=be("CacheManagement");return c(),u("div",qM,[s("div",YM,[s("div",XM,[s("button",{onClick:e[0]||(e[0]=(...l)=>t.goBack&&t.goBack(...l)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[1]||(e[1]=[s("span",{class:"back-icon","aria-hidden":"true"},"←",-1),s("span",{class:"back-text"},"Назад",-1)])])]),e[2]||(e[2]=s("h1",null,"🗑️ Ручное управление кешем",-1))]),t.loading?(c(),u("div",JM," Загрузка статуса кеша... ")):t.error?(c(),u("div",ZM,m(t.error),1)):(c(),u("div",QM,[ne(n)]))])}const t4=ce(KM,[["render",e4],["__scopeId","data-v-a20ded38"]]),a4=[{path:"/install",name:"install",component:Fo},{path:"/",name:"index",component:nw},{path:"/webhook-logs",name:"webhook-logs",redirect:"/admin/webhook-logs"},{path:"/admin/webhook-logs",name:"admin-webhook-logs",component:lS,meta:{requiresAuth:!0,title:"Логи вебхуков",adminOnly:!0}},{path:"/admin/users",name:"admin-users",component:XA,meta:{requiresAuth:!0,title:"Управление пользователями",adminOnly:!0}},{path:"/admin/cache",name:"admin-cache",component:t4,meta:{requiresAuth:!0,title:"Ручное управление кешем",adminOnly:!0}},{path:"/dashboard/sector-1c",name:"dashboard-sector-1c",component:()=>Ce(()=>Promise.resolve().then(()=>Vs),void 0,import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector1c"}},{path:"/dashboard/sector-pdm",name:"dashboard-sector-pdm",component:()=>Ce(()=>import("./SectorDashboardPDM.vue-1xWOYL6p.js"),__vite__mapDeps([14,2,3,4,5,6,7]),import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector-pdm"},props:{sectorId:"pdm"}},{path:"/dashboard/sector-bitrix24",name:"dashboard-sector-bitrix24",component:()=>Ce(()=>import("./SectorDashboardBitrix24.vue-OkVG_2Iq.js"),__vite__mapDeps([15,2,3,4,5,6,7]),import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector-bitrix24"}},{path:"/dashboard/sector-infrastructure",name:"dashboard-sector-infrastructure",component:()=>Ce(()=>import("./SectorDashboardInfrastructure.vue-By56mhyp.js"),__vite__mapDeps([16,2,3,4,5,6,7]),import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector-infrastructure"}},{path:"/dashboard/graph-admission-closure",name:"dashboard-graph-admission-closure",component:()=>Ce(()=>Promise.resolve().then(()=>Qk),void 0,import.meta.url),meta:{title:"График приёма и закрытий сектора 1С",description:"Недельные агрегаты новых и закрытых тикетов сектора 1С",requiresAuth:!0,chunk:"admission-dashboard"}},{path:"/dashboard/graph-state",name:"dashboard-graph-state",component:()=>Ce(()=>Promise.resolve().then(()=>Yg),void 0,import.meta.url),meta:{title:"График состояния сектора 1С",description:"Визуализация изменений состояния сектора во времени",requiresAuth:!0,chunk:"graph-state"}},{path:"/dashboard/tickets-time-tracking",name:"dashboard-tickets-time-tracking",component:()=>Ce(()=>Promise.resolve().then(()=>Yi),void 0,import.meta.url),meta:{title:"Трудозатраты на Тикеты сектора 1С",description:"Трудозатраты сотрудников сектора 1С по неделям",requiresAuth:!0,chunk:"tickets-tracking"}}],ya=lo({history:co(),routes:a4});ya.beforeEach(async(o,e,a)=>{if(console.log("[Router] beforeEach:",{to:o.path,from:e.path,name:o.name}),o.meta.title&&(document.title=`${o.meta.title} - Bitrix24 Dashboard`),o.meta.requiresAuth){console.log("[Router] requiresAuth check for:",o.path);try{const t=await rt.checkAccess();if(!t.allowed){console.warn("Unauthorized access attempt to:",o.path,t.errorMessage),a({name:"index"});return}}catch(t){console.error("Error checking access in navigation guard:",t),a();return}}if(o.meta.adminOnly)try{const t=await rt.getCurrentUser();if(!t||!sa(t)){console.warn("Admin access required for:",o.path),a({name:"index"});return}}catch(t){console.error("Error checking admin access in navigation guard:",t),a({name:"index"});return}if(e.name!==null&&o.path!==e.path)try{if((await rt.checkAccess()).allowed){const r=await rt.getCurrentUser();r&&ca.logPageVisit(o,r,e).catch(i=>{console.error("[Router] Error logging page visit:",i)})}}catch(t){console.error("[Router] Error in activity logging:",t)}if(o.name==="index"&&!e.name&&setTimeout(()=>{Ce(()=>Promise.resolve().then(()=>Vs),void 0,import.meta.url)},1e3),o.meta.chunk)switch(o.meta.chunk){case"dashboard-sector1c":setTimeout(()=>{Ce(()=>Promise.resolve().then(()=>Kv),void 0,import.meta.url)},500);break;case"admission-dashboard":setTimeout(()=>{Ce(()=>import("./chunk-BuX-LpxK.js").then(t=>t.l),__vite__mapDeps([5,3]),import.meta.url)},500);break}console.log("[Router] Allowing navigation to:",o.path),a()});setTimeout(()=>{const o=window.location.pathname,e=window.location.hash;e&&e!=="#/"||(o.includes("install.php")?ya.replace("/install"):ya.replace("/"))},0);class ua{static startBundleLoad(){this.metrics.bundleLoadTime=performance.now()}static endBundleLoad(e){const a=performance.now()-this.metrics.bundleLoadTime;this.metrics.chunkLoadTimes.set(e,a),console.log(`📦 Chunk "${e}" loaded in ${a.toFixed(2)}ms`),window.gtag&&window.gtag("event","bundle_load",{chunk_name:e,load_time:a}),a>1e3&&console.warn(`🐌 Slow chunk load: ${e} took ${a.toFixed(2)}ms`)}static trackComponentLoad(e,a){const t=performance.now()-a;this.metrics.componentLoadTime.set(e,t),console.log(`🧩 Component "${e}" loaded in ${t.toFixed(2)}ms`),t>500&&console.warn(`🐌 Slow component load: ${e} took ${t.toFixed(2)}ms`)}static trackApiCall(e,a){this.metrics.apiResponseTime.set(e,a),a>1e3&&console.warn(`🐌 Slow API call to ${e}: ${a}ms`)}static getReport(){const e=Array.from(this.metrics.componentLoadTime.values()),a=Array.from(this.metrics.apiResponseTime.values()),t=Array.from(this.metrics.chunkLoadTimes.values());return{totalChunks:this.metrics.chunkLoadTimes.size,totalComponents:this.metrics.componentLoadTime.size,totalApiCalls:this.metrics.apiResponseTime.size,averageComponentLoadTime:e.length>0?e.reduce((r,i)=>r+i,0)/e.length:0,averageApiResponseTime:a.length>0?a.reduce((r,i)=>r+i,0)/a.length:0,averageChunkLoadTime:t.length>0?t.reduce((r,i)=>r+i,0)/t.length:0,slowestComponents:Array.from(this.metrics.componentLoadTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i})),slowestApiCalls:Array.from(this.metrics.apiResponseTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({endpoint:r,time:i})),slowestChunks:Array.from(this.metrics.chunkLoadTimes.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i}))}}static clearMetrics(){this.metrics.bundleLoadTime=0,this.metrics.componentLoadTime.clear(),this.metrics.apiResponseTime.clear(),this.metrics.chunkLoadTimes.clear()}}Fe(ua,"metrics",{bundleLoadTime:0,componentLoadTime:new Map,apiResponseTime:new Map,chunkLoadTimes:new Map});class s4{static init(){this.initChunkLoadErrorHandling(),this.initUnhandledErrorHandling(),this.initNetworkErrorHandling()}static initChunkLoadErrorHandling(){if(window.addEventListener("error",e=>{e.target.tagName==="SCRIPT"&&(console.error("❌ Chunk loading error:",e.target.src),this.reportError("chunk_load_error",{url:e.target.src,message:e.message||"Script load failed"}))}),"PerformanceObserver"in window)try{new PerformanceObserver(a=>{for(const t of a.getEntries())if(t.entryType==="resource"&&t.name.includes(".js")){const r=t.responseEnd-t.requestStart;ua.trackApiCall(t.name,r)}}).observe({entryTypes:["resource"]})}catch{console.warn("PerformanceObserver not supported")}}static initUnhandledErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("❌ Unhandled promise rejection:",e.reason),this.reportError("unhandled_rejection",{reason:e.reason?.message||String(e.reason),stack:e.reason?.stack})}),window.addEventListener("error",e=>{e.error&&e.filename&&(console.error("❌ Unhandled error:",e.error),this.reportError("unhandled_error",{message:e.error.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error.stack}))})}static initNetworkErrorHandling(){const e=window.fetch;window.fetch=function(...a){const t=performance.now();return e.apply(this,a).then(r=>{const i=performance.now()-t;return ua.trackApiCall(a[0],i),r.ok||console.warn(`🚨 API error: ${r.status} ${r.statusText} for ${a[0]}`),r}).catch(r=>{const i=performance.now()-t;throw console.error(`❌ Network error for ${a[0]}:`,r),ua.trackApiCall(a[0],i),this.reportError("network_error",{url:a[0],message:r.message,loadTime:i}),r})}}static reportError(e,a){const t={type:e,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,...a};if(console.error("📊 Error report:",t),window.Sentry&&window.Sentry.captureException(new Error(`${e}: ${JSON.stringify(a)}`)),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:"/api/log-error.php",method:"POST",data:t})}catch(r){console.error("Failed to send error report to Bitrix24:",r)}window.gtag&&window.gtag("event","exception",{description:`${e}: ${a.message||"Unknown error"}`,fatal:!1})}static getErrorStats(){return{chunkLoadErrors:0,networkErrors:0,unhandledErrors:0,totalErrors:0}}}const qa=uo(Do);qa.use(ya);const o4=o=>{try{const e=new WeakSet;return JSON.stringify(o,(a,t)=>{if(typeof t=="object"&&t!==null){if(e.has(t))return"[Circular]";e.add(t)}return typeof t=="function"||t===void 0?null:t})}catch{return String(o)}};qa.config.errorHandler=(o,e,a)=>{if(o instanceof TypeError&&o.message.includes("Cannot read properties of undefined (reading 'type')")){console.warn("Caught undefined.type error:",{error:o.message,component:e?.$options?.name||"Unknown",info:a,stack:o.stack});return}if(console.error("Vue error:",o,a),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:et("/api/log-error.php"),method:"POST",data:{error:o?.message||String(o),info:typeof a=="string"?a:o4(a),component:e?.$options?.name||"Unknown"}})}catch(t){console.error("Failed to log error:",t)}};qa.mount("#app");s4.init();export{Nt as L,Rn as S,ce as _,xt as a,bt as b,J as c,iw as d,Ga as e,Vt as f,sn as g,ZA as h,gt as i,jt as n};
