import{_ as _e,r as C,c as j,m as ge,G as De,a as A,o as k,b as c,d as P,g as he,F as re,f as oe,j as me,t as W,p as V,H as be,v as pe,n as Ae,x as Ge,I as Xe,u as ve,L as ze,C as He,J as Ke,k as fe,l as qe,i as Ye,B as Je,K as Ze,D as Qe,M as x,q as je,N as Ue,e as et,y as tt}from"./main-rMadE269.js";import{L as Ve,D as at,B as st}from"./index-Bfew-33W.js";import{S as Te,d as Ee,K as nt,D as Le}from"./index-D4oTPz0r.js";const K={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class G{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,a={}){try{if(!e||typeof e!="object")throw new Y("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new Y("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const n=this.validateSectorData(e);if(!n.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${n.errors.join(", ")}`,"VALIDATION_ERROR",{validation:n});const s=this.normalizeSectorData(e),o={metadata:this.generateSnapshotMetadata(t,a.createdBy,a.sectorId||K.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},l=this.validateSnapshot(o);if(!l.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${l.errors.join(", ")}`,"VALIDATION_ERROR",{validation:l});l.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",l.warnings);const i=this.getApiBaseUrl(),v=await fetch(`${i}${K.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:o,type:t,date:this.formatDate(new Date)})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const m=await v.json();if(!m.success)throw new Error(m.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return m.data.snapshot}catch(n){throw console.error("SnapshotService.createSnapshot error:",n),n instanceof Y?n:new Y(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${n.message}`,"API_ERROR",{originalError:n})}}static async getSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?action=get&date=${a}&type=${t}`,r=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(r.status===404)return null;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return o.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",K.defaultSectorId);const n=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?${t.toString()}`,s=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=await s.json();if(!r.success)throw new Error(r.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(r.data.snapshots.map(async l=>{try{return await this.getSnapshot(l.date,l.type)}catch(i){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${l.date}/${l.type}:`,i),null}}))).filter(l=>l!==null).sort((l,i)=>new Date(l.metadata.createdAt)-new Date(i.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:a=[],zeroPointTickets:n={}}=e,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},r=[],o=[],l=[];t.forEach(m=>{const y=m.id;if(s[y]){let B=0;m.employees.forEach($=>{const T=$.tickets||[];B+=T.length;let h=r.find(g=>g.id===$.id);h||(h={id:$.id,name:$.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},r.push(h)),T.forEach(g=>{o.push(g.id),l.push({id:g.id,title:g.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:$.id,name:$.name},createdAt:g.createdAt||"",updatedAt:g.modifiedAt||g.updatedAt||""}),h.ticketsByStage[y]=(h.ticketsByStage[y]||0)+1,h.totalTickets+=1})}),s[y].count=B}});const i={unassigned:0,keeper:0,total:0};Object.values(n).forEach(m=>{Array.isArray(m)&&m.forEach(y=>{i.total+=1,y.assigneeId===1051||y.assignedById===1051?i.keeper+=1:i.unassigned+=1,o.push(y.id),l.push({id:y.id,title:y.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:y.assignedTo||y.assignedById?{id:y.assignedById||y.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:y.createdAt||"",updatedAt:y.modifiedAt||y.updatedAt||""})})});const v=Object.values(s).reduce((m,y)=>m+y.count,0)+i.total;return{statistics:{stages:{...s,total:v},employees:r,zeroPoint:i},ticketIds:[...new Set(o)],tickets:l}}static generateSnapshotMetadata(e,t,a){const n=new Date,s=-n.getTimezoneOffset(),r=Math.floor(s/60),o=s%60,l=`${r>=0?"+":""}${String(r).padStart(2,"0")}:${String(o).padStart(2,"0")}`,i=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}${l}`;return{version:K.snapshotVersion,createdAt:i,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:a,sectorName:a==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${a}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${n}`}static buildFilePath(e,t){const a=typeof e=="string"?new Date(e):e,n=a.getFullYear(),s=this.getWeekNumber(a),r=this.formatDate(e);let o;if(t==="current"){const l=new Date,i=`${String(l.getHours()).padStart(2,"0")}-${String(l.getMinutes()).padStart(2,"0")}-${String(l.getSeconds()).padStart(2,"0")}`;o=`current-state-${r}-${i}.json`}else if(t==="manual"){const l=new Date,i=`${String(l.getHours()).padStart(2,"0")}-${String(l.getMinutes()).padStart(2,"0")}-${String(l.getSeconds()).padStart(2,"0")}`;o=`manual-${r}-${i}.json`}else o=`${t}-${r}.json`;return t==="current"?`current/${o}`:`${n}/week-${s}/${o}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);const n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-n)/864e5+1)/7)}static validateSnapshot(e){var n,s,r;const t=[],a=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const o=e.statistics.stages,l=(((n=o.formed)==null?void 0:n.count)||0)+(((s=o.review)==null?void 0:s.count)||0)+(((r=o.execution)==null?void 0:r.count)||0);o.total!==l&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${l}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const o=e.statistics.zeroPoint,l=(o.unassigned||0)+(o.keeper||0);o.total!==l&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${l}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const o=new Set(e.ticketIds),l=new Set(e.tickets.map(i=>i.id));o.size!==l.size&&a.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((i,v)=>{i.id||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),i.title||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!i.assignedTo||!i.assignedTo.id)&&a.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),i.createdAt||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),i.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:a}}static validateSectorData(e){const t=[],a=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:a}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:a})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}`,r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:t})});if(r.status===404)return!1;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let a=0;for(const n of t)try{await this.deleteSnapshot(n.metadata.createdAt.split("T")[0],n.metadata.type)&&a++}catch(s){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${n.metadata.createdAt}:`,s)}return a}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=K.snapshotVersion){const a=this.getSnapshotVersion(e);return a===t||a==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${a} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,a=this.getWeekNumber(t);return{year:t.getFullYear(),week:a}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,n=(t.getDay()||7)-1,s=new Date(t);return s.setDate(t.getDate()-n),s.setHours(0,0,0,0),s}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,n=7-(t.getDay()||7),s=new Date(t);return s.setDate(t.getDate()+n),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),a=this.getWeekEndDate(e),n=this.getWeekNumberInfo(e),s=await this.getAllSnapshots({startDate:t,endDate:a}),r=s.find(i=>i.metadata.type==="week_start")||null,o=s.find(i=>i.metadata.type==="week_end")||null,l=s.filter(i=>i.metadata.type==="manual");return{weekStart:r,weekEnd:o,manual:l,weekInfo:n}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof Y)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),a={week_start:0,week_end:0,manual:0,current:0},n=new Map;let s=null,r=null;t.forEach(l=>{const i=l.metadata.type;a.hasOwnProperty(i)&&a[i]++;const v=this.getWeekNumberInfo(l.metadata.createdAt),m=`${v.year}-W${v.week}`;n.set(m,(n.get(m)||0)+1);const y=new Date(l.metadata.createdAt);(!s||y<new Date(s.metadata.createdAt))&&(s=l),(!r||y>new Date(r.metadata.createdAt))&&(r=l)});const o=Array.from(n.entries()).map(([l,i])=>{const[v,m]=l.split("-W");return{year:parseInt(v),week:parseInt(m),count:i}}).sort((l,i)=>l.year!==i.year?l.year-i.year:l.week-i.week);return{total:t.length,byType:a,byWeek:o,oldest:s,newest:r}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class Y extends Error{constructor(e,t,a={}){super(e),this.name="SnapshotError",this.code=t,this.details=a}}const q={formed:{bitrixId:Ee.formed,name:Te.FORMED.name},review:{bitrixId:Ee.review,name:Te.REVIEW.name},execution:{bitrixId:Ee.execution,name:Te.EXECUTION.name}},ie=nt;function rt(S){if(!S||typeof S!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!S.stages||!Array.isArray(S.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=ot(S.stages),t=it(S.stages),a=lt(S.zeroPointTickets||{}),n=ct(S.zeroPointTickets||{}),s=ut(S.stages,S.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:a,zeroPointByStage:n},ticketIds:s.ticketIds,tickets:s.tickets}}function ot(S){const e={formed:{count:0,stageId:q.formed.bitrixId,stageName:q.formed.name},review:{count:0,stageId:q.review.bitrixId,stageName:q.review.name},execution:{count:0,stageId:q.execution.bitrixId,stageName:q.execution.name},total:0};return S.forEach(t=>{if(!q[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let a=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(n=>{n.tickets&&Array.isArray(n.tickets)&&(a+=n.tickets.length)}),e[t.id].count=a,e.total+=a}),e}function it(S){const e=new Map;return S.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(a=>{if(!a||!a.id)return;e.has(a.id)||e.set(a.id,{id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const n=e.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;q[t.id]&&(n.ticketsByStage[t.id]=(n.ticketsByStage[t.id]||0)+s),n.totalTickets+=s})}),Array.from(e.values())}function lt(S){let e=0,t=0;return!S||typeof S!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(S).forEach(a=>{Array.isArray(a)&&a.forEach(n=>{if(!n)return;const s=n.assignedTo||n.assignedById;!s||s===null?e++:(typeof s=="object"?s.id:s)===ie?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function ct(S){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!S||typeof S!="object"||Object.keys(e).forEach(t=>{const a=S[t];Array.isArray(a)&&a.forEach(n=>{if(!n)return;const s=n.assignedTo||n.assignedById;!s||s===null?e[t].unassigned++:(typeof s=="object"?s.id:s)===ie?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function ut(S,e){const t=new Set,a=new Map;return Array.isArray(S)&&S.forEach(n=>{!n.employees||!Array.isArray(n.employees)||n.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(r=>{if(!r||!r.id){console.warn("Ticket without ID found:",r);return}const o=parseInt(r.id);if(isNaN(o)){console.warn("Invalid ticket ID:",r.id);return}t.add(o);let l=r.assignedTo;!l&&s.id&&(l={id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`}),a.set(o,{id:o,title:r.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:l||null,createdAt:de(r.createdAt||r.createdTime),updatedAt:de(r.updatedAt||r.modifiedAt||r.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(n=>{Array.isArray(n)&&n.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const r=parseInt(s.id);if(isNaN(r)){console.warn("Invalid ticket ID in zero point:",s.id);return}t.add(r);let o=s.assignedTo;if(!o&&s.assignedById){const l=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;l&&l!==ie?o={id:l,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:l===ie&&(o={id:ie,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}a.set(r,{id:r,title:s.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o||null,createdAt:de(s.createdAt||s.createdTime),updatedAt:de(s.updatedAt||s.modifiedAt||s.updatedTime)})})}),{ticketIds:Array.from(t).sort((n,s)=>n-s),tickets:Array.from(a.values())}}function de(S){if(!S)return null;if(S instanceof Date)return S.toISOString();if(typeof S=="string"){if(S.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return S;const e=new Date(S);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",S),null}class Ce{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:a=null,normalize:n=!0,includeTicketDetails:s=!1}=e;try{const r=await Le.getSectorData(t,a);return n?rt(r):(s&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),r)}catch(r){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",r),r}}static async isDataAvailable(){try{const e=await Le.getSectorData(!0);return e!=null}catch{return!1}}}class $e{static compareTwoSnapshots(e,t,a={}){const{includeTickets:n=!1,includeEmployees:s=!0}=a,r=this.validateSnapshot(e),o=this.validateSnapshot(t);if(!r.valid||!o.valid)throw new Error("Invalid snapshot structure: "+[...r.errors,...o.errors].join(", "));const l=this.buildComparisonMetadata(e,t),i=this.compareStages(e.statistics.stages,t.statistics.stages),v=s?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],m=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),y=n?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,B=this.buildSummary(i,v,m,y);return{metadata:l,stages:i,employees:v,zeroPoint:m,tickets:y,summary:B}}static calculateDelta(e,t){const a=this.normalizeValue(e),n=this.normalizeValue(t),s=n-a;let r=0;a!==0?r=s/a*100:n!==0&&(r=n>0?1/0:-1/0);const o=this.getTrend(s);return{value1:a,value2:n,delta:s,deltaPercent:Math.round(r*100)/100,trend:o}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var o,l;const a=["formed","review","execution"],n={};for(const i of a){const v=((o=e[i])==null?void 0:o.count)||0,m=((l=t[i])==null?void 0:l.count)||0;n[i]=this.calculateDelta(v,m)}const s=e.total||0,r=t.total||0;return n.total=this.calculateDelta(s,r),n}static compareEmployees(e,t){var o,l;const a=new Map(e.map(i=>[i.id,i])),n=new Map(t.map(i=>[i.id,i])),s=new Set([...a.keys(),...n.keys()]),r=[];for(const i of s){const v=a.get(i)||null,m=n.get(i)||null;if(!v||!m){r.push({id:i,name:(v==null?void 0:v.name)||(m==null?void 0:m.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:v?{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0}:null,snapshot2:m?{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0}:null,delta:this.calculateEmployeeDelta(v,m),trend:v?"removed":"new"});continue}const y={},B=["formed","review","execution"];for(const T of B){const h=((o=v.ticketsByStage)==null?void 0:o[T])||0,g=((l=m.ticketsByStage)==null?void 0:l[T])||0;y[T]=this.calculateDelta(h,g)}const $=this.calculateDelta(v.totalTickets||0,m.totalTickets||0);r.push({id:i,name:v.name,snapshot1:{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0},snapshot2:{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0},delta:{ticketsByStage:y,totalTickets:$},trend:$.trend})}return r}static calculateEmployeeDelta(e,t){var r,o;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},n=["formed","review","execution"];for(const l of n){const i=((r=e==null?void 0:e.ticketsByStage)==null?void 0:r[l])||0,v=((o=t==null?void 0:t.ticketsByStage)==null?void 0:o[l])||0;a[l]=this.calculateDelta(i,v)}const s=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,a,n){var B,$;const s=new Set(e),r=new Set(t),o=t.filter(T=>!s.has(T)),l=e.filter(T=>!r.has(T)),i=[],v=[],m=new Map(a.map(T=>[T.id,T])),y=new Map(n.map(T=>[T.id,T]));for(const T of e){if(!r.has(T))continue;const h=m.get(T),g=y.get(T);if(!h||!g)continue;const b=(((B=h.assignedTo)==null?void 0:B.id)||null)!==((($=g.assignedTo)==null?void 0:$.id)||null),O=(h.stageId||null)!==(g.stageId||null);b||O?i.push(T):v.push(T)}return{new:o,removed:l,changed:i,unchanged:v}}static buildComparisonMetadata(e,t){const a=new Date(e.metadata.createdAt),n=new Date(t.metadata.createdAt),s=new Date,r=n.getTime()-a.getTime(),o=Math.floor(r/(1e3*60*60*24)),l=Math.floor(r%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(r%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:o,hours:l,minutes:i,totalMinutes:Math.floor(r/(1e3*60))}}}static buildSummary(e,t,a,n){var i,v,m;const s=e.total.delta,r=Object.keys(e).filter(y=>y==="total"?!1:e[y].delta!==0).length,o=t.filter(y=>y.trend==="new"||y.trend==="removed"?!0:y.delta.totalTickets.delta!==0).length,l=s!==0||r>0||o>0;return{totalDelta:s,stagesChanged:r,employeesChanged:o,hasChanges:l,newTicketsCount:((i=n==null?void 0:n.new)==null?void 0:i.length)||0,removedTicketsCount:((v=n==null?void 0:n.removed)==null?void 0:v.length)||0,changedTicketsCount:((m=n==null?void 0:n.changed)==null?void 0:m.length)||0}}static validateSnapshot(e){const t=[],a=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:a};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const n=["formed","review","execution"];for(const s of n)e.statistics.stages[s]||a.push(`Missing stage: ${s}`)}e.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:a}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const r of e){const o=this.validateSnapshot(r);if(!o.valid)throw new Error("Invalid snapshot: "+o.errors.join(", "))}const a=[...e].sort((r,o)=>{const l=new Date(r.metadata.createdAt),i=new Date(o.metadata.createdAt);return l-i}),n=[];for(let r=0;r<a.length-1;r++)n.push({from:r,to:r+1,result:this.compareTwoSnapshots(a[r],a[r+1],t)});const s=this.buildTrends(a);return{snapshots:a.map((r,o)=>({index:o,date:r.metadata.createdAt,type:r.metadata.type,data:r})),comparisons:n,trends:s}}static buildTrends(e){var a,n,s,r,o,l,i,v,m,y;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const B of e){const $=B.statistics;t.stages.formed.push(((n=(a=$.stages)==null?void 0:a.formed)==null?void 0:n.count)||0),t.stages.review.push(((r=(s=$.stages)==null?void 0:s.review)==null?void 0:r.count)||0),t.stages.execution.push(((l=(o=$.stages)==null?void 0:o.execution)==null?void 0:l.count)||0),t.stages.total.push(((i=$.stages)==null?void 0:i.total)||0),t.zeroPoint.unassigned.push(((v=$.zeroPoint)==null?void 0:v.unassigned)||0),t.zeroPoint.keeper.push(((m=$.zeroPoint)==null?void 0:m.keeper)||0),t.zeroPoint.total.push(((y=$.zeroPoint)==null?void 0:y.total)||0)}return t}}const dt={class:"graph-state-chart"},pt={class:"chart-header"},ft={class:"chart-type-selector"},gt=["onClick","title"],ht={class:"chart-type-icon"},mt={class:"chart-type-label"},vt={key:0,class:"comparison-type-selector"},wt={class:"radio-group"},yt={key:0},St={key:1},kt={key:1,class:"chart-filters"},Dt=["onUpdate:modelValue"],bt={class:"filter-label"},Tt={key:2,class:"graph-legend"},Et={key:4,class:"error-container"},$t={class:"error-message"},At={key:5,class:"chart-container"},_t={key:6,class:"no-data"},Ct={key:7,class:"employees-details"},It={class:"employees-details-content"},Bt={class:"stage-details-header"},Rt={class:"stage-details-name"},Mt={class:"stage-details-count"},xt={class:"stage-details-employees"},Ot={class:"employee-detail-name"},Ft={class:"employee-detail-count"},Nt={key:0,class:"no-employees-in-stage"},Pt={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(S,{emit:e}){const t=S,a=e,n=C(!1),s=C(null),r=C(null),o=C({weekStart:null,weekEnd:null,current:null}),l=C(null),i=C("weekStartToWeekEnd"),v=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],m=C("line"),y=C(!0),B=C([]),$=j(()=>{switch(m.value){case"line":return Ve;case"bar":return st;case"doughnut":return at;default:return Ve}}),T=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745"}],h=C({formed:!0,review:!0,execution:!0});function g(D){var p;const u=o.value.current||o.value.weekEnd||o.value.weekStart;return!u||!u.statistics||!u.statistics.stages?0:((p=u.statistics.stages[D])==null?void 0:p.count)||0}function b(D){const u=o.value.current||o.value.weekEnd||o.value.weekStart;if(!u||!u.statistics)return[];const p=[];u.statistics.employees&&Array.isArray(u.statistics.employees)&&u.statistics.employees.filter(f=>f.ticketsByStage&&f.ticketsByStage[D]>0).forEach(f=>{p.push({id:f.id,name:f.name,count:f.ticketsByStage[D]||0})});const w=O(D);return w>0&&p.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:w,isKeeper:!0}),p.sort((f,d)=>d.count-f.count)}function O(D){const u=o.value.current||o.value.weekEnd||o.value.weekStart;if(!u||!u.statistics)return 0;if(u.statistics.zeroPointByStage&&u.statistics.zeroPointByStage[D])return u.statistics.zeroPointByStage[D].keeper||0;if(u.statistics.zeroPoint){const p=u.statistics.zeroPoint.keeper||0;return Math.floor(p/3)}return 0}const J=ve();function X(){const D=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(u=>{!u||!u.statistics||!u.statistics.employees||u.statistics.employees.forEach(p=>{D.has(p.id)||D.set(p.id,{id:p.id,name:p.name})})}),B.value=Array.from(D.values()).sort((u,p)=>u.name.localeCompare(p.name))}function U(D,u="background"){var w;return((w={increase:{background:"#10b981",border:"#059669",point:"#10b981"},decrease:{background:"#ef4444",border:"#dc2626",point:"#ef4444"},stable:{background:"#9ca3af",border:"#6b7280",point:"#9ca3af"}}[D])==null?void 0:w[u])||"#6c757d"}function we(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const D=$e.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let u=null,p=null;o.value.current&&(u=$e.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),p=$e.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),l.value={weekStartToWeekEnd:D,weekEndToCurrent:u,weekStartToCurrent:p}}catch(D){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",D),J.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+D.message)}}function le(D){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[D]||"formed"}const te=j(()=>{if(!r.value)return null;if(m.value==="doughnut")return r.value;const D=r.value.datasets.filter(u=>{const p=T.find(w=>w.name===u.label);return p?h.value[p.id]:!0});return{...r.value,datasets:D}}),ye=j(()=>{const D={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:m.value==="doughnut"?"right":"top",onClick:(u,p,w)=>{const f=p.datasetIndex;if(f!==void 0){const d=w.chart.getDatasetMeta(f);d.hidden=!d.hidden,w.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:u=>u[0].label||"",label:u=>{var d,I,E,_,F,R;const p=u.dataset.label||"",w=u.parsed.y||u.parsed||0,f=u.dataIndex;if(m.value==="doughnut"){const M=u.dataset.data.reduce((z,Q)=>z+Q,0),L=M>0?(w/M*100).toFixed(1):0;return`${p}: ${w} (${L}%)`}else{if(!l.value||f===0||m.value==="doughnut")return`${p}: ${w}`;let M=null;const L=le(p);if(i.value==="weekStartToWeekEnd"&&f===1?M=(I=(d=l.value.weekStartToWeekEnd)==null?void 0:d.stages)==null?void 0:I[L]:i.value==="weekEndToCurrent"&&f===2&&o.current?M=(_=(E=l.value.weekEndToCurrent)==null?void 0:E.stages)==null?void 0:_[L]:i.value==="weekStartToCurrent"&&f===2&&o.current&&(M=(R=(F=l.value.weekStartToCurrent)==null?void 0:F.stages)==null?void 0:R[L]),!M)return`${p}: ${w}`;const z=M.delta,Q=M.deltaPercent,ae=M.trend;let ee=`${p}: ${w}`;if(z!==0){const se=z>0?"+":"",ue=ae==="increase"?"‚Üë":ae==="decrease"?"‚Üì":"‚Üí";ee+=` (${se}${z}, ${se}${Q.toFixed(1)}%) ${ue}`}else ee+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return ee}},afterBody:u=>{if(m.value==="doughnut"||!l.value)return[];const p=u[0].dataIndex;if(p===0)return[];let w=null;if(le(u[0].dataset.label||""),i.value==="weekStartToWeekEnd"&&p===1?w=l.value.weekStartToWeekEnd:i.value==="weekEndToCurrent"&&p===2?w=l.value.weekEndToCurrent:i.value==="weekStartToCurrent"&&p===2&&(w=l.value.weekStartToCurrent),!w||!w.metadata)return[];const f=w.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${f.days} –¥–Ω. ${f.hours} —á. ${f.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return m.value==="line"||m.value==="bar"?{...D,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:m.value==="doughnut"?{...D,cutout:"60%"}:D});function ce(D){const u=new Date(D),p=u.getFullYear(),w=String(u.getMonth()+1).padStart(2,"0"),f=String(u.getDate()).padStart(2,"0");return`${p}-${w}-${f}`}function Se(D){const{current:u,weekEnd:p}=D,w=u||p;if(!w||!w.statistics||!w.statistics.stages)return null;const f=[],d=[],I=[],E=[];return T.forEach(_=>{var R;const F=((R=w.statistics.stages[_.id])==null?void 0:R.count)||0;F>0&&(f.push(_.name),d.push(F),I.push(_.color+"80"),E.push(_.color))}),d.length===0?null:{labels:f,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:d,backgroundColor:I,borderColor:E,borderWidth:2}]}}function ke(D){if(m.value==="doughnut")return Se(D);const{weekStart:u,weekEnd:p,current:w}=D,f=[],d=[];return T.forEach(I=>{var L,z,Q,ae,ee,se,ue,Ie,Be,Re,Me,xe,Oe,Fe,Ne,Pe,We;const E=[];if(u&&u.statistics&&u.statistics.stages){const N=u.statistics.stages[I.id];if(f.length===0){const ne=(L=u.metadata)!=null&&L.createdAt?new Date(u.metadata.createdAt):null;f.push(ne?ce(ne):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}E.push((N==null?void 0:N.count)||0)}else f.length===0&&f.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),E.push(0);if(p&&p.statistics&&p.statistics.stages){const N=p.statistics.stages[I.id];if(f.length===1){const ne=(z=p.metadata)!=null&&z.createdAt?new Date(p.metadata.createdAt):null;f.push(ne?ce(ne):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}E.push((N==null?void 0:N.count)||0)}else f.length===1&&f.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),E.push(0);if(w&&t.showCurrentState&&w.statistics&&w.statistics.stages){const N=w.statistics.stages[I.id];f.length===2&&f.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),E.push((N==null?void 0:N.count)||0)}const _=["stable"];l.value?i.value==="weekStartToWeekEnd"?(_.push(((ee=(ae=(Q=l.value.weekStartToWeekEnd)==null?void 0:Q.stages)==null?void 0:ae[I.id])==null?void 0:ee.trend)||"stable"),w&&_.push(((Ie=(ue=(se=l.value.weekStartToCurrent)==null?void 0:se.stages)==null?void 0:ue[I.id])==null?void 0:Ie.trend)||"stable")):i.value==="weekEndToCurrent"&&w?(_.push("stable"),_.push(((Me=(Re=(Be=l.value.weekEndToCurrent)==null?void 0:Be.stages)==null?void 0:Re[I.id])==null?void 0:Me.trend)||"stable")):i.value==="weekStartToCurrent"&&w?(_.push(((Fe=(Oe=(xe=l.value.weekStartToWeekEnd)==null?void 0:xe.stages)==null?void 0:Oe[I.id])==null?void 0:Fe.trend)||"stable"),_.push(((We=(Pe=(Ne=l.value.weekStartToCurrent)==null?void 0:Ne.stages)==null?void 0:Pe[I.id])==null?void 0:We.trend)||"stable")):(_.push("stable"),w&&_.push("stable")):(_.push("stable"),w&&_.push("stable"));let F,R,M;l.value&&m.value!=="doughnut"?(F=_.map(N=>U(N,"background")+"40"),R=_.map(N=>U(N,"border")),M=_.map(N=>U(N,"point"))):(F=I.color+"40",R=I.color,M=I.color),d.push({label:I.name,data:E,backgroundColor:(Array.isArray(F),F),borderColor:(Array.isArray(R),R),borderWidth:2,pointBackgroundColor:(Array.isArray(M),M),pointBorderColor:(Array.isArray(R),R),pointRadius:6,pointHoverRadius:8,fill:m.value!=="line",tension:m.value==="line"?.4:0})}),f.length===0&&(f.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),t.showCurrentState&&f.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:f,datasets:d}}const Z=async()=>{var D,u,p;n.value=!0,s.value=null;try{const w=(D=t.period)!=null&&D.endDate?new Date(t.period.endDate):new Date,f=(u=t.period)!=null&&u.startDate?new Date(t.period.startDate):G.getWeekStartDate(w),d=(p=t.period)!=null&&p.endDate?new Date(t.period.endDate):G.getWeekEndDate(w),I=G.formatDate(f),E=G.formatDate(d),[_,F]=await Promise.all([G.getSnapshot(I,"week_start"),G.getSnapshot(E,"week_end")]);let R=null;t.showCurrentState&&(R=await Ce.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:_,weekEnd:F,current:R},X(),we(),H(),a("data-loaded",{weekStart:_,weekEnd:F,current:R})}catch(w){console.error("Error loading chart data:",w),s.value=w.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",J.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+s.value),a("error",s.value)}finally{n.value=!1}};ge(()=>{Z()});const H=()=>{r.value=ke({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current})};return De(()=>[t.period,t.showCurrentState],()=>{Z()},{deep:!0}),De(m,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&H()}),De(i,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&H()}),(D,u)=>(k(),A("div",dt,[c("div",pt,[u[3]||(u[3]=c("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),c("div",ft,[(k(),A(re,null,oe(v,p=>c("button",{key:p.value,onClick:w=>m.value=p.value,class:me(["chart-type-btn",{active:m.value===p.value}]),title:p.label},[c("span",ht,W(p.icon),1),c("span",mt,W(p.label),1)],10,gt)),64))])]),!n.value&&!s.value&&l.value&&m.value!=="doughnut"?(k(),A("div",vt,[u[7]||(u[7]=c("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),c("div",wt,[c("label",null,[V(c("input",{type:"radio","onUpdate:modelValue":u[0]||(u[0]=p=>i.value=p),value:"weekStartToWeekEnd",onChange:H},null,544),[[be,i.value]]),u[4]||(u[4]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),o.value.current?(k(),A("label",yt,[V(c("input",{type:"radio","onUpdate:modelValue":u[1]||(u[1]=p=>i.value=p),value:"weekEndToCurrent",onChange:H},null,544),[[be,i.value]]),u[5]||(u[5]=c("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0),o.value.current?(k(),A("label",St,[V(c("input",{type:"radio","onUpdate:modelValue":u[2]||(u[2]=p=>i.value=p),value:"weekStartToCurrent",onChange:H},null,544),[[be,i.value]]),u[6]||(u[6]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0)])])):P("",!0),!n.value&&!s.value&&r.value?(k(),A("div",kt,[(k(),A(re,null,oe(T,p=>c("label",{key:p.id,class:"filter-checkbox"},[V(c("input",{type:"checkbox","onUpdate:modelValue":w=>h.value[p.id]=w,onChange:H},null,40,Dt),[[pe,h.value[p.id]]]),c("span",{class:"filter-color",style:Ae({backgroundColor:p.color})},null,4),c("span",bt,W(p.name),1)])),64))])):P("",!0),!n.value&&!s.value&&l.value&&m.value!=="doughnut"?(k(),A("div",Tt,[...u[8]||(u[8]=[Ge('<h4 class="legend-title" data-v-c469e424>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-c469e424><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#10b981;" data-v-c469e424></span><span data-v-c469e424>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#ef4444;" data-v-c469e424></span><span data-v-c469e424>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#9ca3af;" data-v-c469e424></span><span data-v-c469e424>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):P("",!0),n.value?(k(),he(ze,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):s.value?(k(),A("div",Et,[c("p",$t,"‚ùå "+W(s.value),1),c("button",{onClick:Z,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):te.value?(k(),A("div",At,[(k(),he(Xe($.value),{data:te.value,options:ye.value,height:300},null,8,["data","options"]))])):(k(),A("div",_t,[...u[9]||(u[9]=[c("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),c("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),!n.value&&!s.value&&r.value&&y.value?(k(),A("div",Ct,[u[10]||(u[10]=c("h4",{class:"employees-details-title"},"–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º",-1)),c("div",It,[(k(),A(re,null,oe(T,p=>c("div",{key:p.id,class:"stage-details"},[c("div",Bt,[c("span",{class:"stage-details-color",style:Ae({backgroundColor:p.color})},null,4),c("h5",Rt,W(p.name),1),c("span",Mt," –í—Å–µ–≥–æ: "+W(g(p.id))+" —Ç–∏–∫–µ—Ç–æ–≤ ",1)]),c("div",xt,[(k(!0),A(re,null,oe(b(p.id),w=>(k(),A("div",{key:`${p.id}-${w.id}`,class:me(["employee-detail-item",{"employee-detail-keeper":w.isKeeper}])},[c("span",Ot,W(w.name),1),c("span",Ft,W(w.count)+" —Ç–∏–∫–µ—Ç–æ–≤",1)],2))),128)),b(p.id).length===0?(k(),A("div",Nt," –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ ")):P("",!0)])])),64))])])):P("",!0)]))}},Wt=_e(Pt,[["__scopeId","data-v-c469e424"]]),jt={key:0,class:"create-snapshot-button-container"},Ut=["disabled"],Vt={class:"modal-content"},Lt={class:"modal-header"},zt=["disabled"],Ht={class:"modal-body"},Kt={key:0,class:"progress-container"},qt={class:"progress-bar-wrapper"},Gt={class:"progress-text"},Xt={class:"progress-percent"},Yt={class:"progress-description"},Jt={key:1},Zt={class:"modal-footer"},Qt=["disabled"],ea=["disabled"],ta={key:0},aa={key:0},sa={key:1},na={key:2},ra={key:1},oa={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(S,{emit:e}){const t=S,a=e,n=C(t.user),s=C(!1),r=C(!1),o=C(0),l=C("idle"),i=C(""),v=ve(),m=j(()=>n.value?Qe(n.value):!1);ge(async()=>{if(!t.user)try{const h=await He.checkAccess();h.allowed&&(n.value=h.user)}catch(h){console.error("Error loading user:",h)}});const y=()=>{if(!m.value){v.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}s.value=!0},B=()=>{r.value||(s.value=!1,l.value="idle",o.value=0,i.value="")},$=async()=>{if(!r.value){if(!m.value){v.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}r.value=!0,l.value="loading_data",o.value=0,i.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{i.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const h=await Ce.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:O=>{var X;const J=Math.min(80,(O.progress||0)*.8);o.value=J,l.value="loading_data",i.value=O.description||((X=O.details)==null?void 0:X.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});l.value="creating_snapshot",o.value=85,i.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const g=n.value;if(!g)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const b=await G.createSnapshot(h,"manual",{createdBy:{id:g.ID,name:`${g.NAME||""} ${g.LAST_NAME||""}`.trim()||g.EMAIL||`User ${g.ID}`},sectorId:"1C"});l.value="success",o.value=100,i.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",v.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),a("snapshot-created",b),setTimeout(()=>{B()},1500)}catch(h){l.value="error",o.value=0,i.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",h);let g="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";h.message&&(h.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||h.message.includes("sector data")?g="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":h.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||h.message.includes("snapshot")?g="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":h.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||h.message.includes("validation")?g="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":g=h.message),v.error(g)}finally{r.value=!1}}},T=h=>{h.key==="Escape"&&s.value&&!r.value&&B()};return ge(()=>{window.addEventListener("keydown",T)}),Ke(()=>{window.removeEventListener("keydown",T)}),(h,g)=>m.value?(k(),A("div",jt,[c("button",{class:"create-snapshot-btn",onClick:y,disabled:r.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...g[1]||(g[1]=[c("span",{class:"btn-icon"},"üì∏",-1),c("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,Ut),(k(),he(Ze,{to:"body"},[fe(Je,{name:"modal"},{default:qe(()=>[s.value?(k(),A("div",{key:0,class:"modal-overlay",onClick:g[0]||(g[0]=Ye(b=>!r.value&&B(),["self"]))},[c("div",Vt,[c("div",Lt,[g[2]||(g[2]=c("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),c("button",{class:"modal-close",onClick:B,disabled:r.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,zt)]),c("div",Ht,[l.value!=="idle"?(k(),A("div",Kt,[c("div",qt,[c("div",{class:"progress-bar",style:Ae({width:`${o.value}%`})},null,4)]),c("div",Gt,[c("span",Xt,W(Math.round(o.value))+"%",1),c("span",Yt,W(i.value),1)])])):(k(),A("div",Jt,[...g[3]||(g[3]=[c("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),c("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),c("div",Zt,[c("button",{class:"btn btn-secondary",onClick:B,disabled:r.value}," –û—Ç–º–µ–Ω–∞ ",8,Qt),c("button",{class:"btn btn-primary",onClick:$,disabled:r.value},[r.value?(k(),A("span",ta,[l.value==="loading_data"?(k(),A("span",aa,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):l.value==="creating_snapshot"?(k(),A("span",sa,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(k(),A("span",na,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(k(),A("span",ra,"–°–æ–∑–¥–∞—Ç—å"))],8,ea)])])])):P("",!0)]),_:1})]))])):P("",!0)}},ia=_e(oa,[["__scopeId","data-v-cb08ebb3"]]);function la(){const S=C(!1),e=C(null),t=C(null),a=C(0),n=ve(),s=async(h=!0,g=null)=>{S.value=!0,e.value=null,a.value=0;try{const b=await Ce.getSectorDataForSnapshot({useCache:h,onProgress:O=>{O&&typeof O.progress=="number"&&(a.value=O.progress),g&&g(O)},normalize:!0});return t.value=b,b}catch(b){throw e.value=b.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",n.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+e.value),b}finally{S.value=!1,a.value=100}},r=async(h,g={})=>{if(!t.value){const b="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw e.value=b,n.error(b),new Error(b)}S.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(h))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${h}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const b=await G.createSnapshot(t.value,h,g);return n.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),b}catch(b){throw e.value=b.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",n.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+e.value),b}finally{S.value=!1}},o=()=>{S.value=!1,e.value=null,t.value=null,a.value=0},l=j(()=>t.value!==null&&t.value!==void 0),i=C({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),v=j(()=>{const h=new Date;let g,b;switch(i.value.dateRange){case"last-week":g=new Date(h),g.setDate(h.getDate()-7),b=h;break;case"last-2-weeks":g=new Date(h),g.setDate(h.getDate()-14),b=h;break;case"last-month":g=new Date(h),g.setMonth(h.getMonth()-1),b=h;break;case"custom":g=i.value.customDateRange.startDate?new Date(i.value.customDateRange.startDate):null,b=i.value.customDateRange.endDate?new Date(i.value.customDateRange.endDate):null;break;default:g=new Date(h),g.setDate(h.getDate()-7),b=h}return{startDate:g?g.toISOString().split("T")[0]:null,endDate:b?b.toISOString().split("T")[0]:null}}),m=()=>{B()},y=()=>{i.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},B()},B=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(i.value))}catch(h){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",h)}},$=()=>{try{const h=localStorage.getItem("graphStateFilters");if(h){const g=JSON.parse(h);g&&typeof g=="object"&&(i.value={stages:g.stages||{formed:!0,review:!0,execution:!0},employees:g.employees||["all"],dateRange:g.dateRange||"last-week",customDateRange:g.customDateRange||{startDate:null,endDate:null}})}}catch(h){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",h)}},T=j(()=>{const h=Object.values(i.value.stages).some(O=>!O),g=!i.value.employees.includes("all"),b=i.value.dateRange!=="last-week";return h||g||b});return{isLoading:S,error:e,currentSectorData:t,loadingProgress:a,hasSectorData:l,filters:i,selectedPeriod:v,hasActiveFilters:T,loadSectorDataForSnapshot:s,createSnapshot:r,resetState:o,applyFilters:m,resetFilters:y,saveFiltersToLocalStorage:B,loadFiltersFromLocalStorage:$}}const ca={class:"graph-state-dashboard"},ua={key:1,class:"error-message-container"},da={class:"error-message"},pa={class:"error-text"},fa={key:0,class:"error-details"},ga={class:"dashboard-header"},ha={class:"header-content"},ma={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},va={class:"header-actions"},wa=["disabled"],ya={key:0},Sa={key:1},ka={class:"filters-header"},Da=["disabled"],ba={class:"filters-content"},Ta={class:"filter-group"},Ea={class:"checkbox-group"},$a={class:"checkbox-item"},Aa={class:"checkbox-item"},_a={class:"checkbox-item"},Ca={class:"filter-group"},Ia=["value"],Ba={class:"filter-group"},Ra={key:0,class:"filter-group custom-date-range"},Ma={class:"date-range-inputs"},xa={class:"date-input-group"},Oa=["max"],Fa={class:"date-input-group"},Na=["min","max"],Pa={key:0,class:"filter-error"},Wa={key:1,class:"filter-hint"},ja={key:3,class:"dashboard-content"},Ua={class:"chart-container"},Va={__name:"GraphStateDashboard",setup(S){const e=(f,d)=>typeof window>"u"?d:getComputedStyle(document.documentElement).getPropertyValue(f).trim()||d,t=ve(),{filters:a,selectedPeriod:n,hasActiveFilters:s,applyFilters:r,resetFilters:o,loadFiltersFromLocalStorage:l}=la(),i=C(null),v=C(!0),m=C([]),y=C(!1),B=C("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),$=C(null),T=C(!1),h=C(!1),g=C(typeof window<"u"?window.innerWidth:1024),b=C(null),O=j(()=>g.value<768);j(()=>g.value>=768&&g.value<1024),j(()=>g.value>=1024);const J=j(()=>{const f=new Date;return f.setFullYear(f.getFullYear()-1),f.toISOString().split("T")[0]}),X=j(()=>new Date().toISOString().split("T")[0]);function U(){r()}function we(){o(),b.value=null,U(),t.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function le(){a.value.dateRange!=="custom"&&(b.value=null,U())}function te(){const f=ye(a.value.customDateRange.startDate,a.value.customDateRange.endDate);if(!f.valid){b.value=f.error;return}b.value=null,U()}function ye(f,d){if(!f||!d)return{valid:!1,error:"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–±–µ –¥–∞—Ç—ã"};const I=new Date(f),E=new Date(d);return I>E?{valid:!1,error:"–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π"}:Math.ceil((E-I)/(1e3*60*60*24))>365?{valid:!1,error:"–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π"}:{valid:!0}}function ce(f){t.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function Se(f){y.value=!1,B.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",f)}function ke(f){y.value=!1,Z({message:f||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function Z(f){$.value={message:f.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:f.details||null,type:f.type||"error",timestamp:new Date},console.error("Dashboard error:",$.value),t.error($.value.message)}function H(){$.value=null}function D(){$.value=null,y.value=!0,B.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function u(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}T.value=!0;try{const f=document.querySelector(".chart-container");if(!f)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const d=window.html2canvas,I=await d(f,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),E=window.jsPDF,_=new E("landscape","mm","a4"),F=297,R=I.height*F/I.width;_.setFontSize(18),_.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const M=new Date().toLocaleDateString("ru-RU");_.setFontSize(10);const L=n.value.startDate&&n.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${n.value.startDate} - ${n.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";_.text(L,148.5,25,{align:"center"}),_.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${M}`,148.5,30,{align:"center"}),_.addImage(I.toDataURL("image/png"),"PNG",10,35,F-20,R-20),_.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${M}`,author:"Bitrix24 Dashboard"});const z=`graph-state-${M.replace(/\//g,"-")}.pdf`;_.save(z),t.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(f){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",f),Z({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(f.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:f.stack,type:"error"})}finally{T.value=!1}}function p(){typeof window<"u"&&(g.value=window.innerWidth)}async function w(){try{const f=await He.checkAccess();f.allowed&&(i.value=f.user)}catch(f){console.error("Error loading user:",f)}}return ge(()=>{l(),w(),typeof window<"u"&&(g.value=window.innerWidth,window.addEventListener("resize",p))}),Ke(()=>{typeof window<"u"&&window.removeEventListener("resize",p)}),(f,d)=>{const I=et("router-link");return k(),A("div",ca,[y.value?(k(),he(ze,{key:0,message:B.value},null,8,["message"])):P("",!0),$.value?(k(),A("div",ua,[c("div",da,[c("div",{class:"error-header"},[d[8]||(d[8]=c("span",{class:"error-icon"},"‚ùå",-1)),d[9]||(d[9]=c("h3",null,"–û—à–∏–±–∫–∞",-1)),c("button",{onClick:H,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),c("p",pa,W($.value.message),1),$.value.details?(k(),A("div",fa,[c("details",null,[d[10]||(d[10]=c("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),c("pre",null,W($.value.details),1)])])):P("",!0),c("div",{class:"error-actions"},[c("button",{onClick:D,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):P("",!0),c("div",ga,[c("div",ha,[c("nav",ma,[fe(I,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:qe(()=>[...d[11]||(d[11]=[tt(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),d[12]||(d[12]=c("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),d[13]||(d[13]=c("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))]),d[14]||(d[14]=c("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),d[15]||(d[15]=c("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),c("div",va,[c("button",{onClick:u,class:"btn-export-pdf",disabled:T.value||y.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[T.value?(k(),A("span",Sa,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(k(),A("span",ya,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,wa),fe(ia,{user:i.value,onSnapshotCreated:ce},null,8,["user"])])]),O.value?(k(),A("button",{key:2,class:"mobile-filters-toggle",onClick:d[0]||(d[0]=E=>h.value=!h.value)},[d[16]||(d[16]=c("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("span",{class:me(["toggle-icon",{open:h.value}])},"‚ñº",2)])):P("",!0),c("div",{class:me(["filters-panel",{"mobile-open":h.value&&O.value,"mobile-closed":!h.value&&O.value}])},[c("div",ka,[d[17]||(d[17]=c("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("button",{onClick:we,class:"btn-reset-filters",disabled:!x(s)}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,Da)]),c("div",ba,[c("div",Ta,[d[21]||(d[21]=c("label",{class:"filter-label"},"–≠—Ç–∞–ø—ã:",-1)),c("div",Ea,[c("label",$a,[V(c("input",{type:"checkbox","onUpdate:modelValue":d[1]||(d[1]=E=>x(a).stages.formed=E),onChange:U},null,544),[[pe,x(a).stages.formed]]),d[18]||(d[18]=c("span",null,"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",-1))]),c("label",Aa,[V(c("input",{type:"checkbox","onUpdate:modelValue":d[2]||(d[2]=E=>x(a).stages.review=E),onChange:U},null,544),[[pe,x(a).stages.review]]),d[19]||(d[19]=c("span",null,"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",-1))]),c("label",_a,[V(c("input",{type:"checkbox","onUpdate:modelValue":d[3]||(d[3]=E=>x(a).stages.execution=E),onChange:U},null,544),[[pe,x(a).stages.execution]]),d[20]||(d[20]=c("span",null,"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",-1))])])]),c("div",Ca,[d[23]||(d[23]=c("label",{class:"filter-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:",-1)),V(c("select",{"onUpdate:modelValue":d[4]||(d[4]=E=>x(a).employees=E),multiple:"",onChange:U,class:"employees-select",size:"5"},[d[22]||(d[22]=c("option",{value:"all"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",-1)),(k(!0),A(re,null,oe(m.value,E=>(k(),A("option",{key:E.id,value:E.id},W(E.name),9,Ia))),128))],544),[[je,x(a).employees]]),d[24]||(d[24]=c("small",{class:"filter-hint"}," –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac) ",-1))]),c("div",Ba,[d[26]||(d[26]=c("label",{class:"filter-label"},"–ü–µ—Ä–∏–æ–¥:",-1)),V(c("select",{"onUpdate:modelValue":d[5]||(d[5]=E=>x(a).dateRange=E),onChange:le,class:"date-range-select"},[...d[25]||(d[25]=[c("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),c("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),c("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),c("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],544),[[je,x(a).dateRange]])]),x(a).dateRange==="custom"?(k(),A("div",Ra,[d[29]||(d[29]=c("label",{class:"filter-label"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥:",-1)),c("div",Ma,[c("div",xa,[d[27]||(d[27]=c("label",null,"–°:",-1)),V(c("input",{type:"date","onUpdate:modelValue":d[6]||(d[6]=E=>x(a).customDateRange.startDate=E),onChange:te,max:x(a).customDateRange.endDate||X.value,class:"date-input"},null,40,Oa),[[Ue,x(a).customDateRange.startDate]])]),c("div",Fa,[d[28]||(d[28]=c("label",null,"–ü–æ:",-1)),V(c("input",{type:"date","onUpdate:modelValue":d[7]||(d[7]=E=>x(a).customDateRange.endDate=E),onChange:te,min:x(a).customDateRange.startDate||J.value,max:X.value,class:"date-input"},null,40,Na),[[Ue,x(a).customDateRange.endDate]])])]),b.value?(k(),A("small",Pa,W(b.value),1)):(k(),A("small",Wa," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):P("",!0)])],2),!y.value&&!$.value?(k(),A("div",ja,[c("div",Ua,[fe(Wt,{period:x(n),"show-current-state":v.value,onDataLoaded:Se,onError:ke},null,8,["period","show-current-state"])])])):P("",!0)])}}},Ka=_e(Va,[["__scopeId","data-v-a47eb6b6"]]);export{Ka as default};
