var ut=Object.defineProperty;var dt=(t,e,r)=>e in t?ut(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var O=(t,e,r)=>dt(t,typeof e!="symbol"?e+"":e,r);import{D as ft}from"./main-C9Hd2Rrq.js";const A={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367,KEEPER:1051},gt=[A.SECTOR_1C,A.SECTOR_HARDWARE,A.SECTOR_BITRIX24,A.SECTOR_PDM];function mt(t){return gt.includes(t)}const Z=140,x={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},ht={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},yt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"};function pt(){return[x.FORMED.bitrixId,x.REVIEW.bitrixId,x.EXECUTION.bitrixId]}const Et="https://bitrix24.kompo.by",Tt="servisdeskitotdel";function te(t){return`${Et}/page/${Tt}/servisdesk/type/${Z}/details/${t}/`}const p={TODAY:"today",YESTERDAY:"yesterday",THIS_WEEK:"this_week",LAST_WEEK:"last_week",MORE_THAN_TWO_WEEKS:"more_than_two_weeks",UP_TO_ONE_MONTH:"up_to_one_month",MORE_THAN_TWO_MONTHS:"more_than_two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},ee={[p.TODAY]:{label:"СЕГОДНЯ",color:"#28a745",backgroundColor:"#d4edda",textColor:"#155724"},[p.YESTERDAY]:{label:"ВЧЕРА",color:"#20c997",backgroundColor:"#d1f2eb",textColor:"#0c5460"},[p.THIS_WEEK]:{label:"НА ЭТОЙ НЕДЕЛЕ",color:"#17a2b8",backgroundColor:"#d1ecf1",textColor:"#0c5460"},[p.LAST_WEEK]:{label:"НА ПРОШЛОЙ НЕДЕЛЕ",color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},[p.MORE_THAN_TWO_WEEKS]:{label:"БОЛЕЕ ДВУХ НЕДЕЛЬ",color:"#fd7e14",backgroundColor:"#ffe5d0",textColor:"#7d3f00"},[p.UP_TO_ONE_MONTH]:{label:"ДО 1 МЕСЯЦА",color:"#dc3545",backgroundColor:"#f8d7da",textColor:"#721c24"},[p.MORE_THAN_TWO_MONTHS]:{label:"БОЛЕЕ 2 МЕСЯЦЕВ",color:"#6c757d",backgroundColor:"#e2e3e5",textColor:"#383d41"},[p.MORE_THAN_HALF_YEAR]:{label:"БОЛЕЕ ПОЛУГОДА",color:"#6c757d",backgroundColor:"#d6d8db",textColor:"#212529"},[p.MORE_THAN_YEAR]:{label:"БОЛЕЕ ГОДА",color:"#343a40",backgroundColor:"#c6c8ca",textColor:"#000000"}};function re(t){if(!t)return null;const e=String(t).trim();if(e.length===0)return null;try{const r=new Date(e);return isNaN(r.getTime())?(console.warn("Invalid date format:",t),null):r}catch(r){return console.error("Error parsing date:",t,r),null}}function P(t){if(!t)return"";let e;if(t instanceof Date?e=t:e=new Date(t),isNaN(e.getTime()))return"";const r=e.getDate(),o=e.getMonth()+1,n=e.getFullYear(),s=String(r).padStart(2,"0"),i=String(o).padStart(2,"0"),u=String(n);return`${s}.${i}.${u}`}function oe(t,e=new Date){if(!t)return"";const r=t instanceof Date?t:new Date(t),o=e instanceof Date?e:new Date(e);if(isNaN(r.getTime())||isNaN(o.getTime()))return P(r);const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),i=new Date(o.getFullYear(),o.getMonth(),o.getDate())-n,u=Math.floor(i/(1e3*60*60*24));return u===0?"Сегодня":P(r)}function ne(t,e=new Date){if(!t)return p.MORE_THAN_YEAR;const r=t instanceof Date?t:new Date(t),o=e instanceof Date?e:new Date(e);if(isNaN(r.getTime())||isNaN(o.getTime()))return p.MORE_THAN_YEAR;const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),s=new Date(o.getFullYear(),o.getMonth(),o.getDate()),i=s-n;if(i<0)return p.TODAY;const u=Math.floor(i/(1e3*60*60*24)),a=Math.floor(u/7),c=Math.floor(u/30),d=Math.floor(u/365);if(u===0)return p.TODAY;if(u===1)return p.YESTERDAY;const f=new Date(s),y=s.getDay(),l=y===0?6:y-1;if(f.setDate(s.getDate()-l),f.setHours(0,0,0,0),n>=f&&u<7)return p.THIS_WEEK;const g=new Date(f);return g.setDate(f.getDate()-7),n>=g&&n<f?p.LAST_WEEK:a>=2&&c<1?p.MORE_THAN_TWO_WEEKS:c>=1&&c<2?p.UP_TO_ONE_MONTH:c>=2&&c<6?p.MORE_THAN_TWO_MONTHS:c>=6&&d<1?p.MORE_THAN_HALF_YEAR:p.MORE_THAN_YEAR}const Y="dashboard-sector-1c-logger-level",N={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class _t{static getLevel(){if(typeof localStorage<"u"){const e=localStorage.getItem(Y);if(e&&N[e]!==void 0)return e}return"ERROR"}static setLevel(e){return N[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(Y,e),!0):!1}static isEnabled(e,r=null){const o=r||this.getLevel();if(o==="NONE")return!1;const n=N[e]||0,s=N[o]||0;return n<=s}static getLevels(){return{...N}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(Y)}}class m{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,r,o=""){const n=new Date().toISOString(),s=this.getLevelColor(e),i=`%c[${n}] %c[${e}] %c[${o||"Unknown"}] %c${r}`,u=["color: #6c757d; font-weight: normal",`color: ${s}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:i,styles:u}}static log(e,r,o="",n=null){if(!_t.isEnabled(e))return;const s=this.formatMessage(e,r,o),i=[s.formatted,...s.styles];switch(n!=null&&i.push(n),e){case"ERROR":console.error(...i);break;case"WARN":console.warn(...i);break;case"INFO":console.info(...i);break;case"DEBUG":console.log(...i);break;default:console.log(...i)}}static error(e,r="",o=null){this.log("ERROR",e,r,o)}static warn(e,r="",o=null){this.log("WARN",e,r,o)}static info(e,r="",o=null){this.log("INFO",e,r,o)}static debug(e,r="",o=null){this.log("DEBUG",e,r,o)}}class St{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,r,o,n=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const s=this.metrics.ticketsLoading.stages[e];s.loaded=o,s.batches.push({count:r,total:o,next:n}),s.total=o,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((i,u)=>i+u.total,0)}logFiltering(e,r,o=[],n=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=r,this.metrics.filtering.rejected=o.slice(0,50),this.metrics.filtering.tagValueExamples=n.slice(0,20)}logEmployees(e,r=[],o=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=r.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=o.slice(0,50)}logGrouping(e,r=[],o=[]){e.forEach(n=>{const s={};let i=0;n.employees.forEach(u=>{const a=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;s[u.id]=a,i+=a}),this.metrics.grouping.distributionByStages[n.id]={employees:s,total:i}}),this.metrics.grouping.ticketsNotInColumn=r.slice(0,50),this.metrics.grouping.unknownStages=o.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(r=>{this.metrics.zeroPoint.byStage[r]=Array.isArray(e[r])?e[r].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let v=null;function D(){return v||(v=new St),v}function I(t=null,e=null){if(e&&!ft(e))return!1;if(t&&t.query&&t.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const r=window.location.hash;if(r){const n=r.split("?");if(n.length>1){const s=n[1];if(new URLSearchParams(s).get("diagnostics")==="true")return!0}if(r.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class It{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,r={}){try{const o=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:r})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();if(n.error)throw new Error(n.error_description||n.error);return n}catch(o){throw console.error("Bitrix24 API error:",o),o}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},r=["ID","NAME","EMAIL","PHONE"],o={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:r,order:o})).result||[]}}class R{static async call(e,r={}){return await It.call(e,r)}}class h{static get(e){const r=this.cache.get(e);return r?Date.now()-r.timestamp>r.ttl?(this.cache.delete(e),null):r.data:null}static set(e,r,o=this.DEFAULT_TTL){this.cache.set(e,{data:r,timestamp:Date.now(),ttl:o})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const r=[];for(const o of this.cache.keys())o.startsWith(e)&&r.push(o);r.forEach(o=>this.cache.delete(o))}static cleanExpired(){const e=Date.now(),r=[];for(const[o,n]of this.cache.entries())e-n.timestamp>n.ttl&&r.push(o);r.forEach(o=>this.cache.delete(o))}static getStats(){const e=Date.now();let r=0,o=0;for(const n of this.cache.values())e-n.timestamp>n.ttl?r++:o++;return{total:this.cache.size,valid:o,expired:r}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((o,n)=>o-n).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}O(h,"cache",new Map),O(h,"DEFAULT_TTL",5*60*1e3),O(h,"EMPLOYEES_TTL",30*60*1e3),O(h,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{h.cleanExpired()},5*60*1e3);function T(t,e,r={}){if(!t||typeof t!="string")throw new Error("Step must be a non-empty string");const o=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let n=r.description;return n||(n=Ct(t,r)),{step:t,progress:o,details:{...r,description:n}}}function Ct(t,e){return t==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`Загрузка тикетов стадии "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:t==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`Фильтрация тикетов: ${e.filteredTickets} из ${e.totalTickets}...`:t==="grouping"&&e.employeeCount!==void 0?`Группировка тикетов по ${e.employeeCount} сотрудникам...`:e.count!==void 0&&e.total!==void 0?`Обработка: ${e.count} из ${e.total}...`:"Загрузка данных..."}function H(t){if(!t||typeof t!="object")throw new Error("Progress info must be an object");const e=t.step||null;if(!e)throw new Error("Step is required in progress info");const r=t.progress!==void 0&&t.progress!==null?t.progress:t.percent!==void 0&&t.percent!==null?t.percent:void 0,o=t.details||{};return t.stage&&(o.stage=t.stage),t.stageName&&(o.stageName=t.stageName),t.stageIndex!==void 0&&(o.stageIndex=t.stageIndex),t.totalStages!==void 0&&(o.totalStages=t.totalStages),t.count!==void 0&&(o.count=t.count),t.total!==void 0&&(o.total=t.total),t.warning&&(o.warning=t.warning),{step:e,progress:r!=null?Math.max(0,Math.min(100,r)):void 0,details:o}}function J(t,e,r){const o=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,n=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,s=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,i=o+n*s/100;return Math.max(0,Math.min(100,i))}const L=140;class b{static async getAllTickets(e,r=null,o=!0){const n=[],s=e.length;try{for(let i=0;i<e.length;i++){const u=e[i],a=this.getStageName(u);if(r){const c=i/s*100;r(T("loading_tickets",c,{stage:u,stageName:a,stageIndex:i+1,totalStages:s}))}try{const c=await this.getTicketsByStage(u,o,r?d=>{const f=J(i/s*100,1/s*100,d.percent||0);r(T("loading_tickets",f,{stage:u,stageName:a,stageIndex:i+1,totalStages:s,count:d.count,total:d.total}))}:null);n.push(...c)}catch(c){m.error(`Error loading tickets for stage ${u}`,"TicketRepository",c);let d=`Ошибка загрузки стадии "${a}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?d=`Ошибка соединения при загрузке стадии "${a}". Проверьте подключение к интернету.`:c.message.includes("timeout")?d=`Превышено время ожидания при загрузке стадии "${a}". Попробуйте позже.`:c.message.includes("403")||c.message.includes("401")?d=`Ошибка доступа при загрузке стадии "${a}". Проверьте права доступа.`:d=`Ошибка загрузки стадии "${a}": ${c.message}`),new Error(d)}}}catch(i){throw m.error("Error in getAllTickets","TicketRepository",i),i}return n}static getStageName(e){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[e]||e}static async getTicketsByStage(e,r=!0,o=null){var d,f,y;if(r){const l=h.getTicketsCacheKey(e),g=h.get(l);if(g!==null){try{const E=D();E&&I()&&E.logTicketsLoading(e,g.length,g.length,null)}catch(E){m.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",E)}return o&&o(H({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}}const n=[];let s=0;const i=50;let u=!0,a=0,c=null;for(;u;)try{const l=await R.call("crm.item.list",{entityTypeId:L,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:s,useOriginalUfNames:"Y"});let g=[];if(l&&l.result&&(Array.isArray(l.result)?g=l.result:l.result.items&&Array.isArray(l.result.items)?g=l.result.items:l.result.data&&Array.isArray(l.result.data)&&(g=l.result.data)),g.length>0){n.push(...g),s+=g.length;const E=((d=l==null?void 0:l.result)==null?void 0:d.next)??(l==null?void 0:l.next),w=E!=null&&E!==""&&String(E)!=="0";u=g.length===i&&w,I()&&m.debug(`[Pagination] Stage: ${e}, Batch: ${g.length}, Total: ${n.length}, Start: ${s}, NextValue: ${E}, HasNext: ${w}, HasMore: ${u}`,"TicketRepository");try{const _=D();_&&I()&&(m.debug(`[Pagination Debug] Stage: ${e}, Batch: ${g.length}, Total: ${n.length}`,"TicketRepository",{resultStructure:{hasResult:!!(l!=null&&l.result),resultIsArray:Array.isArray(l==null?void 0:l.result),hasItems:!!((f=l==null?void 0:l.result)!=null&&f.items),hasData:!!((y=l==null?void 0:l.result)!=null&&y.data),hasNext:!!E,nextValue:E,nextType:typeof E,resultKeys:l!=null&&l.result?Object.keys(l.result):[]}}),_.logTicketsLoading(e,g.length,n.length,E||null))}catch(_){m.warn("Diagnostics logging error","TicketRepository",_)}if(u?a=s+i:a=n.length,o){const _=a>0?Math.min(100,n.length/a*100):0;o(H({step:"loading_tickets",percent:_,count:n.length,total:a}))}c=null}else u=!1}catch(l){if(m.error(`Error loading tickets batch for stage ${e} (start: ${s})`,"TicketRepository",l),s===0)throw c=l,new Error(`Не удалось загрузить тикеты для стадии ${e}: ${l.message||l}`);u=!1,o&&n.length>0&&o(T("loading_tickets",100,{count:n.length,total:n.length,warning:`Загружено частично: ${n.length} тикетов. Ошибка при загрузке остальных.`}))}if(c&&n.length===0)throw c;if(r){const l=h.getTicketsCacheKey(e);h.set(l,n,h.TICKETS_TTL)}return n}static async getTicket(e){return(await R.call("crm.item.get",{entityTypeId:L,id:e})).result||null}static async updateTicket(e,r){const n=(await R.call("crm.item.update",{entityTypeId:L,id:e,fields:r})).result===!0;return n&&h.invalidateTicketsCache(),n}static async createTicket(e){const r=await R.call("crm.item.add",{entityTypeId:L,fields:e}),o=r.result?parseInt(r.result):0;return o>0&&h.invalidateTicketsCache(),o}static async assignTicket(e,r,o){return await this.updateTicket(e,{assignedById:r,stageId:o})}}class At{static async getEmployeesByIds(e,r=!0){if(!Array.isArray(e)||e.length===0)return[];if(r){const o=h.getEmployeesCacheKey(e),n=h.get(o);if(n!==null)return m.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),n}try{const o=await R.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let n=[];if(o&&o.result&&(Array.isArray(o.result)?n=o.result:m.warn("Unexpected user.get result format","EmployeeRepository",o)),r){const s=h.getEmployeesCacheKey(e);h.set(s,n,h.EMPLOYEES_TTL)}return n}catch(o){return m.error("Error getting employees by IDs","EmployeeRepository",o),[]}}}function W(t){return ht[t]||"formed"}function z(t){return yt[t]||"DT140_12:UC_0VHWE2"}function Dt(){return pt()}function Q(t){return t==null?null:String(t).trim().toLowerCase()||null}const tt=[{id:"general",label:"Генеральский",bitrixValue:"Генеральский",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"Высший приоритет (генеральский уровень)"},{id:"external",label:"Внешние обстоятельства",bitrixValue:"Внешние обстоятельства",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"Внешние обстоятельства/блокеры"},{id:"board",label:"Задачи правления и совета директоров",bitrixValue:"Задачи правления и совета директоров",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"Задачи правления / совета директоров"},{id:"errors",label:"Ошибки/сбои",bitrixValue:"Ошибки/сбои",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"Инциденты, ошибки и сбои"},{id:"operations",label:"Текущая деятельность",bitrixValue:"Текущая деятельность",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"Операционная деятельность"},{id:"projects",label:"Проекты",bitrixValue:"Проекты",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"Проектные задачи"},{id:"optimization",label:"Оптимизация",bitrixValue:"Оптимизация",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"Оптимизация и улучшения"}],C={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых/неизвестных значений"};C.id;const et={},rt={};[...tt,C].forEach(t=>{et[t.id]=t;const e=Q(t.bitrixValue);e&&(rt[e]=t)});function Rt(t){if(!t)return C;const e=String(t).trim();return et[e]||C}function K(t){const e=Q(t);if(!e)return C;const r=rt[e];return r||C}function wt(){return[...tt,C].sort((t,e)=>t.order-e.order)}function ot(t){if(t&&typeof t=="object"&&t.color)return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor};const e=Rt(t)||K(t)||C;return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor}}wt();function nt(t){return t==null?null:String(t).trim().toLowerCase()||null}const it=[{id:"1c-accounting",label:"1С.Бухгалтерия",bitrixValue:"1С.Бухгалтерия",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"Бухгалтерский контур 1С"},{id:"1c-tickets",label:"1С.Талоны",bitrixValue:"1С.Талоны",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"Работа с талонами 1С"},{id:"1c-zup",label:"1С.ЗУП",bitrixValue:"1С.ЗУП",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"Зарплата и управление персоналом"},{id:"1c-docflow",label:"1С.Документооборот",bitrixValue:"1С.Документооборот",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"Документооборот 1С"},{id:"1c-integrations",label:"1С.Интеграции",bitrixValue:"1С.Интеграции",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"Интеграции и сопряжения 1С"}],S={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых или неидентифицированных значений"},Ot={},st={};[...it,S].forEach(t=>{Ot[t.id]=t;const e=nt(t.bitrixValue);e&&(st[e]=t)});function Nt(t){const e=nt(t);if(!e)return S;const r=st[e];return r||S}function bt(){return S}function Mt(){return[...it,S].sort((t,e)=>t.order-e.order)}function kt(t){const e=t&&typeof t=="object"?t:S;return{color:e.color||S.color,backgroundColor:e.backgroundColor||S.backgroundColor,textColor:e.textColor||S.textColor}}Mt();function j(t){const e=parseInt(t.id||t.ID||0),r=t.title||t.TITLE||"Без названия",o=t.stageId||t.STAGE_ID||"",n=t.assignedById||t.ASSIGNED_BY_ID||null,s=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",i=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"",u=t.UF_SUBJECT||t.uf_subject||t.ufSubject||t.UF_SUBJECT||t.uf_subject||null,a=t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||t.ufCrm7DepartmentHead||t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||null;let c=null;if(a){const B=String(a).trim();B.length>0&&(c=B.length>17?B.substring(0,17):B)}const d=t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.ufCrm7UfPriority||t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.priority||t.PRIORITY||null,f=K(d),y=ot(f),l=t.UF_SLA_SERVICE_STR||t.uf_sla_service_str||t.UfSlaServiceStr||t.ufSlaServiceStr||t.service||null,g=Nt(l),E=kt(g),w=t.UF_ACTION_STR||t.uf_action_str||t.UfActionStr||t.ufActionStr||t.UF_ACTION_STR||t.uf_action_str||null,_=w?String(w).trim():null,lt=_&&_.length>0?_:null;return{id:e,title:r,ufSubject:u,departmentHead:c,priorityId:f.id,priorityLabel:f.label,priorityColors:y,priority:f.id,priorityBitrixValue:f.bitrixValue||null,service:g,serviceLabel:g.label,serviceColors:E,serviceBitrixValue:g.bitrixValue||bt().bitrixValue,actionStr:lt,status:Bt(),assigneeId:n?parseInt(n):null,stageId:W(o),createdAt:s,modifiedAt:i,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function Bt(t){return"in_progress"}const M=new Map;function Lt(){M.clear()}function Ft(t){if(!t)return[];if(Array.isArray(t))return t.filter(r=>typeof r=="number"||!isNaN(parseInt(r))).map(r=>typeof r=="number"?r:parseInt(r));if(typeof t=="number")return[t];const e=parseInt(t);return isNaN(e)?[]:[e]}function $t(t,e=!0){const r=t.id||t.ID;if(!t||!r)return null;if(e&&M.has(r))return M.get(r);const o=t.UF_DEPARTMENT||t.departmentId,n=Ft(o);for(const s of n)if(mt(s)){const u=s;return e&&M.set(r,u),u}return e&&M.set(r,null),null}function Ut(t){const e=$t(t);return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"Неизвестный",position:t.WORK_POSITION||t.workPosition||"Сотрудник",email:t.EMAIL||t.email||"",sectorId:e,departmentId:t.UF_DEPARTMENT||null,tickets:[]}}function xt(t){return Array.isArray(t)?t.map(e=>Ut(e)):[]}const Pt="1C",Yt=["1С"],k=new Map,q=100;function at(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function V(t){return t==null?null:String(t).trim().toUpperCase().replace(/С/g,"C")||null}function ct(t){if(!t)return[];if(Array.isArray(t))return t.map(V).filter(Boolean);if(typeof t=="object"&&t.value!==void 0){const r=V(t.value);return r?[r]:[]}const e=V(t);return e?e.split(/[;,]/).map(r=>r.trim()).filter(Boolean):[]}function X(t){const e=at(t),r=ct(e);return r.length===0?!1:r.some(o=>o===Pt||Yt.includes(o))}function vt(t){return`filter:${t.map(r=>r.id||r.ID||"").sort().join(",")}`}function Vt(){k.size>q&&Array.from(k.keys()).slice(0,Math.floor(q*.2)).forEach(e=>k.delete(e))}function Ht(t){if(!Array.isArray(t))return[];const e=vt(t),r=k.get(e);if(r!==void 0)return r;const o=t.filter(X);try{const n=D();if(n&&I()){const s=t.filter(a=>!X(a)),i=[],u=new Set;t.forEach(a=>{const c=at(a),d=ct(c),f=c==null?"":String(c);c!=null&&!u.has(f)&&(u.add(f),i.push({value:c,normalized:d,type:typeof c,isArray:Array.isArray(c),ticketId:a.id||a.ID}))}),n.logFiltering(t.length,o.length,s,i)}}catch(n){console.warn("Diagnostics logging error in filterBySector:",n)}return k.set(e,o),Vt(),o}const $=1051;function U(t){if(!t||typeof t!="object")return null;let e=t.assignedById||t.ASSIGNED_BY_ID||t.assignedByIdId||t.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function G(t){if(t==null)return null;typeof t=="object"&&(t=t.id||t.ID||t.value||null);const e=typeof t=="number"?t:parseInt(t);return isNaN(e)||e<=0?null:e}function Wt(t,e=$){const r=U(t),o=G(r);return o===null||o===e}function Kt(t,e){Array.isArray(t)||(m.warn("Tickets is not an array","TicketGrouper",t),t=[]),Array.isArray(e)||(m.warn("Employees is not an array","TicketGrouper",e),e=[]);const r=e.filter(a=>(a.id?parseInt(a.id):null)!==$),o=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===A.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===A.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:r.map(a=>({...a,isFromSector1C:a.sectorId===A.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],n=new Map(o.map(a=>[a.id,a])),s=new Map;o.forEach(a=>{const c=new Map(a.employees.map(d=>[d.id,d]));s.set(a.id,c)});const i=[],u=[];t.forEach(a=>{const c=W(a.stageId||a.STAGE_ID||""),d=n.get(c);if(!d){u.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID,assignedById:U(a)});return}const f=U(a),y=G(f);if(y!==$)if(y){const l=s.get(c);let g=l.get(y);g||(g={id:y,name:`Сотрудник #${y}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},d.employees.push(g),l.set(y,g));const E=j(a);g.tickets.push(E),g.isFromSector1C?g.ticketsInsideSector.push(E):g.ticketsOutsideSector.push(E)}else i.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:c,assignedById:f})}),o.forEach(a=>{a.employees.sort((c,d)=>c.isFromSector1C&&!d.isFromSector1C?-1:!c.isFromSector1C&&d.isFromSector1C?1:(c.id||0)-(d.id||0))});try{const a=D();if(a&&I()){const c={};o.forEach(f=>{let y=0,l=0;f.employees.forEach(g=>{y+=(g.ticketsInsideSector||[]).length,l+=(g.ticketsOutsideSector||[]).length}),c[f.id]={insideSector:y,outsideSector:l,total:y+l}});const d=a.metrics.grouping;Object.keys(c).forEach(f=>{d.distributionByStages[f]||(d.distributionByStages[f]={employees:{},total:0}),d.distributionByStages[f].insideSector=c[f].insideSector,d.distributionByStages[f].outsideSector=c[f].outsideSector,d.distributionByStages[f].total=c[f].total}),a.logGrouping(o,i,u)}}catch(a){m.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",a)}return o}function jt(t){const e={formed:[],review:[],execution:[]};if(!Array.isArray(t))return m.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",t),e;t.filter(r=>Wt(r)).forEach(r=>{const o=W(r.stageId||r.STAGE_ID||"");e[o]&&e[o].push(j(r))});try{const r=D();r&&I()&&r.logZeroPoint(e)}catch(r){m.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",r)}return e}function Gt(t){if(!Array.isArray(t))return[];const e=new Set,r=[],o=[];t.forEach(s=>{const i=U(s),u=G(i);!i||i===null||i===void 0?r.push({id:s.id||s.ID,title:s.title||s.TITLE||"Без названия",stageId:s.stageId||s.STAGE_ID}):u===$&&o.push({id:s.id||s.ID,title:s.title||s.TITLE||"Без названия",stageId:s.stageId||s.STAGE_ID}),u&&e.add(u)});const n=Array.from(e);try{const s=D();s&&I()&&s.logEmployees(n,r,o)}catch(s){m.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",s)}return n}const F=new Map,zt=10*60*1e3;function qt(t){if(!t||typeof t!="object")return{};const e={},r=Object.keys(t);for(const o of r)o.toUpperCase().startsWith("UF_")&&(e[o]=t[o]);return e}function Xt(t,e=null,r=!0){if(r&&e&&F.has(e)){const s=F.get(e),i=Date.now();if(s.timestamp&&i-s.timestamp<zt)return s.data;F.delete(e)}const o=qt(t),n={typeProduct:o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||o.ufCrm7TypeProduct||null,all:o};return r&&e&&F.set(e,{data:n,timestamp:Date.now()}),n}class Zt{static async getTicketDetails(e,r={}){const{select:o=["*"],useOriginalUfNames:n=!0,useCache:s=!0}=r;try{const i=await b.getTicket(e);if(!i)throw new Error(`Тикет с ID ${e} не найден`);const u=Xt(i,e,s),a=i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.ufCrm7UfPriority||i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.priority||i.PRIORITY||null,c=K(a),d=ot(c);return{id:i.id||i.ID,title:i.title||i.TITLE,stageId:i.stageId||i.STAGE_ID,assignedById:i.assignedById||i.ASSIGNED_BY_ID,createdAt:i.createdTime||i.CREATED_TIME||i.CREATED_DATE,updatedAt:i.updatedTime||i.UPDATED_TIME||i.MODIFY_DATE,priorityId:c.id,priorityLabel:c.label,priorityColors:d,priority:c.id,priorityBitrixValue:c.bitrixValue||null,opportunity:i.opportunity||i.OPPORTUNITY,currencyId:i.currencyId||i.CURRENCY_ID,comments:i.comments||i.COMMENTS,additionalFields:u,rawData:i}}catch(i){throw m.error("Error getting ticket details","TicketDetailsService",i),i}}}class ie{static async getSectorData(e=!0,r=null){try{if(I()){const o=D();o&&o.reset()}}catch(o){m.warn("Error resetting diagnostics","DashboardSector1CService",o)}if(r&&r(T("cache_check",0,{description:"Инициализация загрузки..."})),e){const o=h.getSectorDataCacheKey(),n=h.get(o);if(n!==null)return r&&r(T("cache_hit",100,{description:"Данные загружены из кеша"})),n}try{r&&r(T("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const o=Dt(),n=await b.getAllTickets(o,f=>{if(r){const y=H(f),l=J(10,40,y.progress||0);r(T(y.step||"loading_tickets",l,{...y.details,warning:y.details.warning}))}},e);r&&r(T("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const s=Ht(n);r&&r(T("filtering",50,{totalTickets:n.length,filteredTickets:s.length,description:`Отфильтровано ${s.length} тикетов из ${n.length}`})),r&&r(T("extracting_employees",60,{filteredTickets:s.length,description:`Анализ ${s.length} тикетов для определения сотрудников...`}));const i=Gt(s);r&&r(T("extracting_employees",60,{employeeCount:i.length,description:`Найдено ${i.length} уникальных сотрудников`})),r&&r(T("loading_employees",65,{employeeCount:i.length,description:`Загрузка данных ${i.length} сотрудников...`})),Lt();const u=await At.getEmployeesByIds(i),a=xt(u);r&&r(T("loading_employees",90,{employeeCount:a.length,description:`Загружено данных ${a.length} сотрудников`})),r&&r(T("grouping",90,{filteredTickets:s.length,employeeCount:a.length,description:`Группировка ${s.length} тикетов по этапам и ${a.length} сотрудникам...`}));const d={stages:Kt(s,a),employees:a,zeroPointTickets:jt(s)};if(r&&r(T("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),e){const f=h.getSectorDataCacheKey();h.set(f,d,h.TICKETS_TTL)}return r&&r(T("complete",100,{description:"Загрузка завершена"})),d}catch(o){throw m.error("Error getting sector data","DashboardSector1CService",o),r&&r({step:"error",progress:0,error:o.message}),o}}static async assignTicket(e,r,o){try{const n=z(o),s=await b.assignTicket(e,r,n);return s&&h.invalidateTicketsCache(),s}catch(n){throw m.error("Error assigning ticket","DashboardSector1CService",n),n}}static async createTicket(e){try{const r=z(e.stageId||"formed"),o={title:e.title,stageId:r};e.employeeId&&(o.assignedById=e.employeeId);const n=await b.createTicket(o);return n>0&&h.invalidateTicketsCache(),n}catch(r){throw m.error("Error creating ticket","DashboardSector1CService",r),r}}static async getTicket(e){try{const r=await b.getTicket(e);return j(r)}catch(r){throw m.error("Error getting ticket","DashboardSector1CService",r),r}}static async getTicketDetails(e,r={}){try{return await Zt.getTicketDetails(e,r)}catch(o){throw m.error("Error getting ticket details","DashboardSector1CService",o),o}}static async addComment(e,r){try{return(await R.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+Z,comment:r}})).result!==void 0}catch(o){throw m.error("Error adding comment","DashboardSector1CService",o),o}}}export{It as B,h as C,ee as D,$ as K,m as L,x as S,b as T,ne as a,_t as b,D as c,ie as d,Lt as e,oe as f,te as g,yt as h,I as i,W as j,p as k,A as l,j as m,H as n,re as p};
