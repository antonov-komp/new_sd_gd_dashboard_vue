import{a as C,d as n,b as V,t as L,o as y,C as he,B as Ft,L as Pt,P as Bt,D as Rt,E as Ht,G as Ot,H as Wt,I as Ut,J as jt,K as zt,r as M,c as te,M as Le,l as Ee,N as Xe,j as re,i as Q,k as ye,m as Je,h as ae,O as Vt,n as ve,F as oe,f as ue,x as ze,Q as st,u as _e,g as De,R as Ge,T as it,S as vt,U as tt,q as Yt,V as Kt,W as ct,X as Gt,Y as Xt,Z as Ue,y as qt,e as Jt}from"./chunk-IDUYkvJI.js";import{T as nt,S as Ae,a as ht}from"./chunk-BLNkvvQZ.js";import{e as et,f as Zt}from"./chunk-zzKzT0er.js";import{_ as ke,g as Qt,S as ea,a as ta,b as ut,D as ge,c as dt,d as yt,T as pt,e as aa,A as kt}from"./chunk-CCQQUMtL.js";import{_ as Me}from"./chunk-CEPkt3e7.js";import{a as sa}from"./chunk-DLgBCjTL.js";import{B as na}from"./chunk-C7JhVT7I.js";const oa={name:"LoadingSpinner",props:{message:{type:String,default:"–ó–∞–≥—Ä—É–∑–∫–∞..."}}},la={class:"loading-spinner"},ra={key:0,class:"message"};function ia(e,t,s,a,u,r){return y(),C("div",la,[t[0]||(t[0]=n("div",{class:"spinner"},null,-1)),s.message?(y(),C("p",ra,L(s.message),1)):V("",!0)])}const bt=ke(oa,[["render",ia],["__scopeId","data-v-375eac16"]]);function kr(e,t=300){let s;return function(...u){const r=()=>{clearTimeout(s),e(...u)};clearTimeout(s),s=setTimeout(r,t)}}he.register(Ft,Pt,Bt,Rt,Ht,Ot,Wt,Ut,jt,zt);he.defaults.responsive=!0;he.defaults.maintainAspectRatio=!1;he.defaults.plugins.legend.display=!0;he.defaults.plugins.legend.position="top";const br={primary:"#007bff",success:"#28a745",danger:"#dc3545",warning:"#ffc107",info:"#17a2b8",carryover:"#ff9800",successLight:"#6cbf47",carryoverLight:"#ffb74d",carryoverDark:"#f57c00"};function je(e){return ta[e]||"formed"}function Cr(e){return ea[e]||"DT140_12:UC_0VHWE2"}function wr(){return Qt()}function Ct(e){return e==null?null:String(e).trim().toLowerCase()||null}const wt=[{id:"general",label:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",bitrixValue:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"–í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≥–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)"},{id:"external",label:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",bitrixValue:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞/–±–ª–æ–∫–µ—Ä—ã"},{id:"board",label:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",bitrixValue:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è / —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤"},{id:"errors",label:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",bitrixValue:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã, –æ—à–∏–±–∫–∏ –∏ —Å–±–æ–∏"},{id:"operations",label:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",bitrixValue:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"},{id:"projects",label:"–ü—Ä–æ–µ–∫—Ç—ã",bitrixValue:"–ü—Ä–æ–µ–∫—Ç—ã",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"–ü—Ä–æ–µ–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏"},{id:"optimization",label:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",bitrixValue:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è"}],Te={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö/–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"},Sr=Te.id,St={},_t={};[...wt,Te].forEach(e=>{St[e.id]=e;const t=Ct(e.bitrixValue);t&&(_t[t]=e)});function ca(e){if(!e)return Te;const t=String(e).trim();return St[t]||Te}function ua(e){const t=Ct(e);if(!t)return Te;const s=_t[t];return s||Te}function da(){return[...wt,Te].sort((e,t)=>e.order-t.order)}function pa(e){if(e&&typeof e=="object"&&e.color)return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor};const t=ca(e)||ua(e)||Te;return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor}}da();function Dt(e){return e==null?null:String(e).trim().toLowerCase()||null}const Et=[{id:"1c-accounting",label:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",bitrixValue:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä 1–°"},{id:"1c-tickets",label:"1–°.–¢–∞–ª–æ–Ω—ã",bitrixValue:"1–°.–¢–∞–ª–æ–Ω—ã",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"–†–∞–±–æ—Ç–∞ —Å —Ç–∞–ª–æ–Ω–∞–º–∏ 1–°"},{id:"1c-zup",label:"1–°.–ó–£–ü",bitrixValue:"1–°.–ó–£–ü",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"–ó–∞—Ä–ø–ª–∞—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º"},{id:"1c-docflow",label:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",bitrixValue:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç 1–°"},{id:"1c-integrations",label:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",bitrixValue:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è 1–°"}],Ce={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö –∏–ª–∏ –Ω–µ–∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"},ma={},Tt={};[...Et,Ce].forEach(e=>{ma[e.id]=e;const t=Dt(e.bitrixValue);t&&(Tt[t]=e)});function _r(e){const t=Dt(e);if(!t)return Ce;const s=Tt[t];return s||Ce}function ga(){return Ce}function fa(){return[...Et,Ce].sort((e,t)=>e.order-t.order)}function va(e){const t=e&&typeof e=="object"?e:Ce;return{color:t.color||Ce.color,backgroundColor:t.backgroundColor||Ce.backgroundColor,textColor:t.textColor||Ce.textColor}}fa();const ha=20,ya=5*60*1e3;async function ka({search:e="",limit:t=ha,sectorDepartmentId:s=ut.SECTOR_1C}={}){const a=`sector1c_employees_${e}_${t}_${s||"all"}`,u=sessionStorage.getItem(a);if(u)try{const{data:r,timestamp:l}=JSON.parse(u);if(Date.now()-l<ya)return r}catch(r){console.warn("[sector1cEmployees] Cache parse error:",r)}try{const r={ACTIVE:"Y"};s?Array.isArray(s)?r.UF_DEPARTMENT=s:r.UF_DEPARTMENT=[s]:r.UF_DEPARTMENT=[ut.SECTOR_1C],e&&e.length>=2&&(r["%NAME"]=e,r["%LAST_NAME"]=e,r["%WORK_POSITION"]=e);const i=((await na.call("user.get",{filter:r,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(o=>({id:parseInt(o.ID),name:ba(o),position:o.WORK_POSITION||"",department:o.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:i,timestamp:Date.now()}))}catch(o){console.warn("[sector1cEmployees] Cache write error:",o)}return i}catch(r){throw console.error("[sector1cEmployees] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",r),new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${r.message}`)}}function ba(e){const t=[e.LAST_NAME,e.NAME,e.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):e.NAME||"–ë–µ–∑ –∏–º–µ–Ω–∏"}const Ca={class:"employee-select-field-text"},wa={key:0,class:"employee-select-dropdown"},Sa={class:"employee-select-dropdown-search"},_a={key:0,class:"employee-select-state"},Da={key:1,class:"employee-select-state employee-select-state--error"},Ea={key:2,class:"employee-select-state"},Ta=["checked"],Ia=["checked","onChange"],$a={class:"employee-select-item-content"},Na={class:"employee-select-item-name"},Ma={key:0,class:"employee-select-item-position"},xa={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(e,{emit:t}){const s=e,a=t,u=M(null),r=M(null),l=M(""),d=M([]),i=M(!1),o=M(null),w=M(!1),_=te(()=>{if(!l.value)return d.value;const I=l.value.toLowerCase();return d.value.filter(T=>T.name.toLowerCase().includes(I)||T.position&&T.position.toLowerCase().includes(I))}),p=te(()=>{if(s.selected.includes("all")||s.selected.length===0)return s.placeholder;if(s.selected.length===1){const I=d.value.find(T=>T.id===s.selected[0]);return I?I.name:s.placeholder}return`–í—ã–±—Ä–∞–Ω–æ: ${s.selected.length} ${K(s.selected.length,"—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")}`});async function v(I=""){i.value=!0,o.value=null;try{d.value=await ka({search:I})}catch(T){o.value=T,a("error",T)}finally{i.value=!1}}function b(){a("search",l.value)}function $(){i.value||(w.value=!w.value,w.value?(d.value.length===0&&v(),st(()=>{r.value&&r.value.focus()})):l.value="")}function E(I){u.value&&!u.value.contains(I.target)&&(w.value=!1,l.value="")}function S(I){const T=[...s.selected],H=T.indexOf(I);if(I==="all")if(H>-1)T.splice(H,1);else return a("update:selected",["all"]);else if(H>-1)T.splice(H,1);else{const O=T.indexOf("all");O>-1&&T.splice(O,1),T.push(I)}a("update:selected",T)}function F(I){return I==="all"?s.selected.includes("all"):s.selected.includes(I)||s.selected.includes("all")}const U=te(()=>l.value?`–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${l.value}"`:"–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°");function K(I,T,H,O){const G=I%10,J=I%100;return J>=11&&J<=19?O:G===1?T:G>=2&&G<=4?H:O}function P(){v(l.value)}return Le(()=>s.selected,I=>{(!I||I.length===0)&&a("update:selected",["all"])},{immediate:!0}),Ee(()=>{document.addEventListener("click",E),(!s.selected||s.selected.length===0)&&a("update:selected",["all"])}),Xe(()=>{document.removeEventListener("click",E)}),(I,T)=>(y(),C("div",{class:"employee-select",ref_key:"selectContainer",ref:u},[n("div",{class:Q(["employee-select-field",{"employee-select-field--open":w.value,"employee-select-field--disabled":i.value}]),onClick:$},[n("span",Ca,L(p.value),1),n("span",{class:Q(["employee-select-field-icon",{open:w.value}])},"‚ñº",2)],2),re(ze,{name:"dropdown-fade"},{default:ye(()=>[w.value?(y(),C("div",wa,[n("div",Sa,[Je(n("input",{"onUpdate:modelValue":T[0]||(T[0]=H=>l.value=H),type:"text",placeholder:"üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...",class:"employee-select-search-input",onInput:b,onClick:T[1]||(T[1]=ae(()=>{},["stop"])),ref_key:"searchInput",ref:r},null,544),[[Vt,l.value]])]),i.value?(y(),C("div",_a,[...T[6]||(T[6]=[n("span",{class:"spinner"},"‚è≥",-1),n("span",null,"–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°...",-1)])])):o.value?(y(),C("div",Da,[n("span",null,"‚ùå "+L(o.value.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"),1),n("button",{onClick:[P,T[2]||(T[2]=ae(()=>{},["stop"]))],class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å")])):!i.value&&_.value.length===0&&!o.value?(y(),C("div",Ea,[n("span",null,"üì≠ "+L(U.value),1)])):(y(),C("div",{key:3,class:"employee-select-list",style:ve({maxHeight:`${e.maxHeight}px`})},[n("label",{class:Q(["employee-select-item",{"employee-select-item--selected":F("all")}]),onClick:T[4]||(T[4]=ae(()=>{},["stop"]))},[n("input",{type:"checkbox",checked:F("all"),onChange:T[3]||(T[3]=H=>S("all"))},null,40,Ta),T[7]||(T[7]=n("div",{class:"employee-select-item-content"},[n("span",{class:"employee-select-item-name"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏")],-1))],2),(y(!0),C(oe,null,ue(_.value,H=>(y(),C("label",{key:H.id,class:Q(["employee-select-item",{"employee-select-item--selected":F(H.id)}]),onClick:T[5]||(T[5]=ae(()=>{},["stop"]))},[n("input",{type:"checkbox",checked:F(H.id),onChange:O=>S(H.id)},null,40,Ia),n("div",$a,[n("span",Na,L(H.name),1),H.position?(y(),C("span",Ma,L(H.position),1)):V("",!0)])],2))),128))],4))])):V("",!0)]),_:1})],512))}},Aa=ke(xa,[["__scopeId","data-v-6b8c949b"]]),La={class:"stage-select-field-text"},Fa={key:0,class:"stage-select-dropdown"},Pa={class:"stage-select-list"},Ba=["checked"],Ra=["checked","onChange"],Ha={class:"stage-select-item-content"},Oa={class:"stage-select-item-name"},Wa={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745"}]},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã"}},emits:["update:selected","change"],setup(e,{emit:t}){const s=e,a=t,u=M(null),r=M(!1),l=te(()=>Object.values(s.selected).every(p=>p===!0)),d=te(()=>{if(l.value)return s.placeholder;const p=s.stages.filter(v=>s.selected[v.id]);return p.length===0?"–≠—Ç–∞–ø—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã":p.length===1?p[0].name:`–í—ã–±—Ä–∞–Ω–æ: ${p.length} —ç—Ç–∞–ø–∞(–æ–≤)`});function i(){r.value=!r.value,r.value}function o(p){u.value&&!u.value.contains(p.target)&&(r.value=!1)}function w(p,v){const b={...s.selected};b[p]=v,a("update:selected",b),a("change",p,v)}function _(){const p=l.value,v={};s.stages.forEach(b=>{v[b.id]=!p}),a("update:selected",v),a("change","all",!p)}return Ee(()=>{document.addEventListener("click",o)}),Xe(()=>{document.removeEventListener("click",o)}),(p,v)=>(y(),C("div",{class:"stage-select",ref_key:"selectContainer",ref:u},[n("div",{class:Q(["stage-select-field",{"stage-select-field--open":r.value,"stage-select-field--disabled":!1}]),onClick:i},[n("span",La,L(d.value),1),n("span",{class:Q(["stage-select-field-icon",{open:r.value}])},"‚ñº",2)],2),re(ze,{name:"dropdown-fade"},{default:ye(()=>[r.value?(y(),C("div",Fa,[n("div",Pa,[n("label",{class:Q(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:v[0]||(v[0]=ae(()=>{},["stop"]))},[n("input",{type:"checkbox",checked:l.value,onChange:_},null,40,Ba),v[2]||(v[2]=n("div",{class:"stage-select-item-content"},[n("span",{class:"stage-select-item-name"},"–í—Å–µ —ç—Ç–∞–ø—ã")],-1))],2),(y(!0),C(oe,null,ue(e.stages,b=>(y(),C("label",{key:b.id,class:Q(["stage-select-item",{"stage-select-item--selected":e.selected[b.id]}]),onClick:v[1]||(v[1]=ae(()=>{},["stop"]))},[n("input",{type:"checkbox",checked:e.selected[b.id],onChange:$=>w(b.id,$.target.checked)},null,40,Ra),n("div",Ha,[n("span",{class:"stage-select-item-color",style:ve({backgroundColor:b.color})},null,4),n("span",Oa,L(b.name),1)])],2))),128))])])):V("",!0)]),_:1})],512))}},Ua=ke(Wa,[["__scopeId","data-v-ce2229b2"]]),ja={class:"trigger-text"},za={class:"week-picker-items"},Va=["data-week-number","onClick"],Ya={class:"week-item-content"},Ka={class:"week-number"},Ga={class:"week-dates"},Xa={class:"week-picker-actions"},qa=["disabled"],Ja={__name:"WeekPicker",props:{selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52}},emits:["update:selectedWeek","change"],setup(e,{emit:t}){const s=e,a=t,u=M(null),r=M(null),l=M([]),d=M(!1),i=M(!1),o=M(null);function w(P=52,I=4){const T=[],H=new Date,O=_(H),G=p(H);for(let J=0;J<P;J++){const Z=new Date(O.start);Z.setUTCDate(Z.getUTCDate()-J*7);const ee=_(Z),de=p(Z);T.unshift({weekNumber:de,startUtc:ee.start.toISOString(),endUtc:ee.end.toISOString(),start:ee.start,end:ee.end})}(T.length===0||T[T.length-1].weekNumber!==G)&&T.push({weekNumber:G,startUtc:O.start.toISOString(),endUtc:O.end.toISOString(),start:O.start,end:O.end});for(let J=1;J<=I;J++){const Z=new Date(O.start);Z.setUTCDate(Z.getUTCDate()+J*7);const ee=_(Z),de=p(Z);T.push({weekNumber:de,startUtc:ee.start.toISOString(),endUtc:ee.end.toISOString(),start:ee.start,end:ee.end})}return T.sort((J,Z)=>J.start-Z.start),T}function _(P){const I=new Date(P),T=I.getUTCDay(),H=I.getUTCDate()-T+(T===0?-6:1),O=new Date(Date.UTC(I.getUTCFullYear(),I.getUTCMonth(),H,0,0,0)),G=new Date(O);return G.setUTCDate(G.getUTCDate()+6),G.setUTCHours(23,59,59,999),{start:O,end:G}}function p(P){const I=new Date(Date.UTC(P.getFullYear(),P.getMonth(),P.getDate()));I.setUTCDate(I.getUTCDate()+4-(I.getUTCDay()||7));const T=new Date(Date.UTC(I.getUTCFullYear(),0,1));return Math.ceil(((I-T)/864e5+1)/7)}function v(P){const I=new Date(P),T=I.getUTCFullYear(),H=String(I.getUTCMonth()+1).padStart(2,"0"),O=String(I.getUTCDate()).padStart(2,"0");return`${T}-${H}-${O}`}function b(){i.value=!i.value,i.value&&(l.value=w(s.weeksCount,4),o.value=s.selectedWeek||l.value.find(P=>{const T=p(new Date);return P.weekNumber===T})||l.value[0],st(()=>{o.value&&F(o.value.weekNumber)}))}function $(P){o.value=P,F(P.weekNumber)}function E(){o.value&&(a("update:selectedWeek",o.value),a("change",o.value),i.value=!1)}function S(){o.value=s.selectedWeek||null,i.value=!1}function F(P){if(!r.value)return;const I=r.value.querySelector(`[data-week-number="${P}"]`);if(I){const T=r.value,H=I.offsetTop,O=T.clientHeight,G=I.clientHeight,J=H-O/2+G/2;T.scrollTo({top:J,behavior:"smooth"})}}function U(){d.value||!i.value||(d.value=!0,clearTimeout(window.weekPickerScrollTimeout),window.weekPickerScrollTimeout=setTimeout(()=>{if(!r.value){d.value=!1;return}const P=r.value,I=P.getBoundingClientRect(),T=I.top+I.height/2,H=P.querySelectorAll(".week-picker-item");let O=null,G=1/0;if(H.forEach(J=>{const Z=J.getBoundingClientRect(),ee=Z.top+Z.height/2,de=Math.abs(ee-T);de<G&&(G=de,O=J)}),O){const J=parseInt(O.dataset.weekNumber),Z=l.value.find(ee=>ee.weekNumber===J);Z&&(!o.value||Z.weekNumber!==o.value.weekNumber)&&(o.value=Z)}d.value=!1},150))}function K(P){u.value&&!u.value.contains(P.target)&&i.value&&S()}return Ee(()=>{if(l.value=w(s.weeksCount,4),s.selectedWeek)o.value=s.selectedWeek;else{const I=p(new Date),T=l.value.find(H=>H.weekNumber===I);T?o.value=T:o.value=l.value[0]}document.addEventListener("click",K)}),Xe(()=>{window.weekPickerScrollTimeout&&clearTimeout(window.weekPickerScrollTimeout),document.removeEventListener("click",K)}),Le(()=>s.selectedWeek,P=>{P&&(o.value=P,i.value&&!d.value&&st(()=>{F(P.weekNumber)}))},{deep:!0}),(P,I)=>(y(),C("div",{class:"week-picker",ref_key:"pickerContainer",ref:u},[I[1]||(I[1]=n("div",{class:"week-picker-label"},[n("span",{class:"section-icon"},"üìÖ"),n("span",null,"–ü–µ—Ä–∏–æ–¥")],-1)),n("div",{class:Q(["week-picker-trigger",{"is-open":i.value}]),onClick:b},[n("span",ja,[e.selectedWeek?(y(),C(oe,{key:0},[_e(" –ù–µ–¥–µ–ª—è "+L(e.selectedWeek.weekNumber)+" ¬∑ "+L(v(e.selectedWeek.startUtc))+" ‚Äî "+L(v(e.selectedWeek.endUtc)),1)],64)):(y(),C(oe,{key:1},[_e(" –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é ")],64))]),n("span",{class:Q(["trigger-icon",{"is-open":i.value}])},"‚ñº",2)],2),re(ze,{name:"dropdown-fade"},{default:ye(()=>[i.value?(y(),C("div",{key:0,class:"week-picker-dropdown",onClick:I[0]||(I[0]=ae(()=>{},["stop"]))},[n("div",{class:"week-picker-wheel",ref_key:"wheelContainer",ref:r,onScroll:U},[n("div",za,[(y(!0),C(oe,null,ue(l.value,(T,H)=>(y(),C("div",{key:T.weekNumber,class:Q(["week-picker-item",{active:T.weekNumber===o.value?.weekNumber}]),"data-week-number":T.weekNumber,onClick:O=>$(T)},[n("div",Ya,[n("div",Ka,"–ù–µ–¥–µ–ª—è "+L(T.weekNumber),1),n("div",Ga,L(v(T.startUtc))+" ‚Äî "+L(v(T.endUtc)),1)])],10,Va))),128))])],544),n("div",Xa,[n("button",{class:"btn-cancel",onClick:S},"–û—Ç–º–µ–Ω–∞"),n("button",{class:"btn-apply",onClick:E,disabled:!o.value},"–ü—Ä–∏–º–µ–Ω–∏—Ç—å",8,qa)])])):V("",!0)]),_:1})],512))}},Za=ke(Ja,[["__scopeId","data-v-daae25a6"]]),Qa={class:"filters-panel"},es={class:"filters-header"},ts=["disabled"],as={class:"filters-content"},ss={key:0,class:"filter-section"},ns={class:"section-content"},os={class:"filter-section"},ls={class:"section-content"},rs={class:"filter-section"},is={key:0,class:"section-content"},cs={class:"section-content"},us={key:0,class:"period-mode-group"},ds=["value"],ps=["disabled"],ms=["disabled"],gs={key:0,class:"period-mode-hint"},fs={key:1,class:"period-mode-hint"},vs=["value"],hs={key:0,class:"custom-date-range"},ys={class:"date-range-inputs"},ks={class:"date-input-group"},bs=["value","max"],Cs={class:"date-input-group"},ws=["value","min","max"],Ss={key:0,class:"filter-error"},_s={key:1,class:"filter-hint"},Ds={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1},hideStages:{type:Boolean,default:!1},weekPickerMode:{type:Boolean,default:!1},selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52},showPeriodMode:{type:Boolean,default:!1},periodMode:{type:String,default:"weeks",validator:e=>["weeks","months"].includes(e)}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","update:selectedWeek","update:periodMode","reset","apply"],setup(e,{emit:t}){const s=e,a=t,u=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"var(--b24-primary, #007bff)"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"var(--b24-success, #28a745)"}],r=M(null),l=te(()=>{const E=new Date;return E.setFullYear(E.getFullYear()-1),E.toISOString().split("T")[0]}),d=te(()=>new Date().toISOString().split("T")[0]);function i(E){a("update:stages",E),a("apply")}function o(E,S){a("apply")}function w(E){a("update:employees",E),a("apply")}function _(E){a("update:dateRange",E),r.value=null,a("apply")}function p(E,S){const F={...s.customDateRange};if(F[E]=S,F.startDate&&F.endDate){const U=new Date(F.startDate),K=new Date(F.endDate);if(U>K){r.value="–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π";return}if(Math.ceil((K-U)/(1e3*60*60*24))>365){r.value="–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π";return}}r.value=null,a("update:customDateRange",F),a("apply")}function v(E){a("update:selectedWeek",E),a("apply")}function b(E){if(!["weeks","months"].includes(E)){console.warn("[FiltersPanel] Invalid periodMode:",E);return}E!==s.periodMode&&(a("update:periodMode",E),a("apply"))}function $(){r.value=null,a("reset")}return(E,S)=>(y(),C("div",Qa,[n("div",es,[S[4]||(S[4]=n("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),n("button",{onClick:$,class:"btn-reset-filters",disabled:!e.hasActiveFilters}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,ts)]),n("div",as,[e.hideStages?V("",!0):(y(),C("div",ss,[S[5]||(S[5]=n("h3",{class:"section-title"},[n("span",{class:"section-icon"},"üìä"),_e(" –≠—Ç–∞–ø—ã ")],-1)),n("div",ns,[re(Ua,{selected:e.stages,stages:u,placeholder:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã","onUpdate:selected":i,onChange:o},null,8,["selected"])])])),n("div",os,[S[6]||(S[6]=n("h3",{class:"section-title"},[n("span",{class:"section-icon"},"üë•"),_e(" –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ")],-1)),n("div",ls,[re(Aa,{selected:e.employees,"onUpdate:selected":w},null,8,["selected"])])]),n("div",rs,[e.weekPickerMode?(y(),C("div",is,[re(Za,{selectedWeek:e.selectedWeek,weeksCount:e.weeksCount,"onUpdate:selectedWeek":v,onChange:v},null,8,["selectedWeek","weeksCount"])])):(y(),C(oe,{key:1},[S[11]||(S[11]=n("h3",{class:"section-title"},[n("span",{class:"section-icon"},"üìÖ"),_e(" –ü–µ—Ä–∏–æ–¥ ")],-1)),n("div",cs,[e.showPeriodMode?(y(),C("div",us,[S[7]||(S[7]=n("label",{class:"period-mode-label"},"–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:",-1)),n("select",{value:e.periodMode,onChange:S[0]||(S[0]=F=>b(F.target.value)),class:Q(["period-mode-select",{"period-mode-select--current-weeks":e.periodMode==="weeks","period-mode-select--current-months":e.periodMode==="months"}])},[n("option",{value:"weeks",disabled:e.periodMode==="weeks"}," 4 –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ ",8,ps),n("option",{value:"months",disabled:e.periodMode==="months"}," 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–∞ ",8,ms)],42,ds),e.periodMode==="weeks"?(y(),C("small",gs," –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: 4 –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ ")):e.periodMode==="months"?(y(),C("small",fs," –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–∞ ")):V("",!0)])):V("",!0),e.showPeriodMode?V("",!0):(y(),C(oe,{key:1},[n("select",{value:e.dateRange,onChange:S[1]||(S[1]=F=>_(F.target.value)),class:"date-range-select"},[...S[8]||(S[8]=[n("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),n("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),n("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),n("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],40,vs),e.dateRange==="custom"?(y(),C("div",hs,[n("div",ys,[n("div",ks,[S[9]||(S[9]=n("label",null,"–°:",-1)),n("input",{type:"date",value:e.customDateRange.startDate,onChange:S[2]||(S[2]=F=>p("startDate",F.target.value)),max:e.customDateRange.endDate||d.value,class:"date-input"},null,40,bs)]),n("div",Cs,[S[10]||(S[10]=n("label",null,"–ü–æ:",-1)),n("input",{type:"date",value:e.customDateRange.endDate,onChange:S[3]||(S[3]=F=>p("endDate",F.target.value)),min:e.customDateRange.startDate||l.value,max:d.value,class:"date-input"},null,40,ws)])]),r.value?(y(),C("small",Ss,L(r.value),1)):(y(),C("small",_s," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):V("",!0)],64))])],64))])])]))}},Es=ke(Ds,[["__scopeId","data-v-5970a362"]]);class at{static compareTwoSnapshots(t,s,a={}){const{includeTickets:u=!1,includeEmployees:r=!0}=a,l=this.validateSnapshot(t),d=this.validateSnapshot(s);if(!l.valid||!d.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...d.errors].join(", "));const i=this.buildComparisonMetadata(t,s),o=this.compareStages(t.statistics.stages,s.statistics.stages),w=r?this.compareEmployees(t.statistics.employees||[],s.statistics.employees||[]):[],_=this.compareZeroPoint(t.statistics.zeroPoint||{},s.statistics.zeroPoint||{}),p=u?this.compareTickets(t.ticketIds||[],s.ticketIds||[],t.tickets||[],s.tickets||[]):null,v=this.buildSummary(o,w,_,p);return{metadata:i,stages:o,employees:w,zeroPoint:_,tickets:p,summary:v}}static calculateDelta(t,s){const a=this.normalizeValue(t),u=this.normalizeValue(s),r=u-a;let l=0;a!==0?l=r/a*100:u!==0&&(l=u>0?1/0:-1/0);const d=this.getTrend(r);return{value1:a,value2:u,delta:r,deltaPercent:Math.round(l*100)/100,trend:d}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,s){const a=["formed","review","execution"],u={};for(const d of a){const i=t[d]?.count||0,o=s[d]?.count||0;u[d]=this.calculateDelta(i,o)}const r=t.total||0,l=s.total||0;return u.total=this.calculateDelta(r,l),u}static compareEmployees(t,s){const a=new Map(t.map(d=>[d.id,d])),u=new Map(s.map(d=>[d.id,d])),r=new Set([...a.keys(),...u.keys()]),l=[];for(const d of r){const i=a.get(d)||null,o=u.get(d)||null;if(!i||!o){l.push({id:d,name:i?.name||o?.name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:i?{ticketsByStage:i.ticketsByStage||{},totalTickets:i.totalTickets||0}:null,snapshot2:o?{ticketsByStage:o.ticketsByStage||{},totalTickets:o.totalTickets||0}:null,delta:this.calculateEmployeeDelta(i,o),trend:i?"removed":"new"});continue}const w={},_=["formed","review","execution"];for(const v of _){const b=i.ticketsByStage?.[v]||0,$=o.ticketsByStage?.[v]||0;w[v]=this.calculateDelta(b,$)}const p=this.calculateDelta(i.totalTickets||0,o.totalTickets||0);l.push({id:d,name:i.name,snapshot1:{ticketsByStage:i.ticketsByStage||{},totalTickets:i.totalTickets||0},snapshot2:{ticketsByStage:o.ticketsByStage||{},totalTickets:o.totalTickets||0},delta:{ticketsByStage:w,totalTickets:p},trend:p.trend})}return l}static calculateEmployeeDelta(t,s){if(!t&&!s)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},u=["formed","review","execution"];for(const l of u){const d=t?.ticketsByStage?.[l]||0,i=s?.ticketsByStage?.[l]||0;a[l]=this.calculateDelta(d,i)}const r=this.calculateDelta(t?.totalTickets||0,s?.totalTickets||0);return{ticketsByStage:a,totalTickets:r}}static compareZeroPoint(t,s){return{unassigned:this.calculateDelta(t?.unassigned||0,s?.unassigned||0),keeper:this.calculateDelta(t?.keeper||0,s?.keeper||0),total:this.calculateDelta(t?.total||0,s?.total||0)}}static compareTickets(t,s,a,u){const r=new Set(t),l=new Set(s),d=s.filter(v=>!r.has(v)),i=t.filter(v=>!l.has(v)),o=[],w=[],_=new Map(a.map(v=>[v.id,v])),p=new Map(u.map(v=>[v.id,v]));for(const v of t){if(!l.has(v))continue;const b=_.get(v),$=p.get(v);if(!b||!$)continue;const E=(b.assignedTo?.id||null)!==($.assignedTo?.id||null),S=(b.stageId||null)!==($.stageId||null);E||S?o.push(v):w.push(v)}return{new:d,removed:i,changed:o,unchanged:w}}static buildComparisonMetadata(t,s){const a=new Date(t.metadata.createdAt),u=new Date(s.metadata.createdAt),r=new Date,l=u.getTime()-a.getTime(),d=Math.floor(l/(1e3*60*60*24)),i=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),o=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:s.metadata.createdAt,comparisonDate:r.toISOString(),timeDiff:{days:d,hours:i,minutes:o,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,s,a,u){const r=t.total.delta,l=Object.keys(t).filter(o=>o==="total"?!1:t[o].delta!==0).length,d=s.filter(o=>o.trend==="new"||o.trend==="removed"?!0:o.delta.totalTickets.delta!==0).length,i=r!==0||l>0||d>0;return{totalDelta:r,stagesChanged:l,employeesChanged:d,hasChanges:i,newTicketsCount:u?.new?.length||0,removedTicketsCount:u?.removed?.length||0,changedTicketsCount:u?.changed?.length||0}}static validateSnapshot(t){const s=[],a=[];if(!t)return s.push("Snapshot is null or undefined"),{valid:!1,errors:s,warnings:a};if(t.metadata?(t.metadata.createdAt||s.push("Missing metadata.createdAt"),t.metadata.type||s.push("Missing metadata.type")):s.push("Missing metadata field"),!t.statistics)s.push("Missing statistics field");else{if(!t.statistics.stages)s.push("Missing statistics.stages");else{const u=["formed","review","execution"];for(const r of u)t.statistics.stages[r]||a.push(`Missing stage: ${r}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:s.length===0,errors:s,warnings:a}}static compareMultipleSnapshots(t,s={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const d=this.validateSnapshot(l);if(!d.valid)throw new Error("Invalid snapshot: "+d.errors.join(", "))}const a=[...t].sort((l,d)=>{const i=new Date(l.metadata.createdAt),o=new Date(d.metadata.createdAt);return i-o}),u=[];for(let l=0;l<a.length-1;l++)u.push({from:l,to:l+1,result:this.compareTwoSnapshots(a[l],a[l+1],s)});const r=this.buildTrends(a);return{snapshots:a.map((l,d)=>({index:d,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:u,trends:r}}static buildTrends(t){const s={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const a of t){const u=a.statistics;s.stages.formed.push(u.stages?.formed?.count||0),s.stages.review.push(u.stages?.review?.count||0),s.stages.execution.push(u.stages?.execution?.count||0),s.stages.total.push(u.stages?.total||0),s.zeroPoint.unassigned.push(u.zeroPoint?.unassigned||0),s.zeroPoint.keeper.push(u.zeroPoint?.keeper||0),s.zeroPoint.total.push(u.zeroPoint?.total||0)}return s}}const Ts={class:"stages-container"},Is={class:"stages-chips"},$s=["checked","disabled","onChange"],Ns={class:"stage-chip-label"},Ms={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:e=>e.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(e,{emit:t}){const s=e,a=t;function u(r,l){const d={...s.selected};d[r]=l,a("update:selected",d),a("change",r,l)}return(r,l)=>(y(),C("div",Ts,[l[0]||(l[0]=n("h4",{class:"stages-title"},"–≠—Ç–∞–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:",-1)),n("div",Is,[(y(!0),C(oe,null,ue(e.stages,d=>(y(),C("label",{key:d.id,class:Q(["stage-chip",{"stage-chip--active":e.selected[d.id],"stage-chip--disabled":e.disabled}])},[n("input",{type:"checkbox",checked:e.selected[d.id],disabled:e.disabled,onChange:i=>u(d.id,i.target.checked)},null,40,$s),n("span",{class:"stage-chip-color",style:ve({backgroundColor:d.color})},null,4),n("span",Ns,L(d.name),1)],2))),128))])]))}},xs=ke(Ms,[["__scopeId","data-v-fe03c03c"]]);async function It(e,t,s,a=null){if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:e,stageId:t,hasSnapshot:!!s,snapshotType:s?typeof s:"null",snapshotKeys:s?Object.keys(s):[],hasTickets:!!s?.tickets,ticketsIsArray:Array.isArray(s?.tickets),ticketsLength:s?.tickets?.length||0}),!e||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!s)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!s.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(s)),[];if(!Array.isArray(s.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof s.tickets),[];const u=s.tickets.filter(o=>{const w=o.assignedTo;return w?(typeof w=="object"?w.id:w)===e:!1});if(u.length===0)return[];const r=!u[0].stageId||!u[0].departmentHead;let l=null;if(r){const o=u.map(w=>w.id);if(a&&typeof a=="object")l=a;else try{const w=await nt.getTicketsDetails(o);l=new Map,w.forEach(_=>{_&&_.id&&l.set(_.id,_)})}catch(w){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",w),l=null}}return u.map(o=>{const w=o.id,_={id:w,title:o.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o.assignedTo,createdAt:o.createdAt,updatedAt:o.updatedAt};if(l){const p=l instanceof Map?l.get(w):l[w];p?(_.stageId=p.stageId||null,_.departmentHead=p.departmentHead||null,_.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null):(_.stageId=null,_.departmentHead=null)}else _.stageId=o.stageId||null,_.departmentHead=o.departmentHead||null,_.departmentHeadFull=o.departmentHeadFull||o.departmentHead||null;return _}).filter(o=>o.stageId?je(o.stageId)===t:!0)}function mt(e,t=new Date){if(!e||e.length===0)return[];const s=e.length,a={};return Object.values(ge).forEach(r=>{a[r]={category:r,label:dt[r].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:dt[r].color}}),e.forEach(r=>{if(!r.createdAt){a[ge.MORE_THAN_YEAR].count++,a[ge.MORE_THAN_YEAR].tickets.push(r);return}const l=yt(r.createdAt,t);a[l]&&(a[l].count++,a[l].tickets.push(r))}),Object.values(a).filter(r=>r.count>0).map(r=>{const l=s>0?parseFloat((r.count/s*100).toFixed(1)):0;return{...r,percentage:l,progressBarWidth:l}}).sort((r,l)=>{const d=[ge.TODAY,ge.YESTERDAY,ge.THIS_WEEK,ge.LAST_WEEK,ge.MORE_THAN_TWO_WEEKS,ge.UP_TO_ONE_MONTH,ge.MORE_THAN_TWO_MONTHS,ge.MORE_THAN_HALF_YEAR,ge.MORE_THAN_YEAR];return d.indexOf(r.category)-d.indexOf(l.category)})}function gt(e){if(!e||e.length===0)return[];const t={};e.forEach(a=>{let u=a.departmentHeadFull||a.departmentHead;e.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(r=>r.toLowerCase().includes("department"))}),u?(u=String(u).trim(),u.length===0&&(u="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞")):u="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞",t[u]||(t[u]={departmentName:u,count:0}),t[u].count++});const s=Object.values(t);return s.sort((a,u)=>u.count!==a.count?u.count-a.count:a.departmentName.localeCompare(u.departmentName,"ru")),s}function As(e,t){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function Ls(e,t){if(!e||!t)return{sourceLevel:2,employeeId:e?.employeeId||null,employeeName:e?.employeeName||null,stageId:e?.stageId||null,stageName:e?.stageName||null,dateCategory:null,dateCategoryLabel:null,departmentName:t?.departmentName||null,tickets:[],snapshot:e?.snapshot||null,ticketDetails:e?.ticketDetails||null};const s=Fe(e.tickets||[],t.departmentName);return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:s,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function Fs(e,t){const s=await It(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),a=$t(s,e.dateCategory),u=Fe(a,t.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:t.departmentName,tickets:u,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function Ps(e,t){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function Bs(e,t){const s=(e.snapshot?.tickets||[]).filter(u=>u.stageId?je(u.stageId)===e.stageId:!1),a=Fe(s,t.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:a,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function Rs(e,t){return!e||e.length===0?[]:e.filter(s=>s.stageId?je(s.stageId)===t:!1)}function Hs(e,t){return!e||e.length===0?[]:e.filter(s=>{const a=s.assignedTo;return a?(typeof a=="object"?a.id:a)===t:!1})}function $t(e,t){if(!e||e.length===0)return[];const s=new Date;return e.filter(a=>a.createdAt?yt(a.createdAt,s)===t:t===ge.MORE_THAN_YEAR)}function Fe(e,t){return!e||e.length===0?[]:e.filter(s=>{let a=s.departmentHeadFull||s.departmentHead;return a?(a=String(a).trim(),a.length===0&&(a="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞")):a="–ë–µ–∑ –∑–∞–∫–∞–∑—á–∏–∫–∞",a===t})}async function Os(e){if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let d=e.tickets;return e.departmentName&&(d=Fe(d,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:d.length,departmentFilter:e.departmentName}),d}const{snapshot:t,stageId:s,employeeId:a,dateCategory:u,departmentName:r}=e;let l=t.tickets||[];return s&&(l=Rs(l,s)),a&&(l=Hs(l,a)),u&&(l=$t(l,u)),r&&(l=Fe(l,r)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:t.tickets?.length||0,filteredCount:l.length,filters:{stageId:s,employeeId:a,dateCategory:u,departmentName:r}}),l}function Ws(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function Us(e){return e.filter(t=>{const s=!t.ufSubject||t.ufSubject==="",a=t.actionStr===null||t.actionStr===void 0,u=!t.description||t.description==="";return s||a||u})}function js(e){const t=new Map;return e&&(Array.isArray(e)?e.forEach(s=>{s&&s.id&&t.set(s.id,s)}):typeof e=="object"&&Object.keys(e).forEach(s=>{const a=e[s];a&&a.id&&t.set(a.id,a)})),t}function zs(e,t){const s=t.get(e.id)||null,a={id:e.id,title:e.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};a.ufSubject=s?.ufSubject||e.ufSubject||null;const u=s?.priorityId||e.priorityId||"unknown",r=s?.priorityLabel||e.priorityLabel||"–ù–µ —É–∫–∞–∑–∞–Ω–æ",l=pa(u);a.priorityId=u,a.priorityLabel=r,a.priorityColors=l,a.priority=u;const d=s?.service||e.service||ga(),i=s?.serviceLabel||e.serviceLabel||d.label||"–ù–µ —É–∫–∞–∑–∞–Ω–æ",o=va(d);return a.service=d,a.serviceLabel=i,a.serviceColors=o,a.actionStr=s?.actionStr||e.actionStr||e.ufActionStr||null,a.ufActionStr=a.actionStr,a.departmentHead=s?.departmentHead||e.departmentHead||null,a.departmentHeadFull=s?.departmentHeadFull||e.departmentHeadFull||e.departmentHead||null,a.description=s?.description||e.description||e.comments||"",a.assignedTo=e.assignedTo||null,a.assigneeId=e.assigneeId||e.assignedTo?.id||null,a.stageId=e.stageId||null,!a.status&&a.stageId?a.status=Ws(a.stageId):a.status=e.status||"new",a}async function Vs(e,t=null,s=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const a=Us(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:a.length,alreadyHaveDetails:e.length-a.length});let u=s||null;if(a.length>0&&!s){const d=a.map(i=>i.id).filter(i=>i);if(d.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:d.length,ticketIdsSample:d.slice(0,5)}),u=await nt.getTicketsDetails(d),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:u?.length||0,sampleTicket:u?.[0]?{id:u[0].id,hasUfSubject:!!u[0].ufSubject,hasActionStr:!!u[0].actionStr,hasDescription:!!u[0].description}:null})}catch(i){console.warn("[ticketListUtils] Failed to load ticket details:",i),console.error("[ticketListUtils] Error details:",{message:i.message,stack:i.stack,ticketIdsCount:d.length}),u=null}}const r=js(u),l=e.map(d=>zs(d,r));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:l.length,sampleTicket:l[0]?{id:l[0].id,hasUfSubject:!!l[0].ufSubject,hasPriorityColors:!!l[0].priorityColors,hasServiceColors:!!l[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),l}const xe=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:Bs,createContextFromLevel1Time:Ps,createContextFromLevel2:As,createContextFromLevel2Department:Ls,createContextFromLevel3:Fs,filterTicketsByContext:Os,filterTicketsByDepartment:Fe,prepareTicketsForDisplay:Vs},Symbol.toStringTag,{value:"Module"})),Ve=10;function Ze(e,t){if(!t||!t.statistics)return[];const s=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(u=>u.ticketsByStage&&u.ticketsByStage[e]>0).forEach(u=>{s.push({id:u.id,name:u.name,count:u.ticketsByStage[e]||0})});const a=Ys(e,t);return a>0&&s.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:a,isKeeper:!0}),s.sort((u,r)=>r.count-u.count)}function Ys(e,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[e])return t.statistics.zeroPointByStage[e].keeper||0;if(t.statistics.zeroPoint){const s=t.statistics.zeroPoint.keeper||0;return Math.floor(s/3)}return 0}function Nt(e,t){return!t||!t.statistics||!t.statistics.stages?0:t.statistics.stages[e]?.count||0}function Qe(e,t=Ve){if(!e||e.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const s=[...e].sort((l,d)=>d.count-l.count),a=s.slice(0,t),u=s.slice(t),r=u.reduce((l,d)=>l+d.count,0);return{visible:a,others:{employees:u,count:r,employeeCount:u.length}}}function Mt(e,t){return!e||e.length===0?[]:t===0?e.map(s=>({...s,percentage:0})):e.map(s=>({...s,percentage:parseFloat((s.count/t*100).toFixed(1))}))}function qe(e,t,s="#007bff",a=Ve){if(!e||e.length===0)return{employees:[],others:null};const{visible:u,others:r}=Qe(e,a),l=Mt(u,t).map(i=>({...i,progressBarWidth:i.percentage,progressBarColor:i.isKeeper?"#f59e0b":s}));let d=null;if(r.count>0){const i=parseFloat((r.count/t*100).toFixed(1));d={...r,percentage:i,progressBarWidth:i,progressBarColor:"#6c757d"}}return{employees:l,others:d}}function Ks(e,t){const s={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(u=>{const r=t[u];if(!r)return;const l=Ze(e,r),d=Nt(e,r);if(l.length===0)return;const{visible:i,others:o}=Qe(l,Ve),w=Mt(i,d);s[u]=w,o.count>0&&(s.others[u]={count:o.count,employeeCount:o.employeeCount,percentage:parseFloat((o.count/d*100).toFixed(1))})}),s}function Gs(e,t="current",s=[]){const a=e[t];if(!a)return{labels:[],datasets:[]};const u=new Map;s.forEach(_=>{Ze(_.id,a).forEach(v=>{u.has(v.id)||u.set(v.id,{id:v.id,name:v.name,isKeeper:v.isKeeper||!1,ticketsByStage:{}}),u.get(v.id).ticketsByStage[_.id]=v.count})});const r=Array.from(u.values()).map(_=>{const p=Object.values(_.ticketsByStage).reduce((v,b)=>v+b,0);return{..._,totalTickets:p}});r.sort((_,p)=>p.totalTickets-_.totalTickets);const{visible:l,others:d}=Qe(r,Ve),i=s.map(()=>""),o={};s.forEach(_=>{const p=Ze(_.id,a),{visible:v}=Qe(p,Ve);o[_.id]=v.map(b=>({id:b.id,name:b.name,count:b.count}))});const w=l.map((_,p)=>{const v=s.map($=>_.ticketsByStage[$.id]||0),b=s.map($=>{if((_.ticketsByStage[$.id]||0)===0)return"transparent";const F=$.color.replace("#",""),U=parseInt(F.substring(0,2),16),K=parseInt(F.substring(2,4),16),P=parseInt(F.substring(4,6),16),I=.6+p*.05;return`rgba(${U}, ${K}, ${P}, ${Math.min(I,.95)})`});return{label:_.name,data:v,backgroundColor:b,borderColor:s.map($=>{const E=$.color.replace("#",""),S=parseInt(E.substring(0,2),16),F=parseInt(E.substring(2,4),16),U=parseInt(E.substring(4,6),16);return`rgba(${S}, ${F}, ${U}, 0.8)`}),borderWidth:1,meta:{employeeId:_.id,employeeName:_.name}}});if(d.count>0){const _=s.map(p=>d.employees.reduce((v,b)=>v+(b.ticketsByStage[p.id]||0),0));w.push({label:`–î—Ä—É–≥–∏–µ (${d.employeeCount})`,data:_,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:i,datasets:w,meta:{employeesByStage:o}}}function Xs(e,t,s=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=s.find(o=>o.id===e),u=a?a.name:"",r=a?a.color:"#007bff",l=Ze(e,t),d=Nt(e,t);if(l.length===0)return{stageName:u,totalCount:0,employees:[],others:null};const i=qe(l,d,r,Ve);return{stageName:u,totalCount:d,employees:i.employees,others:i.others}}function qs(e,t){return t?.[e]||e}function Js(e,t){return t?.[e]||"#007bff"}function ot({snapshots:e,graphType:t,timePoint:s,snapshotType:a}){return e?t==="line"&&s?e[s]||null:t==="bar"&&a?e[a]||null:e.current||e.weekEnd||e.weekStart||null:null}function lt(e,t){return t?.statistics?.stages?.[e]?.count||0}function Zs({stageId:e,timePoint:t,meta:s,snapshots:a,stageColor:u,maxVisible:r}){if(!s?.employees||!t)return null;const l=s.employees[t];if(!l||l.length===0)return null;const d=a?.[t]||null,i=lt(e,d)||l.reduce((w,_)=>w+(_.count||0),0),o=qe(l,i,u,r);return{stageId:e,totalCount:i,employees:o.employees,others:o.others,snapshot:d}}function Qs({stageId:e,meta:t,snapshots:s,stageColor:a,maxVisible:u}){const r=t?.employees?.[e];if(!r||!r.employees||r.employees.length===0)return null;const l=ot({snapshots:s,graphType:"doughnut"}),d=r.totalCount??lt(e,l)??r.employees.reduce((o,w)=>o+(w.count||0),0),i=qe(r.employees,d,a,u);return{stageId:e,totalCount:d,employees:i.employees,others:i.others,snapshot:l}}function en({stageId:e,meta:t,snapshots:s,stageColor:a,maxVisible:u,snapshotType:r}){const l=t?.employeesByStage?.[e];if(!l||l.length===0)return null;const d=ot({snapshots:s,graphType:"bar",snapshotType:r}),i=lt(e,d)||l.reduce((w,_)=>w+(_.count||0),0),o=qe(l,i,a,u);return{stageId:e,totalCount:i,employees:o.employees,others:o.others,snapshot:d}}async function xt({stageId:e,graphType:t,timePoint:s=null,snapshotType:a=null,snapshots:u=null,meta:r=null,stageColorMap:l=null,stageNameMap:d=null,maxVisible:i=10,restLoader:o=null}){if(!e)throw new Error("stageId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω—è 1");const w=qs(e,d),_=Js(e,l);let p=null;if(t==="line"?p=Zs({stageId:e,timePoint:s,meta:r?.line,snapshots:u,stageColor:_,maxVisible:i}):t==="doughnut"?p=Qs({stageId:e,meta:r?.doughnut,snapshots:u,stageColor:_,maxVisible:i}):t==="bar"&&(p=en({stageId:e,meta:r?.bar,snapshots:u,stageColor:_,maxVisible:i,snapshotType:a})),p)return{stageId:e,stageName:w,color:_,totalCount:p.totalCount,employees:p.employees,others:p.others,snapshot:p.snapshot};if(typeof o=="function"){const v=await o({stageId:e,graphType:t,timePoint:s,snapshotType:a,snapshots:u});if(v&&Array.isArray(v.employees)){const b=v.totalCount??v.employees.reduce((E,S)=>E+(S.count||0),0),$=qe(v.employees,b,_,i);return{stageId:e,stageName:w,color:_,totalCount:b,employees:$.employees,others:$.others,snapshot:v.snapshot||ot({snapshots:u,graphType:t,timePoint:s,snapshotType:a})}}}throw new Error("–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–∞–¥–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (meta/REST)")}const tn={key:"level-1",class:"level-1"},an={class:"modal-header"},sn={class:"stage-header"},nn=["aria-expanded","onKeydown"],on={class:"stage-title"},ln=["aria-selected","onClick","onKeydown"],rn={class:"stage-name"},cn={class:"modal-total"},un={class:"view-switcher"},dn={class:"modal-body"},pn={key:0,class:"load-error"},mn={key:1,class:"stage-loader"},gn={key:2},fn={key:0,class:"no-employees"},vn={key:1,class:"employees-list"},hn=["onClick"],yn={class:"employee-name"},kn={class:"employee-progress"},bn={class:"employee-count"},Cn={key:0,class:"employee-item employee-others"},wn={class:"employee-name"},Sn={class:"employee-progress"},_n={class:"employee-count"},Dn={key:3,class:"view-time"},En={key:0,class:"no-data"},Tn={key:1,class:"date-categories-list"},In=["onClick"],$n={class:"category-label"},Nn={class:"category-progress"},Mn={class:"category-count"},xn={key:4,class:"view-departments"},An={key:0,class:"no-data"},Ln={key:1,class:"departments-table-container"},Fn={class:"departments-table"},Pn=["onClick"],Bn={class:"col-department"},Rn={class:"department-name"},Hn={class:"col-count"},On={class:"count-value"},Wn={key:"level-2",class:"level-2"},Un={class:"modal-header"},jn={class:"modal-total"},zn={class:"modal-body"},Vn={class:"stage-info level2-stage-row"},Yn={class:"stage-badge"},Kn={class:"level2-sort-switch",role:"group","aria-label":"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"},Gn={key:0},Xn={key:0,class:"no-data"},qn={key:1,class:"date-categories-list"},Jn=["onClick"],Zn={class:"category-label"},Qn={class:"category-progress"},eo={class:"category-count"},to={key:1,class:"view-departments"},ao={key:0,class:"no-data"},so={key:1,class:"departments-table-container"},no={class:"departments-table"},oo=["onClick"],lo={class:"col-department"},ro={class:"department-name"},io={class:"col-count"},co={class:"count-value"},uo={key:"level-3",class:"level-3"},po={class:"modal-header"},mo={class:"header-info"},go={class:"header-badges"},fo={class:"date-badge"},vo={class:"stage-badge"},ho={class:"modal-total"},yo={class:"modal-body"},ko={key:0,class:"no-data"},bo={key:1,class:"departments-table-container"},Co={class:"departments-table"},wo=["onClick"],So={class:"col-department"},_o={class:"department-name"},Do={class:"col-count"},Eo={class:"count-value"},To={key:"level-4",class:"level-4"},Io={class:"modal-header"},$o={class:"header-info"},No={key:0,class:"header-badges"},Mo={key:0,class:"date-badge"},xo={key:1,class:"department-badge"},Ao={class:"stage-badge"},Lo={class:"modal-total"},Fo={class:"modal-body"},Po={key:"loading",class:"loading-state"},Bo={key:"error-fallback",class:"error-state-with-fallback"},Ro={class:"tickets-list-container"},Ho={key:"error",class:"error-state"},Oo={class:"error-message"},Wo={key:"empty",class:"empty-state"},Uo={class:"empty-state-title"},jo={class:"empty-state-message"},zo={key:"tickets",class:"tickets-list-container"},Vo={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(e,{expose:t,emit:s}){const a=e,u=s,r=et(),l=M(1),d=M("time"),i=M("employees"),o=M(null),w=M([]),_=M([]),p=M(null),v=M(null),b=M(null),$=M(a.stageSwitchContext||null),E=M(!1),S=M(null),F=M(null),U=M(!1),K=M(null),P=M(null),I=te(()=>{const g=$.value?.stageNameMap||{},m=$.value?.stageColorMap||{};return Object.keys(g).map(c=>({id:c,name:g[c],color:m[c]||"#007bff",disabled:c===(o.value?.stageId||a.stageId)}))});te(()=>l.value>1);const T=te(()=>{switch(l.value){case 1:return o.value?.stageName||a.stageName;case 2:return p.value?.employeeName||"";case 3:return`${p.value?.employeeName||""} ‚Äî ${v.value?.dateCategoryLabel||""}`;case 4:if(!b.value?.context)return"–°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤";const g=b.value.context,m=[];return g.employeeName&&m.push(g.employeeName),g.dateCategoryLabel&&m.push(g.dateCategoryLabel),g.departmentName&&m.push(g.departmentName),g.stageName&&m.push(g.stageName),m.length>0?m.join(" ‚Äî "):"–°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤";default:return""}});function H(){console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:a.employees?.length||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:a.snapshot?.ticketIds?.length||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,v.value=null,b.value=null,l.value=1,d.value="time",i.value="employees",O(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function O(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const g=o.value.snapshot.tickets||[],m=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:g.length,currentStageId:m,sampleTicket:g[0]?{id:g[0].id,stageId:g[0].stageId,hasDepartmentHead:!!g[0].departmentHead,departmentHead:g[0].departmentHead,hasDepartmentHeadFull:!!g[0].departmentHeadFull,departmentHeadFull:g[0].departmentHeadFull,allKeys:Object.keys(g[0])}:null});let c=g.filter(B=>B.stageId?je(B.stageId)===m:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:g.length,afterFilter:c.length,stageId:m,ticketsWithStageId:c.filter(B=>B.stageId).length,ticketsWithoutStageId:c.filter(B=>!B.stageId).length});const x=c.filter(B=>!B.departmentHead&&!B.departmentHeadFull);if(x.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:x.length,totalTickets:c.length,ticketsWithDepartment:c.filter(k=>k.departmentHead||k.departmentHeadFull).length});const B=x.map(k=>k.id).filter(k=>k);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:B.length,ticketIdsSample:B.slice(0,10)});const k=await nt.getTicketsDetails(B),f=new Map;k.forEach(h=>{h&&h.id&&f.set(h.id,h)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:k.length,detailsMapSize:f.size,sampleDetail:k[0]?{id:k[0].id,departmentHead:k[0].departmentHead,departmentHeadFull:k[0].departmentHeadFull}:null}),c=c.map(h=>{const A=f.get(h.id);return A?{...h,stageId:A.stageId||h.stageId||null,departmentHead:A.departmentHead||h.departmentHead||null,departmentHeadFull:A.departmentHeadFull||A.departmentHead||h.departmentHead||null}:h}),c=c.filter(h=>h.stageId?je(h.stageId)===m:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:c.length,ticketsWithDepartment:c.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:c.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,ticketsWithStageId:c.filter(h=>h.stageId).length,ticketsWithoutStageId:c.filter(h=>!h.stageId).length});const D=c.length,N=c.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));c=c.filter(h=>h.stageId?je(h.stageId)===m:!0);const R=c.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:D,afterStageFilter:c.length,filteredOut:D-c.length,currentStageId:m,ticketsWithDepartment:c.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:c.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,sampleBeforeFilter:N,sampleAfterFilter:R,sampleWithDepartment:c.find(h=>h.departmentHead||h.departmentHeadFull)?{id:c.find(h=>h.departmentHead||h.departmentHeadFull).id,departmentHead:c.find(h=>h.departmentHead||h.departmentHeadFull).departmentHead,departmentHeadFull:c.find(h=>h.departmentHead||h.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(c.find(h=>h.departmentHead||h.departmentHeadFull)).filter(h=>h.toLowerCase().includes("department"))}:null})}catch(k){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",k),console.error("[EmployeeDetailsModal] Error details:",{message:k.message,stack:k.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:c.length,currentStageId:m,ticketsWithStageId:c.filter(B=>B.stageId).length,ticketsWithoutStageId:c.filter(B=>!B.stageId).length,ticketsWithDepartment:c.filter(B=>B.departmentHead||B.departmentHeadFull).length,ticketsWithoutDepartment:c.filter(B=>!B.departmentHead&&!B.departmentHeadFull).length});const se=mt(c);w.value=se,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:c.length,sampleTickets:c.slice(0,5).map(B=>({id:B.id,departmentHead:B.departmentHead,departmentHeadFull:B.departmentHeadFull,hasDepartmentHead:!!B.departmentHead,hasDepartmentHeadFull:!!B.departmentHeadFull,allKeys:Object.keys(B).filter(k=>k.toLowerCase().includes("department"))})),ticketsWithDepartment:c.filter(B=>B.departmentHead||B.departmentHeadFull).length,ticketsWithoutDepartment:c.filter(B=>!B.departmentHead&&!B.departmentHeadFull).length});const be=gt(c);_.value=be;const $e=se.reduce((B,k)=>B+k.count,0),Ke=be.reduce((B,k)=>B+k.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:m,totalTicketsForGrouping:c.length,timeCategoriesCount:se.length,totalTicketsInTimeCategories:$e,departmentsCount:be.length,totalTicketsInDepartments:Ke,departmentsSample:be.slice(0,5),ticketsWithDepartment:c.filter(B=>B.departmentHead||B.departmentHeadFull).length,ticketsWithoutDepartment:c.filter(B=>!B.departmentHead&&!B.departmentHeadFull).length,consistencyCheck:{totalTickets:c.length,timeCategoriesTotal:$e,departmentsTotal:Ke,isConsistent:c.length===$e&&c.length===Ke}})}catch(g){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",g),console.error("[EmployeeDetailsModal] Error stack:",g.stack)}}async function G(g){if(!g){r.error("–ù–µ —É–∫–∞–∑–∞–Ω stageId –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");return}if(o.value?.stageId===g)return;if(!$.value){r.error("–ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞–¥–∏–∏ (stageSwitchContext)");return}E.value=!0,S.value=null;const m=o.value?{...o.value}:null;F.value=m?.stageId||null;try{const c=await xt({...$.value,stageId:g});o.value={stageId:c.stageId,stageName:c.stageName,stageColor:c.color,totalCount:c.totalCount,employees:c.employees,others:c.others,snapshot:c.snapshot||m?.snapshot||null,ticketDetails:c.ticketDetails||null},p.value=null,v.value=null,b.value=null,l.value=1,d.value="time",i.value="employees",await O()}catch(c){console.error("[EmployeeDetailsModal] Failed to reload stage data:",c),S.value=c?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–¥–∏–∏",m&&(o.value=m),r.error(S.value)}finally{E.value=!1}}async function J(g){if(!g||g.count===0){r.info(`–£ –∑–∞–∫–∞–∑—á–∏–∫–∞ "${g?.departmentName||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!v.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),r.error("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω—è 3 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");return}try{const{createContextFromLevel3:m}=await Me(async()=>{const{createContextFromLevel3:x}=await Promise.resolve().then(()=>xe);return{createContextFromLevel3:x}},void 0,import.meta.url),c=await m(v.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:c.employeeName,dateCategory:c.dateCategoryLabel,departmentName:c.departmentName,ticketsCount:c.tickets.length}),await fe(c)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",m),r.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message)}}async function Z(g){if(!g||g.count===0){r.info(`–£ –∑–∞–∫–∞–∑—á–∏–∫–∞ "${g?.departmentName||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),r.error("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω—è 1 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");return}try{const{createContextFromLevel1Department:m}=await Me(async()=>{const{createContextFromLevel1Department:x}=await Promise.resolve().then(()=>xe);return{createContextFromLevel1Department:x}},void 0,import.meta.url),c=m(o.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:c.stageName,departmentName:c.departmentName,ticketsCount:c.tickets.length}),await fe(c)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",m),r.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message)}}async function ee(g){if(!g||g.count===0){r.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${g?.label||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!g.tickets||g.tickets.length===0){r.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${g.label}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),r.error("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω—è 1 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");return}try{const{createContextFromLevel1Time:m}=await Me(async()=>{const{createContextFromLevel1Time:x}=await Promise.resolve().then(()=>xe);return{createContextFromLevel1Time:x}},void 0,import.meta.url),c=m(o.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:c.stageName,dateCategory:c.dateCategoryLabel,ticketsCount:c.tickets.length}),await fe(c)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",m),r.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message)}}Le(()=>a.isVisible,g=>{g?H():(Be(),pe())}),Le(()=>a.stageSwitchContext,g=>{$.value=g},{deep:!0}),Ee(()=>{a.isVisible&&H()});async function de(g,m=null){if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",g),console.log("[EmployeeDetailsModal] Current popup level:",l.value),m&&m.currentTarget&&(m.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{m.currentTarget&&(m.currentTarget.style.transform="")},150)),!g||!g.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",g);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID —Å—Ç–∞–¥–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω"),r.warning("ID —Å—Ç–∞–¥–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: –°–ª–µ–ø–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),r.warning("–°–ª–µ–ø–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",g.id,"stage:",o.value.stageId);const c=await It(g.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",c?.length||0,c),!c||c.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),r.info(`–£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${g.name}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ —Å—Ç–∞–¥–∏–∏ "${o.value.stageName}"`);return}const x=mt(c);console.log("[EmployeeDetailsModal] Date categories:",x?.length||0,x);const se=gt(c).map(be=>({...be,tickets:Fe(c,be.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",se?.length||0,se),p.value={employeeId:g.id,employeeName:g.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:c.length,dateCategories:x,departments:se,tickets:c,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},d.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length,departmentsCount:p.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),l.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",l.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:p.value?.employeeName,dateCategoriesCount:p.value?.dateCategories?.length||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",l.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(c){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",c),console.error("[EmployeeDetailsModal] Error stack:",c.stack),r.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–∫–µ—Ç–∞—Ö: "+c.message)}}async function Ye(g){if(!g||g.count===0){r.info(`–£ –∑–∞–∫–∞–∑—á–∏–∫–∞ "${g?.departmentName||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!p.value){r.error("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");return}try{const{createContextFromLevel2Department:m}=await Me(async()=>{const{createContextFromLevel2Department:x}=await Promise.resolve().then(()=>xe);return{createContextFromLevel2Department:x}},void 0,import.meta.url),c=m(p.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:c.employeeName,departmentName:c.departmentName,ticketsCount:c.tickets.length}),await fe(c)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",m),r.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message)}}async function Pe(g){if(!g||g.count===0){r.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${g?.label||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!g.tickets||g.tickets.length===0){r.info(`–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${g.label}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),r.error("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω—è 2 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");return}try{const{createContextFromLevel2:m}=await Me(async()=>{const{createContextFromLevel2:x}=await Promise.resolve().then(()=>xe);return{createContextFromLevel2:x}},void 0,import.meta.url),c=m(p.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:c.employeeName,dateCategory:c.dateCategoryLabel,ticketsCount:c.tickets.length}),await fe(c)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",m),r.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message)}}async function fe(g){if(console.time("[Performance] goToLevel4"),!g){console.error("[EmployeeDetailsModal] Context is required for level 4"),r.error("–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–µ —É–∫–∞–∑–∞–Ω"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:g.sourceLevel,employeeId:g.employeeId,stageId:g.stageId,dateCategory:g.dateCategory,departmentName:g.departmentName,ticketsCount:g.tickets?.length||0});try{b.value={context:g,tickets:[],totalCount:0,isLoading:!0,error:null};let m=g.tickets||[];if(m.length===0&&g.snapshot){const{filterTicketsByContext:x}=await Me(async()=>{const{filterTicketsByContext:se}=await Promise.resolve().then(()=>xe);return{filterTicketsByContext:se}},void 0,import.meta.url);m=await x(g)}(!m||m.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),m=g.tickets||[]),(!m||m.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),g.snapshot&&g.snapshot.tickets&&(m=g.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",m.length)));let c=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:x}=await Me(async()=>{const{prepareTicketsForDisplay:se}=await Promise.resolve().then(()=>xe);return{prepareTicketsForDisplay:se}},void 0,import.meta.url);c=await x(m,g.snapshot,g.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(x){console.error("[EmployeeDetailsModal] Error preparing tickets:",x),console.timeEnd("[Performance] prepareTicketsForDisplay"),c=m||[],r.warning("–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–æ–≤ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:m.length,preparedCount:c.length}),b.value={context:g,tickets:c,totalCount:c.length,isLoading:!1,error:null},l.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:b.value.totalCount,ticketsCount:b.value.tickets.length,isLoading:b.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",m),console.error("[EmployeeDetailsModal] Error details:",{message:m.message,stack:m.stack,context:g});let c=[];if(g.snapshot&&g.snapshot.tickets)try{const x=g.stageId;x?c=(g.snapshot.tickets||[]).filter(se=>se.stageId===x):c=g.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",c.length)}catch(x){console.error("[EmployeeDetailsModal] Error using fallback tickets:",x)}b.value={context:g,tickets:c,totalCount:c.length,isLoading:!1,error:{message:m.message,hasFallback:c.length>0}},c.length>0?(r.warning("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞."),l.value=4):(r.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤: "+m.message),we()),console.timeEnd("[Performance] goToLevel4")}}function we(){if(l.value===4){if(b.value&&b.value.context){const g=b.value.context.sourceLevel;l.value=g}else l.value=1;b.value=null}else l.value===3?(l.value=2,v.value=null,b.value=null):l.value===2&&(l.value=1,p.value=null,v.value=null,b.value=null)}function Be(){l.value=1,o.value=null,p.value=null,v.value=null,b.value=null,d.value="time"}function Se(){if(!b.value?.context)return"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤";const{sourceLevel:g,employeeName:m,dateCategoryLabel:c,departmentName:x}=b.value.context;return g===2&&m&&c?`–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ —É ${m} –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${c}"`:g===2&&m&&x?`–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ —É ${m} —É –∑–∞–∫–∞–∑—á–∏–∫–∞ "${x}"`:g===3&&m&&x?`–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ —É ${m} —É –∑–∞–∫–∞–∑—á–∏–∫–∞ "${x}"`:g===1&&c?`–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${c}"`:g===1&&x?`–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ —É –∑–∞–∫–∞–∑—á–∏–∫–∞ "${x}"`:"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"}function Re(){if(!b.value?.context)return"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞.";const{stageName:g}=b.value.context;return g?`–ù–∞ —Å—Ç–∞–¥–∏–∏ "${g}" –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.`:"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞."}async function He(){if(!b.value?.context){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const g=b.value.context;await fe(g)}function Ie(g){if(!g){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),r.warning("–û—à–∏–±–∫–∞: —Ç–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");return}if(!g.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",g),r.error("–û—à–∏–±–∫–∞: ID —Ç–∏–∫–µ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω");return}try{const m=aa(g.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:g.id,iframeUrl:m}),!m||typeof m!="string"||m.length===0)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL –¥–ª—è —Ç–∏–∫–µ—Ç–∞");const c=window.open(m,"_blank","noopener,noreferrer");if(!c||c.closed||typeof c.closed>"u")try{const x=document.createElement("a");x.href=m,x.target="_blank",x.rel="noopener noreferrer",x.style.display="none",document.body.appendChild(x),x.click(),document.body.removeChild(x),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:g.id,iframeUrl:m})}catch{throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω popup blocker. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:g.id,iframeUrl:m})}catch(m){console.error("[EmployeeDetailsModal] Error opening ticket:",m),console.error("[EmployeeDetailsModal] Error details:",{message:m.message,stack:m.stack,ticket:g}),r.error("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞: "+m.message)}}function W(){Be(),u("close")}t({reloadLevel1ForStage:G});function z(g){g&&g.stopPropagation(),U.value=!U.value}function pe(){U.value&&(U.value=!1)}function Oe(g){if(!U.value)return;const m=K.value,c=P.value;m&&m.contains(g.target)||c&&c.contains(g.target)||(U.value=!1)}async function me(g){if(g.disabled){U.value=!1;return}U.value=!1,await G(g.id)}function We(g){if(U.value){g.stopPropagation(),pe();return}W()}return(g,m)=>(y(),De(vt,{to:"body"},[e.isVisible?(y(),C("div",{key:0,class:"employee-details-modal",onClick:ae(W,["self"]),onKeydown:Ge(We,["esc"])},[n("div",{class:"modal-content",onClick:Oe},[re(ze,{name:"level",mode:"out-in"},{default:ye(()=>[l.value===1?(y(),C("div",tn,[n("div",an,[n("div",sn,[n("button",{ref_key:"stageTriggerRef",ref:P,class:"stage-trigger","aria-expanded":U.value,"aria-haspopup":"listbox",onClick:ae(z,["stop"]),onKeydown:[Ge(ae(z,["prevent"]),["enter"]),Ge(ae(z,["prevent"]),["space"]),Ge(ae(pe,["stop","prevent"]),["esc"])]},[n("span",{class:"stage-color",style:ve({backgroundColor:o.value?.stageColor||$.value?.stageColorMap?.[o.value?.stageId]||$.value?.stageColorMap?.[e.stageId]||"#007bff"})},null,4),n("span",on,L(o.value?.stageName||e.stageName),1),n("span",{class:Q(["stage-caret",{open:U.value}])},"‚ñæ",2)],40,nn),U.value?(y(),C("div",{key:0,ref_key:"stageDropdownRef",ref:K,class:"stage-dropdown",role:"listbox"},[(y(!0),C(oe,null,ue(I.value,c=>(y(),C("div",{key:c.id,class:Q(["stage-option",{disabled:c.disabled}]),role:"option","aria-selected":c.disabled,onClick:ae(x=>me(c),["stop"]),onKeydown:Ge(ae(x=>me(c),["prevent"]),["enter"])},[n("span",{class:"stage-color",style:ve({backgroundColor:c.color})},null,4),n("span",rn,L(c.name),1)],42,ln))),128))],512)):V("",!0)]),n("span",cn,"–í—Å–µ–≥–æ: "+L(o.value?.totalCount||e.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),n("button",{class:"modal-close",onClick:W,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),n("div",un,[n("button",{class:Q(["view-switch-btn",{active:i.value==="employees"}]),onClick:m[0]||(m[0]=c=>i.value="employees"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"}," üë• –ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º ",2),n("button",{class:Q(["view-switch-btn",{active:i.value==="time"}]),onClick:m[1]||(m[1]=c=>i.value="time"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º"}," üìÖ –ü–æ –≤—Ä–µ–º–µ–Ω–∏ ",2),n("button",{class:Q(["view-switch-btn",{active:i.value==="departments"}]),onClick:m[2]||(m[2]=c=>i.value="departments"),title:"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º"}," üè¢ –ü–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º ",2)]),n("div",dn,[S.value?(y(),C("div",pn,[n("span",null,"–û—à–∏–±–∫–∞: "+L(S.value),1),n("button",{class:"btn-retry-stage",onClick:m[3]||(m[3]=c=>G(o.value?.stageId||e.stageId))}," –ü–æ–≤—Ç–æ—Ä–∏—Ç—å ")])):V("",!0),E.value?(y(),C("div",mn,[...m[7]||(m[7]=[n("div",{class:"loading-spinner small"},null,-1),n("span",null,"–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–¥–∏–∏...",-1)])])):V("",!0),i.value==="employees"?(y(),C("div",gn,[(o.value?.employees||e.employees).length===0&&(!(o.value?.others||e.others)||(o.value?.others||e.others).count===0)?(y(),C("div",fn," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö ")):(y(),C("div",vn,[(y(!0),C(oe,null,ue(o.value?.employees||e.employees,c=>(y(),C("div",{key:c.id,class:Q(["employee-item",{"employee-keeper":c.isKeeper}]),onClick:ae(x=>de(c,x),["stop"]),title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º"},[n("span",yn,L(c.name),1),n("div",kn,[n("div",{class:"progress-bar",style:ve({width:c.progressBarWidth+"%",backgroundColor:c.progressBarColor})},null,4)]),n("span",bn,L(c.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L(c.percentage)+"%) ",1),m[8]||(m[8]=n("span",{class:"employee-arrow"},"‚Üí",-1))],10,hn))),128)),(o.value?.others||e.others)&&(o.value?.others||e.others).count>0?(y(),C("div",Cn,[n("span",wn,"–î—Ä—É–≥–∏–µ ("+L((o.value?.others||e.others).employeeCount)+")",1),n("div",Sn,[n("div",{class:"progress-bar",style:ve({width:(o.value?.others||e.others).progressBarWidth+"%",backgroundColor:(o.value?.others||e.others).progressBarColor})},null,4)]),n("span",_n,L((o.value?.others||e.others).count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L((o.value?.others||e.others).percentage)+"%) ",1)])):V("",!0)]))])):i.value==="time"?(y(),C("div",Dn,[w.value.length===0?(y(),C("div",En," –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ")):(y(),C("div",Tn,[(y(!0),C(oe,null,ue(w.value,c=>(y(),C("div",{key:c.category,class:"category-item",onClick:ae(x=>ee(c),["stop"])},[n("span",$n,L(c.label),1),n("div",Nn,[n("div",{class:"progress-bar",style:ve({width:c.progressBarWidth+"%",backgroundColor:c.progressBarColor})},null,4)]),n("span",Mn,L(c.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L(c.percentage)+"%) ",1),m[9]||(m[9]=n("span",{class:"category-arrow"},"‚Üí",-1))],8,In))),128))]))])):i.value==="departments"?(y(),C("div",xn,[_.value.length===0?(y(),C("div",An," –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ")):(y(),C("div",Ln,[n("table",Fn,[m[11]||(m[11]=n("thead",null,[n("tr",null,[n("th",{class:"col-department"},"–ó–∞–∫–∞–∑—á–∏–∫"),n("th",{class:"col-count"},"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤"),n("th",{class:"col-action"})])],-1)),n("tbody",null,[(y(!0),C(oe,null,ue(_.value,(c,x)=>(y(),C("tr",{key:x,class:"department-row",onClick:ae(se=>Z(c),["stop"]),title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∏–∫–µ—Ç–æ–≤"},[n("td",Bn,[n("span",Rn,L(c.departmentName),1)]),n("td",Hn,[n("span",On,L(c.count),1)]),m[10]||(m[10]=n("td",{class:"col-action"},[n("span",{class:"department-arrow"},"‚Üí")],-1))],8,Pn))),128))])])]))])):V("",!0)])])):l.value===2&&p.value?(y(),C("div",Wn,[n("div",Un,[n("button",{class:"btn-back",onClick:we,"aria-label":"–ù–∞–∑–∞–¥"}," ‚Üê "),n("h3",null,L(p.value.employeeName),1),n("span",jn,"–í—Å–µ–≥–æ: "+L(p.value.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),n("button",{class:"modal-close",onClick:W,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),n("div",zn,[n("div",Vn,[n("span",Yn,L(p.value.stageName),1),n("div",Kn,[n("button",{class:Q(["level2-sort-btn",{active:d.value==="time"}]),onClick:m[4]||(m[4]=c=>d.value="time"),title:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏"}," –ü–æ –≤—Ä–µ–º–µ–Ω–∏ ",2),n("button",{class:Q(["level2-sort-btn",{active:d.value==="departments"}]),onClick:m[5]||(m[5]=c=>d.value="departments"),title:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º"}," –ü–æ –∑–∞–∫–∞–∑—á–∏–∫–∞–º ",2)])]),d.value==="time"?(y(),C("div",Gn,[p.value.dateCategories.length===0?(y(),C("div",Xn," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–∫–µ—Ç–∞—Ö ")):(y(),C("div",qn,[(y(!0),C(oe,null,ue(p.value.dateCategories,c=>(y(),C("div",{key:c.category,class:"category-item",onClick:ae(x=>Pe(c),["stop"])},[n("span",Zn,L(c.label),1),n("div",Qn,[n("div",{class:"progress-bar",style:ve({width:c.progressBarWidth+"%",backgroundColor:c.progressBarColor})},null,4)]),n("span",eo,L(c.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L(c.percentage)+"%) ",1)],8,Jn))),128))]))])):(y(),C("div",to,[!p.value.departments||p.value.departments.length===0?(y(),C("div",ao,[m[12]||(m[12]=_e(" –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∑–∞–∫–∞–∑—á–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ",-1)),n("button",{class:"btn-retry-stage",onClick:m[6]||(m[6]=c=>de({id:p.value.employeeId,name:p.value.employeeName}))}," –û–±–Ω–æ–≤–∏—Ç—å ")])):(y(),C("div",so,[n("table",no,[m[14]||(m[14]=n("thead",null,[n("tr",null,[n("th",{class:"col-department"},"–ó–∞–∫–∞–∑—á–∏–∫"),n("th",{class:"col-count"},"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤"),n("th",{class:"col-action"})])],-1)),n("tbody",null,[(y(!0),C(oe,null,ue(p.value.departments,(c,x)=>(y(),C("tr",{key:x,class:"department-row",onClick:ae(se=>Ye(c),["stop"]),title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∏–∫–µ—Ç–æ–≤"},[n("td",lo,[n("span",ro,L(c.departmentName),1)]),n("td",io,[n("span",co,L(c.count),1)]),m[13]||(m[13]=n("td",{class:"col-action"},[n("span",{class:"department-arrow"},"‚Üí")],-1))],8,oo))),128))])])]))]))])])):l.value===3&&v.value?(y(),C("div",uo,[n("div",po,[n("button",{class:"btn-back",onClick:we,"aria-label":"–ù–∞–∑–∞–¥"}," ‚Üê "),n("div",mo,[n("h3",null,L(v.value.employeeName),1),n("div",go,[n("span",fo,L(v.value.dateCategoryLabel),1),n("span",vo,L(v.value.stageName),1)])]),n("span",ho,"–í—Å–µ–≥–æ: "+L(v.value.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),n("button",{class:"modal-close",onClick:W,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),n("div",yo,[v.value.departments.length===0?(y(),C("div",ko," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑—á–∏–∫–∞—Ö ")):(y(),C("div",bo,[n("table",Co,[m[16]||(m[16]=n("thead",null,[n("tr",null,[n("th",{class:"col-department"},"–ó–∞–∫–∞–∑—á–∏–∫"),n("th",{class:"col-count"},"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤"),n("th",{class:"col-action"})])],-1)),n("tbody",null,[(y(!0),C(oe,null,ue(v.value.departments,(c,x)=>(y(),C("tr",{key:x,class:"department-row",onClick:ae(se=>J(c),["stop"]),title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∏–∫–µ—Ç–æ–≤"},[n("td",So,[n("span",_o,L(c.departmentName),1)]),n("td",Do,[n("span",Eo,L(c.count),1)]),m[15]||(m[15]=n("td",{class:"col-action"},[n("span",{class:"department-arrow"},"‚Üí")],-1))],8,wo))),128))])])]))])])):l.value===4&&b.value?(y(),C("div",To,[n("div",Io,[n("button",{class:"btn-back",onClick:we,"aria-label":"–ù–∞–∑–∞–¥"}," ‚Üê "),n("div",$o,[n("h3",null,L(T.value),1),b.value.context?(y(),C("div",No,[b.value.context.dateCategoryLabel?(y(),C("span",Mo,L(b.value.context.dateCategoryLabel),1)):V("",!0),b.value.context.departmentName?(y(),C("span",xo,L(b.value.context.departmentName),1)):V("",!0),n("span",Ao,L(b.value.context.stageName),1)])):V("",!0)]),n("span",Lo,"–í—Å–µ–≥–æ: "+L(b.value.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),n("button",{class:"modal-close",onClick:W,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),n("div",Fo,[re(ze,{name:"loading",mode:"out-in"},{default:ye(()=>[b.value.isLoading?(y(),C("div",Po,[...m[17]||(m[17]=[n("div",{class:"loading-spinner"},null,-1),n("p",null,"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤...",-1)])])):b.value.error&&b.value.error.hasFallback?(y(),C("div",Bo,[m[18]||(m[18]=n("div",{class:"error-banner"},[n("span",{class:"error-icon"},"‚ö†Ô∏è"),n("span",{class:"error-message"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞.")],-1)),n("div",Ro,[re(it,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(y(!0),C(oe,null,ue(b.value.tickets,(c,x)=>(y(),De(pt,{key:c.id,ticket:c,draggable:!1,style:ve({"--ticket-index":x}),onClick:se=>Ie(c)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):b.value.error&&!b.value.error.hasFallback?(y(),C("div",Ho,[m[19]||(m[19]=n("div",{class:"error-icon"},"‚ùå",-1)),m[20]||(m[20]=n("h3",{class:"error-title"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö",-1)),n("p",Oo,L(b.value.error.message),1),n("button",{class:"btn-retry",onClick:He},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])):!b.value.tickets||b.value.tickets.length===0?(y(),C("div",Wo,[m[21]||(m[21]=n("div",{class:"empty-state-icon"},"üì≠",-1)),n("h3",Uo,L(Se()),1),n("p",jo,L(Re()),1)])):(y(),C("div",zo,[re(it,{name:"ticket",tag:"div",class:"tickets-list"},{default:ye(()=>[(y(!0),C(oe,null,ue(b.value.tickets,(c,x)=>(y(),De(pt,{key:c.id,ticket:c,draggable:!1,style:ve({"--ticket-index":x}),onClick:se=>Ie(c)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):V("",!0)]),_:1})])],32)):V("",!0)]))}},Yo=ke(Vo,[["__scopeId","data-v-65ca978e"]]);function Ko(e,t,s=.5){if(!t||!Array.isArray(t)||t.length===0||typeof e!="number"||e<0)return 0;(typeof s!="number"||s<=0)&&(console.warn("getOverlapCount: threshold –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 0.5"),s=.5);const a=[];if(t.forEach((l,d)=>{if(!l||!l.data||!Array.isArray(l.data))return;const i=l.data[e];i!=null&&!isNaN(i)&&a.push({datasetIndex:d,value:Number(i),y:Number(i)})}),a.length<2)return 0;const u=[];return a.forEach(l=>{let d=!1;for(const i of u){const o=i.y;if(Math.abs(l.y-o)<s){i.points.push(l),i.y=i.points.reduce((_,p)=>_+p.y,0)/i.points.length,d=!0;break}}d||u.push({points:[l],y:l.y})}),u.length===0?0:u.reduce((l,d)=>d.points.length>l.points.length?d:l,u[0]).points.length}function Go(e,t){const s=[];return e.forEach(a=>{let u=!1;for(const r of s){const l=r.y;if(Math.abs(a.value-l)<t){r.points.push(a),r.y=r.points.reduce((d,i)=>d+i.value,0)/r.points.length,u=!0;break}}u||s.push({points:[a],y:a.value})}),s}function Xo(e,t=.5){if(!e)return console.warn("findOverlappingPoints: chart –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω"),[];if(!e.config||e.config.type!=="line")return[];const s=e.data?.datasets,a=e.data?.labels||[];if(!s||!Array.isArray(s)||s.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 0.5"),t=.5);const u=[];return a.forEach((r,l)=>{try{if(Ko(l,s,t)<2)return;const i=[];if(s.forEach((v,b)=>{if(!v||!v.data||!Array.isArray(v.data))return;const $=v.data[l];$==null||isNaN($)||i.push({datasetIndex:b,value:Number($),label:v.label||`Dataset ${b}`})}),i.length<2)return;const o=Go(i,t);if(o.length===0)return;const w=o.reduce((v,b)=>b.points.length>v.points.length?b:v,o[0]);if(w.points.length<2)return;let _=null,p=null;for(let v=0;v<s.length;v++)try{const b=e.getDatasetMeta(v);if(b&&b.data&&b.data[l]){_=b,p=b.data[l];break}}catch{continue}if(!p||typeof p.x!="number"||typeof p.y!="number")return;u.push({position:l,count:w.points.length,x:p.x,y:p.y,value:w.y,points:w.points.map(v=>({datasetIndex:v.datasetIndex,value:v.value,label:v.label}))})}catch(d){console.warn(`findOverlappingPoints: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–∑–∏—Ü–∏–∏ ${l}:`,d)}}),u}function qo(e,t){const s=[];return e.forEach(a=>{let u=!1;for(const r of s){const l=r.y;if(Math.abs(a.y-l)<t){r.points.push(a),r.y=r.points.reduce((d,i)=>d+i.y,0)/r.points.length,u=!0;break}}u||s.push({points:[a],y:a.y})}),s}function Jo(e,t,s=.5){if(!e)return console.warn("calculatePointJitter: chart –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω"),[];if(!e.config||e.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º"),[];(typeof s!="number"||s<=0)&&(console.warn("calculatePointJitter: threshold –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 0.5"),s=.5);const a=e.data?.datasets,u=e.data?.labels||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(u)||t>=u.length)return[];const r=[];if(a.forEach((o,w)=>{if(!o||!o.data||!Array.isArray(o.data))return;const _=o.data[t];if(!(_==null||isNaN(_)))try{const p=e.getDatasetMeta(w);if(p&&p.data&&p.data[t]){const v=p.data[t];v&&typeof v.x=="number"&&typeof v.y=="number"&&r.push({datasetIndex:w,value:Number(_),x:v.x,y:v.y})}}catch(p){console.warn(`calculatePointJitter: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ meta –¥–ª—è dataset ${w}:`,p)}}),r.length===0)return[];const l=qo(r,s),d=[];l.forEach(o=>{const w=o.points||[];w.length>1?w.forEach((p,v)=>{const b=(v-(w.length-1)/2)*4;d.push({datasetIndex:p.datasetIndex,jitterX:b,value:p.value})}):w.length===1&&d.push({datasetIndex:w[0].datasetIndex,jitterX:0,value:w[0].value})});const i=new Set(d.map(o=>o.datasetIndex));return r.forEach(o=>{i.has(o.datasetIndex)||d.push({datasetIndex:o.datasetIndex,jitterX:0,value:o.value})}),d}const Zo=.5,ft=6,Qo=2;function el(e){return typeof e!="number"||e<2?ft:ft+(e-1)*Qo}function tl(e,t){if(!e||!e.ctx){console.warn("drawEnlargedPoint: chart –∏–ª–∏ ctx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã overlap",t);return}const s=t.count;if(typeof s!="number"||s<2)return;const a=e.ctx,{x:u,y:r,points:l}=t,d=el(s);if(a.canvas){a.save();try{a.beginPath(),a.arc(u,r,d,0,2*Math.PI);let o="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&e.data&&e.data.datasets){const w=l[0].datasetIndex,_=e.data.datasets[w];if(_&&_.pointBackgroundColor){const p=Array.isArray(_.pointBackgroundColor)?_.pointBackgroundColor[t.position]||_.pointBackgroundColor[0]:_.pointBackgroundColor;if(p)if(p.startsWith("#")){const v=parseInt(p.slice(1,3),16),b=parseInt(p.slice(3,5),16),$=parseInt(p.slice(5,7),16);o=`rgba(${v}, ${b}, ${$}, 0.4)`}else p.startsWith("rgba")?o=p.replace(/rgba?\(([^)]+)\)/,(v,b)=>{const $=b.split(",").map(E=>E.trim());return`rgba(${$[0]}, ${$[1]}, ${$[2]}, 0.4)`}):o=p+"66"}}a.fillStyle=o,a.fill(),a.strokeStyle=o.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(o){console.warn("drawEnlargedPoint: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏:",o)}finally{a.restore()}}}const al={id:"overlappingPointsPlugin",afterDatasetsDraw:e=>{if(!(!e||!e.config||e.config.type!=="line")&&e.ctx)try{const t=Xo(e,Zo);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{tl(e,a)}catch(u){console.warn(`overlappingPointsPlugin: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ ${a.position}:`,u)}})}catch(t){console.warn("overlappingPointsPlugin: –æ—à–∏–±–∫–∞ –≤ afterDatasetsDraw:",t)}}},sl=.5,nl={id:"pointJitterPlugin",beforeDatasetsDraw:e=>{if(!(!e||!e.config||e.config.type!=="line")){e._jitterData||(e._jitterData={});try{const t=e.data?.datasets,s=e.data?.labels||[];if(!t||!Array.isArray(t)||t.length===0||!Array.isArray(s)||s.length===0)return;e._jitterData={},s.forEach((a,u)=>{const r=Jo(e,u,sl);r&&r.length>0&&r.forEach(l=>{const d=`${l.datasetIndex}_${u}`;e._jitterData[d]=l.jitterX})})}catch(t){console.warn("pointJitterPlugin: –æ—à–∏–±–∫–∞ –≤ beforeDatasetsDraw:",t)}}},afterDatasetsDraw:e=>{if(!(!e||!e.config||e.config.type!=="line")&&e.ctx&&!(!e._jitterData||Object.keys(e._jitterData).length===0))try{const t=e.ctx,s=e.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((a,u)=>{const r=e.getDatasetMeta(u);!r||r.hidden||!a.data||!Array.isArray(a.data)||a.data.forEach((l,d)=>{const i=r.data[d];if(!i||typeof i.x!="number"||typeof i.y!="number"||l==null||isNaN(l))return;const o=`${u}_${d}`,w=e._jitterData[o];if(!(w===void 0||w===0)){t.save();try{const _=a.pointStyle||"circle",p=(a.pointRadius||7)+1,v=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[d]||a.pointBackgroundColor[0]:a.pointBackgroundColor,b=Array.isArray(a.pointBorderColor)?a.pointBorderColor[d]||a.pointBorderColor[0]:a.pointBorderColor,$=a.pointBorderWidth||1,E=i.x+w,S=i.y;switch(t.fillStyle=v||"#007bff",t.strokeStyle=b||"#ffffff",t.lineWidth=$,t.beginPath(),_){case"circle":t.arc(E,S,p,0,2*Math.PI);break;case"triangle":t.moveTo(E,S-p),t.lineTo(E-p,S+p),t.lineTo(E+p,S+p),t.closePath();break;case"rect":case"rectRounded":const F=p*1.4;t.rect(E-F/2,S-F/2,F,F);break;case"rectRot":const U=p*1.4;t.moveTo(E,S-U/2),t.lineTo(E+U/2,S),t.lineTo(E,S+U/2),t.lineTo(E-U/2,S),t.closePath();break;case"star":const K=p;for(let T=0;T<5;T++){const H=T*4*Math.PI/5-Math.PI/2,O=E+K*Math.cos(H),G=S+K*Math.sin(H);T===0?t.moveTo(O,G):t.lineTo(O,G)}t.closePath();break;case"cross":const P=p;t.moveTo(E-P,S-P),t.lineTo(E+P,S+P),t.moveTo(E+P,S-P),t.lineTo(E-P,S+P);break;case"crossRot":const I=p;t.moveTo(E-I,S),t.lineTo(E+I,S),t.moveTo(E,S-I),t.lineTo(E,S+I);break;default:t.arc(E,S,p,0,2*Math.PI)}_!=="cross"&&_!=="crossRot"&&t.fill(),t.stroke(),i._originalX||(i._originalX=i.x,i._originalY=i.y),i._jitterX=w,i._jitteredX=E,i._jitteredY=S}catch(_){console.warn(`pointJitterPlugin: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —Ç–æ—á–∫–∏ ${u}_${d}:`,_)}finally{t.restore()}}})})}catch(t){console.warn("pointJitterPlugin: –æ—à–∏–±–∫–∞ –≤ afterDatasetsDraw:",t)}},afterDraw:e=>{e._jitterData}},ol={id:"pointLabelsPlugin",afterDatasetsDraw:e=>{if(!(!e||!e.config||e.config.type!=="line")&&e.ctx)try{const t=e.ctx,s=e.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((a,u)=>{const r=e.getDatasetMeta(u);if(!r||r.hidden||!a.data||!Array.isArray(a.data))return;const l=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[0]||"#6b7280":a.pointBackgroundColor||"#6b7280";a.data.forEach((d,i)=>{const o=r.data[i];if(!o||typeof o.x!="number"||typeof o.y!="number"||d==null||isNaN(d))return;const w=o._jitteredX!==void 0?o._jitteredX:o.x,_=o._jitteredY!==void 0?o._jitteredY:o.y,p=w+8,v=_-5,b=String(Math.round(d));t.save();try{t.font="11px Arial, sans-serif",t.textAlign="left",t.textBaseline="middle";const E=t.measureText(b).width,S=11,F=3,U=p-F,K=v-S/2-F,P=E+F*2,I=S+F*2;t.fillStyle="rgba(255, 255, 255, 0.95)",t.fillRect(U,K,P,I),t.strokeStyle="rgba(0, 0, 0, 0.1)",t.lineWidth=1,t.strokeRect(U,K,P,I),t.fillStyle=l,t.font="11px Arial, sans-serif",t.textAlign="left",t.textBaseline="middle",t.fillText(b,p,v)}catch($){console.warn(`pointLabelsPlugin: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —Ç–æ—á–∫–∏ ${u}_${i}:`,$)}finally{t.restore()}})})}catch(t){console.warn("pointLabelsPlugin: –æ—à–∏–±–∫–∞ –≤ afterDatasetsDraw:",t)}}},ll={class:"graph-state-chart"},rl={class:"chart-header"},il={class:"chart-type-selector"},cl=["onClick","title"],ul={class:"chart-type-icon"},dl={class:"chart-type-label"},pl={key:0,class:"comparison-type-selector"},ml={class:"radio-group"},gl={key:0},fl={key:1},vl={key:2,class:"graph-legend"},hl={key:4,class:"error-container"},yl={class:"error-message"},kl={class:"chart-wrapper"},bl={class:"chart-canvas-container"},Cl={key:0,class:"bar-chart-stage-labels"},wl={key:6,class:"no-data"},Sl={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(e,{emit:t}){const s=(k,f)=>typeof window>"u"?f:getComputedStyle(document.documentElement).getPropertyValue(k).trim()||f,a=e,u=t,r=M(!1),l=M(null),d=M(null),i=M({weekStart:null,weekEnd:null,current:null}),o=M(null),w=M("weekStartToWeekEnd"),_=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],p=M("line"),v=M(!1),b=M(""),$=M(""),E=M(0),S=M([]),F=M(null),U=M(null),K=M(null),P=M(null),I=M([]),T=te(()=>{switch(p.value){case"line":return ct;case"bar":return Xt;case"doughnut":return Gt;default:return ct}}),H={formed:s("--b24-primary","#007bff"),review:s("--b24-warning","#ffc107"),execution:s("--b24-success","#28a745")},O=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:H.formed},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:H.review},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:H.execution}],G=te(()=>O.reduce((k,f)=>(k[f.id]=f.name,k),{})),J=["circle","triangle","rect","rectRot","star","cross","crossRot"],Z=M({formed:!0,review:!0,execution:!0}),ee=et(),de={id:"employeeLabelsPlugin",afterDatasetsDraw:k=>{if(k.config.type==="bar")try{const f=k.ctx;if(!k.data||!k.data.datasets)return;const D=k.data.datasets,N=k.scales.y;D.forEach((R,h)=>{const A=k.getDatasetMeta(h);if(!A||A.hidden)return;const j=R.label||"";if(!j||j.includes("–î—Ä—É–≥–∏–µ"))return;const Y=j.trim().split(/\s+/);let X="";if(Y.length===1)X=Y[0];else{const q=Y[0],ne=Y.slice(1).join(" ");X=`${q}
${ne}`}const ie=X.split(`
`);R.data.forEach((q,ne)=>{if(q===0||!q)return;const ce=A.data[ne];if(!ce||typeof ce.x!="number"||typeof ce.y!="number")return;const le=ce.x,Ne=ce.y+ce.height+25;f.save(),f.font="bold 9px Arial, sans-serif",f.fillStyle="#6b7280",f.textAlign="center",f.textBaseline="top",f.translate(le,Ne),f.rotate(-12*Math.PI/180),ie.forEach((At,Lt)=>{const rt=At.trim();rt&&f.fillText(rt,0,Lt*11)}),f.restore()})})}catch(f){console.error("Error in employeeLabelsPlugin:",f)}}},Ye={id:"doughnutCenterTextPlugin",afterDraw:k=>{if(k.config.type!=="doughnut")return;const{ctx:f,chartArea:D,width:N,height:R}=k;if(!k.data||!k.data.datasets||k.data.datasets.length===0)return;const A=k.data.datasets[0].meta?.totals?.overall??null;if(A===null||typeof A>"u")return;const j=["–í—Å–µ–≥–æ –≤ —Å–µ–∫—Ç–æ—Ä–µ 1–°","—Ç–∏–∫–µ—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ:",`${A}`];f.save(),f.font='600 16px "Roboto", sans-serif',f.fillStyle=s("--b24-text-primary","#1f2937"),f.textAlign="center",f.textBaseline="middle";const Y=(D.left+D.right)/2,X=(D.top+D.bottom)/2,ie=18,q=ie*j.length,ne=X-q/2+4;j.forEach((ce,le)=>{le===j.length-1&&`${ce}`.length>4?f.font='700 18px "Roboto", sans-serif':f.font='600 16px "Roboto", sans-serif',f.fillText(ce,Y,ne+le*ie)}),f.restore()}};he.register(de),he.register(Ye);function Pe(){const k=new Map;[i.value.weekStart,i.value.weekEnd,i.value.current].forEach(f=>{!f||!f.statistics||!f.statistics.employees||f.statistics.employees.forEach(D=>{k.has(D.id)||k.set(D.id,{id:D.id,name:D.name})})}),I.value=Array.from(k.values()).sort((f,D)=>f.name.localeCompare(D.name))}function fe(k,f="background"){return{increase:{background:s("--b24-success","#28a745"),border:s("--b24-success-hover","#218838"),point:s("--b24-success","#28a745")},decrease:{background:s("--b24-danger","#dc3545"),border:s("--b24-danger-hover","#c82333"),point:s("--b24-danger","#dc3545")},stable:{background:s("--b24-text-muted","#9ca3af"),border:s("--b24-text-secondary","#6b7280"),point:s("--b24-text-muted","#9ca3af")}}[k]?.[f]||s("--b24-text-secondary","#6c757d")}function we(){if(!(!i.value.weekStart||!i.value.weekEnd))try{const k=at.compareTwoSnapshots(i.value.weekStart,i.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let f=null,D=null;i.value.current&&(f=at.compareTwoSnapshots(i.value.weekEnd,i.value.current,{includeTickets:!1,includeEmployees:!0}),D=at.compareTwoSnapshots(i.value.weekStart,i.value.current,{includeTickets:!1,includeEmployees:!0})),o.value={weekStartToWeekEnd:k,weekEndToCurrent:f,weekStartToCurrent:D}}catch(k){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",k),ee.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+k.message)}}function Be(k){return k?k.replace(/\s*\(\d+\)\s*$/,"").trim():""}function Se(k){const f=Be(k);return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[f]||"formed"}function Re(k){return Se(k)}function He(k){return k===0?"weekStart":k===1?"weekEnd":k===2?"current":"weekEnd"}function Ie(k,f,D,N,R=null,h=null,A=null,j=null){console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:k,stageId:f,totalCount:D,employeesCount:N?.length||0,hasSnapshot:!!h,snapshotTicketIds:h?.ticketIds?.length||0}),b.value=k,$.value=f||"",E.value=D,S.value=N||[],F.value=R&&R.count>0?R:null,U.value=h,K.value=A,P.value=j,v.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:$.value,hasCurrentSnapshot:!!U.value})}async function W(k,f,D){console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:k,timePoint:f,hasMeta:!!D});const N=O.find(h=>h.id===k);if(!N){console.warn("[GraphStateChart] Stage not found:",k);return}const R={graphType:"line",stageId:k,stageName:N.name,timePoint:f,snapshots:i.value,meta:{line:D||null,doughnut:d.value?.datasets?.[0]?.meta||null},stageColorMap:H,stageNameMap:G.value};try{const h=await xt({stageId:k,graphType:"line",timePoint:f,snapshots:i.value,meta:{line:D||null,doughnut:d.value?.datasets?.[0]?.meta||null},stageColorMap:H,stageNameMap:G.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:h.stageName,stageId:k,totalCount:h.totalCount,employeesCount:h.employees?.length||0,hasSnapshot:!!h.snapshot}),Ie(h.stageName,k,h.totalCount,h.employees,h.others,h.snapshot,null,R)}catch(h){console.error("[GraphStateChart] Failed to open modal for line point:",h),ee.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ø–∞–ø –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞")}}function z(k,f){if(!f||!f.employees||f.employees.length===0){ee.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞");return}const D=i.value.current||i.value.weekEnd||i.value.weekStart,N={graphType:"doughnut",stageId:k,stageName:f.stageName,snapshots:i.value,meta:{doughnut:d.value?.datasets?.[0]?.meta||null},stageColorMap:H,stageNameMap:G.value};Ie(f.stageName,k,f.totalCount,f.employees,f.others,D,null,N)}function pe(){v.value=!1,b.value="",$.value="",E.value=0,S.value=[],F.value=null,U.value=null,K.value=null}async function Oe(k,f,D){if(p.value!=="line"||f.length===0)return;const N=f[0],R=N.datasetIndex,h=N.index,A=D.data.datasets[R];if(!A)return;const j=Re(A.label),Y=He(h);await W(j,Y,A.meta||null)}function me(k,f,D){if(p.value!=="doughnut"||f.length===0)return;const R=f[0].index,h=D.data,A=h.labels[R],j=Re(A),X=h.datasets[0]?.meta?.employees?.[j];if(!X){console.warn("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–∞–ø–∞:",j);return}z(j,X)}function We(k){const f=O[k];if(!f)return 0;const D=i.value.current||i.value.weekEnd||i.value.weekStart;return!D||!D.statistics||!D.statistics.stages?0:D.statistics.stages[f.id]?.count||0}function g(k){const f=O.find(R=>R.id===k);if(!f)return"";const D=i.value.current||i.value.weekEnd||i.value.weekStart;if(!D||!D.statistics||!D.statistics.stages)return f.name;const N=D.statistics.stages[k]?.count||0;return`${f.name} (${N})`}const m=te(()=>{if(!d.value)return null;if(p.value==="doughnut"||p.value==="bar")return d.value;const k=d.value.datasets.filter(f=>{const D=O.find(N=>N.name===f.label);return D?Z.value[D.id]:!0});return{...d.value,datasets:k}});te(()=>p.value!=="bar"||!d.value||!d.value.meta?null:d.value.meta.employeesByStage||null);const c=te(()=>{const k={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:p.value==="bar"?{bottom:80}:{}},onClick:(f,D,N)=>{p.value==="line"?Oe(f,D,N):p.value==="doughnut"&&me(f,D,N)},onHover:(f,D,N)=>{p.value==="doughnut"&&(f.native.target.style.cursor=D.length>0?"pointer":"default")},plugins:{legend:{display:p.value!=="bar",position:p.value==="doughnut"?"right":"top",labels:{font:{size:p.value==="doughnut"?14:12,weight:p.value==="doughnut"?"600":"500"},boxWidth:p.value==="doughnut"?18:12,boxHeight:p.value==="doughnut"?18:12,padding:p.value==="doughnut"?14:10},onClick:(f,D,N)=>{if(p.value==="bar"){const h=D.datasetIndex;if(h!==void 0){const A=N.chart.getDatasetMeta(h);A.hidden=!A.hidden,N.chart.update()}return}const R=D.datasetIndex;if(R!==void 0){const h=N.chart.getDatasetMeta(R);h.hidden=!h.hidden,N.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:f=>{if(p.value==="bar"){const D=f[0].dataIndex,N=O[D];return N?N.name:""}return f[0].label||""},label:f=>{const D=f.dataset.label||"",N=f.parsed.y||f.parsed||0,R=f.dataIndex;if(p.value==="bar"){const h=f.dataset,A=f.dataIndex,j=O[A],Y=j?j.name:"";return`${h.label}: ${N} —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ "${Y}"`}if(p.value==="doughnut"){const h=f.dataset.data.reduce((j,Y)=>j+Y,0),A=h>0?(N/h*100).toFixed(1):0;return`${D}: ${N} —Ç–∏–∫–µ—Ç–æ–≤ (${A}%)`}else{if(!o.value||R===0)return`${D}: ${N} —Ç–∏–∫–µ—Ç–æ–≤`;let h=null;const A=Se(D);if(w.value==="weekStartToWeekEnd"&&R===1?h=o.value.weekStartToWeekEnd?.stages?.[A]:w.value==="weekEndToCurrent"&&R===2&&i.value.current?h=o.value.weekEndToCurrent?.stages?.[A]:w.value==="weekStartToCurrent"&&R===2&&i.value.current&&(h=o.value.weekStartToCurrent?.stages?.[A]),!h)return`${D}: ${N} —Ç–∏–∫–µ—Ç–æ–≤`;const j=h.delta,Y=h.deltaPercent,X=h.trend;let ie=`${D}: ${N} —Ç–∏–∫–µ—Ç–æ–≤`;if(j!==0){const q=j>0?"+":"",ne=X==="increase"?"‚Üë":X==="decrease"?"‚Üì":"‚Üí";ie+=` (${q}${j}, ${q}${Y.toFixed(1)}%) ${ne}`}else ie+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return ie}},afterBody:f=>{if(p.value==="bar"&&f.length>0){const h=f[0];h.dataset;const A=h.parsed.y||0,j=h.dataIndex,Y=We(j);return[`${Y>0?(A/Y*100).toFixed(1):0}% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç—Ç–∞–ø–∞`]}if(p.value==="doughnut"&&f.length>0)return["–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"];if(p.value==="line"){const h=[];if(o.value){const A=f[0].dataIndex;if(A!==0){let j=null;if(Se(f[0].dataset.label||""),w.value==="weekStartToWeekEnd"&&A===1?j=o.value.weekStartToWeekEnd:w.value==="weekEndToCurrent"&&A===2?j=o.value.weekEndToCurrent:w.value==="weekStartToCurrent"&&A===2&&(j=o.value.weekStartToCurrent),j&&j.metadata){const Y=j.metadata.timeDiff;h.push(`–ü–µ—Ä–∏–æ–¥: ${Y.days} –¥–Ω. ${Y.hours} —á. ${Y.minutes} –º–∏–Ω.`)}}}return h.push("–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"),h}if(!o.value)return[];const D=f[0].dataIndex;if(D===0)return[];let N=null;if(Se(f[0].dataset.label||""),w.value==="weekStartToWeekEnd"&&D===1?N=o.value.weekStartToWeekEnd:w.value==="weekEndToCurrent"&&D===2?N=o.value.weekEndToCurrent:w.value==="weekStartToCurrent"&&D===2&&(N=o.value.weekStartToCurrent),!N||!N.metadata)return[];const R=N.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${R.days} –¥–Ω. ${R.hours} —á. ${R.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return p.value==="line"||p.value==="bar"?{...k,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:p.value==="doughnut"?{...k,cutout:"60%"}:k});function x(k){const f=new Date(k),D=f.getFullYear(),N=String(f.getMonth()+1).padStart(2,"0"),R=String(f.getDate()).padStart(2,"0");return`${D}-${N}-${R}`}function se(k){const{current:f,weekEnd:D}=k,N=f||D;if(!N||!N.statistics||!N.statistics.stages)return null;const R=[],h=[],A=[],j=[],Y={},X={};if(O.forEach(q=>{const ne=N.statistics.stages[q.id]?.count||0;if(ne>0){R.push(`${q.name} (${ne})`),h.push(ne),A.push(q.color+"80"),j.push(q.color),X[q.id]=ne;const ce=Xs(q.id,N,O);ce&&ce.employees&&(Y[q.id]=ce)}}),h.length===0)return null;const ie=h.reduce((q,ne)=>q+ne,0);return{labels:R,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:h,backgroundColor:A,borderColor:j,borderWidth:2,meta:{employees:Y,totals:{overall:ie,stages:X}}}]}}function be(k){if(p.value==="doughnut")return se(k);if(p.value==="bar"){const A=a.showCurrentState&&k.current?"current":k.weekEnd?"weekEnd":"weekStart";return Gs(k,A,O)}const{weekStart:f,weekEnd:D,current:N}=k,R=[],h=[];return O.forEach((A,j)=>{const Y=[];if(f&&f.statistics&&f.statistics.stages){const le=f.statistics.stages[A.id];if(R.length===0){const Ne=f.metadata?.createdAt?new Date(f.metadata.createdAt):null;R.push(Ne?x(Ne):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}Y.push(le?.count||0)}else R.length===0&&R.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),Y.push(0);if(D&&D.statistics&&D.statistics.stages){const le=D.statistics.stages[A.id];if(R.length===1){const Ne=D.metadata?.createdAt?new Date(D.metadata.createdAt):null;R.push(Ne?x(Ne):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}Y.push(le?.count||0)}else R.length===1&&R.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),Y.push(0);if(N&&a.showCurrentState&&N.statistics&&N.statistics.stages){const le=N.statistics.stages[A.id];R.length===2&&R.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),Y.push(le?.count||0)}const X=["stable"];o.value?w.value==="weekStartToWeekEnd"?(X.push(o.value.weekStartToWeekEnd?.stages?.[A.id]?.trend||"stable"),N&&X.push(o.value.weekStartToCurrent?.stages?.[A.id]?.trend||"stable")):w.value==="weekEndToCurrent"&&N?(X.push("stable"),X.push(o.value.weekEndToCurrent?.stages?.[A.id]?.trend||"stable")):w.value==="weekStartToCurrent"&&N?(X.push(o.value.weekStartToWeekEnd?.stages?.[A.id]?.trend||"stable"),X.push(o.value.weekStartToCurrent?.stages?.[A.id]?.trend||"stable")):(X.push("stable"),N&&X.push("stable")):(X.push("stable"),N&&X.push("stable"));let ie,q,ne;o.value&&p.value!=="doughnut"?(ie=X.map(le=>fe(le,"background")+"40"),q=X.map(le=>fe(le,"border")),ne=X.map(le=>fe(le,"point"))):(ie=A.color+"40",q=A.color,ne=A.color);let ce=null;p.value==="line"&&(ce={employees:Ks(A.id,k)}),h.push({label:A.name,data:Y,backgroundColor:(Array.isArray(ie),ie),borderColor:(Array.isArray(q),q),borderWidth:2,...p.value==="line"&&{pointStyle:J[j%J.length]},pointBackgroundColor:(Array.isArray(ne),ne),pointBorderColor:(Array.isArray(q),q),pointRadius:7,pointHoverRadius:10,fill:p.value!=="line",tension:p.value==="line"?.4:0,meta:ce})}),R.length===0&&(R.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),a.showCurrentState&&R.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:R,datasets:h}}const $e=async()=>{r.value=!0,l.value=null;try{const k=a.period?.endDate?new Date(a.period.endDate):new Date,f=a.period?.startDate?new Date(a.period.startDate):Ae.getWeekStartDate(k),D=a.period?.endDate?new Date(a.period.endDate):Ae.getWeekEndDate(k),N=Ae.formatDate(f),R=Ae.formatDate(D),[h,A]=await Promise.all([Ae.getSnapshot(N,"week_start"),Ae.getSnapshot(R,"week_end")]);let j=null;a.showCurrentState&&(j=await ht.getSectorDataForSnapshot({useCache:!1,normalize:!0})),i.value={weekStart:h,weekEnd:A,current:j},Pe(),we(),B(),u("data-loaded",{weekStart:h,weekEnd:A,current:j})}catch(k){console.error("Error loading chart data:",k),l.value=k.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",ee.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+l.value),u("error",l.value)}finally{r.value=!1}};Ee(()=>{he.register(al),he.register(nl),he.register(ol),$e()});function Ke(k){Z.value=k}const B=()=>{const k=be({weekStart:i.value.weekStart,weekEnd:i.value.weekEnd,current:i.value.current});if(!d.value||!d.value.labels||d.value.labels.length!==k?.labels?.length)d.value=k;else if(k){const f=JSON.stringify(d.value),D=JSON.stringify(k);f!==D&&(d.value=k)}};return Le(()=>[a.period,a.showCurrentState],()=>{$e()},{deep:!0}),Le(p,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&B()}),Le(w,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&B()}),(k,f)=>(y(),C("div",ll,[n("div",rl,[f[3]||(f[3]=n("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),n("div",il,[(y(),C(oe,null,ue(_,D=>n("button",{key:D.value,onClick:N=>p.value=D.value,class:Q(["chart-type-btn",{active:p.value===D.value}]),title:D.label},[n("span",ul,L(D.icon),1),n("span",dl,L(D.label),1)],10,cl)),64))])]),!r.value&&!l.value&&o.value&&p.value!=="doughnut"?(y(),C("div",pl,[f[7]||(f[7]=n("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),n("div",ml,[n("label",null,[Je(n("input",{type:"radio","onUpdate:modelValue":f[0]||(f[0]=D=>w.value=D),value:"weekStartToWeekEnd",onChange:B},null,544),[[tt,w.value]]),f[4]||(f[4]=n("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),i.value.current?(y(),C("label",gl,[Je(n("input",{type:"radio","onUpdate:modelValue":f[1]||(f[1]=D=>w.value=D),value:"weekEndToCurrent",onChange:B},null,544),[[tt,w.value]]),f[5]||(f[5]=n("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):V("",!0),i.value.current?(y(),C("label",fl,[Je(n("input",{type:"radio","onUpdate:modelValue":f[2]||(f[2]=D=>w.value=D),value:"weekStartToCurrent",onChange:B},null,544),[[tt,w.value]]),f[6]||(f[6]=n("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):V("",!0)])])):V("",!0),!r.value&&!l.value&&d.value?(y(),De(xs,{key:1,stages:O,selected:Z.value,"onUpdate:selected":Ke,onChange:B},null,8,["selected"])):V("",!0),!r.value&&!l.value&&o.value&&p.value!=="doughnut"?(y(),C("div",vl,[...f[8]||(f[8]=[Yt('<h4 class="legend-title" data-v-cbba196a>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):V("",!0),r.value?(y(),De(bt,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):l.value?(y(),C("div",hl,[n("p",yl,"‚ùå "+L(l.value),1),n("button",{onClick:$e,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):m.value?(y(),C("div",{key:5,class:Q(["chart-container",`chart-type-${p.value}`])},[n("div",kl,[n("div",bl,[(y(),De(Kt(T.value),{data:m.value,options:c.value},null,8,["data","options"]))]),p.value==="bar"?(y(),C("div",Cl,[(y(),C(oe,null,ue(O,D=>n("div",{key:D.id,class:"stage-label-item"},L(g(D.id)),1)),64))])):V("",!0)])],2)):(y(),C("div",wl,[...f[9]||(f[9]=[n("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),n("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),re(Yo,{"is-visible":v.value,"stage-name":b.value,"stage-id":$.value,"total-count":E.value,employees:S.value,others:F.value,snapshot:U.value,"ticket-details":K.value,"stage-switch-context":P.value,onClose:pe},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},_l=ke(Sl,[["__scopeId","data-v-cbba196a"]]),Dl={key:0,class:"create-snapshot-button-container"},El=["disabled"],Tl={class:"modal-content"},Il={class:"modal-header"},$l=["disabled"],Nl={class:"modal-body"},Ml={key:0,class:"progress-container"},xl={class:"progress-bar-wrapper"},Al={class:"progress-text"},Ll={class:"progress-percent"},Fl={class:"progress-description"},Pl={key:1},Bl={class:"modal-footer"},Rl=["disabled"],Hl=["disabled"],Ol={key:0},Wl={key:0},Ul={key:1},jl={key:2},zl={key:1},Vl={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(e,{emit:t}){const s=e,a=t,u=M(s.user),r=M(!1),l=M(!1),d=M(0),i=M("idle"),o=M(""),w=et(),_=te(()=>u.value?sa(u.value):!1);Ee(async()=>{if(!s.user)try{const E=await kt.checkAccess();E.allowed&&(u.value=E.user)}catch(E){console.error("Error loading user:",E)}});const p=()=>{if(!_.value){w.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}r.value=!0},v=()=>{l.value||(r.value=!1,i.value="idle",d.value=0,o.value="")},b=async()=>{if(!l.value){if(!_.value){w.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}l.value=!0,i.value="loading_data",d.value=0,o.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{o.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const E=await ht.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:U=>{const K=Math.min(80,(U.progress||0)*.8);d.value=K,i.value="loading_data",o.value=U.description||U.details?.description||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});i.value="creating_snapshot",d.value=85,o.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const S=u.value;if(!S)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const F=await Ae.createSnapshot(E,"manual",{createdBy:{id:S.ID,name:`${S.NAME||""} ${S.LAST_NAME||""}`.trim()||S.EMAIL||`User ${S.ID}`},sectorId:"1C"});i.value="success",d.value=100,o.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",w.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),a("snapshot-created",F),setTimeout(()=>{v()},1500)}catch(E){i.value="error",d.value=0,o.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",E);let S="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";E.message&&(E.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||E.message.includes("sector data")?S="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":E.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||E.message.includes("snapshot")?S="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":E.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||E.message.includes("validation")?S="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":S=E.message),w.error(S)}finally{l.value=!1}}},$=E=>{E.key==="Escape"&&r.value&&!l.value&&v()};return Ee(()=>{window.addEventListener("keydown",$)}),Xe(()=>{window.removeEventListener("keydown",$)}),(E,S)=>_.value?(y(),C("div",Dl,[n("button",{class:"create-snapshot-btn",onClick:p,disabled:l.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...S[1]||(S[1]=[n("span",{class:"btn-icon"},"üì∏",-1),n("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,El),(y(),De(vt,{to:"body"},[re(ze,{name:"modal"},{default:ye(()=>[r.value?(y(),C("div",{key:0,class:"modal-overlay",onClick:S[0]||(S[0]=ae(F=>!l.value&&v(),["self"]))},[n("div",Tl,[n("div",Il,[S[2]||(S[2]=n("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),n("button",{class:"modal-close",onClick:v,disabled:l.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,$l)]),n("div",Nl,[i.value!=="idle"?(y(),C("div",Ml,[n("div",xl,[n("div",{class:"progress-bar",style:ve({width:`${d.value}%`})},null,4)]),n("div",Al,[n("span",Ll,L(Math.round(d.value))+"%",1),n("span",Fl,L(o.value),1)])])):(y(),C("div",Pl,[...S[3]||(S[3]=[n("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),n("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),n("div",Bl,[n("button",{class:"btn btn-secondary",onClick:v,disabled:l.value}," –û—Ç–º–µ–Ω–∞ ",8,Rl),n("button",{class:"btn btn-primary",onClick:b,disabled:l.value},[l.value?(y(),C("span",Ol,[i.value==="loading_data"?(y(),C("span",Wl,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):i.value==="creating_snapshot"?(y(),C("span",Ul,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(y(),C("span",jl,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(y(),C("span",zl,"–°–æ–∑–¥–∞—Ç—å"))],8,Hl)])])])):V("",!0)]),_:1})]))])):V("",!0)}},Yl=ke(Vl,[["__scopeId","data-v-09bccee2"]]),Kl={class:"graph-state-dashboard"},Gl={key:1,class:"error-message-container"},Xl={class:"error-message"},ql={class:"error-text"},Jl={key:0,class:"error-details"},Zl={class:"dashboard-header"},Ql={class:"header-content"},er={class:"breadcrumbs-row"},tr=["aria-disabled","data-fallback","disabled"],ar={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},sr={class:"header-actions"},nr=["disabled"],or={key:0},lr={key:1},rr={key:3,class:"dashboard-content"},ir={class:"chart-container"},cr="–ù–∞–∑–∞–¥",ur={__name:"GraphStateDashboard",setup(e){const t=(W,z)=>typeof window>"u"?z:getComputedStyle(document.documentElement).getPropertyValue(W).trim()||z,s=et(),a=qt(),u={name:"dashboard-sector-1c"},{filters:r,selectedPeriod:l,hasActiveFilters:d,applyFilters:i,resetFilters:o,loadFiltersFromLocalStorage:w}=Zt(),_=M(null),p=M(!0),v=M(!1),b=M("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),$=M(null),E=M(!1),S=M(!1),F=M(typeof window<"u"?window.innerWidth:1024),U=M(null),K=M(!1),P=te(()=>F.value<768);te(()=>F.value>=768&&F.value<1024),te(()=>F.value>=1024);const I=te(()=>typeof window>"u"?!1:window.history.length>1);te(()=>{const W=new Date;return W.setFullYear(W.getFullYear()-1),W.toISOString().split("T")[0]}),te(()=>new Date().toISOString().split("T")[0]);function T(W){r.value.stages=W}function H(W){r.value.employees=W}function O(W){r.value.dateRange=W}function G(W){r.value.customDateRange=W}function J(){i()}function Z(){o(),U.value=null,J(),s.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function ee(W){s.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function de(W){v.value=!1,b.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",W)}function Ye(W){v.value=!1,Pe({message:W||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function Pe(W){$.value={message:W.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:W.details||null,type:W.type||"error",timestamp:new Date},console.error("Dashboard error:",$.value),s.error($.value.message)}function fe(){$.value=null}function we(){$.value=null,v.value=!0,b.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function Be(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){s.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}E.value=!0;try{const W=document.querySelector(".chart-container");if(!W)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const z=window.html2canvas,pe=await z(W,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Oe=window.jsPDF,me=new Oe("landscape","mm","a4"),We=297,g=pe.height*We/pe.width;me.setFontSize(18),me.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const m=new Date().toLocaleDateString("ru-RU");me.setFontSize(10);const c=l.value.startDate&&l.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${l.value.startDate} - ${l.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";me.text(c,148.5,25,{align:"center"}),me.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${m}`,148.5,30,{align:"center"}),me.addImage(pe.toDataURL("image/png"),"PNG",10,35,We-20,g-20),me.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${m}`,author:"Bitrix24 Dashboard"});const x=`graph-state-${m.replace(/\//g,"-")}.pdf`;me.save(x),s.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(W){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",W),Pe({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(W.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:W.stack,type:"error"})}finally{E.value=!1}}function Se(W){if(W?.preventDefault?.(),!K.value){K.value=!0;try{if(I.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(u)}finally{K.value=!1}}}function Re(){a.push("/")}function He(){typeof window<"u"&&(F.value=window.innerWidth)}async function Ie(){try{const W=await kt.checkAccess();W.allowed&&(_.value=W.user)}catch(W){console.error("Error loading user:",W)}}return Ee(()=>{w(),Ie(),typeof window<"u"&&(F.value=window.innerWidth,window.addEventListener("resize",He))}),Xe(()=>{typeof window<"u"&&window.removeEventListener("resize",He)}),(W,z)=>{const pe=Jt("router-link");return y(),C("div",Kl,[v.value?(y(),De(bt,{key:0,message:b.value},null,8,["message"])):V("",!0),$.value?(y(),C("div",Gl,[n("div",Xl,[n("div",{class:"error-header"},[z[1]||(z[1]=n("span",{class:"error-icon"},"‚ùå",-1)),z[2]||(z[2]=n("h3",null,"–û—à–∏–±–∫–∞",-1)),n("button",{onClick:fe,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),n("p",ql,L($.value.message),1),$.value.details?(y(),C("div",Jl,[n("details",null,[z[3]||(z[3]=n("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),n("pre",null,L($.value.details),1)])])):V("",!0),n("div",{class:"error-actions"},[n("button",{onClick:we,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):V("",!0),n("div",Zl,[n("div",Ql,[n("div",er,[n("button",{class:"btn-home-link",type:"button",onClick:Re,title:"–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É","aria-label":"–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É"}," –ì–ª–∞–≤–Ω–∞—è "),z[9]||(z[9]=n("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),n("button",{class:"btn-back-link",type:"button",onClick:Se,"aria-label":cr,"aria-disabled":!I.value,"data-fallback":!I.value,disabled:K.value,title:"–ù–∞–∑–∞–¥"}," ‚Üê ",8,tr),n("nav",ar,[re(pe,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:ye(()=>[...z[4]||(z[4]=[_e(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),z[6]||(z[6]=n("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),z[7]||(z[7]=n("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1)),z[8]||(z[8]=n("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),re(pe,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:ye(()=>[...z[5]||(z[5]=[_e(" –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏—ë–º–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–π ",-1)])]),_:1})])]),z[10]||(z[10]=n("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),z[11]||(z[11]=n("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),n("div",sr,[n("button",{onClick:Be,class:"btn-export-pdf",disabled:E.value||v.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[E.value?(y(),C("span",lr,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(y(),C("span",or,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,nr),re(Yl,{user:_.value,onSnapshotCreated:ee},null,8,["user"])])]),P.value?(y(),C("button",{key:2,class:"mobile-filters-toggle",onClick:z[0]||(z[0]=Oe=>S.value=!S.value)},[z[12]||(z[12]=n("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),n("span",{class:Q(["toggle-icon",{open:S.value}])},"‚ñº",2)])):V("",!0),n("div",{class:Q({"mobile-open":S.value&&P.value,"mobile-closed":!S.value&&P.value})},[re(Es,{stages:Ue(r).stages,employees:Ue(r).employees,dateRange:Ue(r).dateRange,customDateRange:Ue(r).customDateRange,hasActiveFilters:Ue(d),"onUpdate:stages":T,"onUpdate:employees":H,"onUpdate:dateRange":O,"onUpdate:customDateRange":G,onReset:Z,onApply:J},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!v.value&&!$.value?(y(),C("div",rr,[n("div",ir,[re(_l,{period:Ue(l),"show-current-state":p.value,onDataLoaded:de,onError:Ye},null,8,["period","show-current-state"])])])):V("",!0)])}}},dr=ke(ur,[["__scopeId","data-v-831b0079"]]),Dr=Object.freeze(Object.defineProperty({__proto__:null,default:dr},Symbol.toStringTag,{value:"Module"}));export{Sr as D,Es as F,Dr as G,bt as L,pa as a,_r as b,va as c,ga as d,wr as e,Cr as f,ua as g,kr as h,br as i,ca as j,je as m,xe as t};
