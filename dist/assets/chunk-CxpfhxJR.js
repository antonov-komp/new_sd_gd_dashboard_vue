import{L as l}from"./chunk-CBCOylN3.js";class m{constructor(e,t=5*60*1e3){this.domain=e,this.cache=new Map,this.cacheTimeout=t,this.metrics={apiCalls:0,cacheHits:0,cacheMisses:0,errors:0,avgResponseTime:0,totalResponseTime:0}}async getApi(){const e="api",t=this.cache.get(e);if(t&&Date.now()-t.timestamp<(t.timeout||this.cacheTimeout))return this.metrics.cacheHits++,t.data;this.metrics.cacheMisses++;const s=performance.now();try{const{Bitrix24ApiService:r}=await l.loadBitrix24Api(),i=performance.now()-s;this.updateAverageResponseTime(i);const a=60*1e3;return this.cache.set(e,{data:r,timestamp:Date.now(),timeout:a}),r}catch(r){throw this.metrics.errors++,console.error(`[${this.domain}] Failed to load Bitrix24ApiService:`,r),r}}async call(e,t={}){const s=performance.now();this.metrics.apiCalls++;try{if(this.isCacheableMethod(e)){const c=this.getCachedResult(e,t);if(c)return this.metrics.cacheHits++,c}const i=await(await this.getApi()).call(e,t),a=performance.now()-s;return this.updateAverageResponseTime(a),this.isCacheableMethod(e)&&this.setCachedResult(e,t,i),i}catch(r){this.metrics.errors++;const i=performance.now()-s;throw console.error(`[${this.domain}] API call failed:`,{method:e,params:t,error:r.message,responseTime:`${i.toFixed(2)}ms`,domain:this.domain}),this.wrapError(r,e,t)}}isCacheableMethod(e){return["user.get","department.get","crm.status.list","user.current","crm.contact.list","crm.company.list"].includes(e)}getCachedResult(e,t){const s=this.getCacheKey(e,t),r=this.cache.get(s);return r&&Date.now()-r.timestamp<(r.timeout||this.cacheTimeout)?r.data:null}setCachedResult(e,t,s){const r=this.getCacheKey(e,t);this.cache.set(r,{data:JSON.parse(JSON.stringify(s)),timestamp:Date.now(),timeout:this.cacheTimeout,method:e,params:t})}getCacheKey(e,t){const s=Object.keys(t).sort().reduce((r,i)=>(r[i]=t[i],r),{});return`${e}_${JSON.stringify(s)}`}updateAverageResponseTime(e){this.metrics.totalResponseTime+=e,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.apiCalls}clearCache(e=null){if(e)for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}getMetrics(){const e=this.metrics.cacheHits+this.metrics.cacheMisses,t=e>0?this.metrics.cacheHits/e:0;return{domain:this.domain,cache:{size:this.cache.size,hitRate:Math.round(t*100)/100,hits:this.metrics.cacheHits,misses:this.metrics.cacheMisses,efficiency:t>.8?"excellent":t>.6?"good":"poor"},api:{totalCalls:this.metrics.apiCalls,errors:this.metrics.errors,errorRate:this.metrics.apiCalls>0?Math.round(this.metrics.errors/this.metrics.apiCalls*100)/100:0,avgResponseTime:Math.round(this.metrics.avgResponseTime),totalResponseTime:Math.round(this.metrics.totalResponseTime),performance:this.metrics.avgResponseTime<500?"fast":this.metrics.avgResponseTime<2e3?"normal":"slow"},cacheEntries:Array.from(this.cache.keys()).map(s=>{const r=this.cache.get(s);return{key:s,age:Date.now()-r.timestamp,ageFormatted:this.formatAge(Date.now()-r.timestamp),method:r.method,expiresIn:(r.timeout||this.cacheTimeout)-(Date.now()-r.timestamp)}}).sort((s,r)=>s.age-r.age)}}formatAge(e){const t=Math.floor(e/1e3),s=Math.floor(t/60),r=Math.floor(s/60);return r>0?`${r}h ${s%60}m`:s>0?`${s}m ${t%60}s`:`${t}s`}wrapError(e,t,s){return e.code==="NETWORK_ERROR"||e.message?.includes("fetch")?new p(`Network error calling ${t}`,e,t,s):e.error&&typeof e.error=="string"?new u(e.error_description||e.error,e,t,s):new h(e.message||"Unknown Bitrix24 error",e,t,s)}}class h extends Error{constructor(e,t,s,r){super(e),this.name="Bitrix24FacadeError",this.originalError=t,this.method=s,this.params=r,this.timestamp=new Date().toISOString(),this.domain="facade"}}class u extends h{constructor(e,t,s,r){super(e,t,s,r),this.name="Bitrix24ApiError",this.domain="api"}}class p extends h{constructor(e,t,s,r){super(e,t,s,r),this.name="Bitrix24NetworkError",this.domain="network"}}class T extends m{constructor(){super("activity")}async getUsersList(e={}){return(await this.call("user.get",{filter:{ACTIVE:"Y",...e},select:["ID","NAME","LAST_NAME","EMAIL","UF_DEPARTMENT","ACTIVE","DATE_REGISTER","PERSONAL_PHOTO","WORK_POSITION"]})).result||[]}async getUserDetails(e){if(!e)throw new Error("User ID is required");return(await this.call("user.get",{filter:{ID:parseInt(e)},select:["ID","NAME","LAST_NAME","SECOND_NAME","EMAIL","UF_DEPARTMENT","ACTIVE","DATE_REGISTER","TIMESTAMP_X","PERSONAL_PHONE","WORK_PHONE","PERSONAL_PHOTO","WORK_POSITION","WORK_COMPANY"]})).result?.[0]||null}async getDepartments(){return(await this.call("department.get",{select:["ID","NAME","UF_HEAD","PARENT","SORT"]})).result||[]}async getDepartmentUsers(e){if(!e)throw new Error("Department ID is required");return this.getUsersList({UF_DEPARTMENT:parseInt(e)})}async getDepartmentStats(){const[e,t]=await Promise.all([this.getDepartments(),this.getUsersList()]);return e.map(r=>{const i=t.filter(a=>Array.isArray(a.UF_DEPARTMENT)&&a.UF_DEPARTMENT.includes(parseInt(r.ID)));return{department:r,userCount:i.length,activeUsers:i.filter(a=>a.ACTIVE==="Y").length}})}async searchUsers(e,t=20){return!e||e.length<2?[]:this.getUsersList({"%NAME":e,"%LAST_NAME":e,"%EMAIL":e}).then(s=>s.slice(0,t))}async getUsersByIds(e){return!Array.isArray(e)||e.length===0?[]:(await this.call("user.get",{filter:{ID:e.map(s=>parseInt(s))},select:["ID","NAME","LAST_NAME","EMAIL","UF_DEPARTMENT","ACTIVE","WORK_POSITION"]})).result||[]}async getUsersForAnalytics(e={}){const{departmentId:t,activeOnly:s=!0,includeInactive:r=!1,limit:i=100}=e,a={};return s&&!r&&(a.ACTIVE="Y"),t&&(a.UF_DEPARTMENT=parseInt(t)),(await this.getUsersList(a)).slice(0,i).map(n=>({...n,fullName:`${n.NAME} ${n.LAST_NAME||""}`.trim(),departmentName:"",registrationAge:this.calculateRegistrationAge(n.DATE_REGISTER),isNewUser:this.isNewUser(n.DATE_REGISTER)}))}calculateRegistrationAge(e){if(!e)return 0;const t=new Date(e),r=Math.abs(new Date-t);return Math.ceil(r/(1e3*60*60*24))}isNewUser(e){return this.calculateRegistrationAge(e)<=30}async getDepartmentHierarchy(){const[e,t]=await Promise.all([this.getDepartments(),this.getUsersList()]),s=new Map;e.forEach(i=>{s.set(parseInt(i.ID),{...i,users:[],children:[]})}),t.forEach(i=>{Array.isArray(i.UF_DEPARTMENT)&&i.UF_DEPARTMENT.forEach(a=>{const c=s.get(parseInt(a));c&&c.users.push(i)})});const r=[];return s.forEach(i=>{if(i.PARENT){const a=s.get(parseInt(i.PARENT));a&&a.children.push(i)}else r.push(i)}),r}async getUserSummaryStats(){const e=await this.getUsersList(),t={total:e.length,active:e.filter(s=>s.ACTIVE==="Y").length,inactive:e.filter(s=>s.ACTIVE!=="Y").length,newUsers:e.filter(s=>this.isNewUser(s.DATE_REGISTER)).length,departmentsCount:new Set(e.flatMap(s=>s.UF_DEPARTMENT||[])).size,usersByDepartment:{}};return e.forEach(s=>{Array.isArray(s.UF_DEPARTMENT)&&s.UF_DEPARTMENT.forEach(r=>{const i=parseInt(r);t.usersByDepartment[i]||(t.usersByDepartment[i]={active:0,inactive:0,total:0}),t.usersByDepartment[i].total++,s.ACTIVE==="Y"?t.usersByDepartment[i].active++:t.usersByDepartment[i].inactive++})}),t}}export{T as A,m as B};
