import{_ as A,c as u,a,b as N,t as T,n as B,o as l,F as w,r as P,d as S,e as b,f as D,g as U,w as L,T as M,h as z,i as G,j as x}from"./main-CkrWM5G1.js";const j={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(d,{emit:e}){return{getPriorityLabel:n=>({high:"Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹",medium:"Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹",low:"ÐÐ¸Ð·ÐºÐ¸Ð¹"})[n]||n,getStatusLabel:n=>({in_progress:"Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ",new:"ÐÐ¾Ð²Ñ‹Ð¹",done:"Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾",pending:"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ"})[n]||n,handleDragStart:n=>{n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("application/json",JSON.stringify(d.ticket)),n.dataTransfer.setDragImage(n.target,0,0),e("drag-start",d.ticket)},handleDragEnd:()=>{e("drag-end")}}}},H=["draggable"],Z={class:"ticket-header"},q={class:"ticket-id"},W={class:"ticket-title"},V={class:"ticket-meta"},F={class:"ticket-status"},J={key:0,class:"ticket-description"};function K(d,e,t,i,o,m){return l(),u("div",{class:B(["ticket-card",{"priority-high":t.ticket.priority==="high","priority-medium":t.ticket.priority==="medium","priority-low":t.ticket.priority==="low"}]),draggable:t.draggable,onClick:e[0]||(e[0]=n=>d.$emit("click",t.ticket)),onDragstart:e[1]||(e[1]=(...n)=>i.handleDragStart&&i.handleDragStart(...n)),onDragend:e[2]||(e[2]=(...n)=>i.handleDragEnd&&i.handleDragEnd(...n))},[a("div",Z,[e[3]||(e[3]=a("span",{class:"ticket-icon"},"ðŸŽ«",-1)),a("span",q,"#"+T(t.ticket.id),1)]),a("div",W,T(t.ticket.title),1),a("div",V,[a("span",{class:B(["ticket-priority",`priority-${t.ticket.priority}`])},T(i.getPriorityLabel(t.ticket.priority)),3),a("span",F,T(i.getStatusLabel(t.ticket.status)),1)]),t.ticket.description?(l(),u("div",J,T(t.ticket.description),1)):N("",!0)],42,H)}const X=A(j,[["render",K],["__scopeId","data-v-5f8b7916"]]),Q={name:"ZeroPoint",components:{TicketCard:X},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(d,{emit:e}){return{handleTicketDragStart:i=>{e("ticket-dragged",i)}}}},$={class:"zero-point"},ee={class:"zero-point-header"},te={class:"tickets-count"},ie={class:"zero-point-tickets"},oe={key:0,class:"empty-state"};function ae(d,e,t,i,o,m){const n=S("TicketCard");return l(),u("div",$,[a("div",ee,[e[0]||(e[0]=a("span",{class:"zero-point-icon"},"ðŸ“¥",-1)),e[1]||(e[1]=a("h3",null,"[0] ÐÑƒÐ»ÐµÐ²Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°",-1)),a("span",te,"("+T(t.tickets.length)+")",1)]),e[3]||(e[3]=a("div",{class:"zero-point-description"},[a("p",null,"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ñ‚Ð¸ÐºÐµÑ‚Ñ‹"),a("p",{class:"hint"},"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ‚Ð¸ÐºÐµÑ‚ Ð½Ð° ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°")],-1)),a("div",ie,[(l(!0),u(w,null,P(t.tickets,r=>(l(),b(n,{key:r.id,ticket:r,draggable:!0,onDragStart:s=>i.handleTicketDragStart(r),onClick:s=>d.$emit("ticket-clicked",r)},null,8,["ticket","onDragStart","onClick"]))),128)),t.tickets.length===0?(l(),u("div",oe,[...e[2]||(e[2]=[a("p",null,"ÐÐµÑ‚ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",-1)])])):N("",!0)])])}const ne=A(Q,[["render",ae],["__scopeId","data-v-417bccd2"]]),re={name:"EmployeeColumn",components:{TicketCard:X},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(d,{emit:e}){const t=D(!1),i=g=>{g.preventDefault(),g.dataTransfer.dropEffect="move",t.value=!0},o=g=>{const f=g.currentTarget.getBoundingClientRect(),y=g.clientX,C=g.clientY;(y<f.left||y>f.right||C<f.top||C>f.bottom)&&(t.value=!1)},m=async g=>{g.preventDefault(),t.value=!1;const f=g.dataTransfer.getData("application/json");if(f)try{const y=JSON.parse(f);n(y,d.employee.id,d.stageId)?e("ticket-dropped",y,d.employee.id):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"ÐÐµÐ»ÑŒÐ·Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚Ð¸ÐºÐµÑ‚ ÑÑŽÐ´Ð°",autoHideDelay:3e3})}catch(y){console.error("Error parsing ticket data:",y)}},n=(g,f,y)=>!(g.assigneeId===f&&g.stageId===y);return{isDropZoneActive:t,handleDragOver:i,handleDragLeave:o,handleDrop:m,handleTicketDragStart:g=>{},handleAddTicket:()=>{console.log("Add ticket for employee:",d.employee.id)}}}},se={class:"employee-header"},ce={class:"employee-info"},de={class:"employee-details"},le={class:"employee-name"},ge={key:0,class:"employee-position"},ue={class:"tickets-count"},me={class:"tickets-list"},pe={key:0,class:"empty-state"};function ke(d,e,t,i,o,m){var r;const n=S("TicketCard");return l(),u("div",{class:B(["employee-column",{"drop-zone-active":i.isDropZoneActive}]),onDragover:e[1]||(e[1]=z((...s)=>i.handleDragOver&&i.handleDragOver(...s),["prevent"])),onDragleave:e[2]||(e[2]=(...s)=>i.handleDragLeave&&i.handleDragLeave(...s)),onDrop:e[3]||(e[3]=(...s)=>i.handleDrop&&i.handleDrop(...s))},[a("div",se,[a("div",ce,[e[4]||(e[4]=a("span",{class:"employee-icon"},"ðŸ‘¤",-1)),a("div",de,[a("div",le,T(t.employee.name),1),t.employee.position?(l(),u("div",ge,T(t.employee.position),1)):N("",!0)])]),a("div",ue," ðŸ“Š Ð¢Ð¸ÐºÐµÑ‚Ð¾Ð²: "+T(((r=t.employee.tickets)==null?void 0:r.length)||0),1)]),a("div",me,[U(M,{name:"ticket",tag:"div"},{default:L(()=>[(l(!0),u(w,null,P(t.employee.tickets,s=>(l(),b(n,{key:s.id,ticket:s,draggable:!0,onClick:g=>d.$emit("ticket-clicked",s),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1}),!t.employee.tickets||t.employee.tickets.length===0?(l(),u("div",pe,[e[5]||(e[5]=a("p",null,"ÐÐµÑ‚ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",-1)),a("button",{class:"add-ticket-btn",onClick:e[0]||(e[0]=(...s)=>i.handleAddTicket&&i.handleAddTicket(...s))}," + Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¸ÐºÐµÑ‚ ")])):N("",!0)])],34)}const fe=A(re,[["render",ke],["__scopeId","data-v-1b8f823d"]]),ye={name:"DashboardStage",components:{ZeroPoint:ne,EmployeeColumn:fe},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(d,{emit:e}){const t=D(!1);return{isDragging:t,handleTicketDragged:r=>{t.value=!0},handleTicketAssigned:(r,s)=>{e("ticket-assigned",r,s)},handleTicketDropped:(r,s)=>{e("ticket-moved",r,s,d.stage.id),t.value=!1},handleTicketClicked:r=>{console.log("Ticket clicked:",r),e("ticket-clicked",r)}}}},he={class:"stage-header"},Te={class:"stage-content"},_e={class:"employees-container"};function De(d,e,t,i,o,m){const n=S("ZeroPoint"),r=S("EmployeeColumn");return l(),u("div",{class:"dashboard-stage",style:G({borderLeftColor:t.stage.color})},[a("div",he,[a("h2",null,T(t.stage.name),1)]),a("div",Te,[U(n,{tickets:t.zeroPointTickets,"stage-id":t.stage.id,onTicketDragged:i.handleTicketDragged,onTicketAssigned:i.handleTicketAssigned,onTicketClicked:i.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),a("div",_e,[(l(!0),u(w,null,P(t.stage.employees,s=>(l(),b(r,{key:s.id,employee:s,"stage-id":t.stage.id,onTicketClicked:i.handleTicketClicked,onTicketDropped:i.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const Ie=A(ye,[["render",De],["__scopeId","data-v-20011aa0"]]);class v{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,t={}){try{const i=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:t})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=await i.json();if(o.error)throw new Error(o.error_description||o.error);return o}catch(i){throw console.error("Bitrix24 API error:",i),i}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},t=["ID","NAME","EMAIL","PHONE"],i={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:t,order:i})).result||[]}}class R{static async getSectorData(){try{const e=await v.call("crm.deal.list",{filter:{},select:["ID","TITLE","STAGE_ID","ASSIGNED_BY_ID","OPPORTUNITY","CURRENCY_ID","CREATED_DATE","MODIFY_DATE"],order:{ID:"DESC"}}),t=await this.getEmployees();return{stages:this.groupTicketsByStages(e.result||[],t),employees:t,zeroPointTickets:this.getZeroPointTickets(e.result||[])}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getEmployees(){try{return((await v.call("user.get",{})).result||[]).map(t=>({id:parseInt(t.ID),name:`${t.NAME||""} ${t.LAST_NAME||""}`.trim()||t.EMAIL||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",position:t.WORK_POSITION||"Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº",email:t.EMAIL||"",tickets:[]}))}catch(e){throw console.error("Error getting employees:",e),e}}static groupTicketsByStages(e,t){const i=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff",employees:t.map(o=>({...o,tickets:[]}))},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107",employees:t.map(o=>({...o,tickets:[]}))},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745",employees:t.map(o=>({...o,tickets:[]}))}];return e.forEach(o=>{const m=this.mapStageId(o.STAGE_ID),n=i.find(r=>r.id===m);if(n){const r=o.ASSIGNED_BY_ID?parseInt(o.ASSIGNED_BY_ID):null;if(r){const s=n.employees.find(g=>g.id===r);s&&s.tickets.push(this.mapTicket(o))}}}),i}static mapStageId(e){const t={NEW:"formed",PREPARATION:"review",PREPAYMENT_INVOICE:"execution"};if(e){const i=e.toUpperCase();if(i.includes("NEW")||i.includes("C0"))return"formed";if(i.includes("PREPARATION")||i.includes("C1"))return"review";if(i.includes("PREPAYMENT")||i.includes("C2"))return"execution"}return t[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"NEW",review:"PREPARATION",execution:"PREPAYMENT_INVOICE"}[e]||"NEW"}static mapTicket(e){return{id:parseInt(e.ID),title:e.TITLE||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",priority:this.mapPriority(e.PRIORITY),status:this.mapStatus(e.STAGE_ID),assigneeId:e.ASSIGNED_BY_ID?parseInt(e.ASSIGNED_BY_ID):null,stageId:this.mapStageId(e.STAGE_ID),createdAt:e.CREATED_DATE,modifiedAt:e.MODIFY_DATE,amount:e.OPPORTUNITY||0,currency:e.CURRENCY_ID||"RUB",description:e.COMMENTS||""}}static mapPriority(e){return{3:"high",2:"medium",1:"low"}[e]||"medium"}static mapPriorityToBitrix(e){return{high:"3",medium:"2",low:"1"}[e]||"2"}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const t={formed:[],review:[],execution:[]};return e.filter(i=>!i.ASSIGNED_BY_ID).forEach(i=>{const o=this.mapStageId(i.STAGE_ID);t[o]&&t[o].push(this.mapTicket(i))}),t}static async assignTicket(e,t,i){try{const o=this.mapStageIdToBitrix(i);return(await v.call("crm.deal.update",{id:e,fields:{ASSIGNED_BY_ID:t,STAGE_ID:o}})).result===!0}catch(o){throw console.error("Error assigning ticket:",o),o}}static async createTicket(e){try{const t=await v.call("crm.deal.add",{fields:{TITLE:e.title,ASSIGNED_BY_ID:e.employeeId,STAGE_ID:this.mapStageIdToBitrix(e.stageId),OPPORTUNITY:e.amount||0,CURRENCY_ID:e.currency||"RUB",COMMENTS:e.description||""}});return t.result?parseInt(t.result):0}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const t=await v.call("crm.deal.get",{id:e});return this.mapTicket(t.result)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await v.call("crm.timeline.comment.add",{fields:{ENTITY_ID:e,ENTITY_TYPE:"deal",COMMENT:t}})).result!==void 0}catch(i){throw console.error("Error adding comment:",i),i}}}const Ee={name:"DashboardSector1C",components:{DashboardStage:Ie},setup(){const d=D(!0),e=D(null),t=D([{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff",employees:[]},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107",employees:[]},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745",employees:[]}]),i=D({formed:[],review:[],execution:[]}),o=D([]),m=D(null),n=async()=>{d.value=!0,e.value=null;try{const c=await R.getSectorData();t.value=c.stages,i.value=c.zeroPointTickets,o.value=c.employees}catch(c){e.value=c.message,console.error("Error loading sector data:",c),typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°",autoHideDelay:5e3})}finally{d.value=!1}},r=c=>{m.value=c},s=async(c,p,_)=>{try{await R.assignTicket(c.id,p,_),g(c,p,_),typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"Ð¢Ð¸ÐºÐµÑ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ñ‘Ð½",autoHideDelay:3e3})}catch(I){console.error("Error moving ticket:",I),typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ñ‚Ð¸ÐºÐµÑ‚Ð°",autoHideDelay:5e3})}finally{m.value=null}},g=(c,p,_)=>{const I=t.value.find(k=>k.employees.some(h=>h.tickets.some(O=>O.id===c.id)));if(I){const k=I.employees.find(h=>h.tickets.some(O=>O.id===c.id));k&&(k.tickets=k.tickets.filter(h=>h.id!==c.id))}const E=t.value.find(k=>k.id===_);if(E){const k=E.employees.find(h=>h.id===p);if(k){const h={...c,assigneeId:p,stageId:_};k.tickets.push(h)}}Object.keys(i.value).forEach(k=>{i.value[k]=i.value[k].filter(h=>h.id!==c.id)})},f=async(c,p)=>{await s(c,p,c.stageId)},y=async(c,p)=>{await s(c,c.assigneeId,p)},C=async c=>{try{const p=await R.createTicket(c);await n(),typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"Ð¢Ð¸ÐºÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½",autoHideDelay:3e3})}catch(p){console.error("Error creating ticket:",p),typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð¸ÐºÐµÑ‚Ð°",autoHideDelay:5e3})}},Y=(c,p)=>{const _=t.value.find(E=>E.id===p);if(!_)return[];const I=_.employees.find(E=>E.id===c);return I?I.tickets||[]:[]};return x(()=>{n()}),{isLoading:d,error:e,stages:t,zeroPointTickets:i,employees:o,draggedTicket:m,loadSectorData:n,handleTicketDragStart:r,handleTicketDrop:s,assignTicketToEmployee:f,moveTicketToStage:y,createTicket:C,getEmployeeTickets:Y}}},ve={key:0,class:"loading-state"},Se={key:1,class:"error-state"},Ae={key:2,class:"dashboard-content"},Ce={class:"stages-container"};function Ne(d,e,t,i,o,m){const n=S("DashboardStage");return l(),u("div",{class:B(["dashboard-sector-1c",{"is-dragging":i.draggedTicket}])},[e[1]||(e[1]=a("div",{class:"dashboard-header"},[a("h1",null,"Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´ - Ð¡ÐµÐºÑ‚Ð¾Ñ€ 1Ð¡")],-1)),i.isLoading?(l(),u("div",ve,[...e[0]||(e[0]=[a("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…...",-1)])])):i.error?(l(),u("div",Se,[a("p",null,"ÐžÑˆÐ¸Ð±ÐºÐ°: "+T(i.error),1)])):(l(),u("div",Ae,[a("div",Ce,[(l(!0),u(w,null,P(i.stages,r=>(l(),b(n,{key:r.id,stage:r,"zero-point-tickets":i.zeroPointTickets[r.id]||[],onTicketMoved:i.handleTicketDrop,onTicketAssigned:i.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])]))],2)}const we=A(Ee,[["render",Ne],["__scopeId","data-v-b6ce8859"]]);export{we as default};
