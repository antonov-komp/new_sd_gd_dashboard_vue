import{_ as F,g as y,c as f,a as _,o as d,b as e,t as h,F as A,e as E,n as N,d as L,f as $,G as O,H as R,m as W,j as B,S as G,L as P}from"./main-DF09cIPx.js";import{F as V}from"./FiltersPanel-DmF_m37u.js";import{L as I,D as j,B as x}from"./index-NkQ9SLGe.js";import"./bitrix24-api-Irr5mCDD.js";const Z={class:"ac-chart"},q={class:"ac-chart__header"},z={class:"ac-chart__subtitle"},H={class:"ac-chart__controls"},X={class:"chart-type-selector"},Y=["onClick"],J={class:"chart-type-icon"},K={class:"chart-type-label"},Q={class:"ac-chart__summary"},ee={class:"summary-card summary-card--new"},te={class:"summary-card__value"},se={class:"summary-card summary-card--closed"},ae={class:"summary-card__value"},oe={class:"summary-card summary-card--stages"},ne={class:"summary-card__tags"},le={key:0,class:"stage-tag stage-tag--empty"},re={class:"ac-chart__body"},ce={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(l,{emit:o}){const n=l,g=o,c=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],s=y("line"),t=f(()=>{var b;return((b=n.meta)==null?void 0:b.weekNumber)??"â€”"}),m=f(()=>{var w,i;const b=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],u=Array.isArray((w=n.data.series)==null?void 0:w.new)?n.data.series.new:[n.data.newTickets||0],T=Array.isArray((i=n.data.series)==null?void 0:i.closed)?n.data.series.closed:[n.data.closedTickets||0];return{labels:b,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:u,backgroundColor:R.primary,borderColor:R.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:T,backgroundColor:R.success,borderColor:R.success,tension:.3,fill:!1}]}}),k=f(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[n.data.newTickets||0,n.data.closedTickets||0],backgroundColor:[R.primary,R.success],borderWidth:1}]})),p=f(()=>{switch(s.value){case"line":return I;case"bar":return x;case"doughnut":return j;default:return I}}),D=f(()=>s.value==="doughnut"?k.value:m.value),C=f(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var b;(((b=n.data)==null?void 0:b.responsible)||[]).length>0&&g("open-responsible")},scales:s.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(b,u)=>{var T,w;return d(),_("div",Z,[e("header",q,[e("div",null,[u[1]||(u[1]=e("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),e("p",z," ÐÐµÐ´ÐµÐ»Ñ "+h(t.value)+" Â· "+h(((T=l.meta)==null?void 0:T.weekStartUtc)||"â€”")+" â€” "+h(((w=l.meta)==null?void 0:w.weekEndUtc)||"â€”")+" (UTC) ",1)]),e("div",H,[e("div",X,[(d(),_(A,null,E(c,i=>e("button",{key:i.value,class:N(["chart-type-btn",{active:s.value===i.value}]),onClick:M=>s.value=i.value},[e("span",J,h(i.icon),1),e("span",K,h(i.label),1)],10,Y)),64))]),e("button",{class:"btn-link",onClick:u[0]||(u[0]=i=>b.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),e("section",Q,[e("div",ee,[u[2]||(u[2]=e("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",te,h(l.data.newTickets??0),1)]),e("div",se,[u[3]||(u[3]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",ae,h(l.data.closedTickets??0),1)]),e("div",oe,[u[4]||(u[4]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),e("div",ne,[(d(!0),_(A,null,E(l.data.stages||[],i=>(d(),_("span",{key:i.stageId,class:"stage-tag"},h(i.stageId)+" â€” "+h(i.count),1))),128)),!l.data.stages||l.data.stages.length===0?(d(),_("span",le," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):L("",!0)])])]),e("div",re,[(d(),$(O(p.value),{data:D.value,options:C.value},null,8,["data","options"]))])])}}},ie=F(ce,[["__scopeId","data-v-9edf003d"]]),de={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},ue={class:"modal"},me={class:"modal__header"},pe={class:"modal__body"},ve={key:0,class:"modal__empty"},he={key:1,class:"responsible-list"},_e={class:"responsible-list__name"},ge={class:"responsible-list__avatar","aria-hidden":"true"},be={class:"responsible-list__count"},ke={class:"modal__footer"},ye={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]}},setup(l){const o=l,n=f(()=>(o.responsible||[]).length>0);function g(c){if(!c)return"â€”";const s=String(c).trim().split(/\s+/);return s.length===1?s[0].charAt(0).toUpperCase():`${s[0].charAt(0)}${s[1].charAt(0)}`.toUpperCase()}return(c,s)=>l.isVisible?(d(),_("div",de,[e("div",ue,[e("header",me,[s[2]||(s[2]=e("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("button",{class:"modal__close",onClick:s[0]||(s[0]=t=>c.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),e("section",pe,[n.value?(d(),_("ul",he,[(d(!0),_(A,null,E(l.responsible,t=>(d(),_("li",{key:t.id||t.name,class:"responsible-list__item"},[e("div",_e,[e("span",ge,h(g(t.name)),1),e("span",null,h(t.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1)]),e("div",be,h(t.count??0),1)]))),128))])):(d(),_("p",ve,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),e("footer",ke,[e("button",{class:"btn",onClick:s[1]||(s[1]=t=>c.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])])):L("",!0)}},fe=F(ye,[["__scopeId","data-v-ac5a8b81"]]),we="/api/graph-1c-admission-closure.php";function De(l){var n,g,c,s,t,m,k,p,D,C;if(!l)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const o=l.data||l.result||l;return{meta:o.meta||l.meta||null,data:{newTickets:((n=o.data)==null?void 0:n.newTickets)??o.newTickets??0,closedTickets:((g=o.data)==null?void 0:g.closedTickets)??o.closedTickets??0,series:{new:((s=(c=o.data)==null?void 0:c.series)==null?void 0:s.new)??((t=o.series)==null?void 0:t.new)??[0],closed:((k=(m=o.data)==null?void 0:m.series)==null?void 0:k.closed)??((p=o.series)==null?void 0:p.closed)??[0]},stages:((D=o.data)==null?void 0:D.stages)??o.stages??[],responsible:((C=o.data)==null?void 0:C.responsible)??o.responsible??[]}}}async function Ce(l={}){const{endpoint:o=we,product:n="1C",weekStartUtc:g=null,weekEndUtc:c=null,useCache:s=!0,forceRefresh:t=!1}=l,k=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:n,weekStartUtc:g,weekEndUtc:c,useCache:s,forceRefresh:t})});if(!k.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${k.status})`);const p=await k.json();if((p==null?void 0:p.success)===!1)throw new Error(p.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return De(p)}const Te={class:"ac-dashboard"},Re={key:1},Ue={class:"dashboard-layout"},$e={class:"filters-container"},Se={class:"chart-container"},Ae={__name:"GraphAdmissionClosureDashboard",setup(l){const o=y(!0),n=y(null),g=y(null),c=y({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),s=y(!1),t=y({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),m=y(null),k=f(()=>{const a=t.value.customDateRange.startDate||t.value.customDateRange.endDate,r=t.value.employees.length===1&&t.value.employees.includes("all");return a||!r});async function p(){o.value=!0,n.value=null;try{let a,r;if(m.value)a=m.value.startUtc,r=m.value.endUtc;else{const U=M();a=U.weekStartUtc,r=U.weekEndUtc}const{meta:v,data:S}=await Ce({product:"1C",weekStartUtc:a,weekEndUtc:r});g.value=v,c.value=S,!m.value&&v&&(m.value={weekNumber:v.weekNumber,startUtc:v.weekStartUtc,endUtc:v.weekEndUtc})}catch(a){n.value=a instanceof Error?a:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",a)}finally{o.value=!1}}function D(a){t.value.stages=a}function C(a){t.value.employees=a}function b(a){t.value.dateRange=a}function u(a){t.value.customDateRange=a}function T(a){m.value=a}function w(){t.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},i()}function i(){p()}W(()=>{p()});function M(){const a=new Date;let r=new Date(a),v=new Date(a);switch(t.value.dateRange){case"last-2-weeks":r.setDate(a.getDate()-14);break;case"last-month":r.setMonth(a.getMonth()-1);break;case"custom":t.value.customDateRange.startDate&&(r=new Date(t.value.customDateRange.startDate+"T00:00:00Z")),t.value.customDateRange.endDate&&(v=new Date(t.value.customDateRange.endDate+"T23:59:59Z"));break;case"last-week":default:r.setDate(a.getDate()-7);break}const S=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0)).toISOString(),U=new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth(),v.getUTCDate(),23,59,59)).toISOString();return{weekStartUtc:S,weekEndUtc:U}}return(a,r)=>(d(),_("div",Te,[o.value?(d(),$(P,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(d(),_("div",Re,[r[2]||(r[2]=e("div",{class:"dashboard-header"},[e("div",null,[e("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),e("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),e("div",Ue,[e("div",$e,[B(V,{stages:t.value.stages,employees:t.value.employees,dateRange:t.value.dateRange,customDateRange:t.value.customDateRange,hasActiveFilters:k.value,hideStages:!0,weekPickerMode:!0,selectedWeek:m.value,weeksCount:52,"onUpdate:stages":D,"onUpdate:employees":C,"onUpdate:dateRange":b,"onUpdate:customDateRange":u,"onUpdate:selectedWeek":T,onReset:w,onApply:i},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","selectedWeek"])]),e("div",Se,[n.value?(d(),$(G,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:n.value.message},null,8,["message"])):(d(),$(ie,{key:1,meta:g.value,data:c.value,onOpenResponsible:r[0]||(r[0]=v=>s.value=!0)},null,8,["meta","data"]))])])])),B(fe,{"is-visible":s.value,responsible:c.value.responsible||[],onClose:r[1]||(r[1]=v=>s.value=!1)},null,8,["is-visible","responsible"])]))}},Ie=F(Ae,[["__scopeId","data-v-3aac3d46"]]);export{Ie as default};
