var ee=Object.defineProperty;var te=(p,e,t)=>e in p?ee(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var H=(p,e,t)=>te(p,typeof e!="symbol"?e+"":e,t);import{_ as W,g as v,c as U,a as y,o as g,b as s,t as w,F as Y,e as L,n as x,d as R,f as O,G as se,H as N,I as V,j as D,k as B,B as M,T as X,l as G,m as ae,S as le,L as oe}from"./main-CvSwgagE.js";import{F as ne}from"./FiltersPanel-hS8FFPOi.js";import{L as z,D as re,B as ie}from"./index-aSSF498Y.js";import{B as P,g as Z,a as ce,b as J,D as de,T as K,c as Q}from"./priority-config-u-PWcAk8.js";const ue={class:"ac-chart"},me={class:"ac-chart__header"},ge={class:"ac-chart__subtitle"},ye={class:"ac-chart__controls"},_e={class:"chart-type-selector"},pe=["onClick"],fe={class:"chart-type-icon"},ve={class:"chart-type-label"},he={class:"ac-chart__summary"},ke={class:"summary-card summary-card--new"},Te={class:"summary-card__value"},Ie={class:"summary-card summary-card--closed"},we={class:"summary-card__value"},be={class:"summary-card summary-card--stages"},Ee={class:"summary-card__tags"},Se={key:0,class:"stage-tag stage-tag--empty"},Ce={class:"ac-chart__body"},De={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible","open-stages"],setup(p,{emit:e}){const t=p,a=e,l=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],m=v("line"),_=U(()=>{var E;return((E=t.meta)==null?void 0:E.weekNumber)??"â€”"}),r=U(()=>{var C,u;const E=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],h=Array.isArray((C=t.data.series)==null?void 0:C.new)?t.data.series.new:[t.data.newTickets||0],S=Array.isArray((u=t.data.series)==null?void 0:u.closed)?t.data.series.closed:[t.data.closedTickets||0];return{labels:E,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:h,backgroundColor:N.primary,borderColor:N.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:S,backgroundColor:N.success,borderColor:N.success,tension:.3,fill:!1}]}}),c=U(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[t.data.newTickets||0,t.data.closedTickets||0],backgroundColor:[N.primary,N.success],borderWidth:1}]})),f=U(()=>{switch(m.value){case"line":return z;case"bar":return ie;case"doughnut":return re;default:return z}}),k=U(()=>m.value==="doughnut"?c.value:r.value),b=U(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:(E,h,S)=>{var d,i;if(h.length===0)return;const u=h[0].datasetIndex,o=S.data.datasets[u];!o||!o.label||(o.label==="Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"?(((d=t.data)==null?void 0:d.responsible)||[]).length>0&&a("open-responsible"):o.label==="ÐÐ¾Ð²Ñ‹Ðµ"&&(((i=t.data)==null?void 0:i.newTickets)||0)>0&&a("open-stages"))},scales:m.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(E,h)=>{var S,C;return g(),y("div",ue,[s("header",me,[s("div",null,[h[0]||(h[0]=s("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),s("p",ge," ÐÐµÐ´ÐµÐ»Ñ "+w(_.value)+" Â· "+w(((S=p.meta)==null?void 0:S.weekStartUtc)||"â€”")+" â€” "+w(((C=p.meta)==null?void 0:C.weekEndUtc)||"â€”")+" (UTC) ",1)]),s("div",ye,[s("div",_e,[(g(),y(Y,null,L(l,u=>s("button",{key:u.value,class:x(["chart-type-btn",{active:m.value===u.value}]),onClick:o=>m.value=u.value},[s("span",fe,w(u.icon),1),s("span",ve,w(u.label),1)],10,pe)),64))])])]),s("section",he,[s("div",ke,[h[1]||(h[1]=s("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),s("div",Te,w(p.data.newTickets??0),1)]),s("div",Ie,[h[2]||(h[2]=s("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),s("div",we,w(p.data.closedTickets??0),1)]),s("div",be,[h[3]||(h[3]=s("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),s("div",Ee,[(g(!0),y(Y,null,L(p.data.stages||[],u=>(g(),y("span",{key:u.stageId,class:"stage-tag"},w(u.stageName||u.stageId)+" â€” "+w(u.count),1))),128)),!p.data.stages||p.data.stages.length===0?(g(),y("span",Se," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):R("",!0)])])]),s("div",Ce,[(g(),O(se(f.value),{data:k.value,options:b.value},null,8,["data","options"]))])])}}},Ue=W(De,[["__scopeId","data-v-3bdb54dd"]]);class q{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const t=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",t);const a=await this.getEmployeesByIds(t);return console.log("Loaded employees:",a.length),{stages:this.groupTicketsByStages(e,a),employees:a,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],t=[];for(const a of e){console.log(`Loading tickets for stage: ${a}`);const l=await this.getTicketsByStage(a);t.push(...l),console.log(`Loaded ${l.length} tickets for stage ${a}`)}return t}static async getTicketsByStage(e){const t=[];let a=0;const l=50;let m=!0;for(;m;)try{const r=await P.call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let c=[];r&&r.result&&(Array.isArray(r.result)?c=r.result:r.result.items&&Array.isArray(r.result.items)?c=r.result.items:r.result.data&&Array.isArray(r.result.data)&&(c=r.result.data)),c.length>0?(t.push(...c),a+=c.length,m=c.length===l):m=!1}catch(r){console.error(`Error loading tickets batch for stage ${e} (start: ${a}):`,r),m=!1}t.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(t[0],null,2)),console.log("Sample ticket keys:",Object.keys(t[0])),console.log("Sample ticket assignedById variants:",{assignedById:t[0].assignedById,assignedByIdId:t[0].assignedByIdId,ASSIGNED_BY_ID:t[0].ASSIGNED_BY_ID}));const _=t.filter(r=>{const c=r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product;return Array.isArray(c)?c.includes(this.SECTOR_TAG):typeof c=="object"&&c!==null?c.value===this.SECTOR_TAG||c===this.SECTOR_TAG:c===this.SECTOR_TAG});return console.log(`Filtered ${_.length} tickets from ${t.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),_}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(a=>{const l=a.assignedById||a.assignedByIdId||a.ASSIGNED_BY_ID||a.assignedById||a.assignedById&&typeof a.assignedById=="object"&&(a.assignedById.id||a.assignedById.ID)||a.assignedById&&typeof a.assignedById=="object"&&a.assignedById.value;if(l){const m=parseInt(l);m&&!isNaN(m)&&m>0&&t.add(m)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(t))),Array.from(t)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await P.call("user.get",{filter:{ID:e}});let a=[];return t&&t.result&&(Array.isArray(t.result)?a=t.result:console.warn("Unexpected user.get result format:",t)),a.map(l=>({id:parseInt(l.ID||l.id||0),name:`${l.NAME||l.name||""} ${l.LAST_NAME||l.lastName||""}`.trim()||l.EMAIL||l.email||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",position:l.WORK_POSITION||l.workPosition||"Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº",email:l.EMAIL||l.email||"",tickets:[]}))}catch(t){return console.error("Error getting employees by IDs:",t),[]}}static groupTicketsByStages(e,t){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(t)||(console.warn("Employees is not an array:",t),t=[]);const a=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff",employees:t.map(l=>({...l,tickets:[]}))},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107",employees:t.map(l=>({...l,tickets:[]}))},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745",employees:t.map(l=>({...l,tickets:[]}))}];return e.forEach(l=>{const m=this.mapStageId(l.stageId||l.STAGE_ID||""),_=a.find(r=>r.id===m);if(_){const r=l.assignedById||l.ASSIGNED_BY_ID||null,c=r?parseInt(r):null;if(c){let f=_.employees.find(k=>k.id===c);f||(f={id:c,name:`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${c}`,position:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾",email:"",tickets:[]},_.employees.push(f)),f.tickets.push(this.mapTicket(l))}}}),a}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const t=parseInt(e.id||e.ID||0),a=e.title||e.TITLE||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",l=e.stageId||e.STAGE_ID||"",m=e.assignedById||e.ASSIGNED_BY_ID||null,_=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",r=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",c=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,f=Z(c),k=ce(f);return{id:t,title:a,priorityId:f.id,priorityLabel:f.label,priorityColors:k,priority:f.id,priorityBitrixValue:f.bitrixValue||null,status:this.mapStatus(l),assigneeId:m?parseInt(m):null,stageId:this.mapStageId(l),createdAt:_,modifiedAt:r,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return Z(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const t=J(e);if(t&&t.bitrixValue)return t.bitrixValue;const a={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return a[e]?a[e]:J(de).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(a=>!(a.assignedById||a.ASSIGNED_BY_ID)).forEach(a=>{const l=this.mapStageId(a.stageId||a.STAGE_ID||"");t[l]&&t[l].push(this.mapTicket(a))}),t):(console.warn("Tickets is not an array in getZeroPointTickets:",e),t)}static async assignTicket(e,t,a){try{const l=this.mapStageIdToBitrix(a);return(await P.call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:t,stageId:l}})).result===!0}catch(l){throw console.error("Error assigning ticket:",l),l}}static async createTicket(e){try{const t=await P.call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const t=await P.call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await P.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:t}})).result!==void 0}catch(a){throw console.error("Error adding comment:",a),a}}}H(q,"ENTITY_TYPE_ID",140),H(q,"SECTOR_TAG","1C");const Ae="/api/graph-1c-admission-closure.php";function Be(p){var t,a,l,m,_,r,c,f,k,b,E;if(!p)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const e=p.data||p.result||p;return{meta:e.meta||p.meta||null,data:{newTickets:((t=e.data)==null?void 0:t.newTickets)??e.newTickets??0,closedTickets:((a=e.data)==null?void 0:a.closedTickets)??e.closedTickets??0,series:{new:((m=(l=e.data)==null?void 0:l.series)==null?void 0:m.new)??((_=e.series)==null?void 0:_.new)??[0],closed:((c=(r=e.data)==null?void 0:r.series)==null?void 0:c.closed)??((f=e.series)==null?void 0:f.closed)??[0]},stages:((k=e.data)==null?void 0:k.stages)??e.stages??[],responsible:((b=e.data)==null?void 0:b.responsible)??e.responsible??[],newTicketsByStages:((E=e.data)==null?void 0:E.newTicketsByStages)??e.newTicketsByStages??null}}}async function F(p={}){const{endpoint:e=Ae,product:t="1C",weekStartUtc:a=null,weekEndUtc:l=null,useCache:m=!0,forceRefresh:_=!1,includeTickets:r=!1,includeNewTicketsByStages:c=!1}=p,k=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:t,weekStartUtc:a,weekEndUtc:l,useCache:m,forceRefresh:_,includeTickets:r,includeNewTicketsByStages:c})});if(!k.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${k.status})`);const b=await k.json();if((b==null?void 0:b.success)===!1)throw new Error(b.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return Be(b)}const $e={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Re={class:"modal"},Ne={key:"level-1",class:"level-1"},Pe={class:"modal__header"},Oe={class:"modal__body"},Me={key:"loading",class:"loading-names"},Ye={key:"empty",class:"modal__empty"},Le={key:"list",class:"responsible-list"},Ge=["onClick"],Ve={class:"responsible-list__name"},Fe={class:"responsible-list__count"},We={key:0,class:"responsible-list__arrow"},je={class:"modal__footer"},He={key:"level-2",class:"level-2"},qe={class:"modal__header"},xe={class:"modal__title"},ze={class:"modal__body"},Ze={key:"loading",class:"loading-state"},Je={key:"error",class:"error-state"},Xe={class:"error-message"},Ke={key:"empty",class:"empty-state"},Qe={key:"tickets",class:"tickets-list-container"},et={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},setup(p){const e=p,t=v(1),a=v(null),l=v([]),m=v(!1),_=v(null),r=v([]),c=v(!1);async function f(u){const o=u.filter(d=>d.id!==null&&d.id!==void 0).map(d=>d.id);if(o.length===0)return u;try{const d=await q.getEmployeesByIds(o),i=new Map;return d.forEach(n=>{i.set(n.id,n.name)}),u.map(n=>n.id&&i.has(n.id)?{...n,name:i.get(n.id)}:n)}catch(d){return console.error("[ResponsibleModal] Error enriching names:",d),u}}V(()=>e.responsible,async u=>{if(!u||u.length===0){r.value=[];return}c.value=!0;try{r.value=await f(u)}catch(o){console.error("[ResponsibleModal] Error loading employee names:",o),r.value=u}finally{c.value=!1}},{immediate:!0});const k=U(()=>(r.value||[]).length>0);async function b(u,o=null){!u||!u.id||u.count===0||(o&&o.currentTarget&&(o.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{o.currentTarget&&(o.currentTarget.style.transform="")},150)),a.value=u,t.value=2,await E(u.id))}async function E(u){m.value=!0,_.value=null;try{if(!e.weekStartUtc||!e.weekEndUtc)throw new Error("ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð½ÐµÐ´ÐµÐ»Ð¸");const d=(await F({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0})).data.responsible.find(n=>n.id===u),i=(d==null?void 0:d.tickets)||[];l.value=i.map(n=>({id:n.id,title:n.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",ufSubject:n.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",createdTime:n.createdTime,createdAt:n.createdTime,updatedTime:n.movedTime,modifiedAt:n.movedTime,stageId:n.stageId,assignedById:n.assignedById,priorityId:"medium",priorityLabel:"Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹",priorityColors:{color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},priority:"medium"})),l.value.length===0&&(_.value=null)}catch(o){_.value=o.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",console.error("[ResponsibleModal] Error loading tickets:",o),l.value=[]}finally{m.value=!1}}function h(){t.value=1,a.value=null,l.value=[],_.value=null}function S(u){const o=Q(u.id);window.open(o,"_blank")}function C(){a.value&&E(a.value.id)}return V(()=>e.isVisible,u=>{u||(t.value=1,a.value=null,l.value=[],_.value=null)}),(u,o)=>p.isVisible?(g(),y("div",$e,[s("div",Re,[D(M,{name:"level",mode:"out-in"},{default:B(()=>{var d;return[t.value===1?(g(),y("div",Ne,[s("header",Pe,[o[3]||(o[3]=s("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),s("button",{class:"modal__close",onClick:o[0]||(o[0]=i=>u.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),s("section",Oe,[D(M,{name:"loading",mode:"out-in"},{default:B(()=>[c.value?(g(),y("div",Me,[...o[4]||(o[4]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð¼Ñ‘Ð½ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²...",-1)])])):k.value?(g(),y("ul",Le,[(g(!0),y(Y,null,L(r.value,i=>(g(),y("li",{key:i.id||i.name,class:x(["responsible-list__item",{"responsible-list__item--clickable":i.id&&i.count>0}]),onClick:n=>b(i,n),title:"ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°"},[s("span",Ve,w(i.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1),s("span",Fe,w(i.count??0)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ",1),i.id&&i.count>0?(g(),y("span",We,"â†’")):R("",!0)],10,Ge))),128))])):(g(),y("p",Ye,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),_:1})]),s("footer",je,[s("button",{class:"btn",onClick:o[1]||(o[1]=i=>u.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])):t.value===2?(g(),y("div",He,[s("header",qe,[s("button",{class:"btn-back",onClick:h,"aria-label":"ÐÐ°Ð·Ð°Ð´"},"â† ÐÐ°Ð·Ð°Ð´"),s("h3",xe,"Ð¢Ð¸ÐºÐµÑ‚Ñ‹ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°: "+w(((d=a.value)==null?void 0:d.name)||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"),1),s("button",{class:"modal__close",onClick:o[2]||(o[2]=i=>u.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),s("section",ze,[D(M,{name:"loading",mode:"out-in"},{default:B(()=>[m.value?(g(),y("div",Ze,[...o[5]||(o[5]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²...",-1)])])):_.value?(g(),y("div",Je,[o[6]||(o[6]=s("div",{class:"error-icon"},"âš ï¸",-1)),o[7]||(o[7]=s("p",{class:"error-title"},"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",-1)),s("p",Xe,w(_.value),1),s("button",{class:"btn btn-retry",onClick:C},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ")])):l.value.length===0?(g(),y("div",Ke,[...o[8]||(o[8]=[s("div",{class:"empty-state-icon"},"ðŸ“‹",-1),s("p",{class:"empty-state-message"},"Ð£ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð·Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)])])):(g(),y("div",Qe,[D(X,{name:"ticket",tag:"div",class:"tickets-list"},{default:B(()=>[(g(!0),y(Y,null,L(l.value,(i,n)=>(g(),O(K,{key:i.id,ticket:i,draggable:!1,style:G({"--ticket-index":n}),onClick:S},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):R("",!0)]}),_:1})])])):R("",!0)}},tt=W(et,[["__scopeId","data-v-ec41a840"]]),st={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},at={class:"modal"},lt={key:"level-1",class:"level-1"},ot={class:"modal__header"},nt={class:"modal__body"},rt={key:"loading",class:"loading-names"},it={key:"empty",class:"modal__empty"},ct={key:"list",class:"stages-list"},dt=["onClick"],ut={class:"stages-list__name"},mt={class:"stages-list__count"},gt={key:0,class:"stages-list__arrow"},yt={class:"modal__footer"},_t={key:"level-2",class:"level-2"},pt={class:"modal__header"},ft={class:"modal__title"},vt={class:"modal__body"},ht={key:"loading",class:"loading-state"},kt={key:"error",class:"error-state"},Tt={class:"error-message"},It={key:"empty",class:"empty-state"},wt={class:"empty-state-message"},bt={key:"tickets",class:"tickets-list-container"},Et={__name:"StagesModal",props:{isVisible:{type:Boolean,default:!1},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},emits:["close"],setup(p,{emit:e}){const t=p,a=v(1),l=v(null),m=v([]),_=v(!1),r=v(!1),c=v(null),f=v([]),k=U(()=>f.value.length>0&&f.value.some(o=>o.count>0));async function b(){if(!t.weekStartUtc||!t.weekEndUtc){f.value=[];return}r.value=!0,c.value=null;try{const o=await F({product:"1C",weekStartUtc:t.weekStartUtc,weekEndUtc:t.weekEndUtc,includeNewTicketsByStages:!0});f.value=o.data.newTicketsByStages||[]}catch(o){c.value=o.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ð°Ð´Ð¸Ð¹",console.error("[StagesModal] Error loading stages:",o),f.value=[]}finally{r.value=!1}}async function E(o,d=null){!o||o.count===0||(d&&d.currentTarget&&(d.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{d.currentTarget&&(d.currentTarget.style.transform="")},150)),l.value=o,a.value=2,await h(o.stageId))}async function h(o){var d;_.value=!0,c.value=null;try{if(!t.weekStartUtc||!t.weekEndUtc)throw new Error("ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð½ÐµÐ´ÐµÐ»Ð¸");const n=(d=(await F({product:"1C",weekStartUtc:t.weekStartUtc,weekEndUtc:t.weekEndUtc,includeNewTicketsByStages:!0,includeTickets:!0})).data.newTicketsByStages)==null?void 0:d.find(I=>I.stageId===o),T=(n==null?void 0:n.tickets)||[];m.value=T.map(I=>({id:I.id,title:I.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",ufSubject:I.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",createdTime:I.createdTime,createdAt:I.createdTime,stageId:I.stageId,assignedById:I.assignedById,priorityId:"medium",priorityLabel:"Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹",priorityColors:{color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},priority:"medium"})),m.value.length===0&&(c.value=null)}catch(i){c.value=i.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",console.error("[StagesModal] Error loading tickets:",i),m.value=[]}finally{_.value=!1}}function S(){a.value=1,l.value=null,m.value=[],c.value=null}function C(o){const d=Q(o.id);window.open(d,"_blank")}function u(){l.value&&h(l.value.stageId)}return V(()=>t.isVisible,o=>{o?b():(a.value=1,l.value=null,m.value=[],c.value=null,f.value=[])}),V([()=>t.weekStartUtc,()=>t.weekEndUtc],()=>{t.isVisible&&b()}),(o,d)=>p.isVisible?(g(),y("div",st,[s("div",at,[D(M,{name:"level",mode:"out-in"},{default:B(()=>{var i;return[a.value===1?(g(),y("div",lt,[s("header",ot,[d[3]||(d[3]=s("h3",{class:"modal__title"},"ÐÐ¾Ð²Ñ‹Ðµ Ñ‚Ð¸ÐºÐµÑ‚Ñ‹ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),s("button",{class:"modal__close",onClick:d[0]||(d[0]=n=>o.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),s("section",nt,[D(M,{name:"loading",mode:"out-in"},{default:B(()=>[r.value?(g(),y("div",rt,[...d[4]||(d[4]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ð°Ð´Ð¸Ð¹...",-1)])])):k.value?(g(),y("ul",ct,[(g(!0),y(Y,null,L(f.value,n=>(g(),y("li",{key:n.stageId,class:x(["stages-list__item",{"stages-list__item--clickable":n.count>0}]),style:G({"--stage-color":n.color}),onClick:T=>E(n,T),title:"ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÑ‚Ð°Ð´Ð¸Ð¸"},[s("span",{class:"stages-list__color",style:G({backgroundColor:n.color})},null,4),s("span",ut,w(n.stageName),1),s("span",mt,w(n.count)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ",1),n.count>0?(g(),y("span",gt,"â†’")):R("",!0)],14,dt))),128))])):(g(),y("p",it," ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð·Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ "))]),_:1})]),s("footer",yt,[s("button",{class:"btn",onClick:d[1]||(d[1]=n=>o.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])):a.value===2?(g(),y("div",_t,[s("header",pt,[s("button",{class:"btn-back",onClick:S,"aria-label":"ÐÐ°Ð·Ð°Ð´"},"â† ÐÐ°Ð·Ð°Ð´"),s("h3",ft," Ð¢Ð¸ÐºÐµÑ‚Ñ‹ ÑÑ‚Ð°Ð´Ð¸Ð¸: "+w(((i=l.value)==null?void 0:i.stageName)||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"),1),s("button",{class:"modal__close",onClick:d[2]||(d[2]=n=>o.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),s("section",vt,[D(M,{name:"loading",mode:"out-in"},{default:B(()=>{var n;return[_.value?(g(),y("div",ht,[...d[5]||(d[5]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²...",-1)])])):c.value?(g(),y("div",kt,[d[6]||(d[6]=s("div",{class:"error-icon"},"âš ï¸",-1)),d[7]||(d[7]=s("p",{class:"error-title"},"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",-1)),s("p",Tt,w(c.value),1),s("button",{class:"btn btn-retry",onClick:u},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ")])):m.value.length===0?(g(),y("div",It,[d[8]||(d[8]=s("div",{class:"empty-state-icon"},"ðŸ“‹",-1)),s("p",wt," ÐÐ° ÑÑ‚Ð°Ð´Ð¸Ð¸ Â«"+w((n=l.value)==null?void 0:n.stageName)+"Â» Ð½ÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð·Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ ",1)])):(g(),y("div",bt,[D(X,{name:"ticket",tag:"div",class:"tickets-list"},{default:B(()=>[(g(!0),y(Y,null,L(m.value,(T,I)=>(g(),O(K,{key:T.id,ticket:T,draggable:!1,style:G({"--ticket-index":I}),onClick:C},null,8,["ticket","style"]))),128))]),_:1})]))]}),_:1})])])):R("",!0)]}),_:1})])])):R("",!0)}},St=W(Et,[["__scopeId","data-v-58a39c4e"]]),Ct={class:"ac-dashboard"},Dt={key:1},Ut={class:"dashboard-layout"},At={class:"filters-container"},Bt={class:"chart-container"},$t={__name:"GraphAdmissionClosureDashboard",setup(p){const e=v(!0),t=v(null),a=v(null),l=v({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),m=v(!1),_=v(!1),r=v({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),c=v(null),f=U(()=>{const i=r.value.customDateRange.startDate||r.value.customDateRange.endDate,n=r.value.employees.length===1&&r.value.employees.includes("all");return i||!n});async function k(){e.value=!0,t.value=null;try{let i,n;if(c.value)i=c.value.startUtc,n=c.value.endUtc;else{const A=d();i=A.weekStartUtc,n=A.weekEndUtc}const{meta:T,data:I}=await F({product:"1C",weekStartUtc:i,weekEndUtc:n});a.value=T,l.value=I,!c.value&&T&&(c.value={weekNumber:T.weekNumber,startUtc:T.weekStartUtc,endUtc:T.weekEndUtc})}catch(i){t.value=i instanceof Error?i:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",i)}finally{e.value=!1}}function b(i){r.value.stages=i}function E(i){r.value.employees=i}function h(i){r.value.dateRange=i}function S(i){r.value.customDateRange=i}function C(i){c.value=i}function u(){r.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},o()}function o(){k()}ae(()=>{k()});function d(){const i=new Date,n=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate())),T=n.getUTCDay(),I=n.getUTCDate()-T+(T===0?-6:1),A=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),I,0,0,0)),$=new Date(A);return $.setUTCDate($.getUTCDate()+6),$.setUTCHours(23,59,59,999),{weekStartUtc:A.toISOString(),weekEndUtc:$.toISOString()}}return(i,n)=>{var T,I,A,$;return g(),y("div",Ct,[e.value?(g(),O(oe,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(g(),y("div",Dt,[n[4]||(n[4]=s("div",{class:"dashboard-header"},[s("div",null,[s("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),s("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),s("div",Ut,[s("div",At,[D(ne,{stages:r.value.stages,employees:r.value.employees,dateRange:r.value.dateRange,customDateRange:r.value.customDateRange,hasActiveFilters:f.value,hideStages:!0,weekPickerMode:!0,selectedWeek:c.value,weeksCount:52,"onUpdate:stages":b,"onUpdate:employees":E,"onUpdate:dateRange":h,"onUpdate:customDateRange":S,"onUpdate:selectedWeek":C,onReset:u,onApply:o},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","selectedWeek"])]),s("div",Bt,[t.value?(g(),O(le,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:t.value.message},null,8,["message"])):(g(),O(Ue,{key:1,meta:a.value,data:l.value,onOpenResponsible:n[0]||(n[0]=j=>m.value=!0),onOpenStages:n[1]||(n[1]=j=>_.value=!0)},null,8,["meta","data"]))])])])),D(tt,{"is-visible":m.value,responsible:l.value.responsible||[],"week-start-utc":((T=a.value)==null?void 0:T.weekStartUtc)||null,"week-end-utc":((I=a.value)==null?void 0:I.weekEndUtc)||null,onClose:n[2]||(n[2]=j=>m.value=!1)},null,8,["is-visible","responsible","week-start-utc","week-end-utc"]),D(St,{"is-visible":_.value,"week-start-utc":((A=a.value)==null?void 0:A.weekStartUtc)||null,"week-end-utc":(($=a.value)==null?void 0:$.weekEndUtc)||null,onClose:n[3]||(n[3]=j=>_.value=!1)},null,8,["is-visible","week-start-utc","week-end-utc"])])}}},Yt=W($t,[["__scopeId","data-v-fb08313e"]]);export{Yt as default};
