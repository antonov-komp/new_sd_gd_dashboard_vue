import{_ as ie,a as E,o as D,d as c,F as ve,f as ye,j as Y,n as we,t as L,g as he,b as z,G as wt,i as le,H as ft,r as _,c as V,I as St,m as Se,J as Be,k as Q,p as Me,K as qe,x as kt,L as bt,u as Fe,M as gt,C as mt,N as Pe,l as Le,B as Je,D as Dt,O as Et,P as Tt,y as Re,Q as me,z as Ct,e as $t}from"./main-CeSGKl5U.js";import{L as ut,D as _t,B as At}from"./index-C50tXGCK.js";import{S as Ge,d as Ye,K as It,D as dt,e as pt,B as xt}from"./index-lJ56ifOd.js";const ne={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class re{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,s={}){try{if(!e||typeof e!="object")throw new fe("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new fe("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const o=this.validateSectorData(e);if(!o.isValid)throw new fe(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});const a=this.normalizeSectorData(e),l={metadata:this.generateSnapshotMetadata(t,s.createdBy,s.sectorId||ne.defaultSectorId),statistics:a.statistics,ticketIds:a.ticketIds,tickets:a.tickets},r=this.validateSnapshot(l);if(!r.isValid)throw new fe(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});r.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",r.warnings);const i=this.getApiBaseUrl(),f=await fetch(`${i}${ne.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:t,date:this.formatDate(new Date)})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const v=await f.json();if(!v.success)throw new Error(v.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return v.data.snapshot}catch(o){throw console.error("SnapshotService.createSnapshot error:",o),o instanceof fe?o:new fe(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${o.message}`,"API_ERROR",{originalError:o})}}static async getSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}?action=get&date=${s}&type=${t}`,n=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success){if(l.message&&l.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω"))return null;throw new Error(l.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞")}return l.data.snapshot}catch(s){throw console.error("SnapshotService.getSnapshot error:",s),s}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",ne.defaultSectorId);const o=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}?${t.toString()}`,a=await fetch(o,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(!n.success)throw new Error(n.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(n.data.snapshots.map(async r=>{try{return await this.getSnapshot(r.date,r.type)}catch(i){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${r.date}/${r.type}:`,i),null}}))).filter(r=>r!==null).sort((r,i)=>new Date(r.metadata.createdAt)-new Date(i.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:s=[],zeroPointTickets:o={}}=e,a={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},n=[],l=[],r=[];t.forEach(v=>{const p=v.id;if(a[p]){let b=0;v.employees.forEach(k=>{const y=k.tickets||[];b+=y.length;let g=n.find(h=>h.id===k.id);g||(g={id:k.id,name:k.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(g)),y.forEach(h=>{l.push(h.id),r.push({id:h.id,title:h.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:k.id,name:k.name},createdAt:h.createdAt||"",updatedAt:h.modifiedAt||h.updatedAt||""}),g.ticketsByStage[p]=(g.ticketsByStage[p]||0)+1,g.totalTickets+=1})}),a[p].count=b}});const i={unassigned:0,keeper:0,total:0};Object.values(o).forEach(v=>{Array.isArray(v)&&v.forEach(p=>{i.total+=1,p.assigneeId===1051||p.assignedById===1051?i.keeper+=1:i.unassigned+=1,l.push(p.id),r.push({id:p.id,title:p.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:p.assignedTo||p.assignedById?{id:p.assignedById||p.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:p.createdAt||"",updatedAt:p.modifiedAt||p.updatedAt||""})})});const f=Object.values(a).reduce((v,p)=>v+p.count,0)+i.total;return{statistics:{stages:{...a,total:f},employees:n,zeroPoint:i},ticketIds:[...new Set(l)],tickets:r}}static generateSnapshotMetadata(e,t,s){const o=new Date,a=-o.getTimezoneOffset(),n=Math.floor(a/60),l=a%60,r=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(l).padStart(2,"0")}`,i=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}T${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}:${String(o.getSeconds()).padStart(2,"0")}${r}`;return{version:ne.snapshotVersion,createdAt:i,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:s,sectorName:s==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${s}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${o}`}static buildFilePath(e,t){const s=typeof e=="string"?new Date(e):e,o=s.getFullYear(),a=this.getWeekNumber(s),n=this.formatDate(e);let l;if(t==="current"){const r=new Date,i=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;l=`current-state-${n}-${i}.json`}else if(t==="manual"){const r=new Date,i=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;l=`manual-${n}-${i}.json`}else l=`${t}-${n}.json`;return t==="current"?`current/${l}`:`${o}/week-${a}/${l}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),s=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-s);const o=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-o)/864e5+1)/7)}static validateSnapshot(e){var o,a,n;const t=[],s=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const l=e.statistics.stages,r=(((o=l.formed)==null?void 0:o.count)||0)+(((a=l.review)==null?void 0:a.count)||0)+(((n=l.execution)==null?void 0:n.count)||0);l.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${l.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const l=e.statistics.zeroPoint,r=(l.unassigned||0)+(l.keeper||0);l.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${l.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const l=new Set(e.ticketIds),r=new Set(e.tickets.map(i=>i.id));l.size!==r.size&&s.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((i,f)=>{i.id||t.push(`–¢–∏–∫–µ—Ç #${f}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),i.title||t.push(`–¢–∏–∫–µ—Ç #${f}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!i.assignedTo||!i.assignedTo.id)&&s.push(`–¢–∏–∫–µ—Ç #${f}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),i.createdAt||t.push(`–¢–∏–∫–µ—Ç #${f}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),i.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${f}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:s}}static validateSectorData(e){const t=[],s=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:s}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:s})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${ne.snapshotsEndpoint}`,n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:s,type:t})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(s){throw console.error("SnapshotService.deleteSnapshot error:",s),s}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let s=0;for(const o of t)try{await this.deleteSnapshot(o.metadata.createdAt.split("T")[0],o.metadata.type)&&s++}catch(a){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${o.metadata.createdAt}:`,a)}return s}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=ne.snapshotVersion){const s=this.getSnapshotVersion(e);return s===t||s==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${s} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,s=this.getWeekNumber(t);return{year:t.getFullYear(),week:s}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,o=(t.getDay()||7)-1,a=new Date(t);return a.setDate(t.getDate()-o),a.setHours(0,0,0,0),a}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,o=7-(t.getDay()||7),a=new Date(t);return a.setDate(t.getDate()+o),a.setHours(23,59,59,999),a}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),s=this.getWeekEndDate(e),o=this.getWeekNumberInfo(e),a=await this.getAllSnapshots({startDate:t,endDate:s}),n=a.find(i=>i.metadata.type==="week_start")||null,l=a.find(i=>i.metadata.type==="week_end")||null,r=a.filter(i=>i.metadata.type==="manual");return{weekStart:n,weekEnd:l,manual:r,weekInfo:o}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof fe)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),s={week_start:0,week_end:0,manual:0,current:0},o=new Map;let a=null,n=null;t.forEach(r=>{const i=r.metadata.type;s.hasOwnProperty(i)&&s[i]++;const f=this.getWeekNumberInfo(r.metadata.createdAt),v=`${f.year}-W${f.week}`;o.set(v,(o.get(v)||0)+1);const p=new Date(r.metadata.createdAt);(!a||p<new Date(a.metadata.createdAt))&&(a=r),(!n||p>new Date(n.metadata.createdAt))&&(n=r)});const l=Array.from(o.entries()).map(([r,i])=>{const[f,v]=r.split("-W");return{year:parseInt(f),week:parseInt(v),count:i}}).sort((r,i)=>r.year!==i.year?r.year-i.year:r.week-i.week);return{total:t.length,byType:s,byWeek:l,oldest:a,newest:n}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class fe extends Error{constructor(e,t,s={}){super(e),this.name="SnapshotError",this.code=t,this.details=s}}const oe={formed:{bitrixId:Ye.formed,name:Ge.FORMED.name},review:{bitrixId:Ye.review,name:Ge.REVIEW.name},execution:{bitrixId:Ye.execution,name:Ge.EXECUTION.name}},$e=It;function Bt(u){if(!u||typeof u!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!u.stages||!Array.isArray(u.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Mt(u.stages),t=Rt(u.stages),s=Ot(u.zeroPointTickets||{}),o=Nt(u.zeroPointTickets||{}),a=Ft(u.stages,u.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:s,zeroPointByStage:o},ticketIds:a.ticketIds,tickets:a.tickets}}function Mt(u){const e={formed:{count:0,stageId:oe.formed.bitrixId,stageName:oe.formed.name},review:{count:0,stageId:oe.review.bitrixId,stageName:oe.review.name},execution:{count:0,stageId:oe.execution.bitrixId,stageName:oe.execution.name},total:0};return u.forEach(t=>{if(!oe[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let s=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(o=>{o.tickets&&Array.isArray(o.tickets)&&(s+=o.tickets.length)}),e[t.id].count=s,e.total+=s}),e}function Rt(u){const e=new Map;return u.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(s=>{if(!s||!s.id)return;e.has(s.id)||e.set(s.id,{id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const o=e.get(s.id),a=s.tickets&&Array.isArray(s.tickets)?s.tickets.length:0;oe[t.id]&&(o.ticketsByStage[t.id]=(o.ticketsByStage[t.id]||0)+a),o.totalTickets+=a})}),Array.from(e.values())}function Ot(u){let e=0,t=0;return!u||typeof u!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(u).forEach(s=>{Array.isArray(s)&&s.forEach(o=>{if(!o)return;const a=o.assignedTo||o.assignedById;!a||a===null?e++:(typeof a=="object"?a.id:a)===$e?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function Nt(u){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!u||typeof u!="object"||Object.keys(e).forEach(t=>{const s=u[t];Array.isArray(s)&&s.forEach(o=>{if(!o)return;const a=o.assignedTo||o.assignedById;!a||a===null?e[t].unassigned++:(typeof a=="object"?a.id:a)===$e?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function Ft(u,e){const t=new Set,s=new Map;return Array.isArray(u)&&u.forEach(o=>{!o.employees||!Array.isArray(o.employees)||o.employees.forEach(a=>{!a.tickets||!Array.isArray(a.tickets)||a.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID:",n.id);return}t.add(l);let r=n.assignedTo;!r&&a.id&&(r={id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`}),s.set(l,{id:l,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:r||null,createdAt:xe(n.createdAt||n.createdTime),updatedAt:xe(n.updatedAt||n.modifiedAt||n.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(o=>{Array.isArray(o)&&o.forEach(a=>{if(!a||!a.id){console.warn("Ticket without ID found in zero point:",a);return}const n=parseInt(a.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",a.id);return}t.add(n);let l=a.assignedTo;if(!l&&a.assignedById){const r=typeof a.assignedById=="object"?a.assignedById.id||a.assignedById.value:a.assignedById;r&&r!==$e?l={id:r,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:r===$e&&(l={id:$e,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}s.set(n,{id:n,title:a.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:l||null,createdAt:xe(a.createdAt||a.createdTime),updatedAt:xe(a.updatedAt||a.modifiedAt||a.updatedTime)})})}),{ticketIds:Array.from(t).sort((o,a)=>o-a),tickets:Array.from(s.values())}}function xe(u){if(!u)return null;if(u instanceof Date)return u.toISOString();if(typeof u=="string"){if(u.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return u;const e=new Date(u);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",u),null}class Ze{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:s=null,normalize:o=!0,includeTicketDetails:a=!1}=e;try{const n=await dt.getSectorData(t,s);return o?Bt(n):(a&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),n)}catch(n){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",n),n}}static async isDataAvailable(){try{const e=await dt.getSectorData(!0);return e!=null}catch{return!1}}}class Xe{static compareTwoSnapshots(e,t,s={}){const{includeTickets:o=!1,includeEmployees:a=!0}=s,n=this.validateSnapshot(e),l=this.validateSnapshot(t);if(!n.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...l.errors].join(", "));const r=this.buildComparisonMetadata(e,t),i=this.compareStages(e.statistics.stages,t.statistics.stages),f=a?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],v=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),p=o?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,b=this.buildSummary(i,f,v,p);return{metadata:r,stages:i,employees:f,zeroPoint:v,tickets:p,summary:b}}static calculateDelta(e,t){const s=this.normalizeValue(e),o=this.normalizeValue(t),a=o-s;let n=0;s!==0?n=a/s*100:o!==0&&(n=o>0?1/0:-1/0);const l=this.getTrend(a);return{value1:s,value2:o,delta:a,deltaPercent:Math.round(n*100)/100,trend:l}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var l,r;const s=["formed","review","execution"],o={};for(const i of s){const f=((l=e[i])==null?void 0:l.count)||0,v=((r=t[i])==null?void 0:r.count)||0;o[i]=this.calculateDelta(f,v)}const a=e.total||0,n=t.total||0;return o.total=this.calculateDelta(a,n),o}static compareEmployees(e,t){var l,r;const s=new Map(e.map(i=>[i.id,i])),o=new Map(t.map(i=>[i.id,i])),a=new Set([...s.keys(),...o.keys()]),n=[];for(const i of a){const f=s.get(i)||null,v=o.get(i)||null;if(!f||!v){n.push({id:i,name:(f==null?void 0:f.name)||(v==null?void 0:v.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,snapshot2:v?{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0}:null,delta:this.calculateEmployeeDelta(f,v),trend:f?"removed":"new"});continue}const p={},b=["formed","review","execution"];for(const y of b){const g=((l=f.ticketsByStage)==null?void 0:l[y])||0,h=((r=v.ticketsByStage)==null?void 0:r[y])||0;p[y]=this.calculateDelta(g,h)}const k=this.calculateDelta(f.totalTickets||0,v.totalTickets||0);n.push({id:i,name:f.name,snapshot1:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},snapshot2:{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0},delta:{ticketsByStage:p,totalTickets:k},trend:k.trend})}return n}static calculateEmployeeDelta(e,t){var n,l;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const s={},o=["formed","review","execution"];for(const r of o){const i=((n=e==null?void 0:e.ticketsByStage)==null?void 0:n[r])||0,f=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[r])||0;s[r]=this.calculateDelta(i,f)}const a=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:s,totalTickets:a}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,s,o){var b,k;const a=new Set(e),n=new Set(t),l=t.filter(y=>!a.has(y)),r=e.filter(y=>!n.has(y)),i=[],f=[],v=new Map(s.map(y=>[y.id,y])),p=new Map(o.map(y=>[y.id,y]));for(const y of e){if(!n.has(y))continue;const g=v.get(y),h=p.get(y);if(!g||!h)continue;const T=(((b=g.assignedTo)==null?void 0:b.id)||null)!==(((k=h.assignedTo)==null?void 0:k.id)||null),W=(g.stageId||null)!==(h.stageId||null);T||W?i.push(y):f.push(y)}return{new:l,removed:r,changed:i,unchanged:f}}static buildComparisonMetadata(e,t){const s=new Date(e.metadata.createdAt),o=new Date(t.metadata.createdAt),a=new Date,n=o.getTime()-s.getTime(),l=Math.floor(n/(1e3*60*60*24)),r=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:a.toISOString(),timeDiff:{days:l,hours:r,minutes:i,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,t,s,o){var i,f,v;const a=e.total.delta,n=Object.keys(e).filter(p=>p==="total"?!1:e[p].delta!==0).length,l=t.filter(p=>p.trend==="new"||p.trend==="removed"?!0:p.delta.totalTickets.delta!==0).length,r=a!==0||n>0||l>0;return{totalDelta:a,stagesChanged:n,employeesChanged:l,hasChanges:r,newTicketsCount:((i=o==null?void 0:o.new)==null?void 0:i.length)||0,removedTicketsCount:((f=o==null?void 0:o.removed)==null?void 0:f.length)||0,changedTicketsCount:((v=o==null?void 0:o.changed)==null?void 0:v.length)||0}}static validateSnapshot(e){const t=[],s=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:s};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const o=["formed","review","execution"];for(const a of o)e.statistics.stages[a]||s.push(`Missing stage: ${a}`)}e.statistics.employees||s.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||s.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:s}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const l=this.validateSnapshot(n);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const s=[...e].sort((n,l)=>{const r=new Date(n.metadata.createdAt),i=new Date(l.metadata.createdAt);return r-i}),o=[];for(let n=0;n<s.length-1;n++)o.push({from:n,to:n+1,result:this.compareTwoSnapshots(s[n],s[n+1],t)});const a=this.buildTrends(s);return{snapshots:s.map((n,l)=>({index:l,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:o,trends:a}}static buildTrends(e){var s,o,a,n,l,r,i,f,v,p;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const b of e){const k=b.statistics;t.stages.formed.push(((o=(s=k.stages)==null?void 0:s.formed)==null?void 0:o.count)||0),t.stages.review.push(((n=(a=k.stages)==null?void 0:a.review)==null?void 0:n.count)||0),t.stages.execution.push(((r=(l=k.stages)==null?void 0:l.execution)==null?void 0:r.count)||0),t.stages.total.push(((i=k.stages)==null?void 0:i.total)||0),t.zeroPoint.unassigned.push(((f=k.zeroPoint)==null?void 0:f.unassigned)||0),t.zeroPoint.keeper.push(((v=k.zeroPoint)==null?void 0:v.keeper)||0),t.zeroPoint.total.push(((p=k.zeroPoint)==null?void 0:p.total)||0)}return t}}const Pt={class:"stages-container"},Lt={class:"stages-chips"},Wt=["checked","disabled","onChange"],Ut={class:"stage-chip-label"},jt={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:u=>u.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(u,{emit:e}){const t=u,s=e;function o(a,n){const l={...t.selected};l[a]=n,s("update:selected",l),s("change",a,n)}return(a,n)=>(D(),E("div",Pt,[n[0]||(n[0]=c("h4",{class:"stages-title"},"–≠—Ç–∞–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:",-1)),c("div",Lt,[(D(!0),E(ve,null,ye(u.stages,l=>(D(),E("label",{key:l.id,class:Y(["stage-chip",{"stage-chip--active":u.selected[l.id],"stage-chip--disabled":u.disabled}])},[c("input",{type:"checkbox",checked:u.selected[l.id],disabled:u.disabled,onChange:r=>o(l.id,r.target.checked)},null,40,Wt),c("span",{class:"stage-chip-color",style:we({backgroundColor:l.color})},null,4),c("span",Ut,L(l.name),1)],2))),128))])]))}},Vt=ie(jt,[["__scopeId","data-v-fe03c03c"]]),zt={class:"modal-content"},Kt={class:"modal-header"},Ht={class:"modal-total"},qt={class:"modal-body"},Gt={key:0,class:"no-employees"},Yt={key:1,class:"employees-list"},Xt={class:"employee-name"},Jt={class:"employee-progress"},Zt={class:"employee-count"},Qt={key:0,class:"employee-item employee-others"},ea={class:"employee-name"},ta={class:"employee-progress"},aa={class:"employee-count"},sa={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null}},emits:["close"],setup(u,{emit:e}){const t=e;function s(){t("close")}return(o,a)=>(D(),he(ft,{to:"body"},[u.isVisible?(D(),E("div",{key:0,class:"employee-details-modal",onClick:le(s,["self"]),onKeydown:wt(s,["esc"])},[c("div",zt,[c("div",Kt,[c("h3",null,L(u.stageName),1),c("span",Ht,"–í—Å–µ–≥–æ: "+L(u.totalCount)+" —Ç–∏–∫–µ—Ç–æ–≤",1),c("button",{class:"modal-close",onClick:s,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"√ó")]),c("div",qt,[u.employees.length===0&&(!u.others||u.others.count===0)?(D(),E("div",Gt," –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö ")):(D(),E("div",Yt,[(D(!0),E(ve,null,ye(u.employees,n=>(D(),E("div",{key:n.id,class:Y(["employee-item",{"employee-keeper":n.isKeeper}])},[c("span",Xt,L(n.name),1),c("div",Jt,[c("div",{class:"progress-bar",style:we({width:n.progressBarWidth+"%",backgroundColor:n.progressBarColor})},null,4)]),c("span",Zt,L(n.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L(n.percentage)+"%) ",1)],2))),128)),u.others&&u.others.count>0?(D(),E("div",Qt,[c("span",ea,"–î—Ä—É–≥–∏–µ ("+L(u.others.employeeCount)+")",1),c("div",ta,[c("div",{class:"progress-bar",style:we({width:u.others.progressBarWidth+"%",backgroundColor:u.others.progressBarColor})},null,4)]),c("span",aa,L(u.others.count)+" —Ç–∏–∫–µ—Ç–æ–≤ ("+L(u.others.percentage)+"%) ",1)])):z("",!0)]))])])],32)):z("",!0)]))}},na=ie(sa,[["__scopeId","data-v-0dca1c25"]]),ke=10;function Oe(u,e){if(!e||!e.statistics)return[];const t=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(o=>o.ticketsByStage&&o.ticketsByStage[u]>0).forEach(o=>{t.push({id:o.id,name:o.name,count:o.ticketsByStage[u]||0})});const s=oa(u,e);return s>0&&t.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:s,isKeeper:!0}),t.sort((o,a)=>a.count-o.count)}function oa(u,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[u])return e.statistics.zeroPointByStage[u].keeper||0;if(e.statistics.zeroPoint){const t=e.statistics.zeroPoint.keeper||0;return Math.floor(t/3)}return 0}function ht(u,e){var t;return!e||!e.statistics||!e.statistics.stages?0:((t=e.statistics.stages[u])==null?void 0:t.count)||0}function Ne(u,e=ke){if(!u||u.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const t=[...u].sort((n,l)=>l.count-n.count),s=t.slice(0,e),o=t.slice(e),a=o.reduce((n,l)=>n+l.count,0);return{visible:s,others:{employees:o,count:a,employeeCount:o.length}}}function vt(u,e){return!u||u.length===0?[]:e===0?u.map(t=>({...t,percentage:0})):u.map(t=>({...t,percentage:parseFloat((t.count/e*100).toFixed(1))}))}function yt(u,e,t="#007bff",s=ke){if(!u||u.length===0)return{employees:[],others:null};const{visible:o,others:a}=Ne(u,s),n=vt(o,e).map(r=>({...r,progressBarWidth:r.percentage,progressBarColor:r.isKeeper?"#f59e0b":t}));let l=null;if(a.count>0){const r=parseFloat((a.count/e*100).toFixed(1));l={...a,percentage:r,progressBarWidth:r,progressBarColor:"#6c757d"}}return{employees:n,others:l}}function ra(u,e){const t={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(o=>{const a=e[o];if(!a)return;const n=Oe(u,a),l=ht(u,a);if(n.length===0)return;const{visible:r,others:i}=Ne(n,ke),f=vt(r,l);t[o]=f,i.count>0&&(t.others[o]={count:i.count,employeeCount:i.employeeCount,percentage:parseFloat((i.count/l*100).toFixed(1))})}),t}function la(u,e="current",t=[]){const s=u[e];if(!s)return{labels:[],datasets:[]};const o=new Map;t.forEach(v=>{Oe(v.id,s).forEach(b=>{o.has(b.id)||o.set(b.id,{id:b.id,name:b.name,isKeeper:b.isKeeper||!1,ticketsByStage:{}}),o.get(b.id).ticketsByStage[v.id]=b.count})});const a=Array.from(o.values()).map(v=>{const p=Object.values(v.ticketsByStage).reduce((b,k)=>b+k,0);return{...v,totalTickets:p}});a.sort((v,p)=>p.totalTickets-v.totalTickets);const{visible:n,others:l}=Ne(a,ke),r=t.map(()=>""),i={};t.forEach(v=>{const p=Oe(v.id,s),{visible:b}=Ne(p,ke);i[v.id]=b.map(k=>({id:k.id,name:k.name,count:k.count}))});const f=n.map((v,p)=>{const b=t.map(y=>v.ticketsByStage[y.id]||0),k=t.map(y=>{if((v.ticketsByStage[y.id]||0)===0)return"transparent";const T=y.color.replace("#",""),W=parseInt(T.substring(0,2),16),G=parseInt(T.substring(2,4),16),U=parseInt(T.substring(4,6),16),R=.6+p*.05;return`rgba(${W}, ${G}, ${U}, ${Math.min(R,.95)})`});return{label:v.name,data:b,backgroundColor:k,borderColor:t.map(y=>{const g=y.color.replace("#",""),h=parseInt(g.substring(0,2),16),T=parseInt(g.substring(2,4),16),W=parseInt(g.substring(4,6),16);return`rgba(${h}, ${T}, ${W}, 0.8)`}),borderWidth:1,meta:{employeeId:v.id,employeeName:v.name}}});if(l.count>0){const v=t.map(p=>l.employees.reduce((b,k)=>b+(k.ticketsByStage[p.id]||0),0));f.push({label:`–î—Ä—É–≥–∏–µ (${l.employeeCount})`,data:v,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:r,datasets:f,meta:{employeesByStage:i}}}function ia(u,e,t=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const s=t.find(i=>i.id===u),o=s?s.name:"",a=s?s.color:"#007bff",n=Oe(u,e),l=ht(u,e);if(n.length===0)return{stageName:o,totalCount:0,employees:[],others:null};const r=yt(n,l,a,ke);return{stageName:o,totalCount:l,employees:r.employees,others:r.others}}const ca={class:"graph-state-chart"},ua={class:"chart-header"},da={class:"chart-type-selector"},pa=["onClick","title"],fa={class:"chart-type-icon"},ga={class:"chart-type-label"},ma={key:0,class:"comparison-type-selector"},ha={class:"radio-group"},va={key:0},ya={key:1},wa={key:2,class:"graph-legend"},Sa={key:4,class:"error-container"},ka={class:"error-message"},ba={key:5,class:"chart-container"},Da={class:"chart-wrapper"},Ea={class:"chart-canvas-container"},Ta={key:0,class:"bar-chart-stage-labels"},Ca={key:6,class:"no-data"},$a={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(u,{emit:e}){const t=(w,d)=>typeof window>"u"?d:getComputedStyle(document.documentElement).getPropertyValue(w).trim()||d,s=u,o=e,a=_(!1),n=_(null),l=_(null),r=_({weekStart:null,weekEnd:null,current:null}),i=_(null),f=_("weekStartToWeekEnd"),v=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],p=_("line"),b=_(!1),k=_(""),y=_(0),g=_([]),h=_(null),T=_([]),W=V(()=>{switch(p.value){case"line":return ut;case"bar":return At;case"doughnut":return _t;default:return ut}}),G={formed:t("--b24-primary","#007bff"),review:t("--b24-warning","#ffc107"),execution:t("--b24-success","#28a745")},U=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:G.formed},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:G.review},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:G.execution}],R=_({formed:!0,review:!0,execution:!0}),x=Fe(),j={id:"employeeLabelsPlugin",afterDatasetsDraw:w=>{if(w.config.type==="bar")try{const d=w.ctx;if(!w.data||!w.data.datasets)return;const m=w.data.datasets,S=w.scales.y;m.forEach(($,B)=>{const C=w.getDatasetMeta(B);if(!C||C.hidden)return;const M=$.label||"";if(!M||M.includes("–î—Ä—É–≥–∏–µ"))return;const A=M.trim().split(/\s+/);let O="";if(A.length===1)O=A[0];else{const N=A[0],K=A.slice(1).join(" ");O=`${N}
${K}`}const P=O.split(`
`);$.data.forEach((N,K)=>{if(N===0||!N)return;const H=C.data[K];if(!H||typeof H.x!="number"||typeof H.y!="number")return;const Z=H.x,ue=H.y+H.height+25;d.save(),d.font="bold 9px Arial, sans-serif",d.fillStyle="#6b7280",d.textAlign="center",d.textBaseline="top",d.translate(Z,ue),d.rotate(-12*Math.PI/180),P.forEach((se,de)=>{const pe=se.trim();pe&&d.fillText(pe,0,de*11)}),d.restore()})})}catch(d){console.error("Error in employeeLabelsPlugin:",d)}}};St.register(j);function X(){const w=new Map;[r.value.weekStart,r.value.weekEnd,r.value.current].forEach(d=>{!d||!d.statistics||!d.statistics.employees||d.statistics.employees.forEach(m=>{w.has(m.id)||w.set(m.id,{id:m.id,name:m.name})})}),T.value=Array.from(w.values()).sort((d,m)=>d.name.localeCompare(m.name))}function ee(w,d="background"){var S;return((S={increase:{background:t("--b24-success","#28a745"),border:t("--b24-success-hover","#218838"),point:t("--b24-success","#28a745")},decrease:{background:t("--b24-danger","#dc3545"),border:t("--b24-danger-hover","#c82333"),point:t("--b24-danger","#dc3545")},stable:{background:t("--b24-text-muted","#9ca3af"),border:t("--b24-text-secondary","#6b7280"),point:t("--b24-text-muted","#9ca3af")}}[w])==null?void 0:S[d])||t("--b24-text-secondary","#6c757d")}function ce(){if(!(!r.value.weekStart||!r.value.weekEnd))try{const w=Xe.compareTwoSnapshots(r.value.weekStart,r.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let d=null,m=null;r.value.current&&(d=Xe.compareTwoSnapshots(r.value.weekEnd,r.value.current,{includeTickets:!1,includeEmployees:!0}),m=Xe.compareTwoSnapshots(r.value.weekStart,r.value.current,{includeTickets:!1,includeEmployees:!0})),i.value={weekStartToWeekEnd:w,weekEndToCurrent:d,weekStartToCurrent:m}}catch(w){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",w),x.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+w.message)}}function ge(w){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[w]||"formed"}function _e(w){return ge(w)}function We(w){return w===0?"weekStart":w===1?"weekEnd":w===2?"current":"weekEnd"}function Ue(w){return r.value[w]||null}function be(w,d,m,S=null){k.value=w,y.value=d,g.value=m||[],h.value=S&&S.count>0?S:null,b.value=!0}function je(w,d,m){var M,A,O;const S=U.find(P=>P.id===w);if(!S)return;const $=Ue(d);if(!$)return;const B=((O=(A=(M=$.statistics)==null?void 0:M.stages)==null?void 0:A[w])==null?void 0:O.count)||0,C=yt(m,B,S.color,10);be(S.name,B,C.employees,C.others)}function Ve(w,d){if(!d||!d.employees||d.employees.length===0){x.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞");return}be(d.stageName,d.totalCount,d.employees,d.others)}function ze(){b.value=!1,k.value="",y.value=0,g.value=[],h.value=null}function Ke(w,d,m){var P,N;if(p.value!=="line"||d.length===0)return;const S=d[0],$=S.datasetIndex,B=S.index,C=m.data.datasets[$];if(!C||!C.meta)return;const M=_e(C.label),A=We(B),O=(N=(P=C.meta)==null?void 0:P.employees)==null?void 0:N[A];!O||O.length===0||je(M,A,O)}function Ae(w,d,m){var P,N;if(p.value!=="doughnut"||d.length===0)return;const $=d[0].index,B=m.data,C=B.labels[$],M=_e(C),A=(N=(P=B.datasets[0])==null?void 0:P.meta)==null?void 0:N.employees,O=A==null?void 0:A[M];if(!O){console.warn("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–∞–ø–∞:",M);return}Ve(M,O)}function He(w){var S;const d=U[w];if(!d)return 0;const m=r.value.current||r.value.weekEnd||r.value.weekStart;return!m||!m.statistics||!m.statistics.stages?0:((S=m.statistics.stages[d.id])==null?void 0:S.count)||0}function I(w){var $;const d=U.find(B=>B.id===w);if(!d)return"";const m=r.value.current||r.value.weekEnd||r.value.weekStart;if(!m||!m.statistics||!m.statistics.stages)return d.name;const S=(($=m.statistics.stages[w])==null?void 0:$.count)||0;return`${d.name} (${S})`}const F=V(()=>{if(!l.value)return null;if(p.value==="doughnut"||p.value==="bar")return l.value;const w=l.value.datasets.filter(d=>{const m=U.find(S=>S.name===d.label);return m?R.value[m.id]:!0});return{...l.value,datasets:w}});V(()=>p.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const ae=V(()=>{const w={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:p.value==="bar"?{bottom:80}:{}},onClick:(d,m,S)=>{p.value==="line"?Ke(d,m,S):p.value==="doughnut"&&Ae(d,m,S)},onHover:(d,m,S)=>{p.value==="doughnut"&&(d.native.target.style.cursor=m.length>0?"pointer":"default")},plugins:{legend:{display:p.value!=="bar",position:p.value==="doughnut"?"right":"top",onClick:(d,m,S)=>{if(p.value==="bar"){const B=m.datasetIndex;if(B!==void 0){const C=S.chart.getDatasetMeta(B);C.hidden=!C.hidden,S.chart.update()}return}const $=m.datasetIndex;if($!==void 0){const B=S.chart.getDatasetMeta($);B.hidden=!B.hidden,S.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:d=>{if(p.value==="bar"){const m=d[0].dataIndex,S=U[m];return S?S.name:""}return d[0].label||""},label:d=>{var B,C,M,A,O,P;const m=d.dataset.label||"",S=d.parsed.y||d.parsed||0,$=d.dataIndex;if(p.value==="bar"){const N=d.dataset,K=d.dataIndex,H=U[K],Z=H?H.name:"";return`${N.label}: ${S} —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ "${Z}"`}if(p.value==="doughnut"){const N=d.dataset.data.reduce((H,Z)=>H+Z,0),K=N>0?(S/N*100).toFixed(1):0;return`${m}: ${S} —Ç–∏–∫–µ—Ç–æ–≤ (${K}%)`}else{if(!i.value||$===0)return`${m}: ${S} —Ç–∏–∫–µ—Ç–æ–≤`;let N=null;const K=ge(m);if(f.value==="weekStartToWeekEnd"&&$===1?N=(C=(B=i.value.weekStartToWeekEnd)==null?void 0:B.stages)==null?void 0:C[K]:f.value==="weekEndToCurrent"&&$===2&&r.value.current?N=(A=(M=i.value.weekEndToCurrent)==null?void 0:M.stages)==null?void 0:A[K]:f.value==="weekStartToCurrent"&&$===2&&r.value.current&&(N=(P=(O=i.value.weekStartToCurrent)==null?void 0:O.stages)==null?void 0:P[K]),!N)return`${m}: ${S} —Ç–∏–∫–µ—Ç–æ–≤`;const H=N.delta,Z=N.deltaPercent,ue=N.trend;let se=`${m}: ${S} —Ç–∏–∫–µ—Ç–æ–≤`;if(H!==0){const de=H>0?"+":"",pe=ue==="increase"?"‚Üë":ue==="decrease"?"‚Üì":"‚Üí";se+=` (${de}${H}, ${de}${Z.toFixed(1)}%) ${pe}`}else se+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return se}},afterBody:d=>{if(p.value==="bar"&&d.length>0){const B=d[0];B.dataset;const C=B.parsed.y||0,M=B.dataIndex,A=He(M);return[`${A>0?(C/A*100).toFixed(1):0}% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç—Ç–∞–ø–∞`]}if(p.value==="doughnut"&&d.length>0)return["–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"];if(p.value==="line"){const B=[];if(i.value){const C=d[0].dataIndex;if(C!==0){let M=null;if(ge(d[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&C===1?M=i.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&C===2?M=i.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&C===2&&(M=i.value.weekStartToCurrent),M&&M.metadata){const A=M.metadata.timeDiff;B.push(`–ü–µ—Ä–∏–æ–¥: ${A.days} –¥–Ω. ${A.hours} —á. ${A.minutes} –º–∏–Ω.`)}}}return B.push("–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"),B}if(!i.value)return[];const m=d[0].dataIndex;if(m===0)return[];let S=null;if(ge(d[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&m===1?S=i.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&m===2?S=i.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&m===2&&(S=i.value.weekStartToCurrent),!S||!S.metadata)return[];const $=S.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${$.days} –¥–Ω. ${$.hours} —á. ${$.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return p.value==="line"||p.value==="bar"?{...w,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:p.value==="doughnut"?{...w,cutout:"60%"}:w});function De(w){const d=new Date(w),m=d.getFullYear(),S=String(d.getMonth()+1).padStart(2,"0"),$=String(d.getDate()).padStart(2,"0");return`${m}-${S}-${$}`}function J(w){const{current:d,weekEnd:m}=w,S=d||m;if(!S||!S.statistics||!S.statistics.stages)return null;const $=[],B=[],C=[],M=[],A={};return U.forEach(O=>{var N;const P=((N=S.statistics.stages[O.id])==null?void 0:N.count)||0;if(P>0){$.push(O.name),B.push(P),C.push(O.color+"80"),M.push(O.color);const K=ia(O.id,S,U);K&&K.employees&&(A[O.id]=K)}}),B.length===0?null:{labels:$,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:B,backgroundColor:C,borderColor:M,borderWidth:2,meta:{employees:A}}]}}function Ie(w){if(p.value==="doughnut")return J(w);if(p.value==="bar"){const C=s.showCurrentState&&w.current?"current":w.weekEnd?"weekEnd":"weekStart";return la(w,C,U)}const{weekStart:d,weekEnd:m,current:S}=w,$=[],B=[];return U.forEach(C=>{var H,Z,ue,se,de,pe,Qe,et,tt,at,st,nt,ot,rt,lt,it,ct;const M=[];if(d&&d.statistics&&d.statistics.stages){const q=d.statistics.stages[C.id];if($.length===0){const Ce=(H=d.metadata)!=null&&H.createdAt?new Date(d.metadata.createdAt):null;$.push(Ce?De(Ce):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}M.push((q==null?void 0:q.count)||0)}else $.length===0&&$.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),M.push(0);if(m&&m.statistics&&m.statistics.stages){const q=m.statistics.stages[C.id];if($.length===1){const Ce=(Z=m.metadata)!=null&&Z.createdAt?new Date(m.metadata.createdAt):null;$.push(Ce?De(Ce):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}M.push((q==null?void 0:q.count)||0)}else $.length===1&&$.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),M.push(0);if(S&&s.showCurrentState&&S.statistics&&S.statistics.stages){const q=S.statistics.stages[C.id];$.length===2&&$.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),M.push((q==null?void 0:q.count)||0)}const A=["stable"];i.value?f.value==="weekStartToWeekEnd"?(A.push(((de=(se=(ue=i.value.weekStartToWeekEnd)==null?void 0:ue.stages)==null?void 0:se[C.id])==null?void 0:de.trend)||"stable"),S&&A.push(((et=(Qe=(pe=i.value.weekStartToCurrent)==null?void 0:pe.stages)==null?void 0:Qe[C.id])==null?void 0:et.trend)||"stable")):f.value==="weekEndToCurrent"&&S?(A.push("stable"),A.push(((st=(at=(tt=i.value.weekEndToCurrent)==null?void 0:tt.stages)==null?void 0:at[C.id])==null?void 0:st.trend)||"stable")):f.value==="weekStartToCurrent"&&S?(A.push(((rt=(ot=(nt=i.value.weekStartToWeekEnd)==null?void 0:nt.stages)==null?void 0:ot[C.id])==null?void 0:rt.trend)||"stable"),A.push(((ct=(it=(lt=i.value.weekStartToCurrent)==null?void 0:lt.stages)==null?void 0:it[C.id])==null?void 0:ct.trend)||"stable")):(A.push("stable"),S&&A.push("stable")):(A.push("stable"),S&&A.push("stable"));let O,P,N;i.value&&p.value!=="doughnut"?(O=A.map(q=>ee(q,"background")+"40"),P=A.map(q=>ee(q,"border")),N=A.map(q=>ee(q,"point"))):(O=C.color+"40",P=C.color,N=C.color);let K=null;p.value==="line"&&(K={employees:ra(C.id,w)}),B.push({label:C.name,data:M,backgroundColor:(Array.isArray(O),O),borderColor:(Array.isArray(P),P),borderWidth:2,pointBackgroundColor:(Array.isArray(N),N),pointBorderColor:(Array.isArray(P),P),pointRadius:6,pointHoverRadius:8,fill:p.value!=="line",tension:p.value==="line"?.4:0,meta:K})}),$.length===0&&($.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),s.showCurrentState&&$.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:$,datasets:B}}const Ee=async()=>{var w,d,m;a.value=!0,n.value=null;try{const S=(w=s.period)!=null&&w.endDate?new Date(s.period.endDate):new Date,$=(d=s.period)!=null&&d.startDate?new Date(s.period.startDate):re.getWeekStartDate(S),B=(m=s.period)!=null&&m.endDate?new Date(s.period.endDate):re.getWeekEndDate(S),C=re.formatDate($),M=re.formatDate(B),[A,O]=await Promise.all([re.getSnapshot(C,"week_start"),re.getSnapshot(M,"week_end")]);let P=null;s.showCurrentState&&(P=await Ze.getSectorDataForSnapshot({useCache:!1,normalize:!0})),r.value={weekStart:A,weekEnd:O,current:P},X(),ce(),te(),o("data-loaded",{weekStart:A,weekEnd:O,current:P})}catch(S){console.error("Error loading chart data:",S),n.value=S.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",x.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+n.value),o("error",n.value)}finally{a.value=!1}};Se(()=>{Ee()});function Te(w){R.value=w}const te=()=>{var d;const w=Ie({weekStart:r.value.weekStart,weekEnd:r.value.weekEnd,current:r.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==((d=w==null?void 0:w.labels)==null?void 0:d.length))l.value=w;else if(w){const m=JSON.stringify(l.value),S=JSON.stringify(w);m!==S&&(l.value=w)}};return Be(()=>[s.period,s.showCurrentState],()=>{Ee()},{deep:!0}),Be(p,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&te()}),Be(f,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&te()}),(w,d)=>(D(),E("div",ca,[c("div",ua,[d[3]||(d[3]=c("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),c("div",da,[(D(),E(ve,null,ye(v,m=>c("button",{key:m.value,onClick:S=>p.value=m.value,class:Y(["chart-type-btn",{active:p.value===m.value}]),title:m.label},[c("span",fa,L(m.icon),1),c("span",ga,L(m.label),1)],10,pa)),64))])]),!a.value&&!n.value&&i.value&&p.value!=="doughnut"?(D(),E("div",ma,[d[7]||(d[7]=c("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),c("div",ha,[c("label",null,[Me(c("input",{type:"radio","onUpdate:modelValue":d[0]||(d[0]=m=>f.value=m),value:"weekStartToWeekEnd",onChange:te},null,544),[[qe,f.value]]),d[4]||(d[4]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),r.value.current?(D(),E("label",va,[Me(c("input",{type:"radio","onUpdate:modelValue":d[1]||(d[1]=m=>f.value=m),value:"weekEndToCurrent",onChange:te},null,544),[[qe,f.value]]),d[5]||(d[5]=c("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):z("",!0),r.value.current?(D(),E("label",ya,[Me(c("input",{type:"radio","onUpdate:modelValue":d[2]||(d[2]=m=>f.value=m),value:"weekStartToCurrent",onChange:te},null,544),[[qe,f.value]]),d[6]||(d[6]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):z("",!0)])])):z("",!0),!a.value&&!n.value&&l.value?(D(),he(Vt,{key:1,stages:U,selected:R.value,"onUpdate:selected":Te,onChange:te},null,8,["selected"])):z("",!0),!a.value&&!n.value&&i.value&&p.value!=="doughnut"?(D(),E("div",wa,[...d[8]||(d[8]=[kt('<h4 class="legend-title" data-v-74773c7b>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-74773c7b><div class="legend-item" data-v-74773c7b><span class="legend-color legend-increase" data-v-74773c7b></span><span data-v-74773c7b>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-74773c7b><span class="legend-color legend-decrease" data-v-74773c7b></span><span data-v-74773c7b>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-74773c7b><span class="legend-color legend-stable" data-v-74773c7b></span><span data-v-74773c7b>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):z("",!0),a.value?(D(),he(gt,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):n.value?(D(),E("div",Sa,[c("p",ka,"‚ùå "+L(n.value),1),c("button",{onClick:Ee,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):F.value?(D(),E("div",ba,[c("div",Da,[c("div",Ea,[(D(),he(bt(W.value),{data:F.value,options:ae.value},null,8,["data","options"]))]),p.value==="bar"?(D(),E("div",Ta,[(D(),E(ve,null,ye(U,m=>c("div",{key:m.id,class:"stage-label-item"},L(I(m.id)),1)),64))])):z("",!0)])])):(D(),E("div",Ca,[...d[9]||(d[9]=[c("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),c("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),Q(na,{"is-visible":b.value,"stage-name":k.value,"total-count":y.value,employees:g.value,others:h.value,onClose:ze},null,8,["is-visible","stage-name","total-count","employees","others"])]))}},_a=ie($a,[["__scopeId","data-v-74773c7b"]]),Aa={key:0,class:"create-snapshot-button-container"},Ia=["disabled"],xa={class:"modal-content"},Ba={class:"modal-header"},Ma=["disabled"],Ra={class:"modal-body"},Oa={key:0,class:"progress-container"},Na={class:"progress-bar-wrapper"},Fa={class:"progress-text"},Pa={class:"progress-percent"},La={class:"progress-description"},Wa={key:1},Ua={class:"modal-footer"},ja=["disabled"],Va=["disabled"],za={key:0},Ka={key:0},Ha={key:1},qa={key:2},Ga={key:1},Ya={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(u,{emit:e}){const t=u,s=e,o=_(t.user),a=_(!1),n=_(!1),l=_(0),r=_("idle"),i=_(""),f=Fe(),v=V(()=>o.value?Dt(o.value):!1);Se(async()=>{if(!t.user)try{const g=await mt.checkAccess();g.allowed&&(o.value=g.user)}catch(g){console.error("Error loading user:",g)}});const p=()=>{if(!v.value){f.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}a.value=!0},b=()=>{n.value||(a.value=!1,r.value="idle",l.value=0,i.value="")},k=async()=>{if(!n.value){if(!v.value){f.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}n.value=!0,r.value="loading_data",l.value=0,i.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{i.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const g=await Ze.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:W=>{var U;const G=Math.min(80,(W.progress||0)*.8);l.value=G,r.value="loading_data",i.value=W.description||((U=W.details)==null?void 0:U.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});r.value="creating_snapshot",l.value=85,i.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const h=o.value;if(!h)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const T=await re.createSnapshot(g,"manual",{createdBy:{id:h.ID,name:`${h.NAME||""} ${h.LAST_NAME||""}`.trim()||h.EMAIL||`User ${h.ID}`},sectorId:"1C"});r.value="success",l.value=100,i.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",f.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),s("snapshot-created",T),setTimeout(()=>{b()},1500)}catch(g){r.value="error",l.value=0,i.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",g);let h="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";g.message&&(g.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||g.message.includes("sector data")?h="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":g.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||g.message.includes("snapshot")?h="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":g.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||g.message.includes("validation")?h="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":h=g.message),f.error(h)}finally{n.value=!1}}},y=g=>{g.key==="Escape"&&a.value&&!n.value&&b()};return Se(()=>{window.addEventListener("keydown",y)}),Pe(()=>{window.removeEventListener("keydown",y)}),(g,h)=>v.value?(D(),E("div",Aa,[c("button",{class:"create-snapshot-btn",onClick:p,disabled:n.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...h[1]||(h[1]=[c("span",{class:"btn-icon"},"üì∏",-1),c("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,Ia),(D(),he(ft,{to:"body"},[Q(Je,{name:"modal"},{default:Le(()=>[a.value?(D(),E("div",{key:0,class:"modal-overlay",onClick:h[0]||(h[0]=le(T=>!n.value&&b(),["self"]))},[c("div",xa,[c("div",Ba,[h[2]||(h[2]=c("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),c("button",{class:"modal-close",onClick:b,disabled:n.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,Ma)]),c("div",Ra,[r.value!=="idle"?(D(),E("div",Oa,[c("div",Na,[c("div",{class:"progress-bar",style:we({width:`${l.value}%`})},null,4)]),c("div",Fa,[c("span",Pa,L(Math.round(l.value))+"%",1),c("span",La,L(i.value),1)])])):(D(),E("div",Wa,[...h[3]||(h[3]=[c("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),c("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),c("div",Ua,[c("button",{class:"btn btn-secondary",onClick:b,disabled:n.value}," –û—Ç–º–µ–Ω–∞ ",8,ja),c("button",{class:"btn btn-primary",onClick:k,disabled:n.value},[n.value?(D(),E("span",za,[r.value==="loading_data"?(D(),E("span",Ka,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):r.value==="creating_snapshot"?(D(),E("span",Ha,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(D(),E("span",qa,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(D(),E("span",Ga,"–°–æ–∑–¥–∞—Ç—å"))],8,Va)])])])):z("",!0)]),_:1})]))])):z("",!0)}},Xa=ie(Ya,[["__scopeId","data-v-09bccee2"]]),Ja=20,Za=5*60*1e3;async function Qa({search:u="",limit:e=Ja,sectorDepartmentId:t=pt.SECTOR_1C}={}){const s=`sector1c_employees_${u}_${e}_${t||"all"}`,o=sessionStorage.getItem(s);if(o)try{const{data:a,timestamp:n}=JSON.parse(o);if(Date.now()-n<Za)return a}catch(a){console.warn("[sector1cEmployees] Cache parse error:",a)}try{const a={ACTIVE:"Y"};t?Array.isArray(t)?a.UF_DEPARTMENT=t:a.UF_DEPARTMENT=[t]:a.UF_DEPARTMENT=[pt.SECTOR_1C],u&&u.length>=2&&(a["%NAME"]=u,a["%LAST_NAME"]=u,a["%WORK_POSITION"]=u);const r=((await xt.call("user.get",{filter:a,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,e).map(i=>({id:parseInt(i.ID),name:es(i),position:i.WORK_POSITION||"",department:i.UF_DEPARTMENT||null}));try{sessionStorage.setItem(s,JSON.stringify({data:r,timestamp:Date.now()}))}catch(i){console.warn("[sector1cEmployees] Cache write error:",i)}return r}catch(a){throw console.error("[sector1cEmployees] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",a),new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${a.message}`)}}function es(u){const e=[u.LAST_NAME,u.NAME,u.SECOND_NAME].filter(Boolean);return e.length>0?e.join(" "):u.NAME||"–ë–µ–∑ –∏–º–µ–Ω–∏"}const ts={class:"employee-select-field-text"},as={key:0,class:"employee-select-dropdown"},ss={class:"employee-select-dropdown-search"},ns={key:0,class:"employee-select-state"},os={key:1,class:"employee-select-state employee-select-state--error"},rs={key:2,class:"employee-select-state"},ls=["checked"],is=["checked","onChange"],cs={class:"employee-select-item-content"},us={class:"employee-select-item-name"},ds={key:0,class:"employee-select-item-position"},ps={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(u,{emit:e}){const t=u,s=e,o=_(null),a=_(null),n=_(""),l=_([]),r=_(!1),i=_(null),f=_(!1),v=V(()=>{if(!n.value)return l.value;const R=n.value.toLowerCase();return l.value.filter(x=>x.name.toLowerCase().includes(R)||x.position&&x.position.toLowerCase().includes(R))}),p=V(()=>{if(t.selected.includes("all")||t.selected.length===0)return t.placeholder;if(t.selected.length===1){const R=l.value.find(x=>x.id===t.selected[0]);return R?R.name:t.placeholder}return`–í—ã–±—Ä–∞–Ω–æ: ${t.selected.length} ${G(t.selected.length,"—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤","—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")}`});async function b(R=""){r.value=!0,i.value=null;try{l.value=await Qa({search:R})}catch(x){i.value=x,s("error",x)}finally{r.value=!1}}function k(){s("search",n.value)}function y(){r.value||(f.value=!f.value,f.value?(l.value.length===0&&b(),Tt(()=>{a.value&&a.value.focus()})):n.value="")}function g(R){o.value&&!o.value.contains(R.target)&&(f.value=!1,n.value="")}function h(R){const x=[...t.selected],j=x.indexOf(R);if(R==="all")if(j>-1)x.splice(j,1);else return s("update:selected",["all"]);else if(j>-1)x.splice(j,1);else{const X=x.indexOf("all");X>-1&&x.splice(X,1),x.push(R)}s("update:selected",x)}function T(R){return R==="all"?t.selected.includes("all"):t.selected.includes(R)||t.selected.includes("all")}const W=V(()=>n.value?`–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${n.value}"`:"–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°");function G(R,x,j,X){const ee=R%10,ce=R%100;return ce>=11&&ce<=19?X:ee===1?x:ee>=2&&ee<=4?j:X}function U(){b(n.value)}return Be(()=>t.selected,R=>{(!R||R.length===0)&&s("update:selected",["all"])},{immediate:!0}),Se(()=>{document.addEventListener("click",g),(!t.selected||t.selected.length===0)&&s("update:selected",["all"])}),Pe(()=>{document.removeEventListener("click",g)}),(R,x)=>(D(),E("div",{class:"employee-select",ref_key:"selectContainer",ref:o},[c("div",{class:Y(["employee-select-field",{"employee-select-field--open":f.value,"employee-select-field--disabled":r.value}]),onClick:y},[c("span",ts,L(p.value),1),c("span",{class:Y(["employee-select-field-icon",{open:f.value}])},"‚ñº",2)],2),Q(Je,{name:"dropdown-fade"},{default:Le(()=>[f.value?(D(),E("div",as,[c("div",ss,[Me(c("input",{"onUpdate:modelValue":x[0]||(x[0]=j=>n.value=j),type:"text",placeholder:"üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...",class:"employee-select-search-input",onInput:k,onClick:x[1]||(x[1]=le(()=>{},["stop"])),ref_key:"searchInput",ref:a},null,544),[[Et,n.value]])]),r.value?(D(),E("div",ns,[...x[6]||(x[6]=[c("span",{class:"spinner"},"‚è≥",-1),c("span",null,"–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°...",-1)])])):i.value?(D(),E("div",os,[c("span",null,"‚ùå "+L(i.value.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"),1),c("button",{onClick:[U,x[2]||(x[2]=le(()=>{},["stop"]))],class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å")])):!r.value&&v.value.length===0&&!i.value?(D(),E("div",rs,[c("span",null,"üì≠ "+L(W.value),1)])):(D(),E("div",{key:3,class:"employee-select-list",style:we({maxHeight:`${u.maxHeight}px`})},[c("label",{class:Y(["employee-select-item",{"employee-select-item--selected":T("all")}]),onClick:x[4]||(x[4]=le(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:T("all"),onChange:x[3]||(x[3]=j=>h("all"))},null,40,ls),x[7]||(x[7]=c("div",{class:"employee-select-item-content"},[c("span",{class:"employee-select-item-name"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏")],-1))],2),(D(!0),E(ve,null,ye(v.value,j=>(D(),E("label",{key:j.id,class:Y(["employee-select-item",{"employee-select-item--selected":T(j.id)}]),onClick:x[5]||(x[5]=le(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:T(j.id),onChange:X=>h(j.id)},null,40,is),c("div",cs,[c("span",us,L(j.name),1),j.position?(D(),E("span",ds,L(j.position),1)):z("",!0)])],2))),128))],4))])):z("",!0)]),_:1})],512))}},fs=ie(ps,[["__scopeId","data-v-6b8c949b"]]),gs={class:"stage-select-field-text"},ms={key:0,class:"stage-select-dropdown"},hs={class:"stage-select-list"},vs=["checked"],ys=["checked","onChange"],ws={class:"stage-select-item-content"},Ss={class:"stage-select-item-name"},ks={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745"}]},placeholder:{type:String,default:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã"}},emits:["update:selected","change"],setup(u,{emit:e}){const t=u,s=e,o=_(null),a=_(!1),n=V(()=>Object.values(t.selected).every(p=>p===!0)),l=V(()=>{if(n.value)return t.placeholder;const p=t.stages.filter(b=>t.selected[b.id]);return p.length===0?"–≠—Ç–∞–ø—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã":p.length===1?p[0].name:`–í—ã–±—Ä–∞–Ω–æ: ${p.length} —ç—Ç–∞–ø–∞(–æ–≤)`});function r(){a.value=!a.value,a.value}function i(p){o.value&&!o.value.contains(p.target)&&(a.value=!1)}function f(p,b){const k={...t.selected};k[p]=b,s("update:selected",k),s("change",p,b)}function v(){const p=n.value,b={};t.stages.forEach(k=>{b[k.id]=!p}),s("update:selected",b),s("change","all",!p)}return Se(()=>{document.addEventListener("click",i)}),Pe(()=>{document.removeEventListener("click",i)}),(p,b)=>(D(),E("div",{class:"stage-select",ref_key:"selectContainer",ref:o},[c("div",{class:Y(["stage-select-field",{"stage-select-field--open":a.value,"stage-select-field--disabled":!1}]),onClick:r},[c("span",gs,L(l.value),1),c("span",{class:Y(["stage-select-field-icon",{open:a.value}])},"‚ñº",2)],2),Q(Je,{name:"dropdown-fade"},{default:Le(()=>[a.value?(D(),E("div",ms,[c("div",hs,[c("label",{class:Y(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:b[0]||(b[0]=le(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:n.value,onChange:v},null,40,vs),b[2]||(b[2]=c("div",{class:"stage-select-item-content"},[c("span",{class:"stage-select-item-name"},"–í—Å–µ —ç—Ç–∞–ø—ã")],-1))],2),(D(!0),E(ve,null,ye(u.stages,k=>(D(),E("label",{key:k.id,class:Y(["stage-select-item",{"stage-select-item--selected":u.selected[k.id]}]),onClick:b[1]||(b[1]=le(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:u.selected[k.id],onChange:y=>f(k.id,y.target.checked)},null,40,ys),c("div",ws,[c("span",{class:"stage-select-item-color",style:we({backgroundColor:k.color})},null,4),c("span",Ss,L(k.name),1)])],2))),128))])])):z("",!0)]),_:1})],512))}},bs=ie(ks,[["__scopeId","data-v-ce2229b2"]]),Ds={class:"filters-panel"},Es={class:"filters-header"},Ts=["disabled"],Cs={class:"filters-content"},$s={class:"filter-section"},_s={class:"section-content"},As={class:"filter-section"},Is={class:"section-content"},xs={class:"filter-section"},Bs={class:"section-content"},Ms=["value"],Rs={key:0,class:"custom-date-range"},Os={class:"date-range-inputs"},Ns={class:"date-input-group"},Fs=["value","max"],Ps={class:"date-input-group"},Ls=["value","min","max"],Ws={key:0,class:"filter-error"},Us={key:1,class:"filter-hint"},js={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(u,{emit:e}){const t=u,s=e,o=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"var(--b24-primary, #007bff)"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"var(--b24-success, #28a745)"}],a=_(null),n=V(()=>{const k=new Date;return k.setFullYear(k.getFullYear()-1),k.toISOString().split("T")[0]}),l=V(()=>new Date().toISOString().split("T")[0]);function r(k){s("update:stages",k),s("apply")}function i(k,y){s("apply")}function f(k){s("update:employees",k),s("apply")}function v(k){s("update:dateRange",k),a.value=null,s("apply")}function p(k,y){const g={...t.customDateRange};if(g[k]=y,g.startDate&&g.endDate){const h=new Date(g.startDate),T=new Date(g.endDate);if(h>T){a.value="–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π";return}if(Math.ceil((T-h)/(1e3*60*60*24))>365){a.value="–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π";return}}a.value=null,s("update:customDateRange",g),s("apply")}function b(){a.value=null,s("reset")}return(k,y)=>(D(),E("div",Ds,[c("div",Es,[y[3]||(y[3]=c("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("button",{onClick:b,class:"btn-reset-filters",disabled:!u.hasActiveFilters}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,Ts)]),c("div",Cs,[c("div",$s,[y[4]||(y[4]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"üìä"),Re(" –≠—Ç–∞–ø—ã ")],-1)),c("div",_s,[Q(bs,{selected:u.stages,stages:o,placeholder:"–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø—ã","onUpdate:selected":r,onChange:i},null,8,["selected"])])]),c("div",As,[y[5]||(y[5]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"üë•"),Re(" –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ")],-1)),c("div",Is,[Q(fs,{selected:u.employees,"onUpdate:selected":f},null,8,["selected"])])]),c("div",xs,[y[9]||(y[9]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"üìÖ"),Re(" –ü–µ—Ä–∏–æ–¥ ")],-1)),c("div",Bs,[c("select",{value:u.dateRange,onChange:y[0]||(y[0]=g=>v(g.target.value)),class:"date-range-select"},[...y[6]||(y[6]=[c("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),c("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),c("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),c("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],40,Ms),u.dateRange==="custom"?(D(),E("div",Rs,[c("div",Os,[c("div",Ns,[y[7]||(y[7]=c("label",null,"–°:",-1)),c("input",{type:"date",value:u.customDateRange.startDate,onChange:y[1]||(y[1]=g=>p("startDate",g.target.value)),max:u.customDateRange.endDate||l.value,class:"date-input"},null,40,Fs)]),c("div",Ps,[y[8]||(y[8]=c("label",null,"–ü–æ:",-1)),c("input",{type:"date",value:u.customDateRange.endDate,onChange:y[2]||(y[2]=g=>p("endDate",g.target.value)),min:u.customDateRange.startDate||n.value,max:l.value,class:"date-input"},null,40,Ls)])]),a.value?(D(),E("small",Ws,L(a.value),1)):(D(),E("small",Us," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):z("",!0)])])])]))}},Vs=ie(js,[["__scopeId","data-v-4b7456a2"]]);function zs(){const u=_(!1),e=_(null),t=_(null),s=_(0),o=Fe(),a=async(g=!0,h=null)=>{u.value=!0,e.value=null,s.value=0;try{const T=await Ze.getSectorDataForSnapshot({useCache:g,onProgress:W=>{W&&typeof W.progress=="number"&&(s.value=W.progress),h&&h(W)},normalize:!0});return t.value=T,T}catch(T){throw e.value=T.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",o.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+e.value),T}finally{u.value=!1,s.value=100}},n=async(g,h={})=>{if(!t.value){const T="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw e.value=T,o.error(T),new Error(T)}u.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(g))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${g}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const T=await re.createSnapshot(t.value,g,h);return o.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),T}catch(T){throw e.value=T.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",o.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+e.value),T}finally{u.value=!1}},l=()=>{u.value=!1,e.value=null,t.value=null,s.value=0},r=V(()=>t.value!==null&&t.value!==void 0),i=_({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),f=V(()=>{const g=new Date;let h,T;switch(i.value.dateRange){case"last-week":h=new Date(g),h.setDate(g.getDate()-7),T=g;break;case"last-2-weeks":h=new Date(g),h.setDate(g.getDate()-14),T=g;break;case"last-month":h=new Date(g),h.setMonth(g.getMonth()-1),T=g;break;case"custom":h=i.value.customDateRange.startDate?new Date(i.value.customDateRange.startDate):null,T=i.value.customDateRange.endDate?new Date(i.value.customDateRange.endDate):null;break;default:h=new Date(g),h.setDate(g.getDate()-7),T=g}return{startDate:h?h.toISOString().split("T")[0]:null,endDate:T?T.toISOString().split("T")[0]:null}}),v=()=>{b()},p=()=>{i.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},b()},b=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(i.value))}catch(g){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",g)}},k=()=>{try{const g=localStorage.getItem("graphStateFilters");if(g){const h=JSON.parse(g);h&&typeof h=="object"&&(i.value={stages:h.stages||{formed:!0,review:!0,execution:!0},employees:h.employees||["all"],dateRange:h.dateRange||"last-week",customDateRange:h.customDateRange||{startDate:null,endDate:null}})}}catch(g){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",g)}},y=V(()=>{const g=Object.values(i.value.stages).some(W=>!W),h=!i.value.employees.includes("all"),T=i.value.dateRange!=="last-week";return g||h||T});return{isLoading:u,error:e,currentSectorData:t,loadingProgress:s,hasSectorData:r,filters:i,selectedPeriod:f,hasActiveFilters:y,loadSectorDataForSnapshot:a,createSnapshot:n,resetState:l,applyFilters:v,resetFilters:p,saveFiltersToLocalStorage:b,loadFiltersFromLocalStorage:k}}const Ks={class:"graph-state-dashboard"},Hs={key:1,class:"error-message-container"},qs={class:"error-message"},Gs={class:"error-text"},Ys={key:0,class:"error-details"},Xs={class:"dashboard-header"},Js={class:"header-content"},Zs={class:"breadcrumbs-row"},Qs=["aria-disabled","data-fallback","disabled"],en={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},tn={class:"header-actions"},an=["disabled"],sn={key:0},nn={key:1},on={key:3,class:"dashboard-content"},rn={class:"chart-container"},ln="–ù–∞–∑–∞–¥",cn={__name:"GraphStateDashboard",setup(u){const e=(I,F)=>typeof window>"u"?F:getComputedStyle(document.documentElement).getPropertyValue(I).trim()||F,t=Fe(),s=Ct(),o={name:"dashboard-sector-1c"},{filters:a,selectedPeriod:n,hasActiveFilters:l,applyFilters:r,resetFilters:i,loadFiltersFromLocalStorage:f}=zs(),v=_(null),p=_(!0),b=_(!1),k=_("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),y=_(null),g=_(!1),h=_(!1),T=_(typeof window<"u"?window.innerWidth:1024),W=_(null),G=_(!1),U=V(()=>T.value<768);V(()=>T.value>=768&&T.value<1024),V(()=>T.value>=1024);const R=V(()=>typeof window>"u"?!1:window.history.length>1);V(()=>{const I=new Date;return I.setFullYear(I.getFullYear()-1),I.toISOString().split("T")[0]}),V(()=>new Date().toISOString().split("T")[0]);function x(I){a.value.stages=I}function j(I){a.value.employees=I}function X(I){a.value.dateRange=I}function ee(I){a.value.customDateRange=I}function ce(){r()}function ge(){i(),W.value=null,ce(),t.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function _e(I){t.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function We(I){b.value=!1,k.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",I)}function Ue(I){b.value=!1,be({message:I||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function be(I){y.value={message:I.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:I.details||null,type:I.type||"error",timestamp:new Date},console.error("Dashboard error:",y.value),t.error(y.value.message)}function je(){y.value=null}function Ve(){y.value=null,b.value=!0,k.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function ze(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}g.value=!0;try{const I=document.querySelector(".chart-container");if(!I)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const F=window.html2canvas,ae=await F(I,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),De=window.jsPDF,J=new De("landscape","mm","a4"),Ie=297,Ee=ae.height*Ie/ae.width;J.setFontSize(18),J.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const Te=new Date().toLocaleDateString("ru-RU");J.setFontSize(10);const te=n.value.startDate&&n.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${n.value.startDate} - ${n.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";J.text(te,148.5,25,{align:"center"}),J.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${Te}`,148.5,30,{align:"center"}),J.addImage(ae.toDataURL("image/png"),"PNG",10,35,Ie-20,Ee-20),J.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${Te}`,author:"Bitrix24 Dashboard"});const w=`graph-state-${Te.replace(/\//g,"-")}.pdf`;J.save(w),t.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(I){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",I),be({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(I.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:I.stack,type:"error"})}finally{g.value=!1}}function Ke(I){var F;if((F=I==null?void 0:I.preventDefault)==null||F.call(I),!G.value){G.value=!0;try{if(R.value){s.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),s.push(o)}finally{G.value=!1}}}function Ae(){typeof window<"u"&&(T.value=window.innerWidth)}async function He(){try{const I=await mt.checkAccess();I.allowed&&(v.value=I.user)}catch(I){console.error("Error loading user:",I)}}return Se(()=>{f(),He(),typeof window<"u"&&(T.value=window.innerWidth,window.addEventListener("resize",Ae))}),Pe(()=>{typeof window<"u"&&window.removeEventListener("resize",Ae)}),(I,F)=>{const ae=$t("router-link");return D(),E("div",Ks,[b.value?(D(),he(gt,{key:0,message:k.value},null,8,["message"])):z("",!0),y.value?(D(),E("div",Hs,[c("div",qs,[c("div",{class:"error-header"},[F[1]||(F[1]=c("span",{class:"error-icon"},"‚ùå",-1)),F[2]||(F[2]=c("h3",null,"–û—à–∏–±–∫–∞",-1)),c("button",{onClick:je,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),c("p",Gs,L(y.value.message),1),y.value.details?(D(),E("div",Ys,[c("details",null,[F[3]||(F[3]=c("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),c("pre",null,L(y.value.details),1)])])):z("",!0),c("div",{class:"error-actions"},[c("button",{onClick:Ve,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):z("",!0),c("div",Xs,[c("div",Js,[c("div",Zs,[c("button",{class:"btn-back-link",type:"button",onClick:Ke,"aria-label":ln,"aria-disabled":!R.value,"data-fallback":!R.value,disabled:G.value,title:"–ù–∞–∑–∞–¥"}," ‚Üê ",8,Qs),c("nav",en,[Q(ae,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Le(()=>[...F[4]||(F[4]=[Re(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),F[5]||(F[5]=c("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),F[6]||(F[6]=c("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))])]),F[7]||(F[7]=c("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),F[8]||(F[8]=c("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),c("div",tn,[c("button",{onClick:ze,class:"btn-export-pdf",disabled:g.value||b.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[g.value?(D(),E("span",nn,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(D(),E("span",sn,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,an),Q(Xa,{user:v.value,onSnapshotCreated:_e},null,8,["user"])])]),U.value?(D(),E("button",{key:2,class:"mobile-filters-toggle",onClick:F[0]||(F[0]=De=>h.value=!h.value)},[F[9]||(F[9]=c("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("span",{class:Y(["toggle-icon",{open:h.value}])},"‚ñº",2)])):z("",!0),c("div",{class:Y({"mobile-open":h.value&&U.value,"mobile-closed":!h.value&&U.value})},[Q(Vs,{stages:me(a).stages,employees:me(a).employees,dateRange:me(a).dateRange,customDateRange:me(a).customDateRange,hasActiveFilters:me(l),"onUpdate:stages":x,"onUpdate:employees":j,"onUpdate:dateRange":X,"onUpdate:customDateRange":ee,onReset:ge,onApply:ce},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!b.value&&!y.value?(D(),E("div",on,[c("div",rn,[Q(_a,{period:me(n),"show-current-state":p.value,onDataLoaded:We,onError:Ue},null,8,["period","show-current-state"])])])):z("",!0)])}}},fn=ie(cn,[["__scopeId","data-v-e995acfd"]]);export{fn as default};
