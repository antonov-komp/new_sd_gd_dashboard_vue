var p=Object.defineProperty;var _=(d,e,t)=>e in d?p(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var y=(d,e,t)=>_(d,typeof e!="symbol"?e+"":e,t);import{D as c}from"./chunk-D15Haoqg.js";import{h as g,j as f,q as u,r as T}from"./chunk-C-QDJ0Zs.js";import"./chunk-yzaUG9vQ.js";import"./chunk-D85qNiqy.js";import"./chunk-CVoFfQ50.js";class m{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const t=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",t);const s=await this.getEmployeesByIds(t);return console.log("Loaded employees:",s.length),{stages:this.groupTicketsByStages(e,s),employees:s,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],t=[];for(const s of e){console.log(`Loading tickets for stage: ${s}`);const r=await this.getTicketsByStage(s);t.push(...r),console.log(`Loaded ${r.length} tickets for stage ${s}`)}return t}static async getTicketsByStage(e){const t=[];let s=0;const r=50;let a=!0;for(;a;)try{const o=await new c().call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:s,useOriginalUfNames:"Y"});let n=[];o&&o.result&&(Array.isArray(o.result)?n=o.result:o.result.items&&Array.isArray(o.result.items)?n=o.result.items:o.result.data&&Array.isArray(o.result.data)&&(n=o.result.data)),n.length>0?(t.push(...n),s+=n.length,a=n.length===r):a=!1}catch(i){console.error(`Error loading tickets batch for stage ${e} (start: ${s}):`,i),a=!1}t.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(t[0],null,2)),console.log("Sample ticket keys:",Object.keys(t[0])),console.log("Sample ticket assignedById variants:",{assignedById:t[0].assignedById,assignedByIdId:t[0].assignedByIdId,ASSIGNED_BY_ID:t[0].ASSIGNED_BY_ID}));const l=t.filter(i=>{const o=i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product||i.ufCrm7TypeProduct||i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product;return Array.isArray(o)?o.includes(this.SECTOR_TAG):typeof o=="object"&&o!==null?o.value===this.SECTOR_TAG||o===this.SECTOR_TAG:o===this.SECTOR_TAG});return console.log(`Filtered ${l.length} tickets from ${t.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),l}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(s=>{const r=s.assignedById||s.assignedByIdId||s.ASSIGNED_BY_ID||s.assignedById||s.assignedById&&typeof s.assignedById=="object"&&(s.assignedById.id||s.assignedById.ID)||s.assignedById&&typeof s.assignedById=="object"&&s.assignedById.value;if(r){const a=parseInt(r);a&&!isNaN(a)&&a>0&&t.add(a)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(t))),Array.from(t)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const s=await new c().call("user.get",{filter:{ID:e}});let r=[];return s&&s.result&&(Array.isArray(s.result)?r=s.result:console.warn("Unexpected user.get result format:",s)),r.map(a=>({id:parseInt(a.ID||a.id||0),name:`${a.NAME||a.name||""} ${a.LAST_NAME||a.lastName||""}`.trim()||a.EMAIL||a.email||"Неизвестный",position:a.WORK_POSITION||a.workPosition||"Сотрудник",email:a.EMAIL||a.email||"",tickets:[]}))}catch(t){return console.error("Error getting employees by IDs:",t),[]}}static groupTicketsByStages(e,t){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(t)||(console.warn("Employees is not an array:",t),t=[]);const s=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:t.map(r=>({...r,tickets:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:t.map(r=>({...r,tickets:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:t.map(r=>({...r,tickets:[]}))}];return e.forEach(r=>{const a=this.mapStageId(r.stageId||r.STAGE_ID||""),l=s.find(i=>i.id===a);if(l){const i=r.assignedById||r.ASSIGNED_BY_ID||null,o=i?parseInt(i):null;if(o){let n=l.employees.find(I=>I.id===o);n||(n={id:o,name:`Сотрудник #${o}`,position:"Неизвестно",email:"",tickets:[]},l.employees.push(n)),n.tickets.push(this.mapTicket(r))}}}),s}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const t=parseInt(e.id||e.ID||0),s=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",a=e.assignedById||e.ASSIGNED_BY_ID||null,l=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",i=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",o=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,n=g(o),I=f(n);return{id:t,title:s,priorityId:n.id,priorityLabel:n.label,priorityColors:I,priority:n.id,priorityBitrixValue:n.bitrixValue||null,status:this.mapStatus(r),assigneeId:a?parseInt(a):null,stageId:this.mapStageId(r),createdAt:l,modifiedAt:i,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return g(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const t=u(e);if(t&&t.bitrixValue)return t.bitrixValue;const s={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return s[e]?s[e]:u(T).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(s=>!(s.assignedById||s.ASSIGNED_BY_ID)).forEach(s=>{const r=this.mapStageId(s.stageId||s.STAGE_ID||"");t[r]&&t[r].push(this.mapTicket(s))}),t):(console.warn("Tickets is not an array in getZeroPointTickets:",e),t)}static async assignTicket(e,t,s){try{const r=this.mapStageIdToBitrix(s);return(await new c().call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:t,stageId:r}})).result===!0}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(e){try{const s=await new c().call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return s.result?parseInt(s.result):0}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const s=await new c().call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(s.result)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await new c().call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:t}})).result!==void 0}catch(s){throw console.error("Error adding comment:",s),s}}}y(m,"ENTITY_TYPE_ID",140),y(m,"SECTOR_TAG","1C");export{m as DashboardSector1CService};
