var x=Object.defineProperty;var J=(t,e,s)=>e in t?x(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var E=(t,e,s)=>J(t,typeof e!="symbol"?e+"":e,s);import{_ as C,c as T,a as u,b as L,t as k,n as N,o as y,F as O,r as b,d as A,e as M,f as D,g as G,w as Q,T as ee,h as te,i as U,j as se,k as ne}from"./main-DAcKcKjT.js";const ae={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(t,{emit:e}){return{getPriorityLabel:o=>({high:"–í—ã—Å–æ–∫–∏–π",medium:"–°—Ä–µ–¥–Ω–∏–π",low:"–ù–∏–∑–∫–∏–π"})[o]||o,getStatusLabel:o=>({in_progress:"–í —Ä–∞–±–æ—Ç–µ",new:"–ù–æ–≤—ã–π",done:"–í—ã–ø–æ–ª–Ω–µ–Ω–æ",pending:"–û–∂–∏–¥–∞–Ω–∏–µ"})[o]||o,handleDragStart:o=>{o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("application/json",JSON.stringify(t.ticket)),o.dataTransfer.setDragImage(o.target,0,0),e("drag-start",t.ticket)},handleDragEnd:()=>{e("drag-end")}}}},re=["draggable"],oe={class:"ticket-header"},ie={class:"ticket-id"},ce={class:"ticket-title"},le={class:"ticket-meta"},de={class:"ticket-status"},ue={key:0,class:"ticket-description"};function ge(t,e,s,n,a,d){return y(),T("div",{class:N(["ticket-card",{"priority-high":s.ticket.priority==="high","priority-medium":s.ticket.priority==="medium","priority-low":s.ticket.priority==="low"}]),draggable:s.draggable,onClick:e[0]||(e[0]=o=>t.$emit("click",s.ticket)),onDragstart:e[1]||(e[1]=(...o)=>n.handleDragStart&&n.handleDragStart(...o)),onDragend:e[2]||(e[2]=(...o)=>n.handleDragEnd&&n.handleDragEnd(...o))},[u("div",oe,[e[3]||(e[3]=u("span",{class:"ticket-icon"},"üé´",-1)),u("span",ie,"#"+k(s.ticket.id),1)]),u("div",ce,k(s.ticket.title),1),u("div",le,[u("span",{class:N(["ticket-priority",`priority-${s.ticket.priority}`])},k(n.getPriorityLabel(s.ticket.priority)),3),u("span",de,k(n.getStatusLabel(s.ticket.status)),1)]),s.ticket.description?(y(),T("div",ue,k(s.ticket.description),1)):L("",!0)],42,re)}const W=C(ae,[["render",ge],["__scopeId","data-v-b255f359"]]),fe={name:"ZeroPoint",components:{TicketCard:W},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){return{handleTicketDragStart:n=>{e("ticket-dragged",n)}}}},ye={class:"zero-point"},me={class:"zero-point-header"},Te={class:"tickets-count"},he={class:"zero-point-tickets"},pe={key:0,class:"empty-state"};function ke(t,e,s,n,a,d){const o=A("TicketCard");return y(),T("div",ye,[u("div",me,[e[0]||(e[0]=u("span",{class:"zero-point-icon"},"üì•",-1)),e[1]||(e[1]=u("h3",null,"[0] –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞",-1)),u("span",Te,"("+k(s.tickets.length)+")",1)]),e[3]||(e[3]=u("div",{class:"zero-point-description"},[u("p",null,"–í—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã"),u("p",{class:"hint"},"–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–∏–∫–µ—Ç –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")],-1)),u("div",he,[(y(!0),T(O,null,b(s.tickets,i=>(y(),M(o,{key:i.id,ticket:i,draggable:!0,onDragStart:r=>n.handleTicketDragStart(i),onClick:r=>t.$emit("ticket-clicked",i)},null,8,["ticket","onDragStart","onClick"]))),128)),s.tickets.length===0?(y(),T("div",pe,[...e[2]||(e[2]=[u("p",null,"–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤",-1)])])):L("",!0)])])}const De=C(fe,[["render",ke],["__scopeId","data-v-252e877d"]]);function _e(t){return typeof t=="number"&&t>0&&!isNaN(t)}function F(t){return typeof t=="number"&&t>0&&!isNaN(t)}function H(t){return typeof t=="string"&&["formed","review","execution"].includes(t)}function Ie(t){return!t||typeof t!="object"?!1:_e(t.id)&&typeof t.title=="string"&&t.title.trim().length>0}function Z(t,e,s){return!(!Ie(t)||!F(e)||!H(s)||t.assigneeId===e&&t.stageId===s)}function ve(t){const e=[];return!t||typeof t!="object"?(e.push("–î–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{valid:!1,errors:e}):((!t.title||typeof t.title!="string"||t.title.trim().length===0)&&e.push("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),t.stageId&&!H(t.stageId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å—Ç–∞–¥–∏–∏"),t.employeeId&&!F(t.employeeId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"),{valid:e.length===0,errors:e})}function q(){const t=(d,o="info",i=5e3)=>{typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:d,autoHideDelay:i}):console.log(`[${o.toUpperCase()}] ${d}`)};return{notify:t,success:(d,o=3e3)=>{t(d,"success",o)},error:(d,o=5e3)=>{t(d,"error",o)},info:(d,o=4e3)=>{t(d,"info",o)},warning:(d,o=4e3)=>{t(d,"warning",o)}}}function Ee(t){const e=q(),s=D(!1);return{isDropZoneActive:s,handleDragStart:(r,c)=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("application/json",JSON.stringify(c)),r.dataTransfer.setDragImage(r.target,0,0)},handleDragOver:r=>{r.preventDefault(),r.dataTransfer.dropEffect="move",s.value=!0},handleDragLeave:r=>{const c=r.currentTarget.getBoundingClientRect(),l=r.clientX,g=r.clientY;(l<c.left||l>c.right||g<c.top||g>c.bottom)&&(s.value=!1)},handleDrop:async(r,c,l)=>{r.preventDefault(),s.value=!1;const g=r.dataTransfer.getData("application/json");if(g)try{const m=JSON.parse(g);if(!Z(m,c,l)){e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞");return}t&&typeof t=="function"&&await t(m,c,l)}catch(m){console.error("Error parsing ticket data:",m),e.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞")}},handleDragEnd:r=>{s.value=!1}}}const Se={name:"EmployeeColumn",components:{TicketCard:W},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(t,{emit:e}){const n=Ee(async(i,r,c)=>{e("ticket-dropped",i,r)}),a=i=>{n.handleDrop(i,t.employee.id,t.stageId)},d=i=>{},o=()=>{console.log("Add ticket for employee:",t.employee.id)};return{isDropZoneActive:n.isDropZoneActive,handleDragOver:n.handleDragOver,handleDragLeave:n.handleDragLeave,handleDrop:a,handleTicketDragStart:d,handleAddTicket:o}}},Ae={class:"employee-header"},Ce={class:"employee-info"},we={class:"employee-details"},Pe={class:"employee-name"},Be={key:0,class:"employee-position"},Le={class:"tickets-count"},Ne={class:"tickets-list"},Oe={key:0,class:"empty-state"};function be(t,e,s,n,a,d){var i;const o=A("TicketCard");return y(),T("div",{class:N(["employee-column",{"drop-zone-active":n.isDropZoneActive}]),onDragover:e[1]||(e[1]=te((...r)=>n.handleDragOver&&n.handleDragOver(...r),["prevent"])),onDragleave:e[2]||(e[2]=(...r)=>n.handleDragLeave&&n.handleDragLeave(...r)),onDrop:e[3]||(e[3]=(...r)=>n.handleDrop&&n.handleDrop(...r))},[u("div",Ae,[u("div",Ce,[e[4]||(e[4]=u("span",{class:"employee-icon"},"üë§",-1)),u("div",we,[u("div",Pe,k(s.employee.name),1),s.employee.position?(y(),T("div",Be,k(s.employee.position),1)):L("",!0)])]),u("div",Le," üìä –¢–∏–∫–µ—Ç–æ–≤: "+k(((i=s.employee.tickets)==null?void 0:i.length)||0),1)]),u("div",Ne,[G(ee,{name:"ticket",tag:"div"},{default:Q(()=>[(y(!0),T(O,null,b(s.employee.tickets,r=>(y(),M(o,{key:r.id,ticket:r,draggable:!0,onClick:c=>t.$emit("ticket-clicked",r),onDragStart:n.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1}),!s.employee.tickets||s.employee.tickets.length===0?(y(),T("div",Oe,[e[5]||(e[5]=u("p",null,"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤",-1)),u("button",{class:"add-ticket-btn",onClick:e[0]||(e[0]=(...r)=>n.handleAddTicket&&n.handleAddTicket(...r))}," + –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç ")])):L("",!0)])],34)}const Me=C(Se,[["render",be],["__scopeId","data-v-6120ff13"]]),Re={name:"DashboardStage",components:{ZeroPoint:De,EmployeeColumn:Me},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){const s=D(!1),n=U(()=>{const c=Array.isArray(t.zeroPointTickets)?t.zeroPointTickets.length:0,l=Array.isArray(t.stage.employees)?t.stage.employees.reduce((g,m)=>{const _=Array.isArray(m.tickets)?m.tickets.length:0;return g+_},0):0;return c+l}),a=U(()=>{var g;const c=((g=t.stage)==null?void 0:g.name)||"–°—Ç–∞–¥–∏—è",l=n.value;return`${c} (${l})`});return{isDragging:s,totalTicketsCount:n,stageNameWithCount:a,handleTicketDragged:c=>{s.value=!0},handleTicketAssigned:(c,l)=>{e("ticket-assigned",c,l)},handleTicketDropped:(c,l)=>{e("ticket-moved",c,l,t.stage.id),s.value=!1},handleTicketClicked:c=>{console.log("Ticket clicked:",c),e("ticket-clicked",c)}}}},ze={class:"stage-header"},Ke={class:"stage-content"},$e={class:"employees-container"};function Ye(t,e,s,n,a,d){const o=A("ZeroPoint"),i=A("EmployeeColumn");return y(),T("div",{class:"dashboard-stage",style:se({borderLeftColor:s.stage.color})},[u("div",ze,[u("h2",null,k(n.stageNameWithCount),1)]),u("div",Ke,[G(o,{tickets:s.zeroPointTickets,"stage-id":s.stage.id,onTicketDragged:n.handleTicketDragged,onTicketAssigned:n.handleTicketAssigned,onTicketClicked:n.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),u("div",$e,[(y(!0),T(O,null,b(s.stage.employees,r=>(y(),M(i,{key:r.id,employee:r,"stage-id":s.stage.id,onTicketClicked:n.handleTicketClicked,onTicketDropped:n.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const je=C(Re,[["render",Ye],["__scopeId","data-v-8c32af0d"]]);function Ue(){const t=D(!0),e=D(null),s=D([{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}]),n=D({formed:[],review:[],execution:[]}),a=D([]),d=D(null);return{isLoading:t,error:e,stages:s,zeroPointTickets:n,employees:a,draggedTicket:d,updateState:l=>{l.stages&&(s.value=l.stages),l.employees&&(a.value=l.employees),l.zeroPointTickets&&(n.value=l.zeroPointTickets)},resetState:()=>{t.value=!1,e.value=null,s.value=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}],n.value={formed:[],review:[],execution:[]},a.value=[],d.value=null},updateLocalStateAfterMove:(l,g,m)=>{const _=s.value.find(h=>h.employees.some(p=>p.tickets.some(R=>R.id===l.id)));if(_){const h=_.employees.find(p=>p.tickets.some(R=>R.id===l.id));h&&(h.tickets=h.tickets.filter(p=>p.id!==l.id))}const I=s.value.find(h=>h.id===m);if(I){const h=I.employees.find(p=>p.id===g);if(h){const p={...l,assigneeId:g,stageId:m};h.tickets.push(p)}}Object.keys(n.value).forEach(h=>{n.value[h]=n.value[h].filter(p=>p.id!==l.id)})},getEmployeeTickets:(l,g)=>{const m=s.value.find(I=>I.id===g);if(!m)return[];const _=m.employees.find(I=>I.id===l);return _?_.tickets||[]:[]}}}class Ve{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,s={}){try{const n=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:s})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const a=await n.json();if(a.error)throw new Error(a.error_description||a.error);return a}catch(n){throw console.error("Bitrix24 API error:",n),n}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},s=["ID","NAME","EMAIL","PHONE"],n={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:s,order:n})).result||[]}}class v{static async call(e,s={}){return await Ve.call(e,s)}}class f{static get(e){const s=this.cache.get(e);return s?Date.now()-s.timestamp>s.ttl?(this.cache.delete(e),null):s.data:null}static set(e,s,n=this.DEFAULT_TTL){this.cache.set(e,{data:s,timestamp:Date.now(),ttl:n})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const s=[];for(const n of this.cache.keys())n.startsWith(e)&&s.push(n);s.forEach(n=>this.cache.delete(n))}static cleanExpired(){const e=Date.now(),s=[];for(const[n,a]of this.cache.entries())e-a.timestamp>a.ttl&&s.push(n);s.forEach(n=>this.cache.delete(n))}static getStats(){const e=Date.now();let s=0,n=0;for(const a of this.cache.values())e-a.timestamp>a.ttl?s++:n++;return{total:this.cache.size,valid:n,expired:s}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((n,a)=>n-a).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}E(f,"cache",new Map),E(f,"DEFAULT_TTL",5*60*1e3),E(f,"EMPLOYEES_TTL",30*60*1e3),E(f,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{f.cleanExpired()},5*60*1e3);const w=140;class P{static async getAllTickets(e){const s=[];for(const n of e){console.log(`Loading tickets for stage: ${n}`);const a=await this.getTicketsByStage(n);s.push(...a),console.log(`Loaded ${a.length} tickets for stage ${n}`)}return s}static async getTicketsByStage(e,s=!0){if(s){const i=f.getTicketsCacheKey(e),r=f.get(i);if(r!==null)return console.log(`Cache hit for stage ${e}`),r}const n=[];let a=0;const d=50;let o=!0;for(;o;)try{const i=await v.call("crm.item.list",{entityTypeId:w,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let r=[];i&&i.result&&(Array.isArray(i.result)?r=i.result:i.result.items&&Array.isArray(i.result.items)?r=i.result.items:i.result.data&&Array.isArray(i.result.data)&&(r=i.result.data)),r.length>0?(n.push(...r),a+=r.length,o=r.length===d):o=!1}catch(i){console.error(`Error loading tickets batch for stage ${e} (start: ${a}):`,i),o=!1}if(s){const i=f.getTicketsCacheKey(e);f.set(i,n,f.TICKETS_TTL)}return n}static async getTicket(e){return(await v.call("crm.item.get",{entityTypeId:w,id:e})).result||null}static async updateTicket(e,s){const a=(await v.call("crm.item.update",{entityTypeId:w,id:e,fields:s})).result===!0;return a&&f.invalidateTicketsCache(),a}static async createTicket(e){const s=await v.call("crm.item.add",{entityTypeId:w,fields:e}),n=s.result?parseInt(s.result):0;return n>0&&f.invalidateTicketsCache(),n}static async assignTicket(e,s,n){return await this.updateTicket(e,{assignedById:s,stageId:n})}}class Xe{static async getEmployeesByIds(e,s=!0){if(!Array.isArray(e)||e.length===0)return[];if(s){const n=f.getEmployeesCacheKey(e),a=f.get(n);if(a!==null)return console.log(`Cache hit for employees: ${e.length} employees`),a}try{const n=await v.call("user.get",{filter:{ID:e}});let a=[];if(n&&n.result&&(Array.isArray(n.result)?a=n.result:console.warn("Unexpected user.get result format:",n)),s){const d=f.getEmployeesCacheKey(e);f.set(d,a,f.EMPLOYEES_TTL)}return a}catch(n){return console.error("Error getting employees by IDs:",n),[]}}}const Ge=140,z={FORMED:{bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{bitrixId:"DT140_12:PREPARATION"},EXECUTION:{bitrixId:"DT140_12:CLIENT"}},We={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},Fe={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},He={3:"high",2:"medium",1:"low"};function Ze(){return[z.FORMED.bitrixId,z.REVIEW.bitrixId,z.EXECUTION.bitrixId]}function Y(t){return We[t]||"formed"}function V(t){return Fe[t]||"DT140_12:UC_0VHWE2"}function qe(){return Ze()}function j(t){const e=parseInt(t.id||t.ID||0),s=t.title||t.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",n=t.stageId||t.STAGE_ID||"",a=t.assignedById||t.ASSIGNED_BY_ID||null,d=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",o=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"";return{id:e,title:s,priority:xe(t.priority||t.PRIORITY),status:Je(),assigneeId:a?parseInt(a):null,stageId:Y(n),createdAt:d,modifiedAt:o,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function xe(t){return He[t]||"medium"}function Je(t){return"in_progress"}function Qe(t){return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:t.WORK_POSITION||t.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:t.EMAIL||t.email||"",tickets:[]}}function et(t){return Array.isArray(t)?t.map(e=>Qe(e)):[]}const B="1C",S=new Map,X=100;function tt(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function st(t){const e=tt(t);return e?Array.isArray(e)?e.includes(B):typeof e=="object"&&e!==null&&e.value===B||e===B:!1}function nt(t){return`filter:${t.map(s=>s.id||s.ID||"").sort().join(",")}`}function at(){S.size>X&&Array.from(S.keys()).slice(0,Math.floor(X*.2)).forEach(e=>S.delete(e))}function rt(t){if(!Array.isArray(t))return[];const e=nt(t),s=S.get(e);if(s!==void 0)return s;const n=t.filter(st);return S.set(e,n),at(),n}function ot(t,e){Array.isArray(t)||(console.warn("Tickets is not an array:",t),t=[]),Array.isArray(e)||(console.warn("Employees is not an array:",e),e=[]);const s=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:e.map(n=>({...n,tickets:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:e.map(n=>({...n,tickets:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:e.map(n=>({...n,tickets:[]}))}];return t.forEach(n=>{const a=Y(n.stageId||n.STAGE_ID||""),d=s.find(o=>o.id===a);if(d){const o=n.assignedById||n.ASSIGNED_BY_ID||null,i=o?parseInt(o):null;if(i){let r=d.employees.find(c=>c.id===i);r||(r={id:i,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${i}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",tickets:[]},d.employees.push(r)),r.tickets.push(j(n))}}}),s}function it(t){const e={formed:[],review:[],execution:[]};return Array.isArray(t)?(t.filter(s=>!(s.assignedById||s.ASSIGNED_BY_ID)).forEach(s=>{const n=Y(s.stageId||s.STAGE_ID||"");e[n]&&e[n].push(j(s))}),e):(console.warn("Tickets is not an array in getZeroPointTickets:",t),e)}function ct(t){if(!Array.isArray(t))return[];const e=new Set;return t.forEach(s=>{const n=s.assignedById||s.assignedByIdId||s.ASSIGNED_BY_ID||s.assignedById||s.assignedById&&typeof s.assignedById=="object"&&(s.assignedById.id||s.assignedById.ID)||s.assignedById&&typeof s.assignedById=="object"&&s.assignedById.value;if(n){const a=parseInt(n);a&&!isNaN(a)&&a>0&&e.add(a)}}),Array.from(e)}class K{static async getSectorData(e=!0){if(e){const s=f.getSectorDataCacheKey(),n=f.get(s);if(n!==null)return console.log("Cache hit for sector data"),n}try{const s=qe(),n=await P.getAllTickets(s);console.log("Total tickets loaded:",n.length);const a=rt(n);console.log(`Filtered ${a.length} tickets from ${n.length} (sector tag: 1C)`);const d=ct(a);console.log("Unique employee IDs:",d);const o=await Xe.getEmployeesByIds(d),i=et(o);console.log("Loaded employees:",i.length);const c={stages:ot(a,i),employees:i,zeroPointTickets:it(a)};if(e){const l=f.getSectorDataCacheKey();f.set(l,c,f.TICKETS_TTL)}return c}catch(s){throw console.error("Error getting sector data:",s),s}}static async assignTicket(e,s,n){try{const a=V(n),d=await P.assignTicket(e,s,a);return d&&f.invalidateTicketsCache(),d}catch(a){throw console.error("Error assigning ticket:",a),a}}static async createTicket(e){try{const s=V(e.stageId||"formed"),n={title:e.title,stageId:s};e.employeeId&&(n.assignedById=e.employeeId);const a=await P.createTicket(n);return a>0&&f.invalidateTicketsCache(),a}catch(s){throw console.error("Error creating ticket:",s),s}}static async getTicket(e){try{const s=await P.getTicket(e);return j(s)}catch(s){throw console.error("Error getting ticket:",s),s}}static async addComment(e,s){try{return(await v.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+Ge,comment:s}})).result!==void 0}catch(n){throw console.error("Error adding comment:",n),n}}}function lt(t,e=""){if(console.error(`API Error ${e?`(${e})`:""}:`,t),t.message){if(t.message.includes("HTTP error"))return"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";if(t.message.includes("timeout"))return"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";if(t.message.includes("403")||t.message.includes("401"))return"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";if(t.message.includes("500"))return"–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."}return t.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}function dt(t,e="",s={}){const n={message:t.message,stack:t.stack,context:e,...s,timestamp:new Date().toISOString()};console.error("Error logged:",n)}function $(t,e="",s=null){const n=lt(t,e);dt(t,e),s&&typeof s=="function"?s(n,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:n,autoHideDelay:5e3})}function ut(t){const e=q(),s=async(c=!0)=>{t.isLoading.value=!0,t.error.value=null;try{const l=await K.getSectorData(c);t.updateState(l)}catch(l){t.error.value=l.message,$(l,"loading sector data",e.error)}finally{t.isLoading.value=!1}},n=async(c,l,g)=>{if(!Z(c,l,g))return e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞"),!1;try{const m=await K.assignTicket(c.id,l,g);return m&&(t.updateLocalStateAfterMove(c,l,g),e.success("–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω")),m}catch(m){return $(m,"assigning ticket",e.error),!1}finally{t.draggedTicket.value=null}};return{loadSectorData:s,assignTicket:n,moveTicketToStage:async(c,l)=>await n(c,c.assigneeId,l),assignTicketToEmployee:async(c,l)=>await n(c,l,c.stageId),createTicket:async c=>{const l=ve(c);if(!l.valid){const g=l.errors.join(", ");return e.error(g),0}try{const g=await K.createTicket(c);return g>0&&(await s(!1),e.success("–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω")),g}catch(g){return $(g,"creating ticket",e.error),0}},handleTicketDragStart:c=>{t.draggedTicket.value=c},handleTicketDrop:async(c,l,g)=>{await n(c,l,g)}}}const gt={name:"DashboardSector1C",components:{DashboardStage:je},setup(){const t=Ue(),e=ut(t);return ne(()=>{e.loadSectorData()}),{isLoading:t.isLoading,error:t.error,stages:t.stages,zeroPointTickets:t.zeroPointTickets,employees:t.employees,draggedTicket:t.draggedTicket,loadSectorData:e.loadSectorData,handleTicketDragStart:e.handleTicketDragStart,handleTicketDrop:e.handleTicketDrop,assignTicketToEmployee:e.assignTicketToEmployee,moveTicketToStage:e.moveTicketToStage,createTicket:e.createTicket,getEmployeeTickets:t.getEmployeeTickets}}},ft={key:0,class:"loading-state"},yt={key:1,class:"error-state"},mt={key:2,class:"dashboard-content"},Tt={class:"stages-container"};function ht(t,e,s,n,a,d){const o=A("DashboardStage");return y(),T("div",{class:N(["dashboard-sector-1c",{"is-dragging":n.draggedTicket}])},[e[1]||(e[1]=u("div",{class:"dashboard-header"},[u("h1",null,"–î–∞—à–±–æ—Ä–¥ - –°–µ–∫—Ç–æ—Ä 1–°")],-1)),n.isLoading?(y(),T("div",ft,[...e[0]||(e[0]=[u("p",null,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...",-1)])])):n.error?(y(),T("div",yt,[u("p",null,"–û—à–∏–±–∫–∞: "+k(n.error),1)])):(y(),T("div",mt,[u("div",Tt,[(y(!0),T(O,null,b(n.stages,i=>(y(),M(o,{key:i.id,stage:i,"zero-point-tickets":n.zeroPointTickets[i.id]||[],onTicketMoved:n.handleTicketDrop,onTicketAssigned:n.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])]))],2)}const Dt=C(gt,[["render",ht],["__scopeId","data-v-bb236aab"]]);export{Dt as default};
