const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./chunk-Cm-sZV4A.js","./chunk-DN4eM7RG.js","./chunk-DSZ5QGvq.js","./chunk-Bzh5eqmy.js","./chunk-DIHem5mh.js","./direct-access-config-BqyTgLig.js","./access-config-async-gqR6Vfk8.js","./chunk-BxL3V5Fo.js","./WebhookLogsDashboard.vue-jhr5U-zj.js","./WebhookLogDetails.vue-P6OI-JYD.js"])))=>i.map(i=>d[i]);
var Ya=Object.defineProperty;var Xa=(o,e,s)=>e in o?Ya(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var je=(o,e,s)=>Xa(o,typeof e!="symbol"?e+"":e,s);import{r as be,c as d,o as c,a as ne,b as $,d as ha,t as g,n as X,e as a,f as he,g as I,h as Ae,u as Xe,i as ps,j as M,w as pe,T as Ee,F as ee,k as te,l as we,m as ce,p as Ce,q as We,s as Me,v as Qe,x as Oe,y as $t,C as Je,z as Ja,L as Za,P as Qa,A as eo,B as to,D as so,E as ao,G as oo,H as no,I as ro,J as Le,K as Dt,M as _t,N as wt,O as yt,Q as fa,R as va,S as st,U as Et,V as Wt,W as pa,X as _s,Y as rs,Z as Ys,_ as io,$ as ys,a0 as dt,a1 as lo,a2 as ya,a3 as co,a4 as uo,a5 as mo}from"./chunk-BxL3V5Fo.js";import{a as ka,_ as De,g as et,b as go,f as Ut}from"./chunk-DIHem5mh.js";import{C as Xs}from"./chunk-DSZ5QGvq.js";import{i as ho,S as qt,m as Yt,a as Ls,g as xs,b as ba,c as fo,d as Js,E as vo,e as ws,f as Cs,h as Qt,p as Zs,j as po,k as yo,D as ko,l as bo,n as Qs,o as ea,T as _o,q as ta,r as wo}from"./chunk-Cm-sZV4A.js";import{D as vt}from"./chunk-DN4eM7RG.js";import{L as Co}from"./chunk-Bzh5eqmy.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();const de=(o,e)=>{const s=o.__vccOpts||o;for(const[t,r]of e)s[t]=r;return s},To={name:"App"},So={id:"app"};function Do(o,e,s,t,r,i){const n=be("router-view");return c(),d("div",So,[ne(n)])}const Eo=de(To,[["render",Do]]),Ao={name:"StatusMessage",props:{type:{type:String,required:!0,validator:o=>["success","error","info","warning"].includes(o)},title:{type:String,default:null},message:{type:String,default:null}}},$o={key:0},Io={key:1};function Mo(o,e,s,t,r,i){return c(),d("div",{class:X(["status-message",`status-message--${s.type}`])},[s.title?(c(),d("strong",$o,g(s.title),1)):$("",!0),s.message?(c(),d("p",Io,g(s.message),1)):$("",!0),ha(o.$slots,"default",{},void 0)],2)}const ks=de(Ao,[["render",Mo],["__scopeId","data-v-7f15d2d7"]]),No={name:"LoadingSpinner",props:{message:{type:String,default:"Загрузка..."}}},xo={class:"loading-spinner"},Po={key:0,class:"message"};function Lo(o,e,s,t,r,i){return c(),d("div",xo,[e[0]||(e[0]=a("div",{class:"spinner"},null,-1)),s.message?(c(),d("p",Po,g(s.message),1)):$("",!0)])}const bs=de(No,[["render",Lo],["__scopeId","data-v-375eac16"]]);function Ot(){try{if(window.self===window.top)return!1;if(typeof BX24<"u")return!0;try{const o=window.parent.location.origin;return o.includes("bitrix24")||o.includes("kompo.by")}catch{return!1}}catch(o){return console.warn("Error checking Bitrix24 context:",o),!1}}function Oo(){return typeof BX24<"u"}class kt{static init(e){return new Promise((s,t)=>{if(!Ot()){console.log("Not inside Bitrix24, skipping BX24.init()"),e&&e(),s();return}if(typeof BX24>"u"){t(new Error("Bitrix24 API not loaded. Make sure script is included: //api.bitrix24.com/api/v1/"));return}const r=setTimeout(()=>{t(new Error("BX24.init() timeout: инициализация Bitrix24 API превысила 5 секунд"))},5e3);try{BX24.init(()=>{clearTimeout(r),e&&e(),s()})}catch(i){clearTimeout(r),t(i)}})}static installFinish(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}try{BX24.installFinish(),e()}catch(t){s(t)}})}static callMethod(e,s={}){return new Promise((t,r)=>{if(typeof BX24>"u"){r(new Error("Bitrix24 API not loaded"));return}const i=setTimeout(()=>{r(new Error(`BX24.callMethod(${e}) timeout: запрос превысил 10 секунд`))},1e4);try{BX24.callMethod(e,s,n=>{if(clearTimeout(i),n.error()){const l=n.error();r(new Error(l.error_description||l.error||"Unknown error"))}else t(n.data())})}catch(n){clearTimeout(i),r(n)}})}static async getCurrentUser(){if(Ot()&&Oo())try{const e=await Promise.race([this.callMethod("user.current",{}),new Promise((s,t)=>setTimeout(()=>t(new Error("Timeout")),5e3))]);return console.log("Got user from BX24.callMethod() (interface user):",e?.ID||"unknown"),e}catch(e){console.warn("BX24.callMethod() failed, using proxy API as fallback:",e);try{const t=await new Xs().getCurrentUser();return console.log("Got user from proxy API (token owner, fallback):",t),t}catch(s){throw console.error("Both BX24 API and proxy API failed:",s),e.message&&e.message.includes("timeout")?new Error("Таймаут при определении пользователя. Bitrix24 API не отвечает."):new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}else return console.warn("Not inside Bitrix24, using proxy API (will return token owner, not interface user)"),await new Xs().getCurrentUser()}static getUser(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}if(typeof BX24.getUser!="function"){s(new Error("BX24.getUser is not available"));return}BX24.getUser(t=>{e(t)})})}static getAuth(){return new Promise((e,s)=>{if(typeof BX24>"u"){s(new Error("Bitrix24 API not loaded"));return}BX24.getAuth(t=>{e(t)})})}}const Bo={name:"InstallPage",components:{StatusMessage:ks,LoadingSpinner:bs},setup(){const o=I(!0),e=I(null),s=I(null);return Ae(async()=>{try{let t=null;if(window.INSTALL_RESULT)t=window.INSTALL_RESULT;else{const r=ka("/install.php"),i=await fetch(`${r}?get_result=1`);i.ok&&(t=await i.json())}if(!t)throw new Error("Не удалось получить результат установки");if(s.value=t,t.rest_only===!1)if(t.install===!0){e.value={type:"success",title:"✓ Установка завершена успешно!",message:"Приложение успешно установлено в Bitrix24."};try{await kt.init(()=>{kt.installFinish()})}catch(r){console.error("Error finishing installation:",r)}}else e.value={type:"error",title:"✗ Ошибка установки",message:"Не удалось установить приложение. Проверьте настройки."};else e.value={type:"info",title:"REST-only режим",message:"Это приложение работает только через REST API, без пользовательского интерфейса."}}catch(t){console.error("Error loading install result:",t),e.value={type:"error",title:"Ошибка загрузки",message:t.message||"Не удалось загрузить информацию об установке."}}finally{o.value=!1}}),{loading:o,installStatus:e,installInfo:s}}},Ro={class:"install-page"},Wo={class:"container"},Uo={key:1,class:"info"};function Fo(o,e,s,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner");return c(),d("div",Ro,[a("div",Wo,[e[1]||(e[1]=a("h1",null,"Установка Bitrix24 приложения",-1)),t.installStatus?(c(),he(n,{key:0,type:t.installStatus.type,title:t.installStatus.title,message:t.installStatus.message},null,8,["type","title","message"])):$("",!0),t.installInfo?(c(),d("div",Uo,[e[0]||(e[0]=a("h3",null,"Информация об установке:",-1)),a("pre",null,g(JSON.stringify(t.installInfo,null,2)),1)])):$("",!0),t.loading?(c(),he(l,{key:2,message:"Обработка установки..."})):$("",!0)])])}const Ho=de(Bo,[["render",Fo],["__scopeId","data-v-d082ec9e"]]);function jo(){const o=Xe(),e=ps();return{goBack:(n="/")=>{window.history.length>1?o.back():o.push(n)},goTo:(n,l={})=>{o.push({path:n,...l})},goHome:(n={})=>{o.push({path:"/",...n})},isCurrentRoute:n=>e.path===n,router:o,route:e}}const Vo={name:"BackButton",props:{variant:{type:String,default:"header",validator:o=>["header","floating"].includes(o)},text:{type:String,default:"НАЗАД"},to:{type:String,default:null},showIcon:{type:Boolean,default:!0},ariaLabel:{type:String,default:"Вернуться на главную"},title:{type:String,default:"Вернуться на главную"}},setup(o){const{goBack:e,goHome:s}=jo();return{buttonClasses:M(()=>[o.variant==="header"?"back-button":"floating-back-button"]),handleClick:()=>{o.to?s({path:o.to}):e()}}}},zo=["aria-label","title"],Go={key:0,class:"back-button-icon"},Ko={key:1,class:"back-button-text"};function qo(o,e,s,t,r,i){return c(),d("button",{class:X(t.buttonClasses),onClick:e[0]||(e[0]=(...n)=>t.handleClick&&t.handleClick(...n)),"aria-label":s.ariaLabel,title:s.title},[s.showIcon?(c(),d("span",Go,"←")):$("",!0),s.variant==="header"?(c(),d("span",Ko,g(s.text),1)):$("",!0)],10,zo)}const _a=de(Vo,[["render",qo],["__scopeId","data-v-d605b6a0"]]);function Yo(o){const e=I(!1),s=I(null),t=I(""),r=I({}),i=I([]),n=I({}),l=I([]),u=I({totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}),m=M(()=>i.value.length>0||l.value.length>0),v=M(()=>!m.value&&!e.value&&!s.value),T=M(()=>{const B=Object.values(n.value).reduce((G,q)=>G+(q?.length||0),0),U=i.value.reduce((G,q)=>G+(q.tickets?.length||0),0);return B+U}),f=M(()=>{if(!T.value)return 0;const U=[...Object.values(n.value).flat(),...i.value.flatMap(G=>G.tickets||[])].filter(G=>G.status==="closed"||G.status==="completed"||G.status==="done").length;return Math.round(U/T.value*100)}),k=(B,U="",G={})=>{e.value=B,t.value=U,r.value=G},p=B=>{s.value=B,e.value=!1},S=()=>{s.value=null},C=B=>{i.value=B},y=B=>{l.value=B},_=B=>{n.value=B},A=B=>{u.value={...u.value,...B,lastUpdated:new Date().toISOString()}},W=()=>{e.value=!1,s.value=null,t.value="",r.value={},i.value=[],n.value={},l.value=[],u.value={totalTickets:0,totalEmployees:0,activeStages:0,lastUpdated:null}},x=B=>i.value.find(U=>U.id===B);return{isLoading:e,error:s,currentStep:t,stepDetails:r,stages:i,zeroPointTickets:n,employees:l,sectorStats:u,hasData:m,isEmpty:v,totalTickets:T,completionRate:f,setLoading:k,setError:p,clearError:S,updateStages:C,updateEmployees:y,updateZeroPointTickets:_,updateSectorStats:A,resetState:W,getStageById:x,getEmployeeById:B=>l.value.find(U=>U.id===B),getStageTickets:B=>{const U=x(B);return U?U.tickets||[]:[]},getZeroPointTickets:B=>n.value[B]||[]}}class Mt{static async call(e,s={}){return await new vt().call(e,s)}}class Be{static get(e){const s=this.cache.get(e);return s?Date.now()-s.timestamp>s.ttl?(this.cache.delete(e),null):s.data:null}static set(e,s,t=this.DEFAULT_TTL){this.cache.set(e,{data:s,timestamp:Date.now(),ttl:t})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const s=[];for(const t of this.cache.keys())t.startsWith(e)&&s.push(t);s.forEach(t=>this.cache.delete(t))}static cleanExpired(){const e=Date.now(),s=[];for(const[t,r]of this.cache.entries())e-r.timestamp>r.ttl&&s.push(t);s.forEach(t=>this.cache.delete(t))}static getStats(){const e=Date.now();let s=0,t=0;for(const r of this.cache.values())e-r.timestamp>r.ttl?s++:t++;return{total:this.cache.size,valid:t,expired:s}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((t,r)=>t-r).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}je(Be,"cache",new Map),je(Be,"DEFAULT_TTL",5*60*1e3),je(Be,"EMPLOYEES_TTL",30*60*1e3),je(Be,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{Be.cleanExpired()},5*60*1e3);const Ts="dashboard-sector-1c-logger-level",Vt={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class It{static getLevel(){if(typeof localStorage<"u"){const s=localStorage.getItem(Ts);if(s&&Vt[s]!==void 0)return s}return!0?"ERROR":"DEBUG"}static setLevel(e){return Vt[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(Ts,e),!0):!1}static isEnabled(e,s=null){const t=s||this.getLevel();if(t==="NONE")return!1;const r=Vt[e]||0,i=Vt[t]||0;return r<=i}static getLevels(){return{...Vt}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(Ts)}}let Re=class{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,s,t=""){const r=new Date().toISOString(),i=this.getLevelColor(e),n=`%c[${r}] %c[${e}] %c[${t||"Unknown"}] %c${s}`,l=["color: #6c757d; font-weight: normal",`color: ${i}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:n,styles:l}}static log(e,s,t="",r=null){if(!It.isEnabled(e))return;const i=this.formatMessage(e,s,t),n=[i.formatted,...i.styles];switch(r!=null&&n.push(r),e){case"ERROR":console.error(...n);break;case"WARN":console.warn(...n);break;case"INFO":console.info(...n);break;case"DEBUG":console.log(...n);break;default:console.log(...n)}}static error(e,s="",t=null){this.log("ERROR",e,s,t)}static warn(e,s="",t=null){this.log("WARN",e,s,t)}static info(e,s="",t=null){this.log("INFO",e,s,t)}static debug(e,s="",t=null){this.log("DEBUG",e,s,t)}};function Ke(o,e,s={}){if(!o||typeof o!="string")throw new Error("Step must be a non-empty string");const t=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let r=s.description;return r||(r=Xo(o,s)),{step:o,progress:t,details:{...s,description:r}}}function Xo(o,e){return o==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`Загрузка тикетов стадии "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:o==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`Фильтрация тикетов: ${e.filteredTickets} из ${e.totalTickets}...`:o==="grouping"&&e.employeeCount!==void 0?`Группировка тикетов по ${e.employeeCount} сотрудникам...`:e.count!==void 0&&e.total!==void 0?`Обработка: ${e.count} из ${e.total}...`:"Загрузка данных..."}function ds(o){if(!o||typeof o!="object")throw new Error("Progress info must be an object");const e=o.step||null;if(!e)throw new Error("Step is required in progress info");const s=o.progress!==void 0&&o.progress!==null?o.progress:o.percent!==void 0&&o.percent!==null?o.percent:void 0,t=o.details||{};return o.stage&&(t.stage=o.stage),o.stageName&&(t.stageName=o.stageName),o.stageIndex!==void 0&&(t.stageIndex=o.stageIndex),o.totalStages!==void 0&&(t.totalStages=o.totalStages),o.count!==void 0&&(t.count=o.count),o.total!==void 0&&(t.total=o.total),o.warning&&(t.warning=o.warning),{step:e,progress:s!=null?Math.max(0,Math.min(100,s)):void 0,details:t}}function wa(o,e,s){const t=typeof o=="number"&&!isNaN(o)?Math.max(0,Math.min(100,o)):0,r=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,i=typeof s=="number"&&!isNaN(s)?Math.max(0,Math.min(100,s)):0,n=t+r*i/100;return Math.max(0,Math.min(100,n))}const Nt={allowedDepartmentIds:[369,366,7],adminDepartmentIds:[369]};function Ca(o){return!o||typeof o!="number"?!1:Nt.allowedDepartmentIds.includes(o)}function es(o){if(!o||!o.UF_DEPARTMENT)return!1;const e=Array.isArray(o.UF_DEPARTMENT)?o.UF_DEPARTMENT:[];return e.length===0?!1:e.some(s=>Nt.adminDepartmentIds.includes(s))}class Jo{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,s,t,r=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const i=this.metrics.ticketsLoading.stages[e];i.loaded=t,i.batches.push({count:s,total:t,next:r}),i.total=t,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((n,l)=>n+l.total,0)}logFiltering(e,s,t=[],r=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=s,this.metrics.filtering.rejected=t.slice(0,50),this.metrics.filtering.tagValueExamples=r.slice(0,20)}logEmployees(e,s=[],t=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=s.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=t.slice(0,50)}logGrouping(e,s=[],t=[]){e.forEach(r=>{const i={};let n=0;r.employees.forEach(l=>{const u=(l.ticketsInsideSector||[]).length+(l.ticketsOutsideSector||[]).length;i[l.id]=u,n+=u}),this.metrics.grouping.distributionByStages[r.id]={employees:i,total:n}}),this.metrics.grouping.ticketsNotInColumn=s.slice(0,50),this.metrics.grouping.unknownStages=t.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(s=>{this.metrics.zeroPoint.byStage[s]=Array.isArray(e[s])?e[s].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let Ss=null;function tt(){return Ss||(Ss=new Jo),Ss}function ut(o=null,e=null){if(e&&!es(e))return!1;if(o&&o.query&&o.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const s=window.location.hash;if(s){const r=s.split("?");if(r.length>1){const i=r[1];if(new URLSearchParams(i).get("diagnostics")==="true")return!0}if(s.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}const ss=140;class xt{static async getAllTickets(e,s=null,t=!0){const r=[],i=e.length;try{for(let n=0;n<e.length;n++){const l=e[n],u=this.getStageName(l);if(s){const m=n/i*100;s(Ke("loading_tickets",m,{stage:l,stageName:u,stageIndex:n+1,totalStages:i}))}try{const m=await this.getTicketsByStage(l,t,s?v=>{const T=wa(n/i*100,1/i*100,v.percent||0);s(Ke("loading_tickets",T,{stage:l,stageName:u,stageIndex:n+1,totalStages:i,count:v.count,total:v.total}))}:null);r.push(...m)}catch(m){Re.error(`Error loading tickets for stage ${l}`,"TicketRepository",m);let v=`Ошибка загрузки стадии "${u}"`;throw m.message&&(m.message.includes("HTTP error")||m.message.includes("network")?v=`Ошибка соединения при загрузке стадии "${u}". Проверьте подключение к интернету.`:m.message.includes("timeout")?v=`Превышено время ожидания при загрузке стадии "${u}". Попробуйте позже.`:m.message.includes("403")||m.message.includes("401")?v=`Ошибка доступа при загрузке стадии "${u}". Проверьте права доступа.`:v=`Ошибка загрузки стадии "${u}": ${m.message}`),new Error(v)}}}catch(n){throw Re.error("Error in getAllTickets","TicketRepository",n),n}return r}static getStageName(e){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[e]||e}static async getTicketsByStage(e,s=!0,t=null){if(s){const v=Be.getTicketsCacheKey(e),T=Be.get(v);if(T!==null){try{const f=tt();f&&ut()&&f.logTicketsLoading(e,T.length,T.length,null)}catch(f){Re.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",f)}return t&&t(ds({step:"loading_tickets",percent:100,count:T.length,total:T.length})),T}}const r=[];let i=0;const n=50;let l=!0,u=0,m=null;for(;l;)try{const v=await Mt.call("crm.item.list",{entityTypeId:ss,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:i,useOriginalUfNames:"Y"});let T=[];if(v&&v.result&&(Array.isArray(v.result)?T=v.result:v.result.items&&Array.isArray(v.result.items)?T=v.result.items:v.result.data&&Array.isArray(v.result.data)&&(T=v.result.data)),T.length>0){r.push(...T),i+=T.length;const f=v?.result?.next??v?.next,k=f!=null&&f!==""&&String(f)!=="0";l=T.length===n&&k,ut()&&Re.debug(`[Pagination] Stage: ${e}, Batch: ${T.length}, Total: ${r.length}, Start: ${i}, NextValue: ${f}, HasNext: ${k}, HasMore: ${l}`,"TicketRepository");try{const p=tt();p&&ut()&&(Re.debug(`[Pagination Debug] Stage: ${e}, Batch: ${T.length}, Total: ${r.length}`,"TicketRepository",{resultStructure:{hasResult:!!v?.result,resultIsArray:Array.isArray(v?.result),hasItems:!!v?.result?.items,hasData:!!v?.result?.data,hasNext:!!f,nextValue:f,nextType:typeof f,resultKeys:v?.result?Object.keys(v.result):[]}}),p.logTicketsLoading(e,T.length,r.length,f||null))}catch(p){Re.warn("Diagnostics logging error","TicketRepository",p)}if(l?u=i+n:u=r.length,t){const p=u>0?Math.min(100,r.length/u*100):0;t(ds({step:"loading_tickets",percent:p,count:r.length,total:u}))}m=null}else l=!1}catch(v){if(Re.error(`Error loading tickets batch for stage ${e} (start: ${i})`,"TicketRepository",v),i===0)throw m=v,new Error(`Не удалось загрузить тикеты для стадии ${e}: ${v.message||v}`);l=!1,t&&r.length>0&&t(Ke("loading_tickets",100,{count:r.length,total:r.length,warning:`Загружено частично: ${r.length} тикетов. Ошибка при загрузке остальных.`}))}if(m&&r.length===0)throw m;if(s){const v=Be.getTicketsCacheKey(e);Be.set(v,r,Be.TICKETS_TTL)}return r}static async getTicket(e){return(await Mt.call("crm.item.get",{entityTypeId:ss,id:e})).result||null}static async updateTicket(e,s){const r=(await Mt.call("crm.item.update",{entityTypeId:ss,id:e,fields:s})).result===!0;return r&&Be.invalidateTicketsCache(),r}static async createTicket(e){const s=await Mt.call("crm.item.add",{entityTypeId:ss,fields:e}),t=s.result?parseInt(s.result):0;return t>0&&Be.invalidateTicketsCache(),t}static async assignTicket(e,s,t){return await this.updateTicket(e,{assignedById:s,stageId:t})}}class Zo{static async getEmployeesByIds(e,s=!0){if(!Array.isArray(e)||e.length===0)return[];if(s){const t=Be.getEmployeesCacheKey(e),r=Be.get(t);if(r!==null)return Re.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),r}try{const t=await Mt.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let r=[];if(t&&t.result&&(Array.isArray(t.result)?r=t.result:Re.warn("Unexpected user.get result format","EmployeeRepository",t)),s){const i=Be.getEmployeesCacheKey(e);Be.set(i,r,Be.EMPLOYEES_TTL)}return r}catch(t){return Re.error("Error getting employees by IDs","EmployeeRepository",t),[]}}}const Kt=new Map;function Ta(){Kt.clear()}function Qo(o){if(!o)return[];if(Array.isArray(o))return o.filter(s=>typeof s=="number"||!isNaN(parseInt(s))).map(s=>typeof s=="number"?s:parseInt(s));if(typeof o=="number")return[o];const e=parseInt(o);return isNaN(e)?[]:[e]}function en(o,e=!0){const s=o.id||o.ID;if(!o||!s)return null;if(e&&Kt.has(s))return Kt.get(s);const t=o.UF_DEPARTMENT||o.departmentId,r=Qo(t);for(const i of r)if(ho(i)){const l=i;return e&&Kt.set(s,l),l}return e&&Kt.set(s,null),null}function tn(o){const e=en(o);return{id:parseInt(o.ID||o.id||0),name:`${o.NAME||o.name||""} ${o.LAST_NAME||o.lastName||""}`.trim()||o.EMAIL||o.email||"Неизвестный",position:o.WORK_POSITION||o.workPosition||"Сотрудник",email:o.EMAIL||o.email||"",sectorId:e,departmentId:o.UF_DEPARTMENT||null,tickets:[]}}function sn(o){return Array.isArray(o)?o.map(e=>tn(e)):[]}const an="1C",on=["1С"],Xt=new Map,sa=100;function Sa(o){return o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||o.ufCrm7TypeProduct||o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||null}function Ds(o){return o==null?null:String(o).trim().toUpperCase().replace(/С/g,"C")||null}function Da(o){if(!o)return[];if(Array.isArray(o))return o.map(Ds).filter(Boolean);if(typeof o=="object"&&o.value!==void 0){const s=Ds(o.value);return s?[s]:[]}const e=Ds(o);return e?e.split(/[;,]/).map(s=>s.trim()).filter(Boolean):[]}function aa(o){const e=Sa(o),s=Da(e);return s.length===0?!1:s.some(t=>t===an||on.includes(t))}function nn(o){return`filter:${o.map(s=>s.id||s.ID||"").sort().join(",")}`}function rn(){Xt.size>sa&&Array.from(Xt.keys()).slice(0,Math.floor(sa*.2)).forEach(e=>Xt.delete(e))}function ln(o){if(!Array.isArray(o))return[];const e=nn(o),s=Xt.get(e);if(s!==void 0)return s;const t=o.filter(aa);try{const r=tt();if(r&&ut()){const i=o.filter(u=>!aa(u)),n=[],l=new Set;o.forEach(u=>{const m=Sa(u),v=Da(m),T=m==null?"":String(m);m!=null&&!l.has(T)&&(l.add(T),n.push({value:m,normalized:v,type:typeof m,isArray:Array.isArray(m),ticketId:u.id||u.ID}))}),r.logFiltering(o.length,t.length,i,n)}}catch(r){console.warn("Diagnostics logging error in filterBySector:",r)}return Xt.set(e,t),rn(),t}const Zt=1051;function us(o){if(!o||typeof o!="object")return null;let e=o.assignedById||o.ASSIGNED_BY_ID||o.assignedByIdId||o.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function Os(o){if(o==null)return null;typeof o=="object"&&(o=o.id||o.ID||o.value||null);const e=typeof o=="number"?o:parseInt(o);return isNaN(e)||e<=0?null:e}function cn(o,e=Zt){const s=us(o),t=Os(s);return t===null||t===e}function dn(o,e){Array.isArray(o)||(Re.warn("Tickets is not an array","TicketGrouper",o),o=[]),Array.isArray(e)||(Re.warn("Employees is not an array","TicketGrouper",e),e=[]);const s=e.filter(u=>(u.id?parseInt(u.id):null)!==Zt),t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:s.map(u=>({...u,isFromSector1C:u.sectorId===qt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:s.map(u=>({...u,isFromSector1C:u.sectorId===qt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:s.map(u=>({...u,isFromSector1C:u.sectorId===qt.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],r=new Map(t.map(u=>[u.id,u])),i=new Map;t.forEach(u=>{const m=new Map(u.employees.map(v=>[v.id,v]));i.set(u.id,m)});const n=[],l=[];o.forEach(u=>{const m=Yt(u.stageId||u.STAGE_ID||""),v=r.get(m);if(!v){l.push({id:u.id||u.ID,title:u.title||u.TITLE||"Без названия",stageId:u.stageId||u.STAGE_ID,assignedById:us(u)});return}const T=us(u),f=Os(T);if(f!==Zt)if(f){const k=i.get(m);let p=k.get(f);p||(p={id:f,name:`Сотрудник #${f}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},v.employees.push(p),k.set(f,p));const S=Ls(u),C={...S,stageId:u.stageId||u.STAGE_ID||S.stageId||null,departmentHead:S.departmentHead||null,departmentHeadFull:S.departmentHeadFull||S.departmentHead||null};p.tickets.push(C),p.isFromSector1C?p.ticketsInsideSector.push(C):p.ticketsOutsideSector.push(C)}else n.push({id:u.id||u.ID,title:u.title||u.TITLE||"Без названия",stageId:m,assignedById:T})}),t.forEach(u=>{u.employees.sort((m,v)=>m.isFromSector1C&&!v.isFromSector1C?-1:!m.isFromSector1C&&v.isFromSector1C?1:(m.id||0)-(v.id||0))});try{const u=tt();if(u&&ut()){const m={};t.forEach(T=>{let f=0,k=0;T.employees.forEach(p=>{f+=(p.ticketsInsideSector||[]).length,k+=(p.ticketsOutsideSector||[]).length}),m[T.id]={insideSector:f,outsideSector:k,total:f+k}});const v=u.metrics.grouping;Object.keys(m).forEach(T=>{v.distributionByStages[T]||(v.distributionByStages[T]={employees:{},total:0}),v.distributionByStages[T].insideSector=m[T].insideSector,v.distributionByStages[T].outsideSector=m[T].outsideSector,v.distributionByStages[T].total=m[T].total}),u.logGrouping(t,n,l)}}catch(u){Re.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",u)}return t}function un(o){const e={formed:[],review:[],execution:[]};if(!Array.isArray(o))return Re.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",o),e;o.filter(s=>cn(s)).forEach(s=>{const t=Yt(s.stageId||s.STAGE_ID||"");if(e[t]){const r=Ls(s),i={...r,stageId:s.stageId||s.STAGE_ID||r.stageId||null,departmentHead:r.departmentHead||null,departmentHeadFull:r.departmentHeadFull||r.departmentHead||null};e[t].push(i)}});try{const s=tt();s&&ut()&&s.logZeroPoint(e)}catch(s){Re.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",s)}return e}function mn(o){if(!Array.isArray(o))return[];const e=new Set,s=[],t=[];o.forEach(i=>{const n=us(i),l=Os(n);!n||n===null||n===void 0?s.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}):l===Zt&&t.push({id:i.id||i.ID,title:i.title||i.TITLE||"Без названия",stageId:i.stageId||i.STAGE_ID}),l&&e.add(l)});const r=Array.from(e);try{const i=tt();i&&ut()&&i.logEmployees(r,s,t)}catch(i){Re.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",i)}return r}const as=new Map,gn=10*60*1e3;function hn(o){if(!o||typeof o!="object")return{};const e={},s=Object.keys(o);for(const t of s)t.toUpperCase().startsWith("UF_")&&(e[t]=o[t]);return e}function fn(o,e=null,s=!0){if(s&&e&&as.has(e)){const i=as.get(e),n=Date.now();if(i.timestamp&&n-i.timestamp<gn)return i.data;as.delete(e)}const t=hn(o),r={typeProduct:t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||null,all:t};return s&&e&&as.set(e,{data:r,timestamp:Date.now()}),r}class vn{static async getTicketDetails(e,s={}){const{select:t=["*"],useOriginalUfNames:r=!0,useCache:i=!0}=s;try{const n=await xt.getTicket(e);if(!n)throw new Error(`Тикет с ID ${e} не найден`);const l=fn(n,e,i),u=n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.ufCrm7UfPriority||n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.priority||n.PRIORITY||null,m=xs(u),v=ba(m);return{id:n.id||n.ID,title:n.title||n.TITLE,stageId:n.stageId||n.STAGE_ID,assignedById:n.assignedById||n.ASSIGNED_BY_ID,createdAt:n.createdTime||n.CREATED_TIME||n.CREATED_DATE,updatedAt:n.updatedTime||n.UPDATED_TIME||n.MODIFY_DATE,priorityId:m.id,priorityLabel:m.label,priorityColors:v,priority:m.id,priorityBitrixValue:m.bitrixValue||null,opportunity:n.opportunity||n.OPPORTUNITY,currencyId:n.currencyId||n.CURRENCY_ID,comments:n.comments||n.COMMENTS,additionalFields:l,rawData:n}}catch(n){throw Re.error("Error getting ticket details","TicketDetailsService",n),n}}}let Bt=class{static async getSectorData(e=!0,s=!1,t=null){let r=!1;try{if(ut()){const i=tt();i&&i.reset()}}catch(i){Re.warn("Error resetting diagnostics","DashboardSector1CService",i)}if(t&&t(Ke("cache_check",0,{description:"Инициализация загрузки..."})),e){const i=Be.getSectorDataCacheKey(),n=Be.get(i);if(n!==null)return t&&t(Ke("cache_hit",100,{description:"Данные загружены из in-memory кеша"})),n}try{t&&t(Ke("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const i=fo(),n=await xt.getAllTickets(i,k=>{if(t){const p=ds(k),S=wa(10,40,p.progress||0);t(Ke(p.step||"loading_tickets",S,{...p.details,warning:p.details.warning}))}},e);t&&t(Ke("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const l=ln(n);t&&t(Ke("filtering",50,{totalTickets:n.length,filteredTickets:l.length,description:`Отфильтровано ${l.length} тикетов из ${n.length}`})),t&&t(Ke("extracting_employees",60,{filteredTickets:l.length,description:`Анализ ${l.length} тикетов для определения сотрудников...`}));const u=mn(l);t&&t(Ke("extracting_employees",60,{employeeCount:u.length,description:`Найдено ${u.length} уникальных сотрудников`})),t&&t(Ke("loading_employees",65,{employeeCount:u.length,description:`Загрузка данных ${u.length} сотрудников...`})),Ta();const m=await Zo.getEmployeesByIds(u),v=sn(m);t&&t(Ke("loading_employees",90,{employeeCount:v.length,description:`Загружено данных ${v.length} сотрудников`})),t&&t(Ke("grouping",90,{filteredTickets:l.length,employeeCount:v.length,description:`Группировка ${l.length} тикетов по этапам и ${v.length} сотрудникам...`}));const f={stages:dn(l,v),employees:v,zeroPointTickets:un(l)};if(t&&t(Ke("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),e){const k=Be.getSectorDataCacheKey();Be.set(k,f,Be.TICKETS_TTL),r=!0}return t&&t(Ke("complete",100,{description:"Загрузка завершена"})),r&&!s&&CacheNotificationService.notifyCacheCreationSuccess("Дашборд сектора 1С"),f}catch(i){throw Re.error("Error getting sector data","DashboardSector1CService",i),t&&t({step:"error",progress:0,error:i.message}),i}}static async assignTicket(e,s,t){try{const r=Js(t),i=await xt.assignTicket(e,s,r);return i&&Be.invalidateTicketsCache(),i}catch(r){throw Re.error("Error assigning ticket","DashboardSector1CService",r),r}}static async createTicket(e){try{const s=Js(e.stageId||"formed"),t={title:e.title,stageId:s};e.employeeId&&(t.assignedById=e.employeeId);const r=await xt.createTicket(t);return r>0&&Be.invalidateTicketsCache(),r}catch(s){throw Re.error("Error creating ticket","DashboardSector1CService",s),s}}static async getTicket(e){try{const s=await xt.getTicket(e);return Ls(s)}catch(s){throw Re.error("Error getting ticket","DashboardSector1CService",s),s}}static async getTicketDetails(e,s={}){try{return await vn.getTicketDetails(e,s)}catch(t){throw Re.error("Error getting ticket details","DashboardSector1CService",t),t}}static async addComment(e,s){try{return(await Mt.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+vo,comment:s}})).result!==void 0}catch(t){throw Re.error("Error adding comment","DashboardSector1CService",t),t}}};const pn=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:Bt},Symbol.toStringTag,{value:"Module"}));class Bs{static normalizeSectorData(e,s){return e?{stages:this.normalizeStages(e.stages||[],s),employees:this.normalizeEmployees(e.employees||[],s),zeroPointTickets:this.normalizeTickets(e.zeroPointTickets||[],s),metrics:this.calculateMetrics(e,s),metadata:this.createMetadata(e,s)}:this.getEmptySectorData(s)}static normalizeStages(e,s){return Array.isArray(e)?e.map((t,r)=>{const i=s.stages?.[t.id]||{},n=r%this.STAGE_COLORS.length;return{id:t.id||`stage_${r}`,name:i.name||t.name||t.title||`Этап ${r+1}`,color:i.color||t.color||this.STAGE_COLORS[n],order:i.order||t.order||r,tickets:this.normalizeTickets(t.tickets||[],s),employees:this.normalizeEmployees(t.employees||[],s),metrics:this.calculateStageMetrics(t,s)}}).sort((t,r)=>(t.order||0)-(r.order||0)):[]}static normalizeEmployees(e,s){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`emp_${Math.random()}`,name:this.normalizeEmployeeName(t),department:t.department||t.UF_DEPARTMENT||s.defaultDepartment||"Unknown",load:t.load||t.currentLoad||0,avatar:t.avatar||t.PERSONAL_PHOTO||null,status:t.status||t.ACTIVE||"active",color:this.assignEmployeeColor(t,s)})):[]}static normalizeTickets(e,s){return Array.isArray(e)?e.map(t=>({id:t.id||t.ID||`ticket_${Math.random()}`,title:this.normalizeTicketTitle(t),status:t.status||t.STATUS_ID||"new",priority:this.normalizePriority(t),assignedTo:t.assignedTo||t.ASSIGNED_BY_ID||t.assigned_to,createdAt:this.normalizeDate(t.createdAt||t.CREATED_DATE||t.DATE_CREATE),updatedAt:this.normalizeDate(t.updatedAt||t.UPDATED_DATE||t.TIMESTAMP_X),deadline:this.normalizeDate(t.deadline||t.DEADLINE),tags:this.extractTags(t,s),description:t.description||t.DETAIL_TEXT||t.COMMENTS||""})):[]}static normalizeEmployeeName(e){if(!e)return"Неизвестный сотрудник";const s=e.LAST_NAME||e.lastName||"",t=e.NAME||e.firstName||e.FIRST_NAME||"",r=`${s} ${t}`.trim();return r&&r!==" "?r:t||(e.LOGIN||e.login?e.LOGIN||e.login:`Сотрудник #${e.id||e.ID||"unknown"}`)}static normalizeTicketTitle(e){return e.title||e.TITLE||e.name||e.NAME||e.subject||e.SUBJECT||`Тикет ${e.id||e.ID||"без названия"}`}static normalizePriority(e){const s=e.priority||e.PRIORITY;return typeof s=="number"?Math.max(1,Math.min(5,s)):typeof s=="string"&&{low:1,lowest:1,normal:3,medium:3,high:4,highest:5,urgent:5,critical:5}[s.toLowerCase()]||3}static normalizeDate(e){if(!e)return null;try{const s=new Date(e);return isNaN(s.getTime())?null:s.toISOString()}catch{return null}}static extractTags(e,s){const t=[];return e.UF_CRM_7_TYPE_PRODUCT&&t.push(e.UF_CRM_7_TYPE_PRODUCT),(e.category||e.CATEGORY)&&t.push(e.category||e.CATEGORY),(e.type||e.TYPE)&&t.push(e.type||e.TYPE),e.priority&&typeof e.priority=="string"&&t.push(`priority:${e.priority}`),[...new Set(t)]}static assignEmployeeColor(e,s){const t=["#007bff","#28a745","#ffc107","#dc3545","#6c757d","#17a2b8"];if(e.department){const i=e.department.split("").reduce((n,l)=>(n=(n<<5)-n+l.charCodeAt(0),n&n),0);return t[Math.abs(i)%t.length]}const r=e.id||e.ID||0;return t[Math.abs(r)%t.length]}static calculateStageMetrics(e,s){const t=e.tickets||[],r=e.employees||[];return{ticketCount:t.length,employeeCount:r.length,averageLoad:r.length>0?t.length/r.length:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateMetrics(e,s){const t=[...e.zeroPointTickets||[],...(e.stages||[]).flatMap(l=>l.tickets||[])],r=t.length,i=e.employees?.length||0,n=(e.stages||[]).filter(l=>(l.tickets||[]).length>0).length;return{totalTickets:r,totalEmployees:i,activeStages:n,averageTicketsPerEmployee:i>0?r/i:0,completionRate:this.calculateCompletionRate(t),overdueCount:this.countOverdueTickets(t)}}static calculateCompletionRate(e){if(!e.length)return 0;const s=e.filter(t=>t.status==="closed"||t.status==="completed"||t.status==="done").length;return Math.round(s/e.length*100)}static countOverdueTickets(e){const s=new Date;return e.filter(t=>t.deadline?new Date(t.deadline)<s&&t.status!=="closed"&&t.status!=="completed":!1).length}static createMetadata(e,s){return{sectorId:s.id,sectorName:s.name,lastUpdated:new Date().toISOString(),dataVersion:"2.0",source:"universal-normalizer"}}static getEmptySectorData(e){return{stages:[],employees:[],zeroPointTickets:[],metrics:{totalTickets:0,totalEmployees:0,activeStages:0,averageTicketsPerEmployee:0,completionRate:0,overdueCount:0},metadata:this.createMetadata({},e)}}}je(Bs,"STAGE_COLORS",["#007bff","#ffc107","#28a745","#dc3545","#6c757d","#17a2b8","#e83e8c","#fd7e14"]);class Rs{constructor(e,s){this.sectorId=e,this.sectorConfig=s}async getSectorData(e={}){return Bs.getEmptySectorData({id:this.sectorId,name:this.sectorConfig.name||this.sectorId,defaultDepartment:"Unknown"})}async updateTicketAssignment(e,s,t){return console.log(`[Stub:${this.sectorId}] updateTicketAssignment called:`,{ticketId:e,stageId:s,employeeId:t}),{success:!0,message:"Stub implementation - no real action taken"}}async createTicket(e){return console.log(`[Stub:${this.sectorId}] createTicket called:`,e),{id:`stub_${Date.now()}`,title:e.title||"Stub ticket",status:"new",createdAt:new Date().toISOString()}}}class yn extends Rs{constructor(){super("pdm",{id:"pdm",name:"Сектор PDM",filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:"PDM",stages:{design:{name:"Проектирование",color:"#17a2b8",order:1},review:{name:"Проверка",color:"#ffc107",order:2},implementation:{name:"Внедрение",color:"#28a745",order:3}}})}async getSectorData(e={}){console.log("[SectorPDMService] getSectorData called with options:",e);const s={stages:[{id:"design",name:"Проектирование",color:"#17a2b8",tickets:[{id:"pdm-1",title:"Проектирование модуля отчетов",status:"in_progress",assignedTo:"user1"},{id:"pdm-2",title:"Анализ требований",status:"completed",assignedTo:"user2"}],employees:[{id:"user1",name:"Иван Иванов",department:"PDM"},{id:"user2",name:"Мария Петрова",department:"PDM"}]},{id:"review",name:"Проверка",color:"#ffc107",tickets:[{id:"pdm-3",title:"Проверка кода",status:"in_progress",assignedTo:"user3"}],employees:[{id:"user3",name:"Алексей Сидоров",department:"PDM"}]},{id:"implementation",name:"Внедрение",color:"#28a745",tickets:[],employees:[]}],employees:[{id:"user1",name:"Иван Иванов",department:"PDM"},{id:"user2",name:"Мария Петрова",department:"PDM"},{id:"user3",name:"Алексей Сидоров",department:"PDM"}],zeroPointTickets:[],metadata:{sectorId:"pdm",lastUpdated:new Date().toISOString()}};return console.log("[SectorPDMService] Returning test data:",{stages:s.stages?.length||0,employees:s.employees?.length||0,totalTickets:s.stages?.reduce((t,r)=>t+(r.tickets?.length||0),0)||0}),s}}class kn extends Rs{constructor(){super("bitrix24",{id:"bitrix24",name:"Сектор Битрикс24",filterField:"UF_CRM_7_TYPE_PRODUCT",filterValue:"Bitrix24",stages:{analysis:{name:"Анализ",color:"#007bff",order:1},development:{name:"Разработка",color:"#ffc107",order:2},testing:{name:"Тестирование",color:"#28a745",order:3},deployment:{name:"Внедрение",color:"#6c757d",order:4}}})}}class bn extends Rs{constructor(){super("infrastructure",{id:"infrastructure",name:"Сектор Инфраструктура",filterField:"UF_CRM_7_TYPE_PRODUCT",filterValues:["Железо","Прочее"],stages:{request:{name:"Заявка",color:"#6c757d",order:1},assessment:{name:"Оценка",color:"#ffc107",order:2},procurement:{name:"Закупка",color:"#17a2b8",order:3},deployment:{name:"Внедрение",color:"#28a745",order:4}}})}}class _n{static create(e){const t={pdm:()=>new yn,bitrix24:()=>new kn,infrastructure:()=>new bn}[e];if(!t)throw new Error(`No stub service available for sector: ${e}`);return t()}static isStubAvailable(e){return["pdm","bitrix24","infrastructure"].includes(e)}}class Ea{static create(e){if(this.serviceCache.has(e))return this.serviceCache.get(e);const s=this.createServiceInstance(e);return this.serviceCache.set(e,s),s}static createServiceInstance(e){switch(e){case"1c":console.log("[SectorServiceFactory] Creating Sector1CAdapter for sector 1c");const{DashboardSector1CService:s}=require("@/services/dashboard-sector-1c/index.js");return new s;case"pdm":case"bitrix24":case"infrastructure":return console.log(`[SectorServiceFactory] Creating stub service for sector ${e}`),_n.create(e);default:throw new Error(`Unknown sector: ${e}`)}}static isServiceAvailable(e){return["1c","pdm","bitrix24","infrastructure"].includes(e)}static clearCache(){this.serviceCache.clear(),console.log("[SectorServiceFactory] Service cache cleared")}static getAvailableServices(){return{"1c":{type:"full",description:"Полнофункциональный сервис сектора 1С"},pdm:{type:"stub",description:"Заглушка сервиса сектора PDM"},bitrix24:{type:"stub",description:"Заглушка сервиса сектора Битрикс24"},infrastructure:{type:"stub",description:"Заглушка сервиса сектора Инфраструктура"}}}}je(Ea,"serviceCache",new Map);class wn{constructor(e){this.sectorId=e,this.cache=new Map;try{this.sectorService=Ea.create(e),console.log(`[UniversalSectorDashboardService] Initialized for sector: ${this.sectorId}`)}catch(s){throw console.error(`[UniversalSectorDashboardService] Failed to initialize for sector ${this.sectorId}:`,s),s}}async getSectorDashboardData(e={}){const s=`dashboard:${this.sectorId}:${JSON.stringify(e)}`;if(!e.forceRefresh&&this.cache.has(s))return console.log(`[UniversalSectorDashboardService] Cache hit for dashboard data: ${this.sectorId}`),this.cache.get(s);try{console.log(`[UniversalSectorDashboardService] Loading dashboard data for sector: ${this.sectorId}`);let t;if(this.sectorId==="1c"){const{DashboardSector1CService:i}=await De(async()=>{const{DashboardSector1CService:n}=await Promise.resolve().then(()=>pn);return{DashboardSector1CService:n}},void 0,import.meta.url);t=await i.getSectorData(!e.forceRefresh,!1,null)}else t=await this.sectorService.getSectorData(e);const r=this.normalizeSectorDataToDashboard(t);return this.cache.set(s,r),setTimeout(()=>{this.cache.delete(s)},5*60*1e3),console.log(`[UniversalSectorDashboardService] Returning dashboard data for ${this.sectorId}:`,{stages:r.stages?.length||0,employees:r.employees?.length||0,totalTickets:r.metadata?.totalTickets||0}),r}catch(t){throw console.error(`[UniversalSectorDashboardService] Failed to get dashboard data for ${this.sectorId}:`,t),t}}normalizeSectorDataToDashboard(e){const s=Bs.normalizeSectorData(e,{id:this.sectorId});return{stages:this.convertStagesToDashboardFormat(s.stages),employees:s.employees,zeroPointTickets:this.extractZeroPointTickets(s),metadata:{sectorId:this.sectorId,totalTickets:s.metrics?.totalTickets||0,totalEmployees:s.employees?.length||0,lastUpdated:new Date().toISOString()}}}convertStagesToDashboardFormat(e){return e.map(s=>({id:this.mapStageIdToDashboardId(s.id),name:s.name,color:s.color||"#666",employees:s.employees||[],tickets:s.tickets||[],metrics:{ticketCount:s.tickets?.length||0,employeeCount:s.employees?.length||0}}))}mapStageIdToDashboardId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution",formed:"formed",review:"review",execution:"execution",request:"formed",assessment:"review",deployment:"execution"}[e]||e}extractZeroPointTickets(e){const s={};return e.stages.forEach(t=>{const r=this.mapStageIdToDashboardId(t.id),i=t.tickets.filter(n=>!n.assignedTo||n.assignedTo===null||n.assignedTo==="");s[r]=i}),s}async updateTicketAssignment(e,s,t){try{const r=this.mapDashboardIdToStageId(s),i=await this.sectorService.updateTicketAssignment(e,r,t);return this.clearCache(),i}catch(r){throw console.error("[UniversalSectorDashboardService] Failed to update ticket assignment:",r),r}}mapDashboardIdToStageId(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||e}clearCache(){this.cache.clear(),console.log(`[UniversalSectorDashboardService] Cache cleared for sector: ${this.sectorId}`)}async createTicket(e){try{const s=await this.sectorService.createTicket({...e,sectorId:this.sectorId});return this.clearCache(),s}catch(s){throw console.error("[UniversalSectorDashboardService] Failed to create ticket:",s),s}}async getSectorStats(){try{const e=await this.getSectorDashboardData();return{totalTickets:e.metadata.totalTickets,totalEmployees:e.metadata.totalEmployees,stagesCount:e.stages.length,unassignedTickets:Object.values(e.zeroPointTickets).reduce((s,t)=>s+t.length,0),lastUpdated:e.metadata.lastUpdated}}catch(e){throw console.error("[UniversalSectorDashboardService] Failed to get sector stats:",e),e}}}class Aa{static getService(e){return this.services.has(e)||this.services.set(e,new wn(e)),this.services.get(e)}static clearAll(){this.services.clear()}}je(Aa,"services",new Map);const zt=I([]);let Cn=0;function lt(){const o=(l,u="info",m=3e3)=>{const v=++Cn,T={id:v,message:l,type:u,duration:m,timestamp:Date.now()};return zt.value.push(T),m>0&&setTimeout(()=>{e(v)},m),v},e=l=>{const u=zt.value.findIndex(m=>m.id===l);u>-1&&zt.value.splice(u,1)};return{notifications:zt,showNotification:o,removeNotification:e,clearNotifications:()=>{zt.value=[]},success:(l,u=3e3)=>o(l,"success",u),error:(l,u=5e3)=>o(l,"error",u),warning:(l,u=4e3)=>o(l,"warning",u),info:(l,u=3e3)=>o(l,"info",u)}}function $a(){const o=I(null),e=I(0),s=I(null),t=I(null),r=I({}),i=(f,k={})=>{o.value=f,r.value=k},n=f=>{const k=typeof f=="number"&&!isNaN(f)?f:0;e.value=Math.min(100,Math.max(0,k))},l=f=>{s.value=f,t.value=null},u=f=>{t.value=f},m=()=>{t.value=null},v=()=>{o.value=null,e.value=0,s.value=null,t.value=null,r.value={}},T=M(()=>s.value||t.value);return{currentStep:o,progress:e,error:s,temporaryError:t,displayError:T,stepDetails:r,updateStep:i,updateProgress:n,setError:l,setTemporaryError:u,clearTemporaryError:m,reset:v}}function Tn(o,e){const s=lt();$a();let t=null;const r=()=>(t||(t=Aa.getService(e)),t),i=async(_={})=>{try{o.setLoading(!0,"Загрузка данных сектора..."),o.clearError();const W=await r().getSectorDashboardData(_);o.updateStages(W.stages),o.updateEmployees(W.employees),o.updateZeroPointTickets(W.zeroPointTickets),o.updateSectorStats({totalTickets:W.metadata.totalTickets,totalEmployees:W.metadata.totalEmployees,activeStages:W.stages.length,lastUpdated:W.metadata.lastUpdated}),s.success("Данные сектора загружены",`Загружено ${W.metadata.totalTickets} тикетов`)}catch(A){throw console.error(`[useUniversalDashboardActions] Failed to load sector data for ${e}:`,A),o.setError(A.message||"Ошибка загрузки данных сектора"),s.error("Ошибка загрузки",A.message||"Не удалось загрузить данные сектора"),A}finally{o.setLoading(!1)}},n=async(_,A,W=null)=>{try{await r().updateTicketAssignment(_,A,W),s.success("Тикет обновлен","Назначение тикета успешно изменено"),await i({forceRefresh:!0})}catch(x){throw console.error("[useUniversalDashboardActions] Failed to update ticket assignment:",x),s.error("Ошибка обновления",x.message||"Не удалось обновить назначение тикета"),x}},l=async _=>{try{const W=await r().createTicket(_);return s.success("Тикет создан",`Тикет "${W.title}" успешно создан`),await i({forceRefresh:!0}),W}catch(A){throw console.error("[useUniversalDashboardActions] Failed to create ticket:",A),s.error("Ошибка создания",A.message||"Не удалось создать тикет"),A}},u=async(_,A,W=null)=>{try{if(!S(_,A))throw new Error("Перемещение тикета невозможно");await n(_.id,A,W),s.success("Тикет перемещен",`Тикет перемещен на этап "${y(A)}"`)}catch(x){throw console.error("[useUniversalDashboardActions] Failed to move ticket:",x),s.error("Ошибка перемещения",x.message||"Не удалось переместить тикет"),x}},m=async(_,A)=>{try{const W=r(),x=C(_);if(!x)throw new Error("Тикет не найден");await W.updateTicketAssignment(_,x.stageId,A);const D=o.getEmployeeById(A),E=D?D.name:"сотруднику";s.success("Тикет назначен",`Тикет назначен ${E}`),await i({forceRefresh:!0})}catch(W){throw console.error("[useUniversalDashboardActions] Failed to assign ticket:",W),s.error("Ошибка назначения",W.message||"Не удалось назначить тикет"),W}},v=async()=>{try{r().clearCache(),s.success("Кеш очищен","Кеш сектора успешно очищен"),await i({forceRefresh:!0})}catch(_){throw console.error("[useUniversalDashboardActions] Failed to clear cache:",_),s.error("Ошибка очистки",_.message||"Не удалось очистить кеш"),_}},T=async()=>{try{return await r().getSectorStats()}catch(_){throw console.error("[useUniversalDashboardActions] Failed to get sector stats:",_),_}},f=()=>{De(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/state")}).catch(_=>{console.error("Failed to navigate to graph state:",_)})},k=()=>{De(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/graph/admission-closure")}).catch(_=>{console.error("Failed to navigate to admission closure:",_)})},p=()=>{De(async()=>{const{useRouter:_}=await import("./chunk-BxL3V5Fo.js").then(A=>A.a6);return{useRouter:_}},[],import.meta.url).then(({useRouter:_})=>{_().push("/tickets/time-tracking")}).catch(_=>{console.error("Failed to navigate to tickets management:",_)})},S=(_,A)=>!(!_||!A||_.stageId===A),C=_=>{for(const A of o.stages){const W=A.tickets?.find(x=>x.id===_);if(W)return{...W,stageId:A.id}}for(const[A,W]of Object.entries(o.zeroPointTickets)){const x=W.find(D=>D.id===_);if(x)return{...x,stageId:A}}return null},y=_=>{const A=o.getStageById(_);return A?A.name:_};return{loadSectorData:i,updateTicketAssignment:n,createTicket:l,moveTicket:u,assignTicketToEmployee:m,clearCache:v,getSectorStats:T,navigateToGraphState:f,navigateToAdmissionClosure:k,navigateToTicketsManagement:p,canMoveTicket:S,findTicket:C,getStageName:y}}const Sn={name:"SectorDashboard",components:{BackButton:_a},props:{sectorId:{type:String,required:!0,validator:o=>["1c","pdm","bitrix24","infrastructure"].includes(o)}},setup(o){try{console.log(`[SectorDashboard] 🎯 SETUP called for sector: ${o.sectorId}`);const e=Xe(),s=ps(),t=Yo(o.sectorId),r=Tn(t,o.sectorId),i=I(null),n=I(null),l=M(()=>({"1c":"1С",pdm:"PDM",bitrix24:"Битрикс24",infrastructure:"Инфраструктура"})[o.sectorId]||o.sectorId),u=M(()=>(i.value,!1)),m=()=>{e.push("/")},v=()=>{r.loadSectorData({forceRefresh:!0})},T=()=>{e.push({name:s.name,query:{...s.query,diagnostics:"true"}})},f=()=>{r.clearCache()},k=()=>{r.navigateToGraphState()},p=()=>{r.navigateToAdmissionClosure()},S=()=>{r.navigateToTicketsManagement()};return Ae(async()=>{console.log(`[SectorDashboard] 🚀 Mounted for sector: ${o.sectorId} (${l.value})`);try{console.log(`[SectorDashboard] 📡 Starting data load for sector: ${o.sectorId}`),await r.loadSectorData(),console.log(`[SectorDashboard] ✅ Data loaded successfully for sector: ${o.sectorId}`,{hasData:t.hasData,totalTickets:t.totalTickets,stagesCount:t.stages.length,employeesCount:t.employees.length,completionRate:t.completionRate,stages:t.stages.map(C=>({id:C.id,name:C.name,ticketsCount:C.tickets?.length||0})),renderingCondition:!t.isLoading&&!t.error,stagesLength:t.stages.length})}catch(C){console.error(`[SectorDashboard] ❌ Failed to load initial data for sector ${o.sectorId}:`,C),console.log("[SectorDashboard] 🔍 Error details:",{message:C.message,stack:C.stack})}}),{...t,...r,sectorName:l,currentUser:i,draggedTicket:n,isUserAdmin:u,handleGoHome:m,handleRetry:v,navigateToGraphState:k,navigateToAdmissionClosure:p,navigateToTicketsManagement:S,getZeroPointTickets:t.getZeroPointTickets}}catch(e){return console.error(`[SectorDashboard] 💥 CRITICAL ERROR in setup for sector ${o.sectorId}:`,e),console.error("[SectorDashboard] Error stack:",e.stack),console.error("[SectorDashboard] Error message:",e.message),{isLoading:!1,error:`Ошибка инициализации компонента: ${e.message}`,stages:[],employees:[],totalTickets:0,sectorName:o.sectorId,hasData:!1}}}},Dn={class:"dashboard-header"},En={class:"breadcrumbs-row"},An={class:"breadcrumb-current"},$n={class:"header-actions"},In={class:"sector-stats"},Mn={class:"stat-item"},Nn={class:"stat-value"},xn={class:"stat-item"},Pn={class:"stat-value"},Ln={class:"stat-item"},On={class:"stat-value"},Bn={class:"stat-item"},Rn={class:"stat-value"},Wn={key:0,class:"loading-container"},Un={key:0,class:"error-message"},Fn={key:0,class:"error-message-container"},Hn={class:"error-message"},jn={class:"error-header"},Vn={class:"error-text"},zn={class:"error-actions"},Gn={key:0,class:"dashboard-content"},Kn={style:{background:"#f0f0f0",padding:"10px","margin-bottom":"20px","font-size":"12px"}},qn={key:0,class:"stages-container"},Yn={class:"stage-header"},Xn={class:"stage-stats"},Jn={class:"stat"},Zn={class:"stat"},Qn={class:"stage-content"},er={key:0,class:"tickets-list"},tr={class:"ticket-id"},sr={class:"ticket-title"},ar={key:0,class:"more-tickets"},or={key:1,class:"no-tickets"},nr={key:1,class:"loading-message"},rr={key:2,class:"error-message"},ir={key:3,class:"empty-state"},lr={class:"empty-state-content"},cr={class:"sector-info"};function dr(o,e,s,t,r,i){const n=be("BackButton");return c(),d("div",{class:X(`dashboard-sector-${s.sectorId} ${o.draggedTicket?"is-dragging":""}`)},[a("div",Dn,[a("div",En,[a("button",{class:"btn-home-link",type:"button",onClick:e[0]||(e[0]=(...l)=>o.handleGoHome&&o.handleGoHome(...l)),title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),e[10]||(e[10]=a("span",{class:"breadcrumb-separator"},"/",-1)),a("span",An,"Дашборд сектора "+g(o.sectorName),1)]),ne(n,{variant:"header"}),a("h1",null,"Дашборд - Сектор "+g(o.sectorName),1),a("div",$n,[o.isDiagnosticsEnabled&&o.isUserAdmin?(c(),d("button",{key:0,onClick:e[1]||(e[1]=(...l)=>o.clearCache&&o.clearCache(...l)),class:"btn-clear-cache",title:"Сбросить кеш сектора и тикетов"},[...e[11]||(e[11]=[a("span",{class:"icon"},"♻️",-1),a("span",null,"Сбросить кеш",-1)])])):$("",!0),!o.isDiagnosticsEnabled&&o.isUserAdmin?(c(),d("button",{key:1,onClick:e[2]||(e[2]=(...l)=>o.enableDiagnostics&&o.enableDiagnostics(...l)),class:"btn-enable-diagnostics",title:"Включить диагностический режим"},[...e[12]||(e[12]=[a("span",{class:"icon"},"🔍",-1),a("span",null,"Диагностика",-1)])])):$("",!0),a("button",{onClick:e[3]||(e[3]=(...l)=>o.navigateToGraphState&&o.navigateToGraphState(...l)),class:"btn-navigate-graph-state",title:"Перейти к графику состояния сектора"},[...e[13]||(e[13]=[a("span",{class:"icon"},"📊",-1),a("span",null,"График состояния",-1)])]),a("button",{onClick:e[4]||(e[4]=(...l)=>o.navigateToAdmissionClosure&&o.navigateToAdmissionClosure(...l)),class:"btn-navigate-admission-closure",title:"Перейти к графику приемки-закрытия"},[...e[14]||(e[14]=[a("span",{class:"icon"},"📈",-1),a("span",null,"Приемка-закрытие",-1)])]),a("button",{onClick:e[5]||(e[5]=(...l)=>o.navigateToTicketsManagement&&o.navigateToTicketsManagement(...l)),class:"btn-navigate-tickets",title:"Перейти к управлению тикетами"},[...e[15]||(e[15]=[a("span",{class:"icon"},"📋",-1),a("span",null,"Управление тикетами",-1)])])])]),a("div",In,[a("div",Mn,[a("div",Nn,g(o.totalTickets),1),e[16]||(e[16]=a("div",{class:"stat-label"},"Всего тикетов",-1))]),a("div",xn,[a("div",Pn,g(o.employees.length),1),e[17]||(e[17]=a("div",{class:"stat-label"},"Сотрудников",-1))]),a("div",Ln,[a("div",On,g(o.completionRate)+"%",1),e[18]||(e[18]=a("div",{class:"stat-label"},"Завершено",-1))]),a("div",Bn,[a("div",Rn,g(o.stages.length),1),e[19]||(e[19]=a("div",{class:"stat-label"},"Этапов",-1))])]),ne(Ee,{name:"fade",mode:"out-in"},{default:pe(()=>[o.isLoading?(c(),d("div",Wn,[e[20]||(e[20]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,g(o.currentStep||"Загрузка данных сектора..."),1),o.error?(c(),d("div",Un,[a("p",null,g(o.error),1),a("button",{onClick:e[6]||(e[6]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Повторить")])):$("",!0)])):$("",!0)]),_:1}),o.error&&!o.isLoading?(c(),d("div",Fn,[a("div",Hn,[a("div",jn,[e[21]||(e[21]=a("span",{class:"error-icon"},"❌",-1)),e[22]||(e[22]=a("h3",null,"Ошибка загрузки данных сектора",-1)),a("button",{onClick:e[7]||(e[7]=(...l)=>o.handleErrorClose&&o.handleErrorClose(...l)),class:"error-close","aria-label":"Закрыть"},"✕")]),a("p",Vn,g(o.error),1),a("div",zn,[a("button",{onClick:e[8]||(e[8]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Повторить загрузку")])])])):$("",!0),ne(Ee,{name:"dashboard-fade"},{default:pe(()=>[!o.isLoading&&!o.error?(c(),d("div",Gn,[a("div",Kn," DEBUG: stages.length = "+g(o.stages.length)+", isLoading = "+g(o.isLoading)+", error = "+g(o.error),1),o.stages.length>0?(c(),d("div",qn,[(c(!0),d(ee,null,te(o.stages,l=>(c(),d("div",{key:l.id,class:"stage-card",style:we({borderLeftColor:l.color})},[a("div",Yn,[a("h3",null,g(l.name),1),a("div",Xn,[a("span",Jn,g(l.tickets?.length||0)+" тикетов",1),a("span",Zn,g(l.employees?.length||0)+" сотрудников",1)])]),a("div",Qn,[l.tickets&&l.tickets.length>0?(c(),d("div",er,[(c(!0),d(ee,null,te(l.tickets.slice(0,3),u=>(c(),d("div",{key:u.id,class:"ticket-item"},[a("span",tr,"#"+g(u.id),1),a("span",sr,g(u.title),1)]))),128)),l.tickets.length>3?(c(),d("div",ar," ...и еще "+g(l.tickets.length-3)+" тикетов ",1)):$("",!0)])):(c(),d("div",or," Нет активных тикетов "))])],4))),128))])):o.isLoading?(c(),d("div",nr," Загрузка данных сектора... ")):o.error?(c(),d("div",rr," Ошибка загрузки: "+g(o.error),1)):(c(),d("div",ir,[a("div",lr,[e[29]||(e[29]=a("div",{class:"empty-icon"},"📋",-1)),a("h3",null,'Сектор "'+g(o.sectorName)+'" в разработке',1),e[30]||(e[30]=a("p",null,"Этот сектор находится в стадии разработки. Скоро здесь появятся реальные данные и функциональность.",-1)),a("div",cr,[e[28]||(e[28]=a("h4",null,"Информация о секторе:",-1)),a("ul",null,[a("li",null,[e[23]||(e[23]=a("strong",null,"ID:",-1)),ce(" "+g(s.sectorId),1)]),a("li",null,[e[24]||(e[24]=a("strong",null,"Название:",-1)),ce(" "+g(o.sectorName),1)]),a("li",null,[e[25]||(e[25]=a("strong",null,"Этапов:",-1)),ce(" "+g(o.stages.length),1)]),a("li",null,[e[26]||(e[26]=a("strong",null,"Сотрудников:",-1)),ce(" "+g(o.employees.length),1)]),a("li",null,[e[27]||(e[27]=a("strong",null,"Тикетов:",-1)),ce(" "+g(o.totalTickets),1)])])]),a("button",{onClick:e[9]||(e[9]=(...l)=>o.handleRetry&&o.handleRetry(...l)),class:"btn-retry"},"Обновить данные")])]))])):$("",!0)]),_:1}),ne(n,{variant:"floating"})],2)}const Ia=de(Sn,[["render",dr],["__scopeId","data-v-71ed2018"]]),ur=Object.freeze(Object.defineProperty({__proto__:null,default:Ia},Symbol.toStringTag,{value:"Module"})),Ma="/api/tickets-time-tracking-sector-1c.php";function mr(o){if(!o)return{meta:null,data:{totalElapsedTime:0,totalElapsedTimeUnit:"hours",totalRecordsCount:0,weeks:[],employeesSummary:[]}};const e=o.data||o.result||o,s=e.meta||o.meta||null;return{meta:{weekNumber:s?.weekNumber??null,weekStartUtc:s?.weekStartUtc??null,weekEndUtc:s?.weekEndUtc??null,totalWeeks:s?.totalWeeks??0,sector1CEmployeesCount:s?.sector1CEmployeesCount??0},data:{totalElapsedTime:e.data?.totalElapsedTime??e.totalElapsedTime??0,totalElapsedTimeUnit:e.data?.totalElapsedTimeUnit??e.totalElapsedTimeUnit??"hours",totalRecordsCount:e.data?.totalRecordsCount??e.totalRecordsCount??0,weeks:e.data?.weeks??e.weeks??[],employeesSummary:e.data?.employeesSummary??e.employeesSummary??[]}}}async function gr(o={}){const{product:e="1C",weekStartUtc:s=null,weekEndUtc:t=null,weeksCount:r=4}=o;try{const i=et(Ma),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:e,weekStartUtc:s,weekEndUtc:t,weeksCount:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(l.error)throw new Error(l.error_description||l.error||"Unknown error");const u=mr(l);if(l.cache_used===!0){const{CacheNotificationService:m}=await De(async()=>{const{CacheNotificationService:v}=await Promise.resolve().then(()=>T$);return{CacheNotificationService:v}},void 0,import.meta.url);m.notifyCacheUsed("Трудозатраты на Тикеты сектора 1С")}return u}catch(i){throw console.error("[TimeTrackingService] Error fetching time tracking data:",i),i}}async function hr({taskIds:o,employeeId:e,weekNumber:s,page:t=1,perPage:r=10}){if(!o||!Array.isArray(o)||o.length===0)return{tasks:[],pagination:{totalTasks:0,currentPage:1,perPage:r,totalPages:0}};try{const i=et(Ma),n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:"1C",includeTaskDetails:!0,taskIds:o,employeeId:e||void 0,weekNumber:s||void 0,page:t,perPage:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.error||l.error_description||"Ошибка получения данных о задачах");return{tasks:l.data.tasks||[],pagination:l.data.pagination||{totalTasks:0,currentPage:1,perPage:r,totalPages:0}}}catch(i){throw console.error("[timeTrackingService] Error loading tasks details:",i),i}}const Na={getTimeTrackingData:gr,getTasksDetails:hr};function qe(o,e=1){return typeof o!="number"||isNaN(o)?"0 ч":`${o.toFixed(e)} ч`}function os(o,e){if(!o||!e)return`Неделя ${o||"?"}`;try{const s=new Date(e),t=new Date(s);t.setDate(t.getDate()+6);const r=s.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),i=t.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"});return`Неделя ${o} (${r} - ${i})`}catch(s){return console.error("[TimeTrackingUtils] Error formatting week label:",s),`Неделя ${o}`}}function fr(o){return!o||!o.data?!1:o.data.totalRecordsCount>0||o.data.weeks&&o.data.weeks.length>0}const vr={class:"ttt-summary"},pr={class:"summary-cards"},yr={class:"summary-card summary-card--total"},kr={class:"summary-card__content"},br={class:"summary-card__value"},_r={class:"summary-card summary-card--employees"},wr={class:"summary-card__content"},Cr={class:"summary-card__value"},Tr={class:"summary-card summary-card--average"},Sr={class:"summary-card__content"},Dr={class:"summary-card__value"},Er={__name:"TicketsTimeTrackingSummary",props:{data:{type:Object,required:!0}},setup(o){const e=o,s=M(()=>e.data?.data?.totalElapsedTime||0),t=M(()=>e.data?.meta?.sector1CEmployeesCount||0),r=M(()=>{const l=s.value,u=t.value;return u>0?l/u:0}),i=M(()=>s.value===0?"0.0 ч":qe(s.value,1)),n=M(()=>r.value===0?"0.00 ч":qe(r.value,2));return(l,u)=>(c(),d("div",vr,[a("div",pr,[a("div",yr,[u[1]||(u[1]=a("div",{class:"summary-card__icon"},"⏱",-1)),a("div",kr,[u[0]||(u[0]=a("div",{class:"summary-card__label"},"Общая сумма трудозатрат",-1)),a("div",br,g(i.value),1)])]),a("div",_r,[u[3]||(u[3]=a("div",{class:"summary-card__icon"},"👥",-1)),a("div",wr,[u[2]||(u[2]=a("div",{class:"summary-card__label"},"Сотрудников в секторе",-1)),a("div",Cr,g(t.value),1)])]),a("div",Tr,[u[5]||(u[5]=a("div",{class:"summary-card__icon"},"📊",-1)),a("div",Sr,[u[4]||(u[4]=a("div",{class:"summary-card__label"},"Средняя на сотрудника",-1)),a("div",Dr,g(n.value),1)])])])]))}},Ar=de(Er,[["__scopeId","data-v-51b124c7"]]),$r={class:"ttt-table-container"},Ir={key:0,class:"ttt-table-loading"},Mr={key:1,class:"ttt-table-error"},Nr={key:2,class:"ttt-table-empty"},xr={key:3,class:"ttt-table-wrapper"},Pr={class:"ttt-table"},Lr=["onClick"],Or={class:"ttt-table__header-week-date"},Br=["onClick"],Rr={class:"ttt-table__cell-employee"},Wr=["onClick"],Ur={class:"ttt-table__cell-total"},Fr={class:"ttt-table__row-total"},Hr=["onClick"],jr={class:"ttt-table__cell-total"},Vr={__name:"TicketsTimeTrackingTable",props:{data:{type:Object,required:!0},loading:{type:Boolean,default:!1},error:{type:String,default:null}},emits:["cell-click","employee-click","week-click"],setup(o,{emit:e}){const s=o,t=e,r=M(()=>s.data?.data?.weeks||[]),i=M(()=>{if(!s.data||!s.data.data||!s.data.data.weeks)return null;const f=s.data.data.weeks||[],p=(s.data.data.employeesSummary||[]).map(y=>{const _={};let A=0;return f.forEach(W=>{const D=W.employees?.find(E=>E.id===y.id)?.elapsedTime||0;_[W.weekNumber]=D,A+=D}),{id:y.id,name:y.name,weeks:_,total:A}}),S={};let C=0;return f.forEach(y=>{S[y.weekNumber]=y.totalElapsedTime||0,C+=y.totalElapsedTime||0}),{employees:p,weekTotals:S,grandTotal:C}}),n=(f,k)=>i.value?.employees.find(S=>S.id===f)?.weeks[k]||0,l=f=>i.value?.weekTotals[f]||0,u=f=>{if(!f)return"";try{return new Date(f).toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}catch{return""}},m=(f,k)=>{const p=i.value?.employees.find(C=>C.id===f),S=s.data?.data?.weeks?.find(C=>C.weekNumber===k);p&&S&&t("cell-click",{employee:p,week:S,elapsedTime:n(f,k)})},v=f=>{const k=i.value?.employees.find(p=>p.id===f);k&&t("employee-click",{employee:k,weeks:r.value.map(p=>({week:p,elapsedTime:n(f,p.weekNumber)}))})},T=f=>{const k=r.value.find(p=>p.weekNumber===f);k&&t("week-click",{week:k,employees:i.value?.employees.map(p=>({employee:p,elapsedTime:n(p.id,f)})).filter(p=>p.elapsedTime>0)})};return(f,k)=>(c(),d("div",$r,[o.loading?(c(),d("div",Ir," Загрузка данных... ")):o.error?(c(),d("div",Mr,g(o.error),1)):!i.value||i.value.employees.length===0?(c(),d("div",Nr," Нет данных о трудозатратах за выбранный период ")):(c(),d("div",xr,[a("table",Pr,[a("thead",null,[a("tr",null,[k[1]||(k[1]=a("th",{class:"ttt-table__header-employee"},"Сотрудник",-1)),(c(!0),d(ee,null,te(r.value,p=>(c(),d("th",{key:p.weekNumber,class:X(["ttt-table__header-week",{"ttt-table__header--clickable":!0}]),onClick:S=>T(p.weekNumber)},[ce(" Неделя "+g(p.weekNumber),1),k[0]||(k[0]=a("br",null,null,-1)),a("span",Or,g(u(p.weekStartUtc)),1)],8,Lr))),128)),k[2]||(k[2]=a("th",{class:"ttt-table__header-total"},"Итого",-1))])]),a("tbody",null,[(c(!0),d(ee,null,te(i.value.employees,p=>(c(),d("tr",{key:p.id,class:X(["ttt-table__row",{"ttt-table__row--clickable":!0}]),onClick:S=>v(p.id)},[a("td",Rr,g(p.name),1),(c(!0),d(ee,null,te(r.value,S=>(c(),d("td",{key:`${p.id}-${S.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:Ce(C=>m(p.id,S.weekNumber),["stop"])},g(We(qe)(n(p.id,S.weekNumber))),9,Wr))),128)),a("td",Ur,[a("strong",null,g(We(qe)(p.total)),1)])],8,Br))),128)),a("tr",Fr,[k[3]||(k[3]=a("td",{class:"ttt-table__cell-employee"},[a("strong",null,"ВСЕГО")],-1)),(c(!0),d(ee,null,te(r.value,p=>(c(),d("td",{key:`total-${p.weekNumber}`,class:X(["ttt-table__cell-week",{"ttt-table__cell--clickable":!0}]),onClick:S=>T(p.weekNumber)},[a("strong",null,g(We(qe)(l(p.weekNumber))),1)],8,Hr))),128)),a("td",jr,[a("strong",null,g(We(qe)(i.value.grandTotal)),1)])])])])]))]))}},zr=de(Vr,[["__scopeId","data-v-8021e5e4"]]),Gr={class:"modal-header"},Kr={class:"modal-body"},qr={key:"level-1",class:"detail-cell"},Yr={class:"detail-info"},Xr={key:0,class:"tasks-list"},Jr={class:"task-header"},Zr={class:"task-label"},Qr={class:"task-time"},ei={key:0,class:"ticket-info"},ti={class:"ticket-label"},si=["title"],ai={key:1,class:"ticket-title"},oi={key:1,class:"ticket-info ticket-info--no-ticket"},ni={class:"detail-total"},ri={key:0,class:"detail-actions"},ii={key:"level-2",class:"tasks-list-level"},li={class:"tasks-list-header"},ci={class:"tasks-list-title"},di={class:"tasks-list-content"},ui={key:"loading",class:"loading-state"},mi={key:"error",class:"error-state"},gi={class:"error-message"},hi={key:"empty",class:"empty-state"},fi={key:"tasks",class:"tasks-cards-container"},vi=["onClick"],pi={class:"task-card__header"},yi={class:"task-card__number"},ki={key:0,class:"task-card__time"},bi={class:"task-card__title"},_i={class:"task-card__dates"},wi={class:"task-card__date-item"},Ci={class:"date-value"},Ti={class:"task-card__date-item"},Si={class:"task-card__date-item"},Di={class:"date-value"},Ei={key:0,class:"task-card__ticket"},Ai={class:"ticket-header"},$i={class:"ticket-header__left"},Ii={class:"ticket-id"},Mi=["title"],Ni={class:"ticket-title"},xi={class:"ticket-meta"},Pi={class:"ticket-meta__row"},Li={class:"ticket-meta__item"},Oi={class:"meta-value"},Bi={class:"ticket-meta__item"},Ri={class:"meta-value"},Wi={class:"ticket-meta__row"},Ui={class:"ticket-meta__item"},Fi={class:"meta-value"},Hi={class:"ticket-meta__item"},ji={class:"meta-value"},Vi={class:"ticket-dates"},zi={class:"ticket-date-item"},Gi={class:"date-value"},Ki={key:1,class:"task-card__no-ticket"},qi={key:0,class:"tasks-pagination"},Yi=["disabled"],Xi={class:"pagination-pages"},Ji=["onClick"],Zi=["disabled"],Qi={key:"employee",class:"detail-employee"},el={class:"detail-info"},tl={class:"weeks-list"},sl={class:"week-header"},al={class:"week-label"},ol={class:"week-time"},nl={key:"week",class:"detail-week"},rl={class:"detail-info"},il={class:"employees-list"},ll={class:"employee-header"},cl={class:"employee-label"},dl={class:"employee-time"},ul={__name:"TimeTrackingDetailModal",props:{cellData:{type:Object,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=e,r=I(1),i=I([]),n=I(!1),l=I(null),u=I(1),m=I(10),v=M(()=>{if(!s.cellData)return"Детализация трудозатрат";if(r.value===2)return`Список задач: ${s.cellData.employee?.name||"Сотрудник"}, Неделя ${s.cellData.week?.weekNumber||"?"}`;if(s.cellData.type==="employee")return`Детализация: ${s.cellData.employee?.name||"Сотрудник"}`;if(s.cellData.type==="week")return`Детализация: Неделя ${s.cellData.week?.weekNumber||"?"}`;const Y=s.cellData.employee?.name||"Сотрудник",H=s.cellData.week?.weekNumber||"?",Z=qe(s.cellData.elapsedTime||0);return`Детализация: ${Y}, Неделя ${H} (${Z})`}),T=M(()=>s.cellData?.week?.employees&&s.cellData.week.employees.find(H=>H.id===s.cellData.employee?.id)?.tasksCount||0),f=M(()=>s.cellData?.week?.employees&&s.cellData.week.employees.find(H=>H.id===s.cellData.employee?.id)?.ticketsCount||0);M(()=>s.cellData?.week?.weekNumber||null);const k=I({totalTasks:0,currentPage:1,perPage:10,totalPages:0}),p=M(()=>k.value.totalPages),S=M(()=>i.value),C=M(()=>{const Y=[];let Z=Math.max(1,k.value.currentPage-Math.floor(2.5)),fe=Math.min(p.value,Z+5-1);fe-Z<4&&(Z=Math.max(1,fe-5+1));for(let L=Z;L<=fe;L++)Y.push(L);return Y}),y=Y=>{if(!Y||Y.length===0)return"Период не указан";if(Y.length===1)return os(Y[0].week.weekNumber,Y[0].week.weekStartUtc);const H=Y[0].week,Z=Y[Y.length-1].week;return`${os(H.weekNumber,H.weekStartUtc)} - ${os(Z.weekNumber,Z.weekStartUtc)}`},_=Y=>Y?os(Y.weekNumber,Y.weekStartUtc):"Период не указан",A=Y=>{if(!Y)return"-";try{const H=new Date(Y);return isNaN(H.getTime())?"-":H.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})}catch(H){return console.warn("[TimeTrackingDetailModal] Error formatting date:",Y,H),"-"}},W=(Y,H)=>{if(H)try{const Z=new Date(H);if(!isNaN(Z.getTime()))return!1}catch{}if(!Y)return!1;try{const Z=new Date(Y);return isNaN(Z.getTime())?!1:new Date>Z}catch(Z){return console.warn("[TimeTrackingDetailModal] Error checking overdue:",Y,Z),!1}},x=Y=>{const H=Y.closedDate?new Date(Y.closedDate):null,Z=W(Y.deadline,Y.closedDate);return{"task-card--completed":!!H,"task-card--overdue":Z,"task-card--in-progress":!H&&!Z}},D=async()=>{r.value=2,await B()},E=()=>{r.value=1,i.value=[],l.value=null,u.value=1,k.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0}},P=Y=>!Y||typeof Y!="object"?!1:!Y.id||typeof Y.id!="number"?(console.warn("[TimeTrackingDetailModal] Invalid task (no ID):",Y),!1):!0,B=async()=>{if(!s.cellData?.week?.employees||!s.cellData.employee){l.value="Недостаточно данных для загрузки задач";return}n.value=!0,l.value=null;try{const Y=s.cellData.week.employees.find(fe=>fe.id===s.cellData.employee?.id);if(!Y){i.value=[];return}let H=[];if(Array.isArray(Y.tasks)&&Y.tasks.length>0&&(H=Y.tasks.map(fe=>typeof fe=="object"&&fe!==null&&fe.id?fe.id:typeof fe=="number"?fe:null).filter(fe=>fe!==null&&fe>0)),H.length===0){i.value=[];return}const Z=await Na.getTasksDetails({taskIds:H,employeeId:s.cellData.employee.id,weekNumber:s.cellData.week.weekNumber,page:u.value,perPage:m.value});if(!Z||!Array.isArray(Z.tasks)){console.error("[TimeTrackingDetailModal] Invalid response format:",Z),l.value="Некорректный формат данных от сервера",i.value=[];return}i.value=Z.tasks.filter(P),k.value=Z.pagination||{totalTasks:0,currentPage:1,perPage:m.value,totalPages:0},u.value=k.value.currentPage}catch(Y){console.error("[TimeTrackingDetailModal] Error loading tasks details:",{error:Y,taskIds:s.cellData?.week?.employees?.find(Z=>Z.id===s.cellData.employee?.id)?.tasks?.map(Z=>Z.id)||[],employeeId:s.cellData.employee?.id,weekNumber:s.cellData.week?.weekNumber,timestamp:new Date().toISOString()});const H=Y.message||"";H.includes("network")||H.includes("fetch")||H.includes("Failed to fetch")?l.value="Ошибка сети. Проверьте подключение к интернету.":H.includes("timeout")?l.value="Превышено время ожидания. Попробуйте позже.":H.includes("403")||H.includes("401")?l.value="Ошибка доступа. Проверьте права доступа.":H.includes("404")?l.value="Данные не найдены.":H.includes("500")?l.value="Ошибка сервера. Попробуйте позже.":l.value=H||"Ошибка загрузки задач",i.value=[]}finally{n.value=!1}},U=()=>{u.value=1,B()};Me(u,()=>{r.value===2&&B()});const G=Y=>{if(Y>=1&&Y<=p.value&&Y!==u.value){u.value=Y;const H=document.querySelector(".tasks-cards-container");H&&(H.scrollTop=0)}},q=Y=>{console.log("[TimeTrackingDetailModal] Task clicked:",Y.id)},oe=()=>{t("close")};return Me(()=>s.cellData,Y=>{Y||(r.value=1,i.value=[],l.value=null,u.value=1,k.value={totalTasks:0,currentPage:1,perPage:10,totalPages:0})}),(Y,H)=>(c(),he($t,{to:"body"},[o.cellData?(c(),d("div",{key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true",onClick:Ce(oe,["self"]),onKeydown:Oe(oe,["esc"])},[a("div",{class:"modal-content",onClick:H[2]||(H[2]=Ce(()=>{},["stop"]))},[a("div",Gr,[a("h2",null,g(v.value),1),a("button",{class:"close-button",onClick:oe,"aria-label":"Закрыть"},"×")]),a("div",Kr,[ne(Ee,{name:"level",mode:"out-in"},{default:pe(()=>[r.value===1&&(o.cellData.type==="cell"||!o.cellData.type&&o.cellData.employee&&o.cellData.week)?(c(),d("div",qr,[a("div",Yr,[a("p",null,[H[3]||(H[3]=a("strong",null,"Сотрудник:",-1)),ce(" "+g(o.cellData.employee?.name||"Неизвестно"),1)]),a("p",null,[H[4]||(H[4]=a("strong",null,"Неделя:",-1)),ce(" "+g(o.cellData.week?.weekNumber||"?"),1)]),a("p",null,[H[5]||(H[5]=a("strong",null,"Трудозатраты:",-1)),ce(" "+g(We(qe)(o.cellData.elapsedTime||0)),1)])]),o.cellData.week?.employees?(c(),d("div",Xr,[H[8]||(H[8]=a("h3",null,"Задачи и связанные тикеты:",-1)),(c(!0),d(ee,null,te(o.cellData.week.employees.filter(Z=>Z.id===o.cellData.employee?.id),Z=>(c(),d("div",{key:Z.id,class:"employee-tasks"},[(c(!0),d(ee,null,te(Z.tasks,(fe,L)=>(c(),d("div",{class:"task-item",key:L},[a("div",Jr,[a("span",Zr,"Задача #"+g(fe.id||L+1),1),a("span",Qr,g(We(qe)(fe.elapsedTime||0)),1)]),fe.ticket?(c(),d("div",ei,[a("span",ti,"Тикет #"+g(fe.ticket.id),1),fe.ticket.createdWeek&&fe.ticket.createdWeek!==o.cellData.week.weekNumber?(c(),d("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${fe.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week.weekNumber}`}," (создан в неделе "+g(fe.ticket.createdWeek)+") ",9,si)):$("",!0),fe.ticket.title?(c(),d("div",ai,g(fe.ticket.title),1)):$("",!0)])):(c(),d("div",oi,[...H[6]||(H[6]=[a("span",{class:"no-ticket-label"},"Тикет не связан",-1)])]))]))),128))]))),128)),a("div",ni,[a("p",null,[H[7]||(H[7]=a("strong",null,"Итого:",-1)),ce(" "+g(We(qe)(o.cellData.elapsedTime||0))+" ("+g(T.value)+" задач, "+g(f.value)+" тикетов) ",1)])]),T.value>0?(c(),d("div",ri,[a("button",{class:"btn btn-primary btn-tasks-list",onClick:D}," 📋 Список задач ")])):$("",!0)])):$("",!0)])):r.value===2?(c(),d("div",ii,[a("div",li,[a("button",{class:"btn-back",onClick:E,"aria-label":"Назад"}," ← Назад "),a("h3",ci," Список задач: "+g(o.cellData.employee?.name||"Сотрудник")+", Неделя "+g(o.cellData.week?.weekNumber||"?"),1)]),a("div",di,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),d("div",ui,[...H[9]||(H[9]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка задач...",-1)])])):l.value?(c(),d("div",mi,[H[10]||(H[10]=a("div",{class:"error-icon"},"⚠️",-1)),H[11]||(H[11]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",gi,g(l.value),1),a("button",{class:"btn btn-retry",onClick:U},"Повторить")])):i.value.length===0?(c(),d("div",hi,[...H[12]||(H[12]=[a("div",{class:"empty-state-icon"},"📋",-1),a("p",{class:"empty-state-message"},"Нет задач для отображения",-1)])])):(c(),d("div",fi,[ne(Qe,{name:"task-card",tag:"div",class:"tasks-cards-list"},{default:pe(()=>[(c(!0),d(ee,null,te(S.value.filter(P),Z=>(c(),d("div",{key:Z.id,class:X(["task-card",x(Z)]),onClick:fe=>q(Z)},[a("div",pi,[a("span",yi,"Задача #"+g(Z.id),1),Z.elapsedTime?(c(),d("span",ki,g(We(qe)(Z.elapsedTime)),1)):$("",!0)]),a("div",bi,g(Z.title||"Без названия"),1),a("div",_i,[a("div",wi,[H[13]||(H[13]=a("span",{class:"date-icon"},"📅",-1)),H[14]||(H[14]=a("span",{class:"date-label"},"Начало:",-1)),a("span",Ci,g(A(Z.startDate)),1)]),a("div",Ti,[H[15]||(H[15]=a("span",{class:"date-icon"},"⏰",-1)),H[16]||(H[16]=a("span",{class:"date-label"},"Дедлайн:",-1)),a("span",{class:X(["date-value",{"date-value--overdue":W(Z.deadline,Z.closedDate)}])},g(A(Z.deadline)||"-"),3)]),a("div",Si,[H[17]||(H[17]=a("span",{class:"date-icon"},"✓",-1)),H[18]||(H[18]=a("span",{class:"date-label"},"Завершено:",-1)),a("span",Di,g(A(Z.closedDate)||"-"),1)])]),Z.ticket?(c(),d("div",Ei,[a("div",Ai,[a("div",$i,[a("span",Ii,"Тикет #"+g(Z.ticket.id),1),Z.ticket.createdWeek&&Z.ticket.createdWeek!==o.cellData.week?.weekNumber?(c(),d("span",{key:0,class:"ticket-week-badge",title:`Тикет создан в неделе ${Z.ticket.createdWeek}, трудозатрата записана в неделе ${o.cellData.week?.weekNumber}`}," Создан в нед. "+g(Z.ticket.createdWeek),9,Mi)):$("",!0)])]),a("div",Ni,g(Z.ticket.title||Z.ticket.ufSubject||"Без названия"),1),a("div",xi,[a("div",Pi,[a("div",Li,[H[19]||(H[19]=a("span",{class:"meta-label"},"Сектор:",-1)),a("span",Oi,g(Z.ticket.ufSlaBlockStr||"Не указан"),1)]),a("div",Bi,[H[20]||(H[20]=a("span",{class:"meta-label"},"Сервис:",-1)),a("span",Ri,g(Z.ticket.ufSlaServiceStr||"Не указан"),1)])]),a("div",Wi,[a("div",Ui,[H[21]||(H[21]=a("span",{class:"meta-label"},"Действие:",-1)),a("span",Fi,g(Z.ticket.ufActionStr||"Не указано"),1)]),a("div",Hi,[H[22]||(H[22]=a("span",{class:"meta-label"},"Приоритет:",-1)),a("span",ji,g(Z.ticket.ufCrm7UfPriority||"Не указан"),1)])])]),a("div",Vi,[a("div",zi,[H[23]||(H[23]=a("span",{class:"date-icon"},"📅",-1)),H[24]||(H[24]=a("span",{class:"date-label"},"Создан:",-1)),a("span",Gi,g(A(Z.ticket.createdTime)),1)])])])):(c(),d("div",Ki,[...H[25]||(H[25]=[a("span",{class:"no-ticket-label"},"Тикет не связан",-1)])])),H[26]||(H[26]=a("div",{class:"task-card__status-placeholder"},null,-1))],10,vi))),128))]),_:1}),p.value>1?(c(),d("div",qi,[a("button",{class:"pagination-btn",disabled:k.value.currentPage===1,onClick:H[0]||(H[0]=Z=>G(k.value.currentPage-1))}," ← Предыдущая ",8,Yi),a("div",Xi,[(c(!0),d(ee,null,te(C.value,Z=>(c(),d("button",{key:Z,class:X(["pagination-page",{"pagination-page--active":Z===k.value.currentPage}]),onClick:fe=>G(Z)},g(Z),11,Ji))),128))]),a("button",{class:"pagination-btn",disabled:k.value.currentPage===p.value,onClick:H[1]||(H[1]=Z=>G(k.value.currentPage+1))}," Следующая → ",8,Zi)])):$("",!0)]))]),_:1})])])):r.value===1&&o.cellData.type==="employee"?(c(),d("div",Qi,[a("div",el,[a("p",null,[H[27]||(H[27]=a("strong",null,"Сотрудник:",-1)),ce(" "+g(o.cellData.employee?.name||"Неизвестно"),1)]),a("p",null,[H[28]||(H[28]=a("strong",null,"Период:",-1)),ce(" "+g(y(o.cellData.weeks)),1)])]),a("div",tl,[H[29]||(H[29]=a("h3",null,"Трудозатраты по неделям:",-1)),(c(!0),d(ee,null,te(o.cellData.weeks,Z=>(c(),d("div",{key:Z.week.weekNumber,class:"week-item"},[a("div",sl,[a("span",al,"Неделя "+g(Z.week.weekNumber),1),a("span",ol,g(We(qe)(Z.elapsedTime||0)),1)])]))),128))])])):r.value===1&&o.cellData.type==="week"?(c(),d("div",nl,[a("div",rl,[a("p",null,[H[30]||(H[30]=a("strong",null,"Неделя:",-1)),ce(" "+g(o.cellData.week?.weekNumber||"?"),1)]),a("p",null,[H[31]||(H[31]=a("strong",null,"Период:",-1)),ce(" "+g(_(o.cellData.week)),1)]),a("p",null,[H[32]||(H[32]=a("strong",null,"Общие трудозатраты:",-1)),ce(" "+g(We(qe)(o.cellData.week?.totalElapsedTime||0)),1)])]),a("div",il,[H[33]||(H[33]=a("h3",null,"Трудозатраты по сотрудникам:",-1)),(c(!0),d(ee,null,te(o.cellData.employees,Z=>(c(),d("div",{key:Z.employee.id,class:"employee-item"},[a("div",ll,[a("span",cl,g(Z.employee.name),1),a("span",dl,g(We(qe)(Z.elapsedTime||0)),1)])]))),128))])])):$("",!0)]),_:1})]),a("div",{class:"modal-footer"},[a("button",{class:"close-btn",onClick:oe},"Закрыть")])])],32)):$("",!0)]))}},ml=de(ul,[["__scopeId","data-v-fc33390b"]]),gl={class:"tickets-time-tracking-dashboard"},hl={class:"dashboard-header"},fl={class:"breadcrumbs-row"},vl=["aria-label","aria-disabled","data-fallback","disabled"],pl={class:"breadcrumbs","aria-label":"Навигация"},yl={key:"preloader",class:"time-tracking-preloader"},kl={key:"error",class:"error-state"},bl={key:"empty",class:"empty-state"},_l={key:"content",class:"dashboard-content"},wl={__name:"TicketsTimeTrackingDashboard",setup(o){const e=Xe(),s=I(!0),t=I(null),r=I(null),i=I(null),n=I(!1),l=M(()=>fr(r.value)),u=async()=>{s.value=!0,t.value=null;const y=new Promise(_=>setTimeout(_,300));try{const[_,A]=await Promise.all([y,Na.getTimeTrackingData({product:"1C",weeksCount:4})]);r.value=A}catch(_){console.error("[TicketsTimeTrackingDashboard] Error loading data:",_),t.value=_.message||"Не удалось загрузить данные"}finally{s.value=!1}},m=y=>{i.value=y},v=y=>{i.value={type:"employee",...y}},T=y=>{i.value={type:"week",...y}},f=()=>{i.value=null},k=M(()=>typeof window>"u"?!1:window.history.length>1),p=M(()=>k.value?"Вернуться назад":"Вернуться на главную"),S=()=>{n.value||(n.value=!0,k.value?e.go(-1):e.push({name:"dashboard-sector-1c"}),setTimeout(()=>{n.value=!1},300))},C=()=>{e.push("/")};return Ae(()=>{u()}),(y,_)=>{const A=be("router-link");return c(),d("div",gl,[a("div",hl,[a("div",fl,[a("button",{class:"btn-home-link",type:"button",onClick:C,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),_[7]||(_[7]=a("span",{class:"breadcrumb-separator"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:S,"aria-label":p.value,"aria-disabled":!k.value,"data-fallback":!k.value,disabled:n.value,title:"Назад"}," ← ",8,vl),a("nav",pl,[ne(A,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[..._[0]||(_[0]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),_[3]||(_[3]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[..._[1]||(_[1]=[ce(" График состояния ",-1)])]),_:1}),_[4]||(_[4]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(A,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:pe(()=>[..._[2]||(_[2]=[ce(" График приёма и закрытий ",-1)])]),_:1}),_[5]||(_[5]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),_[6]||(_[6]=a("span",{class:"breadcrumb-current"},"Трудозатраты",-1))])])]),_[10]||(_[10]=a("h1",{class:"dashboard-title"},"Трудозатраты на Тикеты сектора 1С",-1)),$("",!0),ne(Ee,{name:"fade",mode:"out-in"},{default:pe(()=>[s.value?(c(),d("div",yl,[..._[8]||(_[8]=[a("div",{class:"preloader-content"},[a("div",{class:"preloader-spinner"},[a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"})]),a("h3",{class:"preloader-title"},"Загрузка данных"),a("p",{class:"preloader-message"},"Получение данных о трудозатратах..."),a("div",{class:"preloader-dots"},[a("span",{class:"dot"}),a("span",{class:"dot"}),a("span",{class:"dot"})])],-1)])])):t.value?(c(),d("div",kl,[a("p",null,"Ошибка загрузки данных: "+g(t.value),1),a("button",{onClick:u,class:"retry-button"},"Повторить попытку")])):l.value?(c(),d("div",_l,[r.value?(c(),he(Ar,{key:0,data:r.value},null,8,["data"])):$("",!0),r.value?(c(),he(zr,{key:1,data:r.value,loading:s.value,error:t.value,onCellClick:m,onEmployeeClick:v,onWeekClick:T},null,8,["data","loading","error"])):$("",!0)])):(c(),d("div",bl,[..._[9]||(_[9]=[a("p",null,"Нет данных о трудозатратах за выбранный период",-1)])]))]),_:1}),i.value?(c(),he(ml,{key:1,"cell-data":i.value,onClose:f},null,8,["cell-data"])):$("",!0)])}}},xa=de(wl,[["__scopeId","data-v-2f7848de"]]),Cl=Object.freeze(Object.defineProperty({__proto__:null,default:xa},Symbol.toStringTag,{value:"Module"}));Je.register(Ja,Za,Qa,eo,to,so,ao,oo,no,ro);Je.defaults.responsive=!0;Je.defaults.maintainAspectRatio=!1;Je.defaults.plugins.legend.display=!0;Je.defaults.plugins.legend.position="top";const J={primary:"#007bff",success:"#28a745",danger:"#dc3545",warning:"#ffc107",info:"#17a2b8",carryover:"#ff9800",successLight:"#6cbf47",carryoverLight:"#ffb74d",carryoverDark:"#f57c00"},ht={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class pt{static getApiBaseUrl(){return go()}static async createSnapshot(e,s,t={}){try{if(!e||typeof e!="object")throw new St("sectorData должен быть объектом","VALIDATION_ERROR");if(!s||!["week_start","week_end","manual","current"].includes(s))throw new St("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(e);if(!r.isValid)throw new St(`Ошибка валидации данных сектора: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const i=this.normalizeSectorData(e),l={metadata:this.generateSnapshotMetadata(s,t.createdBy,t.sectorId||ht.defaultSectorId),statistics:i.statistics,ticketIds:i.ticketIds,tickets:i.tickets},u=this.validateSnapshot(l);if(!u.isValid)throw new St(`Ошибка валидации слепка: ${u.errors.join(", ")}`,"VALIDATION_ERROR",{validation:u});u.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",u.warnings);const m=this.getApiBaseUrl(),v=await fetch(`${m}${ht.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:s,date:this.formatDate(new Date)})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const T=await v.json();if(!T.success)throw new Error(T.message||"Ошибка создания слепка");return T.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof St?r:new St(`Ошибка создания слепка: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(e,s){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?action=get&date=${t}&type=${s}`,n=await fetch(i,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success){if(l.message&&l.message.includes("не найден"))return null;throw new Error(l.message||"Ошибка получения слепка")}return l.data.snapshot}catch(t){throw console.error("SnapshotService.getSnapshot error:",t),t}}static async getAllSnapshots(e={}){try{const s=new URLSearchParams;s.append("action","list"),e.startDate&&s.append("startDate",this.formatDate(e.startDate)),e.endDate&&s.append("endDate",this.formatDate(e.endDate)),e.type&&s.append("type",e.type),e.sectorId?s.append("sectorId",e.sectorId):s.append("sectorId",ht.defaultSectorId);const r=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}?${s.toString()}`,i=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=await i.json();if(!n.success)throw new Error(n.message||"Ошибка получения списка слепков");return(await Promise.all(n.data.snapshots.map(async u=>{try{return await this.getSnapshot(u.date,u.type)}catch(m){return console.warn(`Ошибка загрузки слепка ${u.date}/${u.type}:`,m),null}}))).filter(u=>u!==null).sort((u,m)=>new Date(u.metadata.createdAt)-new Date(m.metadata.createdAt))}catch(s){throw console.error("SnapshotService.getAllSnapshots error:",s),s}}static normalizeSectorData(e){const{stages:s=[],employees:t=[],zeroPointTickets:r={}}=e,i={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},n=[],l=[],u=[];s.forEach(T=>{const f=T.id;if(i[f]){let k=0;T.employees.forEach(p=>{const S=p.tickets||[];k+=S.length;let C=n.find(y=>y.id===p.id);C||(C={id:p.id,name:p.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(C)),S.forEach(y=>{l.push(y.id),u.push({id:y.id,title:y.title||"Без названия",assignedTo:{id:p.id,name:p.name},createdAt:y.createdAt||"",updatedAt:y.modifiedAt||y.updatedAt||""}),C.ticketsByStage[f]=(C.ticketsByStage[f]||0)+1,C.totalTickets+=1})}),i[f].count=k}});const m={unassigned:0,keeper:0,total:0};Object.values(r).forEach(T=>{Array.isArray(T)&&T.forEach(f=>{m.total+=1,f.assigneeId===1051||f.assignedById===1051?m.keeper+=1:m.unassigned+=1,l.push(f.id),u.push({id:f.id,title:f.title||"Без названия",assignedTo:f.assignedTo||f.assignedById?{id:f.assignedById||f.assigneeId,name:"Неизвестный"}:null,createdAt:f.createdAt||"",updatedAt:f.modifiedAt||f.updatedAt||""})})});const v=Object.values(i).reduce((T,f)=>T+f.count,0)+m.total;return{statistics:{stages:{...i,total:v},employees:n,zeroPoint:m},ticketIds:[...new Set(l)],tickets:u}}static generateSnapshotMetadata(e,s,t){const r=new Date,i=-r.getTimezoneOffset(),n=Math.floor(i/60),l=i%60,u=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(l).padStart(2,"0")}`,m=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${u}`;return{version:ht.snapshotVersion,createdAt:m,createdBy:s||{id:0,name:"Система"},type:e,sectorId:t,sectorName:t==="1C"?"Сектор 1С":`Сектор ${t}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("Некорректная дата");const s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${s}-${t}-${r}`}static buildFilePath(e,s){const t=typeof e=="string"?new Date(e):e,r=t.getFullYear(),i=this.getWeekNumber(t),n=this.formatDate(e);let l;if(s==="current"){const u=new Date,m=`${String(u.getHours()).padStart(2,"0")}-${String(u.getMinutes()).padStart(2,"0")}-${String(u.getSeconds()).padStart(2,"0")}`;l=`current-state-${n}-${m}.json`}else if(s==="manual"){const u=new Date,m=`${String(u.getHours()).padStart(2,"0")}-${String(u.getMinutes()).padStart(2,"0")}-${String(u.getSeconds()).padStart(2,"0")}`;l=`manual-${n}-${m}.json`}else l=`${s}-${n}.json`;return s==="current"?`current/${l}`:`${r}/week-${i}/${l}`}static getWeekNumber(e){const s=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),t=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-t);const r=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-r)/864e5+1)/7)}static validateSnapshot(e){const s=[],t=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&s.push("Неверная версия формата данных"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&s.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(e.metadata.type)||s.push("Неверный тип слепка"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&s.push("Неверный идентификатор сектора"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&s.push("Неверная информация о создателе")):s.push("Отсутствуют метаданные слепка"),!e.statistics)s.push("Отсутствует статистика");else{if(!e.statistics.stages)s.push("Отсутствует статистика по этапам");else{const r=e.statistics.stages,i=(r.formed?.count||0)+(r.review?.count||0)+(r.execution?.count||0);r.total!==i&&t.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${r.total}`)}if(Array.isArray(e.statistics.employees)||s.push("Статистика по сотрудникам должна быть массивом"),!e.statistics.zeroPoint)s.push("Отсутствует статистика нулевой точки");else{const r=e.statistics.zeroPoint,i=(r.unassigned||0)+(r.keeper||0);r.total!==i&&t.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${r.total}`)}}if(Array.isArray(e.ticketIds)||s.push("ticketIds должен быть массивом"),!Array.isArray(e.tickets))s.push("tickets должен быть массивом");else{const r=new Set(e.ticketIds),i=new Set(e.tickets.map(n=>n.id));r.size!==i.size&&t.push("Количество ID в ticketIds не совпадает с количеством тикетов"),e.tickets.forEach((n,l)=>{n.id||s.push(`Тикет #${l}: отсутствует ID`),n.title||s.push(`Тикет #${l}: отсутствует заголовок`),(!n.assignedTo||!n.assignedTo.id)&&t.push(`Тикет #${l}: отсутствует ответственный (может быть в нулевой точке)`),n.createdAt||s.push(`Тикет #${l}: отсутствует дата создания`),n.updatedAt||s.push(`Тикет #${l}: отсутствует дата обновления`)})}return{isValid:s.length===0,errors:s,warnings:t}}static validateSectorData(e){const s=[],t=[];return!e||typeof e!="object"?(s.push("sectorData должен быть объектом"),{isValid:!1,errors:s,warnings:t}):(Array.isArray(e.stages)||s.push("stages должен быть массивом"),Array.isArray(e.employees)||s.push("employees должен быть массивом"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&s.push("zeroPointTickets должен быть объектом"),{isValid:s.length===0,errors:s,warnings:t})}static isValidISODate(e){if(typeof e!="string")return!1;const s=new Date(e);return!isNaN(s.getTime())&&e.includes("T")}static async deleteSnapshot(e,s){try{const t=this.formatDate(e),i=`${this.getApiBaseUrl()}${ht.snapshotsEndpoint}`,n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:t,type:s})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();if(!l.success)throw new Error(l.message||"Ошибка удаления слепка");return!0}catch(t){throw console.error("SnapshotService.deleteSnapshot error:",t),t}}static async deleteSnapshotsByPeriod(e){try{const s=await this.getAllSnapshots(e);let t=0;for(const r of s)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&t++}catch(i){console.warn(`Ошибка удаления слепка ${r.metadata.createdAt}:`,i)}return t}catch(s){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",s),s}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,s=ht.snapshotVersion){const t=this.getSnapshotVersion(e);return t===s||t==="1.0"&&s==="1.0"?e:(console.warn(`Миграция с версии ${t} на ${s} пока не реализована`),{...e,metadata:{...e.metadata,version:s}})}static getWeekNumberInfo(e){const s=typeof e=="string"?new Date(e):e,t=this.getWeekNumber(s);return{year:s.getFullYear(),week:t}}static getWeekStartDate(e){const s=typeof e=="string"?new Date(e):e,r=(s.getDay()||7)-1,i=new Date(s);return i.setDate(s.getDate()-r),i.setHours(0,0,0,0),i}static getWeekEndDate(e){const s=typeof e=="string"?new Date(e):e,r=7-(s.getDay()||7),i=new Date(s);return i.setDate(s.getDate()+r),i.setHours(23,59,59,999),i}static async getSnapshotsForWeek(e){try{const s=this.getWeekStartDate(e),t=this.getWeekEndDate(e),r=this.getWeekNumberInfo(e),i=await this.getAllSnapshots({startDate:s,endDate:t}),n=i.find(m=>m.metadata.type==="week_start")||null,l=i.find(m=>m.metadata.type==="week_end")||null,u=i.filter(m=>m.metadata.type==="manual");return{weekStart:n,weekEnd:l,manual:u,weekInfo:r}}catch(s){throw console.error("SnapshotService.getSnapshotsForWeek error:",s),s}}static handleError(e){if(e instanceof St)return{message:e.message,code:e.code,details:e.details};let s="UNKNOWN_ERROR";return e.message.includes("валидац")?s="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("не найден")?s="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?s="API_ERROR":e.message.includes("версия")||e.message.includes("version")?s="VERSION_MISMATCH":(e.message.includes("доступ")||e.message.includes("permission"))&&(s="PERMISSION_DENIED"),{message:e.message||"Неизвестная ошибка",code:s,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const s=await this.getAllSnapshots(e),t={week_start:0,week_end:0,manual:0,current:0},r=new Map;let i=null,n=null;s.forEach(u=>{const m=u.metadata.type;t.hasOwnProperty(m)&&t[m]++;const v=this.getWeekNumberInfo(u.metadata.createdAt),T=`${v.year}-W${v.week}`;r.set(T,(r.get(T)||0)+1);const f=new Date(u.metadata.createdAt);(!i||f<new Date(i.metadata.createdAt))&&(i=u),(!n||f>new Date(n.metadata.createdAt))&&(n=u)});const l=Array.from(r.entries()).map(([u,m])=>{const[v,T]=u.split("-W");return{year:parseInt(v),week:parseInt(T),count:m}}).sort((u,m)=>u.year!==m.year?u.year-m.year:u.week-m.week);return{total:s.length,byType:t,byWeek:l,oldest:i,newest:n}}catch(s){throw console.error("SnapshotService.getSnapshotsStatistics error:",s),s}}}class St extends Error{constructor(e,s,t={}){super(e),this.name="SnapshotError",this.code=s,this.details=t}}const ft={formed:{bitrixId:Cs.formed,name:ws.FORMED.name},review:{bitrixId:Cs.review,name:ws.REVIEW.name},execution:{bitrixId:Cs.execution,name:ws.EXECUTION.name}},Jt=Zt;function Tl(o){if(!o||typeof o!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!o.stages||!Array.isArray(o.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Sl(o.stages),s=Dl(o.stages),t=El(o.zeroPointTickets||{}),r=Al(o.zeroPointTickets||{}),i=$l(o.stages,o.zeroPointTickets||{});return{statistics:{stages:e,employees:s,zeroPoint:t,zeroPointByStage:r},ticketIds:i.ticketIds,tickets:i.tickets}}function Sl(o){const e={formed:{count:0,stageId:ft.formed.bitrixId,stageName:ft.formed.name},review:{count:0,stageId:ft.review.bitrixId,stageName:ft.review.name},execution:{count:0,stageId:ft.execution.bitrixId,stageName:ft.execution.name},total:0};return o.forEach(s=>{if(!ft[s.id]){console.warn(`Unknown stage ID: ${s.id}`);return}let t=0;s.employees&&Array.isArray(s.employees)&&s.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(t+=r.tickets.length)}),e[s.id].count=t,e.total+=t}),e}function Dl(o){const e=new Map;return o.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(t=>{if(!t||!t.id)return;e.has(t.id)||e.set(t.id,{id:t.id,name:t.name||`Сотрудник #${t.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=e.get(t.id),i=t.tickets&&Array.isArray(t.tickets)?t.tickets.length:0;ft[s.id]&&(r.ticketsByStage[s.id]=(r.ticketsByStage[s.id]||0)+i),r.totalTickets+=i})}),Array.from(e.values())}function El(o){let e=0,s=0;return!o||typeof o!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(o).forEach(t=>{Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e++:(typeof i=="object"?i.id:i)===Jt?s++:e++})}),{unassigned:e,keeper:s,total:e+s})}function Al(o){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!o||typeof o!="object"||Object.keys(e).forEach(s=>{const t=o[s];Array.isArray(t)&&t.forEach(r=>{if(!r)return;const i=r.assignedTo||r.assignedById;!i||i===null?e[s].unassigned++:(typeof i=="object"?i.id:i)===Jt?e[s].keeper++:e[s].unassigned++,e[s].total++})}),e}function $l(o,e){const s=new Set,t=new Map;return Array.isArray(o)&&o.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(i=>{!i.tickets||!Array.isArray(i.tickets)||i.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const l=parseInt(n.id);if(isNaN(l)){console.warn("Invalid ticket ID:",n.id);return}s.add(l);let u=n.assignedTo;!u&&i.id&&(u={id:i.id,name:i.name||`Сотрудник #${i.id}`}),t.set(l,{id:l,title:n.title||"Без названия",assignedTo:u||null,createdAt:ns(n.createdAt||n.createdTime),updatedAt:ns(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||r.id||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(r=>{Array.isArray(r)&&r.forEach(i=>{if(!i||!i.id){console.warn("Ticket without ID found in zero point:",i);return}const n=parseInt(i.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",i.id);return}s.add(n);let l=i.assignedTo;if(!l&&i.assignedById){const u=typeof i.assignedById=="object"?i.assignedById.id||i.assignedById.value:i.assignedById;u&&u!==Jt?l={id:u,name:"Неизвестный"}:u===Jt&&(l={id:Jt,name:"Хранитель объектов"})}t.set(n,{id:n,title:i.title||"Без названия",assignedTo:l||null,createdAt:ns(i.createdAt||i.createdTime),updatedAt:ns(i.updatedAt||i.modifiedAt||i.updatedTime),stageId:i.stageId||null,departmentHead:i.departmentHead||null,departmentHeadFull:i.departmentHeadFull||i.departmentHead||null,priorityId:i.priorityId||null,priorityLabel:i.priorityLabel||null,service:i.service||null,serviceLabel:i.serviceLabel||null})})}),{ticketIds:Array.from(s).sort((r,i)=>r-i),tickets:Array.from(t.values())}}function ns(o){if(!o)return null;if(o instanceof Date)return o.toISOString();if(typeof o=="string"){if(o.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return o;const e=new Date(o);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",o),null}class Ws{static async getSectorDataForSnapshot(e={}){const{useCache:s=!0,useBackendCache:t=!1,onProgress:r=null,normalize:i=!0,includeTicketDetails:n=!1}=e;try{const l=await Bt.getSectorData(s,t,r);return i?Tl(l):(n&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const e=await Bt.getSectorData(!0);return e!=null}catch{return!1}}}class Es{static compareTwoSnapshots(e,s,t={}){const{includeTickets:r=!1,includeEmployees:i=!0}=t,n=this.validateSnapshot(e),l=this.validateSnapshot(s);if(!n.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...l.errors].join(", "));const u=this.buildComparisonMetadata(e,s),m=this.compareStages(e.statistics.stages,s.statistics.stages),v=i?this.compareEmployees(e.statistics.employees||[],s.statistics.employees||[]):[],T=this.compareZeroPoint(e.statistics.zeroPoint||{},s.statistics.zeroPoint||{}),f=r?this.compareTickets(e.ticketIds||[],s.ticketIds||[],e.tickets||[],s.tickets||[]):null,k=this.buildSummary(m,v,T,f);return{metadata:u,stages:m,employees:v,zeroPoint:T,tickets:f,summary:k}}static calculateDelta(e,s){const t=this.normalizeValue(e),r=this.normalizeValue(s),i=r-t;let n=0;t!==0?n=i/t*100:r!==0&&(n=r>0?1/0:-1/0);const l=this.getTrend(i);return{value1:t,value2:r,delta:i,deltaPercent:Math.round(n*100)/100,trend:l}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,s){const t=["formed","review","execution"],r={};for(const l of t){const u=e[l]?.count||0,m=s[l]?.count||0;r[l]=this.calculateDelta(u,m)}const i=e.total||0,n=s.total||0;return r.total=this.calculateDelta(i,n),r}static compareEmployees(e,s){const t=new Map(e.map(l=>[l.id,l])),r=new Map(s.map(l=>[l.id,l])),i=new Set([...t.keys(),...r.keys()]),n=[];for(const l of i){const u=t.get(l)||null,m=r.get(l)||null;if(!u||!m){n.push({id:l,name:u?.name||m?.name||"Неизвестный",snapshot1:u?{ticketsByStage:u.ticketsByStage||{},totalTickets:u.totalTickets||0}:null,snapshot2:m?{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0}:null,delta:this.calculateEmployeeDelta(u,m),trend:u?"removed":"new"});continue}const v={},T=["formed","review","execution"];for(const k of T){const p=u.ticketsByStage?.[k]||0,S=m.ticketsByStage?.[k]||0;v[k]=this.calculateDelta(p,S)}const f=this.calculateDelta(u.totalTickets||0,m.totalTickets||0);n.push({id:l,name:u.name,snapshot1:{ticketsByStage:u.ticketsByStage||{},totalTickets:u.totalTickets||0},snapshot2:{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0},delta:{ticketsByStage:v,totalTickets:f},trend:f.trend})}return n}static calculateEmployeeDelta(e,s){if(!e&&!s)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const t={},r=["formed","review","execution"];for(const n of r){const l=e?.ticketsByStage?.[n]||0,u=s?.ticketsByStage?.[n]||0;t[n]=this.calculateDelta(l,u)}const i=this.calculateDelta(e?.totalTickets||0,s?.totalTickets||0);return{ticketsByStage:t,totalTickets:i}}static compareZeroPoint(e,s){return{unassigned:this.calculateDelta(e?.unassigned||0,s?.unassigned||0),keeper:this.calculateDelta(e?.keeper||0,s?.keeper||0),total:this.calculateDelta(e?.total||0,s?.total||0)}}static compareTickets(e,s,t,r){const i=new Set(e),n=new Set(s),l=s.filter(k=>!i.has(k)),u=e.filter(k=>!n.has(k)),m=[],v=[],T=new Map(t.map(k=>[k.id,k])),f=new Map(r.map(k=>[k.id,k]));for(const k of e){if(!n.has(k))continue;const p=T.get(k),S=f.get(k);if(!p||!S)continue;const C=(p.assignedTo?.id||null)!==(S.assignedTo?.id||null),y=(p.stageId||null)!==(S.stageId||null);C||y?m.push(k):v.push(k)}return{new:l,removed:u,changed:m,unchanged:v}}static buildComparisonMetadata(e,s){const t=new Date(e.metadata.createdAt),r=new Date(s.metadata.createdAt),i=new Date,n=r.getTime()-t.getTime(),l=Math.floor(n/(1e3*60*60*24)),u=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),m=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:s.metadata.createdAt,comparisonDate:i.toISOString(),timeDiff:{days:l,hours:u,minutes:m,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,s,t,r){const i=e.total.delta,n=Object.keys(e).filter(m=>m==="total"?!1:e[m].delta!==0).length,l=s.filter(m=>m.trend==="new"||m.trend==="removed"?!0:m.delta.totalTickets.delta!==0).length,u=i!==0||n>0||l>0;return{totalDelta:i,stagesChanged:n,employeesChanged:l,hasChanges:u,newTicketsCount:r?.new?.length||0,removedTicketsCount:r?.removed?.length||0,changedTicketsCount:r?.changed?.length||0}}static validateSnapshot(e){const s=[],t=[];if(!e)return s.push("Snapshot is null or undefined"),{valid:!1,errors:s,warnings:t};if(e.metadata?(e.metadata.createdAt||s.push("Missing metadata.createdAt"),e.metadata.type||s.push("Missing metadata.type")):s.push("Missing metadata field"),!e.statistics)s.push("Missing statistics field");else{if(!e.statistics.stages)s.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const i of r)e.statistics.stages[i]||t.push(`Missing stage: ${i}`)}e.statistics.employees||t.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||t.push("Missing statistics.zeroPoint")}return{valid:s.length===0,errors:s,warnings:t}}static compareMultipleSnapshots(e,s={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const l=this.validateSnapshot(n);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const t=[...e].sort((n,l)=>{const u=new Date(n.metadata.createdAt),m=new Date(l.metadata.createdAt);return u-m}),r=[];for(let n=0;n<t.length-1;n++)r.push({from:n,to:n+1,result:this.compareTwoSnapshots(t[n],t[n+1],s)});const i=this.buildTrends(t);return{snapshots:t.map((n,l)=>({index:l,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:r,trends:i}}static buildTrends(e){const s={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const t of e){const r=t.statistics;s.stages.formed.push(r.stages?.formed?.count||0),s.stages.review.push(r.stages?.review?.count||0),s.stages.execution.push(r.stages?.execution?.count||0),s.stages.total.push(r.stages?.total||0),s.zeroPoint.unassigned.push(r.zeroPoint?.unassigned||0),s.zeroPoint.keeper.push(r.zeroPoint?.keeper||0),s.zeroPoint.total.push(r.zeroPoint?.total||0)}return s}}const Il={class:"stages-container"},Ml={class:"stages-chips"},Nl=["checked","disabled","onChange"],xl={class:"stage-chip-label"},Pl={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:o=>o.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(o,{emit:e}){const s=o,t=e;function r(i,n){const l={...s.selected};l[i]=n,t("update:selected",l),t("change",i,n)}return(i,n)=>(c(),d("div",Il,[n[0]||(n[0]=a("h4",{class:"stages-title"},"Этапы для отображения:",-1)),a("div",Ml,[(c(!0),d(ee,null,te(o.stages,l=>(c(),d("label",{key:l.id,class:X(["stage-chip",{"stage-chip--active":o.selected[l.id],"stage-chip--disabled":o.disabled}])},[a("input",{type:"checkbox",checked:o.selected[l.id],disabled:o.disabled,onChange:u=>r(l.id,u.target.checked)},null,40,Nl),a("span",{class:"stage-chip-color",style:we({backgroundColor:l.color})},null,4),a("span",xl,g(l.name),1)],2))),128))])]))}},Ll=de(Pl,[["__scopeId","data-v-fe03c03c"]]),Ol={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(o,{emit:e}){const s=I(!1),t=M(()=>!1),r={color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d"},i={color:"#ced4da",backgroundColor:"#f8f9fa",textColor:"#6c757d"},n={color:"#dee2e6",backgroundColor:"#f8f9fa",textColor:"#6c757d"},l=M(()=>({label:o.ticket.priorityLabel||"Не указано",colors:o.ticket.priorityColors||r})),u=M(()=>l.value.label||"Не указано"),m=M(()=>({color:l.value.colors.textColor||r.textColor,backgroundColor:l.value.colors.backgroundColor||r.backgroundColor,borderColor:l.value.colors.color||r.color})),v=M(()=>({borderLeftColor:l.value.colors.color||r.color})),T=M(()=>{const E=o.ticket.service||{};return{label:E.label||o.ticket.serviceLabel||"Не указано",colors:E.colors||o.ticket.serviceColors||i}}),f=M(()=>T.value.label||"Не указано"),k=M(()=>({color:T.value.colors.textColor||i.textColor,backgroundColor:T.value.colors.backgroundColor||i.backgroundColor,borderColor:T.value.colors.color||i.color})),p=M(()=>{const E=o.ticket.actionStr||o.ticket.ufActionStr||null;if(!E)return null;const P=String(E).trim();return P.length>0?P:null}),S=M(()=>({color:n.textColor,backgroundColor:n.backgroundColor,borderColor:n.color})),C=M(()=>{if(!o.ticket.createdAt)return"";const E=Zs(o.ticket.createdAt);return E?po(E):""}),y=M(()=>{if(!o.ticket.createdAt)return null;const E=Zs(o.ticket.createdAt);return yo(E)}),_=M(()=>{const E=y.value;return E&&ko[E]||null}),A=M(()=>{const E=_.value;return E?{color:E.textColor,backgroundColor:E.backgroundColor,borderColor:E.color,border:`1px solid ${E.color}`}:{}});return{handleDragStart:E=>{t.value&&(E.dataTransfer.effectAllowed="move",E.dataTransfer.setData("application/json",JSON.stringify(o.ticket)),E.dataTransfer.setDragImage(E.target,0,0),s.value=!0,e("drag-start",o.ticket))},handleDragEnd:()=>{t.value&&(s.value=!1,e("drag-end"))},handleCardClick:E=>{if(s.value)return;const P=Qt(o.ticket.id);window.open(P,"_blank"),e("click",o.ticket)},isDragEnabled:t,priorityChipStyle:m,displayPriorityLabel:u,priorityBorderStyle:v,displayServiceLabel:f,serviceChipStyle:k,actionStrValue:p,actionChipStyle:S,formattedCreatedDate:C,dateAccentCategory:y,dateAccentConfig:_,dateAccentStyle:A}}},Bl=["draggable"],Rl={key:0,class:"ticket-department"},Wl={class:"ticket-header"},Ul={class:"ticket-id"},Fl={class:"ticket-title"},Hl={class:"ticket-meta"},jl={key:1,class:"ticket-action"},Vl={key:2,class:"ticket-description"},zl={class:"ticket-date-label"},Gl={class:"ticket-date-value"};function Kl(o,e,s,t,r,i){return c(),d("div",{class:"ticket-card",draggable:t.isDragEnabled,style:we(t.priorityBorderStyle),onClick:e[0]||(e[0]=(...n)=>t.handleCardClick&&t.handleCardClick(...n)),onDragstart:e[1]||(e[1]=(...n)=>t.handleDragStart&&t.handleDragStart(...n)),onDragend:e[2]||(e[2]=(...n)=>t.handleDragEnd&&t.handleDragEnd(...n))},[s.ticket.departmentHead?(c(),d("div",Rl,g(s.ticket.departmentHead),1)):$("",!0),a("div",Wl,[e[3]||(e[3]=a("span",{class:"ticket-icon"},"🎫",-1)),a("span",Ul,"#"+g(s.ticket.id),1)]),a("div",Fl,g(s.ticket.ufSubject||s.ticket.title||"Без названия"),1),a("div",Hl,[a("span",{class:"ticket-priority",style:we(t.priorityChipStyle)},g(t.displayPriorityLabel),5),a("span",{class:"ticket-service",style:we(t.serviceChipStyle)},g(t.displayServiceLabel),5)]),t.actionStrValue?(c(),d("div",jl,[a("span",{class:"ticket-action-chip",style:we(t.actionChipStyle)},g(t.actionStrValue),5)])):$("",!0),s.ticket.description?(c(),d("div",Vl,g(s.ticket.description),1)):$("",!0),t.formattedCreatedDate?(c(),d("div",{key:3,class:"ticket-created-date",style:we(t.dateAccentStyle)},[a("span",zl,g(t.dateAccentConfig?.label||""),1),a("span",Gl,g(t.formattedCreatedDate),1)],4)):$("",!0)],44,Bl)}const Ct=de(Ol,[["render",Kl],["__scopeId","data-v-9cda001c"]]),Ft=10;function ms(o,e){if(!e||!e.statistics)return[];const s=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(r=>r.ticketsByStage&&r.ticketsByStage[o]>0).forEach(r=>{s.push({id:r.id,name:r.name,count:r.ticketsByStage[o]||0})});const t=ql(o,e);return t>0&&s.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:t,isKeeper:!0}),s.sort((r,i)=>i.count-r.count)}function ql(o,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[o])return e.statistics.zeroPointByStage[o].keeper||0;if(e.statistics.zeroPoint){const s=e.statistics.zeroPoint.keeper||0;return Math.floor(s/3)}return 0}function Pa(o,e){return!e||!e.statistics||!e.statistics.stages?0:e.statistics.stages[o]?.count||0}function gs(o,e=Ft){if(!o||o.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const s=[...o].sort((n,l)=>l.count-n.count),t=s.slice(0,e),r=s.slice(e),i=r.reduce((n,l)=>n+l.count,0);return{visible:t,others:{employees:r,count:i,employeeCount:r.length}}}function La(o,e){return!o||o.length===0?[]:e===0?o.map(s=>({...s,percentage:0})):o.map(s=>({...s,percentage:parseFloat((s.count/e*100).toFixed(1))}))}function ts(o,e,s="#007bff",t=Ft){if(!o||o.length===0)return{employees:[],others:null};const{visible:r,others:i}=gs(o,t),n=La(r,e).map(u=>({...u,progressBarWidth:u.percentage,progressBarColor:u.isKeeper?"#f59e0b":s}));let l=null;if(i.count>0){const u=parseFloat((i.count/e*100).toFixed(1));l={...i,percentage:u,progressBarWidth:u,progressBarColor:"#6c757d"}}return{employees:n,others:l}}function Yl(o,e){const s={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(r=>{const i=e[r];if(!i)return;const n=ms(o,i),l=Pa(o,i);if(n.length===0)return;const{visible:u,others:m}=gs(n,Ft),v=La(u,l);s[r]=v,m.count>0&&(s.others[r]={count:m.count,employeeCount:m.employeeCount,percentage:parseFloat((m.count/l*100).toFixed(1))})}),s}function Xl(o,e="current",s=[]){const t=o[e];if(!t)return{labels:[],datasets:[]};const r=new Map;s.forEach(T=>{ms(T.id,t).forEach(k=>{r.has(k.id)||r.set(k.id,{id:k.id,name:k.name,isKeeper:k.isKeeper||!1,ticketsByStage:{}}),r.get(k.id).ticketsByStage[T.id]=k.count})});const i=Array.from(r.values()).map(T=>{const f=Object.values(T.ticketsByStage).reduce((k,p)=>k+p,0);return{...T,totalTickets:f}});i.sort((T,f)=>f.totalTickets-T.totalTickets);const{visible:n,others:l}=gs(i,Ft),u=s.map(()=>""),m={};s.forEach(T=>{const f=ms(T.id,t),{visible:k}=gs(f,Ft);m[T.id]=k.map(p=>({id:p.id,name:p.name,count:p.count}))});const v=n.map((T,f)=>{const k=s.map(S=>T.ticketsByStage[S.id]||0),p=s.map(S=>{if((T.ticketsByStage[S.id]||0)===0)return"transparent";const _=S.color.replace("#",""),A=parseInt(_.substring(0,2),16),W=parseInt(_.substring(2,4),16),x=parseInt(_.substring(4,6),16),D=.6+f*.05;return`rgba(${A}, ${W}, ${x}, ${Math.min(D,.95)})`});return{label:T.name,data:k,backgroundColor:p,borderColor:s.map(S=>{const C=S.color.replace("#",""),y=parseInt(C.substring(0,2),16),_=parseInt(C.substring(2,4),16),A=parseInt(C.substring(4,6),16);return`rgba(${y}, ${_}, ${A}, 0.8)`}),borderWidth:1,meta:{employeeId:T.id,employeeName:T.name}}});if(l.count>0){const T=s.map(f=>l.employees.reduce((k,p)=>k+(p.ticketsByStage[f.id]||0),0));v.push({label:`Другие (${l.employeeCount})`,data:T,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:u,datasets:v,meta:{employeesByStage:m}}}function Jl(o,e,s=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const t=s.find(m=>m.id===o),r=t?t.name:"",i=t?t.color:"#007bff",n=ms(o,e),l=Pa(o,e);if(n.length===0)return{stageName:r,totalCount:0,employees:[],others:null};const u=ts(n,l,i,Ft);return{stageName:r,totalCount:l,employees:u.employees,others:u.others}}function Zl(o,e){return e?.[o]||o}function Ql(o,e){return e?.[o]||"#007bff"}function Us({snapshots:o,graphType:e,timePoint:s,snapshotType:t}){return o?e==="line"&&s?o[s]||null:e==="bar"&&t?o[t]||null:o.current||o.weekEnd||o.weekStart||null:null}function Fs(o,e){return e?.statistics?.stages?.[o]?.count||0}function ec({stageId:o,timePoint:e,meta:s,snapshots:t,stageColor:r,maxVisible:i}){if(!s?.employees||!e)return null;const n=s.employees[e];if(!n||n.length===0)return null;const l=t?.[e]||null,u=Fs(o,l)||n.reduce((v,T)=>v+(T.count||0),0),m=ts(n,u,r,i);return{stageId:o,totalCount:u,employees:m.employees,others:m.others,snapshot:l}}function tc({stageId:o,meta:e,snapshots:s,stageColor:t,maxVisible:r}){const i=e?.employees?.[o];if(!i||!i.employees||i.employees.length===0)return null;const n=Us({snapshots:s,graphType:"doughnut"}),l=i.totalCount??Fs(o,n)??i.employees.reduce((m,v)=>m+(v.count||0),0),u=ts(i.employees,l,t,r);return{stageId:o,totalCount:l,employees:u.employees,others:u.others,snapshot:n}}function sc({stageId:o,meta:e,snapshots:s,stageColor:t,maxVisible:r,snapshotType:i}){const n=e?.employeesByStage?.[o];if(!n||n.length===0)return null;const l=Us({snapshots:s,graphType:"bar",snapshotType:i}),u=Fs(o,l)||n.reduce((v,T)=>v+(T.count||0),0),m=ts(n,u,t,r);return{stageId:o,totalCount:u,employees:m.employees,others:m.others,snapshot:l}}async function Oa({stageId:o,graphType:e,timePoint:s=null,snapshotType:t=null,snapshots:r=null,meta:i=null,stageColorMap:n=null,stageNameMap:l=null,maxVisible:u=10,restLoader:m=null}){if(!o)throw new Error("stageId обязателен для загрузки данных уровня 1");const v=Zl(o,l),T=Ql(o,n);let f=null;if(e==="line"?f=ec({stageId:o,timePoint:s,meta:i?.line,snapshots:r,stageColor:T,maxVisible:u}):e==="doughnut"?f=tc({stageId:o,meta:i?.doughnut,snapshots:r,stageColor:T,maxVisible:u}):e==="bar"&&(f=sc({stageId:o,meta:i?.bar,snapshots:r,stageColor:T,maxVisible:u,snapshotType:t})),f)return{stageId:o,stageName:v,color:T,totalCount:f.totalCount,employees:f.employees,others:f.others,snapshot:f.snapshot};if(typeof m=="function"){const k=await m({stageId:o,graphType:e,timePoint:s,snapshotType:t,snapshots:r});if(k&&Array.isArray(k.employees)){const p=k.totalCount??k.employees.reduce((C,y)=>C+(y.count||0),0),S=ts(k.employees,p,T,u);return{stageId:o,stageName:v,color:T,totalCount:p,employees:S.employees,others:S.others,snapshot:k.snapshot||Us({snapshots:r,graphType:e,timePoint:s,snapshotType:t})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const ac={key:"level-1",class:"level-1"},oc={class:"modal-header"},nc={class:"stage-header"},rc=["aria-expanded","onKeydown"],ic={class:"stage-title"},lc=["aria-selected","onClick","onKeydown"],cc={class:"stage-name"},dc={class:"modal-total"},uc={class:"view-switcher"},mc={class:"modal-body"},gc={key:0,class:"load-error"},hc={key:1,class:"stage-loader"},fc={key:2},vc={key:0,class:"no-employees"},pc={key:1,class:"employees-list"},yc=["onClick"],kc={class:"employee-name"},bc={class:"employee-progress"},_c={class:"employee-count"},wc={key:0,class:"employee-item employee-others"},Cc={class:"employee-name"},Tc={class:"employee-progress"},Sc={class:"employee-count"},Dc={key:3,class:"view-time"},Ec={key:0,class:"no-data"},Ac={key:1,class:"date-categories-list"},$c=["onClick"],Ic={class:"category-label"},Mc={class:"category-progress"},Nc={class:"category-count"},xc={key:4,class:"view-departments"},Pc={key:0,class:"no-data"},Lc={key:1,class:"departments-table-container"},Oc={class:"departments-table"},Bc=["onClick"],Rc={class:"col-department"},Wc={class:"department-name"},Uc={class:"col-count"},Fc={class:"count-value"},Hc={key:"level-2",class:"level-2"},jc={class:"modal-header"},Vc={class:"modal-total"},zc={class:"modal-body"},Gc={class:"stage-info level2-stage-row"},Kc={class:"stage-badge"},qc={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},Yc={key:0},Xc={key:0,class:"no-data"},Jc={key:1,class:"date-categories-list"},Zc=["onClick"],Qc={class:"category-label"},ed={class:"category-progress"},td={class:"category-count"},sd={key:1,class:"view-departments"},ad={key:0,class:"no-data"},od={key:1,class:"departments-table-container"},nd={class:"departments-table"},rd=["onClick"],id={class:"col-department"},ld={class:"department-name"},cd={class:"col-count"},dd={class:"count-value"},ud={key:"level-3",class:"level-3"},md={class:"modal-header"},gd={class:"header-info"},hd={class:"header-badges"},fd={class:"date-badge"},vd={class:"stage-badge"},pd={class:"modal-total"},yd={class:"modal-body"},kd={key:0,class:"no-data"},bd={key:1,class:"departments-table-container"},_d={class:"departments-table"},wd=["onClick"],Cd={class:"col-department"},Td={class:"department-name"},Sd={class:"col-count"},Dd={class:"count-value"},Ed={key:"level-4",class:"level-4"},Ad={class:"modal-header"},$d={class:"header-info"},Id={key:0,class:"header-badges"},Md={key:0,class:"date-badge"},Nd={key:1,class:"department-badge"},xd={class:"stage-badge"},Pd={class:"modal-total"},Ld={class:"modal-body"},Od={key:"loading",class:"loading-state"},Bd={key:"error-fallback",class:"error-state-with-fallback"},Rd={class:"tickets-list-container"},Wd={key:"error",class:"error-state"},Ud={class:"error-message"},Fd={key:"empty",class:"empty-state"},Hd={class:"empty-state-title"},jd={class:"empty-state-message"},Vd={key:"tickets",class:"tickets-list-container"},zd={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(o,{expose:e,emit:s}){const t=o,r=s,i=lt(),n=I(1),l=I("time"),u=I("employees"),m=I(null),v=I([]),T=I([]),f=I(null),k=I(null),p=I(null),S=I(t.stageSwitchContext||null),C=I(!1),y=I(null),_=I(null),A=I(!1),W=I(null),x=I(null),D=M(()=>{const z=S.value?.stageNameMap||{},N=S.value?.stageColorMap||{};return Object.keys(z).map(b=>({id:b,name:z[b],color:N[b]||"#007bff",disabled:b===(m.value?.stageId||t.stageId)}))});M(()=>n.value>1);const E=M(()=>{switch(n.value){case 1:return m.value?.stageName||t.stageName;case 2:return f.value?.employeeName||"";case 3:return`${f.value?.employeeName||""} — ${k.value?.dateCategoryLabel||""}`;case 4:if(!p.value?.context)return"Список тикетов";const z=p.value.context,N=[];return z.employeeName&&N.push(z.employeeName),z.dateCategoryLabel&&N.push(z.dateCategoryLabel),z.departmentName&&N.push(z.departmentName),z.stageName&&N.push(z.stageName),N.length>0?N.join(" — "):"Список тикетов";default:return""}});function P(){console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employeesCount:t.employees?.length||0,hasSnapshot:!!t.snapshot,snapshotTicketIds:t.snapshot?.ticketIds?.length||0,hasTicketDetails:!!t.ticketDetails,snapshotKeys:t.snapshot?Object.keys(t.snapshot):[]}),m.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:m.value.stageId,hasSnapshot:!!m.value.snapshot,employeesCount:m.value.employees.length,snapshotType:m.value.snapshot?typeof m.value.snapshot:"null"}),f.value=null,k.value=null,p.value=null,n.value=1,l.value="time",u.value="employees",B(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function B(){if(!m.value||!m.value.snapshot||!m.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const z=m.value.snapshot.tickets||[],N=m.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:z.length,currentStageId:N,sampleTicket:z[0]?{id:z[0].id,stageId:z[0].stageId,hasDepartmentHead:!!z[0].departmentHead,departmentHead:z[0].departmentHead,hasDepartmentHeadFull:!!z[0].departmentHeadFull,departmentHeadFull:z[0].departmentHeadFull,allKeys:Object.keys(z[0])}:null});let b=z.filter(K=>K.stageId?Yt(K.stageId)===N:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:z.length,afterFilter:b.length,stageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length});const O=b.filter(K=>!K.departmentHead&&!K.departmentHeadFull);if(O.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:O.length,totalTickets:b.length,ticketsWithDepartment:b.filter(j=>j.departmentHead||j.departmentHeadFull).length});const K=O.map(j=>j.id).filter(j=>j);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:K.length,ticketIdsSample:K.slice(0,10)});const j=await _o.getTicketsDetails(K),V=new Map;j.forEach(F=>{F&&F.id&&V.set(F.id,F)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:j.length,detailsMapSize:V.size,sampleDetail:j[0]?{id:j[0].id,departmentHead:j[0].departmentHead,departmentHeadFull:j[0].departmentHeadFull}:null}),b=b.map(F=>{const ie=V.get(F.id);return ie?{...F,stageId:ie.stageId||F.stageId||null,departmentHead:ie.departmentHead||F.departmentHead||null,departmentHeadFull:ie.departmentHeadFull||ie.departmentHead||F.departmentHead||null}:F}),b=b.filter(F=>F.stageId?Yt(F.stageId)===N:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:b.length,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,ticketsWithStageId:b.filter(F=>F.stageId).length,ticketsWithoutStageId:b.filter(F=>!F.stageId).length});const se=b.length,me=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));b=b.filter(F=>F.stageId?Yt(F.stageId)===N:!0);const ye=b.slice(0,3).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,stageId:F.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:se,afterStageFilter:b.length,filteredOut:se-b.length,currentStageId:N,ticketsWithDepartment:b.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,sampleBeforeFilter:me,sampleAfterFilter:ye,sampleWithDepartment:b.find(F=>F.departmentHead||F.departmentHeadFull)?{id:b.find(F=>F.departmentHead||F.departmentHeadFull).id,departmentHead:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHead,departmentHeadFull:b.find(F=>F.departmentHead||F.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(b.find(F=>F.departmentHead||F.departmentHeadFull)).filter(F=>F.toLowerCase().includes("department"))}:null})}catch(j){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",j),console.error("[EmployeeDetailsModal] Error details:",{message:j.message,stack:j.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:b.length,currentStageId:N,ticketsWithStageId:b.filter(K=>K.stageId).length,ticketsWithoutStageId:b.filter(K=>!K.stageId).length,ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const Q=Qs(b);v.value=Q,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:b.length,sampleTickets:b.slice(0,5).map(K=>({id:K.id,departmentHead:K.departmentHead,departmentHeadFull:K.departmentHeadFull,hasDepartmentHead:!!K.departmentHead,hasDepartmentHeadFull:!!K.departmentHeadFull,allKeys:Object.keys(K).filter(j=>j.toLowerCase().includes("department"))})),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length});const ue=ea(b);T.value=ue;const ke=Q.reduce((K,j)=>K+j.count,0),_e=ue.reduce((K,j)=>K+j.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:N,totalTicketsForGrouping:b.length,timeCategoriesCount:Q.length,totalTicketsInTimeCategories:ke,departmentsCount:ue.length,totalTicketsInDepartments:_e,departmentsSample:ue.slice(0,5),ticketsWithDepartment:b.filter(K=>K.departmentHead||K.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(K=>!K.departmentHead&&!K.departmentHeadFull).length,consistencyCheck:{totalTickets:b.length,timeCategoriesTotal:ke,departmentsTotal:_e,isConsistent:b.length===ke&&b.length===_e}})}catch(z){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",z),console.error("[EmployeeDetailsModal] Error stack:",z.stack)}}async function U(z){if(!z){i.error("Не указан stageId для загрузки данных");return}if(m.value?.stageId===z)return;if(!S.value){i.error("Нет контекста для смены стадии (stageSwitchContext)");return}C.value=!0,y.value=null;const N=m.value?{...m.value}:null;_.value=N?.stageId||null;try{const b=await Oa({...S.value,stageId:z});m.value={stageId:b.stageId,stageName:b.stageName,stageColor:b.color,totalCount:b.totalCount,employees:b.employees,others:b.others,snapshot:b.snapshot||N?.snapshot||null,ticketDetails:b.ticketDetails||null},f.value=null,k.value=null,p.value=null,n.value=1,l.value="time",u.value="employees",await B()}catch(b){console.error("[EmployeeDetailsModal] Failed to reload stage data:",b),y.value=b?.message||"Не удалось загрузить данные стадии",N&&(m.value=N),i.error(y.value)}finally{C.value=!1}}async function G(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!k.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),i.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:N}=await De(async()=>{const{createContextFromLevel3:O}=await import("./chunk-Cm-sZV4A.js").then(Q=>Q.t);return{createContextFromLevel3:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=await N(k.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function q(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!m.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:N}=await De(async()=>{const{createContextFromLevel1Department:O}=await import("./chunk-Cm-sZV4A.js").then(Q=>Q.t);return{createContextFromLevel1Department:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(m.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:b.stageName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function oe(z){if(!z||z.count===0){i.info(`В категории "${z?.label||"неизвестная"}" нет тикетов`);return}if(!z.tickets||z.tickets.length===0){i.info(`В категории "${z.label}" нет тикетов`);return}if(!m.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),i.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:N}=await De(async()=>{const{createContextFromLevel1Time:O}=await import("./chunk-Cm-sZV4A.js").then(Q=>Q.t);return{createContextFromLevel1Time:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(m.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:b.stageName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}Me(()=>t.isVisible,z=>{z?P():(h(),Se())}),Me(()=>t.stageSwitchContext,z=>{S.value=z},{deep:!0}),Ae(()=>{t.isVisible&&P()});async function Y(z,N=null){if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",z),console.log("[EmployeeDetailsModal] Current popup level:",n.value),N&&N.currentTarget&&(N.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{N.currentTarget&&(N.currentTarget.style.transform="")},150)),!z||!z.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",z);return}if(m.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),m.value={stageName:t.stageName,stageId:t.stageId,totalCount:t.totalCount,employees:t.employees||[],others:t.others||null,snapshot:t.snapshot||null,ticketDetails:t.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:m.value.stageId,stageName:m.value.stageName,hasSnapshot:!!m.value.snapshot,snapshotType:m.value.snapshot?typeof m.value.snapshot:"null",snapshotKeys:m.value.snapshot?Object.keys(m.value.snapshot):[]}),!m.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),i.warning("ID стадии не указан");return}if(!m.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",t.snapshot),i.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",z.id,"stage:",m.value.stageId);const{filterTicketsByDepartment:b}=await De(async()=>{const{filterTicketsByDepartment:ke}=await import("./chunk-Bzh5eqmy.js").then(_e=>_e.l);return{filterTicketsByDepartment:ke}},__vite__mapDeps([3,4]),import.meta.url).then(ke=>ke.LazyServiceLoader.loadTicketListUtils()),O=await bo(z.id,m.value.stageId,m.value.snapshot,m.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",O?.length||0,O),!O||O.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),i.info(`У сотрудника "${z.name}" нет тикетов на стадии "${m.value.stageName}"`);return}const Q=Qs(O);console.log("[EmployeeDetailsModal] Date categories:",Q?.length||0,Q);const ue=ea(O).map(ke=>({...ke,tickets:b(O,ke.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",ue?.length||0,ue),f.value={employeeId:z.id,employeeName:z.name,stageId:m.value.stageId,stageName:m.value.stageName,totalCount:O.length,dateCategories:Q,departments:ue,tickets:O,snapshot:m.value.snapshot,ticketDetails:m.value.ticketDetails},l.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:f.value.employeeName,totalCount:f.value.totalCount,dateCategoriesCount:f.value.dateCategories.length,departmentsCount:f.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",f.value),n.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",n.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",f.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!f.value,employeeName:f.value?.employeeName,dateCategoriesCount:f.value?.dateCategories?.length||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",n.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",f.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(b){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",b),console.error("[EmployeeDetailsModal] Error stack:",b.stack),i.error("Ошибка загрузки данных о тикетах: "+b.message)}}async function H(z){if(!z||z.count===0){i.info(`У заказчика "${z?.departmentName||"неизвестный"}" нет тикетов`);return}if(!f.value){i.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:N}=await De(async()=>{const{createContextFromLevel2Department:O}=await import("./chunk-Cm-sZV4A.js").then(Q=>Q.t);return{createContextFromLevel2Department:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(f.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:b.employeeName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function Z(z){if(!z||z.count===0){i.info(`В категории "${z?.label||"неизвестная"}" нет тикетов`);return}if(!z.tickets||z.tickets.length===0){i.info(`В категории "${z.label}" нет тикетов`);return}if(!f.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),i.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:N}=await De(async()=>{const{createContextFromLevel2:O}=await import("./chunk-Cm-sZV4A.js").then(Q=>Q.t);return{createContextFromLevel2:O}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),b=N(f.value,z);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await fe(b)}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",N),i.error("Ошибка перехода на список тикетов: "+N.message)}}async function fe(z){if(console.time("[Performance] goToLevel4"),!z){console.error("[EmployeeDetailsModal] Context is required for level 4"),i.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:z.sourceLevel,employeeId:z.employeeId,stageId:z.stageId,dateCategory:z.dateCategory,departmentName:z.departmentName,ticketsCount:z.tickets?.length||0});try{p.value={context:z,tickets:[],totalCount:0,isLoading:!0,error:null};let N=z.tickets||[];if(N.length===0&&z.snapshot){const{filterTicketsByContext:O}=await De(async()=>{const{filterTicketsByContext:Q}=await import("./chunk-Cm-sZV4A.js").then(ue=>ue.t);return{filterTicketsByContext:Q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);N=await O(z)}(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),N=z.tickets||[]),(!N||N.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),z.snapshot&&z.snapshot.tickets&&(N=z.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",N.length)));let b=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:O}=await De(async()=>{const{prepareTicketsForDisplay:Q}=await import("./chunk-Cm-sZV4A.js").then(ue=>ue.t);return{prepareTicketsForDisplay:Q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);b=await O(N,z.snapshot,z.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(O){console.error("[EmployeeDetailsModal] Error preparing tickets:",O),console.timeEnd("[Performance] prepareTicketsForDisplay"),b=N||[],i.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:N.length,preparedCount:b.length}),p.value={context:z,tickets:b,totalCount:b.length,isLoading:!1,error:null},n.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:p.value.totalCount,ticketsCount:p.value.tickets.length,isLoading:p.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(N){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,context:z});let b=[];if(z.snapshot&&z.snapshot.tickets)try{const O=z.stageId;O?b=(z.snapshot.tickets||[]).filter(Q=>Q.stageId===O):b=z.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",b.length)}catch(O){console.error("[EmployeeDetailsModal] Error using fallback tickets:",O)}p.value={context:z,tickets:b,totalCount:b.length,isLoading:!1,error:{message:N.message,hasFallback:b.length>0}},b.length>0?(i.warning("Ошибка загрузки данных. Отображаются данные из кеша."),n.value=4):(i.error("Ошибка загрузки тикетов: "+N.message),L()),console.timeEnd("[Performance] goToLevel4")}}function L(){if(n.value===4){if(p.value&&p.value.context){const z=p.value.context.sourceLevel;n.value=z}else n.value=1;p.value=null}else n.value===3?(n.value=2,k.value=null,p.value=null):n.value===2&&(n.value=1,f.value=null,k.value=null,p.value=null)}function h(){n.value=1,m.value=null,f.value=null,k.value=null,p.value=null,l.value="time"}function w(){if(!p.value?.context)return"Нет тикетов";const{sourceLevel:z,employeeName:N,dateCategoryLabel:b,departmentName:O}=p.value.context;return z===2&&N&&b?`Нет тикетов у ${N} в категории "${b}"`:z===2&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:z===3&&N&&O?`Нет тикетов у ${N} у заказчика "${O}"`:z===1&&b?`Нет тикетов в категории "${b}"`:z===1&&O?`Нет тикетов у заказчика "${O}"`:"Нет тикетов для отображения"}function R(){if(!p.value?.context)return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:z}=p.value.context;return z?`На стадии "${z}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function re(){if(!p.value?.context){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const z=p.value.context;await fe(z)}function le(z){if(!z){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),i.warning("Ошибка: тикет не найден");return}if(!z.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",z),i.error("Ошибка: ID тикета не указан");return}try{const N=Qt(z.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:z.id,iframeUrl:N}),!N||typeof N!="string"||N.length===0)throw new Error("Не удалось сформировать URL для тикета");const b=window.open(N,"_blank","noopener,noreferrer");if(!b||b.closed||typeof b.closed>"u")try{const O=document.createElement("a");O.href=N,O.target="_blank",O.rel="noopener noreferrer",O.style.display="none",document.body.appendChild(O),O.click(),document.body.removeChild(O),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:z.id,iframeUrl:N})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:z.id,iframeUrl:N})}catch(N){console.error("[EmployeeDetailsModal] Error opening ticket:",N),console.error("[EmployeeDetailsModal] Error details:",{message:N.message,stack:N.stack,ticket:z}),i.error("Ошибка открытия тикета: "+N.message)}}function ae(){h(),r("close")}e({reloadLevel1ForStage:U});function ge(z){z&&z.stopPropagation(),A.value=!A.value}function Se(){A.value&&(A.value=!1)}function $e(z){if(!A.value)return;const N=W.value,b=x.value;N&&N.contains(z.target)||b&&b.contains(z.target)||(A.value=!1)}async function Ne(z){if(z.disabled){A.value=!1;return}A.value=!1,await U(z.id)}function Fe(z){if(A.value){z.stopPropagation(),Se();return}ae()}return(z,N)=>(c(),he($t,{to:"body"},[o.isVisible?(c(),d("div",{key:0,class:"employee-details-modal",onClick:Ce(ae,["self"]),onKeydown:Oe(Fe,["esc"])},[a("div",{class:"modal-content",onClick:$e},[ne(Ee,{name:"level",mode:"out-in"},{default:pe(()=>[n.value===1?(c(),d("div",ac,[a("div",oc,[a("div",nc,[a("button",{ref_key:"stageTriggerRef",ref:x,class:"stage-trigger","aria-expanded":A.value,"aria-haspopup":"listbox",onClick:Ce(ge,["stop"]),onKeydown:[Oe(Ce(ge,["prevent"]),["enter"]),Oe(Ce(ge,["prevent"]),["space"]),Oe(Ce(Se,["stop","prevent"]),["esc"])]},[a("span",{class:"stage-color",style:we({backgroundColor:m.value?.stageColor||S.value?.stageColorMap?.[m.value?.stageId]||S.value?.stageColorMap?.[o.stageId]||"#007bff"})},null,4),a("span",ic,g(m.value?.stageName||o.stageName),1),a("span",{class:X(["stage-caret",{open:A.value}])},"▾",2)],40,rc),A.value?(c(),d("div",{key:0,ref_key:"stageDropdownRef",ref:W,class:"stage-dropdown",role:"listbox"},[(c(!0),d(ee,null,te(D.value,b=>(c(),d("div",{key:b.id,class:X(["stage-option",{disabled:b.disabled}]),role:"option","aria-selected":b.disabled,onClick:Ce(O=>Ne(b),["stop"]),onKeydown:Oe(Ce(O=>Ne(b),["prevent"]),["enter"])},[a("span",{class:"stage-color",style:we({backgroundColor:b.color})},null,4),a("span",cc,g(b.name),1)],42,lc))),128))],512)):$("",!0)]),a("span",dc,"Всего: "+g(m.value?.totalCount||o.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",uc,[a("button",{class:X(["view-switch-btn",{active:u.value==="employees"}]),onClick:N[0]||(N[0]=b=>u.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),a("button",{class:X(["view-switch-btn",{active:u.value==="time"}]),onClick:N[1]||(N[1]=b=>u.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),a("button",{class:X(["view-switch-btn",{active:u.value==="departments"}]),onClick:N[2]||(N[2]=b=>u.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),a("div",mc,[y.value?(c(),d("div",gc,[a("span",null,"Ошибка: "+g(y.value),1),a("button",{class:"btn-retry-stage",onClick:N[3]||(N[3]=b=>U(m.value?.stageId||o.stageId))}," Повторить ")])):$("",!0),C.value?(c(),d("div",hc,[...N[7]||(N[7]=[a("div",{class:"loading-spinner small"},null,-1),a("span",null,"Загрузка стадии...",-1)])])):$("",!0),u.value==="employees"?(c(),d("div",fc,[(m.value?.employees||o.employees).length===0&&(!(m.value?.others||o.others)||(m.value?.others||o.others).count===0)?(c(),d("div",vc," Нет данных о сотрудниках ")):(c(),d("div",pc,[(c(!0),d(ee,null,te(m.value?.employees||o.employees,b=>(c(),d("div",{key:b.id,class:X(["employee-item",{"employee-keeper":b.isKeeper}]),onClick:Ce(O=>Y(b,O),["stop"]),title:"Кликните для детализации по временным градациям"},[a("span",kc,g(b.name),1),a("div",bc,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",_c,g(b.count)+" тикетов ("+g(b.percentage)+"%) ",1),N[8]||(N[8]=a("span",{class:"employee-arrow"},"→",-1))],10,yc))),128)),(m.value?.others||o.others)&&(m.value?.others||o.others).count>0?(c(),d("div",wc,[a("span",Cc,"Другие ("+g((m.value?.others||o.others).employeeCount)+")",1),a("div",Tc,[a("div",{class:"progress-bar",style:we({width:(m.value?.others||o.others).progressBarWidth+"%",backgroundColor:(m.value?.others||o.others).progressBarColor})},null,4)]),a("span",Sc,g((m.value?.others||o.others).count)+" тикетов ("+g((m.value?.others||o.others).percentage)+"%) ",1)])):$("",!0)]))])):u.value==="time"?(c(),d("div",Dc,[v.value.length===0?(c(),d("div",Ec," Загрузка данных... ")):(c(),d("div",Ac,[(c(!0),d(ee,null,te(v.value,b=>(c(),d("div",{key:b.category,class:"category-item",onClick:Ce(O=>oe(b),["stop"])},[a("span",Ic,g(b.label),1),a("div",Mc,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",Nc,g(b.count)+" тикетов ("+g(b.percentage)+"%) ",1),N[9]||(N[9]=a("span",{class:"category-arrow"},"→",-1))],8,$c))),128))]))])):u.value==="departments"?(c(),d("div",xc,[T.value.length===0?(c(),d("div",Pc," Загрузка данных... ")):(c(),d("div",Lc,[a("table",Oc,[N[11]||(N[11]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),d(ee,null,te(T.value,(b,O)=>(c(),d("tr",{key:O,class:"department-row",onClick:Ce(Q=>q(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",Rc,[a("span",Wc,g(b.departmentName),1)]),a("td",Uc,[a("span",Fc,g(b.count),1)]),N[10]||(N[10]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,Bc))),128))])])]))])):$("",!0)])])):n.value===2&&f.value?(c(),d("div",Hc,[a("div",jc,[a("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),a("h3",null,g(f.value.employeeName),1),a("span",Vc,"Всего: "+g(f.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",zc,[a("div",Gc,[a("span",Kc,g(f.value.stageName),1),a("div",qc,[a("button",{class:X(["level2-sort-btn",{active:l.value==="time"}]),onClick:N[4]||(N[4]=b=>l.value="time"),title:"Сортировка по времени"}," По времени ",2),a("button",{class:X(["level2-sort-btn",{active:l.value==="departments"}]),onClick:N[5]||(N[5]=b=>l.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),l.value==="time"?(c(),d("div",Yc,[f.value.dateCategories.length===0?(c(),d("div",Xc," Нет данных о тикетах ")):(c(),d("div",Jc,[(c(!0),d(ee,null,te(f.value.dateCategories,b=>(c(),d("div",{key:b.category,class:"category-item",onClick:Ce(O=>Z(b),["stop"])},[a("span",Qc,g(b.label),1),a("div",ed,[a("div",{class:"progress-bar",style:we({width:b.progressBarWidth+"%",backgroundColor:b.progressBarColor})},null,4)]),a("span",td,g(b.count)+" тикетов ("+g(b.percentage)+"%) ",1)],8,Zc))),128))]))])):(c(),d("div",sd,[!f.value.departments||f.value.departments.length===0?(c(),d("div",ad,[N[12]||(N[12]=ce(" Для выбранного сотрудника заказчики не найдены ",-1)),a("button",{class:"btn-retry-stage",onClick:N[6]||(N[6]=b=>Y({id:f.value.employeeId,name:f.value.employeeName}))}," Обновить ")])):(c(),d("div",od,[a("table",nd,[N[14]||(N[14]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),d(ee,null,te(f.value.departments,(b,O)=>(c(),d("tr",{key:O,class:"department-row",onClick:Ce(Q=>H(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",id,[a("span",ld,g(b.departmentName),1)]),a("td",cd,[a("span",dd,g(b.count),1)]),N[13]||(N[13]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,rd))),128))])])]))]))])])):n.value===3&&k.value?(c(),d("div",ud,[a("div",md,[a("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),a("div",gd,[a("h3",null,g(k.value.employeeName),1),a("div",hd,[a("span",fd,g(k.value.dateCategoryLabel),1),a("span",vd,g(k.value.stageName),1)])]),a("span",pd,"Всего: "+g(k.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",yd,[k.value.departments.length===0?(c(),d("div",kd," Нет данных о заказчиках ")):(c(),d("div",bd,[a("table",_d,[N[16]||(N[16]=a("thead",null,[a("tr",null,[a("th",{class:"col-department"},"Заказчик"),a("th",{class:"col-count"},"Количество тикетов"),a("th",{class:"col-action"})])],-1)),a("tbody",null,[(c(!0),d(ee,null,te(k.value.departments,(b,O)=>(c(),d("tr",{key:O,class:"department-row",onClick:Ce(Q=>G(b),["stop"]),title:"Кликните для просмотра тикетов"},[a("td",Cd,[a("span",Td,g(b.departmentName),1)]),a("td",Sd,[a("span",Dd,g(b.count),1)]),N[15]||(N[15]=a("td",{class:"col-action"},[a("span",{class:"department-arrow"},"→")],-1))],8,wd))),128))])])]))])])):n.value===4&&p.value?(c(),d("div",Ed,[a("div",Ad,[a("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),a("div",$d,[a("h3",null,g(E.value),1),p.value.context?(c(),d("div",Id,[p.value.context.dateCategoryLabel?(c(),d("span",Md,g(p.value.context.dateCategoryLabel),1)):$("",!0),p.value.context.departmentName?(c(),d("span",Nd,g(p.value.context.departmentName),1)):$("",!0),a("span",xd,g(p.value.context.stageName),1)])):$("",!0)]),a("span",Pd,"Всего: "+g(p.value.totalCount)+" тикетов",1),a("button",{class:"modal-close",onClick:ae,"aria-label":"Закрыть"},"×")]),a("div",Ld,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[p.value.isLoading?(c(),d("div",Od,[...N[17]||(N[17]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):p.value.error&&p.value.error.hasFallback?(c(),d("div",Bd,[N[18]||(N[18]=a("div",{class:"error-banner"},[a("span",{class:"error-icon"},"⚠️"),a("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),a("div",Rd,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(p.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):p.value.error&&!p.value.error.hasFallback?(c(),d("div",Wd,[N[19]||(N[19]=a("div",{class:"error-icon"},"❌",-1)),N[20]||(N[20]=a("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),a("p",Ud,g(p.value.error.message),1),a("button",{class:"btn-retry",onClick:re},"Повторить попытку")])):!p.value.tickets||p.value.tickets.length===0?(c(),d("div",Fd,[N[21]||(N[21]=a("div",{class:"empty-state-icon"},"📭",-1)),a("h3",Hd,g(w()),1),a("p",jd,g(R()),1)])):(c(),d("div",Vd,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(p.value.tickets,(b,O)=>(c(),he(Ct,{key:b.id,ticket:b,draggable:!1,style:we({"--ticket-index":O}),onClick:Q=>le(b)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])],32)):$("",!0)]))}},Gd=de(zd,[["__scopeId","data-v-7fbd8a12"]]);function Kd(o,e,s=.5){if(!e||!Array.isArray(e)||e.length===0||typeof o!="number"||o<0)return 0;(typeof s!="number"||s<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),s=.5);const t=[];if(e.forEach((n,l)=>{if(!n||!n.data||!Array.isArray(n.data))return;const u=n.data[o];u!=null&&!isNaN(u)&&t.push({datasetIndex:l,value:Number(u),y:Number(u)})}),t.length<2)return 0;const r=[];return t.forEach(n=>{let l=!1;for(const u of r){const m=u.y;if(Math.abs(n.y-m)<s){u.points.push(n),u.y=u.points.reduce((T,f)=>T+f.y,0)/u.points.length,l=!0;break}}l||r.push({points:[n],y:n.y})}),r.length===0?0:r.reduce((n,l)=>l.points.length>n.points.length?l:n,r[0]).points.length}function qd(o,e){const s=[];return o.forEach(t=>{let r=!1;for(const i of s){const n=i.y;if(Math.abs(t.value-n)<e){i.points.push(t),i.y=i.points.reduce((l,u)=>l+u.value,0)/i.points.length,r=!0;break}}r||s.push({points:[t],y:t.value})}),s}function Yd(o,e=.5){if(!o)return console.warn("findOverlappingPoints: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];const s=o.data?.datasets,t=o.data?.labels||[];if(!s||!Array.isArray(s)||s.length===0)return[];if(!Array.isArray(t)||t.length===0)return[];(typeof e!="number"||e<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),e=.5);const r=[];return t.forEach((i,n)=>{try{if(Kd(n,s,e)<2)return;const u=[];if(s.forEach((k,p)=>{if(!k||!k.data||!Array.isArray(k.data))return;const S=k.data[n];S==null||isNaN(S)||u.push({datasetIndex:p,value:Number(S),label:k.label||`Dataset ${p}`})}),u.length<2)return;const m=qd(u,e);if(m.length===0)return;const v=m.reduce((k,p)=>p.points.length>k.points.length?p:k,m[0]);if(v.points.length<2)return;let T=null,f=null;for(let k=0;k<s.length;k++)try{const p=o.getDatasetMeta(k);if(p&&p.data&&p.data[n]){T=p,f=p.data[n];break}}catch{continue}if(!f||typeof f.x!="number"||typeof f.y!="number")return;r.push({position:n,count:v.points.length,x:f.x,y:f.y,value:v.y,points:v.points.map(k=>({datasetIndex:k.datasetIndex,value:k.value,label:k.label}))})}catch(l){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${n}:`,l)}}),r}function Xd(o,e){const s=[];return o.forEach(t=>{let r=!1;for(const i of s){const n=i.y;if(Math.abs(t.y-n)<e){i.points.push(t),i.y=i.points.reduce((l,u)=>l+u.y,0)/i.points.length,r=!0;break}}r||s.push({points:[t],y:t.y})}),s}function Jd(o,e,s=.5){if(!o)return console.warn("calculatePointJitter: chart не передан"),[];if(!o.config||o.config.type!=="line")return[];if(typeof e!="number"||e<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof s!="number"||s<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),s=.5);const t=o.data?.datasets,r=o.data?.labels||[];if(!t||!Array.isArray(t)||t.length===0)return[];if(!Array.isArray(r)||e>=r.length)return[];const i=[];if(t.forEach((m,v)=>{if(!m||!m.data||!Array.isArray(m.data))return;const T=m.data[e];if(!(T==null||isNaN(T)))try{const f=o.getDatasetMeta(v);if(f&&f.data&&f.data[e]){const k=f.data[e];k&&typeof k.x=="number"&&typeof k.y=="number"&&i.push({datasetIndex:v,value:Number(T),x:k.x,y:k.y})}}catch(f){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${v}:`,f)}}),i.length===0)return[];const n=Xd(i,s),l=[];n.forEach(m=>{const v=m.points||[];v.length>1?v.forEach((f,k)=>{const p=(k-(v.length-1)/2)*4;l.push({datasetIndex:f.datasetIndex,jitterX:p,value:f.value})}):v.length===1&&l.push({datasetIndex:v[0].datasetIndex,jitterX:0,value:v[0].value})});const u=new Set(l.map(m=>m.datasetIndex));return i.forEach(m=>{u.has(m.datasetIndex)||l.push({datasetIndex:m.datasetIndex,jitterX:0,value:m.value})}),l}const Zd=.5,oa=6,Qd=2;function eu(o){return typeof o!="number"||o<2?oa:oa+(o-1)*Qd}function tu(o,e){if(!o||!o.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!e||typeof e.x!="number"||typeof e.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",e);return}const s=e.count;if(typeof s!="number"||s<2)return;const t=o.ctx,{x:r,y:i,points:n}=e,l=eu(s);if(t.canvas){t.save();try{t.beginPath(),t.arc(r,i,l,0,2*Math.PI);let m="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&o.data&&o.data.datasets){const v=n[0].datasetIndex,T=o.data.datasets[v];if(T&&T.pointBackgroundColor){const f=Array.isArray(T.pointBackgroundColor)?T.pointBackgroundColor[e.position]||T.pointBackgroundColor[0]:T.pointBackgroundColor;if(f)if(f.startsWith("#")){const k=parseInt(f.slice(1,3),16),p=parseInt(f.slice(3,5),16),S=parseInt(f.slice(5,7),16);m=`rgba(${k}, ${p}, ${S}, 0.4)`}else f.startsWith("rgba")?m=f.replace(/rgba?\(([^)]+)\)/,(k,p)=>{const S=p.split(",").map(C=>C.trim());return`rgba(${S[0]}, ${S[1]}, ${S[2]}, 0.4)`}):m=f+"66"}}t.fillStyle=m,t.fill(),t.strokeStyle=m.replace("0.4","0.6").replace("66","99"),t.lineWidth=1,t.stroke()}catch(m){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",m)}finally{t.restore()}}}const su={id:"overlappingPointsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=Yd(o,Zd);if(!Array.isArray(e)||e.length===0)return;e.filter(t=>!(!t||typeof t!="object"||typeof t.count!="number"||t.count<2||typeof t.x!="number"||typeof t.y!="number"||!isFinite(t.x)||!isFinite(t.y))).forEach(t=>{try{tu(o,t)}catch(r){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${t.position}:`,r)}})}catch(e){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",e)}}},au=.5,ou={id:"pointJitterPlugin",beforeDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")){o._jitterData||(o._jitterData={});try{const e=o.data?.datasets,s=o.data?.labels||[];if(!e||!Array.isArray(e)||e.length===0||!Array.isArray(s)||s.length===0)return;o._jitterData={},s.forEach((t,r)=>{const i=Jd(o,r,au);i&&i.length>0&&i.forEach(n=>{const l=`${n.datasetIndex}_${r}`;o._jitterData[l]=n.jitterX})})}catch(e){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",e)}}},afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx&&!(!o._jitterData||Object.keys(o._jitterData).length===0))try{const e=o.ctx,s=o.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((t,r)=>{const i=o.getDatasetMeta(r);!i||i.hidden||!t.data||!Array.isArray(t.data)||t.data.forEach((n,l)=>{const u=i.data[l];if(!u||typeof u.x!="number"||typeof u.y!="number"||n==null||isNaN(n))return;const m=`${r}_${l}`,v=o._jitterData[m];if(!(v===void 0||v===0)){e.save();try{const T=t.pointStyle||"circle",f=(t.pointRadius||7)+1,k=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[l]||t.pointBackgroundColor[0]:t.pointBackgroundColor,p=Array.isArray(t.pointBorderColor)?t.pointBorderColor[l]||t.pointBorderColor[0]:t.pointBorderColor,S=t.pointBorderWidth||1,C=u.x+v,y=u.y;switch(e.fillStyle=k||"#007bff",e.strokeStyle=p||"#ffffff",e.lineWidth=S,e.beginPath(),T){case"circle":e.arc(C,y,f,0,2*Math.PI);break;case"triangle":e.moveTo(C,y-f),e.lineTo(C-f,y+f),e.lineTo(C+f,y+f),e.closePath();break;case"rect":case"rectRounded":const _=f*1.4;e.rect(C-_/2,y-_/2,_,_);break;case"rectRot":const A=f*1.4;e.moveTo(C,y-A/2),e.lineTo(C+A/2,y),e.lineTo(C,y+A/2),e.lineTo(C-A/2,y),e.closePath();break;case"star":const W=f;for(let E=0;E<5;E++){const P=E*4*Math.PI/5-Math.PI/2,B=C+W*Math.cos(P),U=y+W*Math.sin(P);E===0?e.moveTo(B,U):e.lineTo(B,U)}e.closePath();break;case"cross":const x=f;e.moveTo(C-x,y-x),e.lineTo(C+x,y+x),e.moveTo(C+x,y-x),e.lineTo(C-x,y+x);break;case"crossRot":const D=f;e.moveTo(C-D,y),e.lineTo(C+D,y),e.moveTo(C,y-D),e.lineTo(C,y+D);break;default:e.arc(C,y,f,0,2*Math.PI)}T!=="cross"&&T!=="crossRot"&&e.fill(),e.stroke(),u._originalX||(u._originalX=u.x,u._originalY=u.y),u._jitterX=v,u._jitteredX=C,u._jitteredY=y}catch(T){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${r}_${l}:`,T)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:o=>{o._jitterData}},nu={id:"pointLabelsPlugin",afterDatasetsDraw:o=>{if(!(!o||!o.config||o.config.type!=="line")&&o.ctx)try{const e=o.ctx,s=o.data?.datasets;if(!s||!Array.isArray(s)||s.length===0)return;s.forEach((t,r)=>{const i=o.getDatasetMeta(r);if(!i||i.hidden||!t.data||!Array.isArray(t.data))return;const n=Array.isArray(t.pointBackgroundColor)?t.pointBackgroundColor[0]||"#6b7280":t.pointBackgroundColor||"#6b7280";t.data.forEach((l,u)=>{const m=i.data[u];if(!m||typeof m.x!="number"||typeof m.y!="number"||l==null||isNaN(l))return;const v=m._jitteredX!==void 0?m._jitteredX:m.x,T=m._jitteredY!==void 0?m._jitteredY:m.y,f=v+8,k=T-5,p=String(Math.round(l));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const C=e.measureText(p).width,y=11,_=3,A=f-_,W=k-y/2-_,x=C+_*2,D=y+_*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(A,W,x,D),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(A,W,x,D),e.fillStyle=n,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(p,f,k)}catch(S){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${r}_${u}:`,S)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},ru={class:"graph-state-chart"},iu={class:"chart-header"},lu={class:"chart-type-selector"},cu=["onClick","title"],du={class:"chart-type-icon"},uu={class:"chart-type-label"},mu={key:0,class:"comparison-type-selector"},gu={class:"radio-group"},hu={key:0},fu={key:1},vu={key:2,class:"graph-legend"},pu={key:4,class:"error-container"},yu={class:"error-message"},ku={class:"chart-wrapper"},bu={class:"chart-canvas-container"},_u={key:0,class:"bar-chart-stage-labels"},wu={key:6,class:"no-data"},Cu={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(o,{emit:e}){const s=(j,V)=>typeof window>"u"?V:getComputedStyle(document.documentElement).getPropertyValue(j).trim()||V,t=o,r=e,i=I(!1),n=I(null),l=I(null),u=I({weekStart:null,weekEnd:null,current:null}),m=I(null),v=I("weekStartToWeekEnd"),T=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],f=I("line"),k=I(!1),p=I(""),S=I(""),C=I(0),y=I([]),_=I(null),A=I(null),W=I(null),x=I(null),D=I([]),E=M(()=>{switch(f.value){case"line":return yt;case"bar":return va;case"doughnut":return fa;default:return yt}}),P={formed:s("--b24-primary","#007bff"),review:s("--b24-warning","#ffc107"),execution:s("--b24-success","#28a745")},B=[{id:"formed",name:"Сформировано обращение",color:P.formed},{id:"review",name:"Рассмотрение ТЗ",color:P.review},{id:"execution",name:"Исполнение",color:P.execution}],U=M(()=>B.reduce((j,V)=>(j[V.id]=V.name,j),{})),G=["circle","triangle","rect","rectRot","star","cross","crossRot"],q=I({formed:!0,review:!0,execution:!0}),oe=lt(),Y={id:"employeeLabelsPlugin",afterDatasetsDraw:j=>{if(j.config.type==="bar")try{const V=j.ctx;if(!j.data||!j.data.datasets)return;const se=j.data.datasets,me=j.scales.y;se.forEach((ye,F)=>{const ie=j.getDatasetMeta(F);if(!ie||ie.hidden)return;const ve=ye.label||"";if(!ve||ve.includes("Другие"))return;const Te=ve.trim().split(/\s+/);let Ie="";if(Te.length===1)Ie=Te[0];else{const xe=Te[0],Ue=Te.slice(1).join(" ");Ie=`${xe}
${Ue}`}const ze=Ie.split(`
`);ye.data.forEach((xe,Ue)=>{if(xe===0||!xe)return;const Ge=ie.data[Ue];if(!Ge||typeof Ge.x!="number"||typeof Ge.y!="number")return;const He=Ge.x,Tt=Ge.y+Ge.height+25;V.save(),V.font="bold 9px Arial, sans-serif",V.fillStyle="#6b7280",V.textAlign="center",V.textBaseline="top",V.translate(He,Tt),V.rotate(-12*Math.PI/180),ze.forEach((Ka,qa)=>{const qs=Ka.trim();qs&&V.fillText(qs,0,qa*11)}),V.restore()})})}catch(V){console.error("Error in employeeLabelsPlugin:",V)}}},H={id:"doughnutCenterTextPlugin",afterDraw:j=>{if(j.config.type!=="doughnut")return;const{ctx:V,chartArea:se,width:me,height:ye}=j;if(!j.data||!j.data.datasets||j.data.datasets.length===0)return;const ie=j.data.datasets[0].meta?.totals?.overall??null;if(ie===null||typeof ie>"u")return;const ve=["Всего в секторе 1С","тикетов в работе:",`${ie}`];V.save(),V.font='600 16px "Roboto", sans-serif',V.fillStyle=s("--b24-text-primary","#1f2937"),V.textAlign="center",V.textBaseline="middle";const Te=(se.left+se.right)/2,Ie=(se.top+se.bottom)/2,ze=18,xe=ze*ve.length,Ue=Ie-xe/2+4;ve.forEach((Ge,He)=>{He===ve.length-1&&`${Ge}`.length>4?V.font='700 18px "Roboto", sans-serif':V.font='600 16px "Roboto", sans-serif',V.fillText(Ge,Te,Ue+He*ze)}),V.restore()}};Je.register(Y),Je.register(H);function Z(){const j=new Map;[u.value.weekStart,u.value.weekEnd,u.value.current].forEach(V=>{!V||!V.statistics||!V.statistics.employees||V.statistics.employees.forEach(se=>{j.has(se.id)||j.set(se.id,{id:se.id,name:se.name})})}),D.value=Array.from(j.values()).sort((V,se)=>V.name.localeCompare(se.name))}function fe(j,V="background"){return{increase:{background:s("--b24-success","#28a745"),border:s("--b24-success-hover","#218838"),point:s("--b24-success","#28a745")},decrease:{background:s("--b24-danger","#dc3545"),border:s("--b24-danger-hover","#c82333"),point:s("--b24-danger","#dc3545")},stable:{background:s("--b24-text-muted","#9ca3af"),border:s("--b24-text-secondary","#6b7280"),point:s("--b24-text-muted","#9ca3af")}}[j]?.[V]||s("--b24-text-secondary","#6c757d")}function L(){if(!(!u.value.weekStart||!u.value.weekEnd))try{const j=Es.compareTwoSnapshots(u.value.weekStart,u.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let V=null,se=null;u.value.current&&(V=Es.compareTwoSnapshots(u.value.weekEnd,u.value.current,{includeTickets:!1,includeEmployees:!0}),se=Es.compareTwoSnapshots(u.value.weekStart,u.value.current,{includeTickets:!1,includeEmployees:!0})),m.value={weekStartToWeekEnd:j,weekEndToCurrent:V,weekStartToCurrent:se}}catch(j){console.error("Ошибка сравнения слепков:",j),oe.warning("Не удалось выполнить сравнение слепков: "+j.message)}}function h(j){return j?j.replace(/\s*\(\d+\)\s*$/,"").trim():""}function w(j){const V=h(j);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[V]||"formed"}function R(j){return w(j)}function re(j){return j===0?"weekStart":j===1?"weekEnd":j===2?"current":"weekEnd"}function le(j,V,se,me,ye=null,F=null,ie=null,ve=null){console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:j,stageId:V,totalCount:se,employeesCount:me?.length||0,hasSnapshot:!!F,snapshotTicketIds:F?.ticketIds?.length||0}),p.value=j,S.value=V||"",C.value=se,y.value=me||[],_.value=ye&&ye.count>0?ye:null,A.value=F,W.value=ie,x.value=ve,k.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:S.value,hasCurrentSnapshot:!!A.value})}async function ae(j,V,se){console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:j,timePoint:V,hasMeta:!!se});const me=B.find(F=>F.id===j);if(!me){console.warn("[GraphStateChart] Stage not found:",j);return}const ye={graphType:"line",stageId:j,stageName:me.name,timePoint:V,snapshots:u.value,meta:{line:se||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:P,stageNameMap:U.value};try{const F=await Oa({stageId:j,graphType:"line",timePoint:V,snapshots:u.value,meta:{line:se||null,doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:P,stageNameMap:U.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:F.stageName,stageId:j,totalCount:F.totalCount,employeesCount:F.employees?.length||0,hasSnapshot:!!F.snapshot}),le(F.stageName,j,F.totalCount,F.employees,F.others,F.snapshot,null,ye)}catch(F){console.error("[GraphStateChart] Failed to open modal for line point:",F),oe.error("Не удалось открыть попап для выбранной точки графика")}}function ge(j,V){if(!V||!V.employees||V.employees.length===0){oe.warning("Нет данных о сотрудниках для этого этапа");return}const se=u.value.current||u.value.weekEnd||u.value.weekStart,me={graphType:"doughnut",stageId:j,stageName:V.stageName,snapshots:u.value,meta:{doughnut:l.value?.datasets?.[0]?.meta||null},stageColorMap:P,stageNameMap:U.value};le(V.stageName,j,V.totalCount,V.employees,V.others,se,null,me)}function Se(){k.value=!1,p.value="",S.value="",C.value=0,y.value=[],_.value=null,A.value=null,W.value=null}async function $e(j,V,se){if(f.value!=="line"||V.length===0)return;const me=V[0],ye=me.datasetIndex,F=me.index,ie=se.data.datasets[ye];if(!ie)return;const ve=R(ie.label),Te=re(F);await ae(ve,Te,ie.meta||null)}function Ne(j,V,se){if(f.value!=="doughnut"||V.length===0)return;const ye=V[0].index,F=se.data,ie=F.labels[ye],ve=R(ie),Ie=F.datasets[0]?.meta?.employees?.[ve];if(!Ie){console.warn("Данные о сотрудниках не найдены для этапа:",ve);return}ge(ve,Ie)}function Fe(j){const V=B[j];if(!V)return 0;const se=u.value.current||u.value.weekEnd||u.value.weekStart;return!se||!se.statistics||!se.statistics.stages?0:se.statistics.stages[V.id]?.count||0}function z(j){const V=B.find(ye=>ye.id===j);if(!V)return"";const se=u.value.current||u.value.weekEnd||u.value.weekStart;if(!se||!se.statistics||!se.statistics.stages)return V.name;const me=se.statistics.stages[j]?.count||0;return`${V.name} (${me})`}const N=M(()=>{if(!l.value)return null;if(f.value==="doughnut"||f.value==="bar")return l.value;const j=l.value.datasets.filter(V=>{const se=B.find(me=>me.name===V.label);return se?q.value[se.id]:!0});return{...l.value,datasets:j}});M(()=>f.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const b=M(()=>{const j={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:f.value==="bar"?{bottom:80}:{}},onClick:(V,se,me)=>{f.value==="line"?$e(V,se,me):f.value==="doughnut"&&Ne(V,se,me)},onHover:(V,se,me)=>{f.value==="doughnut"&&(V.native.target.style.cursor=se.length>0?"pointer":"default")},plugins:{legend:{display:f.value!=="bar",position:f.value==="doughnut"?"right":"top",labels:{font:{size:f.value==="doughnut"?14:12,weight:f.value==="doughnut"?"600":"500"},boxWidth:f.value==="doughnut"?18:12,boxHeight:f.value==="doughnut"?18:12,padding:f.value==="doughnut"?14:10},onClick:(V,se,me)=>{if(f.value==="bar"){const F=se.datasetIndex;if(F!==void 0){const ie=me.chart.getDatasetMeta(F);ie.hidden=!ie.hidden,me.chart.update()}return}const ye=se.datasetIndex;if(ye!==void 0){const F=me.chart.getDatasetMeta(ye);F.hidden=!F.hidden,me.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:V=>{if(f.value==="bar"){const se=V[0].dataIndex,me=B[se];return me?me.name:""}return V[0].label||""},label:V=>{const se=V.dataset.label||"",me=V.parsed.y||V.parsed||0,ye=V.dataIndex;if(f.value==="bar"){const F=V.dataset,ie=V.dataIndex,ve=B[ie],Te=ve?ve.name:"";return`${F.label}: ${me} тикетов на этапе "${Te}"`}if(f.value==="doughnut"){const F=V.dataset.data.reduce((ve,Te)=>ve+Te,0),ie=F>0?(me/F*100).toFixed(1):0;return`${se}: ${me} тикетов (${ie}%)`}else{if(!m.value||ye===0)return`${se}: ${me} тикетов`;let F=null;const ie=w(se);if(v.value==="weekStartToWeekEnd"&&ye===1?F=m.value.weekStartToWeekEnd?.stages?.[ie]:v.value==="weekEndToCurrent"&&ye===2&&u.value.current?F=m.value.weekEndToCurrent?.stages?.[ie]:v.value==="weekStartToCurrent"&&ye===2&&u.value.current&&(F=m.value.weekStartToCurrent?.stages?.[ie]),!F)return`${se}: ${me} тикетов`;const ve=F.delta,Te=F.deltaPercent,Ie=F.trend;let ze=`${se}: ${me} тикетов`;if(ve!==0){const xe=ve>0?"+":"",Ue=Ie==="increase"?"↑":Ie==="decrease"?"↓":"→";ze+=` (${xe}${ve}, ${xe}${Te.toFixed(1)}%) ${Ue}`}else ze+=" (без изменений)";return ze}},afterBody:V=>{if(f.value==="bar"&&V.length>0){const F=V[0];F.dataset;const ie=F.parsed.y||0,ve=F.dataIndex,Te=Fe(ve);return[`${Te>0?(ie/Te*100).toFixed(1):0}% от общего количества этапа`]}if(f.value==="doughnut"&&V.length>0)return["Кликните для детализации по сотрудникам"];if(f.value==="line"){const F=[];if(m.value){const ie=V[0].dataIndex;if(ie!==0){let ve=null;if(w(V[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&ie===1?ve=m.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&ie===2?ve=m.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&ie===2&&(ve=m.value.weekStartToCurrent),ve&&ve.metadata){const Te=ve.metadata.timeDiff;F.push(`Период: ${Te.days} дн. ${Te.hours} ч. ${Te.minutes} мин.`)}}}return F.push("Кликните для детализации по сотрудникам"),F}if(!m.value)return[];const se=V[0].dataIndex;if(se===0)return[];let me=null;if(w(V[0].dataset.label||""),v.value==="weekStartToWeekEnd"&&se===1?me=m.value.weekStartToWeekEnd:v.value==="weekEndToCurrent"&&se===2?me=m.value.weekEndToCurrent:v.value==="weekStartToCurrent"&&se===2&&(me=m.value.weekStartToCurrent),!me||!me.metadata)return[];const ye=me.metadata.timeDiff;return[`Период: ${ye.days} дн. ${ye.hours} ч. ${ye.minutes} мин.`]}}},title:{display:!1}}};return f.value==="line"||f.value==="bar"?{...j,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:f.value==="doughnut"?{...j,cutout:"60%"}:j});function O(j){const V=new Date(j),se=V.getFullYear(),me=String(V.getMonth()+1).padStart(2,"0"),ye=String(V.getDate()).padStart(2,"0");return`${se}-${me}-${ye}`}function Q(j){const{current:V,weekEnd:se}=j,me=V||se;if(!me||!me.statistics||!me.statistics.stages)return null;const ye=[],F=[],ie=[],ve=[],Te={},Ie={};if(B.forEach(xe=>{const Ue=me.statistics.stages[xe.id]?.count||0;if(Ue>0){ye.push(`${xe.name} (${Ue})`),F.push(Ue),ie.push(xe.color+"80"),ve.push(xe.color),Ie[xe.id]=Ue;const Ge=Jl(xe.id,me,B);Ge&&Ge.employees&&(Te[xe.id]=Ge)}}),F.length===0)return null;const ze=F.reduce((xe,Ue)=>xe+Ue,0);return{labels:ye,datasets:[{label:"Распределение по этапам",data:F,backgroundColor:ie,borderColor:ve,borderWidth:2,meta:{employees:Te,totals:{overall:ze,stages:Ie}}}]}}function ue(j){if(f.value==="doughnut")return Q(j);if(f.value==="bar"){const ie=t.showCurrentState&&j.current?"current":j.weekEnd?"weekEnd":"weekStart";return Xl(j,ie,B)}const{weekStart:V,weekEnd:se,current:me}=j,ye=[],F=[];return B.forEach((ie,ve)=>{const Te=[];if(V&&V.statistics&&V.statistics.stages){const He=V.statistics.stages[ie.id];if(ye.length===0){const Tt=V.metadata?.createdAt?new Date(V.metadata.createdAt):null;ye.push(Tt?O(Tt):"Начало недели")}Te.push(He?.count||0)}else ye.length===0&&ye.push("Начало недели"),Te.push(0);if(se&&se.statistics&&se.statistics.stages){const He=se.statistics.stages[ie.id];if(ye.length===1){const Tt=se.metadata?.createdAt?new Date(se.metadata.createdAt):null;ye.push(Tt?O(Tt):"Конец недели")}Te.push(He?.count||0)}else ye.length===1&&ye.push("Конец недели"),Te.push(0);if(me&&t.showCurrentState&&me.statistics&&me.statistics.stages){const He=me.statistics.stages[ie.id];ye.length===2&&ye.push("Текущее состояние"),Te.push(He?.count||0)}const Ie=["stable"];m.value?v.value==="weekStartToWeekEnd"?(Ie.push(m.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),me&&Ie.push(m.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekEndToCurrent"&&me?(Ie.push("stable"),Ie.push(m.value.weekEndToCurrent?.stages?.[ie.id]?.trend||"stable")):v.value==="weekStartToCurrent"&&me?(Ie.push(m.value.weekStartToWeekEnd?.stages?.[ie.id]?.trend||"stable"),Ie.push(m.value.weekStartToCurrent?.stages?.[ie.id]?.trend||"stable")):(Ie.push("stable"),me&&Ie.push("stable")):(Ie.push("stable"),me&&Ie.push("stable"));let ze,xe,Ue;m.value&&f.value!=="doughnut"?(ze=Ie.map(He=>fe(He,"background")+"40"),xe=Ie.map(He=>fe(He,"border")),Ue=Ie.map(He=>fe(He,"point"))):(ze=ie.color+"40",xe=ie.color,Ue=ie.color);let Ge=null;f.value==="line"&&(Ge={employees:Yl(ie.id,j)}),F.push({label:ie.name,data:Te,backgroundColor:(Array.isArray(ze),ze),borderColor:(Array.isArray(xe),xe),borderWidth:2,...f.value==="line"&&{pointStyle:G[ve%G.length]},pointBackgroundColor:(Array.isArray(Ue),Ue),pointBorderColor:(Array.isArray(xe),xe),pointRadius:7,pointHoverRadius:10,fill:f.value!=="line",tension:f.value==="line"?.4:0,meta:Ge})}),ye.length===0&&(ye.push("Начало недели","Конец недели"),t.showCurrentState&&ye.push("Текущее состояние")),{labels:ye,datasets:F}}const ke=async()=>{i.value=!0,n.value=null;try{const j=t.period?.endDate?new Date(t.period.endDate):new Date,V=t.period?.startDate?new Date(t.period.startDate):pt.getWeekStartDate(j),se=t.period?.endDate?new Date(t.period.endDate):pt.getWeekEndDate(j),me=pt.formatDate(V),ye=pt.formatDate(se),[F,ie]=await Promise.all([pt.getSnapshot(me,"week_start"),pt.getSnapshot(ye,"week_end")]);let ve=null;t.showCurrentState&&(ve=await Ws.getSectorDataForSnapshot({useCache:!1,normalize:!0})),u.value={weekStart:F,weekEnd:ie,current:ve},Z(),L(),K(),r("data-loaded",{weekStart:F,weekEnd:ie,current:ve})}catch(j){console.error("Error loading chart data:",j),n.value=j.message||"Ошибка загрузки данных графика",oe.error("Ошибка загрузки данных графика: "+n.value),r("error",n.value)}finally{i.value=!1}};Ae(()=>{Je.register(su),Je.register(ou),Je.register(nu),ke()});function _e(j){q.value=j}const K=()=>{const j=ue({weekStart:u.value.weekStart,weekEnd:u.value.weekEnd,current:u.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==j?.labels?.length)l.value=j;else if(j){const V=JSON.stringify(l.value),se=JSON.stringify(j);V!==se&&(l.value=j)}};return Me(()=>[t.period,t.showCurrentState],()=>{ke()},{deep:!0}),Me(f,()=>{(u.value.weekStart||u.value.weekEnd||u.value.current)&&K()}),Me(v,()=>{(u.value.weekStart||u.value.weekEnd||u.value.current)&&K()}),(j,V)=>(c(),d("div",ru,[a("div",iu,[V[3]||(V[3]=a("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),a("div",lu,[(c(),d(ee,null,te(T,se=>a("button",{key:se.value,onClick:me=>f.value=se.value,class:X(["chart-type-btn",{active:f.value===se.value}]),title:se.label},[a("span",du,g(se.icon),1),a("span",uu,g(se.label),1)],10,cu)),64))])]),!i.value&&!n.value&&m.value&&f.value!=="doughnut"?(c(),d("div",mu,[V[7]||(V[7]=a("h4",{class:"comparison-title"},"Тип сравнения:",-1)),a("div",gu,[a("label",null,[Le(a("input",{type:"radio","onUpdate:modelValue":V[0]||(V[0]=se=>v.value=se),value:"weekStartToWeekEnd",onChange:K},null,544),[[Dt,v.value]]),V[4]||(V[4]=a("span",null,"Начало недели → Конец недели",-1))]),u.value.current?(c(),d("label",hu,[Le(a("input",{type:"radio","onUpdate:modelValue":V[1]||(V[1]=se=>v.value=se),value:"weekEndToCurrent",onChange:K},null,544),[[Dt,v.value]]),V[5]||(V[5]=a("span",null,"Конец недели → Текущее состояние",-1))])):$("",!0),u.value.current?(c(),d("label",fu,[Le(a("input",{type:"radio","onUpdate:modelValue":V[2]||(V[2]=se=>v.value=se),value:"weekStartToCurrent",onChange:K},null,544),[[Dt,v.value]]),V[6]||(V[6]=a("span",null,"Начало недели → Текущее состояние",-1))])):$("",!0)])])):$("",!0),!i.value&&!n.value&&l.value?(c(),he(Ll,{key:1,stages:B,selected:q.value,"onUpdate:selected":_e,onChange:K},null,8,["selected"])):$("",!0),!i.value&&!n.value&&m.value&&f.value!=="doughnut"?(c(),d("div",vu,[...V[8]||(V[8]=[_t('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):$("",!0),i.value?(c(),he(bs,{key:3,message:"Загрузка данных графика..."})):n.value?(c(),d("div",pu,[a("p",yu,"❌ "+g(n.value),1),a("button",{onClick:ke,class:"btn-retry"},"Повторить загрузку")])):N.value?(c(),d("div",{key:5,class:X(["chart-container",`chart-type-${f.value}`])},[a("div",ku,[a("div",bu,[(c(),he(wt(E.value),{data:N.value,options:b.value},null,8,["data","options"]))]),f.value==="bar"?(c(),d("div",_u,[(c(),d(ee,null,te(B,se=>a("div",{key:se.id,class:"stage-label-item"},g(z(se.id)),1)),64))])):$("",!0)])],2)):(c(),d("div",wu,[...V[9]||(V[9]=[a("p",null,"📊 Нет данных для отображения",-1),a("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ne(Gd,{"is-visible":k.value,"stage-name":p.value,"stage-id":S.value,"total-count":C.value,employees:y.value,others:_.value,snapshot:A.value,"ticket-details":W.value,"stage-switch-context":x.value,onClose:Se},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},Tu=de(Cu,[["__scopeId","data-v-cbba196a"]]),nt={USER_NOT_DETERMINED:"USER_NOT_DETERMINED",ACCESS_DENIED:"ACCESS_DENIED",API_ERROR:"API_ERROR"};class ct{constructor(e,s=null,t=null,r=null){this.allowed=e,this.errorCode=s,this.errorMessage=t,this.user=r}}class rt{static async checkAccess(){try{const e=Ot();if(console.log("AccessControlService.checkAccess - isInsideBitrix24:",e),console.log("AccessControlService.checkAccess - window.self === window.top:",window.self===window.top),console.log("AccessControlService.checkAccess - typeof BX24:",typeof BX24),e)console.log("AccessControlService.checkAccess - Inside Bitrix24, skipping direct access check");else{console.log("AccessControlService.checkAccess - Not inside Bitrix24, checking direct access config...");const{isDirectAccessAllowed:i,getDenyMessage:n}=await De(async()=>{const{isDirectAccessAllowed:u,getDenyMessage:m}=await import("./direct-access-config-BqyTgLig.js");return{isDirectAccessAllowed:u,getDenyMessage:m}},__vite__mapDeps([5,4]),import.meta.url),l=await i();if(console.log("AccessControlService.checkAccess - allowDirectAccess:",l),!l){const u=await n();return console.warn("Direct access denied: Application opened directly in browser, but direct access is disabled in config"),console.warn("Deny message:",u),new ct(!1,nt.ACCESS_DENIED,u,null)}console.log("Direct access allowed: Using primary administrator token from settings.php")}if(e)try{await Promise.race([kt.init(),new Promise((i,n)=>setTimeout(()=>n(new Error("Инициализация Bitrix24 API превысила 5 секунд")),5e3))])}catch(i){console.warn("BX24.init() failed, will try proxy API:",i)}let s;try{s=await Promise.race([kt.getCurrentUser(),new Promise((i,n)=>setTimeout(()=>n(new Error("Получение информации о пользователе превысило 10 секунд")),1e4))])}catch(i){console.warn("Bitrix24BxApi.getCurrentUser() failed, trying proxy API:",i);const{Bitrix24ApiProvider:n}=await De(async()=>{const{Bitrix24ApiProvider:l}=await import("./chunk-Bzh5eqmy.js").then(u=>u.b);return{Bitrix24ApiProvider:l}},__vite__mapDeps([3,4]),import.meta.url);try{const l=await n.getInstance();s=await Promise.race([l.getCurrentUser(),new Promise((u,m)=>setTimeout(()=>m(new Error("Прокси API превысило 5 секунд")),5e3))]),console.log("Got user from proxy API:",s?.ID||"unknown")}catch(l){throw console.error("Both BX24 API and proxy API failed:",l),new Error("Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.")}}if(!s||!s.ID)return console.warn("AccessControlService.checkAccess - user not determined:",s),new ct(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.");console.log("AccessControlService.checkAccess - user determined:",{id:s.ID,name:s.NAME,departments:s.UF_DEPARTMENT});const t=s.UF_DEPARTMENT||[];if(console.log("AccessControlService.checkAccess - departmentIds:",t),!Array.isArray(t)||t.length===0){if(console.log("AccessControlService.checkAccess - user has no departments"),!e){const{isDirectAccessAllowed:i}=await De(async()=>{const{isDirectAccessAllowed:l}=await import("./direct-access-config-BqyTgLig.js");return{isDirectAccessAllowed:l}},__vite__mapDeps([5,4]),import.meta.url);if(await i())return console.log("AccessControlService.checkAccess - Direct access allowed, granting access despite no departments"),new ct(!0,null,null,s)}return console.warn("AccessControlService.checkAccess - Access denied: user has no departments"),new ct(!1,nt.ACCESS_DENIED,"Доступ запрещён. Пользователь не привязан к отделу.")}const r=t.some(i=>Ca(i));return console.log("AccessControlService.checkAccess - hasAccess:",r),r?(console.log("AccessControlService.checkAccess - Access granted"),new ct(!0,null,null,s)):(console.warn("AccessControlService.checkAccess - Access denied: no allowed departments"),new ct(!1,nt.ACCESS_DENIED,"Доступ запрещён"))}catch(e){return console.error("AccessControlService.checkAccess error:",e),e.message&&(e.message.includes("CORS")||e.message.includes("blocked")||e.message.includes("ERR_FAILED")||e.message.includes("unknown address space"))&&Ot()?(console.error("CORS error inside Bitrix24: Cannot determine interface user."),new ct(!1,nt.API_ERROR,"Ошибка CORS: не удалось определить пользователя интерфейса. Обратитесь в Поддержку приложения в ИТ отдел.")):e.message&&e.message.includes("not loaded")?new ct(!1,nt.USER_NOT_DETERMINED,"Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел."):new ct(!1,nt.API_ERROR,"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел.")}}static async getCurrentUser(){try{return Ot()&&await kt.init(),await kt.getCurrentUser()}catch(e){return console.error("AccessControlService.getCurrentUser error:",e),null}}}const Su={key:0,class:"create-snapshot-button-container"},Du=["disabled"],Eu={class:"modal-content"},Au={class:"modal-header"},$u=["disabled"],Iu={class:"modal-body"},Mu={key:0,class:"progress-container"},Nu={class:"progress-bar-wrapper"},xu={class:"progress-text"},Pu={class:"progress-percent"},Lu={class:"progress-description"},Ou={key:1},Bu={class:"modal-footer"},Ru=["disabled"],Wu=["disabled"],Uu={key:0},Fu={key:0},Hu={key:1},ju={key:2},Vu={key:1},zu={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(o,{emit:e}){const s=o,t=e,r=I(s.user),i=I(!1),n=I(!1),l=I(0),u=I("idle"),m=I(""),v=lt(),T=M(()=>r.value?es(r.value):!1);Ae(async()=>{if(!s.user)try{const C=await rt.checkAccess();C.allowed&&(r.value=C.user)}catch(C){console.error("Error loading user:",C)}});const f=()=>{if(!T.value){v.warning("Только администраторы могут создавать слепки");return}i.value=!0},k=()=>{n.value||(i.value=!1,u.value="idle",l.value=0,m.value="")},p=async()=>{if(!n.value){if(!T.value){v.warning("Только администраторы могут создавать слепки");return}n.value=!0,u.value="loading_data",l.value=0,m.value="Инициализация загрузки данных...";try{m.value="Загрузка данных сектора из Bitrix24...";const C=await Ws.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:A=>{const W=Math.min(80,(A.progress||0)*.8);l.value=W,u.value="loading_data",m.value=A.description||A.details?.description||"Загрузка данных сектора..."}});u.value="creating_snapshot",l.value=85,m.value="Создание слепка...";const y=r.value;if(!y)throw new Error("Пользователь не определён");const _=await pt.createSnapshot(C,"manual",{createdBy:{id:y.ID,name:`${y.NAME||""} ${y.LAST_NAME||""}`.trim()||y.EMAIL||`User ${y.ID}`},sectorId:"1C"});u.value="success",l.value=100,m.value="Слепок успешно создан!",v.success("Слепок состояния сектора успешно создан"),t("snapshot-created",_),setTimeout(()=>{k()},1500)}catch(C){u.value="error",l.value=0,m.value="Ошибка создания слепка",console.error("Error creating snapshot:",C);let y="Ошибка создания слепка";C.message&&(C.message.includes("загрузки данных")||C.message.includes("sector data")?y="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":C.message.includes("создания слепка")||C.message.includes("snapshot")?y="Не удалось создать слепок. Обратитесь в поддержку.":C.message.includes("валидац")||C.message.includes("validation")?y="Ошибка валидации данных. Проверьте данные сектора.":y=C.message),v.error(y)}finally{n.value=!1}}},S=C=>{C.key==="Escape"&&i.value&&!n.value&&k()};return Ae(()=>{window.addEventListener("keydown",S)}),st(()=>{window.removeEventListener("keydown",S)}),(C,y)=>T.value?(c(),d("div",Su,[a("button",{class:"create-snapshot-btn",onClick:f,disabled:n.value,title:"Создать слепок состояния сектора"},[...y[1]||(y[1]=[a("span",{class:"btn-icon"},"📸",-1),a("span",{class:"btn-text"},"Создать слепок",-1)])],8,Du),(c(),he($t,{to:"body"},[ne(Ee,{name:"modal"},{default:pe(()=>[i.value?(c(),d("div",{key:0,class:"modal-overlay",onClick:y[0]||(y[0]=Ce(_=>!n.value&&k(),["self"]))},[a("div",Eu,[a("div",Au,[y[2]||(y[2]=a("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),a("button",{class:"modal-close",onClick:k,disabled:n.value,"aria-label":"Закрыть"}," ✕ ",8,$u)]),a("div",Iu,[u.value!=="idle"?(c(),d("div",Mu,[a("div",Nu,[a("div",{class:"progress-bar",style:we({width:`${l.value}%`})},null,4)]),a("div",xu,[a("span",Pu,g(Math.round(l.value))+"%",1),a("span",Lu,g(m.value),1)])])):(c(),d("div",Ou,[...y[3]||(y[3]=[a("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),a("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),a("div",Bu,[a("button",{class:"btn btn-secondary",onClick:k,disabled:n.value}," Отмена ",8,Ru),a("button",{class:"btn btn-primary",onClick:p,disabled:n.value},[n.value?(c(),d("span",Uu,[u.value==="loading_data"?(c(),d("span",Fu,"Загрузка данных...")):u.value==="creating_snapshot"?(c(),d("span",Hu,"Создание...")):(c(),d("span",ju,"Обработка..."))])):(c(),d("span",Vu,"Создать"))],8,Wu)])])])):$("",!0)]),_:1})]))])):$("",!0)}},Gu=de(zu,[["__scopeId","data-v-09bccee2"]]),Ku=20,qu=5*60*1e3;async function Yu({search:o="",limit:e=Ku,sectorDepartmentId:s=qt.SECTOR_1C}={}){const t=`sector1c_employees_${o}_${e}_${s||"all"}`,r=sessionStorage.getItem(t);if(r)try{const{data:i,timestamp:n}=JSON.parse(r);if(Date.now()-n<qu)return i}catch(i){console.warn("[sector1cEmployees] Cache parse error:",i)}try{const i={ACTIVE:"Y"};s?Array.isArray(s)?i.UF_DEPARTMENT=s:i.UF_DEPARTMENT=[s]:i.UF_DEPARTMENT=[qt.SECTOR_1C],o&&o.length>=2&&(i["%NAME"]=o,i["%LAST_NAME"]=o,i["%WORK_POSITION"]=o);const m=((await new vt().call("user.get",{filter:i,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,e).map(v=>({id:parseInt(v.ID),name:Xu(v),position:v.WORK_POSITION||"",department:v.UF_DEPARTMENT||null}));try{sessionStorage.setItem(t,JSON.stringify({data:m,timestamp:Date.now()}))}catch(v){console.warn("[sector1cEmployees] Cache write error:",v)}return m}catch(i){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",i),new Error(`Не удалось загрузить сотрудников: ${i.message}`)}}function Xu(o){const e=[o.LAST_NAME,o.NAME,o.SECOND_NAME].filter(Boolean);return e.length>0?e.join(" "):o.NAME||"Без имени"}function Ju(o,e=300){let s;return function(...r){const i=()=>{clearTimeout(s),o(...r)};clearTimeout(s),s=setTimeout(i,e)}}const Zu={class:"employee-select-field-text"},Qu={key:0,class:"employee-select-dropdown"},em={class:"employee-select-dropdown-search"},tm={key:0,class:"employee-select-state"},sm={key:1,class:"employee-select-state employee-select-state--error"},am={key:2,class:"employee-select-state"},om=["checked"],nm=["checked","onChange"],rm={class:"employee-select-item-content"},im={class:"employee-select-item-name"},lm={key:0,class:"employee-select-item-position"},cm={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(null),n=I(""),l=I([]),u=I(!1),m=I(null),v=I(!1),T=M(()=>{if(!n.value)return l.value;const D=n.value.toLowerCase();return l.value.filter(E=>E.name.toLowerCase().includes(D)||E.position&&E.position.toLowerCase().includes(D))}),f=M(()=>{if(s.selected.includes("all")||s.selected.length===0)return s.placeholder;if(s.selected.length===1){const D=l.value.find(E=>E.id===s.selected[0]);return D?D.name:s.placeholder}return`Выбрано: ${s.selected.length} ${W(s.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function k(D=""){u.value=!0,m.value=null;try{l.value=await Yu({search:D})}catch(E){m.value=E,t("error",E)}finally{u.value=!1}}function p(){t("search",n.value)}function S(){u.value||(v.value=!v.value,v.value?(l.value.length===0&&k(),Wt(()=>{i.value&&i.value.focus()})):n.value="")}function C(D){r.value&&!r.value.contains(D.target)&&(v.value=!1,n.value="")}function y(D){const E=[...s.selected],P=E.indexOf(D);if(D==="all")if(P>-1)E.splice(P,1);else return t("update:selected",["all"]);else if(P>-1)E.splice(P,1);else{const B=E.indexOf("all");B>-1&&E.splice(B,1),E.push(D)}t("update:selected",E)}function _(D){return D==="all"?s.selected.includes("all"):s.selected.includes(D)||s.selected.includes("all")}const A=M(()=>n.value?`Нет сотрудников по запросу "${n.value}"`:"Нет сотрудников сектора 1С");function W(D,E,P,B){const U=D%10,G=D%100;return G>=11&&G<=19?B:U===1?E:U>=2&&U<=4?P:B}function x(){k(n.value)}return Me(()=>s.selected,D=>{(!D||D.length===0)&&t("update:selected",["all"])},{immediate:!0}),Ae(()=>{document.addEventListener("click",C),(!s.selected||s.selected.length===0)&&t("update:selected",["all"])}),st(()=>{document.removeEventListener("click",C)}),(D,E)=>(c(),d("div",{class:"employee-select",ref_key:"selectContainer",ref:r},[a("div",{class:X(["employee-select-field",{"employee-select-field--open":v.value,"employee-select-field--disabled":u.value}]),onClick:S},[a("span",Zu,g(f.value),1),a("span",{class:X(["employee-select-field-icon",{open:v.value}])},"▼",2)],2),ne(Ee,{name:"dropdown-fade"},{default:pe(()=>[v.value?(c(),d("div",Qu,[a("div",em,[Le(a("input",{"onUpdate:modelValue":E[0]||(E[0]=P=>n.value=P),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:p,onClick:E[1]||(E[1]=Ce(()=>{},["stop"])),ref_key:"searchInput",ref:i},null,544),[[Et,n.value]])]),u.value?(c(),d("div",tm,[...E[6]||(E[6]=[a("span",{class:"spinner"},"⏳",-1),a("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):m.value?(c(),d("div",sm,[a("span",null,"❌ "+g(m.value.message||"Ошибка загрузки сотрудников"),1),a("button",{onClick:[x,E[2]||(E[2]=Ce(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!u.value&&T.value.length===0&&!m.value?(c(),d("div",am,[a("span",null,"📭 "+g(A.value),1)])):(c(),d("div",{key:3,class:"employee-select-list",style:we({maxHeight:`${o.maxHeight}px`})},[a("label",{class:X(["employee-select-item",{"employee-select-item--selected":_("all")}]),onClick:E[4]||(E[4]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:_("all"),onChange:E[3]||(E[3]=P=>y("all"))},null,40,om),E[7]||(E[7]=a("div",{class:"employee-select-item-content"},[a("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(c(!0),d(ee,null,te(T.value,P=>(c(),d("label",{key:P.id,class:X(["employee-select-item",{"employee-select-item--selected":_(P.id)}]),onClick:E[5]||(E[5]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:_(P.id),onChange:B=>y(P.id)},null,40,nm),a("div",rm,[a("span",im,g(P.name),1),P.position?(c(),d("span",lm,g(P.position),1)):$("",!0)])],2))),128))],4))])):$("",!0)]),_:1})],512))}},dm=de(cm,[["__scopeId","data-v-6b8c949b"]]),um={class:"stage-select-field-text"},mm={key:0,class:"stage-select-dropdown"},gm={class:"stage-select-list"},hm=["checked"],fm=["checked","onChange"],vm={class:"stage-select-item-content"},pm={class:"stage-select-item-name"},ym={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(!1),n=M(()=>Object.values(s.selected).every(f=>f===!0)),l=M(()=>{if(n.value)return s.placeholder;const f=s.stages.filter(k=>s.selected[k.id]);return f.length===0?"Этапы не выбраны":f.length===1?f[0].name:`Выбрано: ${f.length} этапа(ов)`});function u(){i.value=!i.value,i.value}function m(f){r.value&&!r.value.contains(f.target)&&(i.value=!1)}function v(f,k){const p={...s.selected};p[f]=k,t("update:selected",p),t("change",f,k)}function T(){const f=n.value,k={};s.stages.forEach(p=>{k[p.id]=!f}),t("update:selected",k),t("change","all",!f)}return Ae(()=>{document.addEventListener("click",m)}),st(()=>{document.removeEventListener("click",m)}),(f,k)=>(c(),d("div",{class:"stage-select",ref_key:"selectContainer",ref:r},[a("div",{class:X(["stage-select-field",{"stage-select-field--open":i.value,"stage-select-field--disabled":!1}]),onClick:u},[a("span",um,g(l.value),1),a("span",{class:X(["stage-select-field-icon",{open:i.value}])},"▼",2)],2),ne(Ee,{name:"dropdown-fade"},{default:pe(()=>[i.value?(c(),d("div",mm,[a("div",gm,[a("label",{class:X(["stage-select-item",{"stage-select-item--selected":n.value}]),onClick:k[0]||(k[0]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:n.value,onChange:T},null,40,hm),k[2]||(k[2]=a("div",{class:"stage-select-item-content"},[a("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(c(!0),d(ee,null,te(o.stages,p=>(c(),d("label",{key:p.id,class:X(["stage-select-item",{"stage-select-item--selected":o.selected[p.id]}]),onClick:k[1]||(k[1]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:o.selected[p.id],onChange:S=>v(p.id,S.target.checked)},null,40,fm),a("div",vm,[a("span",{class:"stage-select-item-color",style:we({backgroundColor:p.color})},null,4),a("span",pm,g(p.name),1)])],2))),128))])])):$("",!0)]),_:1})],512))}},km=de(ym,[["__scopeId","data-v-ce2229b2"]]),bm={class:"trigger-text"},_m={class:"week-picker-items"},wm=["data-week-number","onClick"],Cm={class:"week-item-content"},Tm={class:"week-number"},Sm={class:"week-dates"},Dm={class:"week-picker-actions"},Em=["disabled"],Am={__name:"WeekPicker",props:{selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52}},emits:["update:selectedWeek","change"],setup(o,{emit:e}){const s=o,t=e,r=I(null),i=I(null),n=I([]),l=I(!1),u=I(!1),m=I(null);function v(x=52,D=4){const E=[],P=new Date,B=T(P),U=f(P);for(let G=0;G<x;G++){const q=new Date(B.start);q.setUTCDate(q.getUTCDate()-G*7);const oe=T(q),Y=f(q);E.unshift({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}(E.length===0||E[E.length-1].weekNumber!==U)&&E.push({weekNumber:U,startUtc:B.start.toISOString(),endUtc:B.end.toISOString(),start:B.start,end:B.end});for(let G=1;G<=D;G++){const q=new Date(B.start);q.setUTCDate(q.getUTCDate()+G*7);const oe=T(q),Y=f(q);E.push({weekNumber:Y,startUtc:oe.start.toISOString(),endUtc:oe.end.toISOString(),start:oe.start,end:oe.end})}return E.sort((G,q)=>G.start-q.start),E}function T(x){const D=new Date(x),E=D.getUTCDay(),P=D.getUTCDate()-E+(E===0?-6:1),B=new Date(Date.UTC(D.getUTCFullYear(),D.getUTCMonth(),P,0,0,0)),U=new Date(B);return U.setUTCDate(U.getUTCDate()+6),U.setUTCHours(23,59,59,999),{start:B,end:U}}function f(x){const D=new Date(Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()));D.setUTCDate(D.getUTCDate()+4-(D.getUTCDay()||7));const E=new Date(Date.UTC(D.getUTCFullYear(),0,1));return Math.ceil(((D-E)/864e5+1)/7)}function k(x){const D=new Date(x),E=D.getUTCFullYear(),P=String(D.getUTCMonth()+1).padStart(2,"0"),B=String(D.getUTCDate()).padStart(2,"0");return`${E}-${P}-${B}`}function p(){u.value=!u.value,u.value&&(n.value=v(s.weeksCount,4),m.value=s.selectedWeek||n.value.find(x=>{const E=f(new Date);return x.weekNumber===E})||n.value[0],Wt(()=>{m.value&&_(m.value.weekNumber)}))}function S(x){m.value=x,_(x.weekNumber)}function C(){m.value&&(t("update:selectedWeek",m.value),t("change",m.value),u.value=!1)}function y(){m.value=s.selectedWeek||null,u.value=!1}function _(x){if(!i.value)return;const D=i.value.querySelector(`[data-week-number="${x}"]`);if(D){const E=i.value,P=D.offsetTop,B=E.clientHeight,U=D.clientHeight,G=P-B/2+U/2;E.scrollTo({top:G,behavior:"smooth"})}}function A(){l.value||!u.value||(l.value=!0,clearTimeout(window.weekPickerScrollTimeout),window.weekPickerScrollTimeout=setTimeout(()=>{if(!i.value){l.value=!1;return}const x=i.value,D=x.getBoundingClientRect(),E=D.top+D.height/2,P=x.querySelectorAll(".week-picker-item");let B=null,U=1/0;if(P.forEach(G=>{const q=G.getBoundingClientRect(),oe=q.top+q.height/2,Y=Math.abs(oe-E);Y<U&&(U=Y,B=G)}),B){const G=parseInt(B.dataset.weekNumber),q=n.value.find(oe=>oe.weekNumber===G);q&&(!m.value||q.weekNumber!==m.value.weekNumber)&&(m.value=q)}l.value=!1},150))}function W(x){r.value&&!r.value.contains(x.target)&&u.value&&y()}return Ae(()=>{if(n.value=v(s.weeksCount,4),s.selectedWeek)m.value=s.selectedWeek;else{const D=f(new Date),E=n.value.find(P=>P.weekNumber===D);E?m.value=E:m.value=n.value[0]}document.addEventListener("click",W)}),st(()=>{window.weekPickerScrollTimeout&&clearTimeout(window.weekPickerScrollTimeout),document.removeEventListener("click",W)}),Me(()=>s.selectedWeek,x=>{x&&(m.value=x,u.value&&!l.value&&Wt(()=>{_(x.weekNumber)}))},{deep:!0}),(x,D)=>(c(),d("div",{class:"week-picker",ref_key:"pickerContainer",ref:r},[D[1]||(D[1]=a("div",{class:"week-picker-label"},[a("span",{class:"section-icon"},"📅"),a("span",null,"Период")],-1)),a("div",{class:X(["week-picker-trigger",{"is-open":u.value}]),onClick:p},[a("span",bm,[o.selectedWeek?(c(),d(ee,{key:0},[ce(" Неделя "+g(o.selectedWeek.weekNumber)+" · "+g(k(o.selectedWeek.startUtc))+" — "+g(k(o.selectedWeek.endUtc)),1)],64)):(c(),d(ee,{key:1},[ce(" Выберите неделю ")],64))]),a("span",{class:X(["trigger-icon",{"is-open":u.value}])},"▼",2)],2),ne(Ee,{name:"dropdown-fade"},{default:pe(()=>[u.value?(c(),d("div",{key:0,class:"week-picker-dropdown",onClick:D[0]||(D[0]=Ce(()=>{},["stop"]))},[a("div",{class:"week-picker-wheel",ref_key:"wheelContainer",ref:i,onScroll:A},[a("div",_m,[(c(!0),d(ee,null,te(n.value,(E,P)=>(c(),d("div",{key:E.weekNumber,class:X(["week-picker-item",{active:E.weekNumber===m.value?.weekNumber}]),"data-week-number":E.weekNumber,onClick:B=>S(E)},[a("div",Cm,[a("div",Tm,"Неделя "+g(E.weekNumber),1),a("div",Sm,g(k(E.startUtc))+" — "+g(k(E.endUtc)),1)])],10,wm))),128))])],544),a("div",Dm,[a("button",{class:"btn-cancel",onClick:y},"Отмена"),a("button",{class:"btn-apply",onClick:C,disabled:!m.value},"Применить",8,Em)])])):$("",!0)]),_:1})],512))}},$m=de(Am,[["__scopeId","data-v-daae25a6"]]),Im={class:"filters-panel"},Mm={class:"filters-header"},Nm=["disabled"],xm={class:"filters-content"},Pm={key:0,class:"filter-section"},Lm={class:"section-content"},Om={class:"filter-section"},Bm={class:"section-content"},Rm={class:"filter-section"},Wm={key:0,class:"section-content"},Um={class:"section-content"},Fm={key:0,class:"period-mode-group"},Hm=["value"],jm=["disabled"],Vm=["disabled"],zm={key:0,class:"period-mode-hint"},Gm={key:1,class:"period-mode-hint"},Km=["value"],qm={key:0,class:"custom-date-range"},Ym={class:"date-range-inputs"},Xm={class:"date-input-group"},Jm=["value","max"],Zm={class:"date-input-group"},Qm=["value","min","max"],eg={key:0,class:"filter-error"},tg={key:1,class:"filter-hint"},sg={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1},hideStages:{type:Boolean,default:!1},weekPickerMode:{type:Boolean,default:!1},selectedWeek:{type:Object,default:null},weeksCount:{type:Number,default:52},showPeriodMode:{type:Boolean,default:!1},periodMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","update:selectedWeek","update:periodMode","reset","apply"],setup(o,{emit:e}){const s=o,t=e,r=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],i=I(null),n=M(()=>{const C=new Date;return C.setFullYear(C.getFullYear()-1),C.toISOString().split("T")[0]}),l=M(()=>new Date().toISOString().split("T")[0]);function u(C){t("update:stages",C),t("apply")}function m(C,y){t("apply")}function v(C){t("update:employees",C),t("apply")}function T(C){t("update:dateRange",C),i.value=null,t("apply")}function f(C,y){const _={...s.customDateRange};if(_[C]=y,_.startDate&&_.endDate){const A=new Date(_.startDate),W=new Date(_.endDate);if(A>W){i.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((W-A)/(1e3*60*60*24))>365){i.value="Период не может превышать 365 дней";return}}i.value=null,t("update:customDateRange",_),t("apply")}function k(C){t("update:selectedWeek",C),t("apply")}function p(C){if(!["weeks","months"].includes(C)){console.warn("[FiltersPanel] Invalid periodMode:",C);return}C!==s.periodMode&&(t("update:periodMode",C),t("apply"))}function S(){i.value=null,t("reset")}return(C,y)=>(c(),d("div",Im,[a("div",Mm,[y[4]||(y[4]=a("h2",null,"Фильтры",-1)),a("button",{onClick:S,class:"btn-reset-filters",disabled:!o.hasActiveFilters}," Сбросить фильтры ",8,Nm)]),a("div",xm,[o.hideStages?$("",!0):(c(),d("div",Pm,[y[5]||(y[5]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"📊"),ce(" Этапы ")],-1)),a("div",Lm,[ne(km,{selected:o.stages,stages:r,placeholder:"Выберите этапы","onUpdate:selected":u,onChange:m},null,8,["selected"])])])),a("div",Om,[y[6]||(y[6]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"👥"),ce(" Сотрудники сектора 1С ")],-1)),a("div",Bm,[ne(dm,{selected:o.employees,"onUpdate:selected":v},null,8,["selected"])])]),a("div",Rm,[o.weekPickerMode?(c(),d("div",Wm,[ne($m,{selectedWeek:o.selectedWeek,weeksCount:o.weeksCount,"onUpdate:selectedWeek":k,onChange:k},null,8,["selectedWeek","weeksCount"])])):(c(),d(ee,{key:1},[y[11]||(y[11]=a("h3",{class:"section-title"},[a("span",{class:"section-icon"},"📅"),ce(" Период ")],-1)),a("div",Um,[o.showPeriodMode?(c(),d("div",Fm,[y[7]||(y[7]=a("label",{class:"period-mode-label"},"Режим отображения:",-1)),a("select",{value:o.periodMode,onChange:y[0]||(y[0]=_=>p(_.target.value)),class:X(["period-mode-select",{"period-mode-select--current-weeks":o.periodMode==="weeks","period-mode-select--current-months":o.periodMode==="months"}])},[a("option",{value:"weeks",disabled:o.periodMode==="weeks"}," 4 последние недели ",8,jm),a("option",{value:"months",disabled:o.periodMode==="months"}," 3 последних месяца ",8,Vm)],42,Hm),o.periodMode==="weeks"?(c(),d("small",zm," Текущий режим: 4 последние недели ")):o.periodMode==="months"?(c(),d("small",Gm," Текущий режим: 3 последних месяца ")):$("",!0)])):$("",!0),o.showPeriodMode?$("",!0):(c(),d(ee,{key:1},[a("select",{value:o.dateRange,onChange:y[1]||(y[1]=_=>T(_.target.value)),class:"date-range-select"},[...y[8]||(y[8]=[a("option",{value:"last-week"},"Последняя неделя",-1),a("option",{value:"last-2-weeks"},"Последние 2 недели",-1),a("option",{value:"last-month"},"Последний месяц",-1),a("option",{value:"custom"},"Произвольный период",-1)])],40,Km),o.dateRange==="custom"?(c(),d("div",qm,[a("div",Ym,[a("div",Xm,[y[9]||(y[9]=a("label",null,"С:",-1)),a("input",{type:"date",value:o.customDateRange.startDate,onChange:y[2]||(y[2]=_=>f("startDate",_.target.value)),max:o.customDateRange.endDate||l.value,class:"date-input"},null,40,Jm)]),a("div",Zm,[y[10]||(y[10]=a("label",null,"По:",-1)),a("input",{type:"date",value:o.customDateRange.endDate,onChange:y[3]||(y[3]=_=>f("endDate",_.target.value)),min:o.customDateRange.startDate||n.value,max:l.value,class:"date-input"},null,40,Qm)])]),i.value?(c(),d("small",eg,g(i.value),1)):(c(),d("small",tg," Выберите начальную и конечную дату для отображения данных "))])):$("",!0)],64))])],64))])])]))}},Hs=de(sg,[["__scopeId","data-v-5970a362"]]);function ag(){const o=I(!1),e=I(null),s=I(null),t=I(0),r=lt(),i=async(C=!0,y=null)=>{o.value=!0,e.value=null,t.value=0;try{const _=await Ws.getSectorDataForSnapshot({useCache:C,onProgress:A=>{A&&typeof A.progress=="number"&&(t.value=A.progress),y&&y(A)},normalize:!0});return s.value=_,_}catch(_){throw e.value=_.message||"Ошибка загрузки данных сектора",r.error("Ошибка загрузки данных сектора: "+e.value),_}finally{o.value=!1,t.value=100}},n=async(C,y={})=>{if(!s.value){const _="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw e.value=_,r.error(_),new Error(_)}o.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(C))throw new Error(`Неверный тип слепка: ${C}. Допустимые значения: week_start, week_end, manual, current`);const _=await pt.createSnapshot(s.value,C,y);return r.success("Слепок успешно создан"),_}catch(_){throw e.value=_.message||"Ошибка создания слепка",r.error("Ошибка создания слепка: "+e.value),_}finally{o.value=!1}},l=()=>{o.value=!1,e.value=null,s.value=null,t.value=0},u=M(()=>s.value!==null&&s.value!==void 0),m=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),v=M(()=>{const C=new Date;let y,_;switch(m.value.dateRange){case"last-week":y=new Date(C),y.setDate(C.getDate()-7),_=C;break;case"last-2-weeks":y=new Date(C),y.setDate(C.getDate()-14),_=C;break;case"last-month":y=new Date(C),y.setMonth(C.getMonth()-1),_=C;break;case"custom":y=m.value.customDateRange.startDate?new Date(m.value.customDateRange.startDate):null,_=m.value.customDateRange.endDate?new Date(m.value.customDateRange.endDate):null;break;default:y=new Date(C),y.setDate(C.getDate()-7),_=C}return{startDate:y?y.toISOString().split("T")[0]:null,endDate:_?_.toISOString().split("T")[0]:null}}),T=()=>{k()},f=()=>{m.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},k()},k=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(m.value))}catch(C){console.error("Ошибка сохранения фильтров в localStorage:",C)}},p=()=>{try{const C=localStorage.getItem("graphStateFilters");if(C){const y=JSON.parse(C);y&&typeof y=="object"&&(m.value={stages:y.stages||{formed:!0,review:!0,execution:!0},employees:y.employees||["all"],dateRange:y.dateRange||"last-week",customDateRange:y.customDateRange||{startDate:null,endDate:null}})}}catch(C){console.error("Ошибка загрузки фильтров из localStorage:",C)}},S=M(()=>{const C=Object.values(m.value.stages).some(A=>!A),y=!m.value.employees.includes("all"),_=m.value.dateRange!=="last-week";return C||y||_});return{isLoading:o,error:e,currentSectorData:s,loadingProgress:t,hasSectorData:u,filters:m,selectedPeriod:v,hasActiveFilters:S,loadSectorDataForSnapshot:i,createSnapshot:n,resetState:l,applyFilters:T,resetFilters:f,saveFiltersToLocalStorage:k,loadFiltersFromLocalStorage:p}}const og={class:"graph-state-dashboard"},ng={key:1,class:"error-message-container"},rg={class:"error-message"},ig={class:"error-text"},lg={key:0,class:"error-details"},cg={class:"dashboard-header"},dg={class:"header-content"},ug={class:"breadcrumbs-row"},mg=["aria-disabled","data-fallback","disabled"],gg={class:"breadcrumbs","aria-label":"Навигация"},hg={class:"header-actions"},fg=["disabled"],vg={key:0},pg={key:1},yg={key:3,class:"dashboard-content"},kg={class:"chart-container"},bg="Назад",_g={__name:"GraphStateDashboard",setup(o){const e=(ae,ge)=>typeof window>"u"?ge:getComputedStyle(document.documentElement).getPropertyValue(ae).trim()||ge,s=lt(),t=Xe(),r={name:"dashboard-sector-1c"},{filters:i,selectedPeriod:n,hasActiveFilters:l,applyFilters:u,resetFilters:m,loadFiltersFromLocalStorage:v}=ag(),T=I(null),f=I(!0),k=I(!1),p=I("Загрузка данных..."),S=I(null),C=I(!1),y=I(!1),_=I(typeof window<"u"?window.innerWidth:1024),A=I(null),W=I(!1),x=M(()=>_.value<768);M(()=>_.value>=768&&_.value<1024),M(()=>_.value>=1024);const D=M(()=>typeof window>"u"?!1:window.history.length>1);M(()=>{const ae=new Date;return ae.setFullYear(ae.getFullYear()-1),ae.toISOString().split("T")[0]}),M(()=>new Date().toISOString().split("T")[0]);function E(ae){i.value.stages=ae}function P(ae){i.value.employees=ae}function B(ae){i.value.dateRange=ae}function U(ae){i.value.customDateRange=ae}function G(){u()}function q(){m(),A.value=null,G(),s.info("Фильтры сброшены")}function oe(ae){s.success("Слепок успешно создан")}function Y(ae){k.value=!1,p.value="",console.log("Данные графика загружены:",ae)}function H(ae){k.value=!1,Z({message:ae||"Ошибка загрузки графика",details:null,type:"error"})}function Z(ae){S.value={message:ae.message||"Произошла ошибка",details:ae.details||null,type:ae.type||"error",timestamp:new Date},console.error("Dashboard error:",S.value),s.error(S.value.message)}function fe(){S.value=null}function L(){S.value=null,k.value=!0,p.value="Повторная загрузка данных..."}async function h(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){s.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}C.value=!0;try{const ae=document.querySelector(".chart-container");if(!ae)throw new Error("График не найден");const ge=window.html2canvas,Se=await ge(ae,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),$e=window.jsPDF,Ne=new $e("landscape","mm","a4"),Fe=297,z=Se.height*Fe/Se.width;Ne.setFontSize(18),Ne.text("График состояния сектора 1С",148.5,15,{align:"center"});const N=new Date().toLocaleDateString("ru-RU");Ne.setFontSize(10);const b=n.value.startDate&&n.value.endDate?`Период: ${n.value.startDate} - ${n.value.endDate}`:"Период: не указан";Ne.text(b,148.5,25,{align:"center"}),Ne.text(`Экспорт от ${N}`,148.5,30,{align:"center"}),Ne.addImage(Se.toDataURL("image/png"),"PNG",10,35,Fe-20,z-20),Ne.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${N}`,author:"Bitrix24 Dashboard"});const O=`graph-state-${N.replace(/\//g,"-")}.pdf`;Ne.save(O),s.success("График успешно экспортирован в PDF")}catch(ae){console.error("Ошибка экспорта в PDF:",ae),Z({message:"Ошибка экспорта в PDF: "+(ae.message||"Неизвестная ошибка"),details:ae.stack,type:"error"})}finally{C.value=!1}}function w(ae){if(ae?.preventDefault?.(),!W.value){W.value=!0;try{if(D.value){t.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),t.push(r)}finally{W.value=!1}}}function R(){t.push("/")}function re(){typeof window<"u"&&(_.value=window.innerWidth)}async function le(){try{const ae=await rt.checkAccess();ae.allowed&&(T.value=ae.user)}catch(ae){console.error("Error loading user:",ae)}}return Ae(()=>{v(),le(),typeof window<"u"&&(_.value=window.innerWidth,window.addEventListener("resize",re))}),st(()=>{typeof window<"u"&&window.removeEventListener("resize",re)}),(ae,ge)=>{const Se=be("router-link");return c(),d("div",og,[k.value?(c(),he(bs,{key:0,message:p.value},null,8,["message"])):$("",!0),S.value?(c(),d("div",ng,[a("div",rg,[a("div",{class:"error-header"},[ge[1]||(ge[1]=a("span",{class:"error-icon"},"❌",-1)),ge[2]||(ge[2]=a("h3",null,"Ошибка",-1)),a("button",{onClick:fe,class:"error-close","aria-label":"Закрыть"},"✕")]),a("p",ig,g(S.value.message),1),S.value.details?(c(),d("div",lg,[a("details",null,[ge[3]||(ge[3]=a("summary",null,"Детали ошибки",-1)),a("pre",null,g(S.value.details),1)])])):$("",!0),a("div",{class:"error-actions"},[a("button",{onClick:L,class:"btn-retry"},"Повторить попытку")])])])):$("",!0),a("div",cg,[a("div",dg,[a("div",ug,[a("button",{class:"btn-home-link",type:"button",onClick:R,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),ge[9]||(ge[9]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:w,"aria-label":bg,"aria-disabled":!D.value,"data-fallback":!D.value,disabled:W.value,title:"Назад"}," ← ",8,mg),a("nav",gg,[ne(Se,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...ge[4]||(ge[4]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),ge[6]||(ge[6]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ge[7]||(ge[7]=a("span",{class:"breadcrumb-current"},"График состояния",-1)),ge[8]||(ge[8]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(Se,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:pe(()=>[...ge[5]||(ge[5]=[ce(" График приёма и закрытий ",-1)])]),_:1})])]),ge[10]||(ge[10]=a("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),ge[11]||(ge[11]=a("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),a("div",hg,[a("button",{onClick:h,class:"btn-export-pdf",disabled:C.value||k.value,title:"Экспортировать график в PDF"},[C.value?(c(),d("span",pg,"⏳ Экспорт...")):(c(),d("span",vg,"📄 Экспорт в PDF"))],8,fg),ne(Gu,{user:T.value,onSnapshotCreated:oe},null,8,["user"])])]),x.value?(c(),d("button",{key:2,class:"mobile-filters-toggle",onClick:ge[0]||(ge[0]=$e=>y.value=!y.value)},[ge[12]||(ge[12]=a("span",null,"Фильтры",-1)),a("span",{class:X(["toggle-icon",{open:y.value}])},"▼",2)])):$("",!0),a("div",{class:X({"mobile-open":y.value&&x.value,"mobile-closed":!y.value&&x.value})},[ne(Hs,{stages:We(i).stages,employees:We(i).employees,dateRange:We(i).dateRange,customDateRange:We(i).customDateRange,hasActiveFilters:We(l),"onUpdate:stages":E,"onUpdate:employees":P,"onUpdate:dateRange":B,"onUpdate:customDateRange":U,onReset:q,onApply:G},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!k.value&&!S.value?(c(),d("div",yg,[a("div",kg,[ne(Tu,{period:We(n),"show-current-state":f.value,onDataLoaded:Y,onError:H},null,8,["period","show-current-state"])])])):$("",!0)])}}},Ba=de(_g,[["__scopeId","data-v-831b0079"]]),wg=Object.freeze(Object.defineProperty({__proto__:null,default:Ba},Symbol.toStringTag,{value:"Module"})),Cg={key:0,class:"modal-overlay"},Tg={class:"modal-container",role:"dialog","aria-labelledby":"modal-title","aria-modal":"true"},Sg={class:"modal-body"},Dg={class:"mode-description"},Eg={__name:"PeriodModeInfoModal",props:{isVisible:{type:Boolean,required:!0},currentMode:{type:String,default:"weeks",validator:o=>["weeks","months"].includes(o)}},emits:["close","start-loading","select-mode"],setup(o,{emit:e}){const s=o,t=e,r=I(s.currentMode);function i(u){if(!["weeks","months"].includes(u)){console.warn("[PeriodModeInfoModal] Invalid mode:",u);return}r.value=u,console.log("[DEBUG Modal] handleModeSelect: mode =",u),console.log("[DEBUG Modal] Emitting select-mode event"),t("select-mode",u),console.log("[DEBUG Modal] Emitting close event"),t("close"),console.log("[DEBUG Modal] Scheduling start-loading event in 100ms"),setTimeout(()=>{console.log("[DEBUG Modal] Emitting start-loading event"),t("start-loading")},100)}function n(){console.log("[DEBUG Modal] handleClose called, selectedMode =",r.value),console.log("[DEBUG Modal] Emitting select-mode event with",r.value),t("select-mode",r.value),console.log("[DEBUG Modal] Emitting close event"),t("close")}function l(u){u.key==="Escape"&&s.isVisible&&n()}return Me(()=>s.currentMode,u=>{["weeks","months"].includes(u)&&(r.value=u)}),Ae(()=>{s.isVisible&&document.addEventListener("keydown",l)}),st(()=>{document.removeEventListener("keydown",l)}),Me(()=>s.isVisible,u=>{u?(document.addEventListener("keydown",l),r.value=s.currentMode):document.removeEventListener("keydown",l)}),(u,m)=>(c(),he($t,{to:"body"},[ne(Ee,{name:"modal-fade"},{default:pe(()=>[o.isVisible?(c(),d("div",Cg,[a("div",Tg,[a("div",{class:"modal-header"},[m[2]||(m[2]=a("h2",{id:"modal-title",class:"modal-title"},[a("span",{class:"modal-icon"},"ℹ️"),ce(" Выбор режима отображения ")],-1)),a("button",{class:"modal-close-btn",onClick:n,"aria-label":"Закрыть",type:"button"}," × ")]),a("div",Sg,[m[5]||(m[5]=a("p",{class:"modal-description"}," Выберите режим отображения данных для графика приёма и закрытий: ",-1)),a("div",Dg,[a("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="weeks"}]),onClick:m[0]||(m[0]=v=>i("weeks")),type:"button"},[...m[3]||(m[3]=[a("div",{class:"mode-header"},[a("span",{class:"mode-icon"},"📅"),a("h3",{class:"mode-title"},"4 последние недели")],-1),a("p",{class:"mode-text"}," Отображение данных за последние 4 недели с детализацией по неделям. Подходит для краткосрочного анализа динамики поступления и закрытия тикетов. ",-1)])],2),a("button",{class:X(["mode-item mode-item--clickable",{"mode-item--selected":r.value==="months"}]),onClick:m[1]||(m[1]=v=>i("months")),type:"button"},[...m[4]||(m[4]=[a("div",{class:"mode-header"},[a("span",{class:"mode-icon"},"📊"),a("h3",{class:"mode-title"},"3 последних месяца")],-1),a("p",{class:"mode-text"}," Отображение данных за последние 3 месяца с детализацией по месяцам и неделям внутри месяцев. Подходит для долгосрочного анализа и выявления трендов. ",-1)])],2)])])])])):$("",!0)]),_:1})]))}},Ag=de(Eg,[["__scopeId","data-v-4a42a9a6"]]),$g={class:"ac-chart"},Ig={class:"ac-chart__header"},Mg={class:"ac-chart__subtitle"},Ng={class:"ac-chart__controls"},xg={class:"chart-type-selector"},Pg=["onClick"],Lg={class:"chart-type-icon"},Og={class:"chart-type-label"},Bg={class:"ac-chart__summary"},Rg={class:"summary-week-block summary-week-block--current"},Wg={class:"summary-week-block__title"},Ug={class:"summary-week-block__title-week"},Fg={key:0,class:"summary-week-block__title-dates"},Hg={class:"summary-week-block__cards"},jg={class:"summary-card__value-wrapper"},Vg={class:"summary-card__value"},zg=["title"],Gg={class:"percentage-indicator__arrow"},Kg={class:"percentage-indicator__value"},qg={class:"percentage-indicator__label"},Yg={class:"summary-card__value-wrapper"},Xg={class:"summary-card__value-main"},Jg=["title"],Zg={class:"percentage-indicator__arrow"},Qg={class:"percentage-indicator__value"},eh={class:"percentage-indicator__label"},th={class:"summary-card__breakdown"},sh={class:"breakdown-item breakdown-item--this-week"},ah={class:"breakdown-item__value"},oh={class:"breakdown-item breakdown-item--other-week"},nh={class:"breakdown-item__value"},rh={class:"summary-card__value-wrapper"},ih={class:"summary-card__value-main"},lh=["title"],ch={class:"percentage-indicator__arrow"},dh={class:"percentage-indicator__value"},uh={class:"percentage-indicator__label"},mh={class:"summary-card__breakdown"},gh={class:"breakdown-item breakdown-item--this-week"},hh={class:"breakdown-item__value"},fh={class:"breakdown-item breakdown-item--previous-week"},vh={class:"breakdown-item__value"},ph={class:"breakdown-item breakdown-item--older"},yh={class:"breakdown-item__value"},kh={class:"summary-card summary-card--stages"},bh={class:"summary-card__tags"},_h={key:0,class:"stage-tag stage-tag--empty"},wh={key:0,class:"summary-week-divider"},Ch={key:1,class:"summary-week-block summary-week-block--previous"},Th={class:"summary-week-block__title"},Sh={class:"summary-week-block__title-week"},Dh={key:0,class:"summary-week-block__title-dates"},Eh={class:"summary-week-block__cards"},Ah={class:"summary-card__value-wrapper"},$h={class:"summary-card__values-comparison"},Ih={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},Mh={class:"summary-card__value"},Nh={class:"value-label"},xh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},Ph={class:"summary-card__value summary-card__value--current-week"},Lh={class:"value-label"},Oh=["title"],Bh={class:"percentage-indicator__arrow"},Rh={class:"percentage-indicator__value"},Wh={class:"percentage-indicator__label"},Uh={class:"summary-card__value-wrapper"},Fh={class:"summary-card__values-comparison"},Hh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},jh={class:"summary-card__value-main"},Vh={class:"value-label"},zh={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},Gh={class:"summary-card__value-main summary-card__value-main--current-week"},Kh={class:"value-label"},qh=["title"],Yh={class:"percentage-indicator__arrow"},Xh={class:"percentage-indicator__value"},Jh={class:"percentage-indicator__label"},Zh={class:"summary-card__breakdown"},Qh={class:"breakdown-item breakdown-item--this-week"},ef={class:"breakdown-item__value"},tf={class:"breakdown-item breakdown-item--other-week"},sf={class:"breakdown-item__value"},af={class:"summary-card__value-wrapper"},of={class:"summary-card__values-comparison"},nf={class:"summary-card__value-comparison-item summary-card__value-comparison-item--previous"},rf={class:"summary-card__value-main"},lf={class:"value-label"},cf={class:"summary-card__value-comparison-item summary-card__value-comparison-item--current"},df={class:"summary-card__value-main summary-card__value-main--current-week"},uf={class:"value-label"},mf=["title"],gf={class:"percentage-indicator__arrow"},hf={class:"percentage-indicator__value"},ff={class:"percentage-indicator__label"},vf={class:"summary-card__breakdown"},pf={class:"breakdown-item breakdown-item--this-week"},yf={class:"breakdown-item__value"},kf={class:"breakdown-item breakdown-item--previous-week"},bf={class:"breakdown-item__value"},_f={class:"breakdown-item breakdown-item--older"},wf={class:"breakdown-item__value"},Cf={class:"summary-card summary-card--stages summary-card--previous"},Tf={class:"summary-card__tags"},Sf={key:0,class:"stage-tag stage-tag--empty"},Df={class:"ac-chart__body"},Ef={key:0,class:"split-charts-container"},Af={class:"chart-wrapper chart-wrapper--left"},$f={class:"chart-canvas-wrapper"},If={class:"chart-wrapper chart-wrapper--right"},Mf={class:"chart-canvas-wrapper"},Nf={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:()=>({weekNumber:null,weekStartUtc:null,weekEndUtc:null})},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,closedTicketsCreatedThisWeek:0,closedTicketsCreatedOtherWeek:0,carryoverTickets:0,carryoverTicketsCreatedThisWeek:0,carryoverTicketsCreatedPreviousWeek:0,carryoverTicketsCreatedOlder:0,carryoverTicketsCreatedOtherWeek:0,series:{new:[0],closed:[0],closedCreatedThisWeek:[0],closedCreatedOtherWeek:[0],carryover:[0],carryoverCreatedThisWeek:[0],carryoverCreatedPreviousWeek:[0],carryoverCreatedOlder:[0],carryoverCreatedOtherWeek:[0]},stagesByWeek:[],stages:[],responsible:[]})}},emits:["open-responsible","open-stages","open-carryover"],setup(o,{emit:e}){Je.register(pa);const s=o,t=e,r=M(()=>{const h=s.meta?.weeks||[];return h.length>=2?h[h.length-2]:null}),i=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],n=I("line"),l={color:"#111827",font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:h=>h?.dataset?.borderColor||"#111827",borderWidth:1,borderRadius:4,padding:4,offset:8,formatter:h=>h==null||isNaN(h)?"":y(h),display:h=>{if(h?.chart?.config?.type!=="line")return!1;const R=h?.dataset?.data?.[h.dataIndex];return R!=null&&!isNaN(R)&&isFinite(R)}};M(()=>s.meta?.weekNumber??"—");const u=()=>{const h=s.meta?.weeks||[];return h.length>0?h.map(w=>`Неделя ${w.weekNumber}`):[s.meta?.weekNumber?`Неделя ${s.meta.weekNumber}`:"Неделя"]};function m(h,w,R,re=.3,le=0){if(!w)return(($e,Ne)=>{const Fe=parseInt($e.slice(1,3),16),z=parseInt($e.slice(3,5),16),N=parseInt($e.slice(5,7),16);return`rgba(${Fe}, ${z}, ${N}, ${Ne})`})(R,re);const ae=(Se,$e)=>{const Ne=parseInt(Se.slice(1,3),16),Fe=parseInt(Se.slice(3,5),16),z=parseInt(Se.slice(5,7),16);return`rgba(${Ne}, ${Fe}, ${z}, ${$e})`},ge=h.createLinearGradient(0,w.bottom,0,w.top);return ge.addColorStop(0,ae(R,re)),ge.addColorStop(1,ae(R,le)),ge}const v=M(()=>{const h=u(),w=Array.isArray(s.data.series?.new)&&s.data.series.new.length>0?s.data.series.new:[s.data.newTickets??0],R=Array.isArray(s.data.series?.closed)&&s.data.series.closed.length>0?s.data.series.closed:[s.data.closedTickets??0],re=Array.isArray(s.data.series?.closedCreatedThisWeek)&&s.data.series.closedCreatedThisWeek.length>0?s.data.series.closedCreatedThisWeek:[s.data.closedTicketsCreatedThisWeek??0],le=Array.isArray(s.data.series?.closedCreatedOtherWeek)&&s.data.series.closedCreatedOtherWeek.length>0?s.data.series.closedCreatedOtherWeek:[s.data.closedTicketsCreatedOtherWeek??0];return{labels:h,datasets:[{label:"Новые",data:w,backgroundColor:ae=>{const ge=ae.chart,{ctx:Se,chartArea:$e}=ge;return m(Se,$e,J.primary)},borderColor:J.primary,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:R,backgroundColor:ae=>{const ge=ae.chart,{ctx:Se,chartArea:$e}=ge;return m(Se,$e,J.success)},borderColor:J.success,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:re,backgroundColor:J.successLight,borderColor:J.successLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:le,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}}]}}),T=M(()=>{const h=u(),w=Array.isArray(s.data.series?.carryover)&&s.data.series.carryover.length>0?s.data.series.carryover:[s.data.carryoverTickets??0],R=Array.isArray(s.data.series?.carryoverCreatedThisWeek)&&s.data.series.carryoverCreatedThisWeek.length>0?s.data.series.carryoverCreatedThisWeek:[s.data.carryoverTicketsCreatedThisWeek??0],re=Array.isArray(s.data.series?.carryoverCreatedPreviousWeek)&&s.data.series.carryoverCreatedPreviousWeek.length>0?s.data.series.carryoverCreatedPreviousWeek:[s.data.carryoverTicketsCreatedPreviousWeek??0],le=Array.isArray(s.data.series?.carryoverCreatedOlder)&&s.data.series.carryoverCreatedOlder.length>0?s.data.series.carryoverCreatedOlder:[s.data.carryoverTicketsCreatedOlder??0];return Array.isArray(s.data.series?.carryoverCreatedOtherWeek)&&s.data.series.carryoverCreatedOtherWeek.length>0?s.data.series.carryoverCreatedOtherWeek:s.data.carryoverTicketsCreatedOtherWeek,{labels:h,datasets:[{label:"Переходящие (все)",data:w,backgroundColor:ae=>{const ge=ae.chart,{ctx:Se,chartArea:$e}=ge;return m(Se,$e,J.carryover)},borderColor:J.carryover,borderWidth:3,tension:.4,fill:!0,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:R,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:re,backgroundColor:J.warning,borderColor:J.warning,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:le,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,borderWidth:2,tension:.4,borderDash:[8,4],fill:!1,pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),f=M(()=>{const h=s.meta?.weeks||[],w=h.length>0?h.map(Fe=>`Неделя ${Fe.weekNumber}`):[s.meta?.weekNumber?`Неделя ${s.meta.weekNumber}`:"Неделя"],R=Array.isArray(s.data.series?.new)&&s.data.series.new.length>0?s.data.series.new:[s.data.newTickets??0],re=Array.isArray(s.data.series?.closed)&&s.data.series.closed.length>0?s.data.series.closed:[s.data.closedTickets??0],le=Array.isArray(s.data.series?.closedCreatedThisWeek)&&s.data.series.closedCreatedThisWeek.length>0?s.data.series.closedCreatedThisWeek:[s.data.closedTicketsCreatedThisWeek??0],ae=Array.isArray(s.data.series?.closedCreatedOtherWeek)&&s.data.series.closedCreatedOtherWeek.length>0?s.data.series.closedCreatedOtherWeek:[s.data.closedTicketsCreatedOtherWeek??0],ge=Array.isArray(s.data.series?.carryover)&&s.data.series.carryover.length>0?s.data.series.carryover:[s.data.carryoverTickets??0],Se=Array.isArray(s.data.series?.carryoverCreatedThisWeek)&&s.data.series.carryoverCreatedThisWeek.length>0?s.data.series.carryoverCreatedThisWeek:[s.data.carryoverTicketsCreatedThisWeek??0],$e=Array.isArray(s.data.series?.carryoverCreatedPreviousWeek)&&s.data.series.carryoverCreatedPreviousWeek.length>0?s.data.series.carryoverCreatedPreviousWeek:[s.data.carryoverTicketsCreatedPreviousWeek??0],Ne=Array.isArray(s.data.series?.carryoverCreatedOlder)&&s.data.series.carryoverCreatedOlder.length>0?s.data.series.carryoverCreatedOlder:[s.data.carryoverTicketsCreatedOlder??0];return Array.isArray(s.data.series?.carryoverCreatedOtherWeek)&&s.data.series.carryoverCreatedOtherWeek.length>0?s.data.series.carryoverCreatedOtherWeek:s.data.carryoverTicketsCreatedOtherWeek,{labels:w,datasets:[{label:"Новые",data:R,backgroundColor:J.primary,borderColor:J.primary,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.primary,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.primary,pointBackgroundColor:J.primary,datalabels:{...l,anchor:"end",align:"top",offset:10,color:J.primary,borderColor:J.primary}},{label:"Закрытые (все)",data:re,backgroundColor:J.success,borderColor:J.success,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.success,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.success,pointBackgroundColor:J.success,datalabels:{...l,anchor:"start",align:"bottom",offset:10,color:J.success,borderColor:J.success}},{label:"Закрытые (созданы этой неделей)",data:le,backgroundColor:J.successLight,borderColor:J.successLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.successLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.successLight,pointBackgroundColor:J.successLight,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.successLight,borderColor:J.successLight}},{label:"Закрытые (созданы другой неделей)",data:ae,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"bottom",offset:8,color:J.warning,borderColor:J.warning}},{label:"Переходящие (все)",data:ge,backgroundColor:J.carryover,borderColor:J.carryover,tension:.3,fill:!1,pointRadius:4,pointBorderWidth:1,pointBorderColor:J.carryover,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryover,pointBackgroundColor:J.carryover,datalabels:{...l,anchor:"end",align:"top",offset:4,color:J.carryover,borderColor:J.carryover}},{label:"Переходящие (созданы этой неделей)",data:Se,backgroundColor:J.carryoverLight,borderColor:J.carryoverLight,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverLight,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverLight,pointBackgroundColor:J.carryoverLight,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverLight,borderColor:J.carryoverLight}},{label:"Переходящие (созданы предыдущей неделей)",data:$e,backgroundColor:J.warning,borderColor:J.warning,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.warning,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.warning,pointBackgroundColor:J.warning,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.warning,borderColor:J.warning}},{label:"Переходящие (созданы остальными неделями)",data:Ne,backgroundColor:J.carryoverDark,borderColor:J.carryoverDark,tension:.3,fill:!1,borderDash:[5,5],pointRadius:3,pointBorderWidth:1,pointBorderColor:J.carryoverDark,pointHoverRadius:5,pointHoverBorderWidth:2,pointHoverBorderColor:"#ffffff",pointHoverBackgroundColor:J.carryoverDark,pointBackgroundColor:J.carryoverDark,datalabels:{...l,anchor:"end",align:"top",offset:6,color:J.carryoverDark,borderColor:J.carryoverDark}}]}}),k=M(()=>({labels:["Новые","Закрытые","Переходящие"],datasets:[{data:[s.data.newTickets??0,s.data.closedTickets??0,s.data.carryoverTickets??0],backgroundColor:[J.primary,J.success,J.carryover],borderWidth:1}]})),p=M(()=>{switch(n.value){case"line":return yt;case"bar":return va;case"doughnut":return fa;default:return yt}}),S=M(()=>n.value==="doughnut"?k.value:f.value),C=h=>{if(!h)return"—";try{return new Date(h).toLocaleDateString("ru-RU",{day:"2-digit",month:"short"})}catch{return h}};function y(h){return h==null||isNaN(h)?"0":h>=1e3?h.toLocaleString("ru-RU"):h.toString()}function _(h){const w=h%10,R=h%100;return R>=11&&R<=14?"тикетов":w===1?"тикет":w>=2&&w<=4?"тикета":"тикетов"}const A=M(()=>({responsive:!0,maintainAspectRatio:!1,resizeDelay:0,animation:{duration:800,easing:"easeOutQuart"},interaction:{intersect:!1,mode:"index"},plugins:{datalabels:{...l,anchor:"end",align:"top"},tooltip:{enabled:!0,backgroundColor:"rgba(255, 255, 255, 0.98)",titleColor:"#111827",bodyColor:"#374151",borderColor:"#e5e7eb",borderWidth:1,cornerRadius:8,padding:16,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},displayColors:!0,boxPadding:6,usePointStyle:!0,animation:{duration:300,easing:"easeOutQuart"},callbacks:{title:h=>{if(!h||h.length===0)return"";const w=h[0]?.dataIndex,R=s.meta?.weeks||[];if(R.length>0&&w!==void 0&&R[w]){const ge=R[w];return`Неделя ${ge.weekNumber} (${C(ge.weekStartUtc)} — ${C(ge.weekEndUtc)})`}const re=s.meta?.weekNumber,le=s.meta?.weekStartUtc,ae=s.meta?.weekEndUtc;return re&&le&&ae?`Неделя ${re} (${C(le)} — ${C(ae)})`:h[0]?.label||""},label:h=>{const w=h.parsed.y,R=h.dataset.label||"";if(w==null||isNaN(w))return`${R}: 0 тикетов`;const re=y(w),le=_(w);return`${R}: ${re} ${le}`}}},legend:{position:"bottom",labels:{font:{size:13,weight:"500"},padding:12,boxWidth:18,boxHeight:12,usePointStyle:!0,pointStyle:"circle",generateLabels:h=>Je.defaults.plugins.legend.labels.generateLabels(h).map((R,re)=>{const le=h.data.datasets[re],ae=h.getDatasetMeta(re),ge=le.borderDash&&Array.isArray(le.borderDash)&&le.borderDash.length>0||le.borderWidth===2||le.fill===!1;return ae.hidden?(R.fontColor="#9ca3af",R.textDecoration="line-through",R.opacity=.5):ge?R.fontColor="#6b7280":R.fontColor="#111827",R})},onClick:(h,w)=>{const R=w.datasetIndex;if(R==null){console.warn("[Legend] Invalid datasetIndex:",R);return}const re=h.chart;if(!re){console.warn("[Legend] Chart not found");return}const le=re.getDatasetMeta(R);if(!le){console.warn("[Legend] Dataset meta not found for index:",R);return}le.hidden=!le.hidden,re.update("active")},onHover:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="pointer")},onLeave:(h,w)=>{h.native&&h.native.target&&(h.native.target.style.cursor="default")}}},scales:n.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10,color:"#374151",callback:h=>h==null||isNaN(h)?"0":y(h)},title:{display:!1},grid:{color:h=>{if(!h||!h.tick||h.tick.value===void 0)return"#e5e7eb";const w=h.tick.value;return isNaN(w)||!isFinite(w)?"#e5e7eb":w===0||w%5===0?"#d1d5db":"#e5e7eb"},lineWidth:h=>{if(!h||!h.tick||h.tick.value===void 0)return 1;const w=h.tick.value;return isNaN(w)||!isFinite(w)?1:w===0||w%5===0?1.5:1}}},x:{ticks:{maxRotation:45,minRotation:45,font:{size:14},padding:10,color:"#374151"},title:{display:!1},grid:{color:"#e5e7eb",lineWidth:1}}}})),W=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=0){const R={newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0};if(R.carryoverTickets>0&&console.log("[DEBUG currentWeekData]",{total:R.carryoverTickets,thisWeek:R.carryoverTicketsCreatedThisWeek,previousWeek:R.carryoverTicketsCreatedPreviousWeek,older:R.carryoverTicketsCreatedOlder,otherWeek:R.carryoverTicketsCreatedOtherWeek,sum:R.carryoverTicketsCreatedThisWeek+R.carryoverTicketsCreatedPreviousWeek+R.carryoverTicketsCreatedOlder,lastIndex:w,series:{carryoverCreatedPreviousWeek:h.carryoverCreatedPreviousWeek,carryoverCreatedOlder:h.carryoverCreatedOlder,carryoverCreatedPreviousWeekLength:h.carryoverCreatedPreviousWeek?.length,carryoverCreatedOlderLength:h.carryoverCreatedOlder?.length,carryoverCreatedPreviousWeekLast:h.carryoverCreatedPreviousWeek?.[w],carryoverCreatedOlderLast:h.carryoverCreatedOlder?.[w]},currentWeek:s.data.currentWeek,data:{carryoverTicketsCreatedPreviousWeek:s.data.carryoverTicketsCreatedPreviousWeek,carryoverTicketsCreatedOlder:s.data.carryoverTicketsCreatedOlder}}),R.newTickets>0||R.closedTickets>0||R.carryoverTickets>0)return R}}if(s.data?.currentWeek&&typeof s.data.currentWeek=="object"){const h=s.data.currentWeek;if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(s.data?.weeksData&&Array.isArray(s.data.weeksData)&&s.data.weeksData.length>0){const h=s.data.weeksData[s.data.weeksData.length-1];if((h.newTickets??0)>0||(h.closedTickets??0)>0||(h.carryoverTickets??0)>0)return h}if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=0)return{newTickets:Array.isArray(h.new)&&h.new[w]!==void 0?h.new[w]:0,closedTickets:Array.isArray(h.closed)&&h.closed[w]!==void 0?h.closed[w]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[w]!==void 0?h.closedCreatedThisWeek[w]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[w]!==void 0?h.closedCreatedOtherWeek[w]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[w]!==void 0?h.carryover[w]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[w]!==void 0?h.carryoverCreatedThisWeek[w]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[w]!==void 0?h.carryoverCreatedPreviousWeek[w]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[w]!==void 0?h.carryoverCreatedOlder[w]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[w]!==void 0?h.carryoverCreatedOtherWeek[w]:0}}return s.data||{}}),x=M(()=>{const h=s.meta?.weeks||[];return h.length>0?h[h.length-1]:{weekNumber:s.meta?.currentWeek?.weekNumber??s.meta?.weekNumber??null,weekStartUtc:s.meta?.currentWeek?.weekStartUtc??s.meta?.weekStartUtc??null,weekEndUtc:s.meta?.currentWeek?.weekEndUtc??s.meta?.weekEndUtc??null}}),D=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.closedCreatedThisWeek)?h.closedCreatedThisWeek.length:0)-1,(Array.isArray(h.closedCreatedOtherWeek)?h.closedCreatedOtherWeek.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,(Array.isArray(h.carryoverCreatedThisWeek)?h.carryoverCreatedThisWeek.length:0)-1,(Array.isArray(h.carryoverCreatedPreviousWeek)?h.carryoverCreatedPreviousWeek.length:0)-1,(Array.isArray(h.carryoverCreatedOlder)?h.carryoverCreatedOlder.length:0)-1,(Array.isArray(h.carryoverCreatedOtherWeek)?h.carryoverCreatedOtherWeek.length:0)-1,-1);if(w>=1){const R=w-1,re=s.meta?.weeks?.[R],le={weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[R]!==void 0?h.closedCreatedThisWeek[R]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[R]!==void 0?h.closedCreatedOtherWeek[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[R]!==void 0?h.carryoverCreatedThisWeek[R]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[R]!==void 0?h.carryoverCreatedPreviousWeek[R]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[R]!==void 0?h.carryoverCreatedOlder[R]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[R]!==void 0?h.carryoverCreatedOtherWeek[R]:0};if(le.newTickets>0||le.closedTickets>0||le.carryoverTickets>0)return le}}if(s.data?.weeksData&&Array.isArray(s.data.weeksData)&&s.data.weeksData.length>=2){const h=s.data.weeksData.length-2,w=s.data.weeksData[h],R=s.meta?.weeks?.[h];if((w.newTickets??0)>0||(w.closedTickets??0)>0||(w.carryoverTickets??0)>0)return{weekNumber:w.weekNumber??R?.weekNumber??null,weekStartUtc:R?.weekStartUtc??null,weekEndUtc:R?.weekEndUtc??null,newTickets:w.newTickets??0,closedTickets:w.closedTickets??0,closedTicketsCreatedThisWeek:w.closedTicketsCreatedThisWeek??0,closedTicketsCreatedOtherWeek:w.closedTicketsCreatedOtherWeek??0,carryoverTickets:w.carryoverTickets??0,carryoverTicketsCreatedThisWeek:w.carryoverTicketsCreatedThisWeek??0,carryoverTicketsCreatedOtherWeek:w.carryoverTicketsCreatedOtherWeek??0}}if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=1){const R=w-1,re=s.meta?.weeks?.[R];return{weekNumber:re?.weekNumber??null,weekStartUtc:re?.weekStartUtc??null,weekEndUtc:re?.weekEndUtc??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,closedTicketsCreatedThisWeek:Array.isArray(h.closedCreatedThisWeek)&&h.closedCreatedThisWeek[R]!==void 0?h.closedCreatedThisWeek[R]:0,closedTicketsCreatedOtherWeek:Array.isArray(h.closedCreatedOtherWeek)&&h.closedCreatedOtherWeek[R]!==void 0?h.closedCreatedOtherWeek[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0,carryoverTicketsCreatedThisWeek:Array.isArray(h.carryoverCreatedThisWeek)&&h.carryoverCreatedThisWeek[R]!==void 0?h.carryoverCreatedThisWeek[R]:0,carryoverTicketsCreatedPreviousWeek:Array.isArray(h.carryoverCreatedPreviousWeek)&&h.carryoverCreatedPreviousWeek[R]!==void 0?h.carryoverCreatedPreviousWeek[R]:0,carryoverTicketsCreatedOlder:Array.isArray(h.carryoverCreatedOlder)&&h.carryoverCreatedOlder[R]!==void 0?h.carryoverCreatedOlder[R]:0,carryoverTicketsCreatedOtherWeek:Array.isArray(h.carryoverCreatedOtherWeek)&&h.carryoverCreatedOtherWeek[R]!==void 0?h.carryoverCreatedOtherWeek[R]:0}}}return null}),E=M(()=>{const h=s.data?.stagesByWeek;return Array.isArray(h)?h:null}),P=M(()=>{const h=E.value;if(h&&h.length>0){const w=h.length-1,R=h[w];if(Array.isArray(R))return R}return s.data?.stages??[]}),B=M(()=>{const h=E.value;if(h&&h.length>=2){const w=h.length-2,R=h[w];if(Array.isArray(R))return R}return[]}),U=M(()=>D.value?.weekNumber?`Нет данных для недели ${D.value.weekNumber}`:"Нет данных");function G(h,w){if(typeof h!="number"||isNaN(h)||w==null||typeof w!="number"||isNaN(w)||w===0)return null;if(h===w)return 0;const R=(h-w)/w*100;return!isFinite(R)||isNaN(R)?null:R}function q(h){return h==null||isNaN(h)?"":`${h>=0?"+":""}${h.toFixed(1)}%`}const oe=M(()=>{if(s.data?.series){const h=s.data.series,w=Math.max((Array.isArray(h.new)?h.new.length:0)-1,(Array.isArray(h.closed)?h.closed.length:0)-1,(Array.isArray(h.carryover)?h.carryover.length:0)-1,-1);if(w>=2){const R=w-2;return{weekNumber:s.meta?.weeks?.[R]?.weekNumber??null,newTickets:Array.isArray(h.new)&&h.new[R]!==void 0?h.new[R]:0,closedTickets:Array.isArray(h.closed)&&h.closed[R]!==void 0?h.closed[R]:0,carryoverTickets:Array.isArray(h.carryover)&&h.carryover[R]!==void 0?h.carryover[R]:0}}}return null}),Y=M(()=>{const h=W.value,w=D.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}}),H=M(()=>{const h=D.value,w=oe.value;return!h||!w?{newTickets:null,closedTickets:null,carryoverTickets:null}:{newTickets:G(h.newTickets??0,w.newTickets??0),closedTickets:G(h.closedTickets??0,w.closedTickets??0),carryoverTickets:G(h.carryoverTickets??0,w.carryoverTickets??0)}});function Z(h,w){if(!h||!w)return"";try{const R=new Date(h),re=new Date(w),le=R.getUTCDate(),ae=R.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),ge=R.getUTCFullYear(),Se=re.getUTCDate(),$e=re.toLocaleDateString("ru-RU",{month:"short",timeZone:"UTC"}),Ne=re.getUTCFullYear();return ge===Ne&&ae===$e?`${le} — ${Se} ${ae}`:ge===Ne?`${le} ${ae} — ${Se} ${$e}`:`${le} ${ae} ${ge} — ${Se} ${$e} ${Ne}`}catch(R){return console.error("[formatWeekDates] Error:",R),""}}const fe=h=>{const w=W.value,R=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,ae=x.value;h==="new"&&R>0?t("open-stages",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc})},L=h=>{const w=D.value;if(!w)return;const R=w?.newTickets??0,re=w?.closedTickets??0,le=w?.carryoverTickets??0,ae=r.value;ae&&(h==="new"&&R>0?t("open-stages",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="closed"&&re>0?t("open-responsible",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}):h==="carryover"&&le>0&&t("open-carryover",{weekNumber:ae.weekNumber,weekStartUtc:ae.weekStartUtc,weekEndUtc:ae.weekEndUtc}))};return(h,w)=>(c(),d("div",$g,[a("header",Ig,[a("div",null,[w[6]||(w[6]=a("h2",{class:"ac-chart__title"},"График приёма и закрытий сектора 1С",-1)),a("p",Mg," Неделя "+g(o.meta?.currentWeek?.weekNumber??o.meta?.weekNumber??"—")+" · "+g((o.meta?.currentWeek?.weekStartUtc??o.meta?.weekStartUtc)||"—")+" — "+g((o.meta?.currentWeek?.weekEndUtc??o.meta?.weekEndUtc)||"—")+" (UTC) ",1)]),a("div",Ng,[a("div",xg,[(c(),d(ee,null,te(i,R=>a("button",{key:R.value,class:X(["chart-type-btn",{active:n.value===R.value}]),onClick:re=>n.value=R.value},[a("span",Lg,g(R.icon),1),a("span",Og,g(R.label),1)],10,Pg)),64))])])]),a("section",Bg,[a("div",Rg,[a("h3",Wg,[w[7]||(w[7]=a("span",{class:"summary-week-block__title-text"},"Текущая неделя",-1)),a("span",Ug," Неделя "+g(x.value.weekNumber??"—"),1),x.value.weekStartUtc?(c(),d("span",Fg,g(Z(x.value.weekStartUtc,x.value.weekEndUtc)),1)):$("",!0)]),a("div",Hg,[a("div",{class:"summary-card summary-card--new",onClick:w[0]||(w[0]=R=>fe("new"))},[w[8]||(w[8]=a("div",{class:"summary-card__label"},"Новые за неделю",-1)),a("div",jg,[a("div",Vg,g(W.value?.newTickets??0),1),Y.value.newTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",Y.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.newTickets)}`},[a("span",Gg,g(Y.value.newTickets>=0?"↑":"↓"),1),a("span",Kg,g(q(Y.value.newTickets)),1),a("span",qg,"к неделе "+g(D.value?.weekNumber??"—"),1)],10,zg)):$("",!0)])]),a("div",{class:"summary-card summary-card--closed-breakdown",onClick:w[1]||(w[1]=R=>fe("closed"))},[w[13]||(w[13]=a("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),a("div",Yg,[a("div",Xg,g(W.value?.closedTickets??0),1),Y.value.closedTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",Y.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.closedTickets)}`},[a("span",Zg,g(Y.value.closedTickets>=0?"↑":"↓"),1),a("span",Qg,g(q(Y.value.closedTickets)),1),a("span",eh,"к неделе "+g(D.value?.weekNumber??"—"),1)],10,Jg)):$("",!0)]),a("div",th,[a("div",sh,[w[9]||(w[9]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",ah,g(W.value?.closedTicketsCreatedThisWeek??0),1),w[10]||(w[10]=a("span",{class:"breakdown-item__label"},"этой неделей",-1))]),a("div",oh,[w[11]||(w[11]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",nh,g(W.value?.closedTicketsCreatedOtherWeek??0),1),w[12]||(w[12]=a("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),a("div",{class:"summary-card summary-card--carryover-breakdown",onClick:w[2]||(w[2]=R=>fe("carryover"))},[w[20]||(w[20]=a("div",{class:"summary-card__label"},"Переходящие",-1)),a("div",rh,[a("div",ih,g(W.value?.carryoverTickets??0),1),Y.value.carryoverTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",Y.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предыдущей недели (Неделя ${D.value?.weekNumber??"—"}): ${q(Y.value.carryoverTickets)}`},[a("span",ch,g(Y.value.carryoverTickets>=0?"↑":"↓"),1),a("span",dh,g(q(Y.value.carryoverTickets)),1),a("span",uh,"к неделе "+g(D.value?.weekNumber??"—"),1)],10,lh)):$("",!0)]),a("div",mh,[a("div",gh,[w[14]||(w[14]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",hh,g(W.value?.carryoverTicketsCreatedThisWeek??0),1),w[15]||(w[15]=a("span",{class:"breakdown-item__label"},"этой недели",-1))]),a("div",fh,[w[16]||(w[16]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",vh,g(W.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[17]||(w[17]=a("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),a("div",ph,[w[18]||(w[18]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",yh,g(W.value?.carryoverTicketsCreatedOlder??0),1),w[19]||(w[19]=a("span",{class:"breakdown-item__label"},"остальные",-1))])])]),a("div",kh,[w[21]||(w[21]=a("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),a("div",bh,[(c(!0),d(ee,null,te(P.value,R=>(c(),d("span",{key:R.stageId,class:"stage-tag"},g(R.stageName||R.stageId)+" — "+g(R.count),1))),128)),!P.value||P.value.length===0?(c(),d("span",_h," Нет данных ")):$("",!0)])])])]),D.value?(c(),d("div",wh,[...w[22]||(w[22]=[a("div",{class:"summary-week-divider__line"},null,-1),a("div",{class:"summary-week-divider__label"},"Предыдущая неделя",-1)])])):$("",!0),D.value?(c(),d("div",Ch,[a("h3",Th,[w[23]||(w[23]=a("span",{class:"summary-week-block__title-text"},"Предыдущая неделя",-1)),a("span",Sh," Неделя "+g(D.value.weekNumber??"—"),1),D.value.weekStartUtc?(c(),d("span",Dh,g(Z(D.value.weekStartUtc,D.value.weekEndUtc)),1)):$("",!0)]),a("div",Eh,[a("div",{class:"summary-card summary-card--new summary-card--previous summary-card--clickable",onClick:w[3]||(w[3]=R=>L("new"))},[w[24]||(w[24]=a("div",{class:"summary-card__label"},"Новые за неделю",-1)),a("div",Ah,[a("div",$h,[a("div",Ih,[a("div",Mh,g(D.value?.newTickets??0),1),a("span",Nh,"Неделя "+g(D.value?.weekNumber??"—"),1)]),a("div",xh,[a("div",Ph,g(oe.value?.newTickets??0),1),a("span",Lh,"Неделя "+g(oe.value?.weekNumber??"—"),1)])]),H.value.newTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",H.value.newTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.newTickets)}`},[a("span",Bh,g(H.value.newTickets>=0?"↑":"↓"),1),a("span",Rh,g(q(H.value.newTickets)),1),a("span",Wh,"к неделе "+g(oe.value?.weekNumber??"—"),1)],10,Oh)):$("",!0)])]),a("div",{class:"summary-card summary-card--closed-breakdown summary-card--previous summary-card--clickable",onClick:w[4]||(w[4]=R=>L("closed"))},[w[29]||(w[29]=a("div",{class:"summary-card__label"},"Закрытые за неделю",-1)),a("div",Uh,[a("div",Fh,[a("div",Hh,[a("div",jh,g(D.value?.closedTickets??0),1),a("span",Vh,"Неделя "+g(D.value?.weekNumber??"—"),1)]),a("div",zh,[a("div",Gh,g(oe.value?.closedTickets??0),1),a("span",Kh,"Неделя "+g(oe.value?.weekNumber??"—"),1)])]),H.value.closedTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",H.value.closedTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.closedTickets)}`},[a("span",Yh,g(H.value.closedTickets>=0?"↑":"↓"),1),a("span",Xh,g(q(H.value.closedTickets)),1),a("span",Jh,"к неделе "+g(oe.value?.weekNumber??"—"),1)],10,qh)):$("",!0)]),a("div",Zh,[a("div",Qh,[w[25]||(w[25]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",ef,g(D.value?.closedTicketsCreatedThisWeek??0),1),w[26]||(w[26]=a("span",{class:"breakdown-item__label"},"этой неделей",-1))]),a("div",tf,[w[27]||(w[27]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",sf,g(D.value?.closedTicketsCreatedOtherWeek??0),1),w[28]||(w[28]=a("span",{class:"breakdown-item__label"},"другой неделей",-1))])])]),a("div",{class:"summary-card summary-card--carryover-breakdown summary-card--previous summary-card--clickable",onClick:w[5]||(w[5]=R=>L("carryover"))},[w[36]||(w[36]=a("div",{class:"summary-card__label"},"Переходящие",-1)),a("div",af,[a("div",of,[a("div",nf,[a("div",rf,g(D.value?.carryoverTickets??0),1),a("span",lf,"Неделя "+g(D.value?.weekNumber??"—"),1)]),a("div",cf,[a("div",df,g(oe.value?.carryoverTickets??0),1),a("span",uf,"Неделя "+g(oe.value?.weekNumber??"—"),1)])]),H.value.carryoverTickets!==null?(c(),d("div",{key:0,class:X(["percentage-indicator",H.value.carryoverTickets>=0?"percentage-indicator--positive":"percentage-indicator--negative"]),title:`Изменение относительно предпредыдущей недели (Неделя ${oe.value?.weekNumber??"—"}): ${q(H.value.carryoverTickets)}`},[a("span",gf,g(H.value.carryoverTickets>=0?"↑":"↓"),1),a("span",hf,g(q(H.value.carryoverTickets)),1),a("span",ff,"к неделе "+g(oe.value?.weekNumber??"—"),1)],10,mf)):$("",!0)]),a("div",vf,[a("div",pf,[w[30]||(w[30]=a("span",{class:"breakdown-item__icon"},"✓",-1)),a("span",yf,g(D.value?.carryoverTicketsCreatedThisWeek??0),1),w[31]||(w[31]=a("span",{class:"breakdown-item__label"},"этой недели",-1))]),a("div",kf,[w[32]||(w[32]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",bf,g(D.value?.carryoverTicketsCreatedPreviousWeek??0),1),w[33]||(w[33]=a("span",{class:"breakdown-item__label"},"предыдущей недели",-1))]),a("div",_f,[w[34]||(w[34]=a("span",{class:"breakdown-item__icon"},"↻",-1)),a("span",wf,g(D.value?.carryoverTicketsCreatedOlder??0),1),w[35]||(w[35]=a("span",{class:"breakdown-item__label"},"остальные",-1))])])]),a("div",Cf,[w[37]||(w[37]=a("div",{class:"summary-card__label"},"Закрытия по стадиям",-1)),a("div",Tf,[(c(!0),d(ee,null,te(B.value,R=>(c(),d("span",{key:R.stageId,class:"stage-tag"},g(R.stageName||R.stageId)+" — "+g(R.count),1))),128)),!B.value||B.value.length===0?(c(),d("span",Sf,g(U.value),1)):$("",!0)])])])])):$("",!0)]),a("div",Df,[n.value==="line"?(c(),d("div",Ef,[a("div",Af,[w[38]||(w[38]=a("h3",{class:"chart-subtitle"},"Новые и Закрытые тикеты",-1)),a("div",$f,[ne(We(yt),{data:v.value,options:A.value},null,8,["data","options"])])]),a("div",If,[w[39]||(w[39]=a("h3",{class:"chart-subtitle"},"Переходящие тикеты",-1)),a("div",Mf,[ne(We(yt),{data:T.value,options:A.value},null,8,["data","options"])])])])):(c(),he(wt(p.value),{key:1,data:S.value,options:A.value},null,8,["data","options"]))])]))}},xf=de(Nf,[["__scopeId","data-v-3666e13a"]]),Pf={class:"summary-cards-months"},Lf={class:"summary-card summary-card--new"},Of={class:"card-content"},Bf={class:"card-main-value"},Rf=["title"],Wf={class:"card-month-breakdown"},Uf={class:"month-name"},Ff={class:"month-value"},Hf={key:0,class:"month-item month-item--empty"},jf={class:"summary-card summary-card--closed"},Vf={class:"card-content"},zf={class:"card-main-value"},Gf=["title"],Kf={class:"card-month-breakdown-hierarchical"},qf={class:"month-header"},Yf={class:"month-name"},Xf={class:"month-value"},Jf={class:"month-breakdown"},Zf={class:"breakdown-item breakdown-this-week"},Qf={class:"breakdown-value"},ev={class:"breakdown-item breakdown-other-week"},tv={class:"breakdown-value"},sv={key:0,class:"month-item-hierarchical month-item--empty"},av={class:"summary-card summary-card--carryover"},ov={class:"card-content"},nv={class:"card-current-value"},rv={class:"current-value"},iv=["title"],lv={class:"card-month-breakdown"},cv={class:"month-name"},dv={class:"month-value"},uv={key:0,class:"month-item month-item--empty"},mv={class:"summary-card summary-card--stages"},gv={class:"card-content"},hv={class:"stages-list"},fv={class:"stage-icon"},vv={class:"stage-name"},pv={class:"stage-value"},yv={key:0,class:"stage-item stage-item--empty"},kv={__name:"SummaryCardsMonths",props:{data:{type:Object,required:!0,default:()=>({newTickets:0,newTicketsByMonth:[],closedTickets:0,closedTicketsByMonth:[],carryoverTickets:0,carryoverTicketsByMonth:[],stages:[]})}},setup(o){const e=o;function s(C){return C==null||isNaN(C)?"0":C>=1e6?(C/1e6).toFixed(1)+"M":C>=1e3?C.toLocaleString("ru-RU"):C.toString()}function t(C){return C==null||isNaN(C)?"":`${C>=0?"+":""}${C.toFixed(1)}%`}function r(C,y){if(typeof C!="number"||isNaN(C)||y==null||typeof y!="number"||isNaN(y)||y===0)return null;if(C===y)return 0;const _=(C-y)/y*100;return!isFinite(_)||isNaN(_)?null:_}const i=M(()=>e.data?.newTickets||0),n=M(()=>s(i.value)),l=M(()=>e.data?.newTicketsByMonth||[]),u=M(()=>e.data?.closedTicketsByMonth||[]),m=M(()=>e.data?.carryoverTicketsByMonth||[]),v=M(()=>{const C=m.value;return C.length===0?0:C[C.length-1]?.count||0}),T=M(()=>{const C=typeof e.data?.newTickets=="number"?e.data.newTickets:parseInt(e.data?.newTickets)||0,y=e.data?.previousPeriodData?.newTickets;return r(C,y)}),f=M(()=>{const C=typeof e.data?.closedTickets=="number"?e.data.closedTickets:parseInt(e.data?.closedTickets)||0,y=e.data?.previousPeriodData?.closedTickets;return r(C,y)}),k=M(()=>{const C=v.value,y=m.value,_=y.length>0?y[0]?.count||0:null;return r(C,_)});function p(C){return{"DT140_12:SUCCESS":"stage-success","DT140_12:FAIL":"stage-fail","DT140_12:UC_0GBU8Z":"stage-other"}[C]||""}function S(C){return{"DT140_12:SUCCESS":"✓","DT140_12:FAIL":"✗","DT140_12:UC_0GBU8Z":"⚠"}[C]||"•"}return(C,y)=>(c(),d("div",Pf,[a("div",Lf,[y[0]||(y[0]=a("h3",{class:"card-title"},"Новые за период",-1)),a("div",Of,[a("div",Bf,[ce(g(n.value)+" ",1),T.value!==null?(c(),d("span",{key:0,class:X(["percentage-badge",T.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(T.value)}`},g(t(T.value)),11,Rf)):$("",!0)]),a("div",Wf,[(c(!0),d(ee,null,te(l.value,_=>(c(),d("div",{key:`new-${_.month}`,class:"month-item"},[a("span",Uf,g(_.monthName)+":",1),a("span",Ff,g(s(_.count)),1)]))),128)),l.value.length===0?(c(),d("div",Hf," Нет данных ")):$("",!0)])])]),a("div",jf,[y[5]||(y[5]=a("h3",{class:"card-title"},"Закрытые всего",-1)),a("div",Vf,[a("div",zf,[ce(g(s(o.data.closedTickets||0))+" ",1),f.value!==null?(c(),d("span",{key:0,class:X(["percentage-badge",f.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(f.value)}`},g(t(f.value)),11,Gf)):$("",!0)]),a("div",Kf,[(c(!0),d(ee,null,te(u.value,_=>(c(),d("div",{key:`closed-${_.month}`,class:"month-item-hierarchical"},[a("div",qf,[a("span",Yf,g(_.monthName)+":",1),a("span",Xf,g(s(_.count||0)),1)]),a("div",Jf,[a("div",Zf,[y[1]||(y[1]=a("span",{class:"breakdown-icon"},"✓",-1)),y[2]||(y[2]=a("span",{class:"breakdown-label"},"этого месяца:",-1)),a("span",Qf,g(s(_.closedCreatedThisWeek||0)),1)]),a("div",ev,[y[3]||(y[3]=a("span",{class:"breakdown-icon"},"↻",-1)),y[4]||(y[4]=a("span",{class:"breakdown-label"},"другого месяца:",-1)),a("span",tv,g(s(_.closedCreatedOtherWeek||0)),1)])])]))),128)),u.value.length===0?(c(),d("div",sv," Нет данных ")):$("",!0)])])]),a("div",av,[y[7]||(y[7]=a("h3",{class:"card-title"},"Переходящие всего",-1)),y[8]||(y[8]=a("p",{class:"card-hint"},"Активные тикеты сектора в трех основных рабочих стадиях (текущее состояние)",-1)),a("div",ov,[a("div",nv,[y[6]||(y[6]=a("span",{class:"current-label"},"Текущее состояние:",-1)),a("span",rv,[ce(g(s(v.value))+" ",1),k.value!==null?(c(),d("span",{key:0,class:X(["percentage-badge",k.value>=0?"positive":"negative"]),title:`Изменение относительно предыдущего периода: ${t(k.value)}`},g(t(k.value)),11,iv)):$("",!0)])]),a("div",lv,[(c(!0),d(ee,null,te(m.value,_=>(c(),d("div",{key:`carryover-${_.month}`,class:"month-item"},[a("span",cv,g(_.monthName)+":",1),a("span",dv,g(s(_.count||0)),1)]))),128)),m.value.length===0?(c(),d("div",uv," Нет данных ")):$("",!0)])])]),a("div",mv,[y[10]||(y[10]=a("h3",{class:"card-title"},"Закрытия по стадиям",-1)),a("div",gv,[a("div",hv,[(c(!0),d(ee,null,te(o.data.stages||[],_=>(c(),d("div",{key:_.stageId,class:X(["stage-item",p(_.stageId)])},[a("span",fv,g(S(_.stageId)),1),a("span",vv,g(_.stageName||_.stageId)+":",1),a("span",pv,g(s(_.count||0)),1)],2))),128)),!o.data.stages||o.data.stages.length===0?(c(),d("div",yv,[...y[9]||(y[9]=[a("span",{class:"stage-name"},"Нет данных",-1)])])):$("",!0)])])])]))}},bv=de(kv,[["__scopeId","data-v-15d88b90"]]),_v={class:"line-chart-months"},wv={class:"chart-section"},Cv={class:"chart-title"},Tv={key:0,class:"chart-period"},Sv={class:"chart-wrapper"},Dv={class:"chart-container"},Ev={class:"chart-summary"},Av={class:"summary-numbers"},$v={class:"summary-row"},Iv={class:"summary-values"},Mv={class:"summary-row"},Nv={class:"summary-values"},xv={class:"summary-analysis"},Pv=["innerHTML"],Lv={class:"chart-section"},Ov={class:"chart-title"},Bv={key:0,class:"chart-period"},Rv={class:"chart-wrapper"},Wv={class:"chart-container"},Uv={class:"chart-analysis"},Fv={class:"analysis-content"},Hv=["innerHTML"],jv={class:"chart-table-section"},Vv={class:"chart-table-wrapper"},zv={class:"data-table"},Gv={class:"data-row data-row--new"},Kv={class:"data-row data-row--closed"},qv={class:"data-row data-row--carryover"},Yv={__name:"LineChartMonths",props:{data:{type:Object,required:!0,default:()=>({newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[]})},meta:{type:Object,default:()=>({months:[]})}},setup(o){Je.register(pa);const e=o;function s(p){return p==null||isNaN(p)?"0":p>=1e3?p.toLocaleString("ru-RU"):p.toString()}const t=M(()=>{const p=new Set;return e.data.newTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&p.add(C.weekNumber)})}),e.data.closedTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&p.add(C.weekNumber)})}),e.data.carryoverTicketsByMonth?.forEach(S=>{S.weeks&&Array.isArray(S.weeks)&&S.weeks.forEach(C=>{C&&C.weekNumber&&p.add(C.weekNumber)})}),Array.from(p).sort((S,C)=>S-C)}),r=M(()=>{const p=e.data.newTicketsByMonth||[],S=p.map(_=>_.monthName||`Месяц ${_.month}`),C=p.map(_=>_.count||0),y=(e.data.closedTicketsByMonth||[]).map(_=>_.count||0);return{labels:S,datasets:[{label:"Новые тикеты",data:C,borderColor:J.primary,backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:10,color:J.primary,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.primary,borderWidth:1,borderRadius:4,padding:4}},{label:"Закрытые тикеты",data:y,borderColor:J.success,backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"start",align:"bottom",offset:10,color:J.success,font:{size:12,weight:"bold"},backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:J.success,borderWidth:1,borderRadius:4,padding:4}}]}}),i=M(()=>{const p=e.data.carryoverTicketsByMonth||[],S=p.map(y=>y.monthName||`Месяц ${y.month}`),C=p.map(y=>y.count||0);return{labels:S,datasets:[{label:"Переходящие тикеты",data:C,borderColor:J.carryover,backgroundColor:"rgba(255, 152, 0, 0.1)",tension:.4,fill:!1,datalabels:{anchor:"end",align:"top",offset:4,color:J.carryover}}]}}),n={responsive:!0,maintainAspectRatio:!1,layout:{padding:{left:16,right:0,top:56,bottom:0}},plugins:{legend:{position:"left",labels:{font:{size:14,weight:"500"},padding:16,boxWidth:20,boxHeight:12}},tooltip:{enabled:!0,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:12},datalabels:{anchor:"end",align:"top",formatter:(p,S)=>p==null||isNaN(p)?"":p.toString(),color:"#333",font:{size:12,weight:"bold"},padding:{top:4,bottom:4},display:function(p){const S=p.dataset.data[p.dataIndex];return S!=null&&!isNaN(S)&&isFinite(S)},backgroundColor:"rgba(255, 255, 255, 0.8)",borderColor:"#333",borderWidth:1,borderRadius:4,padding:4}},scales:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:14},padding:10},grid:{lineWidth:1.5}},x:{ticks:{maxRotation:0,minRotation:0,font:{size:14},padding:10},grid:{lineWidth:1.5}}}};function l(p){if(!p||p.length===0)return null;const S=p[0],C=p[p.length-1];if(!S||!C)return null;const y=S.monthName||`Месяц ${S.month}`,_=C.monthName||`Месяц ${C.month}`,A=S.year||new Date().getFullYear();return`${y} — ${_} ${A}`}const u=M(()=>l(e.data?.newTicketsByMonth||[])),m=M(()=>l(e.data?.carryoverTicketsByMonth||[])),v=M(()=>{const p=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(p.length===0)return{new:"—",closed:"—"};const C=p.map(_=>`${s(_.count||0)} (${_.monthName||_.month})`).join(" → "),y=S.map(_=>`${s(_.count||0)} (${_.monthName||_.month})`).join(" → ");return{new:C,closed:y}}),T=M(()=>{const p=e.data?.newTicketsByMonth||[],S=e.data?.closedTicketsByMonth||[];if(p.length<2)return["Недостаточно данных для анализа"];const C=[],y=[],_=[];if(p.length>=2){const A=p[0],W=p[1],x=p[2];if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const D=A.monthName||A.month,E=W.monthName||W.month,P=s(A.count||0),B=s(W.count||0);if(A.count>0){const U=(W.count-A.count)/A.count*100;if(isFinite(U)&&!isNaN(U)){const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";y.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${P} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&y.push(`  • Появление тикетов: с 0 (${D}) до ${B} (${E})`)}if(x&&W&&typeof W.count=="number"&&typeof x.count=="number"){const D=W.monthName||W.month,E=x.monthName||x.month,P=s(W.count||0),B=s(x.count||0);if(W.count>0){const U=(x.count-W.count)/W.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)y.push(`  • Без изменений: ${P} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";y.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${P} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W.count===0&&x.count>0&&y.push(`  • Появление тикетов: с 0 (${D}) до ${B} (${E})`)}}if(S.length>=2){const A=S[0],W=S[1],x=S[2];if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const D=A.monthName||A.month,E=W.monthName||W.month,P=s(A.count||0),B=s(W.count||0);if(A.count>0){const U=(W.count-A.count)/A.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)_.push(`  • Без изменений: ${P} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${P} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${B} (${E})`)}if(x&&W&&typeof W.count=="number"&&typeof x.count=="number"){const D=W.monthName||W.month,E=x.monthName||x.month,P=s(W.count||0),B=s(x.count||0);if(W.count>0){const U=(x.count-W.count)/W.count*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<.1)_.push(`  • Без изменений: ${P} (${D}) → ${B} (${E}) — 0.0%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";_.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${P} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W.count===0&&x.count>0&&_.push(`  • Появление закрытий: с 0 (${D}) до ${B} (${E})`)}}if(y.length>0&&(C.push("Новые тикеты:"),C.push(...y)),_.length>0&&(C.push("Закрытые тикеты:"),C.push(..._)),p.length>=3&&S.length>=3){const A=p[0],W=p[p.length-1],x=S[0],D=S[S.length-1],E=A.count||0,P=W.count||0,B=x.count||0,U=D.count||0;if(E>0&&B>0){const G=(P-E)/E*100,q=(U-B)/B*100;if(isFinite(G)&&isFinite(q)){const oe=A.monthName||A.month,Y=W.monthName||W.month,H=x.monthName||x.month,Z=D.monthName||D.month,fe=G>=0?"#28a745":"#dc3545",L=G>=0?"#28a745":"#dc3545",h=q>=0?"#28a745":"#dc3545",w=q>=0?"#28a745":"#dc3545";C.push("Общая динамика за период:"),C.push(`  • Новые тикеты: <span style="color: ${fe}; font-weight: 600;">${G>=0?"рост":"снижение"}</span> с ${s(E)} (${oe}) до ${s(P)} (${Y}) — <span style="color: ${L}; font-weight: 600;">${G>=0?"+":"-"}${Math.abs(G).toFixed(1)}%</span>`),C.push(`  • Закрытые тикеты: <span style="color: ${h}; font-weight: 600;">${q>=0?"рост":"снижение"}</span> с ${s(B)} (${H}) до ${s(U)} (${Z}) — <span style="color: ${w}; font-weight: 600;">${q>=0?"+":"-"}${Math.abs(q).toFixed(1)}%</span>`)}}}return C.length>0?C:["Недостаточно данных для анализа"]}),f=M(()=>{const p=e.data?.carryoverTicketsByMonth||[];if(p.length===0)return["Нет данных для анализа"];const S=[],C=[],y=p.filter(_=>_&&typeof _.count=="number").map(_=>`${s(_.count||0)} (${_.monthName||_.month||"Неизвестно"})`).join(" → ");if(y&&S.push(`Переходящие тикеты: ${y}`),p.length>=2){const _=p[0],A=p[1],W=p[2];if(A&&_&&typeof _.count=="number"&&typeof A.count=="number"){const x=_.monthName||_.month,D=A.monthName||A.month,E=s(_.count||0),P=s(A.count||0);if(_.count>0){const B=(A.count-_.count)/_.count*100;if(isFinite(B)&&!isNaN(B))if(Math.abs(B)<.1)C.push(`  • Без изменений: ${E} (${x}) → ${P} (${D}) — 0.0%`);else{const U=B>=0?"Рост":"Снижение",G=Math.abs(B),q=B>=0?"+":"-",oe=B>=0?"#28a745":"#dc3545",Y=B>=0?"#28a745":"#dc3545";C.push(`  • <span style="color: ${oe}; font-weight: 600;">${U}</span> с ${E} (${x}) до ${P} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else _.count===0&&A.count>0&&C.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${P} (${D})`)}if(W&&A&&typeof A.count=="number"&&typeof W.count=="number"){const x=A.monthName||A.month,D=W.monthName||W.month,E=s(A.count||0),P=s(W.count||0);if(A.count>0){const B=(W.count-A.count)/A.count*100;if(isFinite(B)&&!isNaN(B))if(Math.abs(B)<.1)C.push(`  • Без изменений: ${E} (${x}) → ${P} (${D}) — 0.0%`);else{const U=B>=0?"Рост":"Снижение",G=Math.abs(B),q=B>=0?"+":"-",oe=B>=0?"#28a745":"#dc3545",Y=B>=0?"#28a745":"#dc3545";C.push(`  • <span style="color: ${oe}; font-weight: 600;">${U}</span> с ${E} (${x}) до ${P} (${D}) — <span style="color: ${Y}; font-weight: 600;">${q}${G.toFixed(1)}%</span>`)}}else A.count===0&&W.count>0&&C.push(`  • Появление переходящих тикетов: с 0 (${x}) до ${P} (${D})`)}}if(C.length>0&&(S.push("Динамика по месяцам:"),S.push(...C)),p.length>=3){const _=p[0],A=p[p.length-1];if(_&&A&&typeof _.count=="number"&&typeof A.count=="number"){const W=_.count||0,x=A.count||0,D=_.monthName||_.month,E=A.monthName||A.month,P=s(W),B=s(x);if(W>0){const U=(x-W)/W*100;if(isFinite(U)&&!isNaN(U))if(Math.abs(U)<1)S.push("Тенденция за период:"),S.push(`  • Стабильное количество: ${P} (${D}) → ${B} (${E}) — изменение менее 1%`);else{const G=U>=0?"Рост":"Снижение",q=Math.abs(U),oe=U>=0?"+":"-",Y=U>=0?"#28a745":"#dc3545",H=U>=0?"#28a745":"#dc3545";S.push("Тенденция за период:"),S.push(`  • <span style="color: ${Y}; font-weight: 600;">${G}</span> с ${P} (${D}) до ${B} (${E}) — <span style="color: ${H}; font-weight: 600;">${oe}${q.toFixed(1)}%</span>`)}}else W===0&&x>0?(S.push("Тенденция за период:"),S.push(`  • Появление переходящих тикетов: с 0 (${D}) до ${B} (${E})`)):W>0&&x===0&&(S.push("Тенденция за период:"),S.push(`  • Полное отсутствие переходящих тикетов: с ${P} (${D}) до 0 (${E})`))}}return S.length>0?S:["Недостаточно данных для анализа"]});function k(p,S){let C=[];switch(p){case"new":C=e.data.newTicketsByMonth||[];break;case"closed":C=e.data.closedTicketsByMonth||[];break;case"carryover":C=e.data.carryoverTicketsByMonth||[];break;default:return"-"}for(const y of C){if(!y.weeks||!Array.isArray(y.weeks))continue;const _=y.weeks.find(A=>A&&A.weekNumber===S);if(_){const A=_.count||0;return A>0?s(A):"-"}}return"-"}return(p,S)=>(c(),d("div",_v,[a("div",wv,[a("h3",Cv,[S[0]||(S[0]=ce(" Новые и Закрытые тикеты ",-1)),u.value?(c(),d("span",Tv,"("+g(u.value)+")",1)):$("",!0)]),a("div",Sv,[a("div",Dv,[ne(We(yt),{data:r.value,options:n},null,8,["data"])]),a("div",Ev,[S[3]||(S[3]=a("h4",{class:"summary-title"},"Сводный итог",-1)),a("div",Av,[a("div",$v,[S[1]||(S[1]=a("span",{class:"summary-label"},"Новые:",-1)),a("span",Iv,g(v.value.new),1)]),a("div",Mv,[S[2]||(S[2]=a("span",{class:"summary-label"},"Закрытые:",-1)),a("span",Nv,g(v.value.closed),1)])]),a("div",xv,[(c(!0),d(ee,null,te(T.value,(C,y)=>(c(),d("p",{key:y,innerHTML:C},null,8,Pv))),128))])])])]),a("div",Lv,[a("h3",Ov,[S[4]||(S[4]=ce(" Переходящие тикеты ",-1)),m.value?(c(),d("span",Bv,"("+g(m.value)+")",1)):$("",!0)]),a("div",Rv,[a("div",Wv,[ne(We(yt),{data:i.value,options:n},null,8,["data"])]),a("div",Uv,[S[5]||(S[5]=a("h4",{class:"analysis-title"},"Анализ",-1)),a("div",Fv,[(c(!0),d(ee,null,te(f.value,(C,y)=>(c(),d("p",{key:y,innerHTML:C},null,8,Hv))),128))])])])]),a("div",jv,[S[10]||(S[10]=a("h3",{class:"chart-title"},"Детализация по месяцам и неделям",-1)),a("div",Vv,[a("table",zv,[a("thead",null,[a("tr",null,[S[6]||(S[6]=a("th",{class:"month-header-cell"},"Месяц",-1)),(c(!0),d(ee,null,te(t.value,C=>(c(),d("th",{key:`week-${C}`,class:"week-header-cell"}," Неделя "+g(C),1))),128))])]),a("tbody",null,[a("tr",Gv,[S[7]||(S[7]=a("td",{class:"data-type-cell"},"Новые",-1)),(c(!0),d(ee,null,te(t.value,C=>(c(),d("td",{key:`new-${C}`,class:"week-data-cell"},g(k("new",C)),1))),128))]),a("tr",Kv,[S[8]||(S[8]=a("td",{class:"data-type-cell"},"Закрытые",-1)),(c(!0),d(ee,null,te(t.value,C=>(c(),d("td",{key:`closed-${C}`,class:"week-data-cell"},g(k("closed",C)),1))),128))]),a("tr",qv,[S[9]||(S[9]=a("td",{class:"data-type-cell"},"Переходящие",-1)),(c(!0),d(ee,null,te(t.value,C=>(c(),d("td",{key:`carryover-${C}`,class:"week-data-cell"},g(k("carryover",C)),1))),128))])])])])])]))}},Xv=de(Yv,[["__scopeId","data-v-31a3d565"]]),Jv={class:"months-preloader"},Zv={class:"preloader-content"},Qv={class:"progress-container"},ep={class:"progress-bar"},tp={class:"progress-text"},sp={class:"preloader-message"},ap={class:"stages-list"},op={class:"stage-icon"},np={class:"stage-text"},rp={__name:"MonthsModePreloader",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},currentStage:{type:String,default:""}},setup(o){const e=o,s=[{label:"Подготовка данных...",threshold:5},{label:"Загрузка данных за период (запрос 1)...",threshold:35},{label:"Загрузка данных за период (запрос 2)...",threshold:65},{label:"Загрузка данных за период (запрос 3)...",threshold:85},{label:"Агрегация данных...",threshold:90},{label:"Формирование графиков...",threshold:100}];function t(i){return e.progress>=s[i].threshold}function r(i){const n=s[i].threshold,l=i>0?s[i-1].threshold:0;return e.progress>=l&&e.progress<n}return(i,n)=>(c(),d("div",Jv,[a("div",Zv,[n[0]||(n[0]=_t('<div class="preloader-spinner" data-v-b571fe67><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div><div class="spinner-ring" data-v-b571fe67></div></div><h3 class="preloader-title" data-v-b571fe67>Загрузка данных за 3 месяца</h3>',2)),a("div",Qv,[a("div",ep,[a("div",{class:"progress-fill",style:we({width:`${o.progress}%`})},null,4)]),a("div",tp,g(Math.round(o.progress))+"%",1)]),a("p",sp,g(o.currentStage),1),a("div",ap,[(c(),d(ee,null,te(s,(l,u)=>a("div",{key:u,class:X(["stage-item",{"stage-completed":t(u),"stage-current":r(u)}])},[a("span",op,g(t(u)?"✓":r(u)?"→":"○"),1),a("span",np,g(l.label),1)],2)),64))])])]))}},ip=de(rp,[["__scopeId","data-v-b571fe67"]]),lp={class:"ac-dashboard-months"},cp={key:"content"},dp={class:"dashboard-header"},up={class:"header-content"},mp={class:"breadcrumbs-row"},gp=["aria-label","aria-disabled","data-fallback","disabled"],hp={class:"breadcrumbs","aria-label":"Навигация"},fp={class:"dashboard-layout"},vp={class:"filters-container"},pp={class:"chart-container"},yp={__name:"GraphAdmissionClosureMonthsDashboard",setup(o){const e=Xe(),s=I(!0),t=I(0),r=I("Подготовка данных..."),i=I(null),n=I(null),l=I({newTickets:0,closedTickets:0,carryoverTickets:0,newTicketsByMonth:[],closedTicketsByMonth:[],carryoverTicketsByMonth:[],previousPeriodData:{newTickets:null,closedTickets:null,carryoverTickets:null}}),u=I(!1),m=M(()=>typeof window>"u"?!1:window.history.length>1),v=M(()=>m.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),T={name:"dashboard-sector-1c"};function f(P){if(P?.preventDefault?.(),!u.value){u.value=!0;try{if(m.value){e.back();return}console.warn("GraphAdmissionClosureMonthsDashboard: fallback navigation to dashboard-sector-1c"),e.push(T)}finally{u.value=!1}}}const k=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),p=M(()=>{const P=k.value.customDateRange.startDate||k.value.customDateRange.endDate,B=k.value.employees.length===1&&k.value.employees.includes("all");return P||!B});async function S(P,B,U=500){const G=t.value,q=10,oe=(P-G)/q,Y=U/q;for(let H=0;H<q;H++)await new Promise(Z=>setTimeout(Z,Y)),t.value=Math.min(G+oe*(H+1),P);t.value=P,r.value=B}async function C(){console.log("[DEBUG MonthsDashboard] loadData called"),console.log("[DEBUG MonthsDashboard] isLoading before:",s.value),s.value=!0,i.value=null,t.value=0,r.value="Подготовка данных...",console.log("[DEBUG MonthsDashboard] isLoading set to true");let P=null,B=null;try{console.log("[DEBUG MonthsDashboard] Starting API call"),await S(5,"Подготовка данных...",200);const U=Date.now(),G=2e4;P=setInterval(()=>{const H=Date.now()-U,Z=Math.min(5+H/G*85,90);t.value=Z,Z<35?r.value="Загрузка данных за период (запрос 1)...":Z<65?r.value="Загрузка данных за период (запрос 2)...":Z<85?r.value="Загрузка данных за период (запрос 3)...":r.value="Агрегация данных..."},500),B=setTimeout(()=>{P&&(clearInterval(P),P=null)},G+1e4);const q=await Ut({product:"1C",periodMode:"months",includeTickets:!0});clearTimeout(B),P&&(clearInterval(P),P=null),t.value=90,r.value="Агрегация данных завершена",await S(100,"Формирование графиков...",300),console.log("[DEBUG MonthsDashboard] API call successful, result:",q);const{meta:oe,data:Y}=q;n.value=oe,l.value=Y,console.log("[DEBUG MonthsDashboard] Data set, meta:",oe,"data keys:",Object.keys(Y)),await new Promise(H=>setTimeout(H,200))}catch(U){P&&(clearInterval(P),P=null),B&&(clearTimeout(B),B=null),console.error("[DEBUG MonthsDashboard] API call failed:",U),i.value=U instanceof Error?U:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureMonthsDashboard] loadData error:",U),t.value=100,r.value="Ошибка загрузки данных"}finally{console.log("[DEBUG MonthsDashboard] Finally block: setting isLoading to false"),s.value=!1,console.log("[DEBUG MonthsDashboard] isLoading after:",s.value)}}function y(P){k.value.stages=P}function _(P){k.value.employees=P}function A(P){k.value.dateRange=P}function W(P){k.value.customDateRange=P}function x(){k.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},D()}function D(){C()}function E(P){if(!["weeks","months"].includes(P)){console.warn("[GraphAdmissionClosureMonthsDashboard] Invalid periodMode:",P);return}P==="weeks"&&window.dispatchEvent(new CustomEvent("period-mode-change",{detail:{mode:P}}))}return Ae(()=>{console.log("[DEBUG MonthsDashboard] onMounted called"),console.log("[DEBUG MonthsDashboard] isLoading before loadData:",s.value),C()}),(P,B)=>{const U=be("router-link");return c(),d("div",lp,[ne(Ee,{name:"fade",mode:"out-in"},{default:pe(()=>[s.value?(c(),he(ip,{key:"preloader",progress:t.value,"current-stage":r.value},null,8,["progress","current-stage"])):(c(),d("div",cp,[a("div",dp,[a("div",up,[a("div",mp,[a("button",{class:"btn-back-link",type:"button",onClick:f,"aria-label":v.value,"aria-disabled":!m.value,"data-fallback":!m.value,disabled:u.value,title:"Назад"}," ← ",8,gp),a("nav",hp,[ne(U,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...B[0]||(B[0]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),B[2]||(B[2]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(U,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[...B[1]||(B[1]=[ce(" График состояния ",-1)])]),_:1}),B[3]||(B[3]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),B[4]||(B[4]=a("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),B[5]||(B[5]=a("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),B[6]||(B[6]=a("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),a("div",fp,[a("div",vp,[ne(Hs,{stages:k.value.stages,employees:k.value.employees,dateRange:k.value.dateRange,customDateRange:k.value.customDateRange,hasActiveFilters:p.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":"months","onUpdate:stages":y,"onUpdate:employees":_,"onUpdate:dateRange":A,"onUpdate:customDateRange":W,"onUpdate:periodMode":E,onReset:x,onApply:D},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),a("div",pp,[i.value?(c(),he(ks,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),d(ee,{key:1},[ne(bv,{data:l.value},null,8,["data"]),ne(Xv,{data:l.value,meta:n.value},null,8,["data","meta"])],64))])])]))]),_:1})])}}},kp=de(yp,[["__scopeId","data-v-fe3ca7ed"]]);class hs{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const s=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",s);const t=await this.getEmployeesByIds(s);return console.log("Loaded employees:",t.length),{stages:this.groupTicketsByStages(e,t),employees:t,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],s=[];for(const t of e){console.log(`Loading tickets for stage: ${t}`);const r=await this.getTicketsByStage(t);s.push(...r),console.log(`Loaded ${r.length} tickets for stage ${t}`)}return s}static async getTicketsByStage(e){const s=[];let t=0;const r=50;let i=!0;for(;i;)try{const u=await new vt().call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:t,useOriginalUfNames:"Y"});let m=[];u&&u.result&&(Array.isArray(u.result)?m=u.result:u.result.items&&Array.isArray(u.result.items)?m=u.result.items:u.result.data&&Array.isArray(u.result.data)&&(m=u.result.data)),m.length>0?(s.push(...m),t+=m.length,i=m.length===r):i=!1}catch(l){console.error(`Error loading tickets batch for stage ${e} (start: ${t}):`,l),i=!1}s.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(s[0],null,2)),console.log("Sample ticket keys:",Object.keys(s[0])),console.log("Sample ticket assignedById variants:",{assignedById:s[0].assignedById,assignedByIdId:s[0].assignedByIdId,ASSIGNED_BY_ID:s[0].ASSIGNED_BY_ID}));const n=s.filter(l=>{const u=l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product||l.ufCrm7TypeProduct||l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product;return Array.isArray(u)?u.includes(this.SECTOR_TAG):typeof u=="object"&&u!==null?u.value===this.SECTOR_TAG||u===this.SECTOR_TAG:u===this.SECTOR_TAG});return console.log(`Filtered ${n.length} tickets from ${s.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),n}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const s=new Set;return e.forEach(t=>{const r=t.assignedById||t.assignedByIdId||t.ASSIGNED_BY_ID||t.assignedById||t.assignedById&&typeof t.assignedById=="object"&&(t.assignedById.id||t.assignedById.ID)||t.assignedById&&typeof t.assignedById=="object"&&t.assignedById.value;if(r){const i=parseInt(r);i&&!isNaN(i)&&i>0&&s.add(i)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(s))),Array.from(s)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await new vt().call("user.get",{filter:{ID:e}});let r=[];return t&&t.result&&(Array.isArray(t.result)?r=t.result:console.warn("Unexpected user.get result format:",t)),r.map(i=>({id:parseInt(i.ID||i.id||0),name:`${i.NAME||i.name||""} ${i.LAST_NAME||i.lastName||""}`.trim()||i.EMAIL||i.email||"Неизвестный",position:i.WORK_POSITION||i.workPosition||"Сотрудник",email:i.EMAIL||i.email||"",tickets:[]}))}catch(s){return console.error("Error getting employees by IDs:",s),[]}}static groupTicketsByStages(e,s){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(s)||(console.warn("Employees is not an array:",s),s=[]);const t=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:s.map(r=>({...r,tickets:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:s.map(r=>({...r,tickets:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:s.map(r=>({...r,tickets:[]}))}];return e.forEach(r=>{const i=this.mapStageId(r.stageId||r.STAGE_ID||""),n=t.find(l=>l.id===i);if(n){const l=r.assignedById||r.ASSIGNED_BY_ID||null,u=l?parseInt(l):null;if(u){let m=n.employees.find(v=>v.id===u);m||(m={id:u,name:`Сотрудник #${u}`,position:"Неизвестно",email:"",tickets:[]},n.employees.push(m)),m.tickets.push(this.mapTicket(r))}}}),t}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const s=parseInt(e.id||e.ID||0),t=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",i=e.assignedById||e.ASSIGNED_BY_ID||null,n=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",l=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",u=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,m=xs(u),v=ba(m);return{id:s,title:t,priorityId:m.id,priorityLabel:m.label,priorityColors:v,priority:m.id,priorityBitrixValue:m.bitrixValue||null,status:this.mapStatus(r),assigneeId:i?parseInt(i):null,stageId:this.mapStageId(r),createdAt:n,modifiedAt:l,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return xs(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const s=ta(e);if(s&&s.bitrixValue)return s.bitrixValue;const t={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return t[e]?t[e]:ta(wo).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const s={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(t=>!(t.assignedById||t.ASSIGNED_BY_ID)).forEach(t=>{const r=this.mapStageId(t.stageId||t.STAGE_ID||"");s[r]&&s[r].push(this.mapTicket(t))}),s):(console.warn("Tickets is not an array in getZeroPointTickets:",e),s)}static async assignTicket(e,s,t){try{const r=this.mapStageIdToBitrix(t);return(await new vt().call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:s,stageId:r}})).result===!0}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(e){try{const t=await new vt().call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(s){throw console.error("Error creating ticket:",s),s}}static async getTicket(e){try{const t=await new vt().call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(s){throw console.error("Error getting ticket:",s),s}}static async addComment(e,s){try{return(await new vt().call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:s}})).result!==void 0}catch(t){throw console.error("Error adding comment:",t),t}}}je(hs,"ENTITY_TYPE_ID",140),je(hs,"SECTOR_TAG","1C");const bp=Object.freeze(Object.defineProperty({__proto__:null,DashboardSector1CService:hs},Symbol.toStringTag,{value:"Module"}));function _p(o){if(!o)return null;try{const e=new Date(o);return isNaN(e.getTime())?null:e}catch{return console.warn("Invalid date format:",o),null}}function wp(o,e){return Math.floor((o-e)/864e5)}function Cp(o){return!o||isNaN(o.getTime())?!1:o<=new Date}const it={ONE_MONTH:"one_month",TWO_MONTHS:"two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},Rt={[it.ONE_MONTH]:"Один месяц",[it.TWO_MONTHS]:"Два месяца",[it.MORE_THAN_HALF_YEAR]:"Более полугода",[it.MORE_THAN_YEAR]:"Более года"},na={[it.ONE_MONTH]:30,[it.TWO_MONTHS]:60,[it.MORE_THAN_HALF_YEAR]:180,[it.MORE_THAN_YEAR]:365};function fs(o,e,s=new Date){if(!Array.isArray(o))return console.warn("filterTicketsByTimePeriod: tickets must be an array"),[];if(!na[e])return console.warn(`filterTicketsByTimePeriod: Unknown period "${e}"`),o;const t=na[e],r=e.includes("more_than");return o.filter(i=>{try{if(!i||!i.id||!i.created_at)return console.warn("Ticket missing required fields:",i),!1;const n=_p(i.created_at);if(!n)return console.warn(`Invalid date for ticket ${i.id}: ${i.created_at}`),!1;if(!Cp(n))return console.warn(`Future or invalid date for ticket ${i.id}: ${i.created_at}`),!1;const l=wp(s,n);return r?l>t:l<=t}catch(n){return console.error(`Error filtering ticket ${i?.id||"unknown"}:`,n),!1}})}const Tp={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Sp={class:"modal"},Dp={key:0,class:"modal__tabs"},Ep={key:"level-0-categories",class:"level-0"},Ap={class:"modal__header"},$p={class:"modal__title"},Ip={key:0},Mp={class:"modal__body"},Np={class:"categories-list"},xp=["onClick"],Pp={class:"category-item"},Lp={class:"category-item__icon"},Op={key:0},Bp={key:1},Rp={class:"category-item__content"},Wp={class:"category-item__label"},Up={class:"category-item__count"},Fp={key:0,class:"category-item__arrow"},Hp={class:"modal__footer"},jp={key:"level-1-categories",class:"level-1"},Vp={class:"modal__header"},zp={class:"modal__body"},Gp={key:"loading",class:"loading-names"},Kp={key:"empty",class:"modal__empty"},qp={key:"list",class:"responsible-list"},Yp=["onClick"],Xp={class:"responsible-list__name"},Jp={class:"responsible-list__count"},Zp={key:0,class:"responsible-list__arrow"},Qp={class:"modal__footer"},ey={key:"level-2-categories",class:"level-2"},ty={class:"modal__header"},sy={class:"modal__title"},ay={class:"modal__body"},oy={class:"time-sort-controls"},ny={class:"time-sort-buttons"},ry=["onClick"],iy={class:"count"},ly={key:"loading",class:"loading-state"},cy={key:"error",class:"error-state"},dy={class:"error-message"},uy={key:"empty",class:"empty-state"},my={class:"empty-state-message"},gy={key:"tickets",class:"tickets-list-container"},hy={key:"level-0-employees",class:"level-0"},fy={class:"modal__header"},vy={class:"modal__title"},py={key:0},yy={class:"modal__body"},ky={key:"loading",class:"loading-names"},by={key:"empty",class:"modal__empty"},_y={key:"list",class:"responsible-list"},wy=["onClick"],Cy={class:"responsible-list__name"},Ty={class:"responsible-list__count"},Sy={key:0,class:"responsible-list__arrow"},Dy={class:"modal__footer"},Ey={key:"level-1-employees",class:"level-1"},Ay={class:"modal__header"},$y={class:"modal__title"},Iy={class:"modal__body"},My={class:"categories-list"},Ny=["onClick"],xy={class:"category-item"},Py={class:"category-item__icon"},Ly={key:0},Oy={key:1},By={class:"category-item__content"},Ry={class:"category-item__label"},Wy={class:"category-item__count"},Uy={key:0,class:"category-item__arrow"},Fy={class:"modal__footer"},Hy={key:"level-2-employees",class:"level-2"},jy={class:"modal__header"},Vy={class:"modal__title"},zy={class:"modal__body"},Gy={key:"loading",class:"loading-state"},Ky={key:"error",class:"error-state"},qy={class:"error-message"},Yy={key:"empty",class:"empty-state"},Xy={class:"empty-state-message"},Jy={key:"tickets",class:"tickets-list-container"},Zy={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]},closedTicketsCreatedThisWeek:{type:Number,default:0},closedTicketsCreatedOtherWeek:{type:Number,default:0},responsibleCreatedThisWeek:{type:Array,default:()=>[]},responsibleCreatedOtherWeek:{type:Array,default:()=>[]},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},setup(o){const e=o,s=I(0),t=I("categories"),r=I(null),i=I(null),n=I(null),l=I([]),u=I(!1),m=I(null),v=I([]),T=I([]),f=I(!1),k=I(it.ONE_MONTH),p=M(()=>[{id:"created-this-week",label:"Тикеты закрытые этой неделью и созданные этой неделью",count:e.closedTicketsCreatedThisWeek??0,responsible:e.responsibleCreatedThisWeek??[]},{id:"created-other-week",label:"Тикеты закрытые этой неделью и созданные ранее",count:e.closedTicketsCreatedOtherWeek??0,responsible:e.responsibleCreatedOtherWeek??[]}]),S=M(()=>{const L=new Map;return(e.responsibleCreatedThisWeek||[]).forEach(h=>{const w=h.id??"unassigned";L.has(w)||L.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const R=L.get(w);R.thisWeekCount=h.count??0,R.thisWeekTickets=h.tickets||[],R.totalCount+=R.thisWeekCount}),(e.responsibleCreatedOtherWeek||[]).forEach(h=>{const w=h.id??"unassigned";L.has(w)||L.set(w,{id:h.id,name:h.name,thisWeekCount:0,otherWeekCount:0,totalCount:0,thisWeekTickets:[],otherWeekTickets:[]});const R=L.get(w);R.otherWeekCount=h.count??0,R.otherWeekTickets=h.tickets||[],R.totalCount+=R.otherWeekCount}),Array.from(L.values())}),C=M(()=>{if(!i.value)return[];const L=i.value.thisWeekTickets||[],h=i.value.otherWeekTickets||[];return console.log("[ResponsibleModal] Computing gradations for employee:",{id:i.value.id,name:i.value.name,thisWeekCount:i.value.thisWeekCount,otherWeekCount:i.value.otherWeekCount,thisWeekTickets:L.length,otherWeekTickets:h.length,employee:i.value}),[{id:"this-week",label:"На этой неделе",count:i.value.thisWeekCount??0,tickets:L,employeeId:i.value.id},{id:"other-week",label:"На другой неделе",count:i.value.otherWeekCount??0,tickets:h,employeeId:i.value.id}]}),y=M(()=>(T.value||[]).length>0),_=M(()=>{if(!l.value||l.value.length===0)return[];try{const L=performance.now(),h=fs(l.value,k.value),w=performance.now();return console.log(`[ResponsibleModal] Filtering took ${(w-L).toFixed(2)}ms, results: ${h.length}`),h}catch(L){return console.error("[ResponsibleModal] Error filtering tickets:",L),[]}}),A=M(()=>Object.keys(Rt).map(L=>({key:L,label:Rt[L],count:fs(l.value,L).length})));async function W(L){const h=L.filter(w=>w.id!==null&&w.id!==void 0).map(w=>w.id);if(h.length===0)return L;try{const w=await hs.getEmployeesByIds(h),R=new Map;return w.forEach(re=>{R.set(re.id,re.name)}),L.map(re=>re.id&&R.has(re.id)?{...re,name:R.get(re.id)}:re)}catch(w){return console.error("[ResponsibleModal] Error enriching names:",w),L}}Me([()=>t.value,()=>S.value],async([L,h])=>{if(!(L!=="employees"||s.value!==0)){if(!h||h.length===0){T.value=[];return}f.value=!0;try{T.value=await W(h)}catch(w){console.error("[ResponsibleModal] Error loading employee names:",w),T.value=h}finally{f.value=!1}}},{immediate:!0}),Me(()=>e.responsible,async L=>{if(!(s.value!==0||r.value||t.value!=="categories")){if(!L||L.length===0){v.value=[];return}f.value=!0;try{v.value=await W(L)}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=L}finally{f.value=!1}}},{immediate:!1});const x=M(()=>(v.value||[]).length>0);function D(L){t.value!==L&&(t.value=L,s.value=0,r.value=null,i.value=null,n.value=null,l.value=[],m.value=null,v.value=[],T.value=[])}async function E(L){if(!L||L.count===0){console.warn("[ResponsibleModal] handleCategoryClick: Invalid category or count is 0",{category:L,count:L?.count});return}console.log("[ResponsibleModal] handleCategoryClick called:",{categoryId:L.id,categoryLabel:L.label,categoryCount:L.count,responsibleCount:L.responsible?.length||0,responsibleWithTickets:L.responsible?.filter(h=>h.tickets&&h.tickets.length>0).length||0,responsibleSample:L.responsible?.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))}),r.value=L,s.value=1,f.value=!0;try{v.value=await W(L.responsible),console.log("[ResponsibleModal] After enrichResponsibleWithNames:",{enrichedCount:v.value.length,enrichedSample:v.value.slice(0,2).map(h=>({id:h.id,name:h.name,count:h.count,hasTickets:!!h.tickets,ticketsCount:h.tickets?.length||0}))})}catch(h){console.error("[ResponsibleModal] Error loading employee names:",h),v.value=L.responsible}finally{f.value=!1}}async function P(L,h=null){!L||!L.id||L.totalCount===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),console.log("[ResponsibleModal] Employee selected from list:",{id:L.id,name:L.name,thisWeekCount:L.thisWeekCount,otherWeekCount:L.otherWeekCount,thisWeekTickets:L.thisWeekTickets?.length||0,otherWeekTickets:L.otherWeekTickets?.length||0,employee:L}),i.value={...L,thisWeekTickets:L.thisWeekTickets||[],otherWeekTickets:L.otherWeekTickets||[]},s.value=1)}async function B(L){if(!L||L.count===0)return;n.value=L,s.value=2;const h=L.tickets||[];console.log("[ResponsibleModal] Gradation clicked:",{id:L.id,label:L.label,count:L.count,ticketsInGradation:h.length,selectedEmployee:i.value?.id}),h.length>0?(console.log("[ResponsibleModal] Loading tickets from gradation:",h.length),await U(h)):(console.log("[ResponsibleModal] Tickets not in gradation, loading from API"),await G(L))}async function U(L){u.value=!0,m.value=null;try{try{const{prepareTicketsForDisplay:h}=await De(async()=>{const{prepareTicketsForDisplay:w}=await import("./chunk-Cm-sZV4A.js").then(R=>R.t);return{prepareTicketsForDisplay:w}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await h(L,null,null)}catch(h){console.error("[ResponsibleModal] Error preparing tickets:",h),l.value=L}l.value.length===0&&(m.value=null)}catch(h){m.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),l.value=[]}finally{u.value=!1}}async function G(L){u.value=!0,m.value=null;try{if(!e.weekStartUtc||!e.weekEndUtc||!i.value)throw new Error("Не указаны границы недели или выбранный сотрудник");const h=await Ut({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0}),re=(L.id==="this-week"?h.data.responsibleCreatedThisWeek:h.data.responsibleCreatedOtherWeek)?.find(le=>le.id===i.value.id)?.tickets||[];try{const{prepareTicketsForDisplay:le}=await De(async()=>{const{prepareTicketsForDisplay:ae}=await import("./chunk-Cm-sZV4A.js").then(ge=>ge.t);return{prepareTicketsForDisplay:ae}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await le(re,null,null)}catch(le){console.error("[ResponsibleModal] Error preparing tickets:",le),l.value=re}l.value.length===0&&(m.value=null)}catch(h){m.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets from API:",h),l.value=[]}finally{u.value=!1}}async function q(L,h=null){!L||!L.id||L.count===0||(h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),i.value=L,s.value=2,await oe(L.id))}async function oe(L){u.value=!0,m.value=null;try{let h=[];if(console.log("[ResponsibleModal] loadEmployeeTickets called:",{employeeId:L,selectedCategory:r.value?.id,hasSelectedCategory:!!r.value,hasResponsible:!!r.value?.responsible,responsibleCount:r.value?.responsible?.length||0,categoryData:r.value?{id:r.value.id,label:r.value.label,count:r.value.count,responsibleSample:r.value.responsible?.slice(0,2).map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0}))}:null}),r.value&&r.value.responsible){const w=r.value.responsible.find(R=>R.id===L);console.log("[ResponsibleModal] Employee found in category:",{employee:w,hasTickets:!!w?.tickets,ticketsCount:w?.tickets?.length||0,tickets:w?.tickets?w.tickets.slice(0,2):null}),h=w?.tickets||[]}if(h.length===0&&e.weekStartUtc&&e.weekEndUtc){console.log("[ResponsibleModal] Tickets not found in category, loading from API",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,categoryId:r.value?.id});const w=await Ut({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0});console.log("[ResponsibleModal] API response:",{hasResponsibleCreatedThisWeek:!!w.data.responsibleCreatedThisWeek,hasResponsibleCreatedOtherWeek:!!w.data.responsibleCreatedOtherWeek,thisWeekCount:w.data.responsibleCreatedThisWeek?.length||0,otherWeekCount:w.data.responsibleCreatedOtherWeek?.length||0,thisWeekSample:w.data.responsibleCreatedThisWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0})),otherWeekSample:w.data.responsibleCreatedOtherWeek?.slice(0,1).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const R=r.value?.id==="created-this-week"?w.data.responsibleCreatedThisWeek:w.data.responsibleCreatedOtherWeek;console.log("[ResponsibleModal] Category data:",{categoryId:r.value?.id,categoryDataCount:R?.length||0,categoryDataSample:R?.slice(0,2).map(le=>({id:le.id,name:le.name,count:le.count,hasTickets:!!le.tickets,ticketsCount:le.tickets?.length||0}))});const re=R?.find(le=>le.id===L);console.log("[ResponsibleModal] Employee found in API response:",{employee:re?{id:re.id,name:re.name,count:re.count,hasTickets:!!re.tickets,ticketsCount:re.tickets?.length||0,ticketsSample:re.tickets?.slice(0,2)}:null}),h=re?.tickets||[]}console.log("[ResponsibleModal] Final employeeTickets before prepareTicketsForDisplay:",{ticketsCount:h.length,ticketsSample:h.slice(0,2).map(w=>({id:w.id,title:w.title||w.ufSubject||"No title",stageId:w.stageId}))});try{const{prepareTicketsForDisplay:w}=await De(async()=>{const{prepareTicketsForDisplay:R}=await import("./chunk-Cm-sZV4A.js").then(re=>re.t);return{prepareTicketsForDisplay:R}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);l.value=await w(h,null,null),console.log("[ResponsibleModal] Tickets after prepareTicketsForDisplay:",{ticketsCount:l.value.length,ticketsSample:l.value.slice(0,2).map(R=>({id:R.id,title:R.title||R.ufSubject||"No title",stageId:R.stageId}))})}catch(w){console.error("[ResponsibleModal] Error preparing tickets:",w),console.error("[ResponsibleModal] prepareError details:",{message:w.message,stack:w.stack,employeeTicketsCount:h.length}),l.value=h,console.log("[ResponsibleModal] Using fallback tickets (without enrichment):",l.value.length)}l.value.length===0?(console.warn("[ResponsibleModal] No tickets after loading and preparation",{employeeId:L,categoryId:r.value?.id,employeeTicketsCount:h.length,finalTicketsCount:l.value.length}),m.value=null):console.log("[ResponsibleModal] Successfully loaded tickets:",l.value.length)}catch(h){m.value=h.message||"Ошибка загрузки тикетов",console.error("[ResponsibleModal] Error loading tickets:",h),console.error("[ResponsibleModal] Error details:",{message:h.message,stack:h.stack,employeeId:L,categoryId:r.value?.id}),l.value=[]}finally{u.value=!1}}function Y(){s.value===2?(s.value=1,t.value==="categories"?i.value=null:n.value=null,l.value=[],m.value=null):s.value===1&&(s.value=0,t.value==="categories"?(r.value=null,v.value=[]):i.value=null)}function H(L){console.log(`[ResponsibleModal] Sort mode changed: ${k.value} -> ${L}`);const h=performance.now();k.value=L,setTimeout(()=>{const w=_.value,R=performance.now();console.log(`[ResponsibleModal] Filtering completed in ${(R-h).toFixed(2)}ms, ${w.length} tickets shown`)},0)}function Z(L){const h=Qt(L.id);window.open(h,"_blank")}function fe(){t.value==="employees"&&n.value?U(n.value.tickets):t.value==="categories"&&i.value&&oe(i.value.id)}return Me(()=>e.isVisible,L=>{if(L){console.log("[TASK-070] ResponsibleModal opened for week",e.weekNumber),console.log("[TASK-070] ResponsibleModal props types:",{responsibleCreatedThisWeekType:typeof e.responsibleCreatedThisWeek,responsibleCreatedThisWeekIsArray:Array.isArray(e.responsibleCreatedThisWeek),responsibleCreatedThisWeekLength:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:"not array",responsibleCreatedOtherWeekType:typeof e.responsibleCreatedOtherWeek,responsibleCreatedOtherWeekIsArray:Array.isArray(e.responsibleCreatedOtherWeek),responsibleCreatedOtherWeekLength:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:"not array"}),console.log("[TASK-070] ResponsibleModal data:",{weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,responsibleCreatedThisWeek:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.length:e.responsibleCreatedThisWeek?"not array":"null/undefined",responsibleCreatedOtherWeek:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.length:e.responsibleCreatedOtherWeek?"not array":"null/undefined",closedTicketsCreatedThisWeek:e.closedTicketsCreatedThisWeek,closedTicketsCreatedOtherWeek:e.closedTicketsCreatedOtherWeek}),console.log("[TASK-070] ResponsibleModal detailed data:",{responsibleCreatedThisWeek:e.responsibleCreatedThisWeek,responsibleCreatedOtherWeek:e.responsibleCreatedOtherWeek,responsibleCreatedThisWeekWithTickets:Array.isArray(e.responsibleCreatedThisWeek)?e.responsibleCreatedThisWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null",responsibleCreatedOtherWeekWithTickets:Array.isArray(e.responsibleCreatedOtherWeek)?e.responsibleCreatedOtherWeek.map(w=>({id:w.id,name:w.name,count:w.count,hasTickets:!!w.tickets,ticketsCount:w.tickets?.length||0})):"not array or null"});const h=e.weekNumber;h&&console.log("[TASK-070] ResponsibleModal: Week number",h)}else s.value=0,t.value="categories",r.value=null,i.value=null,n.value=null,l.value=[],m.value=null,v.value=[],T.value=[]}),(L,h)=>o.isVisible?(c(),d("div",Tp,[a("div",Sp,[s.value===0?(c(),d("div",Dp,[a("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="categories"}]),onClick:h[0]||(h[0]=w=>D("categories"))}," По категориям ",2),a("button",{class:X(["modal__tab",{"modal__tab--active":t.value==="employees"}]),onClick:h[1]||(h[1]=w=>D("employees"))}," По сотрудникам ",2)])):$("",!0),ne(Ee,{name:"level",mode:"out-in"},{default:pe(()=>[t.value==="categories"&&s.value===0?(c(),d("div",Ep,[a("header",Ap,[a("h3",$p,[h[12]||(h[12]=ce(" Закрытые за неделю",-1)),o.weekNumber?(c(),d("span",Ip," · Неделя "+g(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:h[2]||(h[2]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Mp,[a("ul",Np,[(c(!0),d(ee,null,te(p.value,w=>(c(),d("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:R=>E(w)},[a("div",Pp,[a("div",Lp,[w.id==="created-this-week"?(c(),d("span",Op,"✓")):(c(),d("span",Bp,"↻"))]),a("div",Rp,[a("div",Wp,g(w.label),1),a("div",Up,g(w.count)+" тикетов",1)]),w.count>0?(c(),d("span",Fp,"→")):$("",!0)])],10,xp))),128))])]),a("footer",Hp,[a("button",{class:"btn",onClick:h[3]||(h[3]=w=>L.$emit("close"))},"Закрыть")])])):t.value==="categories"&&s.value===1?(c(),d("div",jp,[a("header",Vp,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),h[13]||(h[13]=a("h3",{class:"modal__title"},"Ответственные за неделю",-1)),a("button",{class:"modal__close",onClick:h[4]||(h[4]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",zp,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[f.value?(c(),d("div",Gp,[...h[14]||(h[14]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка имён сотрудников...",-1)])])):x.value?(c(),d("ul",qp,[(c(!0),d(ee,null,te(v.value,w=>(c(),d("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.count>0}]),onClick:R=>q(w,R),title:"Кликните для просмотра тикетов сотрудника"},[a("span",Xp,g(w.name||"Не назначен"),1),a("span",Jp,g(w.count??0)+" тикетов ",1),w.id&&w.count>0?(c(),d("span",Zp,"→")):$("",!0)],10,Yp))),128))])):(c(),d("p",Kp,"Нет данных по ответственным"))]),_:1})]),a("footer",Qp,[a("button",{class:"btn",onClick:h[5]||(h[5]=w=>L.$emit("close"))},"Закрыть")])])):t.value==="categories"&&s.value===2?(c(),d("div",ey,[a("header",ty,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",sy,"Тикеты сотрудника: "+g(i.value?.name||"Неизвестно"),1),a("button",{class:"modal__close",onClick:h[6]||(h[6]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",ay,[a("div",oy,[h[15]||(h[15]=a("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),a("div",ny,[(c(!0),d(ee,null,te(A.value,w=>(c(),d("button",{key:w.key,class:X(["time-sort-btn",{active:k.value===w.key}]),onClick:R=>H(w.key)},[ce(g(w.label)+" ",1),a("span",iy,"("+g(w.count)+")",1)],10,ry))),128))])]),ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[u.value?(c(),d("div",ly,[...h[16]||(h[16]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):m.value?(c(),d("div",cy,[h[17]||(h[17]=a("div",{class:"error-icon"},"⚠️",-1)),h[18]||(h[18]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",dy,g(m.value),1),a("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):_.value.length===0?(c(),d("div",uy,[h[19]||(h[19]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",my," У сотрудника нет тикетов за выбранный период ("+g(We(Rt)[k.value])+") ",1)])):(c(),d("div",gy,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(_.value,(w,R)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":R}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):t.value==="employees"&&s.value===0?(c(),d("div",hy,[a("header",fy,[a("h3",vy,[h[20]||(h[20]=ce(" Закрытые за неделю",-1)),o.weekNumber?(c(),d("span",py," · Неделя "+g(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:h[7]||(h[7]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",yy,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[f.value?(c(),d("div",ky,[...h[21]||(h[21]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка имён сотрудников...",-1)])])):y.value?(c(),d("ul",_y,[(c(!0),d(ee,null,te(T.value,w=>(c(),d("li",{key:w.id||w.name,class:X(["responsible-list__item",{"responsible-list__item--clickable":w.id&&w.totalCount>0}]),onClick:R=>P(w,R),title:"Кликните для просмотра градации тикетов сотрудника"},[a("span",Cy,g(w.name||"Не назначен"),1),a("span",Ty,g(w.totalCount??0)+" тикетов ",1),w.id&&w.totalCount>0?(c(),d("span",Sy,"→")):$("",!0)],10,wy))),128))])):(c(),d("p",by,"Нет данных по сотрудникам"))]),_:1})]),a("footer",Dy,[a("button",{class:"btn",onClick:h[8]||(h[8]=w=>L.$emit("close"))},"Закрыть")])])):t.value==="employees"&&s.value===1?(c(),d("div",Ey,[a("header",Ay,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",$y,"Тикеты сотрудника: "+g(i.value?.name||"Неизвестно"),1),a("button",{class:"modal__close",onClick:h[9]||(h[9]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",Iy,[a("ul",My,[(c(!0),d(ee,null,te(C.value,w=>(c(),d("li",{key:w.id,class:X(["categories-list__item",{"categories-list__item--clickable":w.count>0}]),onClick:R=>B(w)},[a("div",xy,[a("div",Py,[w.id==="this-week"?(c(),d("span",Ly,"✓")):(c(),d("span",Oy,"↻"))]),a("div",By,[a("div",Ry,g(w.label),1),a("div",Wy,g(w.count)+" тикетов",1)]),w.count>0?(c(),d("span",Uy,"→")):$("",!0)])],10,Ny))),128))])]),a("footer",Fy,[a("button",{class:"btn",onClick:h[10]||(h[10]=w=>L.$emit("close"))},"Закрыть")])])):t.value==="employees"&&s.value===2?(c(),d("div",Hy,[a("header",jy,[a("button",{class:"btn-back",onClick:Y,"aria-label":"Назад"},"← Назад"),a("h3",Vy," Тикеты сотрудника: "+g(i.value?.name||"Неизвестно")+" ("+g(n.value?.label||"")+") ",1),a("button",{class:"modal__close",onClick:h[11]||(h[11]=w=>L.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",zy,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[u.value?(c(),d("div",Gy,[...h[22]||(h[22]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов...",-1)])])):m.value?(c(),d("div",Ky,[h[23]||(h[23]=a("div",{class:"error-icon"},"⚠️",-1)),h[24]||(h[24]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",qy,g(m.value),1),a("button",{class:"btn btn-retry",onClick:fe},"Повторить")])):l.value.length===0?(c(),d("div",Yy,[h[25]||(h[25]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",Xy,g(t.value==="employees"?`У сотрудника нет тикетов в категории "${n.value?.label||""}"`:"У сотрудника нет закрытых тикетов за выбранную неделю"),1)])):(c(),d("div",Jy,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(_.value,(w,R)=>(c(),he(Ct,{key:w.id,ticket:w,draggable:!1,style:we({"--ticket-index":R}),onClick:Z},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Qy=de(Zy,[["__scopeId","data-v-6f43202a"]]),ek={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},tk={class:"modal"},sk={key:"level-1",class:"level-1"},ak={class:"modal__header"},ok={class:"modal__title"},nk={key:0},rk={class:"modal__body"},ik={key:"loading",class:"loading-names"},lk={key:"empty",class:"modal__empty"},ck={key:"list",class:"stages-list"},dk=["onClick"],uk={class:"stages-list__name"},mk={class:"stages-list__count"},gk={key:0,class:"stages-list__arrow"},hk={class:"modal__footer"},fk={key:"level-2",class:"level-2"},vk={class:"modal__header"},pk={class:"modal__title"},yk={class:"modal__body"},kk={class:"time-sort-controls"},bk={class:"time-sort-buttons"},_k=["onClick"],wk={class:"count"},Ck={key:"loading",class:"loading-state"},Tk={key:"error",class:"error-state"},Sk={class:"error-message"},Dk={key:"empty",class:"empty-state"},Ek={class:"empty-state-message"},Ak={key:"tickets",class:"tickets-list-container"},$k={__name:"StagesModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=I(1),r=I(null),i=I([]),n=I(!1),l=I(!1),u=I(null),m=I([]),v=I(it.ONE_MONTH),T=M(()=>m.value.length>0&&m.value.some(x=>x.count>0)),f=M(()=>{if(!i.value||i.value.length===0)return[];try{const x=performance.now(),D=fs(i.value,v.value),E=performance.now();return console.log(`[StagesModal] Filtering took ${(E-x).toFixed(2)}ms, results: ${D.length}`),D}catch(x){return console.error("[StagesModal] Error filtering tickets:",x),[]}}),k=M(()=>Object.keys(Rt).map(x=>({key:x,label:Rt[x],count:fs(i.value,x).length})));async function p(){if(console.log("[TASK-070] StagesModal: loadStages called",{weekNumber:s.weekNumber,weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc}),!s.weekStartUtc||!s.weekEndUtc){console.warn("[TASK-070] StagesModal: Missing week boundaries, cannot load stages"),m.value=[];return}l.value=!0,u.value=null;try{console.log("[TASK-070] StagesModal: Fetching stages from API...");const x=await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeNewTicketsByStages:!0});console.log("[TASK-070] StagesModal: API response received",{hasNewTicketsByStages:!!x.data.newTicketsByStages,stagesCount:x.data.newTicketsByStages?.length||0}),m.value=x.data.newTicketsByStages||[],m.value.length===0?console.warn("[TASK-070] StagesModal: API returned empty stages array for week",s.weekNumber):console.log("[TASK-070] StagesModal: Stages loaded successfully",m.value.length,"stages")}catch(x){u.value=x.message||"Ошибка загрузки стадий",console.error("[TASK-070] StagesModal: Error loading stages:",x),m.value=[]}finally{l.value=!1}}async function S(x,D=null){!x||x.count===0||(D&&D.currentTarget&&(D.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{D.currentTarget&&(D.currentTarget.style.transform="")},150)),r.value=x,t.value=2,await C(x.stageId))}async function C(x){n.value=!0,u.value=null;try{const D=m.value.find(U=>U.stageId===x);if(D&&Array.isArray(D.tickets)&&D.tickets.length>0){console.log("[TASK-070] StagesModal: Using preloaded tickets for stage",x,"count:",D.tickets.length);const U=D.tickets;try{const{prepareTicketsForDisplay:G}=await De(async()=>{const{prepareTicketsForDisplay:q}=await import("./chunk-Cm-sZV4A.js").then(oe=>oe.t);return{prepareTicketsForDisplay:q}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await G(U,null,null)}catch(G){console.error("[TASK-070] StagesModal: Error preparing tickets:",G),i.value=U}n.value=!1;return}if(console.log("[TASK-070] StagesModal: Tickets not preloaded, loading from API for stage",x),!s.weekStartUtc||!s.weekEndUtc)throw new Error("Не указаны границы недели");const B=(await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeNewTicketsByStages:!0,includeTickets:!0})).data.newTicketsByStages?.find(U=>U.stageId===x)?.tickets||[];try{const{prepareTicketsForDisplay:U}=await De(async()=>{const{prepareTicketsForDisplay:G}=await import("./chunk-Cm-sZV4A.js").then(q=>q.t);return{prepareTicketsForDisplay:G}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await U(B,null,null)}catch(U){console.error("[StagesModal] Error preparing tickets:",U),i.value=B}i.value.length===0&&(u.value=null)}catch(D){u.value=D.message||"Ошибка загрузки тикетов",console.error("[StagesModal] Error loading tickets:",D),i.value=[]}finally{n.value=!1}}function y(){t.value=1,r.value=null,i.value=[],u.value=null}function _(x){const D=Qt(x.id);window.open(D,"_blank")}function A(){r.value&&C(r.value.stageId)}function W(x){console.log(`[StagesModal] Sort mode changed: ${v.value} -> ${x}`);const D=performance.now();v.value=x,setTimeout(()=>{const E=f.value,P=performance.now();console.log(`[StagesModal] Filtering completed in ${(P-D).toFixed(2)}ms, ${E.length} tickets shown`)},0)}return Me(()=>s.isVisible,async x=>{x?(t.value=1,r.value=null,i.value=[],u.value=null,console.log("[TASK-070] StagesModal opened:",{weekNumber:s.weekNumber,weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,preloadedData:s.preloadedData?Array.isArray(s.preloadedData)?`Array(${s.preloadedData.length})`:typeof s.preloadedData:"null"}),s.preloadedData&&Array.isArray(s.preloadedData)&&s.preloadedData.length>0?(console.log("[TASK-070] StagesModal: Using preloaded data, stages count:",s.preloadedData.length),s.preloadedData.every(E=>E.stageId&&E.stageName&&typeof E.count=="number")?(m.value=s.preloadedData,l.value=!1,console.log("[TASK-070] StagesModal: Preloaded data set, stages:",m.value.length)):(console.warn("[TASK-070] StagesModal: Invalid preloaded data structure, falling back to API"),await p())):(console.log("[TASK-070] StagesModal: No preloaded data, loading from API",{weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc}),await p())):(t.value=1,r.value=null,i.value=[],u.value=null,m.value=[])},{immediate:!1}),Me([()=>s.weekNumber,()=>s.preloadedData],async([x,D])=>{s.isVisible&&x&&(D&&Array.isArray(D)&&D.length>0?D.every(P=>P.stageId&&P.stageName&&typeof P.count=="number")?(console.log("[TASK-070] StagesModal: Week changed, updating with preloaded data for week",x),m.value=D,l.value=!1):(console.log("[TASK-070] StagesModal: Week changed, invalid preloaded data, loading from API for week",x),await p()):(console.log("[TASK-070] StagesModal: Week changed, loading from API for week",x),await p()))}),(x,D)=>o.isVisible?(c(),d("div",ek,[a("div",tk,[ne(Ee,{name:"level",mode:"out-in"},{default:pe(()=>[t.value===1?(c(),d("div",sk,[a("header",ak,[a("h3",ok,[D[3]||(D[3]=ce(" Новые тикеты по стадиям",-1)),o.weekNumber?(c(),d("span",nk," · Неделя "+g(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:D[0]||(D[0]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",rk,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[l.value?(c(),d("div",ik,[...D[4]||(D[4]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка стадий...",-1)])])):T.value?(c(),d("ul",ck,[(c(!0),d(ee,null,te(m.value,E=>(c(),d("li",{key:E.stageId,class:X(["stages-list__item",{"stages-list__item--clickable":E.count>0}]),style:we({"--stage-color":E.color}),onClick:P=>S(E,P),title:"Кликните для просмотра тикетов стадии"},[a("span",{class:"stages-list__color",style:we({backgroundColor:E.color})},null,4),a("span",uk,g(E.stageName),1),a("span",mk,g(E.count)+" тикетов ",1),E.count>0?(c(),d("span",gk,"→")):$("",!0)],14,dk))),128))])):(c(),d("p",lk," Нет новых тикетов за выбранную неделю "))]),_:1})]),a("footer",hk,[a("button",{class:"btn",onClick:D[1]||(D[1]=E=>x.$emit("close"))},"Закрыть")])])):t.value===2?(c(),d("div",fk,[a("header",vk,[a("button",{class:"btn-back",onClick:y,"aria-label":"Назад"},"← Назад"),a("h3",pk," Тикеты стадии: "+g(r.value?.stageName||"Неизвестно"),1),a("button",{class:"modal__close",onClick:D[2]||(D[2]=E=>x.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",yk,[a("div",kk,[D[5]||(D[5]=a("h4",{class:"time-sort-title"},"Показать тикеты:",-1)),a("div",bk,[(c(!0),d(ee,null,te(k.value,E=>(c(),d("button",{key:E.key,class:X(["time-sort-btn",{active:v.value===E.key}]),onClick:P=>W(E.key)},[ce(g(E.label)+" ",1),a("span",wk,"("+g(E.count)+")",1)],10,_k))),128))])]),ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),d("div",Ck,[...D[6]||(D[6]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов стадии...",-1),a("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):u.value?(c(),d("div",Tk,[D[7]||(D[7]=a("div",{class:"error-icon"},"⚠️",-1)),D[8]||(D[8]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",Sk,g(u.value),1),a("button",{class:"btn btn-retry",onClick:A},"Повторить")])):f.value.length===0?(c(),d("div",Dk,[D[9]||(D[9]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",Ek," На стадии «"+g(r.value?.stageName)+"» нет тикетов за выбранный период ("+g(We(Rt)[v.value])+") ",1)])):(c(),d("div",Ak,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(f.value,(E,P)=>(c(),he(Ct,{key:E.id,ticket:E,draggable:!1,style:we({"--ticket-index":P}),onClick:_},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},Ik=de($k,[["__scopeId","data-v-0dacaef9"]]),Pt=new Map,Mk=5*60*1e3;function Nk(o,e){return`${o}:${JSON.stringify(e)}`}function ra(o){return Date.now()-o.timestamp<Mk}function xk(o,e){if(Pt.set(o,{data:e,timestamp:Date.now()}),Pt.size>20){const s=Pt.keys().next().value;Pt.delete(s)}}function Pk(o){const e=Pt.get(o);return e&&ra(e)?(console.log("[API-CACHE] Cache hit for key:",o),e.data):(e&&!ra(e)&&(console.log("[API-CACHE] Cache expired for key:",o),Pt.delete(o)),null)}async function Lk(o={}){const e="/api/graph-1c-admission-closure.php",s=Nk(e,o),t=Pk(e);if(t)return t;console.log("[API-CACHE] Cache miss, making API request for:",s);const{LazyServiceLoader:r}=await De(async()=>{const{LazyServiceLoader:l}=await import("./chunk-Bzh5eqmy.js").then(u=>u.l);return{LazyServiceLoader:l}},__vite__mapDeps([3,4]),import.meta.url),{fetchAdmissionClosureStats:i}=await r.loadAdmissionClosureService(),n=await i(o);return xk(s,n),n}async function Ok(o,e){return Lk({product:"1C",weekStartUtc:o,weekEndUtc:e,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!0})}const Bk={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Rk={class:"modal"},Wk={key:"level-1",class:"level-1"},Uk={class:"modal__header"},Fk={class:"modal__title"},Hk={key:0},jk={class:"modal__body"},Vk={key:"loading",class:"loading-names"},zk={key:"empty",class:"modal__empty"},Gk={key:"list",class:"duration-list"},Kk=["onClick"],qk={class:"duration-list__name"},Yk={class:"duration-list__count"},Xk={key:0,class:"duration-list__arrow"},Jk={class:"modal__footer"},Zk={key:"level-2",class:"level-2"},Qk={class:"modal__header"},e1={class:"modal__title"},t1={class:"modal__body"},s1={key:"loading",class:"loading-state"},a1={key:"error",class:"error-state"},o1={class:"error-message"},n1={key:"empty",class:"empty-state"},r1={class:"empty-state-message"},i1={key:"tickets",class:"tickets-list-container"},l1={__name:"CarryoverDurationModal",props:{isVisible:{type:Boolean,default:!1},weekNumber:{type:Number,default:null},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null},preloadedData:{type:Array,default:null}},emits:["close"],setup(o,{emit:e}){const s=o,t=I(1),r=I(null),i=I([]),n=I(!1),l=I(!1),u=I(null),m=I([]),v=M(()=>m.value.length>0&&m.value.some(y=>y.count>0));async function T(){if(!s.weekStartUtc||!s.weekEndUtc){m.value=[];return}l.value=!0,u.value=null;try{const y=await Ut({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0});m.value=y.data.carryoverTicketsByDuration||[]}catch(y){u.value=y.message||"Ошибка загрузки категорий",console.error("[CarryoverDurationModal] Error loading categories:",y),m.value=[]}finally{l.value=!1}}async function f(y,_=null){!y||y.count===0||(_&&_.currentTarget&&(_.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{_.currentTarget&&(_.currentTarget.style.transform="")},150)),r.value=y,t.value=2,await k(y.durationCategory))}async function k(y){n.value=!0,u.value=null;try{const _=m.value.find(D=>D.durationCategory===y);if(_&&Array.isArray(_.tickets)&&_.tickets.length>0){console.log("[TASK-070] CarryoverDurationModal: Using preloaded tickets for category",y,"count:",_.tickets.length);const D=_.tickets;try{const{prepareTicketsForDisplay:E}=await De(async()=>{const{prepareTicketsForDisplay:P}=await import("./chunk-Cm-sZV4A.js").then(B=>B.t);return{prepareTicketsForDisplay:P}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await E(D,null,null)}catch(E){console.error("[TASK-070] CarryoverDurationModal: Error preparing tickets:",E),i.value=D}n.value=!1;return}if(console.log("[TASK-070] CarryoverDurationModal: Tickets not preloaded, loading from API for category",y),!s.weekStartUtc||!s.weekEndUtc)throw new Error("Не указаны границы недели");const x=(await Ok(s.weekStartUtc,s.weekEndUtc)).data.carryoverTicketsByDuration?.find(D=>D.durationCategory===y)?.tickets||[];try{const{prepareTicketsForDisplay:D}=await De(async()=>{const{prepareTicketsForDisplay:E}=await import("./chunk-Cm-sZV4A.js").then(P=>P.t);return{prepareTicketsForDisplay:E}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);i.value=await D(x,null,null)}catch(D){console.error("[CarryoverDurationModal] Error preparing tickets:",D),i.value=x}i.value.length===0&&(u.value=null)}catch(_){u.value=_.message||"Ошибка загрузки тикетов",console.error("[CarryoverDurationModal] Error loading tickets:",_),i.value=[]}finally{n.value=!1}}function p(){t.value=1,r.value=null,i.value=[],u.value=null}function S(y){const _=Qt(y.id);window.open(_,"_blank")}function C(){r.value&&k(r.value.durationCategory)}return Me(()=>s.isVisible,async y=>{y?(t.value=1,r.value=null,i.value=[],u.value=null,s.preloadedData&&Array.isArray(s.preloadedData)&&s.preloadedData.length>0?(console.log("[TASK-070] CarryoverDurationModal: Using preloaded data, categories count:",s.preloadedData.length),s.preloadedData.every(A=>A.durationCategory&&A.durationLabel&&typeof A.count=="number")?(m.value=s.preloadedData,l.value=!1):(console.warn("[TASK-070] CarryoverDurationModal: Invalid preloaded data structure, falling back to API"),await T())):(console.log("[TASK-070] CarryoverDurationModal: No preloaded data, loading from API"),await T())):(t.value=1,r.value=null,i.value=[],u.value=null,m.value=[])},{immediate:!1}),Me([()=>s.weekNumber,()=>s.preloadedData],async([y,_])=>{s.isVisible&&y&&(_&&Array.isArray(_)&&_.length>0?_.every(W=>W.durationCategory&&W.durationLabel&&typeof W.count=="number")?(console.log("[TASK-070] CarryoverDurationModal: Week changed, updating with preloaded data for week",y),m.value=_,l.value=!1):(console.log("[TASK-070] CarryoverDurationModal: Week changed, invalid preloaded data, loading from API for week",y),await T()):(console.log("[TASK-070] CarryoverDurationModal: Week changed, loading from API for week",y),await T()))}),(y,_)=>o.isVisible?(c(),d("div",Bk,[a("div",Rk,[ne(Ee,{name:"level",mode:"out-in"},{default:pe(()=>[t.value===1?(c(),d("div",Wk,[a("header",Uk,[a("h3",Fk,[_[3]||(_[3]=ce(" Переходящие тикеты по срокам",-1)),o.weekNumber?(c(),d("span",Hk," · Неделя "+g(o.weekNumber),1)):$("",!0)]),a("button",{class:"modal__close",onClick:_[0]||(_[0]=A=>y.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",jk,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[l.value?(c(),d("div",Vk,[..._[4]||(_[4]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка категорий...",-1)])])):v.value?(c(),d("ul",Gk,[(c(!0),d(ee,null,te(m.value,A=>(c(),d("li",{key:A.durationCategory,class:X(["duration-list__item",{"duration-list__item--clickable":A.count>0}]),style:we({"--duration-color":A.color}),onClick:W=>f(A,W),title:"Кликните для просмотра тикетов категории"},[a("span",{class:"duration-list__color",style:we({backgroundColor:A.color})},null,4),a("span",qk,g(A.durationLabel),1),a("span",Yk,g(A.count)+" тикетов ",1),A.count>0?(c(),d("span",Xk,"→")):$("",!0)],14,Kk))),128))])):(c(),d("p",zk," Нет переходящих тикетов за выбранную неделю "))]),_:1})]),a("footer",Jk,[a("button",{class:"btn",onClick:_[1]||(_[1]=A=>y.$emit("close"))},"Закрыть")])])):t.value===2?(c(),d("div",Zk,[a("header",Qk,[a("button",{class:"btn-back",onClick:p,"aria-label":"Назад"},"← Назад"),a("h3",e1," Тикеты: "+g(r.value?.durationLabel||"Неизвестно"),1),a("button",{class:"modal__close",onClick:_[2]||(_[2]=A=>y.$emit("close")),"aria-label":"Закрыть"}," ✕ ")]),a("section",t1,[ne(Ee,{name:"loading",mode:"out-in"},{default:pe(()=>[n.value?(c(),d("div",s1,[..._[5]||(_[5]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"Загрузка тикетов категории...",-1),a("p",{class:"loading-subtitle"},"Это может занять несколько секунд для больших объемов данных",-1)])])):u.value?(c(),d("div",a1,[_[6]||(_[6]=a("div",{class:"error-icon"},"⚠️",-1)),_[7]||(_[7]=a("p",{class:"error-title"},"Ошибка загрузки",-1)),a("p",o1,g(u.value),1),a("button",{class:"btn btn-retry",onClick:C},"Повторить")])):i.value.length===0?(c(),d("div",n1,[_[8]||(_[8]=a("div",{class:"empty-state-icon"},"📋",-1)),a("p",r1," В категории «"+g(r.value?.durationLabel)+"» нет тикетов ",1)])):(c(),d("div",i1,[ne(Qe,{name:"ticket",tag:"div",class:"tickets-list"},{default:pe(()=>[(c(!0),d(ee,null,te(i.value,(A,W)=>(c(),he(Ct,{key:A.id,ticket:A,draggable:!1,style:we({"--ticket-index":W}),onClick:S},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):$("",!0)]),_:1})])])):$("",!0)}},c1=de(l1,[["__scopeId","data-v-f199806c"]]);function d1(){const o=I(null),e=I(!1),s=I(null),t=async()=>{if(o.value)return o.value;try{e.value=!0,s.value=null;const{fetchAdmissionClosureStats:n,...l}=await Co.loadAdmissionClosureService();o.value={fetchAdmissionClosureStats:n,...l}}catch(n){throw s.value=n,console.error("Failed to load admission service:",n),n}finally{e.value=!1}return o.value},r=async(n={})=>(await t()).fetchAdmissionClosureStats(n),i=()=>{o.value=null,s.value=null};return{service:_s(o),loading:_s(e),error:_s(s),loadService:t,fetchStats:r,clearService:i}}const u1={class:"ac-dashboard"},m1={key:"preloader",class:"chart-preloader"},g1={class:"preloader-content"},h1={class:"preloader-message"},f1={key:"content"},v1={key:1,class:"weeks-dashboard"},p1={class:"dashboard-header"},y1={class:"header-content"},k1={class:"breadcrumbs-row"},b1=["aria-label","aria-disabled","data-fallback","disabled"],_1={class:"breadcrumbs","aria-label":"Навигация"},w1={class:"dashboard-layout"},C1={class:"filters-container"},T1={class:"chart-container"},S1={__name:"GraphAdmissionClosureDashboard",setup(o){const e=Xe(),{fetchStats:s}=d1(),t=async b=>await s(b),r=I(!1),i=I(null),n=I(null),l=I({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),u=I(!1),m=I(!1),v=I(!1),T=I(!0),f=I(null),k=I({weeks:new Map,currentWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null},previousWeek:{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null}}),p=M(()=>{const b=n.value?.weeks||[];return b.length>=2?b[b.length-2]:null}),S=I(!1),C=M(()=>typeof window>"u"?!1:window.history.length>1),y=M(()=>C.value?"Вернуться на предыдущую страницу":"Вернуться на главную страницу"),_={name:"dashboard-sector-1c"};function A(b){if(b?.preventDefault?.(),!S.value){S.value=!0;try{if(C.value){e.back();return}console.warn("GraphAdmissionClosureDashboard: fallback navigation to dashboard-sector-1c"),e.push(_)}finally{S.value=!1}}}function W(){e.push("/")}const x=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),D=I("weeks"),E=M(()=>{const b=x.value.customDateRange.startDate||x.value.customDateRange.endDate,O=x.value.employees.length===1&&x.value.employees.includes("all");return b||!O});async function P(){if(console.log("[DEBUG] loadData called"),console.log("[DEBUG] periodMode:",D.value),console.log("[DEBUG] isLoading before:",r.value),D.value!=="weeks"){console.log("[DEBUG] loadData: periodMode is not weeks, returning and resetting isLoading"),r.value=!1;return}console.log("[DEBUG] Setting isLoading to true"),r.value=!0,i.value=null;const b=new Promise(O=>setTimeout(O,300));try{console.log("[DEBUG] Starting API call");const O=N(),Q=O.weekStartUtc,ue=O.weekEndUtc;console.log("[DEBUG] Week bounds:",{weekStartUtc:Q,weekEndUtc:ue});const[ke,_e]=await Promise.all([b,t({product:"1C",periodMode:"weeks",weekStartUtc:Q,weekEndUtc:ue,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0})]);console.log("[DEBUG] API call successful, result:",_e);const{meta:K,data:j,carryoverDebug:V}=_e;n.value=K;const se=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:j.responsibleCreatedThisWeek?Object.values(j.responsibleCreatedThisWeek):[],me=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:j.responsibleCreatedOtherWeek?Object.values(j.responsibleCreatedOtherWeek):[];l.value={...j,responsibleCreatedThisWeek:se,responsibleCreatedOtherWeek:me},console.log("[DEBUG] Data set, meta:",K,"data keys:",Object.keys(j)),console.log("[TASK-070] chartData.value.responsibleCreatedThisWeek after normalization:",{isArray:Array.isArray(se),length:se.length,sample:se.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] chartData.value.responsibleCreatedOtherWeek after normalization:",{isArray:Array.isArray(me),length:me.length,sample:me.slice(0,2).map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedThisWeek from API:",{count:j.responsibleCreatedThisWeek?.length||0,data:j.responsibleCreatedThisWeek,details:j.responsibleCreatedThisWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] responsibleCreatedOtherWeek from API:",{count:j.responsibleCreatedOtherWeek?.length||0,data:j.responsibleCreatedOtherWeek,details:j.responsibleCreatedOtherWeek?.map(F=>({id:F.id,name:F.name,count:F.count,hasTickets:!!F.tickets,ticketsCount:F.tickets?.length||0}))}),console.log("[TASK-070] closedTicketsCreatedThisWeek:",j.closedTicketsCreatedThisWeek),console.log("[TASK-070] closedTicketsCreatedOtherWeek:",j.closedTicketsCreatedOtherWeek);const ye=K?.weeks||[];if(console.log("[PERF-OPTIMIZATION] Preloading popup data for",ye.length,"weeks"),ye.forEach((F,ie)=>{k.value.weeks.has(F.weekNumber)||k.value.weeks.set(F.weekNumber,{newTicketsByStages:null,carryoverTicketsByDuration:null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:F});const ve=k.value.weeks.get(F.weekNumber);ie===ye.length-1&&(j.newTicketsByStages&&(ve.newTicketsByStages=j.newTicketsByStages,console.log("[PERF-OPTIMIZATION] Preloaded newTicketsByStages for week",F.weekNumber,":",j.newTicketsByStages.length,"stages")),j.carryoverTicketsByDuration&&(ve.carryoverTicketsByDuration=j.carryoverTicketsByDuration,console.log("[PERF-OPTIMIZATION] Preloaded carryoverTicketsByDuration for week",F.weekNumber,":",j.carryoverTicketsByDuration.length,"categories")))}),j.newTicketsByStages&&(k.value.currentWeek.newTicketsByStages=j.newTicketsByStages),j.carryoverTicketsByDuration&&(k.value.currentWeek.carryoverTicketsByDuration=j.carryoverTicketsByDuration),ye.length>1&&G(ye.slice(0,-1)),j.responsibleCreatedThisWeek){const F=Array.isArray(j.responsibleCreatedThisWeek)?j.responsibleCreatedThisWeek:Object.values(j.responsibleCreatedThisWeek);k.value.currentWeek.responsibleCreatedThisWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedThisWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(j.responsibleCreatedOtherWeek){const F=Array.isArray(j.responsibleCreatedOtherWeek)?j.responsibleCreatedOtherWeek:Object.values(j.responsibleCreatedOtherWeek);k.value.currentWeek.responsibleCreatedOtherWeek=F,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for current week:",F.length,"employees"),console.log("[TASK-070] responsibleCreatedOtherWeek details:",F.map(ie=>({id:ie.id,name:ie.name,count:ie.count,hasTickets:!!ie.tickets,ticketsCount:ie.tickets?.length||0})))}if(V&&(console.log("[CARRYOVER-DEBUG] ========================================"),console.log("[CARRYOVER-DEBUG] Total:",V.total),console.log("[CARRYOVER-DEBUG] ThisWeek:",V.thisWeek),console.log("[CARRYOVER-DEBUG] PreviousWeek:",V.previousWeek),console.log("[CARRYOVER-DEBUG] Older:",V.older),console.log("[CARRYOVER-DEBUG] Sum:",V.sum,"(expected:",V.total,")"),console.log("[CARRYOVER-DEBUG] Series:",V.series),console.log("[CARRYOVER-DEBUG] CurrentWeekData:",V.currentWeekData),console.log("[CARRYOVER-DEBUG] WeeksData:",V.weeksData),console.log("[CARRYOVER-DEBUG] Full object:",V),console.log("[CARRYOVER-DEBUG] ========================================")),p.value){const F=p.value.weekStartUtc,ie=p.value.weekEndUtc;console.log("[TASK-070] Starting preload for previous week:",{weekNumber:p.value.weekNumber,weekStartUtc:F,weekEndUtc:ie}),t({product:"1C",periodMode:"weeks",weekStartUtc:F,weekEndUtc:ie,includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0}).then(ve=>{if(console.log("[TASK-070] Preload successful for previous week"),ve.data.newTicketsByStages&&(k.value.previousWeek.newTicketsByStages=ve.data.newTicketsByStages,console.log("[TASK-070] Preloaded newTicketsByStages for previous week:",ve.data.newTicketsByStages.length,"stages")),ve.data.carryoverTicketsByDuration&&(k.value.previousWeek.carryoverTicketsByDuration=ve.data.carryoverTicketsByDuration,console.log("[TASK-070] Preloaded carryoverTicketsByDuration for previous week:",ve.data.carryoverTicketsByDuration.length,"categories")),ve.data.responsibleCreatedThisWeek){const Te=Array.isArray(ve.data.responsibleCreatedThisWeek)?ve.data.responsibleCreatedThisWeek:Object.values(ve.data.responsibleCreatedThisWeek);k.value.previousWeek.responsibleCreatedThisWeek=Te,console.log("[TASK-070] Preloaded responsibleCreatedThisWeek for previous week:",Te.length,"employees")}if(ve.data.responsibleCreatedOtherWeek){const Te=Array.isArray(ve.data.responsibleCreatedOtherWeek)?ve.data.responsibleCreatedOtherWeek:Object.values(ve.data.responsibleCreatedOtherWeek);k.value.previousWeek.responsibleCreatedOtherWeek=Te,console.log("[TASK-070] Preloaded responsibleCreatedOtherWeek for previous week:",Te.length,"employees")}}).catch(ve=>{console.warn("[TASK-070] Failed to preload previous week data (non-critical):",ve)})}}catch(O){console.error("[DEBUG] API call failed:",O),i.value=O instanceof Error?O:new Error("Неизвестная ошибка загрузки"),console.error("[GraphAdmissionClosureDashboard] loadData error:",O)}finally{console.log("[DEBUG] Finally block: setting isLoading to false"),r.value=!1,console.log("[DEBUG] isLoading after:",r.value)}}function B(b){if(!b||!n.value)return console.log("[TASK-070] getPreloadedStagesData: Missing weekMeta or chartMeta"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null;console.log("[TASK-070] getPreloadedStagesData:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,weeksInMeta:O.length});const ke=b.weekNumber===Q,_e=b.weekNumber===ue;let K=null;if(ke)K=k.value.currentWeek.newTicketsByStages,console.log("[TASK-070] Requested week is current week, checking currentWeek data:",K?`Array(${K.length})`:"null");else if(_e)K=k.value.previousWeek.newTicketsByStages,console.log("[TASK-070] Requested week is previous week, checking previousWeek data:",K?`Array(${K.length})`:"null");else return console.log("[TASK-070] Requested week",b.weekNumber,"is neither current nor previous, no preloaded data available"),null;return Array.isArray(K)&&K.length>0?(console.log("[TASK-070] Using preloaded stages data for week",b.weekNumber,":",K.length,"stages"),K):(console.log("[TASK-070] No preloaded stages data for week",b.weekNumber,", will use API fallback"),null)}function U(b){if(!b)return null;const O=k.value.weeks.get(b.weekNumber);if(O?.carryoverTicketsByDuration&&Array.isArray(O.carryoverTicketsByDuration))return console.log("[PERF-OPTIMIZATION] Using preloaded carryover data for week",b.weekNumber,":",O.carryoverTicketsByDuration.length,"categories"),O.carryoverTicketsByDuration;const Q=n.value?.weeks||[],ue=Q.length>0?Q[Q.length-1].weekNumber:n.value.weekNumber,_e=b.weekNumber===ue?k.value.currentWeek.carryoverTicketsByDuration:k.value.previousWeek.carryoverTicketsByDuration;return Array.isArray(_e)&&_e.length>0?(console.log("[TASK-070] Using fallback preloaded carryover data for week",b.weekNumber,":",_e.length,"categories"),_e):(console.log("[PERF-ISSUE] No preloaded carryover data for week",b.weekNumber,", will use slow API fallback"),null)}async function G(b){if(!(!b||b.length===0)){console.log("[PERF-OPTIMIZATION] Starting background preload for",b.length,"weeks");for(const O of b)try{await new Promise(ke=>setTimeout(ke,500)),console.log("[PERF-OPTIMIZATION] Preloading data for week",O.weekNumber);const Q=await t({product:"1C",periodMode:"weeks",weekStartUtc:O.weekStartUtc,weekEndUtc:O.weekEndUtc,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,includeTickets:!1}),ue={newTicketsByStages:Q.data.newTicketsByStages||null,carryoverTicketsByDuration:Q.data.carryoverTicketsByDuration||null,responsibleCreatedThisWeek:null,responsibleCreatedOtherWeek:null,weekMeta:O};k.value.weeks.set(O.weekNumber,ue),console.log("[PERF-OPTIMIZATION] Successfully preloaded data for week",O.weekNumber)}catch(Q){console.warn("[PERF-OPTIMIZATION] Failed to preload data for week",O.weekNumber,":",Q)}console.log("[PERF-OPTIMIZATION] Background preload completed")}}function q(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber;return b.weekNumber===Q&&l.value.responsible||null}function oe(b){if(!b){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedThisWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;if(console.log("[TASK-070] getResponsibleCreatedThisWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=k.value.previousWeek.responsibleCreatedThisWeek;return console.log("[TASK-070] getResponsibleCreatedThisWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedThisWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function Y(b){if(!b){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: weekMeta is null, using chartData:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(!n.value)return console.log("[TASK-070] getResponsibleCreatedOtherWeek: chartMeta is null"),null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;if(console.log("[TASK-070] getResponsibleCreatedOtherWeek:",{requestedWeek:b.weekNumber,currentWeekNumber:Q,previousWeekNumber:ue,isCurrentWeek:ke,isPreviousWeek:_e}),ke){const K=l.value.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: current week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:K?Object.keys(K).length:0}),K?Array.isArray(K)?K:Object.values(K):null}if(_e){const K=k.value.previousWeek.responsibleCreatedOtherWeek;return console.log("[TASK-070] getResponsibleCreatedOtherWeek: previous week data:",{hasData:!!K,isArray:Array.isArray(K),dataLength:Array.isArray(K)?K.length:0,data:K}),K||null}return console.log("[TASK-070] getResponsibleCreatedOtherWeek: week",b.weekNumber,"is neither current nor previous, no preloaded data"),null}function H(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;return ke?l.value.closedTicketsCreatedThisWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===ue)?.closedTicketsCreatedThisWeek??null:null}function Z(b){if(!b||!n.value)return null;const O=n.value?.weeks||[],Q=O.length>0?O[O.length-1].weekNumber:n.value.weekNumber,ue=O.length>=2?O[O.length-2].weekNumber:null,ke=b.weekNumber===Q,_e=b.weekNumber===ue;return ke?l.value.closedTicketsCreatedOtherWeek??null:_e&&l.value.weeksData?l.value.weeksData.find(j=>j.weekNumber===ue)?.closedTicketsCreatedOtherWeek??null:null}function fe(b){x.value.stages=b}function L(b){x.value.employees=b}function h(b){x.value.dateRange=b}function w(b){x.value.customDateRange=b}function R(b){if(!["weeks","months"].includes(b)){console.warn("[GraphAdmissionClosureDashboard] Invalid periodMode:",b);return}b!==D.value&&(D.value=b,b==="weeks"?P():b==="months"&&(r.value=!1))}function re(b){const{mode:O}=b.detail;["weeks","months"].includes(O)&&R(O)}function le(){x.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},ae()}function ae(){D.value==="weeks"&&P()}function ge(b){["weeks","months"].includes(b)&&(D.value=b)}function Se(){console.log("[DEBUG] handleCloseModal called"),console.log("[DEBUG] showPeriodModeInfo before:",T.value),console.log("[DEBUG] isLoading before:",r.value),console.log("[DEBUG] periodMode:",D.value),T.value=!1,r.value=!0,console.log("[DEBUG] showPeriodModeInfo after:",T.value),console.log("[DEBUG] isLoading after:",r.value),Wt(()=>{console.log("[DEBUG] handleCloseModal: calling handleStartLoading in nextTick"),$e()})}function $e(){console.log("[DEBUG] handleStartLoading called"),console.log("[DEBUG] periodMode before check:",D.value),console.log("[DEBUG] showPeriodModeInfo:",T.value),console.log("[DEBUG] isLoading:",r.value),(!D.value||!["weeks","months"].includes(D.value))&&(console.warn('[GraphAdmissionClosureDashboard] Period mode not set, using default "weeks"'),D.value="weeks"),console.log("[GraphAdmissionClosureDashboard] Starting loading, periodMode:",D.value),Wt(()=>{console.log("[DEBUG] nextTick callback, periodMode:",D.value),console.log("[DEBUG] isLoading in nextTick:",r.value),D.value==="weeks"?(console.log("[GraphAdmissionClosureDashboard] Loading data for weeks mode"),P()):D.value==="months"&&(console.log("[GraphAdmissionClosureDashboard] Months mode - data will be loaded by GraphAdmissionClosureMonthsDashboard"),r.value=!1,console.log("[DEBUG] Reset parent isLoading to false for months mode"))})}function Ne(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},m.value=!0}function Fe(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},u.value=!0}function z(b=null){b?f.value=b:f.value={weekNumber:n.value?.weekNumber||null,weekStartUtc:n.value?.weekStartUtc||null,weekEndUtc:n.value?.weekEndUtc||null},v.value=!0}Ae(()=>{try{const b="graph-admission-closure-period-mode-info-shown";localStorage.getItem(b)&&localStorage.removeItem(b);const O="graph-admission-closure-period-mode";localStorage.getItem(O)&&localStorage.removeItem(O)}catch(b){console.warn("[GraphAdmissionClosureDashboard] Failed to clean localStorage:",b)}window.addEventListener("period-mode-change",re)}),st(()=>{window.removeEventListener("period-mode-change",re)});function N(){const b=new Date,O=new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate())),Q=O.getUTCDay(),ue=O.getUTCDate()-Q+(Q===0?-6:1),ke=new Date(Date.UTC(O.getUTCFullYear(),O.getUTCMonth(),ue,0,0,0)),_e=new Date(ke);return _e.setUTCDate(_e.getUTCDate()+6),_e.setUTCHours(23,59,59,999),{weekStartUtc:ke.toISOString(),weekEndUtc:_e.toISOString()}}return(b,O)=>{const Q=be("router-link");return c(),d("div",u1,[ne(Ee,{name:"fade",mode:"out-in"},{default:pe(()=>[r.value?(c(),d("div",m1,[a("div",g1,[O[3]||(O[3]=a("div",{class:"preloader-spinner"},[a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"}),a("div",{class:"spinner-ring"})],-1)),O[4]||(O[4]=a("h3",{class:"preloader-title"},"Загрузка графика",-1)),a("p",h1," Получение данных за "+g(D.value==="weeks"?"4 недели":"3 месяца")+"... ",1),O[5]||(O[5]=a("div",{class:"preloader-dots"},[a("span",{class:"dot"}),a("span",{class:"dot"}),a("span",{class:"dot"})],-1))])])):!T.value&&!r.value?(c(),d("div",f1,[D.value==="months"?(c(),he(kp,{key:0})):(c(),d("div",v1,[a("div",p1,[a("div",y1,[a("div",k1,[a("button",{class:"btn-home-link",type:"button",onClick:W,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),O[11]||(O[11]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),a("button",{class:"btn-back-link",type:"button",onClick:A,"aria-label":y.value,"aria-disabled":!C.value,"data-fallback":!C.value,disabled:S.value,title:"Назад"}," ← ",8,b1),a("nav",_1,[ne(Q,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:pe(()=>[...O[6]||(O[6]=[ce(" Дашборд сектора 1С ",-1)])]),_:1}),O[8]||(O[8]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),ne(Q,{to:{name:"dashboard-graph-state"},class:"breadcrumb-link"},{default:pe(()=>[...O[7]||(O[7]=[ce(" График состояния ",-1)])]),_:1}),O[9]||(O[9]=a("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),O[10]||(O[10]=a("span",{class:"breadcrumb-current"},"График приёма и закрытий",-1))])]),O[12]||(O[12]=a("h1",{class:"dashboard-title"},"График приёма и закрытий сектора 1С",-1)),O[13]||(O[13]=a("p",{class:"dashboard-subtitle"}," Доступы и фильтры аналогичны «Графику состояния», селектор этапов скрыт. ",-1))])]),a("div",w1,[a("div",C1,[ne(Hs,{stages:x.value.stages,employees:x.value.employees,dateRange:x.value.dateRange,customDateRange:x.value.customDateRange,hasActiveFilters:E.value,hideStages:!0,weekPickerMode:!1,showPeriodMode:!0,"period-mode":D.value,"onUpdate:stages":fe,"onUpdate:employees":L,"onUpdate:dateRange":h,"onUpdate:customDateRange":w,"onUpdate:periodMode":R,onReset:le,onApply:ae},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","period-mode"])]),a("div",T1,[i.value?(c(),he(ks,{key:0,type:"error",title:"Ошибка загрузки",message:i.value.message},null,8,["message"])):(c(),he(xf,{key:1,meta:n.value,data:l.value,onOpenResponsible:Fe,onOpenStages:Ne,onOpenCarryover:z},null,8,["meta","data"]))])])]))])):$("",!0)]),_:1}),ne(Qy,{"is-visible":u.value,responsible:q(f.value)||l.value.responsible||[],"closed-tickets-created-this-week":H(f.value)??l.value.closedTicketsCreatedThisWeek??0,"closed-tickets-created-other-week":Z(f.value)??l.value.closedTicketsCreatedOtherWeek??0,"responsible-created-this-week":oe(f.value)||l.value.responsibleCreatedThisWeek||[],"responsible-created-other-week":Y(f.value)||l.value.responsibleCreatedOtherWeek||[],"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,onClose:O[0]||(O[0]=ue=>{u.value=!1,f.value.value=null})},null,8,["is-visible","responsible","closed-tickets-created-this-week","closed-tickets-created-other-week","responsible-created-this-week","responsible-created-other-week","week-number","week-start-utc","week-end-utc"]),ne(Ik,{"is-visible":m.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":B(f.value),onClose:O[1]||(O[1]=ue=>{m.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),ne(c1,{"is-visible":v.value,"week-number":f.value?.weekNumber||n.value?.weekNumber||null,"week-start-utc":f.value?.weekStartUtc||n.value?.weekStartUtc||null,"week-end-utc":f.value?.weekEndUtc||n.value?.weekEndUtc||null,"preloaded-data":U(f.value),onClose:O[2]||(O[2]=ue=>{v.value=!1,f.value.value=null})},null,8,["is-visible","week-number","week-start-utc","week-end-utc","preloaded-data"]),T.value?(c(),he(Ag,{key:0,"is-visible":T.value,"current-mode":D.value,onClose:Se,onSelectMode:ge},null,8,["is-visible","current-mode"])):$("",!0)])}}},Ra=de(S1,[["__scopeId","data-v-2fa9296d"]]),D1=Object.freeze(Object.defineProperty({__proto__:null,default:Ra},Symbol.toStringTag,{value:"Module"})),E1={name:"ZeroPoint",components:{TicketCard:Ct},props:{tickets:{type:Array,required:!0,default:()=>[]},stageId:{type:String,required:!0}},emits:{"ticket-dragged":o=>typeof o=="object"&&o!==null,"ticket-assigned":o=>typeof o=="object"&&o!==null,"ticket-clicked":o=>typeof o=="object"&&o!==null},setup(o,{emit:e}){return{hasTickets:M(()=>Array.isArray(o.tickets)&&o.tickets.length>0),handleTicketDragStart:r=>{e("ticket-dragged",r)}}}},A1={class:"zero-point"},$1={key:0,class:"empty-state"};function I1(o,e,s,t,r,i){const n=be("TicketCard");return c(),d("div",A1,[e[3]||(e[3]=a("div",{class:"zero-point-header"},[a("h3",null,"Нулевая точка")],-1)),rs([s.tickets.length,s.tickets.map(l=>l.id).join(",")],()=>(c(),d("div",{class:"zero-point-tickets"},[(c(!0),d(ee,null,te(s.tickets,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onDragStart:u=>t.handleTicketDragStart(l),onClick:u=>o.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128))])),e,0),e[1]||(Ys(-1,!0),(e[1]=t.hasTickets?$("",!0):(c(),d("div",$1,[...e[2]||(e[2]=[a("p",null,"Нет неразобранных тикетов в стадии",-1)])]))).cacheIndex=1,Ys(1),e[1])])}const M1=de(E1,[["render",I1],["__scopeId","data-v-c5370e55"]]);function N1(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Wa(o){return typeof o=="number"&&o>0&&!isNaN(o)}function Ua(o){return typeof o=="string"&&["formed","review","execution"].includes(o)}function x1(o){return!o||typeof o!="object"?!1:N1(o.id)&&typeof o.title=="string"&&o.title.trim().length>0}function Fa(o,e,s){return!(!x1(o)||!Wa(e)||!Ua(s)||o.assigneeId===e&&o.stageId===s)}function P1(o){const e=[];return!o||typeof o!="object"?(e.push("Данные тикета должны быть объектом"),{valid:!1,errors:e}):((!o.title||typeof o.title!="string"||o.title.trim().length===0)&&e.push("Название тикета обязательно"),o.stageId&&!Ua(o.stageId)&&e.push("Некорректный ID стадии"),o.employeeId&&!Wa(o.employeeId)&&e.push("Некорректный ID сотрудника"),{valid:e.length===0,errors:e})}function L1(o){const e=lt(),s=I(!1);return{isDropZoneActive:s,handleDragStart:(u,m)=>{u.dataTransfer.effectAllowed="move",u.dataTransfer.setData("application/json",JSON.stringify(m)),u.dataTransfer.setDragImage(u.target,0,0)},handleDragOver:u=>{u.preventDefault(),u.dataTransfer.dropEffect="move",s.value=!0},handleDragLeave:u=>{const m=u.currentTarget.getBoundingClientRect(),v=u.clientX,T=u.clientY;(v<m.left||v>m.right||T<m.top||T>m.bottom)&&(s.value=!1)},handleDrop:async(u,m,v)=>{u.preventDefault(),s.value=!1;const T=u.dataTransfer.getData("application/json");if(T)try{const f=JSON.parse(T);if(!Fa(f,m,v)){e.warning("Нельзя переместить тикет сюда");return}o&&typeof o=="function"&&await o(f,m,v)}catch(f){Re.error("Error parsing ticket data","useDragAndDrop",f),e.error("Ошибка обработки данных тикета")}},handleDragEnd:u=>{s.value=!1}}}function Ha(o=null){const e=io(),s=e?.type?.name||e?.type?.__name||null,t=o||s||"Unknown",r=(m,v,T=null)=>{Re.log(m,v,t,T)};return{error:(m,v=null)=>{r("ERROR",m,v)},warn:(m,v=null)=>{r("WARN",m,v)},info:(m,v=null)=>{r("INFO",m,v)},debug:(m,v=null)=>{r("DEBUG",m,v)},log:r,context:t}}const O1={name:"EmployeeColumn",components:{TicketCard:Ct},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(o,{emit:e}){Ha("EmployeeColumn");const t=L1(async(v,T,f)=>{e("ticket-dropped",v,T)}),r=M(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:Array.isArray(o.employee.ticketsInsideSector)?o.employee.ticketsInsideSector:[]),i=M(()=>o.employee.isFromSector1C?[]:Array.isArray(o.employee.ticketsOutsideSector)?o.employee.ticketsOutsideSector:Array.isArray(o.employee.tickets)?o.employee.tickets:[]),n=M(()=>o.employee.isFromSector1C?Array.isArray(o.employee.tickets)?o.employee.tickets:[]:[]),l=M(()=>r.value.length+i.value.length),u=v=>{t.handleDrop(v,o.employee.id,o.stageId)},m=v=>{};return{isDropZoneActive:t.isDropZoneActive,handleDragOver:t.handleDragOver,handleDragLeave:t.handleDragLeave,handleDrop:u,ticketsInsideSector:r,ticketsOutsideSector:i,ticketsToDisplay:n,totalTicketsCount:l,handleTicketDragStart:m}}},B1={class:"employee-header"},R1={class:"employee-info"},W1={class:"employee-details"},U1={class:"employee-name"},F1={key:0,class:"employee-position"},H1={class:"tickets-count"},j1={class:"tickets-list"},V1={class:"section-header"},z1={class:"section-count"},G1={key:2,class:"empty-state"};function K1(o,e,s,t,r,i){const n=be("TicketCard");return c(),d("div",{class:X(["employee-column",{"drop-zone-active":t.isDropZoneActive}]),onDragover:e[3]||(e[3]=Ce((...l)=>t.handleDragOver&&t.handleDragOver(...l),["prevent"])),onDragleave:e[4]||(e[4]=(...l)=>t.handleDragLeave&&t.handleDragLeave(...l)),onDrop:e[5]||(e[5]=(...l)=>t.handleDrop&&t.handleDrop(...l))},[a("div",B1,[a("div",R1,[e[6]||(e[6]=a("span",{class:"employee-icon"},"👤",-1)),a("div",W1,[a("div",U1,g(s.employee.name),1),s.employee.position?(c(),d("div",F1,g(s.employee.position),1)):$("",!0)])]),a("div",H1," 📊 Тикетов: "+g(t.totalTicketsCount),1)]),a("div",j1,[s.employee.isFromSector1C?rs([t.ticketsToDisplay.length,t.ticketsToDisplay.map(l=>l.id).join(",")],()=>(c(),d("div",{key:0},[ne(Qe,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),d(ee,null,te(t.ticketsToDisplay,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:u=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,0):(c(),d(ee,{key:1},[t.ticketsInsideSector.length>0?rs([t.ticketsInsideSector.length,t.ticketsInsideSector.map(l=>l.id).join(",")],()=>(c(),d("div",{key:0,class:"tickets-section tickets-inside-sector"},[ne(Qe,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),d(ee,null,te(t.ticketsInsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,onClick:u=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,1):$("",!0),t.ticketsOutsideSector.length>0?rs([t.ticketsOutsideSector.length,t.ticketsOutsideSector.map(l=>l.id).join(",")],()=>(c(),d("div",{key:1,class:"tickets-section tickets-outside-sector"},[a("div",V1,[e[7]||(e[7]=a("span",{class:"section-badge"},"Вне сектора",-1)),a("span",z1,g(t.ticketsOutsideSector.length),1)]),ne(Qe,{name:"ticket",tag:"div"},{default:pe(()=>[(c(!0),d(ee,null,te(t.ticketsOutsideSector,l=>(c(),he(n,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:u=>o.$emit("ticket-clicked",l),onDragStart:t.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])),e,2):$("",!0)],64)),t.totalTicketsCount===0?(c(),d("div",G1,[...e[8]||(e[8]=[a("p",null,"Нет тикетов",-1)])])):$("",!0)])],34)}const q1=de(O1,[["render",K1],["__scopeId","data-v-cdec5b5c"]]),Y1={name:"DashboardStage",components:{ZeroPoint:M1,EmployeeColumn:q1},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(o,{emit:e}){const s=Ha("DashboardStage"),t=I(!1),r=M(()=>{const f=Array.isArray(o.zeroPointTickets)?o.zeroPointTickets.length:0,k=Array.isArray(o.stage.employees)?o.stage.employees.reduce((p,S)=>Array.isArray(S.ticketsInsideSector)?p+S.ticketsInsideSector.length:S.isFromSector1C&&Array.isArray(S.tickets)?p+S.tickets.length:p,0):0;return f+k}),i=M(()=>Array.isArray(o.stage.employees)?o.stage.employees.reduce((f,k)=>Array.isArray(k.ticketsOutsideSector)?f+k.ticketsOutsideSector.length:!k.isFromSector1C&&Array.isArray(k.tickets)?f+k.tickets.length:f,0):0),n=M(()=>r.value+i.value),l=M(()=>{const f=o.stage?.name||"Стадия",k=r.value,p=i.value;return p===0?`${f} (${k})`:`${f} (${k} / ${p})`});return{isDragging:t,ticketsCountInsideSector:r,ticketsCountOutsideSector:i,totalTicketsCount:n,stageNameWithCount:l,handleTicketDragged:f=>{t.value=!0},handleTicketAssigned:(f,k)=>{e("ticket-assigned",f,k)},handleTicketDropped:(f,k)=>{e("ticket-moved",f,k,o.stage.id),t.value=!1},handleTicketClicked:f=>{s.debug("Ticket clicked",f),e("ticket-clicked",f)}}}},X1={class:"stage-header"},J1={class:"stage-content"},Z1={class:"employees-container"};function Q1(o,e,s,t,r,i){const n=be("ZeroPoint"),l=be("EmployeeColumn");return c(),d("div",{class:"dashboard-stage",style:we({borderLeftColor:s.stage.color})},[a("div",X1,[a("h2",null,g(t.stageNameWithCount),1)]),a("div",J1,[ne(n,{tickets:s.zeroPointTickets,"stage-id":s.stage.id,onTicketDragged:t.handleTicketDragged,onTicketAssigned:t.handleTicketAssigned,onTicketClicked:t.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),a("div",Z1,[(c(!0),d(ee,null,te(s.stage.employees,u=>(c(),he(l,{key:u.id,employee:u,"stage-id":s.stage.id,onTicketClicked:t.handleTicketClicked,onTicketDropped:t.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const e0=de(Y1,[["render",Q1],["__scopeId","data-v-c6fbde76"]]),As={cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},t0={loading_tickets:{title:"Загрузка тикетов",description:"Получение данных из Bitrix24..."},filtering:{title:"Фильтрация тикетов",description:"Отбор тикетов сектора 1С..."},extracting_employees:{title:"Определение сотрудников",description:"Анализ назначенных сотрудников..."},loading_employees:{title:"Загрузка данных сотрудников",description:"Получение информации о сотрудниках..."},grouping:{title:"Группировка данных",description:"Распределение тикетов по этапам..."},caching:{title:"Сохранение в кеш",description:"Оптимизация для следующих загрузок..."},cache_check:{title:"Проверка кеша",description:"Поиск сохранённых данных..."},cache_hit:{title:"Данные загружены",description:"Мгновенная загрузка..."},complete:{title:"Готово!",description:"Дашборд загружен"},error:{title:"Ошибка загрузки",description:"Не удалось загрузить данные"}},s0={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(o,{emit:e}){const s=M(()=>{const{currentStep:m,stepDetails:v}=o;return v?.description?{title:m?As[m]?.title||m:"Загрузка...",description:v.description}:m?As[m]?As[m]:t0[m]||{title:"Загрузка...",description:"Пожалуйста, подождите..."}:{title:"Загрузка...",description:"Инициализация..."}}),t=M(()=>s.value.title),r=M(()=>s.value.description),i=M(()=>o.stepDetails),n=M(()=>{const m=o.progress;return m==null||isNaN(m)?0:Math.round(Math.max(0,Math.min(100,m)))});return{stepTitle:t,stepDescription:r,details:i,displayProgress:n,getStageDisplayName:m=>m?{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение","Сформировано обращение":"Сформировано обращение","Рассмотрение ТЗ":"Рассмотрение ТЗ",Исполнение:"Исполнение"}[m]||m:"",handleRetry:()=>{e("retry")}}}},a0={class:"preloader-backdrop"},o0={class:"preloader-container"},n0={class:"preloader-content-scrollable"},r0={key:0,class:"spinner-container"},i0={class:"preloader-content"},l0={class:"step-title"},c0={key:0,class:"step-description"},d0={key:1,class:"progress-container"},u0={class:"progress-bar"},m0={class:"progress-text"},g0={key:2,class:"step-details"},h0={key:0,class:"detail-description"},f0={key:1,class:"detail-item"},v0={class:"detail-value"},p0={key:0,class:"detail-total"},y0={key:2,class:"detail-item"},k0={class:"detail-value"},b0={key:0,class:"detail-total"},_0={key:3,class:"detail-item"},w0={class:"detail-value"},C0={key:0,class:"detail-total"},T0={key:4,class:"detail-item"},S0={class:"detail-value"},D0={key:5,class:"detail-warning"},E0={key:0,class:"error-container"},A0={class:"error-content"},$0={class:"error-message"};function I0(o,e,s,t,r,i){return c(),d("div",{class:X(["loading-preloader",{"has-error":s.error}])},[a("div",a0,[a("div",o0,[a("div",n0,[s.error?$("",!0):(c(),d("div",r0,[...e[1]||(e[1]=[a("div",{class:"spinner"},null,-1)])])),a("div",i0,[a("h3",l0,g(t.stepTitle),1),t.stepDescription?(c(),d("p",c0,g(t.stepDescription),1)):$("",!0),s.error?$("",!0):(c(),d("div",d0,[a("div",u0,[a("div",{class:"progress-fill",style:we({width:t.displayProgress+"%"})},null,4)]),a("span",m0,g(t.displayProgress)+"%",1)])),s.error?$("",!0):(c(),d("div",g0,[t.details.description?(c(),d("div",h0,g(t.details.description),1)):$("",!0),t.details.count!==void 0?(c(),d("div",f0,[e[2]||(e[2]=a("span",{class:"detail-label"},"Загружено тикетов:",-1)),a("span",v0,g(t.details.count),1),t.details.total!==void 0?(c(),d("span",p0," из "+g(t.details.total),1)):$("",!0)])):$("",!0),t.details.filteredTickets!==void 0?(c(),d("div",y0,[e[3]||(e[3]=a("span",{class:"detail-label"},"Отфильтровано тикетов:",-1)),a("span",k0,g(t.details.filteredTickets),1),t.details.totalTickets!==void 0?(c(),d("span",b0," из "+g(t.details.totalTickets),1)):$("",!0)])):$("",!0),t.details.stage?(c(),d("div",_0,[e[4]||(e[4]=a("span",{class:"detail-label"},"Стадия:",-1)),a("span",w0,g(t.getStageDisplayName(t.details.stage)),1),t.details.stageIndex&&t.details.totalStages?(c(),d("span",C0," ("+g(t.details.stageIndex)+"/"+g(t.details.totalStages)+") ",1)):$("",!0)])):$("",!0),t.details.employeeCount!==void 0?(c(),d("div",T0,[e[5]||(e[5]=a("span",{class:"detail-label"},"Сотрудников:",-1)),a("span",S0,g(t.details.employeeCount),1)])):$("",!0),t.details.warning?(c(),d("div",D0,[a("span",null,"⚠️ "+g(t.details.warning),1)])):$("",!0)]))])])])]),s.error?(c(),d("div",E0,[a("div",A0,[e[6]||(e[6]=a("div",{class:"error-icon"},"⚠️",-1)),a("p",$0,g(s.error),1),a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleRetry&&t.handleRetry(...n)),class:"retry-button"}," Повторить попытку ")])])):$("",!0)],2)}const M0=de(s0,[["render",I0],["__scopeId","data-v-d129ff19"]]),N0={name:"LoggerControl",props:{showControl:{type:Boolean,default:!1}},setup(){const o=I(!1),e=I("ERROR"),s=I(!0),t=u=>({NONE:"Отключено",ERROR:"Только ошибки",WARN:"Предупреждения и ошибки",INFO:"Информация, предупреждения и ошибки",DEBUG:"Все логи (отладка)"})[u]||u;return Ae(()=>{const u=It.getLevel();e.value=u,o.value=u!=="NONE"}),{enabled:o,level:e,isExpanded:s,getLevelDescription:t,handleToggle:()=>{o.value?(e.value==="NONE"&&(e.value="ERROR"),It.setLevel(e.value)):(It.setLevel("NONE"),e.value="NONE")},handleLevelChange:()=>{o.value&&It.setLevel(e.value)},resetToDefault:()=>{const u="ERROR";e.value=u,o.value=!0,It.setLevel(u)},toggleVisibility:()=>{s.value=!s.value}}}},x0={key:0,class:"logger-control"},P0={class:"logger-control-header"},L0=["aria-label"],O0={key:0,class:"logger-control-content"},B0={class:"logger-control-section"},R0={class:"logger-control-label"},W0={key:0,class:"logger-control-section"},U0={class:"logger-control-label"},F0={key:1,class:"logger-control-info"},H0={class:"logger-control-info-text"},j0={key:2,class:"logger-control-section"};function V0(o,e,s,t,r,i){return s.showControl?(c(),d("div",x0,[a("div",P0,[e[6]||(e[6]=a("h3",{class:"logger-control-title"},"Управление логированием",-1)),a("button",{class:"logger-control-toggle",onClick:e[0]||(e[0]=(...n)=>t.toggleVisibility&&t.toggleVisibility(...n)),"aria-label":t.isExpanded?"Свернуть":"Развернуть"},g(t.isExpanded?"▼":"▶"),9,L0)]),t.isExpanded?(c(),d("div",O0,[a("div",B0,[a("label",R0,[Le(a("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=n=>t.enabled=n),onChange:e[2]||(e[2]=(...n)=>t.handleToggle&&t.handleToggle(...n)),class:"logger-control-checkbox"},null,544),[[ys,t.enabled]]),e[7]||(e[7]=a("span",{class:"logger-control-label-text"},"Включить логирование",-1))])]),t.enabled?(c(),d("div",W0,[a("label",U0,[e[9]||(e[9]=a("span",{class:"logger-control-label-text"},"Уровень логирования:",-1)),Le(a("select",{"onUpdate:modelValue":e[3]||(e[3]=n=>t.level=n),onChange:e[4]||(e[4]=(...n)=>t.handleLevelChange&&t.handleLevelChange(...n)),class:"logger-control-select"},[...e[8]||(e[8]=[_t('<option value="NONE" data-v-ed57067c>Отключено</option><option value="ERROR" data-v-ed57067c>Только ошибки</option><option value="WARN" data-v-ed57067c>Предупреждения и ошибки</option><option value="INFO" data-v-ed57067c>Информация, предупреждения и ошибки</option><option value="DEBUG" data-v-ed57067c>Все логи (отладка)</option>',5)])],544),[[dt,t.level]])])])):$("",!0),t.enabled?(c(),d("div",F0,[a("span",H0,[e[10]||(e[10]=ce(" Текущий уровень: ",-1)),a("strong",null,g(t.getLevelDescription(t.level)),1)])])):$("",!0),t.enabled?(c(),d("div",j0,[a("button",{onClick:e[5]||(e[5]=(...n)=>t.resetToDefault&&t.resetToDefault(...n)),class:"logger-control-reset-btn",title:"Сбросить к значению по умолчанию"}," Сбросить к умолчанию ")])):$("",!0)])):$("",!0)])):$("",!0)}const z0=de(N0,[["render",V0],["__scopeId","data-v-ed57067c"]]),G0={name:"DiagnosticsPanel",props:{isEnabled:{type:Boolean,default:!1},isUserAdmin:{type:Boolean,default:!1}},setup(o){const e=I(!0),s=tt(),t=M(()=>!o.isEnabled||!o.isUserAdmin?{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}:s?s.getMetrics():(console.warn("[DiagnosticsPanel] Diagnostics service not available"),{ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}})),r=M(()=>!o.isEnabled||!o.isUserAdmin||!s?{withoutAssignedById:[],withAssignedById1051:[],withoutSectorTag:[],notInColumn:[],unknownStage:[]}:s.getProblematicTickets()),i=M(()=>{const m=r.value;return m.withoutAssignedById.length===0&&m.withAssignedById1051.length===0&&m.withoutSectorTag.length===0&&m.notInColumn.length===0&&m.unknownStage.length===0});return{isExpanded:e,metrics:t,problematicTickets:r,hasNoProblems:i,toggleExpanded:()=>{e.value=!e.value},downloadJSON:()=>{if(!s)return;const m=s.exportToJSON(),v=new Blob([m],{type:"application/json"}),T=URL.createObjectURL(v),f=document.createElement("a");f.href=T,f.download=`dashboard-diagnostics-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(T)},getStageName:m=>xt.getStageName(m)||m}}},K0={key:0,class:"diagnostics-panel"},q0={class:"diagnostics-header"},Y0={class:"header-actions"},X0=["title"],J0={key:0,class:"diagnostics-content"},Z0={class:"diagnostics-section"},Q0={class:"metrics-grid"},eb={class:"metric-card"},tb={class:"metric-value"},sb={class:"metric-label"},ab={class:"metric-value"},ob={class:"metric-detail"},nb={class:"diagnostics-section"},rb={class:"metrics-grid"},ib={class:"metric-card"},lb={class:"metric-value"},cb={class:"metric-card",style:{"border-left-color":"#28a745"}},db={class:"metric-value"},ub={class:"metric-card",style:{"border-left-color":"#dc3545"}},mb={class:"metric-value"},gb={key:0,class:"metric-detail"},hb={key:0,class:"warning-box"},fb={key:1,class:"examples-box"},vb={class:"example-type"},pb={key:0,class:"normalized"},yb={class:"diagnostics-section"},kb={class:"metrics-grid"},bb={class:"metric-card"},_b={class:"metric-value"},wb={class:"metric-card"},Cb={class:"metric-value"},Tb={class:"metric-card"},Sb={class:"metric-value"},Db={class:"diagnostics-section"},Eb={class:"metrics-grid"},Ab={class:"metric-card"},$b={class:"metric-value"},Ib={class:"metric-card",style:{"border-left-color":"#28a745"}},Mb={class:"metric-value"},Nb={class:"metric-card",style:{"border-left-color":"#ffc107"}},xb={class:"metric-value"},Pb={key:0,class:"employees-list"},Lb={class:"diagnostics-section"},Ob={class:"metrics-grid"},Bb={class:"metric-label"},Rb={class:"metric-value"},Wb={class:"diagnostics-section problematic-tickets"},Ub={key:0,class:"problem-group"},Fb={class:"tickets-list"},Hb={class:"ticket-id"},jb={class:"ticket-title"},Vb={class:"ticket-stage"},zb={key:0,class:"more-items"},Gb={key:1,class:"problem-group"},Kb={class:"tickets-list"},qb={class:"ticket-id"},Yb={class:"ticket-title"},Xb={class:"ticket-stage"},Jb={key:0,class:"more-items"},Zb={key:2,class:"problem-group"},Qb={class:"tickets-list"},e_={class:"ticket-id"},t_={class:"ticket-title"},s_={class:"ticket-stage"},a_={key:0,class:"more-items"},o_={key:3,class:"problem-group"},n_={class:"tickets-list"},r_={class:"ticket-id"},i_={class:"ticket-title"},l_={class:"ticket-stage"},c_={key:0,class:"more-items"},d_={key:4,class:"problem-group"},u_={class:"tickets-list"},m_={class:"ticket-id"},g_={class:"ticket-title"},h_={class:"ticket-stage"},f_={key:0,class:"more-items"},v_={key:5,class:"no-problems"};function p_(o,e,s,t,r,i){return s.isEnabled&&s.isUserAdmin?(c(),d("div",K0,[a("div",q0,[e[2]||(e[2]=a("h2",null,"🔍 Диагностика дашборда",-1)),a("div",Y0,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.downloadJSON&&t.downloadJSON(...n)),class:"btn-download",title:"Скачать JSON"}," 📥 Скачать JSON "),a("button",{onClick:e[1]||(e[1]=(...n)=>t.toggleExpanded&&t.toggleExpanded(...n)),class:"btn-toggle",title:t.isExpanded?"Свернуть":"Развернуть"},g(t.isExpanded?"▼":"▶"),9,X0)])]),t.isExpanded?(c(),d("div",J0,[a("section",Z0,[e[4]||(e[4]=a("h3",null,"📊 Загрузка тикетов",-1)),a("div",Q0,[a("div",eb,[e[3]||(e[3]=a("div",{class:"metric-label"},"Всего загружено",-1)),a("div",tb,g(t.metrics.ticketsLoading.totalLoaded),1)]),(c(!0),d(ee,null,te(t.metrics.ticketsLoading.stages,(n,l)=>(c(),d("div",{key:l,class:"metric-card"},[a("div",sb,g(t.getStageName(l)),1),a("div",ab,g(n.total),1),a("div",ob,"Батчей: "+g(n.batches.length),1)]))),128))])]),a("section",nb,[e[10]||(e[10]=a("h3",null,"🔍 Фильтрация по сектору 1С",-1)),a("div",rb,[a("div",ib,[e[5]||(e[5]=a("div",{class:"metric-label"},"Всего тикетов загружено",-1)),a("div",lb,g(t.metrics.filtering.total),1)]),a("div",cb,[e[6]||(e[6]=a("div",{class:"metric-label"},"Прошло фильтр (тег 1С)",-1)),a("div",db,g(t.metrics.filtering.filtered),1)]),a("div",ub,[e[7]||(e[7]=a("div",{class:"metric-label"},"Отклонено (нет тега 1С)",-1)),a("div",mb,g(t.metrics.filtering.rejected.length),1),t.metrics.filtering.total>0?(c(),d("div",gb,g(Math.round(t.metrics.filtering.rejected.length/t.metrics.filtering.total*100))+"% от всех ",1)):$("",!0)])]),t.metrics.filtering.rejected.length>0?(c(),d("div",hb,[e[8]||(e[8]=a("strong",null,"⚠️ Внимание:",-1)),ce(" "+g(t.metrics.filtering.rejected.length)+" тикетов не имеют тега сектора 1С (UF_CRM_7_TYPE_PRODUCT = '1C') и поэтому не отображаются в дашборде. Эти тикеты есть в Bitrix24, но не попали в интерфейс. ",1)])):$("",!0),t.metrics.filtering.tagValueExamples.length>0?(c(),d("div",fb,[e[9]||(e[9]=a("h4",null,"Примеры значений UF_CRM_7_TYPE_PRODUCT:",-1)),a("ul",null,[(c(!0),d(ee,null,te(t.metrics.filtering.tagValueExamples.slice(0,10),(n,l)=>(c(),d("li",{key:l},[a("code",null,g(JSON.stringify(n.value)),1),a("span",vb,"("+g(n.type)+g(n.isArray?", массив":"")+")",1),n.normalized&&n.normalized.length?(c(),d("span",pb," → нормализовано: "+g(n.normalized.join(", ")),1)):$("",!0)]))),128))])])):$("",!0)]),a("section",yb,[e[14]||(e[14]=a("h3",null,"👥 Сотрудники",-1)),a("div",kb,[a("div",bb,[e[11]||(e[11]=a("div",{class:"metric-label"},"Уникальных ID",-1)),a("div",_b,g(t.metrics.employees.totalUnique),1)]),a("div",wb,[e[12]||(e[12]=a("div",{class:"metric-label"},"Без assignedById",-1)),a("div",Cb,g(t.metrics.employees.ticketsWithoutAssignedById.length),1)]),a("div",Tb,[e[13]||(e[13]=a("div",{class:"metric-label"},"С assignedById=1051",-1)),a("div",Sb,g(t.metrics.employees.ticketsWithAssignedById1051.length),1)])])]),a("section",Db,[e[18]||(e[18]=a("h3",null,"📦 Группировка по стадиям",-1)),(c(!0),d(ee,null,te(t.metrics.grouping.distributionByStages,(n,l)=>(c(),d("div",{key:l,class:"stage-distribution"},[a("h4",null,g(t.getStageName(l)),1),a("div",Eb,[a("div",Ab,[e[15]||(e[15]=a("div",{class:"metric-label"},"Всего тикетов в стадии",-1)),a("div",$b,g(n.total||0),1)]),a("div",Ib,[e[16]||(e[16]=a("div",{class:"metric-label"},"Внутри сектора 1С",-1)),a("div",Mb,g(n.insideSector||0),1)]),a("div",Nb,[e[17]||(e[17]=a("div",{class:"metric-label"},"Вне сектора 1С",-1)),a("div",xb,g(n.outsideSector||0),1)])]),Object.keys(n.employees||{}).length>0?(c(),d("div",Pb,[(c(!0),d(ee,null,te(n.employees,(u,m)=>(c(),d("div",{key:m,class:"employee-item"}," Сотрудник #"+g(m)+": "+g(u)+" тикетов ",1))),128))])):$("",!0)]))),128))]),a("section",Lb,[e[19]||(e[19]=a("h3",null,"🎯 Нулевая точка",-1)),a("div",Ob,[(c(!0),d(ee,null,te(t.metrics.zeroPoint.byStage,(n,l)=>(c(),d("div",{key:l,class:"metric-card"},[a("div",Bb,g(t.getStageName(l)),1),a("div",Rb,g(n),1)]))),128))])]),a("section",Wb,[e[20]||(e[20]=a("h3",null,"⚠️ Проблемные тикеты",-1)),t.problematicTickets.withoutAssignedById.length>0?(c(),d("div",Ub,[a("h4",null,"Без assignedById ("+g(t.problematicTickets.withoutAssignedById.length)+")",1),a("div",Fb,[(c(!0),d(ee,null,te(t.problematicTickets.withoutAssignedById.slice(0,10),n=>(c(),d("div",{key:n.id,class:"ticket-item"},[a("span",Hb,"#"+g(n.id),1),a("span",jb,g(n.title),1),a("span",Vb,g(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withoutAssignedById.length>10?(c(),d("div",zb," ... и ещё "+g(t.problematicTickets.withoutAssignedById.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withAssignedById1051.length>0?(c(),d("div",Gb,[a("h4",null,"С assignedById=1051 ("+g(t.problematicTickets.withAssignedById1051.length)+")",1),a("div",Kb,[(c(!0),d(ee,null,te(t.problematicTickets.withAssignedById1051.slice(0,10),n=>(c(),d("div",{key:n.id,class:"ticket-item"},[a("span",qb,"#"+g(n.id),1),a("span",Yb,g(n.title),1),a("span",Xb,g(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.withAssignedById1051.length>10?(c(),d("div",Jb," ... и ещё "+g(t.problematicTickets.withAssignedById1051.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.withoutSectorTag.length>0?(c(),d("div",Zb,[a("h4",null,"Без/неверный тег сектора ("+g(t.problematicTickets.withoutSectorTag.length)+")",1),a("div",Qb,[(c(!0),d(ee,null,te(t.problematicTickets.withoutSectorTag.slice(0,10),n=>(c(),d("div",{key:n.id||n.ID,class:"ticket-item"},[a("span",e_,"#"+g(n.id||n.ID),1),a("span",t_,g(n.title||n.TITLE||"Без названия"),1),a("span",s_,g(t.getStageName(n.stageId||n.STAGE_ID)),1)]))),128)),t.problematicTickets.withoutSectorTag.length>10?(c(),d("div",a_," ... и ещё "+g(t.problematicTickets.withoutSectorTag.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.notInColumn.length>0?(c(),d("div",o_,[a("h4",null,"Не попали в колонку ("+g(t.problematicTickets.notInColumn.length)+")",1),a("div",n_,[(c(!0),d(ee,null,te(t.problematicTickets.notInColumn.slice(0,10),n=>(c(),d("div",{key:n.id,class:"ticket-item"},[a("span",r_,"#"+g(n.id),1),a("span",i_,g(n.title),1),a("span",l_,g(t.getStageName(n.stageId)),1)]))),128)),t.problematicTickets.notInColumn.length>10?(c(),d("div",c_," ... и ещё "+g(t.problematicTickets.notInColumn.length-10),1)):$("",!0)])])):$("",!0),t.problematicTickets.unknownStage.length>0?(c(),d("div",d_,[a("h4",null,"Неизвестная стадия ("+g(t.problematicTickets.unknownStage.length)+")",1),a("div",u_,[(c(!0),d(ee,null,te(t.problematicTickets.unknownStage.slice(0,10),n=>(c(),d("div",{key:n.id,class:"ticket-item"},[a("span",m_,"#"+g(n.id),1),a("span",g_,g(n.title),1),a("span",h_,"Стадия: "+g(n.stageId),1)]))),128)),t.problematicTickets.unknownStage.length>10?(c(),d("div",f_," ... и ещё "+g(t.problematicTickets.unknownStage.length-10),1)):$("",!0)])])):$("",!0),t.hasNoProblems?(c(),d("div",v_," ✅ Проблемных тикетов не обнаружено ")):$("",!0)])])):$("",!0)])):$("",!0)}const y_=de(G0,[["render",p_],["__scopeId","data-v-74a5e138"]]);function k_(){const o=I(!1),e=I(null),s=I([{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}]),t=I({formed:[],review:[],execution:[]}),r=I([]),i=I(null);return{isLoading:o,error:e,stages:s,zeroPointTickets:t,employees:r,draggedTicket:i,updateState:v=>{v.stages&&(s.value=v.stages),v.employees&&(r.value=v.employees),v.zeroPointTickets&&(t.value=v.zeroPointTickets)},resetState:()=>{o.value=!1,e.value=null,s.value=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:[]},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:[]},{id:"execution",name:"Исполнение",color:"#28a745",employees:[]}],t.value={formed:[],review:[],execution:[]},r.value=[],i.value=null},updateLocalStateAfterMove:(v,T,f)=>{const k=s.value.find(S=>S.employees.some(C=>C.tickets.some(y=>y.id===v.id)));if(k){const S=k.employees.find(C=>C.tickets.some(y=>y.id===v.id));S&&(S.tickets=S.tickets.filter(C=>C.id!==v.id))}const p=s.value.find(S=>S.id===f);if(p){const S=p.employees.find(C=>C.id===T);if(S){const C={...v,assigneeId:T,stageId:f};S.tickets.push(C)}}Object.keys(t.value).forEach(S=>{t.value[S]=t.value[S].filter(C=>C.id!==v.id)})},getEmployeeTickets:(v,T)=>{const f=s.value.find(p=>p.id===T);if(!f)return[];const k=f.employees.find(p=>p.id===v);return k?k.tickets||[]:[]}}}const mt={fadeOutDuration:400,fadeInDuration:400,delayBetween:150,readyDisplayTime:800,fadeOutEasing:"ease-out",fadeInEasing:"ease-in",fadeOutTransform:"scale(0.95)",fadeInTransform:"translateY(10px)"},ia={fadeInDuration:400,fadeInEasing:"ease-in"};function ja(o,e,s="opacity, transform"){return`${s} ${o}ms ${e}`}function b_(){return ja(mt.fadeOutDuration,mt.fadeOutEasing)}function __(){return ja(ia.fadeInDuration,ia.fadeInEasing)}function w_(){const o=I(!1),e=I(null),s=n=>{o.value=!0,e.value=Date.now(),n&&n()},t=n=>{o.value=!1,e.value=null,n&&n()},r=(n,l,u=mt)=>{s(()=>{n&&n(),setTimeout(()=>{l&&l()},u.delayBetween),setTimeout(()=>{t()},u.fadeOutDuration)})},i=M(()=>e.value?Date.now()-e.value:0);return{isTransitioning:M(()=>o.value),startTransition:s,endTransition:t,executeTransition:r,transitionDuration:i}}function C_(o,e=""){if(Logger.error(`API Error ${e?`(${e})`:""}`,"ErrorHandler",o),o.message){if(o.message.includes("HTTP error"))return"Ошибка соединения с сервером. Проверьте подключение к интернету.";if(o.message.includes("timeout"))return"Превышено время ожидания ответа. Попробуйте позже.";if(o.message.includes("403")||o.message.includes("401"))return"Ошибка доступа. Проверьте права доступа.";if(o.message.includes("500"))return"Ошибка на сервере. Обратитесь к администратору."}return o.message||"Произошла неизвестная ошибка"}function T_(o,e="",s={}){const t={message:o.message,stack:o.stack,context:e,...s,timestamp:new Date().toISOString()};Logger.error("Error logged","ErrorHandler",t)}function $s(o,e="",s=null){const t=C_(o,e);T_(o,e),s&&typeof s=="function"?s(t,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:t,autoHideDelay:5e3})}function S_(o){const e=lt(),s=$a(),{isTransitioning:t,executeTransition:r}=w_();function i(k,p){const S=ds(k);S.step&&p.updateStep(S.step,S.details||{}),S.progress!==void 0&&S.progress!==null&&(p.updateProgress(S.progress),p.clearTemporaryError())}const n=async(k=!0)=>{o.isLoading.value=!0,o.error.value=null,s.reset(),s.updateStep("cache_check",{description:"Инициализация загрузки данных..."}),s.updateProgress(0);try{const p=await Bt.getSectorData(k,S=>{i(S,s)});o.updateState(p)}catch(p){o.error.value=p.message,s.setError(p.message),$s(p,"loading sector data",e.error)}finally{if(o.error.value)o.isLoading.value=!1;else{s.updateStep("complete",{description:"Дашборд загружен"}),s.updateProgress(100);const p=mt.readyDisplayTime||800;setTimeout(()=>{r(()=>{},()=>{o.isLoading.value=!1},mt),setTimeout(()=>{s.reset()},mt.fadeOutDuration)},p)}}},l=async(k,p,S)=>{if(!Fa(k,p,S))return e.warning("Нельзя переместить тикет сюда"),!1;try{const C=await Bt.assignTicket(k.id,p,S);return C&&(o.updateLocalStateAfterMove(k,p,S),e.success("Тикет перемещён")),C}catch(C){return $s(C,"assigning ticket",e.error),!1}finally{o.draggedTicket.value=null}};return{loadSectorData:n,assignTicket:l,moveTicketToStage:async(k,p)=>await l(k,k.assigneeId,p),assignTicketToEmployee:async(k,p)=>await l(k,p,k.stageId),createTicket:async k=>{const p=P1(k);if(!p.valid){const S=p.errors.join(", ");return e.error(S),0}try{const S=await Bt.createTicket(k);return S>0&&(await n(!1),e.success("Тикет создан")),S}catch(S){return $s(S,"creating ticket",e.error),0}},handleTicketDragStart:k=>{o.draggedTicket.value=k},handleTicketDrop:async(k,p,S)=>{await l(k,p,S)},loadingProgress:s,isTransitioning:t}}const js={name:"DashboardSector1C",components:{DashboardStage:e0,LoadingPreloader:M0,LoggerControl:z0,BackButton:_a,DiagnosticsPanel:y_},setup(){const o=Xe(),e=ps(),s=k_(),t=S_(s),r=I(null),i=M(()=>r.value?es(r.value):!1),n=M(()=>ut(e,r.value)),l=()=>{o.push({name:"dashboard-sector-1c",query:{...e.query,diagnostics:"true"}}),typeof localStorage<"u"&&localStorage.setItem("dashboard-sector-1c-diagnostics","true");const x=tt();x&&x.reset(),t.loadSectorData(!1)},u=()=>{Be.invalidateTicketsCache(),Be.invalidateEmployeesCache(),Ta();const x=tt();x&&x.reset(),t.loadSectorData(!1)};Ae(async()=>{try{r.value=await rt.getCurrentUser()}catch(x){console.error("Error getting current user:",x),r.value=null}if(n.value){const x=tt();x&&x.reset()}t.loadSectorData()});const m=b_(),v=__(),T=`${mt.delayBetween}ms`,f=mt.fadeOutTransform,k=mt.fadeInTransform,p=()=>{t.loadSectorData(!1)},S=()=>{o.push({name:"dashboard-graph-state"})},C=()=>{o.push({name:"dashboard-graph-admission-closure"})},y=()=>{o.push({name:"dashboard-tickets-time-tracking"})},_=()=>{o.push("/")},A=t.loadingProgress,W=M(()=>typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-show-logger-control")==="true":!1);return{isLoading:s.isLoading,error:s.error,stages:s.stages,zeroPointTickets:s.zeroPointTickets,employees:s.employees,draggedTicket:s.draggedTicket,currentStep:A.currentStep,progress:A.progress,stepDetails:A.stepDetails,loadingProgress:A,loadSectorData:t.loadSectorData,handleTicketDragStart:t.handleTicketDragStart,handleTicketDrop:t.handleTicketDrop,assignTicketToEmployee:t.assignTicketToEmployee,moveTicketToStage:t.moveTicketToStage,createTicket:t.createTicket,getEmployeeTickets:s.getEmployeeTickets,showLoggerControl:W,handleRetry:p,isTransitioning:t.isTransitioning,preloaderFadeOutTransition:m,dashboardFadeInTransition:v,transitionDelay:T,preloaderFadeOutTransform:f,dashboardFadeInTransform:k,navigateToGraphState:S,navigateToAdmissionClosure:C,navigateToTimeTracking:y,handleGoHome:_,isDiagnosticsEnabled:n,enableDiagnostics:l,clearCache:u,isUserAdmin:i}}},la=()=>{lo(o=>({e25fa6d4:o.preloaderFadeOutTransition,v2de4400b:o.preloaderFadeOutTransform,v66f66a76:o.dashboardFadeInTransition,e224f3ee:o.transitionDelay,v171b9ffc:o.dashboardFadeInTransform}))},ca=js.setup;js.setup=ca?(o,e)=>(la(),ca(o,e)):la;const D_={class:"dashboard-header"},E_={class:"breadcrumbs-row"},A_={class:"header-actions"},$_={key:0,class:"dashboard-content"},I_={class:"stages-container"};function M_(o,e,s,t,r,i){const n=be("BackButton"),l=be("LoadingPreloader"),u=be("DashboardStage"),m=be("LoggerControl"),v=be("DiagnosticsPanel");return c(),d("div",{class:X(["dashboard-sector-1c",{"is-dragging":t.draggedTicket}])},[a("div",D_,[a("div",E_,[a("button",{class:"btn-home-link",type:"button",onClick:e[0]||(e[0]=(...T)=>t.handleGoHome&&t.handleGoHome(...T)),title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),e[6]||(e[6]=a("span",{class:"breadcrumb-separator"},"/",-1)),e[7]||(e[7]=a("span",{class:"breadcrumb-current"},"Дашборд сектора 1С",-1))]),ne(n,{variant:"header"}),e[13]||(e[13]=a("h1",null,"Дашборд - Сектор 1С",-1)),a("div",A_,[t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),d("button",{key:0,onClick:e[1]||(e[1]=(...T)=>t.clearCache&&t.clearCache(...T)),class:"btn-clear-cache",title:"Сбросить кеш сектора и тикетов"},[...e[8]||(e[8]=[a("span",{class:"icon"},"♻️",-1),a("span",null,"Сбросить кеш",-1)])])):$("",!0),!t.isDiagnosticsEnabled&&t.isUserAdmin?(c(),d("button",{key:1,onClick:e[2]||(e[2]=(...T)=>t.enableDiagnostics&&t.enableDiagnostics(...T)),class:"btn-enable-diagnostics",title:"Включить диагностический режим"},[...e[9]||(e[9]=[a("span",{class:"icon"},"🔍",-1),a("span",null,"Диагностика",-1)])])):$("",!0),a("button",{onClick:e[3]||(e[3]=(...T)=>t.navigateToGraphState&&t.navigateToGraphState(...T)),class:"btn-navigate-graph-state",title:"Перейти к графику состояния сектора"},[...e[10]||(e[10]=[a("span",{class:"icon"},"📊",-1),a("span",null,"График состояния",-1)])]),a("button",{onClick:e[4]||(e[4]=(...T)=>t.navigateToAdmissionClosure&&t.navigateToAdmissionClosure(...T)),class:"btn-navigate-admission-closure",title:"Перейти к графику приёма и закрытий сектора"},[...e[11]||(e[11]=[a("span",{class:"icon"},"📈",-1),a("span",null,"График приёма и закрытий",-1)])]),a("button",{onClick:e[5]||(e[5]=(...T)=>t.navigateToTimeTracking&&t.navigateToTimeTracking(...T)),class:"btn-navigate-time-tracking",title:"Перейти к трудозатратам на тикеты сектора"},[...e[12]||(e[12]=[a("span",{class:"icon"},"⏱",-1),a("span",null,"Трудозатраты",-1)])])])]),ne(Ee,{name:"preloader-fade"},{default:pe(()=>[t.isLoading||t.error||t.currentStep?(c(),he(l,{key:0,"current-step":t.currentStep,progress:t.progress,"step-details":t.stepDetails,error:t.error||null,onRetry:t.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):$("",!0)]),_:1}),ne(Ee,{name:"dashboard-fade"},{default:pe(()=>[!t.isLoading&&!t.error&&!t.currentStep?(c(),d("div",$_,[a("div",I_,[(c(!0),d(ee,null,te(t.stages,T=>(c(),he(u,{key:T.id,stage:T,"zero-point-tickets":t.zeroPointTickets[T.id]||[],onTicketMoved:t.handleTicketDrop,onTicketAssigned:t.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):$("",!0)]),_:1}),ne(n,{variant:"floating"}),ne(m,{"show-control":t.showLoggerControl},null,8,["show-control"]),ne(v,{"is-enabled":t.isDiagnosticsEnabled,"is-user-admin":t.isUserAdmin},null,8,["is-enabled","is-user-admin"])],2)}const Va=de(js,[["render",M_],["__scopeId","data-v-11e84363"]]),za=Object.freeze(Object.defineProperty({__proto__:null,default:Va},Symbol.toStringTag,{value:"Module"})),N_={name:"ModuleAdapter",props:{moduleConfig:{type:Object,required:!0,validator:o=>o.id&&o.title&&o.component},sectorId:{type:String,required:!0},isCompact:{type:Boolean,default:!0}},emits:["module-ready","module-error","module-navigate"],setup(o,{emit:e}){const s=Xe(),t=I(!1),r=I(null),i=I(null),n=I(null),l={SectorDashboard:Ia,TicketsTimeTrackingDashboard:xa,GraphStateDashboard:Ba,GraphAdmissionClosureDashboard:Ra,DashboardSector1C:Va},u=M(()=>{const S={isCompact:o.isCompact,sectorId:o.sectorId,moduleId:o.moduleConfig.id};switch(o.moduleConfig.component){case"SectorDashboard":return{sectorId:o.sectorId};case"DashboardSector1C":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphStateDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0,autoLoad:!1};case"TicketsTimeTrackingDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};case"GraphAdmissionClosureDashboard":return{...S,showBreadcrumbs:!1,compactMode:!0};default:return S}}),m=async()=>{try{t.value=!0,r.value=null;const S=o.moduleConfig.component;l[S]?(i.value=l[S],console.log(`[ModuleAdapter] ✅ Loading real component ${S} for module ${o.moduleConfig.id} in sector ${o.sectorId}`),console.log("[ModuleAdapter] Component loaded:",i.value)):(i.value="div",console.log(`[ModuleAdapter] ⚠️ Loading module ${o.moduleConfig.id} for sector ${o.sectorId} - using placeholder (component ${S} not found)`)),e("module-ready",{moduleId:o.moduleConfig.id,sectorId:o.sectorId})}catch(S){console.error(`Failed to load module ${o.moduleConfig.id}:`,S),r.value=S.message,e("module-error",{moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})}finally{t.value=!1}},v=()=>{o.moduleConfig.route?s.push(o.moduleConfig.route):console.warn(`No route defined for module ${o.moduleConfig.id}`)},T=()=>{m()},f=S=>{e("module-navigate",{type:"ready",moduleId:o.moduleConfig.id,sectorId:o.sectorId,data:S})},k=S=>{e("module-navigate",{type:"error",moduleId:o.moduleConfig.id,sectorId:o.sectorId,error:S})},p=S=>{e("module-navigate",{type:"navigate",moduleId:o.moduleConfig.id,sectorId:o.sectorId,navigation:S})};return Ae(()=>{m()}),{isLoading:t,error:r,moduleComponent:i,moduleInstance:n,moduleProps:u,openFullView:v,retryLoad:T,onModuleReady:f,onModuleError:k,onModuleNavigate:p}}},x_={class:"module-header"},P_={class:"module-icon"},L_={class:"module-info"},O_={class:"module-actions"},B_=["aria-label"],R_={class:"module-content"},W_={key:0,class:"module-loading"},U_={key:1,class:"module-error"},F_={key:2,class:"module-body"},H_={class:"module-placeholder"},j_={class:"placeholder-icon"};function V_(o,e,s,t,r,i){return c(),d("div",{class:X(["sector-module-adapter",`module-${s.moduleConfig.id}`])},[a("div",x_,[a("div",P_,g(s.moduleConfig.icon),1),a("div",L_,[a("h3",null,g(s.moduleConfig.title),1),a("p",null,g(s.moduleConfig.description),1)]),a("div",O_,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-module-fullscreen",title:"Открыть в полном размере","aria-label":`Открыть ${s.moduleConfig.title} в полном размере`}," ⛶ ",8,B_)])]),a("div",R_,[t.isLoading?(c(),d("div",W_,[e[3]||(e[3]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,"Загрузка "+g(s.moduleConfig.title)+"...",1)])):t.error?(c(),d("div",U_,[e[4]||(e[4]=a("div",{class:"error-icon"},"⚠️",-1)),e[5]||(e[5]=a("p",null,"Ошибка загрузки модуля",-1)),a("button",{onClick:e[1]||(e[1]=(...n)=>t.retryLoad&&t.retryLoad(...n)),class:"btn-retry"},"Повторить")])):(c(),d("div",F_,[a("div",H_,[a("div",j_,g(s.moduleConfig.icon),1),a("h4",null,g(s.moduleConfig.title),1),a("p",null,g(s.moduleConfig.description),1),e[6]||(e[6]=a("div",{class:"placeholder-status"},[a("span",{class:"status-badge"},"В разработке"),a("small",null,"Модуль готовится к интеграции")],-1)),a("button",{onClick:e[2]||(e[2]=(...n)=>t.openFullView&&t.openFullView(...n)),class:"btn-open-full"}," Открыть в полном размере ")])]))])],2)}const z_=de(N_,[["render",V_],["__scopeId","data-v-8cd78004"]]),G_={name:"SectorContainer",components:{ModuleAdapter:z_},props:{sectorConfig:{type:Object,required:!0,validator:o=>o.id&&o.name&&o.icon}},emits:["module-ready","module-error","module-event","sector-expanded","sector-collapsed"],setup(o,{emit:e}){Xe();const s=I(!1),t=I(!1),r=I([]),i=M(()=>o.sectorConfig.modules&&o.sectorConfig.modules.length>0),n=M(()=>!1);Ae(async()=>{i.value&&await l()});const l=async()=>{t.value=!0;try{r.value=o.sectorConfig.modules||[],e("module-ready",{sectorId:o.sectorConfig.id,modulesCount:r.value.length})}catch(k){console.error(`Failed to load modules for sector ${o.sectorConfig.id}:`,k),e("module-error",{sectorId:o.sectorConfig.id,error:k.message})}finally{t.value=!1}};return{expanded:s,loading:t,sectorModules:r,hasModules:i,canNavigateToDashboard:n,toggleExpanded:()=>{s.value=!s.value,s.value?e("sector-expanded",{sectorId:o.sectorConfig.id}):e("sector-collapsed",{sectorId:o.sectorConfig.id})},onModuleReady:k=>{e("module-ready",{sectorId:o.sectorConfig.id,moduleId:k.moduleId,data:k})},onModuleError:k=>{e("module-error",{sectorId:o.sectorConfig.id,moduleId:k.moduleId,error:k.error})},onModuleNavigate:k=>{e("module-event",{sectorId:o.sectorConfig.id,moduleId:k.moduleId,event:k})},navigateToSectorDashboard:()=>{console.log(`Navigate to dashboard for sector: ${o.sectorConfig.id}`)}}}},K_={class:"sector-header"},q_={class:"sector-header-left"},Y_={class:"sector-icon"},X_={class:"sector-title"},J_={class:"sector-actions"},Z_={key:0,class:"sector-content"},Q_={key:0,class:"sector-loading"},ew={key:1,class:"sector-modules-grid"},tw={key:2,class:"no-modules"},sw={key:3,class:"sector-dashboard-link"};function aw(o,e,s,t,r,i){const n=be("ModuleAdapter");return c(),d("div",{class:X(["sector-container",`sector-${s.sectorConfig.id}`])},[a("div",K_,[a("div",q_,[a("div",Y_,g(s.sectorConfig.icon),1),a("div",X_,[a("h2",null,g(s.sectorConfig.name),1),a("p",null,g(s.sectorConfig.description),1)])]),a("div",J_,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.toggleExpanded&&t.toggleExpanded(...l)),class:"btn-toggle-sector"},g(t.expanded?"Свернуть":"Развернуть"),1)])]),t.expanded?(c(),d("div",Z_,[t.loading?(c(),d("div",Q_,[e[3]||(e[3]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,"Загрузка сектора "+g(s.sectorConfig.name)+"...",1)])):t.sectorModules.length>0?(c(),d("div",ew,[(c(!0),d(ee,null,te(t.sectorModules,l=>(c(),he(n,{key:l.id,"module-config":l,"sector-id":s.sectorConfig.id,"is-compact":!0,onModuleReady:t.onModuleReady,onModuleError:t.onModuleError,onModuleNavigate:t.onModuleNavigate},null,8,["module-config","sector-id","onModuleReady","onModuleError","onModuleNavigate"]))),128))])):(c(),d("div",tw,[a("p",null,'Модули для сектора "'+g(s.sectorConfig.name)+'" находятся в разработке',1),t.canNavigateToDashboard?(c(),d("button",{key:0,onClick:e[1]||(e[1]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[4]||(e[4]=[a("span",{class:"icon"},"📊",-1),ce(" Открыть полный дашборд сектора ",-1)])])):$("",!0)])),t.sectorModules.length>0&&t.canNavigateToDashboard?(c(),d("div",sw,[a("button",{onClick:e[2]||(e[2]=(...l)=>t.navigateToSectorDashboard&&t.navigateToSectorDashboard(...l)),class:"btn-sector-dashboard"},[...e[5]||(e[5]=[a("span",{class:"icon"},"📊",-1),ce(" Открыть полный дашборд сектора ",-1)])])])):$("",!0)])):$("",!0)],2)}const ow=de(G_,[["render",aw],["__scopeId","data-v-0fa90bab"]]);class is{static async logAppEntry(e,s=null){if(!e||!e.ID)return console.warn("[ActivityLoggingService] Invalid user object for app entry logging"),!1;const t={timestamp:new Date().toISOString(),type:"app_entry",user_id:e.ID,user_name:this.getUserName(e),user_email:e.EMAIL||null,ip:s||this.getClientIp(),user_agent:navigator.userAgent,session_id:this.getSessionId()};return await this.saveLog(t)}static async logPageVisit(e,s,t=null){if(!s||!s.ID)return console.warn("[ActivityLoggingService] Invalid user object for page visit logging"),!1;if(!e||!e.path)return console.warn("[ActivityLoggingService] Invalid route object for page visit logging"),!1;const r={timestamp:new Date().toISOString(),type:"page_visit",user_id:s.ID,user_name:this.getUserName(s),route_path:e.path,route_name:e.name||null,route_title:e.meta?.title||null,from_path:t?.path||null,from_name:t?.name||null,session_id:this.getSessionId()};return await this.saveLog(r)}static async saveLog(e){try{const s=et("/api/user-activity-log.php"),t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e),signal:AbortSignal.timeout(5e3)});if(!t.ok){const i=await t.text();return console.error("[ActivityLoggingService] Failed to save log:",{status:t.status,statusText:t.statusText,error:i}),!1}const r=await t.json();return r.success?!0:(console.error("[ActivityLoggingService] API returned error:",r.error),!1)}catch(s){return s.name==="AbortError"?console.warn("[ActivityLoggingService] Request timeout (activity logging skipped)"):console.error("[ActivityLoggingService] Error saving log:",s),!1}}static getSessionId(){const e="activity_session_id";if(sessionStorage.getItem(e))return sessionStorage.getItem(e);const s=this.generateSessionId();return sessionStorage.setItem(e,s),s}static generateSessionId(){const e=Date.now(),s=Math.random().toString(36).substring(2,11);return`${e}-${s}`}static getUserName(e){const s=e.NAME||"",t=e.LAST_NAME||"";return`${s} ${t}`.trim()||e.EMAIL||`User #${e.ID}`}static getClientIp(){return null}static isAppEntryLogged(){return sessionStorage.getItem("app_entry_logged")==="true"}static markAppEntryLogged(){sessionStorage.setItem("app_entry_logged","true")}}const nw={reports:[{id:1,title:"Отчёт по тикетам",icon:"📊",route:"/reports/tickets",description:"Статистика по тикетам и обращениям",active:!1},{id:2,title:"Отчёт по производительности",icon:"📈",route:"/reports/performance",description:"Анализ производительности работы отдела",active:!1},{id:3,title:"Отчёт по срокам",icon:"📉",route:"/reports/deadlines",description:"Анализ соблюдения сроков выполнения задач",active:!1},{id:4,title:"Сводный отчёт",icon:"📋",route:"/reports/summary",description:"Общая сводка по всем показателям",active:!1},{id:5,title:"Дашборд сектора 1С",icon:"📋",route:"/dashboard/sector-1c",description:"Управление тикетами сектора 1С",active:!0},{id:6,title:"График состояния",icon:"📊",route:"/dashboard/graph-state",description:"Визуализация изменений состояния сектора 1С во времени",active:!0,category:"analytics",order:6},{id:7,title:"График приёма/закрытий 1С",icon:"📈",route:"/dashboard/graph-admission-closure",description:"Недельные новые и закрытые тикеты сектора 1С",active:!0,category:"analytics",order:7},{id:8,title:"Трудозатраты на Тикеты сектора 1С",icon:"⏱",route:"/dashboard/tickets-time-tracking",description:"Трудозатраты сотрудников сектора 1С по неделям",active:!0,category:"analytics",order:8}]};function rw(){return nw.reports.filter(o=>o.active===!0)}const iw={adminInterfaces:[{id:1,title:"Управление пользователями",icon:"👥",route:"/admin/users",description:"Управление доступом пользователей к приложению"},{id:2,title:"Настройки системы",icon:"⚙️",route:"/admin/settings",description:"Конфигурация системы и параметров приложения"},{id:3,title:"Логи вебхуков",icon:"📋",route:"/admin/webhook-logs",description:"Просмотр и анализ логов вебхуков"},{id:4,title:"Статистика использования",icon:"📊",route:"/admin/usage-stats",description:"Аналитика использования приложения"},{id:5,title:"Ручное управление кешем",icon:"🗑️",route:"/admin/cache",description:"Управление кешем модулей приложения"}]};function lw(){return[...iw.adminInterfaces]}const Gt={sector1c:{id:"1c",name:"Сектор 1С",description:"Модули для работы с системами 1С:Предприятие",icon:"⚙️",color:"#007bff",borderColor:"#0056b3",backgroundColor:"#f8f9fa",filterValue:"1C",modules:[{id:"dashboard-sector-1c",title:"Дашборд сектора 1С",description:"Панель управления сектором 1С с основными метриками",icon:"⚙️",component:"SectorDashboard",route:"/dashboard/sector-1c",category:"management"},{id:"tickets-management-sector-1c",title:"Управление тикетами сектора 1С",description:"Управление заявками и задачами сектора 1С",icon:"📋",component:"TicketsTimeTrackingDashboard",route:"/tickets/time-tracking",category:"tickets"},{id:"state-chart",title:"График состояния",description:"Визуализация текущего состояния систем сектора 1С",icon:"📊",component:"GraphStateDashboard",route:"/graph/state",category:"analytics"},{id:"changes-visualization",title:"Визуализация изменений сост",description:"Отображение изменений состояния в секторе 1С",icon:"📈",component:"GraphAdmissionClosureDashboard",route:"/graph/admission-closure",category:"analytics"}],features:["smart-process-140","1c-integration"],order:1},sectorPdm:{id:"pdm",name:"Сектор PDM",description:"Управление системами PDM (Product Data Management)",icon:"🔧",color:"#28a745",borderColor:"#1e7e34",backgroundColor:"#f8fff8",filterValue:"PDM",modules:[{id:"dashboard-sector-pdm",title:"Дашборд сектора PDM",description:"Панель управления сектором PDM с основными метриками",icon:"🔧",component:"SectorDashboard",route:"/dashboard/sector-pdm",category:"management"}],features:["pdm-integration"],order:2},sectorBitrix24:{id:"bitrix24",name:"Сектор Битрикс24",description:"Управление и поддержка Битрикс24",icon:"🌐",color:"#ffc107",borderColor:"#d39e00",backgroundColor:"#fffef8",filterValue:"Bitrix24",modules:[{id:"dashboard-sector-bitrix24",title:"Дашборд сектора Битрикс24",description:"Панель управления сектором Битрикс24 с основными метриками",icon:"🌐",component:"SectorDashboard",route:"/dashboard/sector-bitrix24",category:"management"}],features:["bitrix24-integration"],order:3},sectorInfrastructure:{id:"infrastructure",name:"Сектор Железо/Инфраструктура",description:"Управление инфраструктурой, оборудованием и прочими задачами",icon:"🖥️",color:"#dc3545",borderColor:"#bd2130",backgroundColor:"#fff8f8",filterValues:["Железо","Прочее"],modules:[{id:"dashboard-sector-infrastructure",title:"Дашборд сектора Инфраструктура",description:"Панель управления сектором Инфраструктура с основными метриками",icon:"🖥️",component:"SectorDashboard",route:"/dashboard/sector-infrastructure",category:"management"}],features:["infrastructure-management"],order:4}};class cw{static getAllSectors(){return Object.values(Gt).sort((e,s)=>(e.order||0)-(s.order||0))}static getSectorById(e){return Gt[e]||null}static getSectorsWithModules(){return this.getAllSectors().filter(e=>e.modules&&e.modules.length>0)}static getSectorColors(){const e={};return Object.values(Gt).forEach(s=>{e[s.id]=s.color}),e}static sectorExists(e){return Object.values(Gt).some(s=>s.id===e)}static getNextOrder(){return Math.max(...Object.values(Gt).map(s=>s.order||0))+1}}const dw={name:"IndexPage",components:{StatusMessage:ks,LoadingSpinner:bs,SectorContainer:ow},beforeCreate(){console.log("[IndexPage] beforeCreate() called")},created(){console.log("[IndexPage] created() called")},beforeMount(){console.log("[IndexPage] beforeMount() called")},setup(){console.log("[IndexPage] setup() called");const o=Xe(),e=I(!0),s=I(null),t=I(!1),r=I(!1),i=I(""),n=I(null),l=I(null),u=I(!1);console.log("[IndexPage] Initial state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value});const m=I(rw()),v=I(cw.getAllSectors()),T=I(!1),f=I(lw()),k=M(()=>n.value?es(n.value):!1),p=M(()=>{if(!n.value)return"Пользователь";const U=n.value.FIRST_NAME?n.value.FIRST_NAME.trim():"",G=n.value.LAST_NAME?n.value.LAST_NAME.trim():"",q=n.value.NAME?n.value.NAME.trim():"";return U&&G?`${U} ${G}`:q&&G&&q!==G?`${q} ${G}`:U&&q&&U!==q?`${U} ${q}`:q&&q.includes(" ")?q:U||G||q||`Пользователь #${n.value.ID}`}),S=M(()=>s.value?s.value.includes("no_install_app")?"Приложение не установлено":"Ошибка API":null),C=M(()=>s.value?s.value.includes("no_install_app")?"Приложение не установлено в Bitrix24. Необходимо выполнить установку.":s.value:null),y=M(()=>s.value&&s.value.includes("no_install_app")),_=M(()=>ka("/install.php"));Ae(async()=>{console.log("[IndexPage] onMounted() called");try{console.log("[IndexPage] Calling AccessControlService.checkAccess()...");const U=await rt.checkAccess();if(console.log("[IndexPage] Access result:",{allowed:U.allowed,hasUser:!!U.user,user:U.user,errorCode:U.errorCode,errorMessage:U.errorMessage}),U.allowed){if(console.log("[IndexPage] Setting accessAllowed to true"),t.value=!0,n.value=U.user,console.log("[IndexPage] Access allowed, setting state:",{accessAllowed:t.value,hasUser:!!n.value,loading:e.value,accessDenied:r.value}),!is.isAppEntryLogged())try{U.user&&await is.logAppEntry(U.user)&&is.markAppEntryLogged()}catch(G){console.error("[IndexPage] Error logging app entry:",G)}}else{r.value=!0;const G=Ot(),q=!G&&U.errorCode===nt.ACCESS_DENIED&&U.errorMessage&&U.errorMessage.includes("Прямой доступ");if(console.log("IndexPage - accessResult:",{errorCode:U.errorCode,errorMessage:U.errorMessage,isInsideB24:G,isDirectAccessDeniedCheck:q}),u.value=q,q&&(i.value=U.errorMessage,console.log("IndexPage - Set direct access denied message:",U.errorMessage)),console.log("IndexPage - State after check:",{accessDenied:r.value,isDirectAccessDenied:u.value,accessErrorMessage:i.value}),!q){if(U.user){const{getAllowedDepartmentIds:oe}=await De(async()=>{const{getAllowedDepartmentIds:Y}=await import("./access-config-async-gqR6Vfk8.js");return{getAllowedDepartmentIds:Y}},__vite__mapDeps([6,7,4,2,3,0,1]),import.meta.url);l.value={userId:U.user.ID,departmentIds:U.user.UF_DEPARTMENT||[],allowedIds:oe()}}U.errorCode===nt.USER_NOT_DETERMINED?i.value="Не удалось определить пользователя. Обратитесь в Поддержку приложения в ИТ отдел.":U.errorCode===nt.ACCESS_DENIED?i.value="Доступ запрещён":i.value=U.errorMessage||"Ошибка при проверке доступа. Обратитесь в Поддержку приложения в ИТ отдел."}}}catch(U){s.value=U.message,console.error("Error checking access:",U)}finally{e.value=!1,console.log("[IndexPage] Final state:",{loading:e.value,accessAllowed:t.value,accessDenied:r.value,hasUser:!!n.value,error:s.value})}});const A=U=>{if(!U){console.error("Route is not defined for report");return}o.push(U)},W=()=>{T.value=!0},x=()=>{T.value=!1};return{loading:e,error:s,accessAllowed:t,accessDenied:r,accessErrorMessage:i,currentUser:n,userName:p,debugInfo:l,isDirectAccessDenied:u,errorTitle:S,errorMessage:C,showInstallLink:y,installPageUrl:_,reportsButtons:m,navigateToReport:A,sectors:v,handleModuleEvent:U=>{console.log("Module event:",U)},handleSectorExpanded:U=>{console.log("Sector expanded:",U.sectorId)},handleSectorCollapsed:U=>{console.log("Sector collapsed:",U.sectorId)},isAdmin:k,showAdminPopup:T,adminButtons:f,openAdminPopup:W,closeAdminPopup:x,navigateToAdmin:U=>{if(!U){console.error("Route is not defined for admin interface");return}o.push(U),x()}}}},uw={class:"index-page"},mw={class:"container"},gw={key:0,class:"install-link"},hw=["href"],fw={key:0,class:"direct-access-denied-info",style:{"margin-top":"15px",padding:"15px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px"}},vw={key:1,class:"debug-info",style:{"margin-top":"15px",padding:"10px",background:"#fff3cd",border:"1px solid #ffc107","border-radius":"4px","font-size":"12px"}},pw={key:3,class:"main-content"},yw={class:"greeting-section"},kw={class:"greeting-header"},bw={class:"greeting-header-content"},_w={class:"greeting-text"},ww={class:"sectors-section"},Cw={class:"admin-popup-header"},Tw={class:"admin-popup-content"},Sw={class:"admin-buttons-grid"},Dw=["onClick"],Ew={class:"admin-icon"},Aw={class:"admin-title"},$w={key:0,class:"admin-description"};function Iw(o,e,s,t,r,i){const n=be("StatusMessage"),l=be("LoadingSpinner"),u=be("SectorContainer");return c(),d("div",uw,[a("div",mw,[t.error?(c(),he(n,{key:0,type:"error",title:t.errorTitle,message:t.errorMessage},{default:pe(()=>[t.showInstallLink?(c(),d("div",gw,[a("a",{href:t.installPageUrl},"Установить приложение",8,hw)])):$("",!0)]),_:1},8,["title","message"])):$("",!0),t.loading?(c(),he(l,{key:1,message:"Проверка доступа..."})):$("",!0),!t.loading&&t.accessDenied?(c(),he(n,{key:2,type:"error",title:"Доступ запрещён",message:t.accessErrorMessage},{default:pe(()=>[t.isDirectAccessDenied?(c(),d("div",fw,[...e[4]||(e[4]=[a("p",{style:{margin:"0 0 10px 0","font-weight":"600",color:"#856404"}},[a("strong",null,"Как открыть приложение:")],-1),a("ol",{style:{margin:"0","padding-left":"20px",color:"#856404"}},[a("li",null,"Войдите в Bitrix24"),a("li",null,"Откройте приложение через интерфейс Bitrix24 (placement, виджет или вкладку)")],-1)])])):t.debugInfo?(c(),d("div",vw,[e[5]||(e[5]=a("strong",null,"Отладочная информация:",-1)),e[6]||(e[6]=a("br",null,null,-1)),ce(" ID пользователя: "+g(t.debugInfo.userId),1),e[7]||(e[7]=a("br",null,null,-1)),ce(" ID отделов пользователя: "+g(t.debugInfo.departmentIds),1),e[8]||(e[8]=a("br",null,null,-1)),ce(" Разрешённые ID отделов: "+g(t.debugInfo.allowedIds),1),e[9]||(e[9]=a("br",null,null,-1)),e[10]||(e[10]=a("small",{style:{color:"#856404"}},"Добавьте ID отдела в файл vue-app/src/config/access-config.js",-1))])):$("",!0)]),_:1},8,["message"])):$("",!0),!t.loading&&!t.accessDenied&&t.accessAllowed?(c(),d("div",pw,[a("div",yw,[a("div",kw,[a("div",bw,[e[13]||(e[13]=a("h2",{class:"greeting-title"},"Страница Аналитики ИТ отдела для Планерки Генеральной дирекции",-1)),a("p",_w,[e[11]||(e[11]=ce(" Добро пожаловать, ",-1)),a("strong",null,g(t.userName),1),e[12]||(e[12]=ce("! ",-1))])]),t.isAdmin?(c(),d("button",{key:0,class:"admin-button-header",onClick:e[0]||(e[0]=(...m)=>t.openAdminPopup&&t.openAdminPopup(...m)),title:"Администрирование"}," ⚙️ ")):$("",!0)])]),a("div",ww,[(c(!0),d(ee,null,te(t.sectors,m=>(c(),he(u,{key:m.id,"sector-config":m,onModuleEvent:t.handleModuleEvent,onSectorExpanded:t.handleSectorExpanded,onSectorCollapsed:t.handleSectorCollapsed},null,8,["sector-config","onModuleEvent","onSectorExpanded","onSectorCollapsed"]))),128))]),t.showAdminPopup&&t.isAdmin?(c(),d("div",{key:0,class:"admin-popup-overlay",onClick:e[3]||(e[3]=(...m)=>t.closeAdminPopup&&t.closeAdminPopup(...m))},[a("div",{class:"admin-popup",onClick:e[2]||(e[2]=Ce(()=>{},["stop"]))},[a("div",Cw,[e[14]||(e[14]=a("h3",{class:"admin-popup-title"},"⚙️ Администрирование",-1)),a("button",{class:"admin-popup-close",onClick:e[1]||(e[1]=(...m)=>t.closeAdminPopup&&t.closeAdminPopup(...m))}," ✕ ")]),a("div",Tw,[a("div",Sw,[(c(!0),d(ee,null,te(t.adminButtons,m=>(c(),d("div",{key:m.id,class:"admin-interface-button",onClick:v=>t.navigateToAdmin(m.route)},[a("div",Ew,g(m.icon),1),a("div",Aw,g(m.title),1),m.description?(c(),d("div",$w,g(m.description),1)):$("",!0)],8,Dw))),128))])])])])):$("",!0)])):$("",!0)])])}const Mw=de(dw,[["render",Iw],["__scopeId","data-v-12137466"]]),Ze=I(new Map),at=I({hits:0,misses:0,sets:0,invalidations:0}),Is={defaultTTL:5*60*1e3,maxSize:100,enableStats:!0};function Nw(o={}){const{ttl:e=Is.defaultTTL,maxSize:s=Is.maxSize,enableStats:t=Is.enableStats}=o,r=C=>{const y=new WeakSet;return JSON.stringify(C,(_,A)=>{if(typeof A=="object"&&A!==null){if(y.has(A))return"[Circular]";y.add(A)}return typeof A=="function"||A===void 0?null:A})},i=(C,y={})=>{const _=Object.keys(y).sort().reduce((A,W)=>{const x=y[W];if(x==null)A[W]=null;else if(typeof x=="object")try{A[W]=r(x)}catch{A[W]=String(x)}else A[W]=x;return A},{});try{return`${C}_${r(_)}`}catch{const W=Object.keys(_).sort().map(x=>`${x}=${_[x]}`).join("&");return`${C}_${W}`}},n=C=>{const y=Ze.value.get(C);return y?Date.now()-y.timestamp>y.ttl?(Ze.value.delete(C),t&&at.value.misses++,null):(y.lastAccessed=Date.now(),t&&at.value.hits++,y.data):(t&&at.value.misses++,null)},l=(C,y,_=null)=>{Ze.value.size>=s&&u(),Ze.value.set(C,{data:y,timestamp:Date.now(),lastAccessed:Date.now(),ttl:_||e}),t&&at.value.sets++},u=()=>{let C=null,y=1/0;for(const[_,A]of Ze.value.entries())A.lastAccessed<y&&(y=A.lastAccessed,C=_);C&&Ze.value.delete(C)},m=()=>{Ze.value.clear(),t&&(at.value={hits:0,misses:0,sets:0,invalidations:0})},v=C=>{const y=typeof C=="string"?new RegExp(C):C;let _=0;for(const A of Ze.value.keys())y.test(A)&&(Ze.value.delete(A),_++);return t&&(at.value.invalidations+=_),_},T=()=>{const C=Date.now();let y=0;for(const[_,A]of Ze.value.entries())C-A.timestamp>A.ttl&&(Ze.value.delete(_),y++);return y},f=()=>{const C=at.value.hits+at.value.misses,y=C>0?(at.value.hits/C*100).toFixed(2):0;return{...at.value,size:Ze.value.size,hitRate:`${y}%`}};let k=null;const p=(C=5*60*1e3)=>{k&&clearInterval(k),k=setInterval(()=>{T()},C)},S=()=>{k&&(clearInterval(k),k=null)};return p(),{get:n,set:l,clear:m,invalidate:v,cleanup:T,getCacheKey:i,getStats:f,startAutoCleanup:p,stopAutoCleanup:S}}function gt(o){if(!o||typeof o!="object"||!o.timestamp||typeof o.timestamp!="string"||!o.event||typeof o.event!="string"||!o.category||typeof o.category!="string"||!["tasks","smart-processes","errors"].includes(o.category))return!1;try{new Date(o.timestamp)}catch{return!1}return!0}function xw(o){if(!o||typeof o!="object")return!1;for(const[e,s]of Object.entries(o))if(typeof s=="function")return!1;return!0}function Ht(o){if(!gt(o))return null;const e={timestamp:o.timestamp,event:o.event,category:o.category};return o.ip&&typeof o.ip=="string"&&(e.ip=o.ip),o.payload&&typeof o.payload=="object"&&(e.payload=o.payload),o.details&&xw(o.details)&&(e.details=o.details),e}function Vs(o){return Array.isArray(o)?o.map(e=>Ht(e)).filter(e=>e!==null):[]}const{get:Pw,set:Lw,getCacheKey:Ow,invalidate:da}=Nw({ttl:2*60*1e3,maxSize:50});class ua{static getBaseUrl(){return et("/api/webhook-logs.php")}static get BASE_URL(){return this.getBaseUrl()}static async getLogs(e={},s=1,t=50,r=!1){if(s<1)throw new Error("Page must be greater than 0");if(t<1||t>1e3)throw new Error("Limit must be between 1 and 1000");const i={category:e.category||null,event:e.event||null,date:e.date||null,hour:e.hour!==void 0?e.hour:null,dateFrom:e.dateFrom||null,dateTo:e.dateTo||null,ip:e.ip||null,status:e.status||null},n=this.getBaseUrl(),l=Ow(n,{filters:i,page:s,limit:t});if(!r){const m=Pw(l);if(m)return console.log("[WebhookLogsApiService] Cache hit:",l.substring(0,50)+"..."),m}console.log("[WebhookLogsApiService] Cache miss:",l.substring(0,50)+"...");const u=new URLSearchParams({page:s.toString(),limit:t.toString()});i.category&&u.append("category",i.category),i.event&&u.append("event",i.event),i.date&&u.append("date",i.date),i.hour!==null&&u.append("hour",i.hour.toString()),i.dateFrom&&u.append("dateFrom",i.dateFrom),i.dateTo&&u.append("dateTo",i.dateTo),i.ip&&u.append("ip",i.ip),i.status&&u.append("status",i.status);try{const m=this.getBaseUrl(),v=await fetch(`${m}?${u.toString()}`);if(!v.ok){const p=await v.text();let S;try{S=JSON.parse(p)}catch{S={error:p}}throw new Error(S.error_description||S.error||`HTTP error! status: ${v.status}`)}const T=await v.json();if(console.log("[WebhookLogsApiService] API response:",{success:T.success,logsCount:T.logs?.length||0,pagination:T.pagination,hasError:!!T.error}),T.error)throw new Error(T.error_description||T.error);if(!T.success)throw console.warn("[WebhookLogsApiService] API returned success=false:",T),new Error("API request failed");if(!Array.isArray(T.logs))throw console.error("[WebhookLogsApiService] Invalid logs format:",T.logs),new Error("Invalid logs format: expected array");const f=Vs(T.logs);(!T.pagination||typeof T.pagination!="object")&&(console.warn("[WebhookLogsApiService] Invalid pagination format:",T.pagination),T.pagination={page:s,limit:t,total:f.length,pages:Math.ceil(f.length/t)});const k={success:!0,logs:f,pagination:{page:T.pagination.page||s,limit:T.pagination.limit||t,total:T.pagination.total||f.length,pages:T.pagination.pages||Math.ceil((T.pagination.total||f.length)/t)}};return Lw(l,k),k}catch(m){throw console.error("[WebhookLogsApiService] Error:",m),m}}static invalidateCacheOnFilterChange(e={},s={}){const t=da(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Invalidated ${t} entries on filter change`)}static clearCache(){const e=da(/^\/api\/webhook-logs\.php/);console.log(`[WebhookLogsApiService] Cleared ${e} entries`)}static async getLogDetails(e,s=null){const t={};return s&&(t.date=s),(await this.getLogs(t,1,1e3)).logs.find(n=>`${n.timestamp}_${n.event}`===e)||null}static async getErrors(e={},s=1,t=50){return this.getLogs({...e,category:"errors"},s,t)}static async getStats(e={}){const s=await this.getLogs(e,1,1e3),t={total:s.pagination.total||s.logs.length,tasks:0,smartProcesses:0,errors:0,byEvent:{},byDate:{}};return s.logs.forEach(r=>{r.category==="tasks"?t.tasks++:r.category==="smart-processes"?t.smartProcesses++:r.category==="errors"&&t.errors++,t.byEvent[r.event]||(t.byEvent[r.event]=0),t.byEvent[r.event]++;const i=r.timestamp.split("T")[0];t.byDate[i]||(t.byDate[i]=0),t.byDate[i]++}),t}}function Bw(){const o=ps(),e=Xe(),s=new Date().toISOString().split("T")[0],t=I({category:null,event:null,dateFrom:s,dateTo:null,hour:null,ip:null,search:null,status:null}),r=()=>{const m=o.query;t.value={category:m.category||null,event:m.event||null,dateFrom:m.dateFrom||m.date||s,dateTo:m.dateTo||null,hour:m.hour?parseInt(m.hour):null,ip:m.ip||null,search:m.search||null,status:m.status||null}},i=m=>{if(u)return;const v={...o.query};Object.keys(m).forEach(f=>{const k=m[f];k!==null&&k!==""&&k!==void 0?v[f]=k.toString():delete v[f]}),JSON.stringify(v)!==JSON.stringify(o.query)&&(u=!0,e.replace({path:o.path,query:v}).finally(()=>{setTimeout(()=>{u=!1},100)}))},n=m=>{const v={...t.value,...m};JSON.stringify(t.value)!==JSON.stringify(v)&&(t.value=v,i(t.value))},l=()=>{t.value={category:null,event:null,dateFrom:s,dateTo:null,hour:null,ip:null,search:null,status:null},i(t.value)};Ae(()=>{r()});let u=!1;return Me(()=>o.query,(m,v)=>{if(u)return;JSON.stringify(m)!==JSON.stringify(v)&&r()},{deep:!0}),{filters:t,updateFilters:n,clearFilters:l,loadFiltersFromUrl:r}}function Rw(o,e,s={}){if(!e||!e.trim())return o;const{caseSensitive:t=!1,searchInEvent:r=!0,searchInPayload:i=!0,searchInDetails:n=!0,searchInIp:l=!0,searchInTimestamp:u=!1}=s,m=t?e.trim():e.trim().toLowerCase();return o.filter(v=>{if(r&&v.event&&(t?v.event:v.event.toLowerCase()).includes(m))return!0;if(i&&v.payload)try{const T=JSON.stringify(v.payload);if((t?T:T.toLowerCase()).includes(m))return!0}catch(T){console.warn("Error searching in payload:",T)}if(n&&v.details)try{const T=JSON.stringify(v.details);if((t?T:T.toLowerCase()).includes(m))return!0}catch(T){console.warn("Error searching in details:",T)}return!!(l&&v.ip&&(t?v.ip:v.ip.toLowerCase()).includes(m)||u&&v.timestamp&&(t?v.timestamp:v.timestamp.toLowerCase()).includes(m))})}function Ps(o){if(!o||typeof o!="object"||o.category!==void 0&&o.category!==null&&!["tasks","smart-processes","errors"].includes(o.category)||o.date!==void 0&&o.date!==null&&!/^\d{4}-\d{2}-\d{2}$/.test(o.date))return!1;if(o.hour!==void 0&&o.hour!==null){const e=parseInt(o.hour,10);if(isNaN(e)||e<0||e>23)return!1}return!(o.ip!==void 0&&o.ip!==null&&(typeof o.ip!="string"||o.ip.length===0))}function Ww(o){if(!o||typeof o!="object")return!1;const e=parseInt(o.page,10),s=parseInt(o.limit,10),t=parseInt(o.total,10),r=parseInt(o.pages,10);return!(isNaN(e)||e<1||isNaN(s)||s<1||s>1e3||isNaN(t)||t<0||isNaN(r)||r<0)}function ma(o){if(o==null)return"";const e=String(o),s=e.replace(/"/g,'""');return e.includes(",")||e.includes(`
`)||e.includes('"')?`"${s}"`:s}function Uw(o){return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}function Fw(o,e="webhook-logs.csv",s={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{columns:i=null,onProgress:n=null}=s,l=i||Object.keys(o[0]),m=[l.map(p=>ma(p)).join(",")],v=o.length,T=1e3;for(let p=0;p<v;p+=T){const S=o.slice(p,p+T);if(S.forEach(C=>{const y=l.map(_=>{const A=C[_];return ma(Uw(A))});m.push(y.join(","))}),n){const C=Math.min(100,Math.round((p+S.length)/v*100));n(C)}}const f="\uFEFF"+m.join(`
`),k=new Blob([f],{type:"text/csv;charset=utf-8;"});Ga(k,e),n&&n(100),t()}catch(i){r(i)}})}function Hw(o,e="webhook-logs.json",s={}){return new Promise((t,r)=>{try{if(!Array.isArray(o)||o.length===0)throw new Error("Нет данных для экспорта");const{pretty:i=!0,onProgress:n=null}=s,l=i?JSON.stringify(o,null,2):JSON.stringify(o);n&&n(50);const u=new Blob([l],{type:"application/json;charset=utf-8;"});Ga(u,e),n&&n(100),t()}catch(i){r(i)}})}function Ga(o,e){const s=URL.createObjectURL(o),t=document.createElement("a");t.href=s,t.download=e,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t),URL.revokeObjectURL(s)},100)}function jw(o,e={},s=0){const t=new Date().toISOString().split("T")[0],r=new Date().toTimeString().split(" ")[0].replace(/:/g,"-");let i=`webhook-logs_${t}_${r}`;const n=[];return e.category&&n.push(`cat-${e.category}`),e.event&&n.push(`evt-${e.event.substring(0,10)}`),e.dateFrom&&n.push(`from-${e.dateFrom}`),e.dateTo&&n.push(`to-${e.dateTo}`),n.length>0&&(i+=`_${n.join("-")}`),s>0&&(i+=`_${s}records`),`${i}.${o}`}function Vw(o){const e=[];if(!Array.isArray(o))return e.push("Данные должны быть массивом"),{valid:!1,errors:e,estimatedSize:0};if(o.length===0)return e.push("Нет данных для экспорта"),{valid:!1,errors:e,estimatedSize:0};const s=JSON.stringify(o).length,t=50*1024*1024;return s>t&&e.push(`Большой объём данных (${Math.round(s/1024/1024)} MB). Экспорт может занять время.`),{valid:e.length===0,errors:e,estimatedSize:s}}function zs(o,e="short"){if(!o)return"—";try{const s=new Date(o);if(isNaN(s.getTime()))return"Invalid date";switch(e){case"short":return s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});case"long":return s.toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});case"relative":return zw(s);default:return s.toLocaleString("ru-RU")}}catch{return"Invalid date"}}function zw(o){const s=new Date-o,t=Math.floor(s/1e3),r=Math.floor(t/60),i=Math.floor(r/60),n=Math.floor(i/24);return t<60?"только что":r<60?`${r} ${Ms(r,"минуту","минуты","минут")} назад`:i<24?`${i} ${Ms(i,"час","часа","часов")} назад`:n<7?`${n} ${Ms(n,"день","дня","дней")} назад`:zs(o.toISOString(),"short")}function Ms(o,e,s,t){const r=o%10,i=o%100;return r===1&&i!==11?e:r>=2&&r<=4&&(i<10||i>=20)?s:t}function jt(o){return o?o.replace(/^ON/,"").split(/(?=[A-Z])/).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):"—"}function bt(o){return{tasks:"Задачи","smart-processes":"Смарт-процессы",errors:"Ошибки"}[o]||o}function Gs(o){if(!o||typeof o!="object")return"—";const e=[];if(o.task_id&&e.push(`Задача #${o.task_id}`),o.entity_id&&e.push(`Сущность #${o.entity_id}`),o.task_title&&e.push(`"${o.task_title}"`),o.title&&e.push(`"${o.title}"`),o.comment_text){const s=o.comment_text.length>50?o.comment_text.substring(0,50)+"...":o.comment_text;e.push(`Комментарий: ${s}`)}return e.length>0?e.join(" • "):"—"}const Gw={name:"WebhookLogsExport",props:{logs:{type:Array,default:()=>[]},selectedLogs:{type:Array,default:()=>[]},filters:{type:Object,default:()=>({})},totalCount:{type:Number,default:0}},emits:["export-start","export-complete","export-error"],setup(o,{emit:e}){const s=I(!1),t=I("csv"),r=I("all"),i=I(!0),n=I(!1),l=I(0),u=I([]),m=I(null),v=M(()=>o.selectedLogs.length),T=M(()=>o.logs.length>0||o.totalCount>0),f=M(()=>o.filters.category||o.filters.event||o.filters.dateFrom||o.filters.dateTo),k=M(()=>r.value==="selected"?v.value:o.logs.length||o.totalCount),p=M(()=>r.value==="selected"?v.value>0:T.value),S=()=>{l.value=0,u.value=[],m.value=null,v.value>0?r.value="selected":r.value="all",s.value=!0,y()},C=()=>{n.value||(s.value=!1)},y=()=>{const x=_(),D=Vw(x);u.value=D.errors,m.value=D.estimatedSize},_=()=>(r.value==="selected"?o.selectedLogs:o.logs).map(E=>Ht(E)).filter(E=>gt(E)?!0:(console.warn("[WebhookLogsExport] Skipping invalid log:",E),!1)),A=async()=>{try{n.value=!0,l.value=0;let x=_();if(x.length===0)throw new Error("Нет валидных данных для экспорта");const D=x.map(B=>({timestamp:B.timestamp,event:B.event,category:B.category,ip:B.ip||null,details:B.details||null,payload:B.payload||null,formatted:{timestamp:zs(B.timestamp),event:jt(B.event),category:bt(B.category),details:Gs(B.details)}}));e("export-start",{format:t.value,scope:r.value,count:D.length});const E=jw(t.value,o.filters,D.length),P=B=>{l.value=B};t.value==="csv"?await Fw(D,E,{onProgress:P}):await Hw(D,E,{pretty:i.value,onProgress:P}),e("export-complete",{format:t.value,filename:E,count:D.length}),setTimeout(()=>{n.value=!1,s.value=!1,l.value=0},500)}catch(x){console.error("[WebhookLogsExport] Export error:",x),e("export-error",x),n.value=!1,l.value=0,alert(`Ошибка экспорта: ${x.message}`)}},W=x=>x<1024?`${x} B`:x<1024*1024?`${(x/1024).toFixed(2)} KB`:`${(x/1024/1024).toFixed(2)} MB`;return Me([r,()=>o.logs,()=>o.selectedLogs],()=>{s.value&&y()}),{showExportModal:s,exportFormat:t,exportScope:r,jsonPretty:i,exporting:n,exportProgress:l,exportWarnings:u,estimatedSize:m,selectedCount:v,hasAllLogs:T,hasFilters:f,exportCount:k,canExport:p,openExportModal:S,closeExportModal:C,handleExport:A,formatSize:W}}},Kw={class:"webhook-logs-export"},qw=["disabled","title"],Yw={key:0,class:"selected-badge"},Xw={class:"export-modal-header"},Jw={class:"export-modal-body"},Zw={class:"export-section"},Qw={class:"radio-group"},eC={class:"export-section"},tC={class:"radio-group"},sC=["disabled"],aC={class:"radio-label"},oC={key:0},nC={key:1},rC=["disabled"],iC={class:"radio-label"},lC={key:0,class:"export-section"},cC={class:"checkbox-option"},dC={class:"export-info"},uC={class:"info-item"},mC={class:"info-value"},gC={key:0,class:"info-item"},hC={class:"info-value"},fC={key:1,class:"export-warnings"},vC={key:0,class:"export-progress"},pC={class:"progress-bar"},yC={class:"progress-text"},kC={class:"export-modal-footer"},bC=["disabled"],_C={key:0},wC={key:1},CC=["disabled"];function TC(o,e,s,t,r,i){return c(),d("div",Kw,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.openExportModal&&t.openExportModal(...n)),class:"btn-export",disabled:!t.canExport,title:t.canExport?"Экспорт данных":"Нет данных для экспорта"},[e[11]||(e[11]=a("span",{class:"btn-icon"},"📥",-1)),e[12]||(e[12]=a("span",{class:"btn-text"},"Экспорт",-1)),t.selectedCount>0?(c(),d("span",Yw,g(t.selectedCount),1)):$("",!0)],8,qw),ne(Ee,{name:"modal"},{default:pe(()=>[t.showExportModal?(c(),d("div",{key:0,class:"export-modal-overlay",onClick:e[10]||(e[10]=(...n)=>t.closeExportModal&&t.closeExportModal(...n))},[a("div",{class:"export-modal",onClick:e[9]||(e[9]=Ce(()=>{},["stop"]))},[a("div",Xw,[e[13]||(e[13]=a("h3",null,"Экспорт данных",-1)),a("button",{onClick:e[1]||(e[1]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),class:"btn-close"},"✕")]),a("div",Jw,[a("div",Zw,[e[16]||(e[16]=a("h4",null,"Формат файла",-1)),a("div",Qw,[a("label",{class:X(["radio-option",{active:t.exportFormat==="csv"}])},[Le(a("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=n=>t.exportFormat=n),value:"csv",class:"radio-input"},null,512),[[Dt,t.exportFormat]]),e[14]||(e[14]=a("span",{class:"radio-label"},[a("strong",null,"CSV"),a("small",null,"Для Excel, LibreOffice")],-1))],2),a("label",{class:X(["radio-option",{active:t.exportFormat==="json"}])},[Le(a("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=n=>t.exportFormat=n),value:"json",class:"radio-input"},null,512),[[Dt,t.exportFormat]]),e[15]||(e[15]=a("span",{class:"radio-label"},[a("strong",null,"JSON"),a("small",null,"Для разработчиков, API")],-1))],2)])]),a("div",eC,[e[19]||(e[19]=a("h4",null,"Что экспортировать",-1)),a("div",tC,[a("label",{class:X(["radio-option",{active:t.exportScope==="all",disabled:!t.hasAllLogs}])},[Le(a("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=n=>t.exportScope=n),value:"all",disabled:!t.hasAllLogs,class:"radio-input"},null,8,sC),[[Dt,t.exportScope]]),a("span",aC,[e[17]||(e[17]=a("strong",null,"Все записи",-1)),t.hasFilters?(c(),d("small",oC,"С применёнными фильтрами ("+g(t.exportCount)+" записей)",1)):(c(),d("small",nC,"Всего: "+g(t.exportCount)+" записей",1))])],2),a("label",{class:X(["radio-option",{active:t.exportScope==="selected",disabled:t.selectedCount===0}])},[Le(a("input",{type:"radio","onUpdate:modelValue":e[5]||(e[5]=n=>t.exportScope=n),value:"selected",disabled:t.selectedCount===0,class:"radio-input"},null,8,rC),[[Dt,t.exportScope]]),a("span",iC,[e[18]||(e[18]=a("strong",null,"Выбранные записи",-1)),a("small",null,g(t.selectedCount)+" записей выбрано",1)])],2)])]),t.exportFormat==="json"?(c(),d("div",lC,[e[21]||(e[21]=a("h4",null,"Опции JSON",-1)),a("label",cC,[Le(a("input",{type:"checkbox","onUpdate:modelValue":e[6]||(e[6]=n=>t.jsonPretty=n),class:"checkbox-input"},null,512),[[ys,t.jsonPretty]]),e[20]||(e[20]=a("span",{class:"checkbox-label"},"Красивое форматирование (с отступами)",-1))])])):$("",!0),a("div",dC,[a("div",uC,[e[22]||(e[22]=a("span",{class:"info-label"},"Записей к экспорту:",-1)),a("span",mC,g(t.exportCount),1)]),t.estimatedSize?(c(),d("div",gC,[e[23]||(e[23]=a("span",{class:"info-label"},"Примерный размер:",-1)),a("span",hC,g(t.formatSize(t.estimatedSize)),1)])):$("",!0)]),t.exportWarnings.length>0?(c(),d("div",fC,[(c(!0),d(ee,null,te(t.exportWarnings,(n,l)=>(c(),d("div",{key:l,class:"warning-item"}," ⚠️ "+g(n),1))),128))])):$("",!0)]),t.exporting?(c(),d("div",vC,[a("div",pC,[a("div",{class:"progress-fill",style:we({width:`${t.exportProgress}%`})},null,4)]),a("div",yC," Экспорт: "+g(t.exportProgress)+"% ",1)])):$("",!0),a("div",kC,[a("button",{onClick:e[7]||(e[7]=(...n)=>t.handleExport&&t.handleExport(...n)),disabled:t.exporting||!t.canExport,class:"btn-primary"},[t.exporting?(c(),d("span",_C,"Экспорт...")):(c(),d("span",wC,"Экспортировать"))],8,bC),a("button",{onClick:e[8]||(e[8]=(...n)=>t.closeExportModal&&t.closeExportModal(...n)),disabled:t.exporting,class:"btn-secondary"}," Отмена ",8,CC)])])])):$("",!0)]),_:1})])}const SC=de(Gw,[["render",TC],["__scopeId","data-v-7ae66f8c"]]),DC={name:"WebhookLogSearch",props:{modelValue:{type:String,default:""}},emits:["update:modelValue","search"],setup(o,{emit:e}){const s=I(o.modelValue||""),t=I(!1),r=I(null),i=Ju(k=>{t.value=!1,e("search",k)},400),n=()=>{t.value=!0,e("update:modelValue",s.value),i(s.value)},l=()=>{t.value=!1,e("search",s.value)},u=()=>{s.value="",t.value=!1,r.value=null,e("update:modelValue",""),e("search","")};return Me(()=>o.modelValue,k=>{k!==s.value&&(s.value=k)}),{searchQuery:s,isSearching:t,searchResultsCount:r,handleSearchInput:n,handleSearch:l,clearSearch:u,setResultsCount:k=>{r.value=k},getResultsText:k=>{const p=k%10,S=k%100;return S>=11&&S<=19?"записей":p===1?"запись":p>=2&&p<=4?"записи":"записей"},performSearch:(k,p)=>{if(!k||!p||!Array.isArray(p))return[];const S=k.toLowerCase().trim();return S.length===0?p:p.map(y=>Ht(y)).filter(y=>gt(y)).filter(y=>{if(y.event&&y.event.toLowerCase().includes(S)||y.category&&y.category.toLowerCase().includes(S)||y.ip&&y.ip.toLowerCase().includes(S)||y.details&&typeof y.details=="object"&&(y.details.task_id&&String(y.details.task_id).includes(S)||y.details.task_title&&y.details.task_title.toLowerCase().includes(S)||y.details.entity_id&&String(y.details.entity_id).includes(S)||y.details.title&&y.details.title.toLowerCase().includes(S)||y.details.comment_text&&y.details.comment_text.toLowerCase().includes(S)))return!0;if(y.payload&&typeof y.payload=="object")try{if(JSON.stringify(y.payload).toLowerCase().includes(S))return!0}catch{}return!1})},formatSearchResult:k=>{const p=[];if(k.event&&p.push(jt(k.event)),k.category&&p.push(bt(k.category)),k.details){const S=Gs(k.details);S!=="—"&&p.push(S)}return p.join(" • ")}}}},EC={class:"webhook-search"},AC={class:"search-wrapper"},$C={key:0,class:"search-indicator"},IC={key:1,class:"search-results"};function MC(o,e,s,t,r,i){return c(),d("div",EC,[a("div",AC,[e[5]||(e[5]=a("span",{class:"search-icon"},"🔍",-1)),Le(a("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>t.searchQuery=n),type:"text",placeholder:"Поиск по содержимому логов (событие, payload, IP, детали)...",class:"search-input",onInput:e[1]||(e[1]=(...n)=>t.handleSearchInput&&t.handleSearchInput(...n)),onKeyup:[e[2]||(e[2]=Oe((...n)=>t.handleSearch&&t.handleSearch(...n),["enter"])),e[3]||(e[3]=Oe((...n)=>t.clearSearch&&t.clearSearch(...n),["esc"]))]},null,544),[[Et,t.searchQuery]]),t.searchQuery?(c(),d("button",{key:0,onClick:e[4]||(e[4]=(...n)=>t.clearSearch&&t.clearSearch(...n)),class:"clear-button",title:"Очистить поиск (Esc)","aria-label":"Очистить поиск"}," ✕ ")):$("",!0)]),t.isSearching?(c(),d("div",$C,[...e[6]||(e[6]=[a("span",{class:"spinner"},null,-1),ce(" Поиск... ",-1)])])):$("",!0),t.searchQuery&&t.searchResultsCount!==null?(c(),d("div",IC," Найдено: "+g(t.searchResultsCount)+" "+g(t.getResultsText(t.searchResultsCount)),1)):$("",!0)])}const NC=de(DC,[["render",MC],["__scopeId","data-v-db228863"]]);function xC(o,e=null){const s=()=>{try{const n=localStorage.getItem(o);return n?JSON.parse(n):e}catch(n){return console.error(`Error loading ${o} from localStorage:`,n),e}},t=n=>{try{localStorage.setItem(o,JSON.stringify(n))}catch(l){console.error(`Error saving ${o} to localStorage:`,l)}},r=()=>{try{localStorage.removeItem(o)}catch(n){console.error(`Error clearing ${o} from localStorage:`,n)}},i=I(s());return Me(i,n=>{t(n)},{deep:!0}),{value:i,save:t,load:s,clear:r}}const PC={name:"WebhookLogFilters",props:{filters:{type:Object,required:!0}},emits:["update:filters","reset"],setup(o,{emit:e}){const s=I(null),t=xC("webhook-filters",{category:null,event:null,dateFrom:null,dateTo:null,hour:null,ip:null,status:null}),r=E=>(s.value=null,Ps(E)?(e("update:filters",E),!0):(s.value="Некорректные параметры фильтрации",console.error("[WebhookLogFilters] Validation error:",s.value),!1)),i=new Date().toISOString().split("T")[0],n=I({category:t.value.category||o.filters.category||null,event:t.value.event||o.filters.event||null,dateFrom:t.value.dateFrom||o.filters.dateFrom||o.filters.date||i,dateTo:t.value.dateTo||o.filters.dateTo||null,hour:t.value.hour!==void 0?t.value.hour:o.filters.hour!==void 0?o.filters.hour:null,ip:t.value.ip||o.filters.ip||null,status:t.value.status||o.filters.status||null}),l=I(null),u=[{id:"today",label:"Сегодня",getDates:()=>({from:i,to:i})},{id:"yesterday",label:"Вчера",getDates:()=>{const E=new Date;E.setDate(E.getDate()-1);const P=E.toISOString().split("T")[0];return{from:P,to:P}}},{id:"last7days",label:"Последние 7 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-7),{from:E.toISOString().split("T")[0],to:i}}},{id:"last30days",label:"Последние 30 дней",getDates:()=>{const E=new Date;return E.setDate(E.getDate()-30),{from:E.toISOString().split("T")[0],to:i}}}],m=E=>{const P=u.find(B=>B.id===E);if(P){const B=P.getDates();n.value.dateFrom=B.from,n.value.dateTo=B.to,l.value=E,x()}};Me(()=>o.filters,E=>{n.value={category:E.category||null,event:E.event||null,dateFrom:E.dateFrom||E.date||i,dateTo:E.dateTo||null,hour:E.hour!==void 0?E.hour:null,ip:E.ip||null,status:E.status||null}},{deep:!0}),Me(n,E=>{t.value={...E},e("update:filters",{...E})},{deep:!0});const v=M(()=>{const E={};return n.value.category&&(E.category=n.value.category),n.value.event&&(E.event=n.value.event),n.value.hour!==null&&(E.hour=n.value.hour),n.value.ip&&(E.ip=n.value.ip),n.value.status&&(E.status=n.value.status),n.value.dateFrom&&n.value.dateFrom!==i&&(E.dateFrom=n.value.dateFrom),n.value.dateTo&&(E.dateTo=n.value.dateTo),E}),T=M(()=>Object.keys(v.value).length>0),f=E=>({category:"Категория",event:"Событие",hour:"Час",ip:"IP адрес",status:"Статус",dateFrom:"Дата от",dateTo:"Дата до"})[E]||E,k=(E,P)=>E==="category"?bt(P)||P:E==="hour"?`${String(P).padStart(2,"0")}:00`:E==="event"?jt(P)||P:E==="status"&&{success:"Успешно",error:"Ошибка",warning:"Предупреждение"}[P]||P,p=M(()=>[{value:null,label:"Все категории"},{value:"tasks",label:bt("tasks")},{value:"smart-processes",label:bt("smart-processes")},{value:"errors",label:bt("errors")}]),S=M(()=>[{value:null,label:"Все события"},...["ONTASKADD","ONTASKUPDATE","ONTASKDELETE","ONTASKCOMMENTADD","ONTASKCOMMENTUPDATE","ONTASKCOMMENTDELETE","ONCRMDYNAMICITEMADD","ONCRMDYNAMICITEMUPDATE","ONCRMDYNAMICITEMDELETE"].map(P=>({value:P,label:jt(P)}))]),C=E=>{E==="hour"?n.value[E]=null:E==="dateFrom"?n.value[E]=i:n.value[E]=null,l.value=null},y=E=>{const P={...n.value,category:E||null};r(P)&&(n.value.category=E)},_=E=>{const P={...n.value,event:E||null};r(P)&&(n.value.event=E)},A=(E,P)=>{if(E&&!/^\d{4}-\d{2}-\d{2}$/.test(E)){console.error("[WebhookLogFilters] Invalid date format:",E),s.value="Некорректный формат даты";return}const B={...n.value,[P]:E||null};r(B)&&(n.value[P]=E)},W=E=>{if(E!=null){const B=parseInt(E,10);if(isNaN(B)||B<0||B>23){console.error("[WebhookLogFilters] Invalid hour:",E),s.value="Некорректный час (должен быть от 0 до 23)";return}}const P={...n.value,hour:E!=null?parseInt(E,10):null};r(P)&&(n.value.hour=E!=null?parseInt(E,10):null)},x=()=>{r({...n.value})},D=()=>{n.value={category:null,event:null,dateFrom:i,dateTo:null,hour:null,ip:null,status:null},l.value=null,t.clear(),e("reset")};return Ae(()=>{t.value&&Object.keys(t.value).length>0&&e("update:filters",{...t.value})}),{localFilters:n,activeFilters:v,hasActiveFilters:T,getFilterLabel:f,getFilterValue:k,clearFilter:C,handleFilterChange:x,handleCategoryChange:y,handleEventChange:_,handleDateChange:A,handleHourChange:W,handleReset:D,quickFilters:u,activeQuickFilter:l,applyQuickFilter:m,categoryOptions:p,eventOptions:S,validationError:s}}},LC={class:"webhook-log-filters"},OC={key:0,class:"active-filters-indicator"},BC=["onClick"],RC={key:1,class:"validation-error"},WC={class:"quick-filters"},UC=["onClick"],FC={class:"filters-row"},HC={class:"filter-group"},jC=["value"],VC={class:"filter-group"},zC=["value"],GC={class:"filter-group"},KC={class:"filter-group"},qC={class:"filter-group"},YC={class:"filter-group"},XC={class:"filter-group"};function JC(o,e,s,t,r,i){return c(),d("div",LC,[t.hasActiveFilters?(c(),d("div",OC,[e[14]||(e[14]=a("span",{class:"indicator-text"},"Активные фильтры:",-1)),(c(!0),d(ee,null,te(t.activeFilters,(n,l)=>(c(),d("span",{key:l,class:"filter-badge"},[ce(g(t.getFilterLabel(l))+": "+g(t.getFilterValue(l,n))+" ",1),a("button",{onClick:u=>t.clearFilter(l),class:"filter-badge-remove",title:"Удалить фильтр"}," × ",8,BC)]))),128)),a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-clear-all"}," Очистить все ")])):$("",!0),t.validationError?(c(),d("div",RC," ⚠️ "+g(t.validationError),1)):$("",!0),a("div",WC,[e[15]||(e[15]=a("span",{class:"quick-filters-label"},"Быстрые фильтры:",-1)),(c(!0),d(ee,null,te(t.quickFilters,n=>(c(),d("button",{key:n.id,onClick:l=>t.applyQuickFilter(n.id),class:X(["quick-filter-btn",{active:t.activeQuickFilter===n.id}])},g(n.label),11,UC))),128))]),a("div",FC,[a("div",HC,[e[16]||(e[16]=a("label",{for:"category-filter"},"Категория:",-1)),Le(a("select",{id:"category-filter","onUpdate:modelValue":e[1]||(e[1]=n=>t.localFilters.category=n),onChange:e[2]||(e[2]=n=>t.handleCategoryChange(t.localFilters.category)),class:"filter-select"},[(c(!0),d(ee,null,te(t.categoryOptions,n=>(c(),d("option",{key:n.value,value:n.value},g(n.label),9,jC))),128))],544),[[dt,t.localFilters.category]])]),a("div",VC,[e[17]||(e[17]=a("label",{for:"event-filter"},"Тип события:",-1)),Le(a("select",{id:"event-filter","onUpdate:modelValue":e[3]||(e[3]=n=>t.localFilters.event=n),onChange:e[4]||(e[4]=n=>t.handleEventChange(t.localFilters.event)),class:"filter-select"},[(c(!0),d(ee,null,te(t.eventOptions,n=>(c(),d("option",{key:n.value,value:n.value},g(n.label),9,zC))),128))],544),[[dt,t.localFilters.event]])]),a("div",GC,[e[18]||(e[18]=a("label",{for:"date-from-filter"},"Дата от:",-1)),Le(a("input",{id:"date-from-filter","onUpdate:modelValue":e[5]||(e[5]=n=>t.localFilters.dateFrom=n),type:"date",onChange:e[6]||(e[6]=n=>t.handleDateChange(t.localFilters.dateFrom,"dateFrom")),class:"filter-input"},null,544),[[Et,t.localFilters.dateFrom]])]),a("div",KC,[e[19]||(e[19]=a("label",{for:"date-to-filter"},"Дата до:",-1)),Le(a("input",{id:"date-to-filter","onUpdate:modelValue":e[7]||(e[7]=n=>t.localFilters.dateTo=n),type:"date",onChange:e[8]||(e[8]=n=>t.handleDateChange(t.localFilters.dateTo,"dateTo")),class:"filter-input"},null,544),[[Et,t.localFilters.dateTo]])]),a("div",qC,[e[20]||(e[20]=a("label",{for:"ip-filter"},"IP адрес:",-1)),Le(a("input",{id:"ip-filter","onUpdate:modelValue":e[9]||(e[9]=n=>t.localFilters.ip=n),type:"text",placeholder:"192.168.1.1",onInput:e[10]||(e[10]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-input"},null,544),[[Et,t.localFilters.ip]])]),a("div",YC,[e[22]||(e[22]=a("label",{for:"status-filter"},"Статус:",-1)),Le(a("select",{id:"status-filter","onUpdate:modelValue":e[11]||(e[11]=n=>t.localFilters.status=n),onChange:e[12]||(e[12]=(...n)=>t.handleFilterChange&&t.handleFilterChange(...n)),class:"filter-select"},[...e[21]||(e[21]=[a("option",{value:null},"Все статусы",-1),a("option",{value:"success"},"Успешно",-1),a("option",{value:"error"},"Ошибка",-1),a("option",{value:"warning"},"Предупреждение",-1)])],544),[[dt,t.localFilters.status]])]),a("div",XC,[a("button",{onClick:e[13]||(e[13]=(...n)=>t.handleReset&&t.handleReset(...n)),class:"btn-reset"}," Сбросить ")])])])}const ZC=de(PC,[["render",JC],["__scopeId","data-v-2a150a46"]]),QC={name:"WebhookLogList",props:{logs:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},error:{type:String,default:null},pagination:{type:Object,default:null},selectedLogs:{type:Array,default:()=>[]}},emits:["select-log","page-change","update:selectedLogs"],setup(o,{emit:e}){const s=M(()=>!o.logs||!Array.isArray(o.logs)?(console.warn("[WebhookLogList] Invalid logs prop:",o.logs),[]):o.logs.map(P=>Ht(P)).filter(P=>gt(P)?!0:(console.warn("[WebhookLogList] Invalid log entry:",P),!1))),t=I("timestamp"),r=I("desc"),i=P=>{t.value===P?r.value=r.value==="asc"?"desc":"asc":(t.value=P,r.value="desc")},n=M(()=>!s.value||s.value.length===0?[]:[...s.value].sort((B,U)=>{let G,q;switch(t.value){case"timestamp":G=new Date(B.timestamp||0).getTime(),q=new Date(U.timestamp||0).getTime();break;case"event":G=(B.event||"").toLowerCase(),q=(U.event||"").toLowerCase();break;case"category":G=(B.category||"").toLowerCase(),q=(U.category||"").toLowerCase();break;case"ip":G=(B.ip||"").toLowerCase(),q=(U.ip||"").toLowerCase();break;default:return 0}return G<q?r.value==="asc"?-1:1:G>q?r.value==="asc"?1:-1:0})),l=P=>t.value!==P?"↕️":r.value==="asc"?"↑":"↓",u=P=>P.category==="errors"?"status-error":"status-success",m=P=>P.category==="errors"?"❌":"✅",v=P=>P.category==="errors"?"Ошибка обработки":"Успешно обработано",T=P=>`${P.timestamp}_${P.event}_${P.ip||"unknown"}`,f=P=>P?zs(P,"short"):"—",k=P=>P?jt(P):"—",p=P=>P?bt(P):"—",S=P=>!P||typeof P!="object"?"—":Gs(P),C=P=>`category-${P}`,y=P=>P?.startsWith("ONTASK")?"event-task":P?.startsWith("ONCRMDYNAMIC")?"event-smart-process":"event-other",_=P=>{e("select-log",P)},A=P=>{P>=1&&P<=o.pagination.pages&&e("page-change",P)},W=P=>o.selectedLogs.some(B=>T(B)===T(P)),x=(P,B)=>{B.stopPropagation();const U=[...o.selectedLogs],G=T(P),q=U.findIndex(oe=>T(oe)===G);B.target.checked?q===-1&&U.push(P):q!==-1&&U.splice(q,1),e("update:selectedLogs",U)},D=P=>{P.target.checked?e("update:selectedLogs",[...o.logs]):e("update:selectedLogs",[])},E=M(()=>s.value.length>0&&s.value.every(P=>W(P)));return Me(()=>o.logs,P=>{if(P&&Array.isArray(P)){const B=P.filter(U=>!gt(U)).length;B>0&&console.warn(`[WebhookLogList] Received ${B} invalid log entries out of ${P.length}`)}},{immediate:!0}),{validatedLogs:s,sortBy:t,sortOrder:r,sortedLogs:n,handleSort:i,getSortIcon:l,getStatusClass:u,getStatusIcon:m,getStatusTitle:v,getLogId:T,formatTimestamp:f,formatEvent:k,formatCategoryLabel:p,formatDetailsPreview:S,getCategoryClass:C,getEventClass:y,handleLogClick:_,handlePageChange:A,isSelected:W,handleSelectLog:x,handleSelectAll:D,allSelected:E}}},eT={class:"webhook-log-list"},tT={key:0,class:"logs-table-container"},sT={class:"logs-table"},aT={class:"checkbox-header"},oT=["checked"],nT={class:"sort-icon"},rT={class:"sort-icon"},iT={class:"sort-icon"},lT={class:"sort-icon"},cT=["onClick"],dT=["checked","onChange"],uT=["title"],mT={class:"details-preview"},gT=["onClick"],hT={key:0,class:"pagination"},fT=["disabled"],vT={class:"pagination-info"},pT=["disabled"];function yT(o,e,s,t,r,i){return c(),d("div",eT,[s.logs.length>0?(c(),d("div",tT,[a("table",sT,[a("thead",null,[a("tr",null,[a("th",aT,[a("input",{type:"checkbox",checked:t.allSelected,onChange:e[0]||(e[0]=(...n)=>t.handleSelectAll&&t.handleSelectAll(...n)),onClick:e[1]||(e[1]=Ce(()=>{},["stop"])),class:"checkbox-input",title:"Выбрать все"},null,40,oT)]),a("th",{onClick:e[2]||(e[2]=n=>t.handleSort("timestamp")),class:X(["sortable",{"sort-asc":t.sortBy==="timestamp"&&t.sortOrder==="asc","sort-desc":t.sortBy==="timestamp"&&t.sortOrder==="desc"}])},[e[9]||(e[9]=ce(" Дата и время ",-1)),a("span",nT,g(t.getSortIcon("timestamp")),1)],2),a("th",{onClick:e[3]||(e[3]=n=>t.handleSort("event")),class:X(["sortable",{"sort-asc":t.sortBy==="event"&&t.sortOrder==="asc","sort-desc":t.sortBy==="event"&&t.sortOrder==="desc"}])},[e[10]||(e[10]=ce(" Тип события ",-1)),a("span",rT,g(t.getSortIcon("event")),1)],2),a("th",{onClick:e[4]||(e[4]=n=>t.handleSort("category")),class:X(["sortable",{"sort-asc":t.sortBy==="category"&&t.sortOrder==="asc","sort-desc":t.sortBy==="category"&&t.sortOrder==="desc"}])},[e[11]||(e[11]=ce(" Категория ",-1)),a("span",iT,g(t.getSortIcon("category")),1)],2),a("th",{onClick:e[5]||(e[5]=n=>t.handleSort("ip")),class:X(["sortable",{"sort-asc":t.sortBy==="ip"&&t.sortOrder==="asc","sort-desc":t.sortBy==="ip"&&t.sortOrder==="desc"}])},[e[12]||(e[12]=ce(" IP ",-1)),a("span",lT,g(t.getSortIcon("ip")),1)],2),e[13]||(e[13]=a("th",null,"Детали",-1)),e[14]||(e[14]=a("th",null,"Действия",-1))])]),a("tbody",null,[(c(!0),d(ee,null,te(t.sortedLogs,n=>(c(),d("tr",{key:t.getLogId(n),onClick:l=>t.handleLogClick(n),class:X(["log-row",{"row-selected":t.isSelected(n)}])},[a("td",{onClick:e[6]||(e[6]=Ce(()=>{},["stop"]))},[a("input",{type:"checkbox",checked:t.isSelected(n),onChange:l=>t.handleSelectLog(n,l),class:"checkbox-input"},null,40,dT)]),a("td",null,g(t.formatTimestamp(n.timestamp)),1),a("td",null,[a("span",{class:X(["status-indicator",t.getStatusClass(n)]),title:t.getStatusTitle(n)},g(t.getStatusIcon(n)),11,uT),a("span",{class:X(["event-badge",t.getEventClass(n.event)])},g(t.formatEvent(n.event)),3)]),a("td",null,[a("span",{class:X(["category-badge",t.getCategoryClass(n.category)])},g(t.formatCategoryLabel(n.category)),3)]),a("td",null,g(n.ip||"N/A"),1),a("td",null,[a("div",mT,g(t.formatDetailsPreview(n.details)),1)]),a("td",null,[a("button",{onClick:Ce(l=>t.handleLogClick(n),["stop"]),class:"btn-view"}," Просмотр ",8,gT)])],10,cT))),128))])]),s.pagination&&s.pagination.pages>1?(c(),d("div",hT,[a("button",{onClick:e[7]||(e[7]=n=>t.handlePageChange(s.pagination.page-1)),disabled:s.pagination.page<=1,class:"btn-pagination"}," Назад ",8,fT),a("span",vT," Страница "+g(s.pagination.page)+" из "+g(s.pagination.pages)+" (всего: "+g(s.pagination.total)+") ",1),a("button",{onClick:e[8]||(e[8]=n=>t.handlePageChange(s.pagination.page+1)),disabled:s.pagination.page>=s.pagination.pages,class:"btn-pagination"}," Вперёд ",8,pT)])):$("",!0)])):$("",!0)])}const kT=de(QC,[["render",yT],["__scopeId","data-v-fddd3018"]]),bT={name:"LoadingSkeleton",props:{width:{type:[String,Number],default:"100%"},height:{type:[String,Number],default:"20px"},variant:{type:String,default:"rect",validator:o=>["rect","circle","text","table-row"].includes(o)},animated:{type:Boolean,default:!0},borderRadius:{type:String,default:null}},setup(o){return{skeletonStyle:M(()=>{const s={width:typeof o.width=="number"?`${o.width}px`:o.width,height:typeof o.height=="number"?`${o.height}px`:o.height};return o.borderRadius&&(s.borderRadius=o.borderRadius),s})}}},_T={key:0,class:"skeleton-shimmer"};function wT(o,e,s,t,r,i){return c(),d("div",{class:X(["skeleton",[`skeleton-${s.variant}`,{"skeleton-animated":s.animated}]]),style:we(t.skeletonStyle)},[s.animated?(c(),d("div",_T)):$("",!0)],6)}const CT=de(bT,[["render",wT],["__scopeId","data-v-014f86e6"]]),TT={name:"SkeletonLogList",components:{LoadingSkeleton:CT},props:{rows:{type:Number,default:5}},setup(){return{getColumnWidth:e=>["40px","15%","20%","15%","15%","20%","15%"][e-1]||"100%"}}},ST={class:"skeleton-log-list"},DT={class:"skeleton-table-header"};function ET(o,e,s,t,r,i){const n=be("LoadingSkeleton");return c(),d("div",ST,[a("div",DT,[(c(),d(ee,null,te(7,l=>ne(n,{key:l,width:"120px",height:"16px",variant:"text"})),64))]),(c(!0),d(ee,null,te(s.rows,l=>(c(),d("div",{key:l,class:"skeleton-table-row"},[(c(),d(ee,null,te(7,u=>ne(n,{key:u,width:"100%",height:"20px",variant:"text",style:we({width:t.getColumnWidth(u)})},null,8,["style"])),64))]))),128))])}const AT=de(TT,[["render",ET],["__scopeId","data-v-475c4e73"]]),$T={name:"EmptyState",props:{icon:{type:String,default:"📭"},title:{type:String,required:!0},description:{type:String,required:!0},actionLabel:{type:String,default:null},actions:{type:Array,default:null},hints:{type:Array,default:()=>[]},variant:{type:String,default:"default",validator:o=>["default","error","warning","info"].includes(o)}},emits:["action","action-click"]},IT={class:"empty-icon"},MT={class:"empty-title"},NT={class:"empty-description"},xT={key:0,class:"empty-hints"},PT={key:1,class:"empty-actions"},LT=["onClick"];function OT(o,e,s,t,r,i){return c(),d("div",{class:X(["empty-state",`empty-state-${s.variant}`])},[a("div",IT,g(s.icon),1),a("h3",MT,g(s.title),1),a("p",NT,g(s.description),1),s.hints&&s.hints.length>0?(c(),d("div",xT,[(c(!0),d(ee,null,te(s.hints,(n,l)=>(c(),d("div",{key:l,class:"hint-item"}," 💡 "+g(n),1))),128))])):$("",!0),s.actionLabel||s.actions?(c(),d("div",PT,[s.actionLabel?(c(),d("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("action")),class:"btn-primary"},g(s.actionLabel),1)):$("",!0),(c(!0),d(ee,null,te(s.actions,(n,l)=>(c(),d("button",{key:l,onClick:u=>o.$emit("action-click",n.id),class:X(["btn",`btn-${n.variant||"secondary"}`])},g(n.label),11,LT))),128))])):$("",!0)],2)}const BT=de($T,[["render",OT],["__scopeId","data-v-081c13b9"]]),RT={name:"ErrorDisplay",props:{title:{type:String,default:"Произошла ошибка"},message:{type:String,required:!0},details:{type:String,default:null},severity:{type:String,default:"error",validator:o=>["error","warning","critical"].includes(o)},retryable:{type:Boolean,default:!1}},emits:["retry"],setup(){return{showDetails:I(!1)}}},WT={class:"error-icon"},UT={class:"error-content"},FT={class:"error-title"},HT={class:"error-message"},jT={key:0,class:"error-details"},VT={class:"error-actions"};function zT(o,e,s,t,r,i){return c(),d("div",{class:X(["error-display",`error-${s.severity}`])},[a("div",WT,g(s.severity==="critical"?"🚨":"⚠️"),1),a("div",UT,[a("h4",FT,g(s.title),1),a("p",HT,g(s.message),1),s.details&&t.showDetails?(c(),d("div",jT,[a("pre",null,g(s.details),1)])):$("",!0),a("div",VT,[s.retryable?(c(),d("button",{key:0,onClick:e[0]||(e[0]=n=>o.$emit("retry")),class:"btn-retry"}," 🔄 Повторить ")):$("",!0),s.details?(c(),d("button",{key:1,onClick:e[1]||(e[1]=n=>t.showDetails=!t.showDetails),class:"btn-details"},g(t.showDetails?"Скрыть":"Показать")+" детали ",1)):$("",!0)])])],2)}const GT=de(RT,[["render",zT],["__scopeId","data-v-3f2f4c14"]]),KT={name:"Notification",props:{notification:{type:Object,required:!0}},emits:["close"],setup(o,{emit:e}){const s=I(100),t=M(()=>o.notification.duration>0);let r=null;const i={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},n=M(()=>i[o.notification.type]||"ℹ️"),l=()=>{e("close")},u=()=>{o.notification.onClick&&o.notification.onClick()};return Ae(()=>{if(t.value&&o.notification.duration>0){const m=Date.now(),v=o.notification.duration;r=setInterval(()=>{const T=Date.now()-m;s.value=Math.max(0,100-T/v*100),s.value<=0&&(clearInterval(r),l())},50)}}),st(()=>{r&&clearInterval(r)}),{icon:n,progress:s,showProgress:t,close:l,handleClick:u}}},qT={class:"notification-content"},YT={class:"notification-icon"},XT={class:"notification-message"},JT={key:0,class:"notification-progress"};function ZT(o,e,s,t,r,i){return c(),d("div",{class:X(["notification",`notification-${s.notification.type}`]),onClick:e[1]||(e[1]=(...n)=>t.handleClick&&t.handleClick(...n))},[a("div",qT,[a("span",YT,g(t.icon),1),a("span",XT,g(s.notification.message),1)]),a("button",{onClick:e[0]||(e[0]=Ce((...n)=>t.close&&t.close(...n),["stop"])),class:"notification-close"},"✕"),t.showProgress?(c(),d("div",JT,[a("div",{class:"progress-bar",style:we({width:`${t.progress}%`})},null,4)])):$("",!0)],2)}const QT=de(KT,[["render",ZT],["__scopeId","data-v-1b602bdf"]]),eS={name:"NotificationContainer",components:{Notification:QT},setup(){const{notifications:o,removeNotification:e}=lt();return{notifications:o,removeNotification:e}}},tS={class:"notification-container"};function sS(o,e,s,t,r,i){const n=be("Notification");return c(),he($t,{to:"body"},[a("div",tS,[ne(Qe,{name:"notification",tag:"div"},{default:pe(()=>[(c(!0),d(ee,null,te(t.notifications,l=>(c(),he(n,{key:l.id,notification:l,onClose:u=>t.removeNotification(l.id)},null,8,["notification","onClose"]))),128))]),_:1})])])}const aS=de(eS,[["render",sS],["__scopeId","data-v-dd8772c8"]]),oS={name:"RealtimeControls",props:{enabled:{type:Boolean,default:!1},connectionState:{type:String,default:"disconnected"},error:{type:String,default:null}},emits:["toggle"],setup(o,{emit:e}){const s=I(o.enabled);Me(()=>o.enabled,T=>{s.value=T});const t=M(()=>o.connectionState==="connecting"),r=M(()=>!!o.error),i=M(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),n=M(()=>{switch(o.connectionState){case"connected":return"Подключено";case"connecting":return"Подключение...";case"disconnected":return"Отключено";case"error":return"Ошибка соединения";default:return"Неизвестное состояние"}}),l=M(()=>n.value),u=M(()=>({"status-connected":o.connectionState==="connected","status-connecting":o.connectionState==="connecting","status-disconnected":o.connectionState==="disconnected","status-error":o.connectionState==="error"})),m=M(()=>o.error?typeof o.error=="string"?o.error:o.error.message?o.error.message:"Неизвестная ошибка":null);return{localEnabled:s,isConnecting:t,hasError:r,statusClass:i,statusText:n,connectionStatusText:l,connectionStatusClass:u,displayError:m,handleToggle:()=>{e("toggle",s.value)}}}},nS={class:"realtime-controls"},rS={class:"control-toggle"},iS=["disabled"],lS={class:"status-text"},cS={key:0,class:"error-message"};function dS(o,e,s,t,r,i){return c(),d("div",nS,[a("label",rS,[Le(a("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=n=>t.localEnabled=n),onChange:e[1]||(e[1]=(...n)=>t.handleToggle&&t.handleToggle(...n)),disabled:t.isConnecting},null,40,iS),[[ys,t.localEnabled]]),e[2]||(e[2]=a("span",{class:"toggle-label"},"Автообновление",-1))]),a("div",{class:X(["status-indicator",t.statusClass])},[e[3]||(e[3]=a("span",{class:"status-dot"},null,-1)),a("span",lS,g(t.statusText),1)],2),t.hasError&&t.displayError?(c(),d("div",cS," ⚠️ "+g(t.displayError),1)):$("",!0)])}const uS=de(oS,[["render",dS],["__scopeId","data-v-af36f073"]]),mS={name:"NewLogsIndicator",props:{count:{type:Number,default:0},newLogs:{type:Array,default:()=>[]}},emits:["apply","dismiss"],setup(o,{emit:e}){const s=(n,l,u,m)=>{const v=n%10,T=n%100;return T>=11&&T<=19?m:v===1?l:v>=2&&v<=4?u:m},t=M(()=>!o.newLogs||!Array.isArray(o.newLogs)||o.newLogs.length===0?[]:o.newLogs.map(l=>Ht(l)).filter(l=>gt(l)).slice(0,5).map(l=>({...l,formatted:{event:jt(l.event),category:bt(l.category)}})));return{pluralize:s,newLogsPreview:t,handleApply:()=>{if(!o.newLogs||o.newLogs.length===0)return;const n=o.newLogs.map(l=>Ht(l)).filter(l=>gt(l));if(n.length===0){console.warn("[NewLogsIndicator] No valid logs to apply");return}e("apply",n)},handleDismiss:()=>{e("dismiss")}}}},gS={key:0,class:"new-logs-indicator"},hS={class:"indicator-content"},fS={class:"indicator-text"},vS={class:"indicator-actions"};function pS(o,e,s,t,r,i){return c(),he(Ee,{name:"slide-down"},{default:pe(()=>[s.count>0?(c(),d("div",gS,[a("div",hS,[e[2]||(e[2]=a("span",{class:"indicator-icon"},"🔔",-1)),a("span",fS,g(s.count)+" "+g(t.pluralize(s.count,"новое событие","новых события","новых событий")),1),a("div",vS,[a("button",{onClick:e[0]||(e[0]=(...n)=>t.handleApply&&t.handleApply(...n)),class:"btn-apply"}," Применить "),a("button",{onClick:e[1]||(e[1]=(...n)=>t.handleDismiss&&t.handleDismiss(...n)),class:"btn-dismiss"}," ✕ ")])])])):$("",!0)]),_:1})}const yS=de(mS,[["render",pS],["__scopeId","data-v-19791dbc"]]);class kS{constructor(e,s={}){this.url=e,this.options={reconnectInterval:3e3,maxReconnectAttempts:10,reconnectDelay:1e3,lastTimestamp:null,...s},this.eventSource=null,this.listeners=new Map,this.reconnectAttempts=0,this.reconnectTimer=null,this.isManualDisconnect=!1,this.connectionState="disconnected"}updateOptions(e){this.options={...this.options,...e}}connect(){if(this.connectionState==="connected"||this.connectionState==="connecting"){console.warn("[RealtimeService] Already connected or connecting");return}this.isManualDisconnect=!1,this.connectionState="connecting",this.notifyListeners("state-change",{state:this.connectionState});try{let e=this.url;if(!e.startsWith("http://")&&!e.startsWith("https://")){const s=new URL(e,window.location.origin);this.options.lastTimestamp&&s.searchParams.set("last_timestamp",this.options.lastTimestamp),e=s.toString()}else{const s=new URL(e);this.options.lastTimestamp&&s.searchParams.set("last_timestamp",this.options.lastTimestamp),e=s.toString()}console.log("[RealtimeService] Connecting to:",e),this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{console.log("[RealtimeService] EventSource opened"),this.notifyListeners("open",{timestamp:new Date().toISOString()})},this.eventSource.onmessage=s=>{try{const t=JSON.parse(s.data);this.notifyListeners("message",t)}catch(t){console.error("[RealtimeService] Error parsing message:",t)}},this.eventSource.addEventListener("connected",s=>{try{const t=JSON.parse(s.data);console.log("[RealtimeService] Connected event received:",t),this.connectionState="connected",this.reconnectAttempts=0,this.notifyListeners("connected",t),this.notifyListeners("state-change",{state:this.connectionState})}catch(t){console.error("[RealtimeService] Error parsing connected event:",t)}}),this.eventSource.addEventListener("new_logs",s=>{const t=JSON.parse(s.data);if(t.logs&&t.logs.length>0){const r=t.logs[t.logs.length-1];r.timestamp&&(this.options.lastTimestamp=r.timestamp)}this.notifyListeners("new_logs",t)}),this.eventSource.addEventListener("error",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("error",t)}catch{this.notifyListeners("error",{message:"Server error"})}}),this.eventSource.addEventListener("timeout",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("timeout",t)}catch{this.notifyListeners("timeout",{message:"Connection timeout"})}this.reconnect()}),this.eventSource.addEventListener("closed",s=>{try{const t=JSON.parse(s.data);this.notifyListeners("closed",t)}catch{this.notifyListeners("closed",{message:"Connection closed"})}this.isManualDisconnect||this.reconnect()}),this.eventSource.onerror=s=>{console.error("[RealtimeService] Connection error:",s),console.error("[RealtimeService] EventSource readyState:",this.eventSource?.readyState),this.eventSource?.readyState===EventSource.CLOSED?(console.log("[RealtimeService] EventSource closed by server"),this.connectionState="disconnected",this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()):this.eventSource?.readyState===EventSource.CONNECTING?console.log("[RealtimeService] Still connecting..."):(this.connectionState="error",this.notifyListeners("error",{error:s,type:"connection",message:"Failed to connect to realtime stream",readyState:this.eventSource?.readyState}),this.notifyListeners("state-change",{state:this.connectionState}),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.isManualDisconnect||this.reconnect())}}catch(e){console.error("[RealtimeService] Error creating EventSource:",e),this.connectionState="error",this.notifyListeners("error",{error:e,type:"initialization"}),this.notifyListeners("state-change",{state:this.connectionState}),this.isManualDisconnect||this.reconnect()}}reconnect(){if(this.isManualDisconnect)return;if(this.reconnectAttempts>=this.options.maxReconnectAttempts){console.error("[RealtimeService] Max reconnect attempts reached"),this.notifyListeners("max-reconnect-attempts",{attempts:this.reconnectAttempts});return}this.reconnectAttempts++;const e=Math.min(this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),this.options.reconnectInterval);console.log(`[RealtimeService] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.connect()},e)}disconnect(){this.isManualDisconnect=!0,this.connectionState="disconnected",this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.notifyListeners("disconnected",{timestamp:new Date().toISOString()}),this.notifyListeners("state-change",{state:this.connectionState})}on(e,s){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(s)}off(e,s){if(this.listeners.has(e)){const t=this.listeners.get(e),r=t.indexOf(s);r>-1&&t.splice(r,1)}}notifyListeners(e,s){this.listeners.has(e)&&this.listeners.get(e).forEach(t=>{try{t(s)}catch(r){console.error(`[RealtimeService] Error in listener for ${e}:`,r)}})}getState(){return this.connectionState}isConnected(){return this.connectionState==="connected"}}function bS(o,e={}){const{autoConnect:s=!1,enableSound:t=!1,onNewLogs:r=null,validateLogs:i=!0}=e,n=new kS(o,e),l=I("disconnected"),u=I([]),m=I(0),v=I(null),T=I(null),f=I(0),k=M(()=>l.value==="connected"),p=M(()=>l.value==="connecting"),S=M(()=>l.value==="error"),C=M(()=>m.value>0),y=G=>{l.value=G.state,G.state==="connected"&&(f.value=0,T.value=null)},_=G=>{let q=G.logs||[];if(i){q=Vs(q);const oe=q.filter(Y=>gt(Y));oe.length!==q.length&&console.warn("[useRealtime] Filtered out invalid logs:",q.length-oe.length),q=oe}q.length!==0&&(u.value.push(...q),m.value+=q.length,v.value=new Date().toISOString(),t&&q.length>0&&U(),r&&r(q))},A=G=>{const q=G.message||G.error?.message||"Connection error";T.value=q,l.value="error",console.error("[useRealtime] Error:",G)},W=G=>{console.warn("[useRealtime] Connection timeout:",G)},x=G=>{T.value=`Max reconnect attempts reached (${G.attempts})`,console.error("[useRealtime] Max reconnect attempts:",G)},D=(G={})=>{T.value=null,G.lastTimestamp!==void 0&&n.updateOptions({lastTimestamp:G.lastTimestamp}),n.on("state-change",y),n.on("new_logs",_),n.on("error",A),n.on("timeout",W),n.on("max-reconnect-attempts",x),n.connect()},E=()=>{n.off("state-change",y),n.off("new_logs",_),n.off("error",A),n.off("timeout",W),n.off("max-reconnect-attempts",x),n.disconnect()},P=()=>{u.value=[],m.value=0},B=G=>{G&&Array.isArray(G)&&(G.unshift(...u.value),P())},U=()=>{try{const G=new Audio("/sounds/notification.mp3");G.volume=.3,G.play().catch(q=>{console.warn("[useRealtime] Failed to play sound:",q)})}catch(G){console.warn("[useRealtime] Sound not available:",G)}};return s&&Ae(()=>{D()}),st(()=>{E()}),{connectionState:l,isConnected:k,isConnecting:p,hasError:S,newLogs:u,newLogsCount:m,hasNewLogs:C,lastUpdateTime:v,error:T,reconnectAttempts:f,connect:D,disconnect:E,clearNewLogs:P,applyNewLogs:B}}const _S=ya(()=>De(()=>import("./WebhookLogsDashboard.vue-jhr5U-zj.js"),__vite__mapDeps([8,7,4,2,3,0,1]),import.meta.url)),wS=ya(()=>De(()=>import("./WebhookLogDetails.vue-P6OI-JYD.js"),__vite__mapDeps([9,7,4,2,3,0,1]),import.meta.url)),CS={name:"WebhookLogsPage",components:{WebhookLogsDashboard:_S,WebhookLogsExport:SC,WebhookLogSearch:NC,WebhookLogFilters:ZC,WebhookLogList:kT,WebhookLogDetails:wS,SkeletonLogList:AT,EmptyState:BT,ErrorDisplay:GT,NotificationContainer:aS,RealtimeControls:uS,NewLogsIndicator:yS},setup(){const o=Xe(),{success:e,error:s}=lt(),t=I(!1),r=I(!1),i=I(null),n=I(null),l=I([]),u=(N,b=2)=>{if(N==null)return String(N);if(typeof N=="string")return N;const O=(Q,ue=0)=>{if(ue>10)return"[Max Depth]";if(Q==null||typeof Q!="object")return Q;if(Array.isArray(Q))return Q.map(_e=>O(_e,ue+1));const ke={};try{for(const _e in Q)if(Object.prototype.hasOwnProperty.call(Q,_e))try{const K=Q[_e];if(typeof K=="function"||K===void 0)continue;ke[_e]=O(K,ue+1)}catch{ke[_e]="[Error reading property]"}}catch{return"[Error reading object]"}return ke};try{const Q=O(N),ue=new WeakSet;return JSON.stringify(Q,(ke,_e)=>{if(typeof _e=="object"&&_e!==null){if(ue.has(_e))return"[Circular]";ue.add(_e)}return _e},b)}catch(Q){return console.error("[WebhookLogsPage] Error in safeStringify:",Q),`[Error: ${Q.message}]`}},m=I(null),v=I([]),T=I(""),f=I(null),k=I(null),p=I(!1),{connectionState:S,newLogsCount:C,error:y,connect:_,disconnect:A,applyNewLogs:W,clearNewLogs:x}=bS(et("/api/webhook-realtime.php"),{autoConnect:!1,enableSound:!0,validateLogs:!0,onNewLogs:N=>{console.log("[WebhookLogsPage] New logs received:",N.length),N.length>0&&(l.value.unshift(...N),B.value.total+=N.length,e(`Получено ${N.length} новых событий`))}}),{filters:D,updateFilters:E,clearFilters:P}=Bw(),B=I({page:1,limit:50,total:0,pages:0}),U=M(()=>{let N=[...l.value];return T.value&&T.value.trim()&&(N=Rw(N,T.value,{caseSensitive:!1,searchInEvent:!0,searchInPayload:!0,searchInDetails:!0,searchInIp:!0})),D.value.category&&(N=N.filter(b=>b.category===D.value.category)),D.value.event&&(N=N.filter(b=>b.event===D.value.event)),D.value.ip&&(N=N.filter(b=>b.ip&&b.ip.includes(D.value.ip))),D.value.status&&(N=N.filter(b=>D.value.status==="error"?b.category==="errors":D.value.status==="success"?b.category!=="errors":!0)),D.value.dateFrom&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]>=D.value.dateFrom:!1)),D.value.dateTo&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).toISOString().split("T")[0]<=D.value.dateTo:!1)),D.value.hour!==null&&(N=N.filter(b=>b.timestamp?new Date(b.timestamp).getHours()===D.value.hour:!1)),N});Me(U,N=>{f.value&&T.value&&f.value.setResultsCount(N.length)});const G=async()=>{try{await kt.init();const N=await kt.getCurrentUser();if(console.log("[WebhookLogsPage] User data:",N),!N||!N.ID){console.warn("[WebhookLogsPage] User not determined"),n.value=u({error:"User not determined",userId:N?.ID||null,userName:N?`${N.NAME||""} ${N.LAST_NAME||""}`.trim():null}),t.value=!1;return}const b=N?.UF_DEPARTMENT||[];if(console.log("[WebhookLogsPage] User departments:",b),console.log("[WebhookLogsPage] Allowed departments:",Nt.allowedDepartmentIds),b.length>0){const O=b.some(Q=>Ca(Q));console.log("[WebhookLogsPage] Has access:",O),t.value=O,O||(n.value=u({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:b,allowedDepartments:Nt.allowedDepartmentIds,message:"User departments do not match allowed departments"}))}else console.warn("[WebhookLogsPage] User has no departments"),n.value=u({userId:N.ID,userName:`${N.NAME||""} ${N.LAST_NAME||""}`.trim(),userDepartments:[],allowedDepartments:Nt.allowedDepartmentIds,message:"User has no departments assigned"}),t.value=!1}catch(N){console.error("[WebhookLogsPage] Error checking access:",N),n.value=u({error:N.message,stack:N.stack}),t.value=!1}},q=M(()=>Nt.allowedDepartmentIds.join(", ")),oe=async(N=!1)=>{if(t.value&&!(Z&&!N)){Z=!0,r.value=!0,i.value=null;try{const b=new Date().toISOString().split("T")[0],O={category:D.value.category||null,event:D.value.event||null,date:D.value.dateFrom||b,hour:D.value.hour!==null&&D.value.hour!==void 0?D.value.hour:null,ip:D.value.ip||null,status:D.value.status||null,dateFrom:D.value.dateFrom||b,dateTo:D.value.dateTo||null};if(!Ps(O))throw new Error("Некорректные параметры фильтрации");console.log("[WebhookLogsPage] Loading logs with filters:",O);const Q=await ua.getLogs(O,B.value.page,B.value.limit,N);if(console.log("[WebhookLogsPage] API result:",Q),console.log("[WebhookLogsPage] Logs count:",Q?.logs?.length||0),console.log("[WebhookLogsPage] Pagination:",Q?.pagination),!Q.success)throw new Error(Q.error||"Ошибка загрузки логов");Ww(Q.pagination)?B.value=Q.pagination:(console.warn("[WebhookLogsPage] Invalid pagination format, using defaults"),B.value={page:B.value.page,limit:B.value.limit,total:Q.logs.length,pages:Math.ceil(Q.logs.length/B.value.limit)});const ue=Vs(Q.logs),ke=ue.filter(_e=>gt(_e));ke.length!==ue.length&&console.warn("[WebhookLogsPage] Filtered out invalid logs:",ue.length-ke.length),l.value=ke,N&&e("Логи обновлены")}catch(b){Y(b)}finally{r.value=!1,Z=!1}}},Y=N=>{console.error("[WebhookLogsPage] API Error:",N),N.status===403?(i.value="Доступ запрещён",s("У вас нет доступа к логам вебхуков")):N.status===404?(i.value="Логи не найдены",s("Логи для указанных фильтров не найдены")):N.status>=500?(i.value="Ошибка сервера",s("Произошла ошибка на сервере. Попробуйте позже.")):(i.value=N.message||"Неизвестная ошибка",s(i.value)),N.status>=500&&(l.value=[])},H=N=>{T.value=N,E({search:N||null})};let Z=!1;const fe=N=>{if(!Ps(N)){s("Некорректные параметры фильтрации");return}const b={category:D.value.category,event:D.value.event,dateFrom:D.value.dateFrom,dateTo:D.value.dateTo,hour:D.value.hour,ip:D.value.ip,status:D.value.status},O={category:N?.category||null,event:N?.event||null,dateFrom:N?.dateFrom||null,dateTo:N?.dateTo||null,hour:N?.hour!==void 0?N.hour:null,ip:N?.ip||null,status:N?.status||null},Q=Object.keys(O).some(ue=>{const ke=b[ue],_e=O[ue];return ke!==_e});if(!(!Q&&!Z)){if(E(O),B.value.page=1,Q)try{ua.invalidateCacheOnFilterChange(b,O)}catch(ue){console.error("[WebhookLogsPage] Error invalidating cache:",ue)}Z||(Z=!0,oe(!0).finally(()=>{Z=!1}))}},L=()=>{P(),T.value="",B.value.page=1,oe()},h=N=>{m.value=N},w=()=>{m.value=null},R=N=>{B.value.page=N,oe()},re=()=>{try{o.push("/")}catch(N){console.error("Navigation error:",N),window.location.hash="#/"}},le=N=>{v.value=N},ae=N=>{console.log("Экспорт начат:",N)},ge=N=>{console.log("Экспорт завершён:",N),e(`Экспорт завершён: ${N.count} записей в файле ${N.filename}`)},Se=N=>{console.error("Ошибка экспорта:",N),s(`Ошибка экспорта: ${N.message||"Неизвестная ошибка"}`)},$e=()=>{T.value="",L()},Ne=N=>{if(console.log("[WebhookLogsPage] Toggle auto-update:",N),p.value=N,N){let b=null;if(l.value.length>0){const O=l.value[0];O.timestamp&&(b=O.timestamp,console.log("[WebhookLogsPage] Using lastTimestamp:",b))}_({lastTimestamp:b})}else A()},Fe=()=>{W(l.value),e("Новые события применены")},z=()=>{x()};return Ae(async()=>{await G(),t.value&&(D.value.search&&(T.value=D.value.search),await oe())}),{hasAccess:t,loading:r,error:i,logs:l,filteredLogs:U,selectedLog:m,selectedLogs:v,filters:D,searchQuery:T,searchComponent:f,pagination:B,previousPeriodStats:k,handleFiltersUpdate:fe,handleFiltersReset:L,handleSearch:H,handleLogSelect:h,handleLogClose:w,handlePageChange:R,handleSelectedLogsUpdate:le,handleExportStart:ae,handleExportComplete:ge,handleExportError:Se,handleClearSearch:$e,autoUpdateEnabled:p,connectionState:S,newLogsCount:C,realtimeError:y,handleToggleAutoUpdate:Ne,handleApplyNewLogs:Fe,handleDismissNewLogs:z,allowedDepartmentsText:q,accessDebugInfo:n,goBack:re}}},TS={class:"webhook-logs-page"},SS={class:"page-header"},DS={class:"page-header-top"},ES={key:0,class:"access-denied"},AS={class:"access-denied-content"},$S={class:"access-hint"},IS={key:0,class:"access-debug"},MS={key:1,class:"page-content"},NS={class:"actions-bar"};function xS(o,e,s,t,r,i){const n=be("WebhookLogsDashboard"),l=be("WebhookLogsExport"),u=be("WebhookLogSearch"),m=be("RealtimeControls"),v=be("NewLogsIndicator"),T=be("WebhookLogFilters"),f=be("SkeletonLogList"),k=be("WebhookLogList"),p=be("EmptyState"),S=be("ErrorDisplay"),C=be("WebhookLogDetails"),y=be("NotificationContainer");return c(),d("div",TS,[a("div",SS,[a("div",DS,[a("button",{onClick:e[0]||(e[0]=(..._)=>t.goBack&&t.goBack(..._)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[3]||(e[3]=[a("span",{class:"back-icon","aria-hidden":"true"},"←",-1),a("span",{class:"back-text"},"Назад",-1)])])]),e[4]||(e[4]=a("h1",null,"Логи вебхуков Bitrix24",-1))]),t.hasAccess?(c(),d("div",MS,[ne(n,{logs:t.logs,pagination:t.pagination,"previous-period-stats":t.previousPeriodStats},null,8,["logs","pagination","previous-period-stats"]),a("div",NS,[ne(l,{logs:t.filteredLogs,"selected-logs":t.selectedLogs,filters:t.filters,"total-count":t.filteredLogs.length,onExportStart:t.handleExportStart,onExportComplete:t.handleExportComplete,onExportError:t.handleExportError},null,8,["logs","selected-logs","filters","total-count","onExportStart","onExportComplete","onExportError"]),ne(u,{modelValue:t.searchQuery,"onUpdate:modelValue":e[1]||(e[1]=_=>t.searchQuery=_),onSearch:t.handleSearch,ref:"searchComponent"},null,8,["modelValue","onSearch"])]),ne(m,{enabled:t.autoUpdateEnabled,"connection-state":t.connectionState,error:t.realtimeError,onToggle:t.handleToggleAutoUpdate},null,8,["enabled","connection-state","error","onToggle"]),ne(v,{count:t.newLogsCount,onApply:t.handleApplyNewLogs,onDismiss:t.handleDismissNewLogs},null,8,["count","onApply","onDismiss"]),ne(T,{filters:t.filters,"onUpdate:filters":t.handleFiltersUpdate,onReset:t.handleFiltersReset},null,8,["filters","onUpdate:filters","onReset"]),ne(Ee,{name:"fade"},{default:pe(()=>[t.loading&&t.logs.length===0?(c(),he(f,{key:0,rows:5})):$("",!0)]),_:1}),ne(Ee,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length>0?(c(),he(k,{key:0,logs:t.filteredLogs,loading:!1,error:null,pagination:t.pagination,"selected-logs":t.selectedLogs,onSelectLog:t.handleLogSelect,onPageChange:t.handlePageChange,"onUpdate:selectedLogs":t.handleSelectedLogsUpdate},null,8,["logs","pagination","selected-logs","onSelectLog","onPageChange","onUpdate:selectedLogs"])):$("",!0)]),_:1}),ne(Ee,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length===0?(c(),he(p,{key:0,icon:"📭",title:"Логи не найдены",description:"Логи вебхуков пока отсутствуют. Они появятся здесь после получения событий от Bitrix24.",hints:["Проверьте фильтры по категории и типу события","Убедитесь, что выбран правильный период","Попробуйте очистить все фильтры"],"action-label":"Очистить фильтры",onAction:t.handleFiltersReset},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ee,{name:"fade"},{default:pe(()=>[!t.loading&&t.filteredLogs.length===0&&!t.error&&t.logs.length>0?(c(),he(p,{key:0,icon:"🔍",title:"Ничего не найдено",description:"По вашему запросу ничего не найдено. Попробуйте изменить параметры поиска или фильтры.",hints:["Проверьте правильность написания поискового запроса","Попробуйте использовать другие фильтры","Очистите поиск и попробуйте снова"],"action-label":"Очистить поиск",onAction:t.handleClearSearch},null,8,["onAction"])):$("",!0)]),_:1}),ne(Ee,{name:"fade"},{default:pe(()=>[t.error?(c(),he(S,{key:0,title:"Ошибка загрузки логов",message:t.error,retryable:!0,onRetry:o.loadLogs},null,8,["message","onRetry"])):$("",!0)]),_:1}),t.selectedLog?(c(),d("div",{key:0,class:"modal-overlay",onClick:e[2]||(e[2]=(..._)=>t.handleLogClose&&t.handleLogClose(..._))})):$("",!0),ne(Ee,{name:"modal"},{default:pe(()=>[t.selectedLog?(c(),he(C,{key:0,log:t.selectedLog,onClose:t.handleLogClose},null,8,["log","onClose"])):$("",!0)]),_:1})])):(c(),d("div",ES,[a("div",AS,[e[7]||(e[7]=a("h2",null,"Доступ запрещён",-1)),e[8]||(e[8]=a("p",null,"У вас нет доступа к просмотру логов вебхуков.",-1)),a("p",$S,[e[5]||(e[5]=ce(" Доступ разрешён только пользователям из отделов: ",-1)),a("strong",null,g(t.allowedDepartmentsText),1)]),e[9]||(e[9]=a("p",{class:"access-hint"}," Если вы считаете, что у вас должен быть доступ, обратитесь к администратору системы. ",-1)),t.accessDebugInfo?(c(),d("details",IS,[e[6]||(e[6]=a("summary",null,"Отладочная информация",-1)),a("pre",null,g(t.accessDebugInfo),1)])):$("",!0)])])),ne(y)])}const PS=de(CS,[["render",xS],["__scopeId","data-v-628bf174"]]),LS={name:"DrillDownNavigation",props:{breadcrumbs:{type:Array,default:()=>[],validator:o=>Array.isArray(o)&&o.every(e=>typeof e=="object"&&typeof e.id=="string"&&typeof e.label=="string")},separator:{type:String,default:">"},showBackButton:{type:Boolean,default:!0},additionalActions:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},maxLabelLength:{type:Number,default:30}},emits:["navigate","back","action"],setup(o,{emit:e}){const s=M(()=>o.breadcrumbs.map(u=>({...u,label:r(u.label,o.maxLabelLength)}))),t=M(()=>{const u=s.value;return u.length<=5?u:[u[0],{id:"ellipsis-start",label:"...",isEllipsis:!0},...u.slice(-3)]}),r=(u,m)=>u.length<=m?u:u.substring(0,m-3)+"...";return{visibleBreadcrumbs:t,handleNavigate:u=>{u.action&&e("navigate",u)},handleBack:()=>{e("back")},handleAction:u=>{e("action",u)}}}},OS={class:"drilldown-navigation",role:"navigation","aria-label":"Навигация по разделам управления пользователями"},BS={class:"breadcrumb-list"},RS={key:0,class:"breadcrumb-separator","aria-hidden":"true"},WS=["onClick","onKeydown","aria-label","title"],US={class:"breadcrumb-text"},FS={key:2,class:"breadcrumb-current-text","aria-current":"page"},HS={class:"breadcrumb-text"},jS={key:3,class:"breadcrumb-loading","aria-label":"Загрузка данных"},VS=["aria-label","title"],zS={key:1,class:"breadcrumb-actions"},GS=["onClick","onKeydown","aria-label","title","disabled"],KS={key:1,class:"action-text"};function qS(o,e,s,t,r,i){return c(),d("nav",OS,[a("ol",BS,[(c(!0),d(ee,null,te(s.breadcrumbs,(n,l)=>(c(),d("li",{key:n.id,class:X(["breadcrumb-item",{"breadcrumb-current":l===s.breadcrumbs.length-1,"breadcrumb-interactive":l<s.breadcrumbs.length-1}])},[l>0?(c(),d("span",RS,g(s.separator),1)):$("",!0),l<s.breadcrumbs.length-1&&n.action?(c(),d("button",{key:1,class:"breadcrumb-link",onClick:u=>t.handleNavigate(n),onKeydown:[Oe(u=>t.handleNavigate(n),["enter"]),Oe(u=>t.handleNavigate(n),["space"])],"aria-label":`Перейти к разделу ${n.label}`,title:`Вернуться к ${n.label}`},[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),a("span",US,g(n.label),1)],40,WS)):(c(),d("span",FS,[n.icon?(c(),he(wt(n.icon),{key:0,class:"breadcrumb-icon","aria-hidden":"true"})):$("",!0),a("span",HS,g(n.label),1)])),l===s.breadcrumbs.length-1&&s.isLoading?(c(),d("div",jS,[...e[3]||(e[3]=[a("div",{class:"loading-spinner","aria-hidden":"true"},null,-1)])])):$("",!0)],2))),128))]),s.showBackButton&&s.breadcrumbs.length>1?(c(),d("button",{key:0,class:"back-button",onClick:e[0]||(e[0]=(...n)=>t.handleBack&&t.handleBack(...n)),onKeydown:[e[1]||(e[1]=Oe((...n)=>t.handleBack&&t.handleBack(...n),["enter"])),e[2]||(e[2]=Oe((...n)=>t.handleBack&&t.handleBack(...n),["space"]))],"aria-label":`Вернуться к ${s.breadcrumbs[s.breadcrumbs.length-2]?.label||"предыдущему разделу"}`,title:`Вернуться к ${s.breadcrumbs[s.breadcrumbs.length-2]?.label||"предыдущему разделу"}`},[...e[4]||(e[4]=[a("svg",{class:"back-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1),a("span",{class:"back-text"},"Назад",-1)])],40,VS)):$("",!0),s.additionalActions.length>0?(c(),d("div",zS,[(c(!0),d(ee,null,te(s.additionalActions,n=>(c(),d("button",{key:n.id,class:X(["action-button",n.class]),onClick:l=>t.handleAction(n),onKeydown:[Oe(l=>t.handleAction(n),["enter"]),Oe(l=>t.handleAction(n),["space"])],"aria-label":n.label,title:n.title||n.label,disabled:n.disabled},[n.icon?(c(),he(wt(n.icon),{key:0,class:"action-icon","aria-hidden":"true"})):$("",!0),n.text?(c(),d("span",KS,g(n.text),1)):$("",!0)],42,GS))),128))])):$("",!0)])}const YS=de(LS,[["render",qS],["__scopeId","data-v-e0da3deb"]]),XS={name:"MetricCard",emits:["click"],props:{metric:{type:Object,default:()=>({})},title:{type:String,required:!0},value:{type:[Number,String],required:!0},unit:{type:String,default:""},subtitle:{type:String,default:""},icon:{type:String,default:""},trend:{type:Number,default:null},trendPeriod:{type:String,default:""},progress:{type:Number,default:null},size:{type:String,default:"medium",validator:o=>["small","medium","large","compact"].includes(o)},interactive:{type:Boolean,default:!1}},computed:{formattedValue(){return typeof this.value=="number"?this.value>=1e6?`${(this.value/1e6).toFixed(1)}M`:this.value>=1e3?`${(this.value/1e3).toFixed(1)}K`:this.value.toLocaleString():this.value}}},JS={class:"metric-header"},ZS=["innerHTML"],QS={class:"metric-title"},eD={class:"metric-value-section"},tD={class:"metric-value"},sD={key:0,class:"metric-unit"},aD={key:0,class:"metric-subtitle"},oD={key:1,class:"metric-trend"},nD={class:"trend-indicator"},rD={key:0,viewBox:"0 0 24 24",width:"12",height:"12"},iD={key:1,viewBox:"0 0 24 24",width:"12",height:"12"},lD={key:2,viewBox:"0 0 24 24",width:"12",height:"12"},cD={class:"trend-value"},dD={class:"trend-period"},uD={key:2,class:"metric-progress"},mD={class:"progress-bar"},gD={class:"progress-text"};function hD(o,e,s,t,r,i){return c(),d("div",{class:X(["metric-card",{[`size-${s.size}`]:!0,"has-trend":s.trend!==null,"trend-up":s.trend>0,"trend-down":s.trend<0,"trend-neutral":s.trend===0,interactive:s.interactive}]),onClick:e[0]||(e[0]=n=>s.interactive?o.$emit("click",s.metric):null)},[a("div",JS,[s.icon?(c(),d("div",{key:0,class:"metric-icon",innerHTML:s.icon},null,8,ZS)):$("",!0),a("div",QS,g(s.title),1)]),a("div",eD,[a("div",tD,g(i.formattedValue),1),s.unit?(c(),d("div",sD,g(s.unit),1)):$("",!0)]),s.subtitle?(c(),d("div",aD,g(s.subtitle),1)):$("",!0),s.trend!==null?(c(),d("div",oD,[a("div",nD,[s.trend>0?(c(),d("svg",rD,[...e[1]||(e[1]=[a("path",{d:"M7 14l5-5 5 5z",fill:"currentColor"},null,-1)])])):s.trend<0?(c(),d("svg",iD,[...e[2]||(e[2]=[a("path",{d:"M7 10l5 5 5-5z",fill:"currentColor"},null,-1)])])):(c(),d("svg",lD,[...e[3]||(e[3]=[a("path",{d:"M7 12h10v-2H7z",fill:"currentColor"},null,-1)])]))]),a("span",cD,g(Math.abs(s.trend))+"%",1),a("span",dD,g(s.trendPeriod||"vs prev"),1)])):$("",!0),s.progress!==null?(c(),d("div",uD,[a("div",mD,[a("div",{class:"progress-fill",style:we({width:`${Math.min(s.progress,100)}%`})},null,4)]),a("span",gD,g(s.progress)+"%",1)])):$("",!0)],2)}const fD=de(XS,[["render",hD],["__scopeId","data-v-b8d66bef"]]),vD={name:"ContextSidebar",components:{MetricCard:fD},props:{context:{type:String,default:"global",validator:o=>["global","user","management"].includes(o)},selectedUser:{type:Object,default:null},selectedUsers:{type:Array,default:()=>[]},globalMetrics:{type:Array,default:()=>[]},userStats:{type:Object,default:()=>({})},userFilters:{type:Object,default:()=>({timeRange:"week",activity_types:[]})},filterPresets:{type:Array,default:()=>[]},activePreset:{type:String,default:null},recentActivity:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},activityTypes:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},collapsed:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},emits:["toggle-collapse","metric-click","filter-preset-apply","activity-click","filter-change","view-profile","export-data","edit-permissions","bulk-action","user-select"],setup(o,{emit:e}){const s=I(o.collapsed),t=M(()=>{if(!o.selectedUser?.name)return"";const[A,W]=o.selectedUser.name.split(" ");return`${A?.[0]||""}${W?.[0]||""}`.toUpperCase()}),r=()=>{s.value=!s.value,e("toggle-collapse",s.value)},i=()=>{switch(o.context){case"global":return"Обзор";case"user":return"Анализ пользователя";case"management":return"Управление";default:return"Обзор"}},n=()=>`${i()} - боковая панель с дополнительной информацией`,l=A=>{switch(A){case"online":return"Онлайн";case"away":return"Отошёл";case"offline":return"Оффлайн";default:return"Неизвестно"}},u=A=>{if(!A)return"";const[W,x]=A.split(" ");return`${W?.[0]||""}${x?.[0]||""}`.toUpperCase()},m=A=>{const W=Math.floor(A/60),x=A%60;return`${W}:${x.toString().padStart(2,"0")}`},v=A=>{const W=new Date(A),D=new Date-W,E=Math.floor(D/(1e3*60)),P=Math.floor(D/(1e3*60*60)),B=Math.floor(D/(1e3*60*60*24));return E<1?"только что":E<60?`${E} мин назад`:P<24?`${P} ч назад`:B<7?`${B} д назад`:W.toLocaleDateString()},T=A=>{e("metric-click",A)},f=A=>{e("filter-preset-apply",A)},k=A=>{e("activity-click",A)},p=()=>{e("filter-change",o.userFilters)},S=()=>{e("view-profile",o.selectedUser)},C=()=>{e("export-data",o.selectedUser)},y=()=>{e("edit-permissions",o.selectedUser)},_=A=>{e("bulk-action",{action:A,users:o.selectedUsers})};return Me(()=>o.collapsed,A=>{s.value=A}),{isCollapsed:s,userInitials:t,toggleCollapse:r,getContextTitle:i,getAriaLabel:n,getStatusText:l,getUserInitials:u,formatDuration:m,formatTime:v,handleMetricClick:T,applyFilterPreset:f,handleActivityClick:k,handleFilterChange:p,viewDetailedProfile:S,exportUserData:C,editPermissions:y,performBulkAction:_}}},pD=["aria-label"],yD=["aria-label","title"],kD={class:"sidebar-header"},bD={class:"context-title"},_D={key:0,class:"user-indicator"},wD={class:"user-avatar"},CD=["src","alt"],TD={key:1,class:"avatar-placeholder"},SD={class:"user-info"},DD={class:"user-name"},ED={key:0,class:"global-context-content"},AD={class:"metrics-section"},$D={class:"metrics-grid"},ID={class:"filters-section"},MD={class:"filter-presets"},ND=["onClick","aria-label"],xD={class:"preset-label"},PD={key:0,class:"preset-count"},LD={class:"recent-activity-section"},OD={class:"recent-activity-list"},BD=["onClick"],RD={class:"activity-content"},WD={class:"activity-text"},UD={class:"activity-time"},FD={key:1,class:"user-context-content"},HD={class:"user-stats-section"},jD={class:"user-stats-grid"},VD={class:"stat-item"},zD={class:"stat-value"},GD={class:"stat-item"},KD={class:"stat-value"},qD={class:"stat-item"},YD={class:"stat-value"},XD={class:"stat-item"},JD={class:"stat-value"},ZD={class:"analysis-filters-section"},QD={class:"filter-controls"},e2={class:"filter-group"},t2={class:"filter-group"},s2={class:"checkbox-group"},a2=["value"],o2={class:"user-actions-section"},n2={class:"action-buttons"},r2=["aria-label"],i2=["aria-label"],l2=["aria-label"],c2={key:2,class:"management-context-content"},d2={key:0,class:"selected-users-section"},u2={class:"section-title"},m2={class:"selected-users-list"},g2={class:"user-avatar small"},h2=["src","alt"],f2={key:1,class:"avatar-placeholder small"},v2={class:"user-name"},p2={key:0,class:"more-users"},y2={class:"bulk-operations-section"},k2={class:"bulk-actions"},b2=["disabled"],_2=["disabled"],w2=["disabled"],C2={class:"audit-log-section"},T2={class:"audit-log-list"},S2={class:"audit-content"},D2={class:"audit-text"},E2={class:"audit-time"},A2={key:0,class:"sidebar-loading-overlay"};function $2(o,e,s,t,r,i){const n=be("MetricCard");return c(),d("aside",{class:X(["context-sidebar",{collapsed:t.isCollapsed,"context-global":s.context==="global","context-user":s.context==="user","context-management":s.context==="management"}]),role:"complementary","aria-label":t.getAriaLabel()},[a("button",{class:"collapse-toggle",onClick:e[0]||(e[0]=(...l)=>t.toggleCollapse&&t.toggleCollapse(...l)),onKeydown:[e[1]||(e[1]=Oe((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["enter"])),e[2]||(e[2]=Oe((...l)=>t.toggleCollapse&&t.toggleCollapse(...l),["space"]))],"aria-label":t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель",title:t.isCollapsed?"Развернуть боковую панель":"Свернуть боковую панель"},[(c(),d("svg",{class:X(["collapse-icon",{rotated:t.isCollapsed}]),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[13]||(e[13]=[a("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"},null,-1)])],2))],40,yD),a("header",kD,[a("h3",bD,g(t.getContextTitle()),1),s.context==="user"&&s.selectedUser?(c(),d("div",_D,[a("div",wD,[s.selectedUser.avatar?(c(),d("img",{key:0,src:s.selectedUser.avatar,alt:`Аватар ${s.selectedUser.name}`},null,8,CD)):(c(),d("div",TD,g(t.userInitials),1))]),a("div",SD,[a("div",DD,g(s.selectedUser.name),1),a("div",{class:X(["user-status",s.selectedUser.status])},g(t.getStatusText(s.selectedUser.status)),3)])])):$("",!0)]),a("div",{class:X(["sidebar-content",{"content-collapsed":t.isCollapsed}])},[s.context==="global"?(c(),d("div",ED,[a("section",AD,[e[14]||(e[14]=a("h4",{class:"section-title"},"Общая статистика",-1)),a("div",$D,[(c(!0),d(ee,null,te(s.globalMetrics,l=>(c(),he(n,{key:l.id,metric:l,size:"compact",onClick:t.handleMetricClick},null,8,["metric","onClick"]))),128))])]),a("section",ID,[e[15]||(e[15]=a("h4",{class:"section-title"},"Быстрые фильтры",-1)),a("div",MD,[(c(!0),d(ee,null,te(s.filterPresets,l=>(c(),d("button",{key:l.id,class:X(["filter-preset",{active:s.activePreset===l.id}]),onClick:u=>t.applyFilterPreset(l),"aria-label":`Применить фильтр: ${l.label}`},[(c(),he(wt(l.icon),{class:"preset-icon"})),a("span",xD,g(l.label),1),l.count!==void 0?(c(),d("span",PD,g(l.count),1)):$("",!0)],10,ND))),128))])]),a("section",LD,[e[16]||(e[16]=a("h4",{class:"section-title"},"Недавние действия",-1)),a("div",OD,[(c(!0),d(ee,null,te(s.recentActivity,l=>(c(),d("div",{key:l.id,class:"activity-item",onClick:u=>t.handleActivityClick(l)},[a("div",{class:X(["activity-icon",l.type])},[(c(),he(wt(l.icon)))],2),a("div",RD,[a("div",WD,g(l.text),1),a("div",UD,g(t.formatTime(l.timestamp)),1)])],8,BD))),128))])])])):s.context==="user"?(c(),d("div",FD,[a("section",HD,[e[21]||(e[21]=a("h4",{class:"section-title"},"Статистика пользователя",-1)),a("div",jD,[a("div",VD,[a("div",zD,g(s.userStats.total_actions||0),1),e[17]||(e[17]=a("div",{class:"stat-label"},"действий",-1)),s.userStats.actions_change!==0?(c(),d("div",{key:0,class:X(["stat-change",{positive:s.userStats.actions_change>0,negative:s.userStats.actions_change<0}])},g(s.userStats.actions_change>0?"+":"")+g(s.userStats.actions_change)+"% ",3)):$("",!0)]),a("div",GD,[a("div",KD,g(t.formatDuration(s.userStats.avg_session_duration||0)),1),e[18]||(e[18]=a("div",{class:"stat-label"},"средняя сессия",-1))]),a("div",qD,[a("div",YD,g(s.userStats.total_sessions||0),1),e[19]||(e[19]=a("div",{class:"stat-label"},"сессий",-1))]),a("div",XD,[a("div",JD,g(s.userStats.activity_score||0)+"/100",1),e[20]||(e[20]=a("div",{class:"stat-label"},"активность",-1))])])]),a("section",ZD,[e[26]||(e[26]=a("h4",{class:"section-title"},"Фильтры анализа",-1)),a("div",QD,[a("div",e2,[e[23]||(e[23]=a("label",{class:"filter-label"},"Период:",-1)),Le(a("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>s.userFilters.timeRange=l),class:"filter-select",onChange:e[4]||(e[4]=(...l)=>t.handleFilterChange&&t.handleFilterChange(...l))},[...e[22]||(e[22]=[_t('<option value="today" data-v-abccaced>Сегодня</option><option value="week" data-v-abccaced>Неделя</option><option value="month" data-v-abccaced>Месяц</option><option value="quarter" data-v-abccaced>Квартал</option><option value="year" data-v-abccaced>Год</option>',5)])],544),[[dt,s.userFilters.timeRange]])]),a("div",t2,[e[25]||(e[25]=a("label",{class:"filter-label"},"Типы действий:",-1)),a("div",s2,[(c(!0),d(ee,null,te(s.activityTypes,l=>(c(),d("label",{key:l.id,class:"checkbox-label"},[Le(a("input",{type:"checkbox",value:l.id,"onUpdate:modelValue":e[5]||(e[5]=u=>s.userFilters.activity_types=u),onChange:e[6]||(e[6]=(...u)=>t.handleFilterChange&&t.handleFilterChange(...u))},null,40,a2),[[ys,s.userFilters.activity_types]]),e[24]||(e[24]=a("span",{class:"checkmark"},null,-1)),ce(" "+g(l.label),1)]))),128))])])])]),a("section",o2,[e[30]||(e[30]=a("h4",{class:"section-title"},"Действия",-1)),a("div",n2,[a("button",{class:"action-button primary",onClick:e[7]||(e[7]=(...l)=>t.viewDetailedProfile&&t.viewDetailedProfile(...l)),"aria-label":`Просмотреть детальный профиль ${s.selectedUser?.name}`},[...e[27]||(e[27]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.6C18.8 6 18.5 5.4 18.1 4.9L19 3L17 1L15.4 1.9C14.9 1.5 14.3 1.2 13.7 1L13 0V2C12.4 2 11.8 2.2 11.3 2.6L10.6 1.9L8.6 3L9.5 4.9C9.1 5.4 8.8 6 8.6 6.6L7 7V9L8.6 8.4C8.8 9 9.1 9.6 9.5 10.1L8.6 12L10.6 13.9L11.3 13.2C11.8 13.6 12.4 13.8 13 14V16H11V18H13V20H11V22H13V20H15V18H13V16H15V14C15.6 14 16.2 13.6 16.7 13.2L17.4 13.9L19.4 12L18.5 10.1C18.9 9.6 19.2 9 19.4 8.4L21 9ZM12 8C10.9 8 10 7.1 10 6C10 4.9 10.9 4 12 4C13.1 4 14 4.9 14 6C14 7.1 13.1 8 12 8Z"})],-1),ce(" Детальный профиль ",-1)])],8,r2),a("button",{class:"action-button secondary",onClick:e[8]||(e[8]=(...l)=>t.exportUserData&&t.exportUserData(...l)),"aria-label":`Экспортировать данные ${s.selectedUser?.name}`},[...e[28]||(e[28]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ce(" Экспорт данных ",-1)])],8,i2),s.canEditPermissions?(c(),d("button",{key:0,class:"action-button warning",onClick:e[9]||(e[9]=(...l)=>t.editPermissions&&t.editPermissions(...l)),"aria-label":`Изменить права ${s.selectedUser?.name}`},[...e[29]||(e[29]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить права ",-1)])],8,l2)):$("",!0)])])])):s.context==="management"?(c(),d("div",c2,[s.selectedUsers.length>0?(c(),d("section",d2,[a("h4",u2,"Выбрано пользователей: "+g(s.selectedUsers.length),1),a("div",m2,[(c(!0),d(ee,null,te(s.selectedUsers.slice(0,3),l=>(c(),d("div",{key:l.id,class:"selected-user-item"},[a("div",g2,[l.avatar?(c(),d("img",{key:0,src:l.avatar,alt:l.name},null,8,h2)):(c(),d("div",f2,g(t.getUserInitials(l.name)),1))]),a("span",v2,g(l.name),1)]))),128)),s.selectedUsers.length>3?(c(),d("div",p2," +"+g(s.selectedUsers.length-3)+" ещё ",1)):$("",!0)])])):$("",!0),a("section",y2,[e[34]||(e[34]=a("h4",{class:"section-title"},"Массовые операции",-1)),a("div",k2,[a("button",{class:"bulk-action-button",onClick:e[10]||(e[10]=l=>t.performBulkAction("change_department")),disabled:s.selectedUsers.length===0},[...e[31]||(e[31]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить отдел ",-1)])],8,b2),a("button",{class:"bulk-action-button",onClick:e[11]||(e[11]=l=>t.performBulkAction("toggle_admin")),disabled:s.selectedUsers.length===0},[...e[32]||(e[32]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,6V8H13V6H11M11,10V18H13V10H11Z"})],-1),ce(" Изменить права администратора ",-1)])],8,_2),a("button",{class:"bulk-action-button",onClick:e[12]||(e[12]=l=>t.performBulkAction("export")),disabled:s.selectedUsers.length===0},[...e[33]||(e[33]=[a("svg",{class:"action-icon",viewBox:"0 0 24 24"},[a("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1),ce(" Экспорт ",-1)])],8,w2)])]),a("section",C2,[e[35]||(e[35]=a("h4",{class:"section-title"},"Последние изменения",-1)),a("div",T2,[(c(!0),d(ee,null,te(s.auditLog.slice(0,5),l=>(c(),d("div",{key:l.id,class:"audit-entry"},[a("div",{class:X(["audit-icon",l.type])},[(c(),he(wt(l.icon)))],2),a("div",S2,[a("div",D2,g(l.text),1),a("div",E2,g(t.formatTime(l.timestamp)),1)])]))),128))])])])):$("",!0)],2),s.isLoading?(c(),d("div",A2,[...e[36]||(e[36]=[a("div",{class:"loading-spinner","aria-label":"Загрузка данных"},null,-1)])])):$("",!0)],10,pD)}const I2=de(vD,[["render",$2],["__scopeId","data-v-abccaced"]]),ga=o=>new Date(o),M2=(o,e,s={})=>{const t=new Date(o),r=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return e.replace("yyyy",r).replace("MM",i).replace("dd",n)},N2={name:"UnifiedUserCard",props:{user:{type:Object,required:!0,validator:o=>o&&typeof o=="object"&&o.id&&o.name&&o.email},isSelected:{type:Boolean,default:!1},showExtendedMetrics:{type:Boolean,default:!1},compactView:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1},canDelete:{type:Boolean,default:!1},maxDepartments:{type:Number,default:2}},emits:["select","view-profile","edit-permissions","toggle-hidden","view-analytics","export-data","send-notification","view-audit","delete-user"],setup(o,{emit:e}){const s=I(!1),t=I(null),r=M(()=>{const[L,h]=o.user.name.split(" ");return`${L?.[0]||""}${h?.[0]||""}`.toUpperCase()}),i=M(()=>{const L=["#2196F3","#4CAF50","#FF9800","#F44336","#9C27B0","#00BCD4","#8BC34A","#FFC107","#E91E63","#3F51B5"];return L[Math.abs(o.user.id)%L.length]}),n=M(()=>(o.user.departments||[]).slice(0,o.maxDepartments).map(h=>({...h,shortName:h.name.length>10?h.name.substring(0,8)+"...":h.name}))),l=M(()=>{const L=o.user.departments||[];return Math.max(0,L.length-o.maxDepartments)}),u=M(()=>{const L=o.user.activity_stats?.total_actions||0;return L>=1e6?`${(L/1e6).toFixed(1)}M`:L>=1e3?`${(L/1e3).toFixed(1)}K`:L.toLocaleString()}),m=M(()=>{const L=o.user.activity_stats?.total_sessions||0;return L>=1e3?`${(L/1e3).toFixed(1)}K`:L.toString()}),v=M(()=>{const L=o.user.activity_stats?.avg_session_duration||0,h=Math.floor(L/60),w=Math.floor(L%60);return`${h}:${w.toString().padStart(2,"0")}`}),T=M(()=>{const L=o.user.activity_stats?.last_activity;if(!L)return"Никогда";let h;try{h=typeof L=="string"?ga(L):new Date(L)}catch{return"Неизвестно"}const R=new Date-h,re=Math.floor(R/(1e3*60*60*24)),le=Math.floor(R/(1e3*60*60)),ae=Math.floor(R/(1e3*60));return ae<1?"только что":ae<60?`${ae} мин`:le<24?`${le} ч`:re<7?`${re} д`:re<30?`${Math.floor(re/7)} нед`:M2(h,"dd.MM.yyyy")}),f=M(()=>Math.min(100,Math.max(0,o.user.activity_stats?.activity_score||0))),k=M(()=>o.user.activity_stats?.actions_change_percent||0),p=M(()=>o.user.status||"offline"),S=M(()=>!!o.user.is_admin),C=M(()=>{if(!o.user.created_at)return!1;try{const L=typeof o.user.created_at=="string"?ga(o.user.created_at):new Date(o.user.created_at);return Math.floor((new Date-L)/(1e3*60*60*24))<=7}catch{return!1}}),y=M(()=>!!o.user.is_hidden),_=M(()=>o.user.name||"Неизвестный пользователь"),A=M(()=>o.user.email||""),W=M(()=>o.user.avatar||null),x=()=>{e("select",o.user)},D=()=>{e("view-profile",o.user)},E=()=>{e("edit-permissions",o.user)},P=()=>{e("toggle-hidden",o.user)},B=()=>{s.value=!0;const L=h=>{t.value&&!t.value.contains(h.target)&&(s.value=!1,document.removeEventListener("click",L))};setTimeout(()=>{document.addEventListener("click",L)},0)},U=()=>{s.value=!1,e("view-analytics",o.user)},G=()=>{s.value=!1,e("export-data",o.user)},q=()=>{s.value=!1,e("send-notification",o.user)},oe=()=>{s.value=!1,e("view-audit",o.user)},Y=()=>{s.value=!1,confirm(`Вы уверены, что хотите удалить пользователя ${o.user.name}?`)&&e("delete-user",o.user)},H=()=>{console.warn(`Failed to load avatar for user ${o.user.id}`)},Z=L=>{switch(L){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},fe=L=>{if(L.key==="Enter"||L.key===" ")L.preventDefault(),x();else if(L.key==="ArrowDown"){L.preventDefault();const h=L.target.nextElementSibling;h&&h.focus()}else if(L.key==="ArrowUp"){L.preventDefault();const h=L.target.previousElementSibling;h&&h.focus()}};return Ae(()=>{const L=document.querySelector(`[data-user-id="${o.user.id}"]`);L&&L.addEventListener("keydown",fe)}),st(()=>{const L=document.querySelector(`[data-user-id="${o.user.id}"]`);L&&L.removeEventListener("keydown",fe)}),{showContextMenuFlag:s,contextMenuRef:t,userInitials:r,avatarColor:i,visibleDepartments:n,hiddenDepartmentsCount:l,totalActionsFormatted:u,totalSessionsFormatted:m,avgSessionDurationFormatted:v,lastActivityFormatted:T,activityScore:f,actionsChange:k,userStatus:p,isAdmin:S,isNew:C,isHidden:y,userName:_,userEmail:A,userAvatar:W,handleSelect:x,viewProfile:D,editPermissions:E,toggleHidden:P,showContextMenu:B,viewDetailedAnalytics:U,exportUserData:G,sendNotification:q,viewAuditLog:oe,deleteUser:Y,handleAvatarError:H,getStatusText:Z}}},x2=["aria-label","aria-selected","aria-describedby"],P2={class:"user-avatar-section"},L2={class:"avatar-container"},O2=["src","alt"],B2=["title"],R2={key:2,class:"new-indicator",title:"Новый пользователь"},W2={class:"user-info-section"},U2={class:"user-header"},F2={class:"user-name"},H2={class:"user-badges"},j2={key:0,class:"badge admin",title:"Администратор"},V2={key:1,class:"badge hidden",title:"Скрытый пользователь"},z2={class:"user-email"},G2={key:0,class:"user-departments"},K2=["title"],q2=["title"],Y2={class:"user-metrics-section"},X2={class:"metric primary"},J2={class:"metric-value"},Z2=["title"],Q2={class:"metric secondary"},eE={class:"metric-value"},tE={key:0,class:"activity-score"},sE={class:"score-bar"},aE=["title"],oE={key:1,class:"mini-metrics"},nE={class:"mini-metric"},rE={class:"mini-metric"},iE={class:"user-actions-section"},lE=["aria-label","title"],cE=["aria-label","title"],dE=["aria-label","title"],uE=["aria-label"],mE=["aria-label"],gE=["aria-label"],hE=["aria-label"],fE=["aria-label"],vE=["aria-label"],pE=["aria-label"],yE=["id"],kE={key:1,class:"selection-indicator","aria-hidden":"true"};function bE(o,e,s,t,r,i){return c(),d("div",{class:X(["unified-user-card",{selected:s.isSelected,"activity-high":t.activityScore>=80,"activity-medium":t.activityScore>=50&&t.activityScore<80,"activity-low":t.activityScore<50,"status-online":t.userStatus==="online","status-away":t.userStatus==="away","status-offline":t.userStatus==="offline","has-departments":t.visibleDepartments.length>0,"is-admin":t.isAdmin,"is-new":t.isNew,"is-hidden":t.isHidden,"compact-view":s.compactView}]),onClick:e[10]||(e[10]=(...n)=>t.handleSelect&&t.handleSelect(...n)),onDblclick:e[11]||(e[11]=(...n)=>t.viewProfile&&t.viewProfile(...n)),onKeydown:[e[12]||(e[12]=Oe((...n)=>t.handleSelect&&t.handleSelect(...n),["enter"])),e[13]||(e[13]=Oe((...n)=>t.handleSelect&&t.handleSelect(...n),["space"]))],onContextmenu:e[14]||(e[14]=Ce((...n)=>t.showContextMenu&&t.showContextMenu(...n),["prevent"])),tabindex:"0",role:"button","aria-label":`Выбрать пользователя ${t.userName}`,"aria-selected":s.isSelected,"aria-describedby":`user-card-${s.user.id}-description`},[a("div",P2,[a("div",L2,[t.userAvatar?(c(),d("img",{key:0,src:t.userAvatar,alt:`Аватар ${t.userName}`,class:"user-avatar",onError:e[0]||(e[0]=(...n)=>t.handleAvatarError&&t.handleAvatarError(...n))},null,40,O2)):(c(),d("div",{key:1,class:"avatar-placeholder",style:we({backgroundColor:t.avatarColor})},g(t.userInitials),5)),a("div",{class:X(["status-indicator",t.userStatus]),title:`Статус: ${t.getStatusText(t.userStatus)}`},null,10,B2),t.isNew?(c(),d("div",R2," NEW ")):$("",!0)])]),a("div",W2,[a("div",U2,[a("h4",F2,g(t.userName),1),a("div",H2,[t.isAdmin?(c(),d("span",j2," Админ ")):$("",!0),t.isHidden?(c(),d("span",V2," Скрыт ")):$("",!0)])]),a("p",z2,g(t.userEmail),1),t.visibleDepartments.length>0?(c(),d("div",G2,[(c(!0),d(ee,null,te(t.visibleDepartments,n=>(c(),d("span",{key:n.id,class:"dept-tag",style:we({backgroundColor:n.color}),title:n.name},g(n.shortName||n.name),13,K2))),128)),t.hiddenDepartmentsCount>0?(c(),d("span",{key:0,class:"dept-more",title:`Ещё ${t.hiddenDepartmentsCount} отделов`}," +"+g(t.hiddenDepartmentsCount),9,q2)):$("",!0)])):$("",!0)]),a("div",Y2,[a("div",X2,[a("div",J2,g(t.totalActionsFormatted),1),e[15]||(e[15]=a("div",{class:"metric-label"},"действий",-1)),t.actionsChange!==0?(c(),d("div",{key:0,class:X(["metric-change",{positive:t.actionsChange>0,negative:t.actionsChange<0}]),title:`Изменение: ${t.actionsChange>0?"+":""}${t.actionsChange}%`},g(t.actionsChange>0?"+":"")+g(t.actionsChange)+"% ",11,Z2)):$("",!0)]),a("div",Q2,[a("div",eE,g(t.lastActivityFormatted),1),e[16]||(e[16]=a("div",{class:"metric-label"},"активность",-1))]),s.compactView?$("",!0):(c(),d("div",tE,[a("div",sE,[a("div",{class:X(["score-fill",{"high-score":t.activityScore>=80,"medium-score":t.activityScore>=50&&t.activityScore<80,"low-score":t.activityScore<50}]),style:we({width:`${t.activityScore}%`})},null,6)]),a("div",{class:"score-label",title:`Уровень активности: ${t.activityScore}/100`},g(t.activityScore)+"/100 ",9,aE)])),s.compactView?(c(),d("div",oE,[a("span",nE,g(t.totalSessionsFormatted)+" сессий",1),a("span",rE,g(t.avgSessionDurationFormatted),1)])):$("",!0)]),a("div",iE,[a("button",{onClick:e[1]||(e[1]=Ce((...n)=>t.viewProfile&&t.viewProfile(...n),["stop"])),class:"action-btn primary","aria-label":`Просмотреть профиль ${t.userName}`,title:`Просмотреть профиль ${t.userName}`}," 👁️ ",8,lE),s.canEditPermissions?(c(),d("button",{key:0,onClick:e[2]||(e[2]=Ce((...n)=>t.editPermissions&&t.editPermissions(...n),["stop"])),class:"action-btn secondary","aria-label":`Изменить права ${t.userName}`,title:`Изменить права ${t.userName}`}," ⚙️ ",8,cE)):$("",!0),a("button",{onClick:e[3]||(e[3]=Ce((...n)=>t.toggleHidden&&t.toggleHidden(...n),["stop"])),class:X(["action-btn tertiary",{active:t.isHidden}]),"aria-label":`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`,title:`${t.isHidden?"Показать":"Скрыть"} пользователя ${t.userName}`},g(t.isHidden?"👁️‍🗨️":"🙈"),11,dE),a("button",{onClick:e[4]||(e[4]=Ce((...n)=>t.showContextMenu&&t.showContextMenu(...n),["stop"])),class:"action-btn menu","aria-label":`Меню действий для ${t.userName}`,title:"Дополнительные действия"}," ⋮ ",8,uE)]),t.showContextMenuFlag?(c(),d("div",{key:0,class:"context-menu",ref:"contextMenu",role:"menu","aria-label":`Меню действий для ${t.userName}`},[a("button",{onClick:e[5]||(e[5]=(...n)=>t.viewDetailedAnalytics&&t.viewDetailedAnalytics(...n)),class:"menu-item",role:"menuitem","aria-label":`Детальная аналитика для ${t.userName}`}," 📊 Детальная аналитика ",8,gE),a("button",{onClick:e[6]||(e[6]=(...n)=>t.exportUserData&&t.exportUserData(...n)),class:"menu-item",role:"menuitem","aria-label":`Экспорт данных ${t.userName}`}," 📥 Экспорт данных ",8,hE),a("button",{onClick:e[7]||(e[7]=(...n)=>t.sendNotification&&t.sendNotification(...n)),class:"menu-item",role:"menuitem","aria-label":`Отправить уведомление ${t.userName}`}," 📧 Уведомление ",8,fE),a("button",{onClick:e[8]||(e[8]=(...n)=>t.viewAuditLog&&t.viewAuditLog(...n)),class:"menu-item",role:"menuitem","aria-label":`Журнал аудита для ${t.userName}`}," 📋 Журнал аудита ",8,vE),e[17]||(e[17]=a("hr",{class:"menu-divider",role:"separator"},null,-1)),s.canDelete?(c(),d("button",{key:0,onClick:e[9]||(e[9]=(...n)=>t.deleteUser&&t.deleteUser(...n)),class:"menu-item danger",role:"menuitem","aria-label":`Удалить пользователя ${t.userName}`}," 🗑️ Удалить пользователя ",8,pE)):$("",!0)],8,mE)):$("",!0),a("div",{id:`user-card-${s.user.id}-description`,class:"sr-only"}," Пользователь "+g(t.userName)+", email "+g(t.userEmail)+", статус "+g(t.getStatusText(t.userStatus))+", "+g(t.totalActionsFormatted)+" действий, последняя активность "+g(t.lastActivityFormatted)+", уровень активности "+g(t.activityScore)+" из 100. "+g(t.isAdmin?"Администратор.":"")+" "+g(t.isHidden?"Скрытый пользователь.":"")+" "+g(t.visibleDepartments.length>0?`Отделы: ${t.visibleDepartments.map(n=>n.name).join(", ")}.`:""),9,yE),s.isSelected?(c(),d("div",kE,[...e[18]||(e[18]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16"},[a("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})],-1)])])):$("",!0)],42,x2)}const _E=de(N2,[["render",bE],["__scopeId","data-v-5e790fbc"]]),wE={name:"BulkActionsBar",emits:["execute","clear-selection"],props:{selectedUsers:{type:Array,default:()=>[]},availableActions:{type:Array,default:()=>[]}}},CE={key:0,class:"bulk-actions-bar"},TE={class:"bar-content"},SE={class:"selection-info"},DE={class:"selection-count"},EE={class:"selection-text"},AE={class:"actions-list"},$E=["onClick","title"],IE={key:0,class:"action-icon"},ME={class:"action-text"};function NE(o,e,s,t,r,i){return s.selectedUsers.length>0?(c(),d("div",CE,[a("div",TE,[a("div",SE,[a("span",DE," Выбрано: "+g(s.selectedUsers.length),1),a("span",EE,g(s.selectedUsers.length===1?"пользователь":"пользователей"),1)]),a("div",AE,[(c(!0),d(ee,null,te(s.availableActions,n=>(c(),d("button",{key:n.id,onClick:l=>o.$emit("execute",n),class:X(["action-btn",n.class]),title:n.description},[n.icon?(c(),d("span",IE,g(n.icon),1)):$("",!0),a("span",ME,g(n.label),1)],10,$E))),128))]),a("button",{onClick:e[0]||(e[0]=n=>o.$emit("clear-selection")),class:"clear-btn",title:"Очистить выбор"}," ✕ ")])])):$("",!0)}const xE=de(wE,[["render",NE],["__scopeId","data-v-56b78081"]]),PE={name:"VirtualList",emits:["item-click"],props:{items:{type:Array,default:()=>[]},itemHeight:{type:Number,default:50},containerHeight:{type:Number,default:400},bufferSize:{type:Number,default:5}},data(){return{scrollTop:0}},computed:{totalItems(){return this.items.length},totalHeight(){return this.totalItems*this.itemHeight},visibleCount(){return Math.ceil(this.containerHeight/this.itemHeight)+this.bufferSize*2},startIndex(){const o=Math.floor(this.scrollTop/this.itemHeight)-this.bufferSize;return Math.max(0,o)},endIndex(){const o=this.startIndex+this.visibleCount;return Math.min(this.totalItems,o)},visibleItems(){return this.items.slice(this.startIndex,this.endIndex)},offsetTop(){return this.startIndex*this.itemHeight},offsetBottom(){return Math.max(0,this.totalHeight-this.offsetTop-this.visibleItems.length*this.itemHeight)},listHeight(){return Math.min(this.totalHeight,this.containerHeight)}},methods:{handleScroll(o){this.scrollTop=o.target.scrollTop},getItemKey(o,e){return o.id||o.key||e},scrollToIndex(o){const e=Math.max(0,o*this.itemHeight-this.containerHeight/2);this.$refs.container?.scrollTo({top:e,behavior:"smooth"})},scrollToTop(){this.$refs.container?.scrollTo({top:0,behavior:"smooth"})},scrollToBottom(){const o=this.totalHeight-this.containerHeight;this.$refs.container?.scrollTo({top:o,behavior:"smooth"})}}},LE={class:"virtual-list-container",ref:"container"};function OE(o,e,s,t,r,i){return c(),d("div",LE,[a("div",{class:"virtual-list",style:we({height:`${i.listHeight}px`}),onScroll:e[0]||(e[0]=(...n)=>i.handleScroll&&i.handleScroll(...n))},[a("div",{class:"virtual-spacer top",style:we({height:`${i.offsetTop}px`})},null,4),(c(!0),d(ee,null,te(i.visibleItems,(n,l)=>(c(),d("div",{key:i.getItemKey(n,i.startIndex+l),class:"virtual-item"},[ha(o.$slots,"item",{item:n,index:i.startIndex+l},void 0)]))),128)),a("div",{class:"virtual-spacer bottom",style:we({height:`${i.offsetBottom}px`})},null,4)],36)],512)}const BE=de(PE,[["render",OE],["__scopeId","data-v-302c06ef"]]),RE={name:"PaginationControls",emits:["page-change","per-page-change"],props:{currentPage:{type:Number,required:!0},totalPages:{type:Number,required:!0},totalItems:{type:Number,required:!0},perPage:{type:Number,default:50},showPerPageSelector:{type:Boolean,default:!0},perPageOptions:{type:Array,default:()=>[10,25,50,100]},maxVisiblePages:{type:Number,default:7}},computed:{startItem(){return(this.currentPage-1)*this.perPage+1},endItem(){return Math.min(this.currentPage*this.perPage,this.totalItems)},visiblePages(){const o=[],e=this.totalPages,s=this.currentPage,t=this.maxVisiblePages;if(e<=t)for(let r=1;r<=e;r++)o.push(r);else{const r=Math.max(1,s-Math.floor(t/2)),i=Math.min(e,r+t-1),n=Math.max(1,i-t+1);n>1&&(o.push(1),n>2&&o.push("..."));for(let l=n;l<=i;l++)o.push(l);i<e&&(i<e-1&&o.push("..."),o.push(e))}return o}}},WE={key:0,class:"pagination-controls"},UE={class:"pagination-info"},FE={class:"pagination-text"},HE={class:"pagination-nav"},jE=["disabled"],VE=["disabled"],zE={key:0,class:"page-btn ellipsis",disabled:"","aria-hidden":"true"},GE=["onClick","aria-label","aria-current"],KE=["disabled"],qE=["disabled"],YE={key:0,class:"per-page-selector"},XE=["value"],JE=["value"];function ZE(o,e,s,t,r,i){return s.totalPages>1?(c(),d("div",WE,[a("div",UE,[a("span",FE,g(i.startItem)+"-"+g(i.endItem)+" из "+g(s.totalItems.toLocaleString()),1)]),a("div",HE,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("page-change",1)),disabled:s.currentPage===1,class:"page-btn first","aria-label":"Перейти на первую страницу",title:"Первая страница"}," «« ",8,jE),a("button",{onClick:e[1]||(e[1]=n=>o.$emit("page-change",s.currentPage-1)),disabled:s.currentPage===1,class:"page-btn prev","aria-label":"Перейти на предыдущую страницу",title:"Предыдущая страница"}," ‹ ",8,VE),(c(!0),d(ee,null,te(i.visiblePages,n=>(c(),d(ee,{key:n},[n==="..."?(c(),d("button",zE,g(n),1)):(c(),d("button",{key:1,onClick:l=>o.$emit("page-change",n),class:X({"page-btn":!0,current:n===s.currentPage}),"aria-label":`Перейти на страницу ${n}`,"aria-current":n===s.currentPage?"page":null},g(n),11,GE))],64))),128)),a("button",{onClick:e[2]||(e[2]=n=>o.$emit("page-change",s.currentPage+1)),disabled:s.currentPage===s.totalPages,class:"page-btn next","aria-label":"Перейти на следующую страницу",title:"Следующая страница"}," › ",8,KE),a("button",{onClick:e[3]||(e[3]=n=>o.$emit("page-change",s.totalPages)),disabled:s.currentPage===s.totalPages,class:"page-btn last","aria-label":"Перейти на последнюю страницу",title:"Последняя страница"}," »» ",8,qE)]),s.showPerPageSelector?(c(),d("div",YE,[e[5]||(e[5]=a("label",{for:"per-page-select",class:"per-page-label"},"Показывать:",-1)),a("select",{id:"per-page-select",value:s.perPage,onChange:e[4]||(e[4]=n=>o.$emit("per-page-change",parseInt(n.target.value))),class:"per-page-select","aria-label":"Количество элементов на странице"},[(c(!0),d(ee,null,te(s.perPageOptions,n=>(c(),d("option",{key:n,value:n},g(n),9,JE))),128))],40,XE)])):$("",!0)])):$("",!0)}const QE=de(RE,[["render",ZE],["__scopeId","data-v-59d0e153"]]),eA={name:"UserListPanel",components:{UnifiedUserCard:_E,BulkActionsBar:xE,VirtualList:BE,PaginationControls:QE},props:{users:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},pagination:{type:Object,default:()=>({current_page:1,per_page:50,total:0,total_pages:0})},filters:{type:Object,default:()=>({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"})},viewOptions:{type:Object,default:()=>({compactView:!1,showExtendedMetrics:!1,itemsPerPage:50})},canEditPermissions:{type:Boolean,default:!1},canDeleteUsers:{type:Boolean,default:!1}},emits:["user-select","user-select-multiple","filters-change","pagination-change","view-options-change","user-action"],setup(o,{emit:e}){const s=I(!1),t=I([]),r=I({...o.filters}),i=I(null),n=I(null),l=M(()=>o.users),u=M(()=>{let L=0;return r.value.search&&L++,r.value.department_ids.length>0&&L++,r.value.activity_filter!=="all"&&L++,r.value.time_range!=="week"&&L++,L}),m=M(()=>{if(!n.value)return 400;const L=n.value.getBoundingClientRect();return Math.max(400,window.innerHeight-L.top-200)}),v=M(()=>[{id:369,name:"Битрикс24 отдел",color:"#2196F3"},{id:366,name:"Сектор 1С",color:"#4CAF50"},{id:370,name:"Отдел аналитики",color:"#FF9800"},{id:371,name:"Техническая поддержка",color:"#F44336"}]),T=M(()=>[{id:"change_department",label:"Изменить отдел",icon:"BuildingIcon",description:"Назначить пользователей в другой отдел"},{id:"toggle_admin",label:"Изменить права администратора",icon:"ShieldIcon",description:"Предоставить или отозвать права администратора"},{id:"export",label:"Экспорт данных",icon:"DownloadIcon",description:"Экспортировать данные выбранных пользователей"},{id:"hide_users",label:"Скрыть пользователей",icon:"EyeOffIcon",description:"Скрыть выбранных пользователей из списка"}]),f=()=>{s.value=!s.value},k=()=>{e("filters-change",{...r.value})},p=()=>{r.value={search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc",time_range:"week"},k()},S=L=>{const h=r.value.department_ids.indexOf(L);h>-1?r.value.department_ids.splice(h,1):r.value.department_ids.push(L),k()},C=()=>{r.value.sort_order=r.value.sort_order==="asc"?"desc":"asc",k()},y=()=>{const L={...o.viewOptions,compactView:!o.viewOptions.compactView};e("view-options-change",L)},_=()=>{i.value&&clearTimeout(i.value),i.value=setTimeout(A,300)},A=()=>{k()},W=()=>{r.value.search="",k()},x=L=>{D(L)},D=L=>{e("user-select",L)},E=L=>{t.value=L,e("user-select-multiple",L)},P=()=>{t.value=[]},B=L=>{e("user-action","view-profile",L)},U=L=>{e("user-action","edit-permissions",L)},G=L=>{e("user-action","toggle-visibility",L)},q=L=>{e("user-action","view-analytics",L)},oe=L=>{e("user-action","export-data",L)},Y=L=>{e("user-action","delete",L)},H=L=>{e("user-action","bulk-action",{action:L,users:t.value})},Z=L=>{e("pagination-change",L)},fe=L=>{e("pagination-change",1,L)};return Me(()=>o.filters,L=>{r.value={...L}},{deep:!0}),Ae(()=>{Wt(()=>{n.value&&(n.value.style.height=`${m.value}px`)})}),{showFilters:s,selectedUsers:t,localFilters:r,filteredUsers:l,activeFiltersCount:u,listHeight:m,departments:v,bulkActions:T,listContainer:n,toggleFilters:f,applyFilters:k,resetFilters:p,toggleDepartmentFilter:S,toggleSortOrder:C,toggleCompactView:y,debounceSearch:_,applySearch:A,clearSearch:W,handleUserClick:x,handleUserSelect:D,handleUserSelectMultiple:E,clearSelection:P,handleViewProfile:B,handleEditPermissions:U,handleToggleHidden:G,handleViewAnalytics:q,handleExportUserData:oe,handleDeleteUser:Y,handleBulkAction:H,handlePageChange:Z,handlePerPageChange:fe}}},tA={class:"panel-header"},sA={class:"header-content"},aA={class:"panel-title"},oA={key:0,class:"users-count"},nA={class:"header-actions"},rA={class:"search-container"},iA=["aria-expanded"],lA={key:0,class:"filters-count"},cA={class:"view-options"},dA={key:0,class:"filters-panel",role:"region","aria-label":"Панель фильтров"},uA={class:"filters-grid"},mA={class:"filter-group"},gA={class:"departments-filter"},hA=["onClick","aria-label"],fA={class:"filter-group"},vA={class:"filter-group"},pA={class:"filter-group"},yA={class:"sort-controls"},kA=["aria-label"],bA={class:"filter-actions"},_A={class:"users-list-container",role:"list","aria-label":"Список пользователей"},wA={key:0,class:"loading-state"},CA={key:1,class:"empty-state"},TA={class:"empty-title"},SA={class:"empty-description"};function DA(o,e,s,t,r,i){const n=be("BulkActionsBar"),l=be("UnifiedUserCard"),u=be("VirtualList"),m=be("PaginationControls");return c(),d("div",{class:X(["user-list-panel",{loading:s.loading,empty:!s.loading&&t.filteredUsers.length===0,"compact-view":s.viewOptions.compactView}]),role:"region","aria-label":"Список пользователей"},[a("div",tA,[a("div",sA,[a("h2",aA,[e[16]||(e[16]=ce(" Пользователи ",-1)),s.loading?$("",!0):(c(),d("span",oA," ("+g(s.pagination.total.toLocaleString())+") ",1))]),a("div",nA,[a("div",rA,[Le(a("input",{"onUpdate:modelValue":e[0]||(e[0]=v=>t.localFilters.search=v),type:"text",class:"search-input",placeholder:"Поиск по имени или email...",onInput:e[1]||(e[1]=(...v)=>t.debounceSearch&&t.debounceSearch(...v)),onKeydown:e[2]||(e[2]=Oe((...v)=>t.applySearch&&t.applySearch(...v),["enter"])),"aria-label":"Поиск пользователей"},null,544),[[Et,t.localFilters.search]]),t.localFilters.search?(c(),d("button",{key:0,onClick:e[3]||(e[3]=(...v)=>t.clearSearch&&t.clearSearch(...v)),class:"search-clear","aria-label":"Очистить поиск"}," ✕ ")):$("",!0),e[17]||(e[17]=a("div",{class:"search-icon","aria-hidden":"true"},"🔍",-1))]),a("button",{onClick:e[4]||(e[4]=(...v)=>t.toggleFilters&&t.toggleFilters(...v)),class:X(["filters-toggle",{active:t.showFilters}]),"aria-label":"Показать/скрыть фильтры","aria-expanded":t.showFilters},[e[18]||(e[18]=a("svg",{class:"filter-icon",viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"})],-1)),e[19]||(e[19]=ce(" Фильтры ",-1)),t.activeFiltersCount>0?(c(),d("span",lA,g(t.activeFiltersCount),1)):$("",!0)],10,iA),a("div",cA,[a("button",{onClick:e[5]||(e[5]=(...v)=>t.toggleCompactView&&t.toggleCompactView(...v)),class:X(["view-toggle",{active:s.viewOptions.compactView}]),"aria-label":"Переключить компактный вид",title:"Компактный вид"},[...e[20]||(e[20]=[a("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[a("path",{d:"M3 3h18v2H3V3zm0 16h18v2H3v16zm0-8h18v2H3v-2z"})],-1)])],2)])])])]),t.showFilters?(c(),d("div",dA,[a("div",uA,[a("div",mA,[e[21]||(e[21]=a("label",{class:"filter-label"},"Отделы:",-1)),a("div",gA,[(c(!0),d(ee,null,te(t.departments,v=>(c(),d("button",{key:v.id,onClick:T=>t.toggleDepartmentFilter(v.id),class:X(["department-chip",{active:t.localFilters.department_ids.includes(v.id)}]),style:we({borderColor:v.color}),"aria-label":`Фильтр по отделу ${v.name}`},[a("span",{class:"dept-dot",style:we({backgroundColor:v.color}),"aria-hidden":"true"},null,4),ce(" "+g(v.name),1)],14,hA))),128))])]),a("div",fA,[e[23]||(e[23]=a("label",{class:"filter-label"},"Активность:",-1)),Le(a("select",{"onUpdate:modelValue":e[6]||(e[6]=v=>t.localFilters.activity_filter=v),class:"filter-select",onChange:e[7]||(e[7]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Фильтр по уровню активности"},[...e[22]||(e[22]=[_t('<option value="all" data-v-8c6ab554>Все пользователи</option><option value="active" data-v-8c6ab554>Активные (80%+)</option><option value="moderate" data-v-8c6ab554>Средне активные (50-80%)</option><option value="inactive" data-v-8c6ab554>Неактивные (&lt;50%)</option><option value="new" data-v-8c6ab554>Новые (за неделю)</option>',5)])],544),[[dt,t.localFilters.activity_filter]])]),a("div",vA,[e[25]||(e[25]=a("label",{class:"filter-label"},"Период:",-1)),Le(a("select",{"onUpdate:modelValue":e[8]||(e[8]=v=>t.localFilters.time_range=v),class:"filter-select",onChange:e[9]||(e[9]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Временной диапазон для фильтрации"},[...e[24]||(e[24]=[_t('<option value="today" data-v-8c6ab554>Сегодня</option><option value="week" data-v-8c6ab554>Эта неделя</option><option value="month" data-v-8c6ab554>Этот месяц</option><option value="quarter" data-v-8c6ab554>Этот квартал</option><option value="year" data-v-8c6ab554>Этот год</option>',5)])],544),[[dt,t.localFilters.time_range]])]),a("div",pA,[e[28]||(e[28]=a("label",{class:"filter-label"},"Сортировка:",-1)),a("div",yA,[Le(a("select",{"onUpdate:modelValue":e[10]||(e[10]=v=>t.localFilters.sort_by=v),class:"filter-select sort-select",onChange:e[11]||(e[11]=(...v)=>t.applyFilters&&t.applyFilters(...v)),"aria-label":"Поле сортировки"},[...e[26]||(e[26]=[a("option",{value:"last_activity"},"Последняя активность",-1),a("option",{value:"name"},"Имя",-1),a("option",{value:"email"},"Email",-1),a("option",{value:"total_actions"},"Количество действий",-1)])],544),[[dt,t.localFilters.sort_by]]),a("button",{onClick:e[12]||(e[12]=(...v)=>t.toggleSortOrder&&t.toggleSortOrder(...v)),class:"sort-order-toggle","aria-label":`Изменить порядок сортировки на ${t.localFilters.sort_order==="asc"?"убывающий":"возрастающий"}`},[(c(),d("svg",{class:X({rotated:t.localFilters.sort_order==="desc"}),viewBox:"0 0 24 24","aria-hidden":"true"},[...e[27]||(e[27]=[a("path",{d:"M7 14l5-5 5 5z"},null,-1)])],2))],8,kA)])])]),a("div",bA,[a("button",{onClick:e[13]||(e[13]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"filter-reset-btn"}," Сбросить "),a("button",{onClick:e[14]||(e[14]=(...v)=>t.applyFilters&&t.applyFilters(...v)),class:"filter-apply-btn"}," Применить ")])])):$("",!0),t.selectedUsers.length>0?(c(),he(n,{key:1,"selected-users":t.selectedUsers,"available-actions":t.bulkActions,onExecute:t.handleBulkAction,onClearSelection:t.clearSelection},null,8,["selected-users","available-actions","onExecute","onClearSelection"])):$("",!0),a("div",_A,[s.loading?(c(),d("div",wA,[(c(!0),d(ee,null,te(s.viewOptions.itemsPerPage,v=>(c(),d("div",{key:v,class:"user-skeleton","aria-hidden":"true"},[...e[29]||(e[29]=[_t('<div class="skeleton-avatar" data-v-8c6ab554></div><div class="skeleton-content" data-v-8c6ab554><div class="skeleton-line" data-v-8c6ab554></div><div class="skeleton-line short" data-v-8c6ab554></div></div><div class="skeleton-actions" data-v-8c6ab554><div class="skeleton-button" data-v-8c6ab554></div><div class="skeleton-button" data-v-8c6ab554></div></div>',3)])]))),128))])):t.filteredUsers.length===0?(c(),d("div",CA,[e[30]||(e[30]=a("div",{class:"empty-icon","aria-hidden":"true"},"👥",-1)),a("h3",TA,g(t.localFilters.search?"Пользователи не найдены":"Нет пользователей"),1),a("p",SA,g(t.localFilters.search?`По запросу "${t.localFilters.search}" ничего не найдено. Попробуйте изменить поиск или сбросить фильтры.`:"В системе ещё нет зарегистрированных пользователей."),1),t.activeFiltersCount>0?(c(),d("button",{key:0,onClick:e[15]||(e[15]=(...v)=>t.resetFilters&&t.resetFilters(...v)),class:"empty-action-btn"}," Сбросить фильтры ")):$("",!0)])):(c(),he(u,{key:2,items:t.filteredUsers,"item-height":s.viewOptions.compactView?80:120,"container-height":t.listHeight,class:"virtual-users-list",onItemClick:t.handleUserClick},{item:pe(({item:v,index:T})=>[(c(),he(l,{key:v.id,user:v,"is-selected":t.selectedUsers.some(f=>f.id===v.id),"compact-view":s.viewOptions.compactView,"can-edit-permissions":s.canEditPermissions,"can-delete":s.canDeleteUsers,"show-extended-metrics":!s.viewOptions.compactView,onSelect:t.handleUserSelect,onViewProfile:t.handleViewProfile,onEditPermissions:t.handleEditPermissions,onToggleHidden:t.handleToggleHidden,onViewAnalytics:t.handleViewAnalytics,onExportData:t.handleExportUserData,onDeleteUser:t.handleDeleteUser},null,8,["user","is-selected","compact-view","can-edit-permissions","can-delete","show-extended-metrics","onSelect","onViewProfile","onEditPermissions","onToggleHidden","onViewAnalytics","onExportData","onDeleteUser"]))]),_:1},8,["items","item-height","container-height","onItemClick"]))]),!s.loading&&s.pagination.total_pages>1?(c(),he(m,{key:2,"current-page":s.pagination.current_page,"total-pages":s.pagination.total_pages,"total-items":s.pagination.total,"per-page":s.pagination.per_page,onPageChange:t.handlePageChange,onPerPageChange:t.handlePerPageChange},null,8,["current-page","total-pages","total-items","per-page","onPageChange","onPerPageChange"])):$("",!0)],2)}const EA=de(eA,[["render",DA],["__scopeId","data-v-8c6ab554"]]),AA={name:"AnalysisPanel",emits:["back","filter-change","export"],props:{user:{type:Object,default:null},activityData:{type:Object,default:()=>({})},filters:{type:Object,default:()=>({})},timeRange:{type:String,default:"week"},isLoading:{type:Boolean,default:!1}},methods:{getStatusText(o){switch(o){case"online":return"онлайн";case"away":return"отошёл";case"offline":return"оффлайн";default:return"неизвестен"}},formatDuration(o){const e=Math.floor(o/60),s=Math.floor(o%60);return`${e}:${s.toString().padStart(2,"0")}`},formatLastActivity(o){if(!o)return"Никогда";const e=new Date(o),t=new Date-e,r=Math.floor(t/(1e3*60)),i=Math.floor(t/(1e3*60*60)),n=Math.floor(t/(1e3*60*60*24));return r<1?"только что":r<60?`${r} мин назад`:i<24?`${i} ч назад`:n<7?`${n} д назад`:e.toLocaleDateString("ru-RU")}}},$A={class:"analysis-panel"},IA={class:"analysis-header"},MA={class:"user-summary"},NA={class:"user-avatar"},xA=["src","alt"],PA={key:1,class:"avatar-placeholder"},LA={class:"user-info"},OA={class:"user-email"},BA={class:"user-status"},RA={key:0,class:"admin-badge"},WA={class:"header-actions"},UA={class:"analysis-content"},FA={class:"stats-section"},HA={class:"stats-grid"},jA={class:"stat-card"},VA={class:"stat-value"},zA={class:"stat-card"},GA={class:"stat-value"},KA={class:"stat-card"},qA={class:"stat-value"},YA={class:"stat-card"},XA={class:"stat-value"},JA={class:"activity-section"},ZA={class:"last-activity"},QA={key:0,class:"departments-section"},e$={class:"departments-list"};function t$(o,e,s,t,r,i){return c(),d("div",$A,[a("div",IA,[a("div",MA,[a("div",NA,[s.user.avatar?(c(),d("img",{key:0,src:s.user.avatar,alt:`Аватар ${s.user.name}`},null,8,xA)):(c(),d("div",PA,g(s.user.name.charAt(0)),1))]),a("div",LA,[a("h2",null,g(s.user.name),1),a("p",OA,g(s.user.email),1),a("div",BA,[a("span",{class:X(`status-${s.user.status}`)},g(i.getStatusText(s.user.status)),3),s.user.is_admin?(c(),d("span",RA,"Администратор")):$("",!0)])])]),a("div",WA,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку")])]),a("div",UA,[a("div",FA,[e[5]||(e[5]=a("h3",null,"📊 Статистика активности",-1)),a("div",HA,[a("div",jA,[a("div",VA,g(s.user.activity_stats?.total_actions||0),1),e[1]||(e[1]=a("div",{class:"stat-label"},"Всего действий",-1))]),a("div",zA,[a("div",GA,g(s.user.activity_stats?.total_sessions||0),1),e[2]||(e[2]=a("div",{class:"stat-label"},"Сессий",-1))]),a("div",KA,[a("div",qA,g(i.formatDuration(s.user.activity_stats?.avg_session_duration||0)),1),e[3]||(e[3]=a("div",{class:"stat-label"},"Средняя сессия",-1))]),a("div",YA,[a("div",XA,g(s.user.activity_stats?.activity_score||0)+"/100",1),e[4]||(e[4]=a("div",{class:"stat-label"},"Уровень активности",-1))])])]),a("div",JA,[e[6]||(e[6]=a("h3",null,"🕒 Последняя активность",-1)),a("div",ZA,[a("p",null,g(i.formatLastActivity(s.user.activity_stats?.last_activity)),1)])]),s.user.departments&&s.user.departments.length>0?(c(),d("div",QA,[e[7]||(e[7]=a("h3",null,"🏢 Отделы",-1)),a("div",e$,[(c(!0),d(ee,null,te(s.user.departments,n=>(c(),d("span",{key:n.id,class:"department-tag",style:we({backgroundColor:n.color})},g(n.name),5))),128))])])):$("",!0),e[8]||(e[8]=a("div",{class:"placeholder-note"},[a("strong",null,"🚧 Следующие возможности в разработке:"),a("ul",null,[a("li",null,"График активности по времени"),a("li",null,"Анализ паттернов использования"),a("li",null,"Сравнение с другими пользователями"),a("li",null,"Экспорт детальной статистики")])],-1))])])}const s$=de(AA,[["render",t$],["__scopeId","data-v-15fd9d64"]]),a$={name:"ManagementPanel",emits:["back","permissions-change","bulk-update"],props:{selectedUsers:{type:Array,default:()=>[]},allUsers:{type:Array,default:()=>[]},departments:{type:Array,default:()=>[]},auditLog:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},canEditPermissions:{type:Boolean,default:!1}},methods:{handleBulkPermissions(){this.$emit("bulk-update","change_permissions",{is_admin:!1,department_id:369})}}},o$={class:"management-panel"},n$={class:"panel-placeholder"},r$={key:0,class:"selected-info"},i$={class:"selected-list"},l$={class:"user-name"},c$={class:"user-email"},d$={class:"placeholder-actions"};function u$(o,e,s,t,r,i){return c(),d("div",o$,[a("div",n$,[e[2]||(e[2]=a("div",{class:"placeholder-icon"},"⚙️",-1)),e[3]||(e[3]=a("h3",null,"Панель управления правами",-1)),e[4]||(e[4]=a("p",null,"Управление правами доступа и ролями пользователей",-1)),e[5]||(e[5]=a("div",{class:"placeholder-note"},[a("strong",null,"Статус:"),ce(" В разработке (TASK-089 - Этап 5) ")],-1)),s.selectedUsers.length>0?(c(),d("div",r$,[a("h4",null,"Выбрано пользователей: "+g(s.selectedUsers.length),1),a("div",i$,[(c(!0),d(ee,null,te(s.selectedUsers.slice(0,3),n=>(c(),d("div",{key:n.id,class:"selected-user"},[a("span",l$,g(n.name),1),a("span",c$,g(n.email),1)]))),128))])])):$("",!0),a("div",d$,[a("button",{onClick:e[0]||(e[0]=n=>o.$emit("back")),class:"back-btn"},"← Назад к списку"),s.selectedUsers.length>0?(c(),d("button",{key:0,onClick:e[1]||(e[1]=(...n)=>i.handleBulkPermissions&&i.handleBulkPermissions(...n)),class:"permissions-btn"}," Изменить права ("+g(s.selectedUsers.length)+") ",1)):$("",!0)])])])}const m$=de(a$,[["render",u$],["__scopeId","data-v-7dfddba5"]]),g$={name:"UnifiedUserManagement",components:{DrillDownNavigation:YS,ContextSidebar:I2,UserListPanel:EA,AnalysisPanel:s$,ManagementPanel:m$},props:{config:{type:Object,default:()=>({enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"})}},setup(o){console.log("[UnifiedUserManagement] Component loaded successfully",o.config);const e=I("global"),s=I(null),t=I(!1),r=I([{id:1,name:"Иван Иванов",email:"ivan@example.com",departments:[{id:369,name:"Битрикс24 отдел",color:"#2196F3"}],is_admin:!0,activity_stats:{total_actions:156,last_activity:new Date().toISOString(),activity_score:85},status:"online"},{id:2,name:"Петр Петров",email:"petr@example.com",departments:[{id:366,name:"Сектор 1С",color:"#4CAF50"}],is_admin:!1,activity_stats:{total_actions:89,last_activity:new Date(Date.now()-864e5).toISOString(),activity_score:67},status:"away"},{id:3,name:"Анна Сидорова",email:"anna@example.com",departments:[],is_admin:!1,activity_stats:{total_actions:23,last_activity:new Date(Date.now()-6048e5).toISOString(),activity_score:35},status:"offline"}]),i=I({search:"",department_ids:[],activity_filter:"all",sort_by:"last_activity",sort_order:"desc"}),n=I([{id:"total_users",label:"Всего пользователей",value:r.value.length,change:5.2},{id:"active_users",label:"Активных сегодня",value:r.value.filter(p=>p.status==="online").length,change:12.1},{id:"new_users",label:"Новых сегодня",value:1,change:-2.3}]),l=M(()=>{const p=[{id:"global",label:"Управление пользователями",icon:"UsersIcon",action:()=>u("global")}];return e.value==="user"&&s.value&&p.push({id:`user-${s.value.id}`,label:s.value.name,icon:"UserIcon",action:()=>m(s.value)}),e.value==="management"&&p.push({id:"management",label:"Управление правами",icon:"SettingsIcon",action:()=>u("management")}),p}),u=(p,S={})=>{e.value=p,S.user&&(s.value=S.user),console.log(`[UnifiedUserManagement] Switched to context: ${p}`,S)},m=p=>{s.value=p,u("user",{user:p})};return{currentContext:e,selectedUser:s,loading:t,users:r,filters:i,globalMetrics:n,breadcrumbs:l,handleUserSelect:p=>{m(p)},handleBreadcrumbNavigate:p=>{p.action&&p.action()},handleGoBack:()=>{(e.value==="user"||e.value==="management")&&(u("global"),s.value=null),console.log("[UnifiedUserManagement] Returned to global context")},handleMetricClick:p=>{console.log("Metric clicked:",p)}}}},h$={class:"unified-user-management"},f$={class:"management-grid"},v$={class:"main-content-area"};function p$(o,e,s,t,r,i){const n=be("DrillDownNavigation"),l=be("ContextSidebar"),u=be("UserListPanel"),m=be("AnalysisPanel"),v=be("ManagementPanel");return c(),d("div",h$,[ne(n,{breadcrumbs:t.breadcrumbs,"is-loading":t.loading,onNavigate:t.handleBreadcrumbNavigate,onBack:t.handleGoBack},null,8,["breadcrumbs","is-loading","onNavigate","onBack"]),a("div",f$,[ne(l,{context:t.currentContext,"global-metrics":t.globalMetrics,"selected-user":t.selectedUser,onMetricClick:t.handleMetricClick},null,8,["context","global-metrics","selected-user","onMetricClick"]),a("div",v$,[t.currentContext==="global"?(c(),he(u,{key:0,users:t.users,loading:t.loading,pagination:{current_page:1,total:t.users.length,total_pages:1},filters:t.filters,"can-edit-permissions":!0,"can-delete":!1,onUserSelect:t.handleUserSelect},null,8,["users","loading","pagination","filters","onUserSelect"])):t.currentContext==="user"?(c(),he(m,{key:1,user:t.selectedUser,onBack:t.handleGoBack},null,8,["user","onBack"])):t.currentContext==="management"?(c(),he(v,{key:2,onBack:t.handleGoBack},null,8,["onBack"])):$("",!0)])])])}const y$=de(g$,[["render",p$],["__scopeId","data-v-953cd27b"]]),k$={name:"UsersManagementPage",components:{UnifiedUserManagement:y$},setup(){const o=Xe();return Ae(async()=>{try{if(!(await rt.checkAccess()).allowed){o.push("/");return}if(!await rt.getCurrentUser()){o.push("/");return}console.log("[UsersManagementPage] Access granted - loading unified interface")}catch(e){console.error("[UsersManagementPage] Access check failed:",e),o.push("/")}}),{}}},b$={class:"users-management-page"};function _$(o,e,s,t,r,i){const n=be("UnifiedUserManagement");return c(),d("div",b$,[ne(n,{config:{enablePersistence:!0,enableKeyboardShortcuts:!0,defaultView:"global"}})])}const w$=de(k$,[["render",_$],["__scopeId","data-v-3ef05244"]]);class Pe{static async getCacheStatus(){try{const e=et("/api/admin/cache-status.php");console.log("[CacheManagementService] Fetching cache status from:",e);const s=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(console.log("[CacheManagementService] Response status:",s.status),!s.ok){const r=await s.text();throw console.error("[CacheManagementService] HTTP error:",r),new Error(`HTTP error! status: ${s.status}, message: ${r}`)}const t=await s.json();if(console.log("[CacheManagementService] API result:",t),t.success){let r=t.modules||[];console.log("[CacheManagementService] Modules from API:",r.length,r),r.length===0&&(console.log("[CacheManagementService] Using mock data for UI demonstration"),r=this.getMockModules(),console.log("[CacheManagementService] Mock modules:",r.length));const i=this.categorizeAndSortModules(r);return console.log("[CacheManagementService] Categorized result:",i),i}else throw new Error(t.error||"Failed to get cache status")}catch(e){console.error("[CacheManagementService] Error getting cache status:",e),console.log("[CacheManagementService] Using mock data due to API error");const s=this.getMockModules(),t=this.categorizeAndSortModules(s);return console.log("[CacheManagementService] Mock categorized result:",t),t}}static async clearCache(e){try{const s=et("/api/admin/cache-clear.php"),t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,confirm:!0})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return!0;throw new Error(r.error||"Failed to clear cache")}catch(s){throw console.error("[CacheManagementService] Error clearing cache:",s),s}}static async getCacheStats(){try{const e=et("/api/admin/cache-stats.php"),s=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(t.success)return t.stats||{};throw new Error(t.error||"Failed to get cache stats")}catch(e){throw console.error("[CacheManagementService] Error getting cache stats:",e),e}}static formatCacheSize(e){if(e===0)return"0 B";const s=1024,t=["B","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(s));return Math.round(e/Math.pow(s,r)*100)/100+" "+t[r]}static categorizeAndSortModules(e,s={}){const t=this.generateCacheKey(e),r=this.getCachedResult(t);if(r&&!s.forceRefresh)return r;const i=performance.now(),n=this.performCategorization(e),l=performance.now();return n.metadata={processingTime:l-i,totalModules:e.length,primaryCount:n.primaryModules.length,secondaryCount:n.secondaryModules.length,cached:!1},this.setCachedResult(t,n),n}static performCategorization(e){const s=[],t=[];return e.forEach(r=>{this.validateModule(r),this.PRIMARY_MODULE_IDS.includes(r.id)?s.push({...r,category:"primary",priority:this.PRIMARY_MODULE_PRIORITIES[r.id]||999}):t.push({...r,category:"secondary",groupType:this.getModuleType(r.id)})}),{primaryModules:this.sortPrimaryModules(s),secondaryModules:this.sortSecondaryModules(t)}}static sortPrimaryModules(e){return e.sort((s,t)=>{const r=this.PRIMARY_MODULE_PRIORITIES[s.id]||999,i=this.PRIMARY_MODULE_PRIORITIES[t.id]||999;return r-i})}static sortSecondaryModules(e){return e.sort((s,t)=>{const r=this.getModuleType(s.id),i=this.getModuleType(t.id);return r!==i?this.compareModuleTypes(r,i):s.name.localeCompare(t.name)})}static compareModuleTypes(e,s){const t=["users","activity","webhooks","other"],r=t.indexOf(e),i=t.indexOf(s);return(r===-1?999:r)-(i===-1?999:i)}static getModuleType(e){for(const[s,t]of Object.entries(this.SECONDARY_MODULE_TYPES))if(e.startsWith(t.prefix))return s;return e.includes("time-tracking")?"time-tracking":e.includes("graph")?"graphs":e.includes("dashboard")?"dashboards":"other"}static getModuleTypeConfig(e){return this.SECONDARY_MODULE_TYPES[e]||{title:"🔧 Прочие модули",description:"Дополнительные модули системы"}}static validateModule(e){if(!e||typeof e!="object")throw new Error("Module must be an object");if(!e.id||typeof e.id!="string")throw new Error("Module must have a valid id");if(!e.name||typeof e.name!="string")throw new Error("Module must have a valid name");return!0}static generateCacheKey(e){const s=e.map(t=>t.id).sort().join(",");return btoa(s).substring(0,16)}static getCachedResult(e){const s=this.categorizationCache.get(e);return s?Date.now()-s.timestamp>this.CACHE_TTL?(this.categorizationCache.delete(e),null):{...s.data,metadata:{...s.data.metadata,cached:!0}}:null}static setCachedResult(e,s){if(this.categorizationCache.set(e,{data:{...s,metadata:{...s.metadata,cached:!1}},timestamp:Date.now()}),this.categorizationCache.size>10){const t=this.categorizationCache.keys().next().value;this.categorizationCache.delete(t)}}static clearCategorizationCache(){this.categorizationCache.clear()}static invalidateCacheAfterModuleOperation(){this.clearCategorizationCache()}static getCategorizationStats(){return{cacheSize:this.categorizationCache.size,cacheEntries:Array.from(this.categorizationCache.entries()).map(([e,s])=>({key:e,age:Date.now()-s.timestamp,modulesCount:s.data.primaryModules.length+s.data.secondaryModules.length}))}}static formatTTL(e){return e<60?`${e} сек`:e<3600?`${Math.floor(e/60)} мин`:`${Math.floor(e/3600)} ч`}static formatCreationTime(e){return e<1e3?`${Math.round(e)}мс`:e<6e4?`${Math.round(e/1e3*10)/10}сек`:`${Math.round(e/6e4*10)/10}мин`}static formatCacheHitRatio(e){return`${Math.round(e*100)}%`}static formatDataFreshness(e){return`${Math.round(e*100)}%`}static getExpiryColor(e){if(!e)return"gray";const s=Date.now()/1e3,t=(e-s)/3600;return t>2?"green":t>.5?"yellow":"red"}static getEfficiencyColor(e){return e>=.85?"green":e>=.7?"yellow":"red"}static getCreationTimeColor(e){return e<=2e3?"green":e<=1e4?"yellow":"red"}static getFreshnessColor(e){return e>=.9?"green":e>=.7?"yellow":"red"}static generateModuleMetadata(e){const s=Math.floor(Date.now()/1e3),t=e.metadata||{},r=this.PRIMARY_MODULE_IDS.includes(e.id);return{version:t.version||"1.0",module_id:e.id,module_name:e.name,created_at:t.created_at||s-Math.random()*86400*7,created_by:t.created_by||(Math.random()>.5?"system":"cron"),creation_time_ms:t.creation_time_ms||500+Math.random()*9500,last_accessed_at:t.last_accessed_at||s-Math.random()*3600,access_count:t.access_count||Math.floor(Math.random()*100)+1,expires_at:t.expires_at||s+(e.ttl||3600),ttl_seconds:e.ttl||3600,file_size_bytes:e.total_size||Math.floor(Math.random()*1e7)+1e6,compression_ratio:t.compression_ratio||.7+Math.random()*.3,data_version:t.data_version||`2026.01.12.v${Math.floor(Math.random()*10)+1}`,source_params:t.source_params||{period:r?Math.random()>.5?"weeks":"months":"default",sector_id:e.id.includes("sector-1c")?"1c":"all",filters:Math.random()>.5?["active_only"]:[],limit:Math.floor(Math.random()*1e3)+500},performance_metrics:t.performance_metrics||{avg_response_time_ms:20+Math.random()*80,cache_hit_ratio:.7+Math.random()*.3,data_freshness_score:.8+Math.random()*.2}}}static getMockModules(){const e=Math.floor(Date.now()/1e3);return[{id:"dashboard-sector-1c",name:"Дашборд сектора 1С",status:"active",file_count:5,total_size:1024e3,ttl:600,created_at:e-7200,expires_at:e+1800,cache_dir:"api/cache/dashboard-sector-1c"},{id:"graph-state",name:"График состояния",status:"active",file_count:3,total_size:512e3,ttl:3600,created_at:e-3600,expires_at:e+7200,cache_dir:"api/cache/graph-state"},{id:"graph-admission-closure-weeks",name:"График приема/закрытий 1С (4 недели)",status:"active",file_count:8,total_size:2048e3,ttl:300,created_at:e-1800,expires_at:e+120,cache_dir:"api/cache/graph-admission-closure/weeks"},{id:"graph-admission-closure-months",name:"График приема/закрытий 1С (3 месяца)",status:"active",file_count:12,total_size:3072e3,ttl:300,created_at:e-3600,expires_at:e+240,cache_dir:"api/cache/graph-admission-closure/months"},{id:"time-tracking-default",name:"Трудозатраты (режим по умолчанию)",status:"active",file_count:4,total_size:768e3,ttl:300,created_at:e-900,expires_at:e+2100,cache_dir:"api/cache/time-tracking-sector-1c/default"},{id:"time-tracking-detailed",name:"Трудозатраты (детальный режим)",status:"active",file_count:6,total_size:1536e3,ttl:120,created_at:e-600,expires_at:e+3540,cache_dir:"api/cache/time-tracking-sector-1c/detailed"},{id:"time-tracking-summary",name:"Трудозатраты (сводный режим)",status:"active",file_count:2,total_size:384e3,ttl:600,created_at:e-1800,expires_at:e+4200,cache_dir:"api/cache/time-tracking-sector-1c/summary"},{id:"users-management-departments",name:"Управление пользователями (отделы)",status:"active",file_count:2,total_size:256e3,ttl:3600,created_at:e-7200,expires_at:e+28800,cache_dir:"api/cache/users-management/departments"},{id:"webhook-logs-api",name:"Логи вебхуков (API запросы)",status:"active",file_count:15,total_size:512e4,ttl:300,created_at:e-3600,expires_at:e+2400,cache_dir:"api/cache/webhook-logs/api"}]}static enrichModulesWithMetadata(e){return e.map(s=>({...s,metadata:this.generateModuleMetadata(s)}))}}je(Pe,"PRIMARY_MODULE_IDS",["dashboard-sector-1c","graph-state","graph-admission-closure-weeks","graph-admission-closure-months","time-tracking-default","time-tracking-detailed","time-tracking-summary"]),je(Pe,"PRIMARY_MODULE_PRIORITIES",{"dashboard-sector-1c":1,"graph-state":2,"graph-admission-closure-weeks":3,"graph-admission-closure-months":4,"time-tracking-default":5,"time-tracking-detailed":6,"time-tracking-summary":7}),je(Pe,"SECONDARY_MODULE_TYPES",{users:{prefix:"users-management",title:"👥 Управление пользователями",description:"Модули для управления пользователями и отделами"},activity:{prefix:"user-activity",title:"📊 Отслеживание активности",description:"Мониторинг активности пользователей"},webhooks:{prefix:"webhook-logs",title:"🔗 Логи вебхуков",description:"Логирование и мониторинг вебхуков"}}),je(Pe,"categorizationCache",new Map),je(Pe,"CACHE_TTL",3e4);function C$(o){const e=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),s=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-s);const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}class Ns{static async createCache(e,s=null,t={}){try{const r=et("/api/admin/cache-create.php"),i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({module_id:e,mode:s,params:t})});if(!i.ok){const l=await i.json().catch(()=>({}));throw new Error(l.error||`HTTP error! status: ${i.status}`)}const n=await i.json();if(n.success)return n;throw new Error(n.error||"Failed to create cache")}catch(r){throw console.error("[CacheCreationService] Error creating cache:",r),r}}static async getCreationStatus(e){try{const s=et(`/api/admin/cache-create-status.php?task_id=${e}`),t=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();if(r.success)return r;throw new Error(r.error||"Failed to get creation status")}catch(s){throw console.error("[CacheCreationService] Error getting creation status:",s),s}}static getDefaultParams(e){if(e.includes("graph-admission-closure"))if((e.includes("weeks")?"weeks":"months")==="weeks"){const t=new Date,r=t.getUTCFullYear(),i=C$(t),n=new Date(r,0,1+(i-1)*7),l=n.getUTCDay(),u=n.getUTCDate()-l+(l===0?-6:1);n.setUTCDate(u),n.setUTCHours(0,0,0,0);const m=new Date(n);return m.setUTCDate(n.getUTCDate()+6),m.setUTCHours(23,59,59,999),{product:"1C",periodMode:"weeks",weekStartUtc:n.toISOString(),weekEndUtc:m.toISOString(),includeTickets:!0,includeNewTicketsByStages:!0,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!0,useCache:!0,forceRefresh:!0}}else return{product:"1C",periodMode:"months",includeTickets:!0,includeNewTicketsByStages:!1,includeCarryoverTickets:!0,includeCarryoverTicketsByDuration:!1};if(e.includes("dashboard-sector-1c"))return{forceRefresh:!0,ttl:600};if(e.includes("graph-state"))return{type:"current",forceRefresh:!0,ttl:3600};if(e.includes("time-tracking")){const s=e.includes("detailed")?"detailed":e.includes("summary")?"summary":"default";return{product:"1C",includeTaskDetails:s==="detailed",summary:s==="summary"}}return{}}}let ls=class{static notifyCacheCreationStarted(e){this.showNotification({content:`Начато создание кеша для модуля "${e}"...`,type:"info",autoHideDelay:3e3})}static notifyCacheCreationSuccess(e){this.showNotification({content:`✅ Кеш для модуля "${e}" успешно создан`,type:"success",autoHideDelay:5e3})}static notifyCacheCreationError(e,s){this.showNotification({content:`❌ Ошибка создания кеша для модуля "${e}": ${s}`,type:"error",autoHideDelay:7e3})}static notifyCacheUpdated(e,s="auto"){const t=s==="manual"?"вручную":"автоматически";this.showNotification({content:`🔄 Кеш для модуля "${e}" обновлён ${t}`,type:"info",autoHideDelay:4e3})}static notifyCacheUsed(e){this.showNotification({content:`⚡ Использован кеш для модуля "${e}"`,type:"success",autoHideDelay:3e3})}static showNotification(e){typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:e.content,autoHideDelay:e.autoHideDelay||3e3}):console.log("[CacheNotification]",e.content)}};const T$=Object.freeze(Object.defineProperty({__proto__:null,CacheNotificationService:ls},Symbol.toStringTag,{value:"Module"})),S$={name:"CacheCreateProgress",props:{progress:{type:Number,required:!0,validator:o=>o>=0&&o<=100},message:{type:String,default:"Создание кеша..."}}},D$={class:"cache-create-progress"},E$={class:"progress-bar"},A$={class:"progress-text"};function $$(o,e,s,t,r,i){return c(),d("div",D$,[a("div",E$,[a("div",{class:"progress-fill",style:we({width:s.progress+"%"})},null,4)]),a("div",A$,g(s.progress)+"% - "+g(s.message),1)])}const I$=de(S$,[["render",$$],["__scopeId","data-v-7071de3b"]]),M$={name:"CacheCreateModal",components:{CacheCreateProgress:I$},props:{module:{type:Object,required:!0}},emits:["close","create"],setup(o,{emit:e}){const s=I(!1),t=I(0),r=I(""),i=I(null),n=I(""),l=M(()=>o.module.id.includes("graph-admission-closure")||o.module.id.includes("time-tracking")),u=M(()=>o.module.id.includes("graph-admission-closure")?["months","weeks"]:o.module.id.includes("time-tracking")?["default","detailed","summary"]:[]),m=()=>{e("close")},v=f=>{f.preventDefault(),f.stopPropagation(),f.target===f.currentTarget&&m()},T=async()=>{s.value=!0,t.value=0,r.value="Начало создания кеша...";try{let f={};if(n.value.trim())try{f=JSON.parse(n.value)}catch{throw new Error("Неверный формат JSON параметров")}else f=Ns.getDefaultParams(o.module.id);ls.notifyCacheCreationStarted(o.module.name),t.value=25,r.value="Загрузка данных из Bitrix24...";const k=await Ns.createCache(o.module.id,i.value,f);t.value=75,r.value="Сохранение кеша...",await new Promise(p=>setTimeout(p,500)),t.value=100,r.value="Кеш успешно создан!",ls.notifyCacheCreationSuccess(o.module.name),setTimeout(()=>{e("create",k),m()},1e3)}catch(f){console.error("[CacheCreateModal] Error creating cache:",f),ls.notifyCacheCreationError(o.module.name,f.message),s.value=!1}};return Ae(()=>{u.value.length>0&&(i.value=u.value[0]);const f=Ns.getDefaultParams(o.module.id);n.value=JSON.stringify(f,null,2)}),{creating:s,progress:t,progressMessage:r,selectedMode:i,paramsJson:n,supportsModes:l,availableModes:u,close:m,handleOverlayClick:v,handleCreate:T}}},N$={class:"modal-header"},x$={class:"modal-body"},P$={key:1,class:"create-form"},L$={key:0,class:"form-group"},O$=["value"],B$={class:"form-group"},R$={class:"modal-footer"},W$=["disabled"],U$=["disabled"],F$={key:0},H$={key:1};function j$(o,e,s,t,r,i){const n=be("CacheCreateProgress");return c(),he($t,{to:"body"},[a("div",{class:"modal-overlay",onClick:e[6]||(e[6]=(...l)=>t.handleOverlayClick&&t.handleOverlayClick(...l))},[a("div",{class:"modal-content",onClick:e[5]||(e[5]=Ce(()=>{},["stop"])),style:{"pointer-events":"auto"}},[a("div",N$,[a("h2",null,"Создание кеша: "+g(s.module.name),1),a("button",{onClick:e[0]||(e[0]=(...l)=>t.close&&t.close(...l)),class:"btn-close"},"×")]),a("div",x$,[t.creating?(c(),he(n,{key:0,progress:t.progress,message:t.progressMessage},null,8,["progress","message"])):(c(),d("div",P$,[t.supportsModes?(c(),d("div",L$,[e[7]||(e[7]=a("label",null,"Режим кеша:",-1)),Le(a("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>t.selectedMode=l),class:"form-control"},[(c(!0),d(ee,null,te(t.availableModes,l=>(c(),d("option",{key:l,value:l},g(l),9,O$))),128))],512),[[dt,t.selectedMode]])])):$("",!0),a("div",B$,[e[8]||(e[8]=a("label",null,"Параметры (JSON):",-1)),Le(a("textarea",{"onUpdate:modelValue":e[2]||(e[2]=l=>t.paramsJson=l),placeholder:'{"product": "1C", ...}',rows:"5",class:"form-control"},null,512),[[Et,t.paramsJson]]),e[9]||(e[9]=a("small",{class:"form-text"},"Оставьте пустым для использования параметров по умолчанию",-1))])]))]),a("div",R$,[a("button",{onClick:e[3]||(e[3]=(...l)=>t.close&&t.close(...l)),class:"btn-cancel",disabled:t.creating},"Отмена",8,W$),a("button",{onClick:e[4]||(e[4]=(...l)=>t.handleCreate&&t.handleCreate(...l)),disabled:t.creating,class:"btn-create"},[t.creating?(c(),d("span",F$,"Создание...")):(c(),d("span",H$,"Создать кеш"))],8,U$)])])])])}const V$=de(M$,[["render",j$],["__scopeId","data-v-1fa7d83b"]]),z$={name:"CacheCreateButton",components:{CacheCreateModal:V$},props:{module:{type:Object,required:!0}},emits:["created"],setup(o,{emit:e}){const s=I(!1),t=I(!1);return{showModal:s,creating:t,openModal:()=>{s.value=!0},closeModal:()=>{s.value=!1},handleCreate:async l=>{t.value=!0;try{e("created",l)}finally{t.value=!1}}}}},G$={class:"cache-create-button"},K$=["disabled"],q$={key:0},Y$={key:1};function X$(o,e,s,t,r,i){const n=be("CacheCreateModal");return c(),d("div",G$,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.openModal&&t.openModal(...l)),disabled:t.creating,class:X(["btn-create",{"btn-disabled":t.creating}])},[t.creating?(c(),d("span",q$,"Создание...")):(c(),d("span",Y$,"➕ Создать кеш"))],10,K$),t.showModal?(c(),he(n,{key:0,module:s.module,onClose:t.closeModal,onCreate:t.handleCreate},null,8,["module","onClose","onCreate"])):$("",!0)])}const J$=de(z$,[["render",X$],["__scopeId","data-v-45e7d308"]]);class Ye{static success(e,s,t={}){this.show("success",e,s,t)}static error(e,s,t={}){this.show("error",e,s,t)}static warning(e,s,t={}){this.show("warning",e,s,t)}static info(e,s,t={}){this.show("info",e,s,t)}static show(e,s,t,r={}){const i={autoHideDelay:r.autoHideDelay||5e3,position:r.position||"top-right",...r};this.isBitrix24Available()?this.showBitrix24Notification(e,s,t,i):this.showFallbackNotification(e,s,t,i)}static isBitrix24Available(){return typeof window<"u"&&window.BX&&window.BX.UI&&window.BX.UI.Notification&&window.BX.UI.Notification.Center&&typeof window.BX.UI.Notification.Center.notify=="function"}static showBitrix24Notification(e,s,t,r){try{const n={success:"success",error:"error",warning:"warning",info:"info"}[e]||"info",l=s?`${s}: ${t}`:t;window.BX.UI.Notification.Center.notify({content:l,autoHideDelay:r.autoHideDelay,category:`cache-management-${e}`,position:r.position}),console.log(`[NotificationSystem] Bitrix24 notification shown: ${e}`,{title:s,message:t,config:r})}catch(i){console.error("[NotificationSystem] Error showing Bitrix24 notification:",i),this.showFallbackNotification(e,s,t,r)}}static showFallbackNotification(e,s,t,r){if("Notification"in window&&Notification.permission==="granted")try{const i=new Notification(s||"Уведомление",{body:t,icon:this.getIconForType(e),tag:`cache-management-${e}`});setTimeout(()=>{i.close()},r.autoHideDelay),console.log(`[NotificationSystem] Browser notification shown: ${e}`,{title:s,message:t});return}catch(i){console.warn("[NotificationSystem] Browser notification failed:",i)}this.showCustomNotification(e,s,t,r)}static showCustomNotification(e,s,t,r){let i=document.getElementById("notification-container");if(!i){i=document.createElement("div"),i.id="notification-container",i.className="notification-container",document.body.appendChild(i);const u=document.createElement("style");u.textContent=this.getNotificationStyles(),document.head.appendChild(u)}const n=document.createElement("div");n.className=`custom-notification notification-${e}`,n.innerHTML=`
      <div class="notification-content">
        <div class="notification-title">${s||""}</div>
        <div class="notification-message">${t}</div>
      </div>
      <button class="notification-close" aria-label="Закрыть уведомление">×</button>
    `,n.querySelector(".notification-close").addEventListener("click",()=>{this.removeCustomNotification(n)}),i.appendChild(n),setTimeout(()=>{this.removeCustomNotification(n)},r.autoHideDelay),console.log(`[NotificationSystem] Custom notification shown: ${e}`,{title:s,message:t})}static removeCustomNotification(e){e&&e.parentNode&&(e.classList.add("notification-hiding"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}static getIconForType(e){const s={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"};return s[e]||s.info}static getNotificationStyles(){return`
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        pointer-events: none;
      }

      .custom-notification {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        min-width: 300px;
        max-width: 500px;
        pointer-events: auto;
        opacity: 0;
        transform: translateX(100%);
        animation: notificationSlideIn 0.3s ease forwards;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 16px;
        gap: 12px;
      }

      .custom-notification.notification-success {
        border-left-color: #28a745;
      }

      .custom-notification.notification-error {
        border-left-color: #dc3545;
      }

      .custom-notification.notification-warning {
        border-left-color: #ffc107;
      }

      .custom-notification.notification-info {
        border-left-color: #17a2b8;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #333;
      }

      .notification-message {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
      }

      .notification-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        flex-shrink: 0;
      }

      .notification-close:hover {
        color: #333;
      }

      .notification-hiding {
        animation: notificationSlideOut 0.3s ease forwards;
      }

      @keyframes notificationSlideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes notificationSlideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      @media (max-width: 768px) {
        .notification-container {
          left: 10px;
          right: 10px;
          top: 10px;
        }

        .custom-notification {
          min-width: auto;
          max-width: none;
        }
      }
    `}static clearAll(){try{this.isBitrix24Available()&&window.BX.UI.Notification.Center.clearAll&&window.BX.UI.Notification.Center.clearAll()}catch(s){console.warn("[NotificationSystem] Error clearing Bitrix24 notifications:",s)}const e=document.getElementById("notification-container");if(e&&(e.innerHTML=""),"Notification"in window&&"getNotifications"in Notification)try{Notification.getNotifications().forEach(t=>{t.tag&&t.tag.startsWith("cache-management-")&&t.close()})}catch(s){console.warn("[NotificationSystem] Error clearing browser notifications:",s)}}}Ye.show.bind(Ye);Ye.success.bind(Ye);Ye.error.bind(Ye);Ye.warning.bind(Ye);Ye.info.bind(Ye);let Ve=null,ot=null;const Lt=class Lt{static show(e={}){return new Promise((s,t)=>{ot=s,Ve||(Ve=this.createModal(),document.body.appendChild(Ve)),this.configureModal(e),this.showModal()})}static hide(){Ve&&(this.hideModal(),ot&&(ot(!1),ot=null))}static createModal(){const e=document.createElement("div");return e.className="cache-confirmation-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","confirmation-title"),e.setAttribute("aria-describedby","confirmation-message"),e.innerHTML=`
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="confirmation-title" class="modal-title"></h3>
          <button
            class="modal-close"
            data-action="cancel"
            aria-label="Закрыть окно подтверждения"
          >
            ×
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-icon">
            <span class="icon-symbol"></span>
          </div>
          <p id="confirmation-message" class="modal-message"></p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-cancel" data-action="cancel"></button>
          <button class="btn btn-confirm" data-action="confirm"></button>
        </div>
      </div>
    `,this.attachEventListeners(e),this.addStyles(),e}static configureModal(e){const{title:s="Подтверждение действия",message:t="Вы уверены, что хотите выполнить это действие?",type:r="warning",confirmText:i="Подтвердить",cancelText:n="Отмена",showCancel:l=!0}=e,u=Ve.querySelector(".modal-title");u.textContent=s;const m=Ve.querySelector(".modal-message");m.textContent=t;const v=Ve.querySelector(".icon-symbol"),T={danger:"⚠️",warning:"⚠️",info:"ℹ️",success:"✅"};v.textContent=T[r]||T.warning;const f=Ve.querySelector(".btn-cancel"),k=Ve.querySelector(".btn-confirm");f.textContent=n,k.textContent=i,l?f.style.display="inline-block":f.style.display="none",Ve.className=`cache-confirmation-modal modal-${r}`}static showModal(){document.body.style.overflow="hidden",Ve.style.display="flex",Ve.classList.add("modal-visible"),setTimeout(()=>{const e=Ve.querySelector(".btn-confirm");e&&e.focus()},100),document.addEventListener("keydown",this.handleKeyDown)}static hideModal(){document.body.style.overflow="",Ve.classList.remove("modal-visible"),document.removeEventListener("keydown",this.handleKeyDown),setTimeout(()=>{Ve&&(Ve.style.display="none")},300)}static attachEventListeners(e){e.addEventListener("click",s=>{const t=s.target.closest("[data-action]")?.getAttribute("data-action");t==="confirm"?this.handleConfirm():t==="cancel"&&this.handleCancel()})}static handleConfirm(){ot&&(ot(!0),ot=null),this.hideModal()}static handleCancel(){ot&&(ot(!1),ot=null),this.hideModal()}static handleTabNavigation(e){const t=Ve.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=t[0],i=t[t.length-1];e.shiftKey?document.activeElement===r&&(e.preventDefault(),i.focus()):document.activeElement===i&&(e.preventDefault(),r.focus())}static addStyles(){if(document.getElementById("cache-confirmation-styles"))return;const e=document.createElement("style");e.id="cache-confirmation-styles",e.textContent=`
      .cache-confirmation-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .cache-confirmation-modal.modal-visible {
        display: flex;
      }

      .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        z-index: 10001;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: #f0f0f0;
        color: #333;
      }

      .modal-body {
        padding: 24px;
        text-align: center;
      }

      .modal-icon {
        margin-bottom: 16px;
      }

      .icon-symbol {
        font-size: 48px;
        display: block;
      }

      .modal-message {
        margin: 0;
        font-size: 16px;
        color: #555;
        line-height: 1.5;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px 24px;
        border-top: 1px solid #e0e0e0;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
      }

      .btn-cancel {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
      }

      .btn-cancel:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }

      .btn-confirm {
        background: #007bff;
        color: white;
      }

      .btn-confirm:hover {
        background: #0056b3;
      }

      /* Типы модальных окон */
      .modal-danger .btn-confirm {
        background: #dc3545;
      }

      .modal-danger .btn-confirm:hover {
        background: #c82333;
      }

      .modal-warning .btn-confirm {
        background: #ffc107;
        color: #212529;
      }

      .modal-warning .btn-confirm:hover {
        background: #e0a800;
      }

      .modal-info .btn-confirm {
        background: #17a2b8;
      }

      .modal-info .btn-confirm:hover {
        background: #138496;
      }

      .modal-success .btn-confirm {
        background: #28a745;
      }

      .modal-success .btn-confirm:hover {
        background: #1e7e34;
      }

      /* Адаптивность */
      @media (max-width: 480px) {
        .modal-content {
          margin: 20px;
          width: calc(100% - 40px);
        }

        .modal-header,
        .modal-body,
        .modal-footer {
          padding-left: 20px;
          padding-right: 20px;
        }

        .modal-footer {
          flex-direction: column-reverse;
        }

        .btn {
          width: 100%;
        }
      }

      /* Доступность */
      @media (prefers-reduced-motion: reduce) {
        .modal-content,
        .modal-close,
        .btn {
          animation: none;
          transition: none;
        }
      }

      /* Высокий контраст */
      @media (prefers-contrast: high) {
        .modal-content {
          border: 2px solid #000;
        }

        .btn-cancel {
          border: 2px solid #000;
        }

        .btn-confirm {
          border: 2px solid #000;
        }
      }
    `,document.head.appendChild(e)}};je(Lt,"handleKeyDown",e=>{switch(e.key){case"Enter":e.preventDefault(),Lt.handleConfirm();break;case"Escape":e.preventDefault(),Lt.handleCancel();break;case"Tab":Lt.handleTabNavigation(e);break}});let At=Lt;At.show.bind(At);At.hide.bind(At);const Z$={name:"CacheModuleCard",components:{CacheCreateButton:J$},props:{module:{type:Object,required:!0,validator:o=>o&&typeof o.id=="string"&&typeof o.name=="string"},isPrimary:{type:Boolean,default:!1},priority:{type:Number,default:999},groupType:{type:String,default:null}},emits:["clear","refresh","details"],setup(o,{emit:e}){const s=I(!1),t=I(!1),r=I(!1),i=I(!1),n=b=>{if(!b.target.closest(".action-button"))switch(b.key){case"Enter":case" ":b.preventDefault();const O=b.currentTarget.querySelector(".action-button:not([disabled])");O&&O.focus();break}};Ae(()=>{const b=()=>{i.value=window.innerWidth<768};b(),window.addEventListener("resize",b);const O=document.querySelector(`[data-module-id="${o.module.id}"]`);O&&O.addEventListener("keydown",n)}),st(()=>{const b=document.querySelector(`[data-module-id="${o.module.id}"]`);b&&b.removeEventListener("keydown",n)});const l=M(()=>({"cache-module-card":!0,"primary-module":o.isPrimary,"secondary-module":!o.isPrimary,"high-priority":o.priority<=3,"expiring-soon":S.value,"empty-cache":k.value,loading:s.value||t.value,[w.value]:!0})),u=M(()=>o.isPrimary?"🏆":{users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"}[o.groupType]||"🔧"),m=M(()=>({"primary-icon":o.isPrimary,"secondary-icon":!o.isPrimary})),v=M(()=>o.isPrimary?"Основной модуль":o.groupType?Pe.getModuleTypeConfig(o.groupType).title||"Неизвестная группа":""),T=M(()=>o.priority?`priority-${o.priority}`:""),f=M(()=>`status-${o.module.status||"empty"}`),k=M(()=>(o.module.file_count||0)===0),p=M(()=>o.module.expires_at?new Date(o.module.expires_at*1e3)<=new Date:!1),S=M(()=>{if(!o.module.expires_at)return!1;const Q=(new Date(o.module.expires_at*1e3)-new Date)/(1e3*60*60);return Q>0&&Q<=2}),C=M(()=>{const b=o.module.status;return b==="active"?"Активен":b==="expired"?"Просрочен":b==="empty"?"Пуст":"Неизвестен"}),y=M(()=>Pe.formatCacheSize(o.module.total_size||0)),_=M(()=>Pe.formatTTL(o.module.ttl||0)),A=M(()=>{if(!o.module.cache_dir)return"";const b=o.module.cache_dir.split("/");return b.length>2?"..."+b.slice(-2).join("/"):o.module.cache_dir}),W=M(()=>o.module.metadata?.creation_time_ms?Pe.formatCreationTime(o.module.metadata.creation_time_ms):"—"),x=M(()=>{if(!o.module.metadata?.last_accessed_at)return"—";const b=new Date(o.module.metadata.last_accessed_at*1e3),Q=new Date-b;return Q<6e4?"Только что":Q<36e5?`${Math.floor(Q/6e4)} мин назад`:b.toLocaleString("ru-RU",{hour:"2-digit",minute:"2-digit"})}),D=M(()=>o.module.metadata?.access_count||0),E=M(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?Pe.formatCacheHitRatio(o.module.metadata.performance_metrics.cache_hit_ratio):"—"),P=M(()=>o.module.metadata?.performance_metrics?.data_freshness_score?Pe.formatDataFreshness(o.module.metadata.performance_metrics.data_freshness_score):"—"),B=M(()=>o.module.expires_at?`metric-${Pe.getExpiryColor(o.module.expires_at)}`:""),U=M(()=>o.module.metadata?.creation_time_ms?`metric-${Pe.getCreationTimeColor(o.module.metadata.creation_time_ms)}`:""),G=M(()=>o.module.metadata?.performance_metrics?.cache_hit_ratio?`metric-${Pe.getEfficiencyColor(o.module.metadata.performance_metrics.cache_hit_ratio)}`:""),q=M(()=>o.module.metadata?.performance_metrics?.data_freshness_score?`metric-${Pe.getFreshnessColor(o.module.metadata.performance_metrics.data_freshness_score)}`:""),oe=M(()=>{if(!o.module.expires_at)return null;const b=new Date(o.module.expires_at*1e3);return Math.max(0,Math.floor((b-new Date)/1e3))}),Y=M(()=>{if(oe.value===null)return"—";if(oe.value<=0)return"Истек";const b=Math.floor(oe.value/3600),O=Math.floor(oe.value%3600/60),Q=oe.value%60;return b>0?`${b}ч ${O}м`:O>0?`${O}м ${Q}с`:`${Q}с`}),H=M(()=>oe.value===null?"":oe.value<=0||oe.value<=1800?"metric-red":oe.value<=7200?"metric-orange":"metric-green"),Z=b=>{if(b===0)return"0 B";const O=1024,Q=["B","KB","MB","GB","TB"],ue=Math.floor(Math.log(b)/Math.log(O));return parseFloat((b/Math.pow(O,ue)).toFixed(1))+" "+Q[ue]},fe=b=>b<60?`${b}с`:b<3600?`${Math.floor(b/60)}м`:b<86400?`${Math.floor(b/3600)}ч`:`${Math.floor(b/86400)}д`,L=M(()=>{if(k.value)return"empty";if(p.value)return"expired";const b=oe.value;return b===null?"fresh":b<=0?"expired":b<=30*60*1e3?"critical":b<=2*60*60*1e3?"warning":"fresh"}),h=M(()=>{const b=L.value;return{fresh:"Свежий кеш",warning:"Истекает скоро",critical:"Критически истекает",expired:"Просрочен",empty:"Кеш пуст"}[b]||"Неизвестное состояние"}),w=M(()=>`cache-state-${L.value}`),R=M(()=>({fresh:"🟢",warning:"🟡",critical:"🔴",expired:"⚫",empty:"⚪"})[L.value]||"❓"),re=M(()=>!k.value&&!s.value),le=M(()=>o.isPrimary&&!k.value),ae=M(()=>k.value?"Кеш модуля пуст":`Очистить кеш модуля ${o.module.name}`),ge=M(()=>{if(!o.module.created_at)return"—";const b=new Date(o.module.created_at*1e3),O=new Date,Q=O-b;if(Q<6e4)return"Только что";if(Q<36e5){const ke=Math.floor(Q/6e4);return`${ke} ${ke===1?"минуту":ke<5?"минуты":"минут"} назад`}if(b.toDateString()===O.toDateString())return`Сегодня в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`;const ue=new Date(O);return ue.setDate(ue.getDate()-1),b.toDateString()===ue.toDateString()?`Вчера в ${b.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`:b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),Se=M(()=>{if(!o.module.expires_at)return"—";const b=new Date(o.module.expires_at*1e3),Q=b-new Date;if(Q<0)return`Просрочен (${b.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})`;const ue=Math.floor(Q/6e4),ke=Math.floor(ue/60);return ke>0?`${ke} ч ${ue%60} мин`:ue>0?`${ue} мин`:"Менее минуты"});return{clearing:s,creating:t,showDetailModal:r,isMobile:i,moduleClasses:l,moduleIcon:u,iconClass:m,moduleTypeText:v,priorityClass:T,statusClass:f,isEmpty:k,isExpired:p,isExpiringSoon:S,statusText:C,formattedSize:y,formattedTTL:_,shortCacheDir:A,formattedCreationTime:W,formattedLastAccess:x,accessCount:D,cacheEfficiency:E,dataFreshness:P,expiresClass:B,creationTimeClass:U,cacheEfficiencyClass:G,dataFreshnessClass:q,cacheState:L,cacheStateText:h,cacheStateClass:w,cacheStateIcon:R,timeToExpiry:oe,formatTimeToExpiry:Y,timeToExpiryClass:H,formatBytes:Z,formatTTL:fe,canClear:re,canShowDetails:le,clearButtonLabel:ae,formattedCreatedAt:ge,formattedExpiresAt:Se,handleClear:async()=>{if(re.value)try{if(!await At.show({title:"Подтверждение очистки кеша",message:`Вы действительно хотите очистить кеш модуля "${o.module.name}"?

Это действие нельзя отменить.`,type:"danger",confirmText:"🗑️ Очистить кеш",cancelText:"Отмена"}))return;s.value=!0,await Pe.clearCache(o.module.id),e("clear",o.module.id),Ye.success("Кеш успешно очищен",`Кеш модуля "${o.module.name}" был полностью очищен`)}catch(b){console.error("[CacheModuleCard] Error clearing cache:",b),Ye.error("Ошибка очистки кеша",`Не удалось очистить кеш модуля "${o.module.name}": ${b.message}`)}finally{s.value=!1}},handleCacheCreated:()=>{Pe.invalidateCacheAfterModuleOperation(),e("refresh")},handleCreatingState:b=>{t.value=b},showDetails:()=>{r.value=!0,e("details",o.module)},closeDetails:()=>{r.value=!1}}}},Q$=["aria-labelledby","aria-describedby","data-module-id"],eI={class:"card-header"},tI={class:"module-identity"},sI={class:"module-info"},aI=["id"],oI={class:"module-type"},nI={class:"header-meta"},rI=["id"],iI={class:"card-content"},lI={class:"data-grid",role:"region","aria-label":"Информация о кеше"},cI={class:"data-section statistics"},dI={class:"data-items"},uI={class:"data-item"},mI={class:"data-value"},gI={class:"data-item"},hI={class:"data-value"},fI={key:0,class:"data-item full-width"},vI=["title"],pI={class:"data-section lifetime"},yI={class:"data-items"},kI={class:"data-item"},bI={class:"data-value"},_I={key:0,class:"data-item"},wI={class:"data-value"},CI={key:1,class:"data-item"},TI={class:"data-section cache-state"},SI={class:"section-header"},DI=["aria-label"],EI={class:"data-items"},AI={class:"data-value cache-state-text"},$I={key:0,class:"data-section performance"},II={class:"data-items"},MI={key:0,class:"data-item"},NI={key:1,class:"data-item"},xI={class:"data-value"},PI={key:2,class:"data-item"},LI={class:"data-value"},OI={key:3,class:"data-item"},BI={key:4,class:"data-item"},RI={key:5,class:"data-item"},WI={class:"data-value"},UI={key:6,class:"data-item"},FI={class:"data-value"},HI={key:7,class:"data-item"},jI=["aria-label"],VI={class:"primary-actions"},zI={class:"secondary-actions"},GI=["disabled","aria-label"],KI={key:0,class:"button-content"},qI={key:1,class:"button-content"},YI={key:2,class:"button-content"},XI=["aria-label"],JI={class:"detail-modal",role:"dialog","aria-modal":"true"},ZI={class:"modal-header"},QI={class:"modal-content"},eM={class:"json-data"};function tM(o,e,s,t,r,i){const n=be("CacheCreateButton");return c(),d("article",{class:X(["cache-module-card",t.moduleClasses]),role:"article","aria-labelledby":`module-${s.module.id}-title`,"aria-describedby":`module-${s.module.id}-status`,"data-module-id":s.module.id,tabindex:"0"},[a("div",eI,[a("div",tI,[a("div",{class:X(["module-icon",t.iconClass])},g(t.moduleIcon),3),a("div",sI,[a("h3",{class:"module-name",id:`module-${s.module.id}-title`},g(s.module.name),9,aI),a("span",oI,g(t.moduleTypeText),1)])]),a("div",nI,[s.isPrimary&&s.priority?(c(),d("span",{key:0,class:X(["priority-badge",t.priorityClass])},g(s.priority),3)):$("",!0),a("span",{class:X(["status-badge",t.statusClass]),id:`module-${s.module.id}-status`,role:"status"},g(t.statusText),11,rI)])]),a("div",iI,[a("div",lI,[a("div",cI,[e[14]||(e[14]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"📊"),a("h4",{class:"section-title"},"Статистика")],-1)),a("div",dI,[a("div",uI,[e[11]||(e[11]=a("span",{class:"data-label"},"Файлов:",-1)),a("span",mI,g(s.module.file_count||0),1)]),a("div",gI,[e[12]||(e[12]=a("span",{class:"data-label"},"Размер:",-1)),a("span",hI,g(t.formattedSize),1)]),s.module.cache_dir?(c(),d("div",fI,[e[13]||(e[13]=a("span",{class:"data-label"},"Директория:",-1)),a("span",{class:"data-value cache-dir",title:s.module.cache_dir},g(t.shortCacheDir),9,vI)])):$("",!0)])]),a("div",pI,[e[18]||(e[18]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"⏰"),a("h4",{class:"section-title"},"Время жизни")],-1)),a("div",yI,[a("div",kI,[e[15]||(e[15]=a("span",{class:"data-label"},"TTL:",-1)),a("span",bI,g(t.formattedTTL),1)]),s.module.created_at?(c(),d("div",_I,[e[16]||(e[16]=a("span",{class:"data-label"},"Создан:",-1)),a("span",wI,g(t.formattedCreatedAt),1)])):$("",!0),s.module.expires_at?(c(),d("div",CI,[e[17]||(e[17]=a("span",{class:"data-label"},"Истекает:",-1)),a("span",{class:X(["data-value",t.expiresClass])},g(t.formattedExpiresAt),3)])):$("",!0)])]),a("div",TI,[a("div",SI,[a("span",{class:"section-icon","aria-label":t.cacheStateText,"aria-hidden":"false"},g(t.cacheStateIcon),9,DI),e[19]||(e[19]=a("h4",{class:"section-title"},"Состояние кеша",-1))]),a("div",EI,[a("div",{class:X(["data-item cache-state-indicator",t.cacheStateClass])},[e[20]||(e[20]=a("span",{class:"data-label"},"Статус:",-1)),a("span",AI,g(t.cacheStateText),1)],2)])]),s.module.metadata||s.module.created_at?(c(),d("div",$I,[e[29]||(e[29]=a("div",{class:"section-header"},[a("span",{class:"section-icon","aria-hidden":"true"},"⚡"),a("h4",{class:"section-title"},"Производительность")],-1)),a("div",II,[t.formattedCreationTime?(c(),d("div",MI,[e[21]||(e[21]=a("span",{class:"data-label"},"Время создания:",-1)),a("span",{class:X(["data-value",t.creationTimeClass])},g(t.formattedCreationTime),3)])):$("",!0),t.formattedLastAccess?(c(),d("div",NI,[e[22]||(e[22]=a("span",{class:"data-label"},"Последний доступ:",-1)),a("span",xI,g(t.formattedLastAccess),1)])):$("",!0),t.accessCount!==null?(c(),d("div",PI,[e[23]||(e[23]=a("span",{class:"data-label"},"Обращений:",-1)),a("span",LI,g(t.accessCount),1)])):$("",!0),t.cacheEfficiency?(c(),d("div",OI,[e[24]||(e[24]=a("span",{class:"data-label"},"Эффективность:",-1)),a("span",{class:X(["data-value",t.cacheEfficiencyClass])},g(t.cacheEfficiency),3)])):$("",!0),t.dataFreshness?(c(),d("div",BI,[e[25]||(e[25]=a("span",{class:"data-label"},"Свежесть данных:",-1)),a("span",{class:X(["data-value",t.dataFreshnessClass])},g(t.dataFreshness),3)])):$("",!0),s.module.total_size?(c(),d("div",RI,[e[26]||(e[26]=a("span",{class:"data-label"},"Общий размер:",-1)),a("span",WI,g(t.formatBytes(s.module.total_size)),1)])):$("",!0),s.module.ttl?(c(),d("div",UI,[e[27]||(e[27]=a("span",{class:"data-label"},"TTL:",-1)),a("span",FI,g(t.formatTTL(s.module.ttl)),1)])):$("",!0),t.timeToExpiry!==null?(c(),d("div",HI,[e[28]||(e[28]=a("span",{class:"data-label"},"Истекает через:",-1)),a("span",{class:X(["data-value",t.timeToExpiryClass])},g(t.formatTimeToExpiry),3)])):$("",!0)])])):$("",!0)])]),a("div",{class:X(["card-actions",{"mobile-layout":t.isMobile}]),role:"group","aria-label":`Действия с кешем ${s.module.name}`},[a("div",VI,[ne(n,{module:s.module,disabled:t.creating,onCreated:t.handleCacheCreated,onCreating:t.handleCreatingState,class:X({loading:t.creating})},null,8,["module","disabled","onCreated","onCreating","class"])]),a("div",zI,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClear&&t.handleClear(...l)),onKeydown:[e[1]||(e[1]=Oe((...l)=>t.handleClear&&t.handleClear(...l),["enter"])),e[2]||(e[2]=Oe(Ce((...l)=>t.handleClear&&t.handleClear(...l),["prevent"]),["space"]))],disabled:!t.canClear,class:X(["action-button clear-button",{disabled:!t.canClear,loading:t.clearing}]),"aria-label":t.clearButtonLabel,tabindex:"0"},[t.clearing?(c(),d("span",KI,[...e[30]||(e[30]=[a("span",{class:"spinner"},null,-1),ce(" Очистка... ",-1)])])):t.isEmpty?(c(),d("span",qI," 📁 Кеш пуст ")):(c(),d("span",YI," 🗑️ Очистить "))],42,GI),t.canShowDetails?(c(),d("button",{key:0,onClick:e[3]||(e[3]=(...l)=>t.showDetails&&t.showDetails(...l)),onKeydown:[e[4]||(e[4]=Oe((...l)=>t.showDetails&&t.showDetails(...l),["enter"])),e[5]||(e[5]=Oe(Ce((...l)=>t.showDetails&&t.showDetails(...l),["prevent"]),["space"]))],class:"action-button details-button","aria-label":`Показать детали кеша ${s.module.name}`,title:"Показать детали кеша",tabindex:"0"}," 📊 ",40,XI)):$("",!0)])],10,jI),(c(),he($t,{to:"body"},[t.showDetailModal?(c(),d("div",{key:0,class:"detail-modal-overlay",onClick:e[9]||(e[9]=Ce((...l)=>t.closeDetails&&t.closeDetails(...l),["self"])),onKeydown:e[10]||(e[10]=Oe((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))},[a("div",JI,[a("div",ZI,[a("h3",null,"Детали кеша: "+g(s.module.name),1),a("button",{onClick:e[6]||(e[6]=(...l)=>t.closeDetails&&t.closeDetails(...l)),onKeydown:[e[7]||(e[7]=Oe((...l)=>t.closeDetails&&t.closeDetails(...l),["enter"])),e[8]||(e[8]=Oe((...l)=>t.closeDetails&&t.closeDetails(...l),["escape"]))],class:"close-button","aria-label":"Закрыть",tabindex:"0"}," ✕ ",32)]),a("div",QI,[a("pre",eM,g(JSON.stringify(s.module,null,2)),1)])])],32)):$("",!0)]))],10,Q$)}const sM=de(Z$,[["render",tM],["__scopeId","data-v-bc59cd77"]]),aM={name:"CacheStats",props:{modules:{type:Array,required:!1,default:()=>[]}},setup(o){console.log("[CacheStats] setup called with modules:",o.modules);const e=M(()=>o.modules||[]),s=M(()=>{console.log("[CacheStats] Computing primaryModules, total modules:",e.value?.length||0);const p=e.value.filter(S=>Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Primary modules count:",p.length),p}),t=M(()=>{console.log("[CacheStats] Computing secondaryModules, total modules:",e.value?.length||0);const p=e.value.filter(S=>!Pe.PRIMARY_MODULE_IDS.includes(S.id));return console.log("[CacheStats] Secondary modules count:",p.length),p}),r=M(()=>s.value?.length||0),i=M(()=>t.value?.length||0),n=M(()=>e.value?.length||0),l=M(()=>e.value.reduce((p,S)=>p+(S.file_count||0),0)),u=M(()=>(o.modules||[]).reduce((p,S)=>p+(S.total_size||0),0)),m=M(()=>Pe.formatCacheSize(u.value)),v=M(()=>{const p=o.modules||[];if(p.length===0)return"0 мин";const S=p.reduce((y,_)=>y+(_.ttl||0),0),C=Math.round(S/p.length);return Pe.formatTTL(C)}),T=M(()=>(e.value||[]).filter(p=>p.status==="active").length),f=M(()=>{if((i.value||0)===0)return[];const p={};(t.value||[]).forEach(C=>{const y=Pe.getModuleType(C.id);if(!p[y]){const _=Pe.getModuleTypeConfig(y);p[y]={type:y,title:_.title||"Неизвестная группа",icon:k(y),count:0}}p[y].count++});const S=i.value||0;return Object.values(p).map(C=>({...C,percentage:S>0?Math.round(C.count/S*100):0})).sort((C,y)=>y.count-C.count)}),k=p=>{const S={users:"👥",activity:"📊",webhooks:"🔗",other:"🔧"};return S[p]||S.other};return{modules:e,primaryModulesCount:r,secondaryModulesCount:i,totalModules:n,totalFiles:l,totalSizeFormatted:m,avgTTL:v,activeModules:T,groupStats:f}}},oM={key:0,class:"cache-stats"},nM={class:"stats-overview"},rM={class:"overview-grid"},iM={class:"overview-card primary"},lM={class:"overview-content"},cM={class:"overview-value"},dM={class:"overview-card secondary"},uM={class:"overview-content"},mM={class:"overview-value"},gM={class:"overview-card total"},hM={class:"overview-content"},fM={class:"overview-value"},vM={class:"detailed-stats"},pM={class:"stats-grid"},yM={class:"stat-card"},kM={class:"stat-content"},bM={class:"stat-value"},_M={class:"stat-card"},wM={class:"stat-content"},CM={class:"stat-value"},TM={class:"stat-card"},SM={class:"stat-content"},DM={class:"stat-value"},EM={class:"stat-card"},AM={class:"stat-content"},$M={class:"stat-value"},IM={key:0,class:"group-distribution"},MM={class:"distribution-grid"},NM={class:"group-icon"},xM={class:"group-info"},PM={class:"group-name"},LM={class:"group-count"},OM={class:"group-percentage"},BM={key:1,class:"cache-stats-loading"};function RM(o,e,s,t,r,i){return(t.modules||[]).length>0?(c(),d("div",oM,[e[18]||(e[18]=a("h2",{class:"stats-title"},"📊 Статистика кеша по категориям",-1)),a("div",nM,[a("div",rM,[a("div",iM,[e[2]||(e[2]=a("div",{class:"overview-icon"},"🏆",-1)),a("div",lM,[a("div",cM,g(t.primaryModulesCount),1),e[0]||(e[0]=a("div",{class:"overview-label"},"Основных модулей",-1)),e[1]||(e[1]=a("div",{class:"overview-desc"},"Приоритетные",-1))])]),a("div",dM,[e[5]||(e[5]=a("div",{class:"overview-icon"},"🔧",-1)),a("div",uM,[a("div",mM,g(t.secondaryModulesCount),1),e[3]||(e[3]=a("div",{class:"overview-label"},"Побочных модулей",-1)),e[4]||(e[4]=a("div",{class:"overview-desc"},"Служебные",-1))])]),a("div",gM,[e[8]||(e[8]=a("div",{class:"overview-icon"},"📦",-1)),a("div",hM,[a("div",fM,g(t.totalModules),1),e[6]||(e[6]=a("div",{class:"overview-label"},"Всего модулей",-1)),e[7]||(e[7]=a("div",{class:"overview-desc"},"Активных",-1))])])])]),a("div",vM,[a("div",pM,[a("div",yM,[e[10]||(e[10]=a("div",{class:"stat-icon"},"📄",-1)),a("div",kM,[a("div",bM,g(t.totalFiles),1),e[9]||(e[9]=a("div",{class:"stat-label"},"Всего файлов",-1))])]),a("div",_M,[e[12]||(e[12]=a("div",{class:"stat-icon"},"💾",-1)),a("div",wM,[a("div",CM,g(t.totalSizeFormatted),1),e[11]||(e[11]=a("div",{class:"stat-label"},"Общий размер",-1))])]),a("div",TM,[e[14]||(e[14]=a("div",{class:"stat-icon"},"⏱️",-1)),a("div",SM,[a("div",DM,g(t.avgTTL),1),e[13]||(e[13]=a("div",{class:"stat-label"},"Средний TTL",-1))])]),a("div",EM,[e[16]||(e[16]=a("div",{class:"stat-icon"},"⚡",-1)),a("div",AM,[a("div",$M,g(t.activeModules),1),e[15]||(e[15]=a("div",{class:"stat-label"},"Активных кешей",-1))])])])]),t.secondaryModulesCount>0?(c(),d("div",IM,[e[17]||(e[17]=a("h3",{class:"distribution-title"},"Распределение побочных модулей",-1)),a("div",MM,[(c(!0),d(ee,null,te(t.groupStats,n=>(c(),d("div",{key:n.type,class:"distribution-item"},[a("div",NM,g(n.icon),1),a("div",xM,[a("div",PM,g(n.title),1),a("div",LM,g(n.count)+" модулей",1)]),a("div",OM,g(n.percentage)+"%",1)]))),128))])])):$("",!0)])):(c(),d("div",BM,[...e[19]||(e[19]=[a("p",null,"📊 Загрузка статистики...",-1)])]))}const WM=de(aM,[["render",RM],["__scopeId","data-v-9fa190bb"]]),UM={name:"CacheManagement",components:{CacheModuleCard:sM,CacheStats:WM},setup(){const o=I([]),e=I([]),s=I(!0),t=I(null),r=I(!1),i=M(()=>(o.value?.length||0)+(e.value?.length||0)),n=M(()=>{const y=l.value?.length||0,_=(u.value?.length||0)>0?1:0;return y+_}),l=M(()=>{const y=(o.value||[]).filter(_=>!_.id.includes("time-tracking"));return console.log("[CacheManagement] individualPrimaryModules:",y.length,y.map(_=>_.id)),y}),u=M(()=>{const y=(o.value||[]).filter(_=>_.id.includes("time-tracking")).sort((_,A)=>{const W=["time-tracking-default","time-tracking-detailed","time-tracking-summary"];return W.indexOf(_.id)-W.indexOf(A.id)});return console.log("[CacheManagement] timeTrackingModules:",y.length,y.map(_=>_.id)),y}),m=M(()=>{const y={};return(e.value||[]).forEach(A=>{const W=Pe.getModuleType(A.id);y[W]||(y[W]={type:W,title:T(W),modules:[]}),y[W].modules.push(A)}),Object.values(y).sort((A,W)=>{const x=["users","activity","webhooks","other"],D=x.indexOf(A.type),E=x.indexOf(W.type);return(D===-1?999:D)-(E===-1?999:E)})}),v=async()=>{s.value=!0,t.value=null;try{const y=await Pe.getCacheStatus();o.value=y.primaryModules||[],e.value=y.secondaryModules||[],console.log("[CacheManagement] Primary modules:",o.value.length,o.value.map(_=>({id:_.id,name:_.name}))),console.log("[CacheManagement] Secondary modules:",e.value.length,e.value.map(_=>({id:_.id,name:_.name})))}catch(y){console.error("[CacheManagement] Error loading modules:",y),t.value=y.message}finally{s.value=!1}},T=y=>{const _={users:"👥 Управление пользователями",activity:"📊 Отслеживание активности",webhooks:"🔗 Логи вебхуков",other:"🔧 Прочие модули"};return _[y]||_.other},f=async y=>{console.log(`[CacheManagement] Clearing module: ${y}`),Pe.invalidateCacheAfterModuleOperation(),await v()},k=async()=>{console.log("[CacheManagement] Clearing all cache"),r.value=!0;try{await Pe.clearCache("all"),Pe.invalidateCacheAfterModuleOperation(),Ye.success("Кеш полностью очищен","Все файлы кеша были успешно удалены"),await v()}catch(y){console.error("[CacheManagement] Error clearing all cache:",y),Ye.error("Ошибка очистки кеша",`Не удалось очистить весь кеш: ${y.message}`)}finally{r.value=!1}},p=async y=>{console.log(`[CacheManagement] Creating cache for: ${y.name} (${y.id})`),alert(`Создание кеша для модуля: ${y.name}
ID: ${y.id}
Это mock функция для тестирования интерфейса.`)},S=async y=>{console.log(`[CacheManagement] Clearing cache for: ${y.name} (${y.id})`),alert(`Очистка кеша для модуля: ${y.name}
ID: ${y.id}
Это mock функция для тестирования интерфейса.`)},C=()=>{v()};return Ae(()=>{v()}),{primaryModules:o,secondaryModules:e,loading:s,error:t,totalModules:i,groupedSecondaryModules:m,individualPrimaryModules:l,timeTrackingModules:u,logicalPrimaryCount:n,clearingAll:r,handleModuleClear:f,handleClearAllCache:k,handleCreateMock:p,handleClearMock:S,refreshModules:C}}},FM={class:"cache-management"},HM={key:0,class:"header-section"},jM={class:"stats-bar"},VM={class:"stat-item"},zM={class:"stat-item"},GM={class:"stat-item"},KM={key:0,class:"global-actions"},qM=["disabled"],YM={key:0},XM={key:1},JM={class:"section-header"},ZM={class:"section-meta"},QM={class:"module-count","aria-label":"{{ logicalPrimaryCount }} основных модулей"},e4={key:0,class:"modules-container"},t4={key:0,class:"modules-grid"},s4={key:1,class:"time-tracking-group"},a4={class:"modules-grid"},o4={key:1,class:"empty-state"},n4={key:2,class:"section-divider"},r4={key:3,class:"cache-section secondary-modules","aria-labelledby":"secondary-modules-heading"},i4={class:"section-header"},l4={class:"section-meta"},c4={class:"module-count","aria-label":"{{ (secondaryModules || []).length }} второстепенных модулей"},d4={class:"grouped-modules"},u4={class:"group-header"},m4={class:"group-title"},g4={class:"group-badge secondary"},h4={class:"modules-grid"},f4={key:4,class:"error-message",role:"alert","aria-live":"assertive"},v4={key:5,class:"loading-overlay",role:"status","aria-live":"polite","aria-label":"Загрузка модулей кеша"};function p4(o,e,s,t,r,i){const n=be("CacheModuleCard");return c(),d("div",FM,[!t.loading&&!t.error?(c(),d("div",HM,[e[6]||(e[6]=a("h1",null,"🗑️ Ручное управление кешем",-1)),e[7]||(e[7]=a("p",{class:"description"}," Управление кешем системы сгруппировано по важности для удобства администрирования ",-1)),a("div",jM,[a("span",VM,[a("strong",null,g(t.totalModules),1),e[3]||(e[3]=ce(" всего модулей ",-1))]),a("span",zM,[a("strong",null,g(t.logicalPrimaryCount),1),e[4]||(e[4]=ce(" основных ",-1))]),a("span",GM,[a("strong",null,g((t.secondaryModules||[]).length),1),e[5]||(e[5]=ce(" дополнительных ",-1))])]),!t.loading&&!t.error?(c(),d("div",KM,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.handleClearAllCache&&t.handleClearAllCache(...l)),disabled:t.clearingAll,class:X(["btn-clear-all",{"btn-disabled":t.clearingAll}])},[t.clearingAll?(c(),d("span",YM,"🧹 Очистка всего кеша...")):(c(),d("span",XM,"🗑️ Очистить весь кеш"))],10,qM)])):$("",!0)])):$("",!0),!t.loading&&!t.error?(c(),d("section",{key:1,class:X(["cache-section primary-modules",{empty:(t.primaryModules||[]).length===0}]),"aria-labelledby":"primary-modules-heading"},[a("div",JM,[e[9]||(e[9]=a("h2",{id:"primary-modules-heading"},"🏆 Основные модули кеша",-1)),a("div",ZM,[a("span",QM,g(t.logicalPrimaryCount),1),e[8]||(e[8]=a("span",{class:"section-badge primary",role:"status","aria-label":"Приоритетные модули"},"Приоритет",-1))])]),e[13]||(e[13]=a("p",{class:"section-description"}," 5 основных модулей для оперативного анализа и мониторинга системы: дашборд сектора 1С, график состояния, графики приема-закрытия и трудозатраты на тикеты сектора 1С. ",-1)),(t.primaryModules||[]).length>0?(c(),d("div",e4,[t.individualPrimaryModules.length>0?(c(),d("div",t4,[(c(!0),d(ee,null,te(t.individualPrimaryModules,l=>(c(),d("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])):$("",!0),(t.timeTrackingModules||[]).length>0?(c(),d("div",s4,[e[10]||(e[10]=a("div",{class:"group-header"},[a("h3",{class:"group-title"},"⏱️ Трудозатраты на тикеты сектора 1С"),a("span",{class:"group-badge"},"Основная группа")],-1)),e[11]||(e[11]=a("p",{class:"group-description"},"Анализ времени работы с задачами в разных режимах отображения",-1)),a("div",a4,[(c(!0),d(ee,null,te(t.timeTrackingModules,l=>(c(),d("div",{key:l.id,class:"module-wrapper"},[ne(n,{module:l,"is-primary":!0,priority:l.priority,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","priority","onClear","onRefresh"])]))),128))])])):$("",!0)])):(c(),d("div",o4,[e[12]||(e[12]=a("p",null,"⚠️ Основные модули кеша не найдены",-1)),a("button",{onClick:e[1]||(e[1]=(...l)=>t.refreshModules&&t.refreshModules(...l)),class:"refresh-btn"},"Обновить список")]))],2)):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),d("div",n4,[...e[14]||(e[14]=[_t('<div class="divider-line" data-v-6a4e8216></div><div class="divider-content" data-v-6a4e8216><span class="divider-icon" data-v-6a4e8216>🔧</span><span class="divider-text" data-v-6a4e8216>Дополнительные модули</span><span class="divider-subtitle" data-v-6a4e8216>Вспомогательные функции системы</span></div><div class="divider-line" data-v-6a4e8216></div>',3)])])):$("",!0),!t.loading&&!t.error&&(t.secondaryModules||[]).length>0?(c(),d("section",r4,[a("div",i4,[e[16]||(e[16]=a("h2",{id:"secondary-modules-heading"},"🔧 Побочные модули кеша",-1)),a("div",l4,[a("span",c4,g((t.secondaryModules||[]).length),1),e[15]||(e[15]=a("span",{class:"section-badge secondary",role:"status","aria-label":"Служебные модули"},"Служебные",-1))])]),e[17]||(e[17]=a("p",{class:"section-description"}," Модули для администрирования и детального мониторинга системы. ",-1)),a("div",d4,[(c(!0),d(ee,null,te(t.groupedSecondaryModules,l=>(c(),d("div",{key:l.type,class:X(["module-group",`group-${l.type}`])},[a("div",u4,[a("h3",m4,g(l.title),1),a("span",g4,g(l.modules.length),1)]),a("div",h4,[(c(!0),d(ee,null,te(l.modules,u=>(c(),d("div",{key:u.id,class:"module-wrapper"},[ne(n,{module:u,"is-primary":!1,"group-type":l.type,onClear:t.handleModuleClear,onRefresh:t.refreshModules},null,8,["module","group-type","onClear","onRefresh"])]))),128))])],2))),128))])])):$("",!0),t.error?(c(),d("div",f4,[e[18]||(e[18]=a("h3",null,"❌ Ошибка загрузки модулей кеша",-1)),a("p",null,g(t.error),1),a("button",{onClick:e[2]||(e[2]=(...l)=>o.loadModules&&o.loadModules(...l)),class:"retry-btn","aria-label":"Повторить загрузку модулей кеша"},"Повторить попытку")])):$("",!0),t.loading?(c(),d("div",v4,[...e[19]||(e[19]=[a("div",{class:"loading-spinner","aria-hidden":"true"},null,-1),a("p",null,"Загрузка модулей кеша...",-1)])])):$("",!0)])}const y4=de(UM,[["render",p4],["__scopeId","data-v-6a4e8216"]]),k4={name:"CacheManagementPage",components:{CacheManagement:y4},beforeCreate(){console.log("[CacheManagementPage] beforeCreate() called")},created(){console.log("[CacheManagementPage] created() called")},beforeMount(){console.log("[CacheManagementPage] beforeMount() called")},setup(){console.log("[CacheManagementPage] setup() called with new hierarchical UI");const o=Xe(),e=I(!1),s=I(null),t=()=>{o.push({name:"index"})};return Ae(()=>{console.log("[CacheManagementPage] onMounted() called - hierarchical cache management ready")}),{loading:e,error:s,goBack:t}}},b4={class:"cache-management-page"},_4={class:"page-header"},w4={class:"page-header-top"},C4={key:0,class:"loading"},T4={key:1,class:"error"},S4={key:2,class:"cache-content"};function D4(o,e,s,t,r,i){const n=be("CacheManagement");return c(),d("div",b4,[a("div",_4,[a("div",w4,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.goBack&&t.goBack(...l)),class:"back-button",title:"Вернуться на главную страницу","aria-label":"Вернуться на главную страницу"},[...e[1]||(e[1]=[a("span",{class:"back-icon","aria-hidden":"true"},"←",-1),a("span",{class:"back-text"},"Назад",-1)])])]),e[2]||(e[2]=a("h1",null,"🗑️ Ручное управление кешем",-1))]),t.loading?(c(),d("div",C4," Загрузка статуса кеша... ")):t.error?(c(),d("div",T4,g(t.error),1)):(c(),d("div",S4,[ne(n)]))])}const E4=de(k4,[["render",D4],["__scopeId","data-v-a20ded38"]]),A4=[{path:"/install",name:"install",component:Ho},{path:"/",name:"index",component:Mw},{path:"/webhook-logs",name:"webhook-logs",redirect:"/admin/webhook-logs"},{path:"/admin/webhook-logs",name:"admin-webhook-logs",component:PS,meta:{requiresAuth:!0,title:"Логи вебхуков",adminOnly:!0}},{path:"/admin/users",name:"admin-users",component:w$,meta:{requiresAuth:!0,title:"Управление пользователями",adminOnly:!0}},{path:"/admin/cache",name:"admin-cache",component:E4,meta:{requiresAuth:!0,title:"Ручное управление кешем",adminOnly:!0}},{path:"/dashboard/sector-1c",name:"dashboard-sector-1c",component:()=>De(()=>Promise.resolve().then(()=>za),void 0,import.meta.url),meta:{requiresAuth:!0,chunk:"dashboard-sector1c"}},{path:"/dashboard/sector/:sectorId",name:"dashboard-sector",component:()=>De(()=>Promise.resolve().then(()=>ur),void 0,import.meta.url),props:o=>({sectorId:o.params.sectorId}),meta:{requiresAuth:!0,chunk:"universal-dashboard"},beforeEnter:(o,e,s)=>{const{SECTORS_CONFIG:t,SectorConfigUtils:r}=require("@/config/sectors.js"),i=o.params.sectorId;if(console.log(`[Router] beforeEnter: checking sector ${i}`),console.log("[Router] Available sectors:",Object.keys(t)),!r.sectorExists(i)){console.warn(`[Router] Sector ${i} does not exist, redirecting to index`),s({name:"index"});return}console.log(`[Router] Sector ${i} exists, allowing navigation`),s(),s()}},{path:"/dashboard/graph-admission-closure",name:"dashboard-graph-admission-closure",component:()=>De(()=>Promise.resolve().then(()=>D1),void 0,import.meta.url),meta:{title:"График приёма и закрытий сектора 1С",description:"Недельные агрегаты новых и закрытых тикетов сектора 1С",requiresAuth:!0,chunk:"admission-dashboard"}},{path:"/dashboard/graph-state",name:"dashboard-graph-state",component:()=>De(()=>Promise.resolve().then(()=>wg),void 0,import.meta.url),meta:{title:"График состояния сектора 1С",description:"Визуализация изменений состояния сектора во времени",requiresAuth:!0,chunk:"graph-state"}},{path:"/dashboard/tickets-time-tracking",name:"dashboard-tickets-time-tracking",component:()=>De(()=>Promise.resolve().then(()=>Cl),void 0,import.meta.url),meta:{title:"Трудозатраты на Тикеты сектора 1С",description:"Трудозатраты сотрудников сектора 1С по неделям",requiresAuth:!0,chunk:"tickets-tracking"}}],vs=co({history:uo(),routes:A4});vs.beforeEach(async(o,e,s)=>{if(console.log("[Router] beforeEach:",{to:o.path,from:e.path,name:o.name}),o.meta.title&&(document.title=`${o.meta.title} - Bitrix24 Dashboard`),o.meta.requiresAuth){console.log("[Router] requiresAuth check for:",o.path);try{const t=await rt.checkAccess();if(!t.allowed){console.warn("Unauthorized access attempt to:",o.path,t.errorMessage),s({name:"index"});return}}catch(t){console.error("Error checking access in navigation guard:",t),s();return}}if(o.meta.adminOnly)try{const t=await rt.getCurrentUser();if(!t||!es(t)){console.warn("Admin access required for:",o.path),s({name:"index"});return}}catch(t){console.error("Error checking admin access in navigation guard:",t),s({name:"index"});return}if(e.name!==null&&o.path!==e.path)try{if((await rt.checkAccess()).allowed){const r=await rt.getCurrentUser();r&&is.logPageVisit(o,r,e).catch(i=>{console.error("[Router] Error logging page visit:",i)})}}catch(t){console.error("[Router] Error in activity logging:",t)}if(o.name==="index"&&!e.name&&setTimeout(()=>{De(()=>Promise.resolve().then(()=>za),void 0,import.meta.url)},1e3),o.meta.chunk)switch(o.meta.chunk){case"dashboard-sector1c":setTimeout(()=>{De(()=>Promise.resolve().then(()=>bp),void 0,import.meta.url)},500);break;case"admission-dashboard":setTimeout(()=>{De(()=>import("./chunk-Bzh5eqmy.js").then(t=>t.l),__vite__mapDeps([3,4]),import.meta.url)},500);break}console.log("[Router] Allowing navigation to:",o.path),s()});setTimeout(()=>{const o=window.location.pathname,e=window.location.hash;e&&e!=="#/"||(o.includes("install.php")?vs.replace("/install"):vs.replace("/"))},0);class cs{static startBundleLoad(){this.metrics.bundleLoadTime=performance.now()}static endBundleLoad(e){const s=performance.now()-this.metrics.bundleLoadTime;this.metrics.chunkLoadTimes.set(e,s),console.log(`📦 Chunk "${e}" loaded in ${s.toFixed(2)}ms`),window.gtag&&window.gtag("event","bundle_load",{chunk_name:e,load_time:s}),s>1e3&&console.warn(`🐌 Slow chunk load: ${e} took ${s.toFixed(2)}ms`)}static trackComponentLoad(e,s){const t=performance.now()-s;this.metrics.componentLoadTime.set(e,t),console.log(`🧩 Component "${e}" loaded in ${t.toFixed(2)}ms`),t>500&&console.warn(`🐌 Slow component load: ${e} took ${t.toFixed(2)}ms`)}static trackApiCall(e,s){this.metrics.apiResponseTime.set(e,s),s>1e3&&console.warn(`🐌 Slow API call to ${e}: ${s}ms`)}static getReport(){const e=Array.from(this.metrics.componentLoadTime.values()),s=Array.from(this.metrics.apiResponseTime.values()),t=Array.from(this.metrics.chunkLoadTimes.values());return{totalChunks:this.metrics.chunkLoadTimes.size,totalComponents:this.metrics.componentLoadTime.size,totalApiCalls:this.metrics.apiResponseTime.size,averageComponentLoadTime:e.length>0?e.reduce((r,i)=>r+i,0)/e.length:0,averageApiResponseTime:s.length>0?s.reduce((r,i)=>r+i,0)/s.length:0,averageChunkLoadTime:t.length>0?t.reduce((r,i)=>r+i,0)/t.length:0,slowestComponents:Array.from(this.metrics.componentLoadTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i})),slowestApiCalls:Array.from(this.metrics.apiResponseTime.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({endpoint:r,time:i})),slowestChunks:Array.from(this.metrics.chunkLoadTimes.entries()).sort(([,r],[,i])=>i-r).slice(0,5).map(([r,i])=>({name:r,time:i}))}}static clearMetrics(){this.metrics.bundleLoadTime=0,this.metrics.componentLoadTime.clear(),this.metrics.apiResponseTime.clear(),this.metrics.chunkLoadTimes.clear()}}je(cs,"metrics",{bundleLoadTime:0,componentLoadTime:new Map,apiResponseTime:new Map,chunkLoadTimes:new Map});class $4{static init(){this.initChunkLoadErrorHandling(),this.initUnhandledErrorHandling(),this.initNetworkErrorHandling()}static initChunkLoadErrorHandling(){if(window.addEventListener("error",e=>{e.target.tagName==="SCRIPT"&&(console.error("❌ Chunk loading error:",e.target.src),this.reportError("chunk_load_error",{url:e.target.src,message:e.message||"Script load failed"}))}),"PerformanceObserver"in window)try{new PerformanceObserver(s=>{for(const t of s.getEntries())if(t.entryType==="resource"&&t.name.includes(".js")){const r=t.responseEnd-t.requestStart;cs.trackApiCall(t.name,r)}}).observe({entryTypes:["resource"]})}catch{console.warn("PerformanceObserver not supported")}}static initUnhandledErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("❌ Unhandled promise rejection:",e.reason),this.reportError("unhandled_rejection",{reason:e.reason?.message||String(e.reason),stack:e.reason?.stack})}),window.addEventListener("error",e=>{e.error&&e.filename&&(console.error("❌ Unhandled error:",e.error),this.reportError("unhandled_error",{message:e.error.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error.stack}))})}static initNetworkErrorHandling(){const e=window.fetch;window.fetch=function(...s){const t=performance.now();return e.apply(this,s).then(r=>{const i=performance.now()-t;return cs.trackApiCall(s[0],i),r.ok||console.warn(`🚨 API error: ${r.status} ${r.statusText} for ${s[0]}`),r}).catch(r=>{const i=performance.now()-t;throw console.error(`❌ Network error for ${s[0]}:`,r),cs.trackApiCall(s[0],i),this.reportError("network_error",{url:s[0],message:r.message,loadTime:i}),r})}}static reportError(e,s){const t={type:e,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,...s};if(console.error("📊 Error report:",t),window.Sentry&&window.Sentry.captureException(new Error(`${e}: ${JSON.stringify(s)}`)),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:"/api/log-error.php",method:"POST",data:t})}catch(r){console.error("Failed to send error report to Bitrix24:",r)}window.gtag&&window.gtag("event","exception",{description:`${e}: ${s.message||"Unknown error"}`,fatal:!1})}static getErrorStats(){return{chunkLoadErrors:0,networkErrors:0,unhandledErrors:0,totalErrors:0}}}const Ks=mo(Eo);Ks.use(vs);const I4=o=>{try{const e=new WeakSet;return JSON.stringify(o,(s,t)=>{if(typeof t=="object"&&t!==null){if(e.has(t))return"[Circular]";e.add(t)}return typeof t=="function"||t===void 0?null:t})}catch{return String(o)}};Ks.config.errorHandler=(o,e,s)=>{if(o instanceof TypeError&&o.message.includes("Cannot read properties of undefined (reading 'type')")){console.warn("Caught undefined.type error:",{error:o.message,component:e?.$options?.name||"Unknown",info:s,stack:o.stack});return}if(console.error("Vue error:",o,s),typeof BX<"u"&&BX.ajax)try{BX.ajax({url:et("/api/log-error.php"),method:"POST",data:{error:o?.message||String(o),info:typeof s=="string"?s:I4(s),component:e?.$options?.name||"Unknown"}})}catch(t){console.error("Failed to log error:",t)}};Ks.mount("#app");$4.init();export{de as _,Nt as a,bt as b,J as c,xw as d,zs as e,jt as f,T$ as g,gt as i,Ht as n};
