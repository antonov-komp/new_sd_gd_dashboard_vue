import{a as re}from"./chunk-CEPkt3e7.js";import{C as _,L as g,f as Z,h as ae,i as N,j as $,b as U,k as C,l as h,n as se,m as ne,o as ie,E as oe,p as P,S as j}from"./chunk-CCQQUMtL.js";import{g as J,a as Q,b as ce,c as le,m as W,d as de,e as ue,f as V}from"./chunk-CYuVzfAf.js";import{B as G}from"./chunk-C7JhVT7I.js";class z{static notifyCacheCreationStarted(e){this.showNotification({content:`–ù–∞—á–∞—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞ –¥–ª—è –º–æ–¥—É–ª—è "${e}"...`,type:"info",autoHideDelay:3e3})}static notifyCacheCreationSuccess(e){this.showNotification({content:`‚úÖ –ö–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`,type:"success",autoHideDelay:5e3})}static notifyCacheCreationError(e,t){this.showNotification({content:`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ—à–∞ –¥–ª—è –º–æ–¥—É–ª—è "${e}": ${t}`,type:"error",autoHideDelay:7e3})}static notifyCacheUpdated(e,t="auto"){const r=t==="manual"?"–≤—Ä—É—á–Ω—É—é":"–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏";this.showNotification({content:`üîÑ –ö–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}" –æ–±–Ω–æ–≤–ª—ë–Ω ${r}`,type:"info",autoHideDelay:4e3})}static notifyCacheUsed(e){this.showNotification({content:`‚ö° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}"`,type:"success",autoHideDelay:3e3})}static showNotification(e){typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:e.content,autoHideDelay:e.autoHideDelay||3e3}):console.log("[CacheNotification]",e.content)}}const je=Object.freeze(Object.defineProperty({__proto__:null,CacheNotificationService:z},Symbol.toStringTag,{value:"Module"}));class fe{static async getEmployeesByIds(e,t=!0){if(!Array.isArray(e)||e.length===0)return[];if(t){const r=_.getEmployeesCacheKey(e),s=_.get(r);if(s!==null)return g.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),s}try{const r=await Z.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(r&&r.result&&(Array.isArray(r.result)?s=r.result:g.warn("Unexpected user.get result format","EmployeeRepository",r)),t){const n=_.getEmployeesCacheKey(e);_.set(n,s,_.EMPLOYEES_TTL)}return s}catch(r){return g.error("Error getting employees by IDs","EmployeeRepository",r),[]}}}function O(a){const e=parseInt(a.id||a.ID||0),t=a.title||a.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",r=a.stageId||a.STAGE_ID||"",s=a.assignedById||a.ASSIGNED_BY_ID||null,n=a.createdTime||a.CREATED_DATE||a.CREATED_TIME||"",i=a.updatedTime||a.MODIFY_DATE||a.UPDATED_TIME||"",c=a.UF_SUBJECT||a.uf_subject||a.ufSubject||a.UF_SUBJECT||a.uf_subject||null,o=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||null;let l=null,u=null;if(o){const w=String(o).trim();w.length>0&&(u=w,l=w.length>17?w.substring(0,17):w)}const f=a.UF_CRM_7_UF_PRIORITY||a.uf_crm_7_uf_priority||a.ufCrm7UfPriority||a.UF_CRM_7_UF_PRIORITY||a.uf_crm_7_uf_priority||a.priority||a.PRIORITY||null,d=J(f),p=Q(d),m=a.UF_SLA_SERVICE_STR||a.uf_sla_service_str||a.UfSlaServiceStr||a.ufSlaServiceStr||a.service||null,y=ce(m),S=le(y),E=a.UF_ACTION_STR||a.uf_action_str||a.UfActionStr||a.ufActionStr||a.UF_ACTION_STR||a.uf_action_str||null,k=E?String(E).trim():null,te=k&&k.length>0?k:null;return{id:e,title:t,ufSubject:c,departmentHead:l,departmentHeadFull:u,priorityId:d.id,priorityLabel:d.label,priorityColors:p,priority:d.id,priorityBitrixValue:d.bitrixValue||null,service:y,serviceLabel:y.label,serviceColors:S,serviceBitrixValue:y.bitrixValue||de().bitrixValue,actionStr:te,status:pe(),assigneeId:s?parseInt(s):null,stageId:W(r),createdAt:n,modifiedAt:i,amount:a.opportunity||a.OPPORTUNITY||0,currency:a.currencyId||a.CURRENCY_ID||"RUB",description:a.comments||a.COMMENTS||""}}function pe(a){return"in_progress"}function me(a){const e=ae(a);return{id:parseInt(a.ID||a.id||0),name:`${a.NAME||a.name||""} ${a.LAST_NAME||a.lastName||""}`.trim()||a.EMAIL||a.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:a.WORK_POSITION||a.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:a.EMAIL||a.email||"",sectorId:e,departmentId:a.UF_DEPARTMENT||null,tickets:[]}}function ge(a){return Array.isArray(a)?a.map(e=>me(e)):[]}const ye="1C",he=["1–°"],R=new Map,K=100;function x(a){return a.UF_CRM_7_TYPE_PRODUCT||a.uf_crm_7_type_product||a.ufCrm7TypeProduct||a.UF_CRM_7_TYPE_PRODUCT||a.uf_crm_7_type_product||null}function b(a){return a==null?null:String(a).trim().toUpperCase().replace(/–°/g,"C")||null}function ee(a){if(!a)return[];if(Array.isArray(a))return a.map(b).filter(Boolean);if(typeof a=="object"&&a.value!==void 0){const t=b(a.value);return t?[t]:[]}const e=b(a);return e?e.split(/[;,]/).map(t=>t.trim()).filter(Boolean):[]}function q(a){const e=x(a),t=ee(e);return t.length===0?!1:t.some(r=>r===ye||he.includes(r))}function Se(a){return`filter:${a.map(t=>t.id||t.ID||"").sort().join(",")}`}function _e(){R.size>K&&Array.from(R.keys()).slice(0,Math.floor(K*.2)).forEach(e=>R.delete(e))}function Ee(a){if(!Array.isArray(a))return[];const e=Se(a),t=R.get(e);if(t!==void 0)return t;const r=a.filter(q);try{const s=N();if(s&&$()){const n=a.filter(o=>!q(o)),i=[],c=new Set;a.forEach(o=>{const l=x(o),u=ee(l),f=l==null?"":String(l);l!=null&&!c.has(f)&&(c.add(f),i.push({value:l,normalized:u,type:typeof l,isArray:Array.isArray(l),ticketId:o.id||o.ID}))}),s.logFiltering(a.length,r.length,n,i)}}catch(s){console.warn("Diagnostics logging error in filterBySector:",s)}return R.set(e,r),_e(),r}const M=1051;function F(a){if(!a||typeof a!="object")return null;let e=a.assignedById||a.ASSIGNED_BY_ID||a.assignedByIdId||a.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function Y(a){if(a==null)return null;typeof a=="object"&&(a=a.id||a.ID||a.value||null);const e=typeof a=="number"?a:parseInt(a);return isNaN(e)||e<=0?null:e}function Ie(a,e=M){const t=F(a),r=Y(t);return r===null||r===e}function Te(a,e){Array.isArray(a)||(g.warn("Tickets is not an array","TicketGrouper",a),a=[]),Array.isArray(e)||(g.warn("Employees is not an array","TicketGrouper",e),e=[]);const t=e.filter(o=>(o.id?parseInt(o.id):null)!==M),r=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:t.map(o=>({...o,isFromSector1C:o.sectorId===U.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:t.map(o=>({...o,isFromSector1C:o.sectorId===U.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:t.map(o=>({...o,isFromSector1C:o.sectorId===U.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(r.map(o=>[o.id,o])),n=new Map;r.forEach(o=>{const l=new Map(o.employees.map(u=>[u.id,u]));n.set(o.id,l)});const i=[],c=[];a.forEach(o=>{const l=W(o.stageId||o.STAGE_ID||""),u=s.get(l);if(!u){c.push({id:o.id||o.ID,title:o.title||o.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:o.stageId||o.STAGE_ID,assignedById:F(o)});return}const f=F(o),d=Y(f);if(d!==M)if(d){const p=n.get(l);let m=p.get(d);m||(m={id:d,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${d}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},u.employees.push(m),p.set(d,m));const y=O(o),S={...y,stageId:o.stageId||o.STAGE_ID||y.stageId,departmentHead:y.departmentHead||null,departmentHeadFull:y.departmentHeadFull||y.departmentHead||null};m.tickets.push(S),m.isFromSector1C?m.ticketsInsideSector.push(S):m.ticketsOutsideSector.push(S)}else i.push({id:o.id||o.ID,title:o.title||o.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:l,assignedById:f})}),r.forEach(o=>{o.employees.sort((l,u)=>l.isFromSector1C&&!u.isFromSector1C?-1:!l.isFromSector1C&&u.isFromSector1C?1:(l.id||0)-(u.id||0))});try{const o=N();if(o&&$()){const l={};r.forEach(f=>{let d=0,p=0;f.employees.forEach(m=>{d+=(m.ticketsInsideSector||[]).length,p+=(m.ticketsOutsideSector||[]).length}),l[f.id]={insideSector:d,outsideSector:p,total:d+p}});const u=o.metrics.grouping;Object.keys(l).forEach(f=>{u.distributionByStages[f]||(u.distributionByStages[f]={employees:{},total:0}),u.distributionByStages[f].insideSector=l[f].insideSector,u.distributionByStages[f].outsideSector=l[f].outsideSector,u.distributionByStages[f].total=l[f].total}),o.logGrouping(r,i,c)}}catch(o){g.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",o)}return r}function De(a){const e={formed:[],review:[],execution:[]};if(!Array.isArray(a))return g.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",a),e;a.filter(t=>Ie(t)).forEach(t=>{const r=W(t.stageId||t.STAGE_ID||"");if(e[r]){const s=O(t),n={...s,stageId:t.stageId||t.STAGE_ID||s.stageId,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null};e[r].push(n)}});try{const t=N();t&&$()&&t.logZeroPoint(e)}catch(t){g.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",t)}return e}function Ae(a){if(!Array.isArray(a))return[];const e=new Set,t=[],r=[];a.forEach(n=>{const i=F(n),c=Y(i);!i||i===null||i===void 0?t.push({id:n.id||n.ID,title:n.title||n.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:n.stageId||n.STAGE_ID}):c===M&&r.push({id:n.id||n.ID,title:n.title||n.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:n.stageId||n.STAGE_ID}),c&&e.add(c)});const s=Array.from(e);try{const n=N();n&&$()&&n.logEmployees(s,t,r)}catch(n){g.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",n)}return s}const H=new Map,we=10*60*1e3;function Ce(a){if(!a||typeof a!="object")return{};const e={},t=Object.keys(a);for(const r of t)r.toUpperCase().startsWith("UF_")&&(e[r]=a[r]);return e}function Re(a,e=null,t=!0){if(t&&e&&H.has(e)){const n=H.get(e),i=Date.now();if(n.timestamp&&i-n.timestamp<we)return n.data;H.delete(e)}const r=Ce(a),s={typeProduct:r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||null,all:r};return t&&e&&H.set(e,{data:s,timestamp:Date.now()}),s}let ve=class{static async getTicketDetails(e,t={}){const{select:r=["*"],useOriginalUfNames:s=!0,useCache:n=!0}=t;try{const i=await C.getTicket(e);if(!i)throw new Error(`–¢–∏–∫–µ—Ç —Å ID ${e} –Ω–µ –Ω–∞–π–¥–µ–Ω`);const c=Re(i,e,n),o=i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.ufCrm7UfPriority||i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.priority||i.PRIORITY||null,l=J(o),u=Q(l);return{id:i.id||i.ID,title:i.title||i.TITLE,stageId:i.stageId||i.STAGE_ID,assignedById:i.assignedById||i.ASSIGNED_BY_ID,createdAt:i.createdTime||i.CREATED_TIME||i.CREATED_DATE,updatedAt:i.updatedTime||i.UPDATED_TIME||i.MODIFY_DATE,priorityId:l.id,priorityLabel:l.label,priorityColors:u,priority:l.id,priorityBitrixValue:l.bitrixValue||null,opportunity:i.opportunity||i.OPPORTUNITY,currencyId:i.currencyId||i.CURRENCY_ID,comments:i.comments||i.COMMENTS,additionalFields:c,rawData:i}}catch(i){throw g.error("Error getting ticket details","TicketDetailsService",i),i}}};class X{static async getSectorData(e=!0,t=!1,r=null){let s=!1;try{if($()){const n=N();n&&n.reset()}}catch(n){g.warn("Error resetting diagnostics","DashboardSector1CService",n)}if(r&&r(h("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),t)try{r&&r(h("backend_cache_check",5,{description:"–ü—Ä–æ–≤–µ—Ä–∫–∞ backend –∫–µ—à–∞..."}));const n=await fetch("/api/services/dashboard-sector-1c.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getSectorDataCached",params:{forceRefresh:!1,ttl:600}})});if(n.ok){const i=await n.json();if(i.success&&i.data)return r&&r(h("backend_cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ backend –∫–µ—à–∞"})),i.cache_created===!0&&z.notifyCacheCreationSuccess("–î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° (backend)"),i.data}g.warn("Backend cache miss or error, falling back to frontend logic","DashboardSector1CService")}catch(n){g.warn("Backend cache request failed, falling back to frontend logic","DashboardSector1CService",n)}if(e){const n=_.getSectorDataCacheKey(),i=_.get(n);if(i!==null)return r&&r(h("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ in-memory –∫–µ—à–∞"})),i}try{r&&r(h("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const n=ue(),i=await C.getAllTickets(n,p=>{if(r){const m=se(p),y=ne(10,40,m.progress||0);r(h(m.step||"loading_tickets",y,{...m.details,warning:m.details.warning}))}},e);r&&r(h("filtering",50,{totalTickets:i.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${i.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const c=Ee(i);r&&r(h("filtering",50,{totalTickets:i.length,filteredTickets:c.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${i.length}`})),r&&r(h("extracting_employees",60,{filteredTickets:c.length,description:`–ê–Ω–∞–ª–∏–∑ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const o=Ae(c);r&&r(h("extracting_employees",60,{employeeCount:o.length,description:`–ù–∞–π–¥–µ–Ω–æ ${o.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),r&&r(h("loading_employees",65,{employeeCount:o.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${o.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`})),ie();const l=await fe.getEmployeesByIds(o),u=ge(l);r&&r(h("loading_employees",90,{employeeCount:u.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${u.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),r&&r(h("grouping",90,{filteredTickets:c.length,employeeCount:u.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${u.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const d={stages:Te(c,u),employees:u,zeroPointTickets:De(c)};if(r&&r(h("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),e){const p=_.getSectorDataCacheKey();_.set(p,d,_.TICKETS_TTL),s=!0}return r&&r(h("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),s&&!t&&z.notifyCacheCreationSuccess("–î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–°"),d}catch(n){throw g.error("Error getting sector data","DashboardSector1CService",n),r&&r({step:"error",progress:0,error:n.message}),n}}static async assignTicket(e,t,r){try{const s=V(r),n=await C.assignTicket(e,t,s);return n&&_.invalidateTicketsCache(),n}catch(s){throw g.error("Error assigning ticket","DashboardSector1CService",s),s}}static async createTicket(e){try{const t=V(e.stageId||"formed"),r={title:e.title,stageId:t};e.employeeId&&(r.assignedById=e.employeeId);const s=await C.createTicket(r);return s>0&&_.invalidateTicketsCache(),s}catch(t){throw g.error("Error creating ticket","DashboardSector1CService",t),t}}static async getTicket(e){try{const t=await C.getTicket(e);return O(t)}catch(t){throw g.error("Error getting ticket","DashboardSector1CService",t),t}}static async getTicketDetails(e,t={}){try{return await ve.getTicketDetails(e,t)}catch(r){throw g.error("Error getting ticket details","DashboardSector1CService",r),r}}static async addComment(e,t){try{return(await Z.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+oe,comment:t}})).result!==void 0}catch(r){throw g.error("Error adding comment","DashboardSector1CService",r),r}}}const I={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Le{static getApiBaseUrl(){return re()}static async createSnapshot(e,t,r={}){try{if(!e||typeof e!="object")throw new D("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new D("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const s=this.validateSectorData(e);if(!s.isValid)throw new D(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${s.errors.join(", ")}`,"VALIDATION_ERROR",{validation:s});const n=this.normalizeSectorData(e),c={metadata:this.generateSnapshotMetadata(t,r.createdBy,r.sectorId||I.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},o=this.validateSnapshot(c);if(!o.isValid)throw new D(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",o.warnings);const l=this.getApiBaseUrl(),u=await fetch(`${l}${I.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:t,date:this.formatDate(new Date)})});if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const f=await u.json();if(!f.success)throw new Error(f.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return f.data.snapshot}catch(s){throw console.error("SnapshotService.createSnapshot error:",s),s instanceof D?s:new D(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${s.message}`,"API_ERROR",{originalError:s})}}static async getSnapshot(e,t){try{const r=this.formatDate(e),n=`${this.getApiBaseUrl()}${I.snapshotsEndpoint}?action=get&date=${r}&type=${t}`,i=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(i.status===404)return null;if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const c=await i.json();if(!c.success){if(c.message&&c.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω"))return null;throw new Error(c.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞")}return c.data.snapshot}catch(r){throw console.error("SnapshotService.getSnapshot error:",r),r}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",I.defaultSectorId);const s=`${this.getApiBaseUrl()}${I.snapshotsEndpoint}?${t.toString()}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.json();if(!i.success)throw new Error(i.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(i.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(l){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${o.date}/${o.type}:`,l),null}}))).filter(o=>o!==null).sort((o,l)=>new Date(o.metadata.createdAt)-new Date(l.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:r=[],zeroPointTickets:s={}}=e,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},i=[],c=[],o=[];t.forEach(f=>{const d=f.id;if(n[d]){let p=0;f.employees.forEach(m=>{const y=m.tickets||[];p+=y.length;let S=i.find(E=>E.id===m.id);S||(S={id:m.id,name:m.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},i.push(S)),y.forEach(E=>{c.push(E.id),o.push({id:E.id,title:E.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:m.id,name:m.name},createdAt:E.createdAt||"",updatedAt:E.modifiedAt||E.updatedAt||""}),S.ticketsByStage[d]=(S.ticketsByStage[d]||0)+1,S.totalTickets+=1})}),n[d].count=p}});const l={unassigned:0,keeper:0,total:0};Object.values(s).forEach(f=>{Array.isArray(f)&&f.forEach(d=>{l.total+=1,d.assigneeId===1051||d.assignedById===1051?l.keeper+=1:l.unassigned+=1,c.push(d.id),o.push({id:d.id,title:d.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const u=Object.values(n).reduce((f,d)=>f+d.count,0)+l.total;return{statistics:{stages:{...n,total:u},employees:i,zeroPoint:l},ticketIds:[...new Set(c)],tickets:o}}static generateSnapshotMetadata(e,t,r){const s=new Date,n=-s.getTimezoneOffset(),i=Math.floor(n/60),c=n%60,o=`${i>=0?"+":""}${String(i).padStart(2,"0")}:${String(c).padStart(2,"0")}`,l=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${o}`;return{version:I.snapshotVersion,createdAt:l,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:r,sectorName:r==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${r}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${s}`}static buildFilePath(e,t){const r=typeof e=="string"?new Date(e):e,s=r.getFullYear(),n=this.getWeekNumber(r),i=this.formatDate(e);let c;if(t==="current"){const o=new Date,l=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`current-state-${i}-${l}.json`}else if(t==="manual"){const o=new Date,l=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;c=`manual-${i}-${l}.json`}else c=`${t}-${i}.json`;return t==="current"?`current/${c}`:`${s}/week-${n}/${c}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),r=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-r);const s=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-s)/864e5+1)/7)}static validateSnapshot(e){const t=[],r=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const s=e.statistics.stages,n=(s.formed?.count||0)+(s.review?.count||0)+(s.execution?.count||0);s.total!==n&&r.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${n}, —É–∫–∞–∑–∞–Ω–æ ${s.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const s=e.statistics.zeroPoint,n=(s.unassigned||0)+(s.keeper||0);s.total!==n&&r.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${n}, —É–∫–∞–∑–∞–Ω–æ ${s.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const s=new Set(e.ticketIds),n=new Set(e.tickets.map(i=>i.id));s.size!==n.size&&r.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((i,c)=>{i.id||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),i.title||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!i.assignedTo||!i.assignedTo.id)&&r.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),i.createdAt||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),i.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:r}}static validateSectorData(e){const t=[],r=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:r}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:r})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const r=this.formatDate(e),n=`${this.getApiBaseUrl()}${I.snapshotsEndpoint}`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:r,type:t})});if(i.status===404)return!1;if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const c=await i.json();if(!c.success)throw new Error(c.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(r){throw console.error("SnapshotService.deleteSnapshot error:",r),r}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let r=0;for(const s of t)try{await this.deleteSnapshot(s.metadata.createdAt.split("T")[0],s.metadata.type)&&r++}catch(n){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${s.metadata.createdAt}:`,n)}return r}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,t=I.snapshotVersion){const r=this.getSnapshotVersion(e);return r===t||r==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${r} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,r=this.getWeekNumber(t);return{year:t.getFullYear(),week:r}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,s=(t.getDay()||7)-1,n=new Date(t);return n.setDate(t.getDate()-s),n.setHours(0,0,0,0),n}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,s=7-(t.getDay()||7),n=new Date(t);return n.setDate(t.getDate()+s),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),r=this.getWeekEndDate(e),s=this.getWeekNumberInfo(e),n=await this.getAllSnapshots({startDate:t,endDate:r}),i=n.find(l=>l.metadata.type==="week_start")||null,c=n.find(l=>l.metadata.type==="week_end")||null,o=n.filter(l=>l.metadata.type==="manual");return{weekStart:i,weekEnd:c,manual:o,weekInfo:s}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof D)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),r={week_start:0,week_end:0,manual:0,current:0},s=new Map;let n=null,i=null;t.forEach(o=>{const l=o.metadata.type;r.hasOwnProperty(l)&&r[l]++;const u=this.getWeekNumberInfo(o.metadata.createdAt),f=`${u.year}-W${u.week}`;s.set(f,(s.get(f)||0)+1);const d=new Date(o.metadata.createdAt);(!n||d<new Date(n.metadata.createdAt))&&(n=o),(!i||d>new Date(i.metadata.createdAt))&&(i=o)});const c=Array.from(s.entries()).map(([o,l])=>{const[u,f]=o.split("-W");return{year:parseInt(u),week:parseInt(f),count:l}}).sort((o,l)=>o.year!==l.year?o.year-l.year:o.week-l.week);return{total:t.length,byType:r,byWeek:c,oldest:n,newest:i}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class D extends Error{constructor(e,t,r={}){super(e),this.name="SnapshotError",this.code=t,this.details=r}}const T={formed:{bitrixId:j.formed,name:P.FORMED.name},review:{bitrixId:j.review,name:P.REVIEW.name},execution:{bitrixId:j.execution,name:P.EXECUTION.name}},v=M;function Oe(a){if(!a||typeof a!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!a.stages||!Array.isArray(a.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Me(a.stages),t=Ne(a.stages),r=$e(a.zeroPointTickets||{}),s=He(a.zeroPointTickets||{}),n=Be(a.stages,a.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:r,zeroPointByStage:s},ticketIds:n.ticketIds,tickets:n.tickets}}function Me(a){const e={formed:{count:0,stageId:T.formed.bitrixId,stageName:T.formed.name},review:{count:0,stageId:T.review.bitrixId,stageName:T.review.name},execution:{count:0,stageId:T.execution.bitrixId,stageName:T.execution.name},total:0};return a.forEach(t=>{if(!T[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let r=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(s=>{s.tickets&&Array.isArray(s.tickets)&&(r+=s.tickets.length)}),e[t.id].count=r,e.total+=r}),e}function Ne(a){const e=new Map;return a.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(r=>{if(!r||!r.id)return;e.has(r.id)||e.set(r.id,{id:r.id,name:r.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${r.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const s=e.get(r.id),n=r.tickets&&Array.isArray(r.tickets)?r.tickets.length:0;T[t.id]&&(s.ticketsByStage[t.id]=(s.ticketsByStage[t.id]||0)+n),s.totalTickets+=n})}),Array.from(e.values())}function $e(a){let e=0,t=0;return!a||typeof a!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(a).forEach(r=>{Array.isArray(r)&&r.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?e++:(typeof n=="object"?n.id:n)===v?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function He(a){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!a||typeof a!="object"||Object.keys(e).forEach(t=>{const r=a[t];Array.isArray(r)&&r.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?e[t].unassigned++:(typeof n=="object"?n.id:n)===v?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function Be(a,e){const t=new Set,r=new Map;return Array.isArray(a)&&a.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(i=>{if(!i||!i.id){console.warn("Ticket without ID found:",i);return}const c=parseInt(i.id);if(isNaN(c)){console.warn("Invalid ticket ID:",i.id);return}t.add(c);let o=i.assignedTo;!o&&n.id&&(o={id:n.id,name:n.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${n.id}`}),r.set(c,{id:c,title:i.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o||null,createdAt:B(i.createdAt||i.createdTime),updatedAt:B(i.updatedAt||i.modifiedAt||i.updatedTime),stageId:i.stageId||s.id||null,departmentHead:i.departmentHead||null,departmentHeadFull:i.departmentHeadFull||i.departmentHead||null,priorityId:i.priorityId||null,priorityLabel:i.priorityLabel||null,service:i.service||null,serviceLabel:i.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const i=parseInt(n.id);if(isNaN(i)){console.warn("Invalid ticket ID in zero point:",n.id);return}t.add(i);let c=n.assignedTo;if(!c&&n.assignedById){const o=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;o&&o!==v?c={id:o,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:o===v&&(c={id:v,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}r.set(i,{id:i,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:c||null,createdAt:B(n.createdAt||n.createdTime),updatedAt:B(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})}),{ticketIds:Array.from(t).sort((s,n)=>s-n),tickets:Array.from(r.values())}}function B(a){if(!a)return null;if(a instanceof Date)return a.toISOString();if(typeof a=="string"){if(a.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return a;const e=new Date(a);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",a),null}class ze{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,useBackendCache:r=!1,onProgress:s=null,normalize:n=!0,includeTicketDetails:i=!1}=e;try{const c=await X.getSectorData(t,r,s);return n?Oe(c):(i&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),c)}catch(c){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",c),c}}static async isDataAvailable(){try{const e=await X.getSectorData(!0);return e!=null}catch{return!1}}}const L=140,A=new Map;class We{static async getTicketDetails(e){if(!e)return console.warn("Ticket ID is required"),null;try{const t=await G.call("crm.item.list",{entityTypeId:L,filter:{id:e},select:["*"],useOriginalUfNames:"Y"});let r=[];if(t&&t.result&&(Array.isArray(t.result)?r=t.result:t.result.items&&Array.isArray(t.result.items)?r=t.result.items:t.result.data&&Array.isArray(t.result.data)&&(r=t.result.data)),!r||r.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${e} not found`),null;const s=r[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s),ticketSample:JSON.stringify(s).substring(0,500)});const n=O(s),i=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:i,mappedDepartmentHead:n.departmentHead,departmentHeadFull:i?String(i).trim():null});let c=null;if(i){const o=String(i).trim();o.length>0&&(c=o)}return{...n,departmentHeadFull:c}}catch(t){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${e}:`,t),console.error("[TicketDetailsService] Error details:",{message:t.message,stack:t.stack,ticketId:e}),null}}static async getTicketsDetails(e){if(!e||!Array.isArray(e)||e.length===0)return[];const t=[],r=[];if(e.forEach(s=>{A.has(s)?t.push(A.get(s)):r.push(s)}),r.length===0)return t;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:r.length,ticketIdsSample:r.slice(0,5),entityTypeId:L});const s=await G.call("crm.item.list",{entityTypeId:L,filter:{id:r},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!s,resultType:typeof s,resultKeys:s?Object.keys(s):[],hasResultResult:!!s?.result,resultResultType:typeof s?.result,isArray:Array.isArray(s?.result),resultResultLength:Array.isArray(s?.result)?s.result.length:"not array",fullResult:s});let n=[];if(s&&s.result&&(Array.isArray(s.result)?n=s.result:s.result.items&&Array.isArray(s.result.items)?n=s.result.items:s.result.data&&Array.isArray(s.result.data)&&(n=s.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!s,hasResultResult:!!s?.result,resultType:typeof s?.result,result:s,resultKeys:s?Object.keys(s):[]}),t;const i=n.map((c,o)=>{o===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const l=O(c);o===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:l.id,hasDepartmentHead:!!l.departmentHead,departmentHead:l.departmentHead,mappedTicketKeys:Object.keys(l).filter(p=>p.toLowerCase().includes("department"))});const u=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;o===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:u,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm"))});let f=null;if(u){const p=String(u).trim();p.length>0&&(f=p)}!f&&l.departmentHead&&(f=l.departmentHead);const d={...l,departmentHeadFull:f||l.departmentHead||null};return o===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&A.set(d.id,d),d});return[...t,...i]}catch(s){return console.error("[TicketDetailsService] Error loading tickets details batch:",s),console.error("[TicketDetailsService] Error details:",{message:s.message,stack:s.stack,ticketIdsCount:e.length,ticketIdsSample:e.slice(0,5)}),t}}static clearCache(e=1e3){A.size>e&&A.clear()}static getCacheSize(){return A.size}}export{z as C,X as D,Le as S,We as T,ze as a,je as c};
