import{_ as _e,r as _,c as U,m as he,G as De,a as T,o as k,b as c,d as P,g as me,F as re,f as oe,n as ve,t as W,p as V,H as be,v as fe,l as Ae,x as Ge,I as Xe,u as we,L as ze,C as He,J as Ke,j as ge,k as qe,i as Ye,B as Je,K as Ze,D as Qe,M,q as je,N as Ue,e as et,y as tt}from"./main-ZGXLZG87.js";import{L as Ve,D as at,B as st}from"./index-Cd9fxKGI.js";import{S as Te,d as Ee,K as nt,D as Le}from"./index-DlvxMCs7.js";const K={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class G{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,s={}){try{if(!e||typeof e!="object")throw new Y("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new Y("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const n=this.validateSectorData(e);if(!n.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${n.errors.join(", ")}`,"VALIDATION_ERROR",{validation:n});const a=this.normalizeSectorData(e),o={metadata:this.generateSnapshotMetadata(t,s.createdBy,s.sectorId||K.defaultSectorId),statistics:a.statistics,ticketIds:a.ticketIds,tickets:a.tickets},i=this.validateSnapshot(o);if(!i.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",i.warnings);const l=this.getApiBaseUrl(),v=await fetch(`${l}${K.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:o,type:t,date:this.formatDate(new Date)})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const g=await v.json();if(!g.success)throw new Error(g.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return g.data.snapshot}catch(n){throw console.error("SnapshotService.createSnapshot error:",n),n instanceof Y?n:new Y(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${n.message}`,"API_ERROR",{originalError:n})}}static async getSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?action=get&date=${s}&type=${t}`,r=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(r.status===404)return null;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return o.data.snapshot}catch(s){throw console.error("SnapshotService.getSnapshot error:",s),s}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",K.defaultSectorId);const n=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?${t.toString()}`,a=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();if(!r.success)throw new Error(r.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(r.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(l){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${i.date}/${i.type}:`,l),null}}))).filter(i=>i!==null).sort((i,l)=>new Date(i.metadata.createdAt)-new Date(l.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:s=[],zeroPointTickets:n={}}=e,a={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},r=[],o=[],i=[];t.forEach(g=>{const y=g.id;if(a[y]){let $=0;g.employees.forEach(A=>{const b=A.tickets||[];$+=b.length;let h=r.find(m=>m.id===A.id);h||(h={id:A.id,name:A.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},r.push(h)),b.forEach(m=>{o.push(m.id),i.push({id:m.id,title:m.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:A.id,name:A.name},createdAt:m.createdAt||"",updatedAt:m.modifiedAt||m.updatedAt||""}),h.ticketsByStage[y]=(h.ticketsByStage[y]||0)+1,h.totalTickets+=1})}),a[y].count=$}});const l={unassigned:0,keeper:0,total:0};Object.values(n).forEach(g=>{Array.isArray(g)&&g.forEach(y=>{l.total+=1,y.assigneeId===1051||y.assignedById===1051?l.keeper+=1:l.unassigned+=1,o.push(y.id),i.push({id:y.id,title:y.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:y.assignedTo||y.assignedById?{id:y.assignedById||y.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:y.createdAt||"",updatedAt:y.modifiedAt||y.updatedAt||""})})});const v=Object.values(a).reduce((g,y)=>g+y.count,0)+l.total;return{statistics:{stages:{...a,total:v},employees:r,zeroPoint:l},ticketIds:[...new Set(o)],tickets:i}}static generateSnapshotMetadata(e,t,s){const n=new Date,a=-n.getTimezoneOffset(),r=Math.floor(a/60),o=a%60,i=`${r>=0?"+":""}${String(r).padStart(2,"0")}:${String(o).padStart(2,"0")}`,l=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}${i}`;return{version:K.snapshotVersion,createdAt:l,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:s,sectorName:s==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${s}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${n}`}static buildFilePath(e,t){const s=typeof e=="string"?new Date(e):e,n=s.getFullYear(),a=this.getWeekNumber(s),r=this.formatDate(e);let o;if(t==="current"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;o=`current-state-${r}-${l}.json`}else if(t==="manual"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;o=`manual-${r}-${l}.json`}else o=`${t}-${r}.json`;return t==="current"?`current/${o}`:`${n}/week-${a}/${o}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),s=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-s);const n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-n)/864e5+1)/7)}static validateSnapshot(e){var n,a,r;const t=[],s=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const o=e.statistics.stages,i=(((n=o.formed)==null?void 0:n.count)||0)+(((a=o.review)==null?void 0:a.count)||0)+(((r=o.execution)==null?void 0:r.count)||0);o.total!==i&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${i}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const o=e.statistics.zeroPoint,i=(o.unassigned||0)+(o.keeper||0);o.total!==i&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${i}, —É–∫–∞–∑–∞–Ω–æ ${o.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const o=new Set(e.ticketIds),i=new Set(e.tickets.map(l=>l.id));o.size!==i.size&&s.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((l,v)=>{l.id||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),l.title||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!l.assignedTo||!l.assignedTo.id)&&s.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),l.createdAt||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),l.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${v}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:s}}static validateSectorData(e){const t=[],s=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:s}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:s})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}`,r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:s,type:t})});if(r.status===404)return!1;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(s){throw console.error("SnapshotService.deleteSnapshot error:",s),s}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let s=0;for(const n of t)try{await this.deleteSnapshot(n.metadata.createdAt.split("T")[0],n.metadata.type)&&s++}catch(a){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${n.metadata.createdAt}:`,a)}return s}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=K.snapshotVersion){const s=this.getSnapshotVersion(e);return s===t||s==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${s} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,s=this.getWeekNumber(t);return{year:t.getFullYear(),week:s}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,n=(t.getDay()||7)-1,a=new Date(t);return a.setDate(t.getDate()-n),a.setHours(0,0,0,0),a}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,n=7-(t.getDay()||7),a=new Date(t);return a.setDate(t.getDate()+n),a.setHours(23,59,59,999),a}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),s=this.getWeekEndDate(e),n=this.getWeekNumberInfo(e),a=await this.getAllSnapshots({startDate:t,endDate:s}),r=a.find(l=>l.metadata.type==="week_start")||null,o=a.find(l=>l.metadata.type==="week_end")||null,i=a.filter(l=>l.metadata.type==="manual");return{weekStart:r,weekEnd:o,manual:i,weekInfo:n}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof Y)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),s={week_start:0,week_end:0,manual:0,current:0},n=new Map;let a=null,r=null;t.forEach(i=>{const l=i.metadata.type;s.hasOwnProperty(l)&&s[l]++;const v=this.getWeekNumberInfo(i.metadata.createdAt),g=`${v.year}-W${v.week}`;n.set(g,(n.get(g)||0)+1);const y=new Date(i.metadata.createdAt);(!a||y<new Date(a.metadata.createdAt))&&(a=i),(!r||y>new Date(r.metadata.createdAt))&&(r=i)});const o=Array.from(n.entries()).map(([i,l])=>{const[v,g]=i.split("-W");return{year:parseInt(v),week:parseInt(g),count:l}}).sort((i,l)=>i.year!==l.year?i.year-l.year:i.week-l.week);return{total:t.length,byType:s,byWeek:o,oldest:a,newest:r}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class Y extends Error{constructor(e,t,s={}){super(e),this.name="SnapshotError",this.code=t,this.details=s}}const q={formed:{bitrixId:Ee.formed,name:Te.FORMED.name},review:{bitrixId:Ee.review,name:Te.REVIEW.name},execution:{bitrixId:Ee.execution,name:Te.EXECUTION.name}},ie=nt;function rt(w){if(!w||typeof w!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!w.stages||!Array.isArray(w.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=ot(w.stages),t=it(w.stages),s=lt(w.zeroPointTickets||{}),n=ct(w.zeroPointTickets||{}),a=ut(w.stages,w.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:s,zeroPointByStage:n},ticketIds:a.ticketIds,tickets:a.tickets}}function ot(w){const e={formed:{count:0,stageId:q.formed.bitrixId,stageName:q.formed.name},review:{count:0,stageId:q.review.bitrixId,stageName:q.review.name},execution:{count:0,stageId:q.execution.bitrixId,stageName:q.execution.name},total:0};return w.forEach(t=>{if(!q[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let s=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(n=>{n.tickets&&Array.isArray(n.tickets)&&(s+=n.tickets.length)}),e[t.id].count=s,e.total+=s}),e}function it(w){const e=new Map;return w.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(s=>{if(!s||!s.id)return;e.has(s.id)||e.set(s.id,{id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const n=e.get(s.id),a=s.tickets&&Array.isArray(s.tickets)?s.tickets.length:0;q[t.id]&&(n.ticketsByStage[t.id]=(n.ticketsByStage[t.id]||0)+a),n.totalTickets+=a})}),Array.from(e.values())}function lt(w){let e=0,t=0;return!w||typeof w!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(w).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n)return;const a=n.assignedTo||n.assignedById;!a||a===null?e++:(typeof a=="object"?a.id:a)===ie?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function ct(w){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!w||typeof w!="object"||Object.keys(e).forEach(t=>{const s=w[t];Array.isArray(s)&&s.forEach(n=>{if(!n)return;const a=n.assignedTo||n.assignedById;!a||a===null?e[t].unassigned++:(typeof a=="object"?a.id:a)===ie?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function ut(w,e){const t=new Set,s=new Map;return Array.isArray(w)&&w.forEach(n=>{!n.employees||!Array.isArray(n.employees)||n.employees.forEach(a=>{!a.tickets||!Array.isArray(a.tickets)||a.tickets.forEach(r=>{if(!r||!r.id){console.warn("Ticket without ID found:",r);return}const o=parseInt(r.id);if(isNaN(o)){console.warn("Invalid ticket ID:",r.id);return}t.add(o);let i=r.assignedTo;!i&&a.id&&(i={id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`}),s.set(o,{id:o,title:r.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:i||null,createdAt:pe(r.createdAt||r.createdTime),updatedAt:pe(r.updatedAt||r.modifiedAt||r.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(n=>{Array.isArray(n)&&n.forEach(a=>{if(!a||!a.id){console.warn("Ticket without ID found in zero point:",a);return}const r=parseInt(a.id);if(isNaN(r)){console.warn("Invalid ticket ID in zero point:",a.id);return}t.add(r);let o=a.assignedTo;if(!o&&a.assignedById){const i=typeof a.assignedById=="object"?a.assignedById.id||a.assignedById.value:a.assignedById;i&&i!==ie?o={id:i,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:i===ie&&(o={id:ie,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}s.set(r,{id:r,title:a.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o||null,createdAt:pe(a.createdAt||a.createdTime),updatedAt:pe(a.updatedAt||a.modifiedAt||a.updatedTime)})})}),{ticketIds:Array.from(t).sort((n,a)=>n-a),tickets:Array.from(s.values())}}function pe(w){if(!w)return null;if(w instanceof Date)return w.toISOString();if(typeof w=="string"){if(w.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return w;const e=new Date(w);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",w),null}class Ce{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:s=null,normalize:n=!0,includeTicketDetails:a=!1}=e;try{const r=await Le.getSectorData(t,s);return n?rt(r):(a&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),r)}catch(r){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",r),r}}static async isDataAvailable(){try{const e=await Le.getSectorData(!0);return e!=null}catch{return!1}}}class $e{static compareTwoSnapshots(e,t,s={}){const{includeTickets:n=!1,includeEmployees:a=!0}=s,r=this.validateSnapshot(e),o=this.validateSnapshot(t);if(!r.valid||!o.valid)throw new Error("Invalid snapshot structure: "+[...r.errors,...o.errors].join(", "));const i=this.buildComparisonMetadata(e,t),l=this.compareStages(e.statistics.stages,t.statistics.stages),v=a?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],g=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),y=n?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,$=this.buildSummary(l,v,g,y);return{metadata:i,stages:l,employees:v,zeroPoint:g,tickets:y,summary:$}}static calculateDelta(e,t){const s=this.normalizeValue(e),n=this.normalizeValue(t),a=n-s;let r=0;s!==0?r=a/s*100:n!==0&&(r=n>0?1/0:-1/0);const o=this.getTrend(a);return{value1:s,value2:n,delta:a,deltaPercent:Math.round(r*100)/100,trend:o}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var o,i;const s=["formed","review","execution"],n={};for(const l of s){const v=((o=e[l])==null?void 0:o.count)||0,g=((i=t[l])==null?void 0:i.count)||0;n[l]=this.calculateDelta(v,g)}const a=e.total||0,r=t.total||0;return n.total=this.calculateDelta(a,r),n}static compareEmployees(e,t){var o,i;const s=new Map(e.map(l=>[l.id,l])),n=new Map(t.map(l=>[l.id,l])),a=new Set([...s.keys(),...n.keys()]),r=[];for(const l of a){const v=s.get(l)||null,g=n.get(l)||null;if(!v||!g){r.push({id:l,name:(v==null?void 0:v.name)||(g==null?void 0:g.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:v?{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(v,g),trend:v?"removed":"new"});continue}const y={},$=["formed","review","execution"];for(const b of $){const h=((o=v.ticketsByStage)==null?void 0:o[b])||0,m=((i=g.ticketsByStage)==null?void 0:i[b])||0;y[b]=this.calculateDelta(h,m)}const A=this.calculateDelta(v.totalTickets||0,g.totalTickets||0);r.push({id:l,name:v.name,snapshot1:{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:y,totalTickets:A},trend:A.trend})}return r}static calculateEmployeeDelta(e,t){var r,o;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const s={},n=["formed","review","execution"];for(const i of n){const l=((r=e==null?void 0:e.ticketsByStage)==null?void 0:r[i])||0,v=((o=t==null?void 0:t.ticketsByStage)==null?void 0:o[i])||0;s[i]=this.calculateDelta(l,v)}const a=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:s,totalTickets:a}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,s,n){var $,A;const a=new Set(e),r=new Set(t),o=t.filter(b=>!a.has(b)),i=e.filter(b=>!r.has(b)),l=[],v=[],g=new Map(s.map(b=>[b.id,b])),y=new Map(n.map(b=>[b.id,b]));for(const b of e){if(!r.has(b))continue;const h=g.get(b),m=y.get(b);if(!h||!m)continue;const E=((($=h.assignedTo)==null?void 0:$.id)||null)!==(((A=m.assignedTo)==null?void 0:A.id)||null),F=(h.stageId||null)!==(m.stageId||null);E||F?l.push(b):v.push(b)}return{new:o,removed:i,changed:l,unchanged:v}}static buildComparisonMetadata(e,t){const s=new Date(e.metadata.createdAt),n=new Date(t.metadata.createdAt),a=new Date,r=n.getTime()-s.getTime(),o=Math.floor(r/(1e3*60*60*24)),i=Math.floor(r%(1e3*60*60*24)/(1e3*60*60)),l=Math.floor(r%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:a.toISOString(),timeDiff:{days:o,hours:i,minutes:l,totalMinutes:Math.floor(r/(1e3*60))}}}static buildSummary(e,t,s,n){var l,v,g;const a=e.total.delta,r=Object.keys(e).filter(y=>y==="total"?!1:e[y].delta!==0).length,o=t.filter(y=>y.trend==="new"||y.trend==="removed"?!0:y.delta.totalTickets.delta!==0).length,i=a!==0||r>0||o>0;return{totalDelta:a,stagesChanged:r,employeesChanged:o,hasChanges:i,newTicketsCount:((l=n==null?void 0:n.new)==null?void 0:l.length)||0,removedTicketsCount:((v=n==null?void 0:n.removed)==null?void 0:v.length)||0,changedTicketsCount:((g=n==null?void 0:n.changed)==null?void 0:g.length)||0}}static validateSnapshot(e){const t=[],s=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:s};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const n=["formed","review","execution"];for(const a of n)e.statistics.stages[a]||s.push(`Missing stage: ${a}`)}e.statistics.employees||s.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||s.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:s}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const r of e){const o=this.validateSnapshot(r);if(!o.valid)throw new Error("Invalid snapshot: "+o.errors.join(", "))}const s=[...e].sort((r,o)=>{const i=new Date(r.metadata.createdAt),l=new Date(o.metadata.createdAt);return i-l}),n=[];for(let r=0;r<s.length-1;r++)n.push({from:r,to:r+1,result:this.compareTwoSnapshots(s[r],s[r+1],t)});const a=this.buildTrends(s);return{snapshots:s.map((r,o)=>({index:o,date:r.metadata.createdAt,type:r.metadata.type,data:r})),comparisons:n,trends:a}}static buildTrends(e){var s,n,a,r,o,i,l,v,g,y;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const $ of e){const A=$.statistics;t.stages.formed.push(((n=(s=A.stages)==null?void 0:s.formed)==null?void 0:n.count)||0),t.stages.review.push(((r=(a=A.stages)==null?void 0:a.review)==null?void 0:r.count)||0),t.stages.execution.push(((i=(o=A.stages)==null?void 0:o.execution)==null?void 0:i.count)||0),t.stages.total.push(((l=A.stages)==null?void 0:l.total)||0),t.zeroPoint.unassigned.push(((v=A.zeroPoint)==null?void 0:v.unassigned)||0),t.zeroPoint.keeper.push(((g=A.zeroPoint)==null?void 0:g.keeper)||0),t.zeroPoint.total.push(((y=A.zeroPoint)==null?void 0:y.total)||0)}return t}}const dt={class:"graph-state-chart"},pt={class:"chart-header"},ft={class:"chart-type-selector"},gt=["onClick","title"],ht={class:"chart-type-icon"},mt={class:"chart-type-label"},vt={key:0,class:"comparison-type-selector"},wt={class:"radio-group"},yt={key:0},St={key:1},kt={key:1,class:"chart-filters"},Dt=["onUpdate:modelValue"],bt={class:"filter-label"},Tt={key:2,class:"graph-legend"},Et={key:4,class:"error-container"},$t={class:"error-message"},At={key:5,class:"chart-container"},_t={key:6,class:"no-data"},Ct={key:7,class:"employees-details"},It={class:"employees-details-content"},Bt={class:"stage-details-header"},Rt={class:"stage-details-name"},Mt={class:"stage-details-count"},xt={class:"stage-details-employees"},Ot={class:"employee-detail-name"},Ft={class:"employee-detail-count"},Nt={key:0,class:"no-employees-in-stage"},Pt={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(w,{emit:e}){const t=w,s=e,n=_(!1),a=_(null),r=_(null),o=_({weekStart:null,weekEnd:null,current:null}),i=_(null),l=_("weekStartToWeekEnd"),v=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],g=_("line"),y=_(!0),$=_([]),A=U(()=>{switch(g.value){case"line":return Ve;case"bar":return st;case"doughnut":return at;default:return Ve}}),b=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff"},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107"},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745"}],h=_({formed:!0,review:!0,execution:!0});function m(D){var f;const d=o.value.current||o.value.weekEnd||o.value.weekStart;return!d||!d.statistics||!d.statistics.stages?0:((f=d.statistics.stages[D])==null?void 0:f.count)||0}function E(D){const d=o.value.current||o.value.weekEnd||o.value.weekStart;if(!d||!d.statistics)return[];const f=[];d.statistics.employees&&Array.isArray(d.statistics.employees)&&d.statistics.employees.filter(u=>u.ticketsByStage&&u.ticketsByStage[D]>0).forEach(u=>{f.push({id:u.id,name:u.name,count:u.ticketsByStage[D]||0})});const p=F(D);return p>0&&f.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:p,isKeeper:!0}),f.sort((u,I)=>I.count-u.count)}function F(D){const d=o.value.current||o.value.weekEnd||o.value.weekStart;if(!d||!d.statistics)return 0;if(d.statistics.zeroPointByStage&&d.statistics.zeroPointByStage[D])return d.statistics.zeroPointByStage[D].keeper||0;if(d.statistics.zeroPoint){const f=d.statistics.zeroPoint.keeper||0;return Math.floor(f/3)}return 0}const X=we();function j(){const D=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(d=>{!d||!d.statistics||!d.statistics.employees||d.statistics.employees.forEach(f=>{D.has(f.id)||D.set(f.id,{id:f.id,name:f.name})})}),$.value=Array.from(D.values()).sort((d,f)=>d.name.localeCompare(f.name))}function Q(D,d="background"){var p;return((p={increase:{background:"#10b981",border:"#059669",point:"#10b981"},decrease:{background:"#ef4444",border:"#dc2626",point:"#ef4444"},stable:{background:"#9ca3af",border:"#6b7280",point:"#9ca3af"}}[D])==null?void 0:p[d])||"#6c757d"}function ye(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const D=$e.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let d=null,f=null;o.value.current&&(d=$e.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),f=$e.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),i.value={weekStartToWeekEnd:D,weekEndToCurrent:d,weekStartToCurrent:f}}catch(D){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",D),X.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+D.message)}}function ee(D){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[D]||"formed"}const le=U(()=>{if(!r.value)return null;if(g.value==="doughnut")return r.value;const D=r.value.datasets.filter(d=>{const f=b.find(p=>p.name===d.label);return f?h.value[f.id]:!0});return{...r.value,datasets:D}}),Se=U(()=>{const D={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:g.value==="doughnut"?"right":"top",onClick:(d,f,p)=>{const u=f.datasetIndex;if(u!==void 0){const I=p.chart.getDatasetMeta(u);I.hidden=!I.hidden,p.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:d=>d[0].label||"",label:d=>{var I,S,B,C,N,R;const f=d.dataset.label||"",p=d.parsed.y||d.parsed||0,u=d.dataIndex;if(g.value==="doughnut"){const x=d.dataset.data.reduce((H,J)=>H+J,0),L=x>0?(p/x*100).toFixed(1):0;return`${f}: ${p} (${L}%)`}else{if(!i.value||u===0||g.value==="doughnut")return`${f}: ${p}`;let x=null;const L=ee(f);if(l.value==="weekStartToWeekEnd"&&u===1?x=(S=(I=i.value.weekStartToWeekEnd)==null?void 0:I.stages)==null?void 0:S[L]:l.value==="weekEndToCurrent"&&u===2&&o.current?x=(C=(B=i.value.weekEndToCurrent)==null?void 0:B.stages)==null?void 0:C[L]:l.value==="weekStartToCurrent"&&u===2&&o.current&&(x=(R=(N=i.value.weekStartToCurrent)==null?void 0:N.stages)==null?void 0:R[L]),!x)return`${f}: ${p}`;const H=x.delta,J=x.deltaPercent,ae=x.trend;let Z=`${f}: ${p}`;if(H!==0){const se=H>0?"+":"",de=ae==="increase"?"‚Üë":ae==="decrease"?"‚Üì":"‚Üí";Z+=` (${se}${H}, ${se}${J.toFixed(1)}%) ${de}`}else Z+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return Z}},afterBody:d=>{if(g.value==="doughnut"||!i.value)return[];const f=d[0].dataIndex;if(f===0)return[];let p=null;if(ee(d[0].dataset.label||""),l.value==="weekStartToWeekEnd"&&f===1?p=i.value.weekStartToWeekEnd:l.value==="weekEndToCurrent"&&f===2?p=i.value.weekEndToCurrent:l.value==="weekStartToCurrent"&&f===2&&(p=i.value.weekStartToCurrent),!p||!p.metadata)return[];const u=p.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${u.days} –¥–Ω. ${u.hours} —á. ${u.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return g.value==="line"||g.value==="bar"?{...D,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:g.value==="doughnut"?{...D,cutout:"60%"}:D});function ce(D){const d=new Date(D),f=d.getFullYear(),p=String(d.getMonth()+1).padStart(2,"0"),u=String(d.getDate()).padStart(2,"0");return`${f}-${p}-${u}`}function ke(D){const{current:d,weekEnd:f}=D,p=d||f;if(!p||!p.statistics||!p.statistics.stages)return null;const u=[],I=[],S=[],B=[];return b.forEach(C=>{var R;const N=((R=p.statistics.stages[C.id])==null?void 0:R.count)||0;N>0&&(u.push(C.name),I.push(N),S.push(C.color+"80"),B.push(C.color))}),I.length===0?null:{labels:u,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:I,backgroundColor:S,borderColor:B,borderWidth:2}]}}function ue(D){if(g.value==="doughnut")return ke(D);const{weekStart:d,weekEnd:f,current:p}=D,u=[],I=[];return b.forEach(S=>{var L,H,J,ae,Z,se,de,Ie,Be,Re,Me,xe,Oe,Fe,Ne,Pe,We;const B=[];if(d&&d.statistics&&d.statistics.stages){const O=d.statistics.stages[S.id];if(u.length===0){const ne=(L=d.metadata)!=null&&L.createdAt?new Date(d.metadata.createdAt):null;u.push(ne?ce(ne):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}B.push((O==null?void 0:O.count)||0)}else u.length===0&&u.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),B.push(0);if(f&&f.statistics&&f.statistics.stages){const O=f.statistics.stages[S.id];if(u.length===1){const ne=(H=f.metadata)!=null&&H.createdAt?new Date(f.metadata.createdAt):null;u.push(ne?ce(ne):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}B.push((O==null?void 0:O.count)||0)}else u.length===1&&u.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),B.push(0);if(p&&t.showCurrentState&&p.statistics&&p.statistics.stages){const O=p.statistics.stages[S.id];u.length===2&&u.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),B.push((O==null?void 0:O.count)||0)}const C=["stable"];i.value?l.value==="weekStartToWeekEnd"?(C.push(((Z=(ae=(J=i.value.weekStartToWeekEnd)==null?void 0:J.stages)==null?void 0:ae[S.id])==null?void 0:Z.trend)||"stable"),p&&C.push(((Ie=(de=(se=i.value.weekStartToCurrent)==null?void 0:se.stages)==null?void 0:de[S.id])==null?void 0:Ie.trend)||"stable")):l.value==="weekEndToCurrent"&&p?(C.push("stable"),C.push(((Me=(Re=(Be=i.value.weekEndToCurrent)==null?void 0:Be.stages)==null?void 0:Re[S.id])==null?void 0:Me.trend)||"stable")):l.value==="weekStartToCurrent"&&p?(C.push(((Fe=(Oe=(xe=i.value.weekStartToWeekEnd)==null?void 0:xe.stages)==null?void 0:Oe[S.id])==null?void 0:Fe.trend)||"stable"),C.push(((We=(Pe=(Ne=i.value.weekStartToCurrent)==null?void 0:Ne.stages)==null?void 0:Pe[S.id])==null?void 0:We.trend)||"stable")):(C.push("stable"),p&&C.push("stable")):(C.push("stable"),p&&C.push("stable"));let N,R,x;i.value&&g.value!=="doughnut"?(N=C.map(O=>Q(O,"background")+"40"),R=C.map(O=>Q(O,"border")),x=C.map(O=>Q(O,"point"))):(N=S.color+"40",R=S.color,x=S.color),I.push({label:S.name,data:B,backgroundColor:(Array.isArray(N),N),borderColor:(Array.isArray(R),R),borderWidth:2,pointBackgroundColor:(Array.isArray(x),x),pointBorderColor:(Array.isArray(R),R),pointRadius:6,pointHoverRadius:8,fill:g.value!=="line",tension:g.value==="line"?.4:0})}),u.length===0&&(u.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),t.showCurrentState&&u.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:u,datasets:I}}const te=async()=>{var D,d,f;n.value=!0,a.value=null;try{const p=(D=t.period)!=null&&D.endDate?new Date(t.period.endDate):new Date,u=(d=t.period)!=null&&d.startDate?new Date(t.period.startDate):G.getWeekStartDate(p),I=(f=t.period)!=null&&f.endDate?new Date(t.period.endDate):G.getWeekEndDate(p),S=G.formatDate(u),B=G.formatDate(I),[C,N]=await Promise.all([G.getSnapshot(S,"week_start"),G.getSnapshot(B,"week_end")]);let R=null;t.showCurrentState&&(R=await Ce.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:C,weekEnd:N,current:R},j(),ye(),z(),s("data-loaded",{weekStart:C,weekEnd:N,current:R})}catch(p){console.error("Error loading chart data:",p),a.value=p.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",X.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+a.value),s("error",a.value)}finally{n.value=!1}};he(()=>{te()});const z=()=>{r.value=ue({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current})};return De(()=>[t.period,t.showCurrentState],()=>{te()},{deep:!0}),De(g,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&z()}),De(l,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&z()}),(D,d)=>(k(),T("div",dt,[c("div",pt,[d[3]||(d[3]=c("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),c("div",ft,[(k(),T(re,null,oe(v,f=>c("button",{key:f.value,onClick:p=>g.value=f.value,class:ve(["chart-type-btn",{active:g.value===f.value}]),title:f.label},[c("span",ht,W(f.icon),1),c("span",mt,W(f.label),1)],10,gt)),64))])]),!n.value&&!a.value&&i.value&&g.value!=="doughnut"?(k(),T("div",vt,[d[7]||(d[7]=c("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),c("div",wt,[c("label",null,[V(c("input",{type:"radio","onUpdate:modelValue":d[0]||(d[0]=f=>l.value=f),value:"weekStartToWeekEnd",onChange:z},null,544),[[be,l.value]]),d[4]||(d[4]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),o.value.current?(k(),T("label",yt,[V(c("input",{type:"radio","onUpdate:modelValue":d[1]||(d[1]=f=>l.value=f),value:"weekEndToCurrent",onChange:z},null,544),[[be,l.value]]),d[5]||(d[5]=c("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0),o.value.current?(k(),T("label",St,[V(c("input",{type:"radio","onUpdate:modelValue":d[2]||(d[2]=f=>l.value=f),value:"weekStartToCurrent",onChange:z},null,544),[[be,l.value]]),d[6]||(d[6]=c("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0)])])):P("",!0),!n.value&&!a.value&&r.value?(k(),T("div",kt,[(k(),T(re,null,oe(b,f=>c("label",{key:f.id,class:"filter-checkbox"},[V(c("input",{type:"checkbox","onUpdate:modelValue":p=>h.value[f.id]=p,onChange:z},null,40,Dt),[[fe,h.value[f.id]]]),c("span",{class:"filter-color",style:Ae({backgroundColor:f.color})},null,4),c("span",bt,W(f.name),1)])),64))])):P("",!0),!n.value&&!a.value&&i.value&&g.value!=="doughnut"?(k(),T("div",Tt,[...d[8]||(d[8]=[Ge('<h4 class="legend-title" data-v-c469e424>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-c469e424><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#10b981;" data-v-c469e424></span><span data-v-c469e424>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#ef4444;" data-v-c469e424></span><span data-v-c469e424>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-c469e424><span class="legend-color" style="background-color:#9ca3af;" data-v-c469e424></span><span data-v-c469e424>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):P("",!0),n.value?(k(),me(ze,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):a.value?(k(),T("div",Et,[c("p",$t,"‚ùå "+W(a.value),1),c("button",{onClick:te,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):le.value?(k(),T("div",At,[(k(),me(Xe(A.value),{data:le.value,options:Se.value,height:300},null,8,["data","options"]))])):(k(),T("div",_t,[...d[9]||(d[9]=[c("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),c("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),!n.value&&!a.value&&r.value&&y.value?(k(),T("div",Ct,[d[10]||(d[10]=c("h4",{class:"employees-details-title"},"–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º",-1)),c("div",It,[(k(),T(re,null,oe(b,f=>c("div",{key:f.id,class:"stage-details"},[c("div",Bt,[c("span",{class:"stage-details-color",style:Ae({backgroundColor:f.color})},null,4),c("h5",Rt,W(f.name),1),c("span",Mt," –í—Å–µ–≥–æ: "+W(m(f.id))+" —Ç–∏–∫–µ—Ç–æ–≤ ",1)]),c("div",xt,[(k(!0),T(re,null,oe(E(f.id),p=>(k(),T("div",{key:`${f.id}-${p.id}`,class:ve(["employee-detail-item",{"employee-detail-keeper":p.isKeeper}])},[c("span",Ot,W(p.name),1),c("span",Ft,W(p.count)+" —Ç–∏–∫–µ—Ç–æ–≤",1)],2))),128)),E(f.id).length===0?(k(),T("div",Nt," –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ ")):P("",!0)])])),64))])])):P("",!0)]))}},Wt=_e(Pt,[["__scopeId","data-v-c469e424"]]),jt={key:0,class:"create-snapshot-button-container"},Ut=["disabled"],Vt={class:"modal-content"},Lt={class:"modal-header"},zt=["disabled"],Ht={class:"modal-body"},Kt={key:0,class:"progress-container"},qt={class:"progress-bar-wrapper"},Gt={class:"progress-text"},Xt={class:"progress-percent"},Yt={class:"progress-description"},Jt={key:1},Zt={class:"modal-footer"},Qt=["disabled"],ea=["disabled"],ta={key:0},aa={key:0},sa={key:1},na={key:2},ra={key:1},oa={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(w,{emit:e}){const t=w,s=e,n=_(t.user),a=_(!1),r=_(!1),o=_(0),i=_("idle"),l=_(""),v=we(),g=U(()=>n.value?Qe(n.value):!1);he(async()=>{if(!t.user)try{const h=await He.checkAccess();h.allowed&&(n.value=h.user)}catch(h){console.error("Error loading user:",h)}});const y=()=>{if(!g.value){v.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}a.value=!0},$=()=>{r.value||(a.value=!1,i.value="idle",o.value=0,l.value="")},A=async()=>{if(!r.value){if(!g.value){v.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}r.value=!0,i.value="loading_data",o.value=0,l.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{l.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const h=await Ce.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:F=>{var j;const X=Math.min(80,(F.progress||0)*.8);o.value=X,i.value="loading_data",l.value=F.description||((j=F.details)==null?void 0:j.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});i.value="creating_snapshot",o.value=85,l.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const m=n.value;if(!m)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const E=await G.createSnapshot(h,"manual",{createdBy:{id:m.ID,name:`${m.NAME||""} ${m.LAST_NAME||""}`.trim()||m.EMAIL||`User ${m.ID}`},sectorId:"1C"});i.value="success",o.value=100,l.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",v.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),s("snapshot-created",E),setTimeout(()=>{$()},1500)}catch(h){i.value="error",o.value=0,l.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",h);let m="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";h.message&&(h.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||h.message.includes("sector data")?m="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":h.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||h.message.includes("snapshot")?m="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":h.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||h.message.includes("validation")?m="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":m=h.message),v.error(m)}finally{r.value=!1}}},b=h=>{h.key==="Escape"&&a.value&&!r.value&&$()};return he(()=>{window.addEventListener("keydown",b)}),Ke(()=>{window.removeEventListener("keydown",b)}),(h,m)=>g.value?(k(),T("div",jt,[c("button",{class:"create-snapshot-btn",onClick:y,disabled:r.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...m[1]||(m[1]=[c("span",{class:"btn-icon"},"üì∏",-1),c("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,Ut),(k(),me(Ze,{to:"body"},[ge(Je,{name:"modal"},{default:qe(()=>[a.value?(k(),T("div",{key:0,class:"modal-overlay",onClick:m[0]||(m[0]=Ye(E=>!r.value&&$(),["self"]))},[c("div",Vt,[c("div",Lt,[m[2]||(m[2]=c("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),c("button",{class:"modal-close",onClick:$,disabled:r.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,zt)]),c("div",Ht,[i.value!=="idle"?(k(),T("div",Kt,[c("div",qt,[c("div",{class:"progress-bar",style:Ae({width:`${o.value}%`})},null,4)]),c("div",Gt,[c("span",Xt,W(Math.round(o.value))+"%",1),c("span",Yt,W(l.value),1)])])):(k(),T("div",Jt,[...m[3]||(m[3]=[c("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),c("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),c("div",Zt,[c("button",{class:"btn btn-secondary",onClick:$,disabled:r.value}," –û—Ç–º–µ–Ω–∞ ",8,Qt),c("button",{class:"btn btn-primary",onClick:A,disabled:r.value},[r.value?(k(),T("span",ta,[i.value==="loading_data"?(k(),T("span",aa,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):i.value==="creating_snapshot"?(k(),T("span",sa,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(k(),T("span",na,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(k(),T("span",ra,"–°–æ–∑–¥–∞—Ç—å"))],8,ea)])])])):P("",!0)]),_:1})]))])):P("",!0)}},ia=_e(oa,[["__scopeId","data-v-cb08ebb3"]]);function la(){const w=_(!1),e=_(null),t=_(null),s=_(0),n=we(),a=async(h=!0,m=null)=>{w.value=!0,e.value=null,s.value=0;try{const E=await Ce.getSectorDataForSnapshot({useCache:h,onProgress:F=>{F&&typeof F.progress=="number"&&(s.value=F.progress),m&&m(F)},normalize:!0});return t.value=E,E}catch(E){throw e.value=E.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",n.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+e.value),E}finally{w.value=!1,s.value=100}},r=async(h,m={})=>{if(!t.value){const E="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw e.value=E,n.error(E),new Error(E)}w.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(h))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${h}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const E=await G.createSnapshot(t.value,h,m);return n.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),E}catch(E){throw e.value=E.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",n.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+e.value),E}finally{w.value=!1}},o=()=>{w.value=!1,e.value=null,t.value=null,s.value=0},i=U(()=>t.value!==null&&t.value!==void 0),l=_({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),v=U(()=>{const h=new Date;let m,E;switch(l.value.dateRange){case"last-week":m=new Date(h),m.setDate(h.getDate()-7),E=h;break;case"last-2-weeks":m=new Date(h),m.setDate(h.getDate()-14),E=h;break;case"last-month":m=new Date(h),m.setMonth(h.getMonth()-1),E=h;break;case"custom":m=l.value.customDateRange.startDate?new Date(l.value.customDateRange.startDate):null,E=l.value.customDateRange.endDate?new Date(l.value.customDateRange.endDate):null;break;default:m=new Date(h),m.setDate(h.getDate()-7),E=h}return{startDate:m?m.toISOString().split("T")[0]:null,endDate:E?E.toISOString().split("T")[0]:null}}),g=()=>{$()},y=()=>{l.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},$()},$=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(l.value))}catch(h){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",h)}},A=()=>{try{const h=localStorage.getItem("graphStateFilters");if(h){const m=JSON.parse(h);m&&typeof m=="object"&&(l.value={stages:m.stages||{formed:!0,review:!0,execution:!0},employees:m.employees||["all"],dateRange:m.dateRange||"last-week",customDateRange:m.customDateRange||{startDate:null,endDate:null}})}}catch(h){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",h)}},b=U(()=>{const h=Object.values(l.value.stages).some(F=>!F),m=!l.value.employees.includes("all"),E=l.value.dateRange!=="last-week";return h||m||E});return{isLoading:w,error:e,currentSectorData:t,loadingProgress:s,hasSectorData:i,filters:l,selectedPeriod:v,hasActiveFilters:b,loadSectorDataForSnapshot:a,createSnapshot:r,resetState:o,applyFilters:g,resetFilters:y,saveFiltersToLocalStorage:$,loadFiltersFromLocalStorage:A}}const ca={class:"graph-state-dashboard"},ua={key:1,class:"error-message-container"},da={class:"error-message"},pa={class:"error-text"},fa={key:0,class:"error-details"},ga={class:"dashboard-header"},ha={class:"header-content"},ma={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},va={class:"header-actions"},wa=["disabled"],ya={key:0},Sa={key:1},ka={class:"filters-header"},Da=["disabled"],ba={class:"filters-content"},Ta={class:"filter-group"},Ea={class:"checkbox-group"},$a={class:"checkbox-item"},Aa={class:"checkbox-item"},_a={class:"checkbox-item"},Ca={class:"filter-group"},Ia=["value"],Ba={class:"filter-group"},Ra={key:0,class:"filter-group custom-date-range"},Ma={class:"date-range-inputs"},xa={class:"date-input-group"},Oa=["max"],Fa={class:"date-input-group"},Na=["min","max"],Pa={key:0,class:"filter-error"},Wa={key:1,class:"filter-hint"},ja={key:3,class:"dashboard-content"},Ua={class:"chart-container"},Va={__name:"GraphStateDashboard",setup(w){const e=we(),{filters:t,selectedPeriod:s,hasActiveFilters:n,applyFilters:a,resetFilters:r,loadFiltersFromLocalStorage:o}=la(),i=_(null),l=_(!0),v=_([]),g=_(!1),y=_("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),$=_(null),A=_(!1),b=_(!1),h=_(typeof window<"u"?window.innerWidth:1024),m=_(null),E=U(()=>h.value<768);U(()=>h.value>=768&&h.value<1024),U(()=>h.value>=1024);const F=U(()=>{const p=new Date;return p.setFullYear(p.getFullYear()-1),p.toISOString().split("T")[0]}),X=U(()=>new Date().toISOString().split("T")[0]);function j(){a()}function Q(){r(),m.value=null,j(),e.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function ye(){t.value.dateRange!=="custom"&&(m.value=null,j())}function ee(){const p=le(t.value.customDateRange.startDate,t.value.customDateRange.endDate);if(!p.valid){m.value=p.error;return}m.value=null,j()}function le(p,u){if(!p||!u)return{valid:!1,error:"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–±–µ –¥–∞—Ç—ã"};const I=new Date(p),S=new Date(u);return I>S?{valid:!1,error:"–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π"}:Math.ceil((S-I)/(1e3*60*60*24))>365?{valid:!1,error:"–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π"}:{valid:!0}}function Se(p){e.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function ce(p){g.value=!1,y.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",p)}function ke(p){g.value=!1,ue({message:p||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function ue(p){$.value={message:p.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:p.details||null,type:p.type||"error",timestamp:new Date},console.error("Dashboard error:",$.value),e.error($.value.message)}function te(){$.value=null}function z(){$.value=null,g.value=!0,y.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function D(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}A.value=!0;try{const p=document.querySelector(".chart-container");if(!p)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const u=window.html2canvas,I=await u(p,{scale:2,useCORS:!0,logging:!1,backgroundColor:"#ffffff"}),S=window.jsPDF,B=new S("landscape","mm","a4"),C=297,N=I.height*C/I.width;B.setFontSize(18),B.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const R=new Date().toLocaleDateString("ru-RU");B.setFontSize(10);const x=s.value.startDate&&s.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${s.value.startDate} - ${s.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";B.text(x,148.5,25,{align:"center"}),B.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${R}`,148.5,30,{align:"center"}),B.addImage(I.toDataURL("image/png"),"PNG",10,35,C-20,N-20),B.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${R}`,author:"Bitrix24 Dashboard"});const L=`graph-state-${R.replace(/\//g,"-")}.pdf`;B.save(L),e.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(p){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",p),ue({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(p.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:p.stack,type:"error"})}finally{A.value=!1}}function d(){typeof window<"u"&&(h.value=window.innerWidth)}async function f(){try{const p=await He.checkAccess();p.allowed&&(i.value=p.user)}catch(p){console.error("Error loading user:",p)}}return he(()=>{o(),f(),typeof window<"u"&&(h.value=window.innerWidth,window.addEventListener("resize",d))}),Ke(()=>{typeof window<"u"&&window.removeEventListener("resize",d)}),(p,u)=>{const I=et("router-link");return k(),T("div",ca,[g.value?(k(),me(ze,{key:0,message:y.value},null,8,["message"])):P("",!0),$.value?(k(),T("div",ua,[c("div",da,[c("div",{class:"error-header"},[u[8]||(u[8]=c("span",{class:"error-icon"},"‚ùå",-1)),u[9]||(u[9]=c("h3",null,"–û—à–∏–±–∫–∞",-1)),c("button",{onClick:te,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),c("p",pa,W($.value.message),1),$.value.details?(k(),T("div",fa,[c("details",null,[u[10]||(u[10]=c("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),c("pre",null,W($.value.details),1)])])):P("",!0),c("div",{class:"error-actions"},[c("button",{onClick:z,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):P("",!0),c("div",ga,[c("div",ha,[c("nav",ma,[ge(I,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:qe(()=>[...u[11]||(u[11]=[tt(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),u[12]||(u[12]=c("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),u[13]||(u[13]=c("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))]),u[14]||(u[14]=c("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),u[15]||(u[15]=c("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),c("div",va,[c("button",{onClick:D,class:"btn-export-pdf",disabled:A.value||g.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[A.value?(k(),T("span",Sa,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(k(),T("span",ya,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,wa),ge(ia,{user:i.value,onSnapshotCreated:Se},null,8,["user"])])]),E.value?(k(),T("button",{key:2,class:"mobile-filters-toggle",onClick:u[0]||(u[0]=S=>b.value=!b.value)},[u[16]||(u[16]=c("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("span",{class:ve(["toggle-icon",{open:b.value}])},"‚ñº",2)])):P("",!0),c("div",{class:ve(["filters-panel",{"mobile-open":b.value&&E.value,"mobile-closed":!b.value&&E.value}])},[c("div",ka,[u[17]||(u[17]=c("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),c("button",{onClick:Q,class:"btn-reset-filters",disabled:!M(n)}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,Da)]),c("div",ba,[c("div",Ta,[u[21]||(u[21]=c("label",{class:"filter-label"},"–≠—Ç–∞–ø—ã:",-1)),c("div",Ea,[c("label",$a,[V(c("input",{type:"checkbox","onUpdate:modelValue":u[1]||(u[1]=S=>M(t).stages.formed=S),onChange:j},null,544),[[fe,M(t).stages.formed]]),u[18]||(u[18]=c("span",null,"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",-1))]),c("label",Aa,[V(c("input",{type:"checkbox","onUpdate:modelValue":u[2]||(u[2]=S=>M(t).stages.review=S),onChange:j},null,544),[[fe,M(t).stages.review]]),u[19]||(u[19]=c("span",null,"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",-1))]),c("label",_a,[V(c("input",{type:"checkbox","onUpdate:modelValue":u[3]||(u[3]=S=>M(t).stages.execution=S),onChange:j},null,544),[[fe,M(t).stages.execution]]),u[20]||(u[20]=c("span",null,"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",-1))])])]),c("div",Ca,[u[23]||(u[23]=c("label",{class:"filter-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:",-1)),V(c("select",{"onUpdate:modelValue":u[4]||(u[4]=S=>M(t).employees=S),multiple:"",onChange:j,class:"employees-select",size:"5"},[u[22]||(u[22]=c("option",{value:"all"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",-1)),(k(!0),T(re,null,oe(v.value,S=>(k(),T("option",{key:S.id,value:S.id},W(S.name),9,Ia))),128))],544),[[je,M(t).employees]]),u[24]||(u[24]=c("small",{class:"filter-hint"}," –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac) ",-1))]),c("div",Ba,[u[26]||(u[26]=c("label",{class:"filter-label"},"–ü–µ—Ä–∏–æ–¥:",-1)),V(c("select",{"onUpdate:modelValue":u[5]||(u[5]=S=>M(t).dateRange=S),onChange:ye,class:"date-range-select"},[...u[25]||(u[25]=[c("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),c("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),c("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),c("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],544),[[je,M(t).dateRange]])]),M(t).dateRange==="custom"?(k(),T("div",Ra,[u[29]||(u[29]=c("label",{class:"filter-label"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥:",-1)),c("div",Ma,[c("div",xa,[u[27]||(u[27]=c("label",null,"–°:",-1)),V(c("input",{type:"date","onUpdate:modelValue":u[6]||(u[6]=S=>M(t).customDateRange.startDate=S),onChange:ee,max:M(t).customDateRange.endDate||X.value,class:"date-input"},null,40,Oa),[[Ue,M(t).customDateRange.startDate]])]),c("div",Fa,[u[28]||(u[28]=c("label",null,"–ü–æ:",-1)),V(c("input",{type:"date","onUpdate:modelValue":u[7]||(u[7]=S=>M(t).customDateRange.endDate=S),onChange:ee,min:M(t).customDateRange.startDate||F.value,max:X.value,class:"date-input"},null,40,Na),[[Ue,M(t).customDateRange.endDate]])])]),m.value?(k(),T("small",Pa,W(m.value),1)):(k(),T("small",Wa," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):P("",!0)])],2),!g.value&&!$.value?(k(),T("div",ja,[c("div",Ua,[ge(Wt,{period:M(s),"show-current-state":l.value,onDataLoaded:ce,onError:ke},null,8,["period","show-current-state"])])])):P("",!0)])}}},Ka=_e(Va,[["__scopeId","data-v-32ebc814"]]);export{Ka as default};
