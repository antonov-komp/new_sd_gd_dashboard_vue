var St=Object.defineProperty;var Ct=(t,e,r)=>e in t?St(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var B=(t,e,r)=>Ct(t,typeof e!="symbol"?e+"":e,r);import{_ as It,g as Dt,c as S,a as L,d as W,b as D,t as A,l as x,o as F,D as At}from"./main-BZu-8wvz.js";const w={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367,KEEPER:1051},Rt=[w.SECTOR_1C,w.SECTOR_HARDWARE,w.SECTOR_BITRIX24,w.SECTOR_PDM];function kt(t){return Rt.includes(t)}const lt=140,q={FORMED:{name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",bitrixId:"DT140_12:CLIENT"}},bt={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},wt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"};function Ot(){return[q.FORMED.bitrixId,q.REVIEW.bitrixId,q.EXECUTION.bitrixId]}const Nt="https://bitrix24.kompo.by",Mt="servisdeskitotdel";function vt(t){return`${Nt}/page/${Mt}/servisdesk/type/${lt}/details/${t}/`}const p={TODAY:"today",YESTERDAY:"yesterday",THIS_WEEK:"this_week",LAST_WEEK:"last_week",MORE_THAN_TWO_WEEKS:"more_than_two_weeks",UP_TO_ONE_MONTH:"up_to_one_month",MORE_THAN_TWO_MONTHS:"more_than_two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},Bt={[p.TODAY]:{label:"–°–ï–ì–û–î–ù–Ø",color:"#28a745",backgroundColor:"#d4edda",textColor:"#155724"},[p.YESTERDAY]:{label:"–í–ß–ï–†–ê",color:"#20c997",backgroundColor:"#d1f2eb",textColor:"#0c5460"},[p.THIS_WEEK]:{label:"–ù–ê –≠–¢–û–ô –ù–ï–î–ï–õ–ï",color:"#17a2b8",backgroundColor:"#d1ecf1",textColor:"#0c5460"},[p.LAST_WEEK]:{label:"–ù–ê –ü–†–û–®–õ–û–ô –ù–ï–î–ï–õ–ï",color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},[p.MORE_THAN_TWO_WEEKS]:{label:"–ë–û–õ–ï–ï –î–í–£–• –ù–ï–î–ï–õ–¨",color:"#fd7e14",backgroundColor:"#ffe5d0",textColor:"#7d3f00"},[p.UP_TO_ONE_MONTH]:{label:"–î–û 1 –ú–ï–°–Ø–¶–ê",color:"#dc3545",backgroundColor:"#f8d7da",textColor:"#721c24"},[p.MORE_THAN_TWO_MONTHS]:{label:"–ë–û–õ–ï–ï 2 –ú–ï–°–Ø–¶–ï–í",color:"#6c757d",backgroundColor:"#e2e3e5",textColor:"#383d41"},[p.MORE_THAN_HALF_YEAR]:{label:"–ë–û–õ–ï–ï –ü–û–õ–£–ì–û–î–ê",color:"#6c757d",backgroundColor:"#d6d8db",textColor:"#212529"},[p.MORE_THAN_YEAR]:{label:"–ë–û–õ–ï–ï –ì–û–î–ê",color:"#343a40",backgroundColor:"#c6c8ca",textColor:"#000000"}};function it(t){if(!t)return null;const e=String(t).trim();if(e.length===0)return null;try{const r=new Date(e);return isNaN(r.getTime())?(console.warn("Invalid date format:",t),null):r}catch(r){return console.error("Error parsing date:",t,r),null}}function X(t){if(!t)return"";let e;if(t instanceof Date?e=t:e=new Date(t),isNaN(e.getTime()))return"";const r=e.getDate(),o=e.getMonth()+1,n=e.getFullYear(),a=String(r).padStart(2,"0"),i=String(o).padStart(2,"0"),c=String(n);return`${a}.${i}.${c}`}function Lt(t,e=new Date){if(!t)return"";const r=t instanceof Date?t:new Date(t),o=e instanceof Date?e:new Date(e);if(isNaN(r.getTime())||isNaN(o.getTime()))return X(r);const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),i=new Date(o.getFullYear(),o.getMonth(),o.getDate())-n,c=Math.floor(i/(1e3*60*60*24));return c===0?"–°–µ–≥–æ–¥–Ω—è":X(r)}function xt(t,e=new Date){if(!t)return p.MORE_THAN_YEAR;const r=t instanceof Date?t:new Date(t),o=e instanceof Date?e:new Date(e);if(isNaN(r.getTime())||isNaN(o.getTime()))return p.MORE_THAN_YEAR;const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),a=new Date(o.getFullYear(),o.getMonth(),o.getDate()),i=a-n;if(i<0)return p.TODAY;const c=Math.floor(i/(1e3*60*60*24)),s=Math.floor(c/7),l=Math.floor(c/30),u=Math.floor(c/365);if(c===0)return p.TODAY;if(c===1)return p.YESTERDAY;const f=new Date(a),m=a.getDay(),d=m===0?6:m-1;if(f.setDate(a.getDate()-d),f.setHours(0,0,0,0),n>=f&&c<7)return p.THIS_WEEK;const g=new Date(f);return g.setDate(f.getDate()-7),n>=g&&n<f?p.LAST_WEEK:s>=2&&l<1?p.MORE_THAN_TWO_WEEKS:l>=1&&l<2?p.UP_TO_ONE_MONTH:l>=2&&l<6?p.MORE_THAN_TWO_MONTHS:l>=6&&u<1?p.MORE_THAN_HALF_YEAR:p.MORE_THAN_YEAR}const Ft={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(t,{emit:e}){const r=Dt(!1),o=S(()=>!1),n={color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d"},a={color:"#ced4da",backgroundColor:"#f8f9fa",textColor:"#6c757d"},i={color:"#dee2e6",backgroundColor:"#f8f9fa",textColor:"#6c757d"},c=S(()=>({label:t.ticket.priorityLabel||"–ù–µ —É–∫–∞–∑–∞–Ω–æ",colors:t.ticket.priorityColors||n})),s=S(()=>c.value.label||"–ù–µ —É–∫–∞–∑–∞–Ω–æ"),l=S(()=>({color:c.value.colors.textColor||n.textColor,backgroundColor:c.value.colors.backgroundColor||n.backgroundColor,borderColor:c.value.colors.color||n.color})),u=S(()=>({borderLeftColor:c.value.colors.color||n.color})),f=S(()=>{const h=t.ticket.service||{};return{label:h.label||t.ticket.serviceLabel||"–ù–µ —É–∫–∞–∑–∞–Ω–æ",colors:h.colors||t.ticket.serviceColors||a}}),m=S(()=>f.value.label||"–ù–µ —É–∫–∞–∑–∞–Ω–æ"),d=S(()=>({color:f.value.colors.textColor||a.textColor,backgroundColor:f.value.colors.backgroundColor||a.backgroundColor,borderColor:f.value.colors.color||a.color})),g=S(()=>{const h=t.ticket.actionStr||t.ticket.ufActionStr||null;if(!h)return null;const Y=String(h).trim();return Y.length>0?Y:null}),y=S(()=>({color:i.textColor,backgroundColor:i.backgroundColor,borderColor:i.color})),I=S(()=>{if(!t.ticket.createdAt)return"";const h=it(t.ticket.createdAt);return h?Lt(h):""}),C=S(()=>{if(!t.ticket.createdAt)return null;const h=it(t.ticket.createdAt);return xt(h)}),N=S(()=>{const h=C.value;return h&&Bt[h]||null}),z=S(()=>{const h=N.value;return h?{color:h.textColor,backgroundColor:h.backgroundColor,borderColor:h.color,border:`1px solid ${h.color}`}:{}});return{handleDragStart:h=>{o.value&&(h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("application/json",JSON.stringify(t.ticket)),h.dataTransfer.setDragImage(h.target,0,0),r.value=!0,e("drag-start",t.ticket))},handleDragEnd:()=>{o.value&&(r.value=!1,e("drag-end"))},handleCardClick:h=>{if(r.value)return;const Y=vt(t.ticket.id);window.open(Y,"_blank"),e("click",t.ticket)},isDragEnabled:o,priorityChipStyle:l,displayPriorityLabel:s,priorityBorderStyle:u,displayServiceLabel:m,serviceChipStyle:d,actionStrValue:g,actionChipStyle:y,formattedCreatedDate:I,dateAccentCategory:C,dateAccentConfig:N,dateAccentStyle:z}}},Ut=["draggable"],Ht={key:0,class:"ticket-department"},Pt={class:"ticket-header"},Vt={class:"ticket-id"},Yt={class:"ticket-title"},Wt={class:"ticket-meta"},$t={key:1,class:"ticket-action"},Kt={key:2,class:"ticket-description"},jt={class:"ticket-date-label"},Gt={class:"ticket-date-value"};function zt(t,e,r,o,n,a){var i;return F(),L("div",{class:"ticket-card",draggable:o.isDragEnabled,style:x(o.priorityBorderStyle),onClick:e[0]||(e[0]=(...c)=>o.handleCardClick&&o.handleCardClick(...c)),onDragstart:e[1]||(e[1]=(...c)=>o.handleDragStart&&o.handleDragStart(...c)),onDragend:e[2]||(e[2]=(...c)=>o.handleDragEnd&&o.handleDragEnd(...c))},[r.ticket.departmentHead?(F(),L("div",Ht,A(r.ticket.departmentHead),1)):W("",!0),D("div",Pt,[e[3]||(e[3]=D("span",{class:"ticket-icon"},"üé´",-1)),D("span",Vt,"#"+A(r.ticket.id),1)]),D("div",Yt,A(r.ticket.ufSubject||r.ticket.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"),1),D("div",Wt,[D("span",{class:"ticket-priority",style:x(o.priorityChipStyle)},A(o.displayPriorityLabel),5),D("span",{class:"ticket-service",style:x(o.serviceChipStyle)},A(o.displayServiceLabel),5)]),o.actionStrValue?(F(),L("div",$t,[D("span",{class:"ticket-action-chip",style:x(o.actionChipStyle)},A(o.actionStrValue),5)])):W("",!0),r.ticket.description?(F(),L("div",Kt,A(r.ticket.description),1)):W("",!0),o.formattedCreatedDate?(F(),L("div",{key:3,class:"ticket-created-date",style:x(o.dateAccentStyle)},[D("span",jt,A(((i=o.dateAccentConfig)==null?void 0:i.label)||""),1),D("span",Gt,A(o.formattedCreatedDate),1)],4)):W("",!0)],44,Ut)}const Ne=It(Ft,[["render",zt],["__scopeId","data-v-9cda001c"]]),J="dashboard-sector-1c-logger-level",U={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class qt{static getLevel(){if(typeof localStorage<"u"){const e=localStorage.getItem(J);if(e&&U[e]!==void 0)return e}return"ERROR"}static setLevel(e){return U[e]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(J,e),!0):!1}static isEnabled(e,r=null){const o=r||this.getLevel();if(o==="NONE")return!1;const n=U[e]||0,a=U[o]||0;return n<=a}static getLevels(){return{...U}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(J)}}class _{static getLevelColor(e){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[e]||"#6c757d"}static formatMessage(e,r,o=""){const n=new Date().toISOString(),a=this.getLevelColor(e),i=`%c[${n}] %c[${e}] %c[${o||"Unknown"}] %c${r}`,c=["color: #6c757d; font-weight: normal",`color: ${a}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:i,styles:c}}static log(e,r,o="",n=null){if(!qt.isEnabled(e))return;const a=this.formatMessage(e,r,o),i=[a.formatted,...a.styles];switch(n!=null&&i.push(n),e){case"ERROR":console.error(...i);break;case"WARN":console.warn(...i);break;case"INFO":console.info(...i);break;case"DEBUG":console.log(...i);break;default:console.log(...i)}}static error(e,r="",o=null){this.log("ERROR",e,r,o)}static warn(e,r="",o=null){this.log("WARN",e,r,o)}static info(e,r="",o=null){this.log("INFO",e,r,o)}static debug(e,r="",o=null){this.log("DEBUG",e,r,o)}}class Xt{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(e,r,o,n=null){this.metrics.ticketsLoading.stages[e]||(this.metrics.ticketsLoading.stages[e]={loaded:0,batches:[],total:0});const a=this.metrics.ticketsLoading.stages[e];a.loaded=o,a.batches.push({count:r,total:o,next:n}),a.total=o,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((i,c)=>i+c.total,0)}logFiltering(e,r,o=[],n=[]){this.metrics.filtering.total=e,this.metrics.filtering.filtered=r,this.metrics.filtering.rejected=o.slice(0,50),this.metrics.filtering.tagValueExamples=n.slice(0,20)}logEmployees(e,r=[],o=[]){this.metrics.employees.uniqueIds=e,this.metrics.employees.totalUnique=e.length,this.metrics.employees.ticketsWithoutAssignedById=r.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=o.slice(0,50)}logGrouping(e,r=[],o=[]){e.forEach(n=>{const a={};let i=0;n.employees.forEach(c=>{const s=(c.ticketsInsideSector||[]).length+(c.ticketsOutsideSector||[]).length;a[c.id]=s,i+=s}),this.metrics.grouping.distributionByStages[n.id]={employees:a,total:i}}),this.metrics.grouping.ticketsNotInColumn=r.slice(0,50),this.metrics.grouping.unknownStages=o.slice(0,50)}logZeroPoint(e){Object.keys(e).forEach(r=>{this.metrics.zeroPoint.byStage[r]=Array.isArray(e[r])?e[r].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let Z=null;function O(){return Z||(Z=new Xt),Z}function k(t=null,e=null){if(e&&!At(e))return!1;if(t&&t.query&&t.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const r=window.location.hash;if(r){const n=r.split("?");if(n.length>1){const a=n[1];if(new URLSearchParams(a).get("diagnostics")==="true")return!0}if(r.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class Jt{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,r={}){try{const o=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:r})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();if(n.error)throw new Error(n.error_description||n.error);return n}catch(o){throw console.error("Bitrix24 API error:",o),o}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},r=["ID","NAME","EMAIL","PHONE"],o={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:r,order:o})).result||[]}}class v{static async call(e,r={}){return await Jt.call(e,r)}}class E{static get(e){const r=this.cache.get(e);return r?Date.now()-r.timestamp>r.ttl?(this.cache.delete(e),null):r.data:null}static set(e,r,o=this.DEFAULT_TTL){this.cache.set(e,{data:r,timestamp:Date.now(),ttl:o})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const r=[];for(const o of this.cache.keys())o.startsWith(e)&&r.push(o);r.forEach(o=>this.cache.delete(o))}static cleanExpired(){const e=Date.now(),r=[];for(const[o,n]of this.cache.entries())e-n.timestamp>n.ttl&&r.push(o);r.forEach(o=>this.cache.delete(o))}static getStats(){const e=Date.now();let r=0,o=0;for(const n of this.cache.values())e-n.timestamp>n.ttl?r++:o++;return{total:this.cache.size,valid:o,expired:r}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((o,n)=>o-n).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}B(E,"cache",new Map),B(E,"DEFAULT_TTL",5*60*1e3),B(E,"EMPLOYEES_TTL",30*60*1e3),B(E,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{E.cleanExpired()},5*60*1e3);function T(t,e,r={}){if(!t||typeof t!="string")throw new Error("Step must be a non-empty string");const o=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let n=r.description;return n||(n=Zt(t,r)),{step:t,progress:o,details:{...r,description:n}}}function Zt(t,e){return t==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:t==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤: ${e.filteredTickets} –∏–∑ ${e.totalTickets}...`:t==="grouping"&&e.employeeCount!==void 0?`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ ${e.employeeCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`:e.count!==void 0&&e.total!==void 0?`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${e.count} –∏–∑ ${e.total}...`:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}function tt(t){if(!t||typeof t!="object")throw new Error("Progress info must be an object");const e=t.step||null;if(!e)throw new Error("Step is required in progress info");const r=t.progress!==void 0&&t.progress!==null?t.progress:t.percent!==void 0&&t.percent!==null?t.percent:void 0,o=t.details||{};return t.stage&&(o.stage=t.stage),t.stageName&&(o.stageName=t.stageName),t.stageIndex!==void 0&&(o.stageIndex=t.stageIndex),t.totalStages!==void 0&&(o.totalStages=t.totalStages),t.count!==void 0&&(o.count=t.count),t.total!==void 0&&(o.total=t.total),t.warning&&(o.warning=t.warning),{step:e,progress:r!=null?Math.max(0,Math.min(100,r)):void 0,details:o}}function dt(t,e,r){const o=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,n=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,a=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,i=o+n*a/100;return Math.max(0,Math.min(100,i))}const $=140;class H{static async getAllTickets(e,r=null,o=!0){const n=[],a=e.length;try{for(let i=0;i<e.length;i++){const c=e[i],s=this.getStageName(c);if(r){const l=i/a*100;r(T("loading_tickets",l,{stage:c,stageName:s,stageIndex:i+1,totalStages:a}))}try{const l=await this.getTicketsByStage(c,o,r?u=>{const f=dt(i/a*100,1/a*100,u.percent||0);r(T("loading_tickets",f,{stage:c,stageName:s,stageIndex:i+1,totalStages:a,count:u.count,total:u.total}))}:null);n.push(...l)}catch(l){_.error(`Error loading tickets for stage ${c}`,"TicketRepository",l);let u=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${s}"`;throw l.message&&(l.message.includes("HTTP error")||l.message.includes("network")?u=`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${s}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`:l.message.includes("timeout")?u=`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${s}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`:l.message.includes("403")||l.message.includes("401")?u=`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${s}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.`:u=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${s}": ${l.message}`),new Error(u)}}}catch(i){throw _.error("Error in getAllTickets","TicketRepository",i),i}return n}static getStageName(e){return{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[e]||e}static async getTicketsByStage(e,r=!0,o=null){var u,f,m;if(r){const d=E.getTicketsCacheKey(e),g=E.get(d);if(g!==null){try{const y=O();y&&k()&&y.logTicketsLoading(e,g.length,g.length,null)}catch(y){_.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",y)}return o&&o(tt({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}}const n=[];let a=0;const i=50;let c=!0,s=0,l=null;for(;c;)try{const d=await v.call("crm.item.list",{entityTypeId:$,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let g=[];if(d&&d.result&&(Array.isArray(d.result)?g=d.result:d.result.items&&Array.isArray(d.result.items)?g=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(g=d.result.data)),g.length>0){n.push(...g),a+=g.length;const y=((u=d==null?void 0:d.result)==null?void 0:u.next)??(d==null?void 0:d.next),I=y!=null&&y!==""&&String(y)!=="0";c=g.length===i&&I,k()&&_.debug(`[Pagination] Stage: ${e}, Batch: ${g.length}, Total: ${n.length}, Start: ${a}, NextValue: ${y}, HasNext: ${I}, HasMore: ${c}`,"TicketRepository");try{const C=O();C&&k()&&(_.debug(`[Pagination Debug] Stage: ${e}, Batch: ${g.length}, Total: ${n.length}`,"TicketRepository",{resultStructure:{hasResult:!!(d!=null&&d.result),resultIsArray:Array.isArray(d==null?void 0:d.result),hasItems:!!((f=d==null?void 0:d.result)!=null&&f.items),hasData:!!((m=d==null?void 0:d.result)!=null&&m.data),hasNext:!!y,nextValue:y,nextType:typeof y,resultKeys:d!=null&&d.result?Object.keys(d.result):[]}}),C.logTicketsLoading(e,g.length,n.length,y||null))}catch(C){_.warn("Diagnostics logging error","TicketRepository",C)}if(c?s=a+i:s=n.length,o){const C=s>0?Math.min(100,n.length/s*100):0;o(tt({step:"loading_tickets",percent:C,count:n.length,total:s}))}l=null}else c=!1}catch(d){if(_.error(`Error loading tickets batch for stage ${e} (start: ${a})`,"TicketRepository",d),a===0)throw l=d,new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç—ã –¥–ª—è —Å—Ç–∞–¥–∏–∏ ${e}: ${d.message||d}`);c=!1,o&&n.length>0&&o(T("loading_tickets",100,{count:n.length,total:n.length,warning:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ${n.length} —Ç–∏–∫–µ—Ç–æ–≤. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.`}))}if(l&&n.length===0)throw l;if(r){const d=E.getTicketsCacheKey(e);E.set(d,n,E.TICKETS_TTL)}return n}static async getTicket(e){return(await v.call("crm.item.get",{entityTypeId:$,id:e})).result||null}static async updateTicket(e,r){const n=(await v.call("crm.item.update",{entityTypeId:$,id:e,fields:r})).result===!0;return n&&E.invalidateTicketsCache(),n}static async createTicket(e){const r=await v.call("crm.item.add",{entityTypeId:$,fields:e}),o=r.result?parseInt(r.result):0;return o>0&&E.invalidateTicketsCache(),o}static async assignTicket(e,r,o){return await this.updateTicket(e,{assignedById:r,stageId:o})}}class Qt{static async getEmployeesByIds(e,r=!0){if(!Array.isArray(e)||e.length===0)return[];if(r){const o=E.getEmployeesCacheKey(e),n=E.get(o);if(n!==null)return _.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),n}try{const o=await v.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let n=[];if(o&&o.result&&(Array.isArray(o.result)?n=o.result:_.warn("Unexpected user.get result format","EmployeeRepository",o)),r){const a=E.getEmployeesCacheKey(e);E.set(a,n,E.EMPLOYEES_TTL)}return n}catch(o){return _.error("Error getting employees by IDs","EmployeeRepository",o),[]}}}function et(t){return bt[t]||"formed"}function at(t){return wt[t]||"DT140_12:UC_0VHWE2"}function te(){return Ot()}function ut(t){return t==null?null:String(t).trim().toLowerCase()||null}const ft=[{id:"general",label:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",bitrixValue:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"–í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≥–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)"},{id:"external",label:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",bitrixValue:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞/–±–ª–æ–∫–µ—Ä—ã"},{id:"board",label:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",bitrixValue:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è / —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤"},{id:"errors",label:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",bitrixValue:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã, –æ—à–∏–±–∫–∏ –∏ —Å–±–æ–∏"},{id:"operations",label:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",bitrixValue:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"},{id:"projects",label:"–ü—Ä–æ–µ–∫—Ç—ã",bitrixValue:"–ü—Ä–æ–µ–∫—Ç—ã",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"–ü—Ä–æ–µ–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏"},{id:"optimization",label:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",bitrixValue:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è"}],b={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö/–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"};b.id;const gt={},mt={};[...ft,b].forEach(t=>{gt[t.id]=t;const e=ut(t.bitrixValue);e&&(mt[e]=t)});function ee(t){if(!t)return b;const e=String(t).trim();return gt[e]||b}function rt(t){const e=ut(t);if(!e)return b;const r=mt[e];return r||b}function re(){return[...ft,b].sort((t,e)=>t.order-e.order)}function yt(t){if(t&&typeof t=="object"&&t.color)return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor};const e=ee(t)||rt(t)||b;return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor}}re();function ht(t){return t==null?null:String(t).trim().toLowerCase()||null}const _t=[{id:"1c-accounting",label:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",bitrixValue:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä 1–°"},{id:"1c-tickets",label:"1–°.–¢–∞–ª–æ–Ω—ã",bitrixValue:"1–°.–¢–∞–ª–æ–Ω—ã",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"–†–∞–±–æ—Ç–∞ —Å —Ç–∞–ª–æ–Ω–∞–º–∏ 1–°"},{id:"1c-zup",label:"1–°.–ó–£–ü",bitrixValue:"1–°.–ó–£–ü",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"–ó–∞—Ä–ø–ª–∞—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º"},{id:"1c-docflow",label:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",bitrixValue:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç 1–°"},{id:"1c-integrations",label:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",bitrixValue:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è 1–°"}],R={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö –∏–ª–∏ –Ω–µ–∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"},oe={},Et={};[..._t,R].forEach(t=>{oe[t.id]=t;const e=ht(t.bitrixValue);e&&(Et[e]=t)});function ne(t){const e=ht(t);if(!e)return R;const r=Et[e];return r||R}function ie(){return R}function ae(){return[..._t,R].sort((t,e)=>t.order-e.order)}function se(t){const e=t&&typeof t=="object"?t:R;return{color:e.color||R.color,backgroundColor:e.backgroundColor||R.backgroundColor,textColor:e.textColor||R.textColor}}ae();function ot(t){const e=parseInt(t.id||t.ID||0),r=t.title||t.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",o=t.stageId||t.STAGE_ID||"",n=t.assignedById||t.ASSIGNED_BY_ID||null,a=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",i=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"",c=t.UF_SUBJECT||t.uf_subject||t.ufSubject||t.UF_SUBJECT||t.uf_subject||null,s=t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||t.ufCrm7DepartmentHead||t.UF_CRM_7_DEPARTMENT_HEAD||t.uf_crm_7_department_head||null;let l=null,u=null;if(s){const M=String(s).trim();M.length>0&&(u=M,l=M.length>17?M.substring(0,17):M)}const f=t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.ufCrm7UfPriority||t.UF_CRM_7_UF_PRIORITY||t.uf_crm_7_uf_priority||t.priority||t.PRIORITY||null,m=rt(f),d=yt(m),g=t.UF_SLA_SERVICE_STR||t.uf_sla_service_str||t.UfSlaServiceStr||t.ufSlaServiceStr||t.service||null,y=ne(g),I=se(y),C=t.UF_ACTION_STR||t.uf_action_str||t.UfActionStr||t.ufActionStr||t.UF_ACTION_STR||t.uf_action_str||null,N=C?String(C).trim():null,z=N&&N.length>0?N:null;return{id:e,title:r,ufSubject:c,departmentHead:l,departmentHeadFull:u,priorityId:m.id,priorityLabel:m.label,priorityColors:d,priority:m.id,priorityBitrixValue:m.bitrixValue||null,service:y,serviceLabel:y.label,serviceColors:I,serviceBitrixValue:y.bitrixValue||ie().bitrixValue,actionStr:z,status:ce(),assigneeId:n?parseInt(n):null,stageId:et(o),createdAt:a,modifiedAt:i,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function ce(t){return"in_progress"}const P=new Map;function le(){P.clear()}function de(t){if(!t)return[];if(Array.isArray(t))return t.filter(r=>typeof r=="number"||!isNaN(parseInt(r))).map(r=>typeof r=="number"?r:parseInt(r));if(typeof t=="number")return[t];const e=parseInt(t);return isNaN(e)?[]:[e]}function ue(t,e=!0){const r=t.id||t.ID;if(!t||!r)return null;if(e&&P.has(r))return P.get(r);const o=t.UF_DEPARTMENT||t.departmentId,n=de(o);for(const a of n)if(kt(a)){const c=a;return e&&P.set(r,c),c}return e&&P.set(r,null),null}function fe(t){const e=ue(t);return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:t.WORK_POSITION||t.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:t.EMAIL||t.email||"",sectorId:e,departmentId:t.UF_DEPARTMENT||null,tickets:[]}}function ge(t){return Array.isArray(t)?t.map(e=>fe(e)):[]}const me="1C",ye=["1–°"],V=new Map,st=100;function pt(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function Q(t){return t==null?null:String(t).trim().toUpperCase().replace(/–°/g,"C")||null}function Tt(t){if(!t)return[];if(Array.isArray(t))return t.map(Q).filter(Boolean);if(typeof t=="object"&&t.value!==void 0){const r=Q(t.value);return r?[r]:[]}const e=Q(t);return e?e.split(/[;,]/).map(r=>r.trim()).filter(Boolean):[]}function ct(t){const e=pt(t),r=Tt(e);return r.length===0?!1:r.some(o=>o===me||ye.includes(o))}function he(t){return`filter:${t.map(r=>r.id||r.ID||"").sort().join(",")}`}function _e(){V.size>st&&Array.from(V.keys()).slice(0,Math.floor(st*.2)).forEach(e=>V.delete(e))}function Ee(t){if(!Array.isArray(t))return[];const e=he(t),r=V.get(e);if(r!==void 0)return r;const o=t.filter(ct);try{const n=O();if(n&&k()){const a=t.filter(s=>!ct(s)),i=[],c=new Set;t.forEach(s=>{const l=pt(s),u=Tt(l),f=l==null?"":String(l);l!=null&&!c.has(f)&&(c.add(f),i.push({value:l,normalized:u,type:typeof l,isArray:Array.isArray(l),ticketId:s.id||s.ID}))}),n.logFiltering(t.length,o.length,a,i)}}catch(n){console.warn("Diagnostics logging error in filterBySector:",n)}return V.set(e,o),_e(),o}const j=1051;function G(t){if(!t||typeof t!="object")return null;let e=t.assignedById||t.ASSIGNED_BY_ID||t.assignedByIdId||t.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function nt(t){if(t==null)return null;typeof t=="object"&&(t=t.id||t.ID||t.value||null);const e=typeof t=="number"?t:parseInt(t);return isNaN(e)||e<=0?null:e}function pe(t,e=j){const r=G(t),o=nt(r);return o===null||o===e}function Te(t,e){Array.isArray(t)||(_.warn("Tickets is not an array","TicketGrouper",t),t=[]),Array.isArray(e)||(_.warn("Employees is not an array","TicketGrouper",e),e=[]);const r=e.filter(s=>(s.id?parseInt(s.id):null)!==j),o=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:r.map(s=>({...s,isFromSector1C:s.sectorId===w.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:r.map(s=>({...s,isFromSector1C:s.sectorId===w.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:r.map(s=>({...s,isFromSector1C:s.sectorId===w.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],n=new Map(o.map(s=>[s.id,s])),a=new Map;o.forEach(s=>{const l=new Map(s.employees.map(u=>[u.id,u]));a.set(s.id,l)});const i=[],c=[];t.forEach(s=>{const l=et(s.stageId||s.STAGE_ID||""),u=n.get(l);if(!u){c.push({id:s.id||s.ID,title:s.title||s.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:s.stageId||s.STAGE_ID,assignedById:G(s)});return}const f=G(s),m=nt(f);if(m!==j)if(m){const d=a.get(l);let g=d.get(m);g||(g={id:m,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${m}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},u.employees.push(g),d.set(m,g));const y=ot(s),I={...y,stageId:s.stageId||s.STAGE_ID||y.stageId,departmentHead:y.departmentHead||null,departmentHeadFull:y.departmentHeadFull||y.departmentHead||null};g.tickets.push(I),g.isFromSector1C?g.ticketsInsideSector.push(I):g.ticketsOutsideSector.push(I)}else i.push({id:s.id||s.ID,title:s.title||s.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:l,assignedById:f})}),o.forEach(s=>{s.employees.sort((l,u)=>l.isFromSector1C&&!u.isFromSector1C?-1:!l.isFromSector1C&&u.isFromSector1C?1:(l.id||0)-(u.id||0))});try{const s=O();if(s&&k()){const l={};o.forEach(f=>{let m=0,d=0;f.employees.forEach(g=>{m+=(g.ticketsInsideSector||[]).length,d+=(g.ticketsOutsideSector||[]).length}),l[f.id]={insideSector:m,outsideSector:d,total:m+d}});const u=s.metrics.grouping;Object.keys(l).forEach(f=>{u.distributionByStages[f]||(u.distributionByStages[f]={employees:{},total:0}),u.distributionByStages[f].insideSector=l[f].insideSector,u.distributionByStages[f].outsideSector=l[f].outsideSector,u.distributionByStages[f].total=l[f].total}),s.logGrouping(o,i,c)}}catch(s){_.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",s)}return o}function Se(t){const e={formed:[],review:[],execution:[]};if(!Array.isArray(t))return _.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",t),e;t.filter(r=>pe(r)).forEach(r=>{const o=et(r.stageId||r.STAGE_ID||"");if(e[o]){const n=ot(r),a={...n,stageId:r.stageId||r.STAGE_ID||n.stageId,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null};e[o].push(a)}});try{const r=O();r&&k()&&r.logZeroPoint(e)}catch(r){_.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",r)}return e}function Ce(t){if(!Array.isArray(t))return[];const e=new Set,r=[],o=[];t.forEach(a=>{const i=G(a),c=nt(i);!i||i===null||i===void 0?r.push({id:a.id||a.ID,title:a.title||a.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:a.stageId||a.STAGE_ID}):c===j&&o.push({id:a.id||a.ID,title:a.title||a.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:a.stageId||a.STAGE_ID}),c&&e.add(c)});const n=Array.from(e);try{const a=O();a&&k()&&a.logEmployees(n,r,o)}catch(a){_.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",a)}return n}const K=new Map,Ie=10*60*1e3;function De(t){if(!t||typeof t!="object")return{};const e={},r=Object.keys(t);for(const o of r)o.toUpperCase().startsWith("UF_")&&(e[o]=t[o]);return e}function Ae(t,e=null,r=!0){if(r&&e&&K.has(e)){const a=K.get(e),i=Date.now();if(a.timestamp&&i-a.timestamp<Ie)return a.data;K.delete(e)}const o=De(t),n={typeProduct:o.UF_CRM_7_TYPE_PRODUCT||o.uf_crm_7_type_product||o.ufCrm7TypeProduct||null,all:o};return r&&e&&K.set(e,{data:n,timestamp:Date.now()}),n}class Re{static async getTicketDetails(e,r={}){const{select:o=["*"],useOriginalUfNames:n=!0,useCache:a=!0}=r;try{const i=await H.getTicket(e);if(!i)throw new Error(`–¢–∏–∫–µ—Ç —Å ID ${e} –Ω–µ –Ω–∞–π–¥–µ–Ω`);const c=Ae(i,e,a),s=i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.ufCrm7UfPriority||i.UF_CRM_7_UF_PRIORITY||i.uf_crm_7_uf_priority||i.priority||i.PRIORITY||null,l=rt(s),u=yt(l);return{id:i.id||i.ID,title:i.title||i.TITLE,stageId:i.stageId||i.STAGE_ID,assignedById:i.assignedById||i.ASSIGNED_BY_ID,createdAt:i.createdTime||i.CREATED_TIME||i.CREATED_DATE,updatedAt:i.updatedTime||i.UPDATED_TIME||i.MODIFY_DATE,priorityId:l.id,priorityLabel:l.label,priorityColors:u,priority:l.id,priorityBitrixValue:l.bitrixValue||null,opportunity:i.opportunity||i.OPPORTUNITY,currencyId:i.currencyId||i.CURRENCY_ID,comments:i.comments||i.COMMENTS,additionalFields:c,rawData:i}}catch(i){throw _.error("Error getting ticket details","TicketDetailsService",i),i}}}class Me{static async getSectorData(e=!0,r=null){try{if(k()){const o=O();o&&o.reset()}}catch(o){_.warn("Error resetting diagnostics","DashboardSector1CService",o)}if(r&&r(T("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),e){const o=E.getSectorDataCacheKey(),n=E.get(o);if(n!==null)return r&&r(T("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫–µ—à–∞"})),n}try{r&&r(T("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const o=te(),n=await H.getAllTickets(o,f=>{if(r){const m=tt(f),d=dt(10,40,m.progress||0);r(T(m.step||"loading_tickets",d,{...m.details,warning:m.details.warning}))}},e);r&&r(T("filtering",50,{totalTickets:n.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${n.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const a=Ee(n);r&&r(T("filtering",50,{totalTickets:n.length,filteredTickets:a.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${n.length}`})),r&&r(T("extracting_employees",60,{filteredTickets:a.length,description:`–ê–Ω–∞–ª–∏–∑ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const i=Ce(a);r&&r(T("extracting_employees",60,{employeeCount:i.length,description:`–ù–∞–π–¥–µ–Ω–æ ${i.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),r&&r(T("loading_employees",65,{employeeCount:i.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${i.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`})),le();const c=await Qt.getEmployeesByIds(i),s=ge(c);r&&r(T("loading_employees",90,{employeeCount:s.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${s.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),r&&r(T("grouping",90,{filteredTickets:a.length,employeeCount:s.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${s.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const u={stages:Te(a,s),employees:s,zeroPointTickets:Se(a)};if(r&&r(T("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),e){const f=E.getSectorDataCacheKey();E.set(f,u,E.TICKETS_TTL)}return r&&r(T("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),u}catch(o){throw _.error("Error getting sector data","DashboardSector1CService",o),r&&r({step:"error",progress:0,error:o.message}),o}}static async assignTicket(e,r,o){try{const n=at(o),a=await H.assignTicket(e,r,n);return a&&E.invalidateTicketsCache(),a}catch(n){throw _.error("Error assigning ticket","DashboardSector1CService",n),n}}static async createTicket(e){try{const r=at(e.stageId||"formed"),o={title:e.title,stageId:r};e.employeeId&&(o.assignedById=e.employeeId);const n=await H.createTicket(o);return n>0&&E.invalidateTicketsCache(),n}catch(r){throw _.error("Error creating ticket","DashboardSector1CService",r),r}}static async getTicket(e){try{const r=await H.getTicket(e);return ot(r)}catch(r){throw _.error("Error getting ticket","DashboardSector1CService",r),r}}static async getTicketDetails(e,r={}){try{return await Re.getTicketDetails(e,r)}catch(o){throw _.error("Error getting ticket details","DashboardSector1CService",o),o}}static async addComment(e,r){try{return(await v.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+lt,comment:r}})).result!==void 0}catch(o){throw _.error("Error adding comment","DashboardSector1CService",o),o}}}export{Jt as B,E as C,Me as D,j as K,_ as L,q as S,Ne as T,qt as a,H as b,le as c,wt as d,et as e,p as f,O as g,Bt as h,k as i,xt as j,vt as k,w as l,ot as m,tt as n,yt as o,ie as p,se as q};
