var le=Object.defineProperty;var de=(e,t,n)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var P=(e,t,n)=>de(e,typeof t!="symbol"?t+"":t,n);import{_ as O,c as h,a as g,b as _,t as k,n as L,o as m,F as C,r as N,d as M,e as A,f as v,g as E,w as R,T as V,h as B,i as ue,j as ie,k as Q,l as ge}from"./main-CjPdrdax.js";const fe={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(e,{emit:t}){return{getPriorityLabel:s=>({high:"–í—ã—Å–æ–∫–∏–π",medium:"–°—Ä–µ–¥–Ω–∏–π",low:"–ù–∏–∑–∫–∏–π"})[s]||s,getStatusLabel:s=>({in_progress:"–í —Ä–∞–±–æ—Ç–µ",new:"–ù–æ–≤—ã–π",done:"–í—ã–ø–æ–ª–Ω–µ–Ω–æ",pending:"–û–∂–∏–¥–∞–Ω–∏–µ"})[s]||s,handleDragStart:s=>{s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("application/json",JSON.stringify(e.ticket)),s.dataTransfer.setDragImage(s.target,0,0),t("drag-start",e.ticket)},handleDragEnd:()=>{t("drag-end")}}}},ye=["draggable"],me={class:"ticket-header"},pe={class:"ticket-id"},he={class:"ticket-title"},ke={class:"ticket-meta"},Te={class:"ticket-status"},_e={key:0,class:"ticket-description"};function Se(e,t,n,i,r,a){return m(),h("div",{class:L(["ticket-card",{"priority-high":n.ticket.priority==="high","priority-medium":n.ticket.priority==="medium","priority-low":n.ticket.priority==="low"}]),draggable:n.draggable,onClick:t[0]||(t[0]=s=>e.$emit("click",n.ticket)),onDragstart:t[1]||(t[1]=(...s)=>i.handleDragStart&&i.handleDragStart(...s)),onDragend:t[2]||(t[2]=(...s)=>i.handleDragEnd&&i.handleDragEnd(...s))},[g("div",me,[t[3]||(t[3]=g("span",{class:"ticket-icon"},"üé´",-1)),g("span",pe,"#"+k(n.ticket.id),1)]),g("div",he,k(n.ticket.title),1),g("div",ke,[g("span",{class:L(["ticket-priority",`priority-${n.ticket.priority}`])},k(i.getPriorityLabel(n.ticket.priority)),3),g("span",Te,k(i.getStatusLabel(n.ticket.status)),1)]),n.ticket.description?(m(),h("div",_e,k(n.ticket.description),1)):_("",!0)],42,ye)}const ne=O(fe,[["render",Se],["__scopeId","data-v-b255f359"]]),De={name:"ZeroPoint",components:{TicketCard:ne},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(e,{emit:t}){return{handleTicketDragStart:i=>{t("ticket-dragged",i)}}}},ve={class:"zero-point"},Ee={class:"zero-point-header"},Ie={class:"tickets-count"},Ae={class:"zero-point-tickets"},Ce={key:0,class:"empty-state"};function we(e,t,n,i,r,a){const s=M("TicketCard");return m(),h("div",ve,[g("div",Ee,[t[0]||(t[0]=g("span",{class:"zero-point-icon"},"üì•",-1)),t[1]||(t[1]=g("h3",null,"[0] –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞",-1)),g("span",Ie,"("+k(n.tickets.length)+")",1)]),t[3]||(t[3]=g("div",{class:"zero-point-description"},[g("p",null,"–í—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã"),g("p",{class:"hint"},"–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–∏–∫–µ—Ç –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")],-1)),g("div",Ae,[(m(!0),h(C,null,N(n.tickets,l=>(m(),A(s,{key:l.id,ticket:l,draggable:!0,onDragStart:c=>i.handleTicketDragStart(l),onClick:c=>e.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128)),n.tickets.length===0?(m(),h("div",Ce,[...t[2]||(t[2]=[g("p",null,"–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤",-1)])])):_("",!0)])])}const Ne=O(De,[["render",we],["__scopeId","data-v-252e877d"]]);function Me(e){return typeof e=="number"&&e>0&&!isNaN(e)}function re(e){return typeof e=="number"&&e>0&&!isNaN(e)}function se(e){return typeof e=="string"&&["formed","review","execution"].includes(e)}function Oe(e){return!e||typeof e!="object"?!1:Me(e.id)&&typeof e.title=="string"&&e.title.trim().length>0}function ae(e,t,n){return!(!Oe(e)||!re(t)||!se(n)||e.assigneeId===t&&e.stageId===n)}function Pe(e){const t=[];return!e||typeof e!="object"?(t.push("–î–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{valid:!1,errors:t}):((!e.title||typeof e.title!="string"||e.title.trim().length===0)&&t.push("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),e.stageId&&!se(e.stageId)&&t.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å—Ç–∞–¥–∏–∏"),e.employeeId&&!re(e.employeeId)&&t.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"),{valid:t.length===0,errors:t})}function oe(){const e=(a,s="info",l=5e3)=>{typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:a,autoHideDelay:l}):console.log(`[${s.toUpperCase()}] ${a}`)};return{notify:e,success:(a,s=3e3)=>{e(a,"success",s)},error:(a,s=5e3)=>{e(a,"error",s)},info:(a,s=4e3)=>{e(a,"info",s)},warning:(a,s=4e3)=>{e(a,"warning",s)}}}function Re(e){const t=oe(),n=v(!1);return{isDropZoneActive:n,handleDragStart:(c,f)=>{c.dataTransfer.effectAllowed="move",c.dataTransfer.setData("application/json",JSON.stringify(f)),c.dataTransfer.setDragImage(c.target,0,0)},handleDragOver:c=>{c.preventDefault(),c.dataTransfer.dropEffect="move",n.value=!0},handleDragLeave:c=>{const f=c.currentTarget.getBoundingClientRect(),d=c.clientX,u=c.clientY;(d<f.left||d>f.right||u<f.top||u>f.bottom)&&(n.value=!1)},handleDrop:async(c,f,d)=>{c.preventDefault(),n.value=!1;const u=c.dataTransfer.getData("application/json");if(u)try{const o=JSON.parse(u);if(!ae(o,f,d)){t.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞");return}e&&typeof e=="function"&&await e(o,f,d)}catch(o){console.error("Error parsing ticket data:",o),t.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞")}},handleDragEnd:c=>{n.value=!1}}}const be={name:"EmployeeColumn",components:{TicketCard:ne},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(e,{emit:t}){const i=Re(async(u,o,y)=>{t("ticket-dropped",u,o)}),r=E(()=>e.employee.isFromSector1C?Array.isArray(e.employee.tickets)?e.employee.tickets:[]:Array.isArray(e.employee.ticketsInsideSector)?e.employee.ticketsInsideSector:[]),a=E(()=>e.employee.isFromSector1C?[]:Array.isArray(e.employee.ticketsOutsideSector)?e.employee.ticketsOutsideSector:Array.isArray(e.employee.tickets)?e.employee.tickets:[]),s=E(()=>e.employee.isFromSector1C?Array.isArray(e.employee.tickets)?e.employee.tickets:[]:[]),l=E(()=>r.value.length+a.value.length),c=u=>{i.handleDrop(u,e.employee.id,e.stageId)},f=u=>{},d=()=>{console.log("Add ticket for employee:",e.employee.id)};return{isDropZoneActive:i.isDropZoneActive,handleDragOver:i.handleDragOver,handleDragLeave:i.handleDragLeave,handleDrop:c,ticketsInsideSector:r,ticketsOutsideSector:a,ticketsToDisplay:s,totalTicketsCount:l,handleTicketDragStart:f,handleAddTicket:d}}},Le={class:"employee-header"},Be={class:"employee-info"},Fe={class:"employee-details"},xe={class:"employee-name"},ze={key:0,class:"employee-position"},Ke={class:"tickets-count"},Ue={class:"tickets-list"},je={key:0,class:"tickets-section tickets-inside-sector"},Ve={key:1,class:"tickets-section tickets-outside-sector"},Xe={class:"section-header"},Ye={class:"section-count"},We={key:2,class:"empty-state"};function $e(e,t,n,i,r,a){const s=M("TicketCard");return m(),h("div",{class:L(["employee-column",{"drop-zone-active":i.isDropZoneActive}]),onDragover:t[1]||(t[1]=ue((...l)=>i.handleDragOver&&i.handleDragOver(...l),["prevent"])),onDragleave:t[2]||(t[2]=(...l)=>i.handleDragLeave&&i.handleDragLeave(...l)),onDrop:t[3]||(t[3]=(...l)=>i.handleDrop&&i.handleDrop(...l))},[g("div",Le,[g("div",Be,[t[4]||(t[4]=g("span",{class:"employee-icon"},"üë§",-1)),g("div",Fe,[g("div",xe,k(n.employee.name),1),n.employee.position?(m(),h("div",ze,k(n.employee.position),1)):_("",!0)])]),g("div",Ke," üìä –¢–∏–∫–µ—Ç–æ–≤: "+k(i.totalTicketsCount),1)]),g("div",Ue,[n.employee.isFromSector1C?(m(),A(V,{key:0,name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsToDisplay,l=>(m(),A(s,{key:l.id,ticket:l,draggable:!0,onClick:c=>e.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})):(m(),h(C,{key:1},[i.ticketsInsideSector.length>0?(m(),h("div",je,[B(V,{name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsInsideSector,l=>(m(),A(s,{key:l.id,ticket:l,draggable:!0,onClick:c=>e.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0),i.ticketsOutsideSector.length>0?(m(),h("div",Ve,[g("div",Xe,[t[5]||(t[5]=g("span",{class:"section-badge"},"–í–Ω–µ —Å–µ–∫—Ç–æ—Ä–∞",-1)),g("span",Ye,k(i.ticketsOutsideSector.length),1)]),B(V,{name:"ticket",tag:"div"},{default:R(()=>[(m(!0),h(C,null,N(i.ticketsOutsideSector,l=>(m(),A(s,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:c=>e.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0)],64)),i.totalTicketsCount===0?(m(),h("div",We,[t[6]||(t[6]=g("p",null,"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤",-1)),g("button",{class:"add-ticket-btn",onClick:t[0]||(t[0]=(...l)=>i.handleAddTicket&&i.handleAddTicket(...l))}," + –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç ")])):_("",!0)])],34)}const He=O(be,[["render",$e],["__scopeId","data-v-5779d978"]]),Ge={name:"DashboardStage",components:{ZeroPoint:Ne,EmployeeColumn:He},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(e,{emit:t}){const n=v(!1),i=E(()=>{const u=Array.isArray(e.zeroPointTickets)?e.zeroPointTickets.length:0,o=Array.isArray(e.stage.employees)?e.stage.employees.reduce((y,p)=>Array.isArray(p.ticketsInsideSector)?y+p.ticketsInsideSector.length:p.isFromSector1C&&Array.isArray(p.tickets)?y+p.tickets.length:y,0):0;return u+o}),r=E(()=>Array.isArray(e.stage.employees)?e.stage.employees.reduce((u,o)=>Array.isArray(o.ticketsOutsideSector)?u+o.ticketsOutsideSector.length:!o.isFromSector1C&&Array.isArray(o.tickets)?u+o.tickets.length:u,0):0),a=E(()=>i.value+r.value),s=E(()=>{var p;const u=((p=e.stage)==null?void 0:p.name)||"–°—Ç–∞–¥–∏—è",o=i.value,y=r.value;return y===0?`${u} (${o})`:`${u} (${o} / ${y})`});return{isDragging:n,ticketsCountInsideSector:i,ticketsCountOutsideSector:r,totalTicketsCount:a,stageNameWithCount:s,handleTicketDragged:u=>{n.value=!0},handleTicketAssigned:(u,o)=>{t("ticket-assigned",u,o)},handleTicketDropped:(u,o)=>{t("ticket-moved",u,o,e.stage.id),n.value=!1},handleTicketClicked:u=>{console.log("Ticket clicked:",u),t("ticket-clicked",u)}}}},Ze={class:"stage-header"},qe={class:"stage-content"},Je={class:"employees-container"};function Qe(e,t,n,i,r,a){const s=M("ZeroPoint"),l=M("EmployeeColumn");return m(),h("div",{class:"dashboard-stage",style:ie({borderLeftColor:n.stage.color})},[g("div",Ze,[g("h2",null,k(i.stageNameWithCount),1)]),g("div",qe,[B(s,{tickets:n.zeroPointTickets,"stage-id":n.stage.id,onTicketDragged:i.handleTicketDragged,onTicketAssigned:i.handleTicketAssigned,onTicketClicked:i.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),g("div",Je,[(m(!0),h(C,null,N(n.stage.employees,c=>(m(),A(l,{key:c.id,employee:c,"stage-id":n.stage.id,onTicketClicked:i.handleTicketClicked,onTicketDropped:i.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const et=O(Ge,[["render",Qe],["__scopeId","data-v-3eed4deb"]]),X={cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},tt={loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},it={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(e,{emit:t}){const n=E(()=>{var u;const{currentStep:f,stepDetails:d}=e;return d!=null&&d.description?{title:f?((u=X[f])==null?void 0:u.title)||f:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:d.description}:f?X[f]?X[f]:tt[f]||{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."}:{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."}}),i=E(()=>n.value.title),r=E(()=>n.value.description),a=E(()=>e.stepDetails),s=E(()=>{const f=e.progress;return f==null||isNaN(f)?0:Math.round(Math.max(0,Math.min(100,f)))});return{stepTitle:i,stepDescription:r,details:a,displayProgress:s,getStageDisplayName:f=>f?{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ","–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[f]||f:"",handleRetry:()=>{t("retry")}}}},nt={class:"preloader-backdrop"},rt={class:"preloader-container"},st={class:"preloader-content-scrollable"},at={key:0,class:"spinner-container"},ot={class:"preloader-content"},ct={class:"step-title"},lt={key:0,class:"step-description"},dt={key:1,class:"progress-container"},ut={class:"progress-bar"},gt={class:"progress-text"},ft={key:2,class:"step-details"},yt={key:0,class:"detail-description"},mt={key:1,class:"detail-item"},pt={class:"detail-value"},ht={key:0,class:"detail-total"},kt={key:2,class:"detail-item"},Tt={class:"detail-value"},_t={key:0,class:"detail-total"},St={key:3,class:"detail-item"},Dt={class:"detail-value"},vt={key:0,class:"detail-total"},Et={key:4,class:"detail-item"},It={class:"detail-value"},At={key:5,class:"detail-warning"},Ct={key:0,class:"error-container"},wt={class:"error-content"},Nt={class:"error-message"};function Mt(e,t,n,i,r,a){return m(),h("div",{class:L(["loading-preloader",{"has-error":n.error}])},[g("div",nt,[g("div",rt,[g("div",st,[n.error?_("",!0):(m(),h("div",at,[...t[1]||(t[1]=[g("div",{class:"spinner"},null,-1)])])),g("div",ot,[g("h3",ct,k(i.stepTitle),1),i.stepDescription?(m(),h("p",lt,k(i.stepDescription),1)):_("",!0),n.error?_("",!0):(m(),h("div",dt,[g("div",ut,[g("div",{class:"progress-fill",style:ie({width:i.displayProgress+"%"})},null,4)]),g("span",gt,k(i.displayProgress)+"%",1)])),n.error?_("",!0):(m(),h("div",ft,[i.details.description?(m(),h("div",yt,k(i.details.description),1)):_("",!0),i.details.count!==void 0?(m(),h("div",mt,[t[2]||(t[2]=g("span",{class:"detail-label"},"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",pt,k(i.details.count),1),i.details.total!==void 0?(m(),h("span",ht," –∏–∑ "+k(i.details.total),1)):_("",!0)])):_("",!0),i.details.filteredTickets!==void 0?(m(),h("div",kt,[t[3]||(t[3]=g("span",{class:"detail-label"},"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),g("span",Tt,k(i.details.filteredTickets),1),i.details.totalTickets!==void 0?(m(),h("span",_t," –∏–∑ "+k(i.details.totalTickets),1)):_("",!0)])):_("",!0),i.details.stage?(m(),h("div",St,[t[4]||(t[4]=g("span",{class:"detail-label"},"–°—Ç–∞–¥–∏—è:",-1)),g("span",Dt,k(i.getStageDisplayName(i.details.stage)),1),i.details.stageIndex&&i.details.totalStages?(m(),h("span",vt," ("+k(i.details.stageIndex)+"/"+k(i.details.totalStages)+") ",1)):_("",!0)])):_("",!0),i.details.employeeCount!==void 0?(m(),h("div",Et,[t[5]||(t[5]=g("span",{class:"detail-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",-1)),g("span",It,k(i.details.employeeCount),1)])):_("",!0),i.details.warning?(m(),h("div",At,[g("span",null,"‚ö†Ô∏è "+k(i.details.warning),1)])):_("",!0)]))])])])]),n.error?(m(),h("div",Ct,[g("div",wt,[t[6]||(t[6]=g("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),g("p",Nt,k(n.error),1),g("button",{onClick:t[0]||(t[0]=(...s)=>i.handleRetry&&i.handleRetry(...s)),class:"retry-button"}," –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É ")])])):_("",!0)],2)}const Ot=O(it,[["render",Mt],["__scopeId","data-v-d129ff19"]]);function Pt(){const e=v(!1),t=v(null),n=v([{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}]),i=v({formed:[],review:[],execution:[]}),r=v([]),a=v(null);return{isLoading:e,error:t,stages:n,zeroPointTickets:i,employees:r,draggedTicket:a,updateState:d=>{d.stages&&(n.value=d.stages),d.employees&&(r.value=d.employees),d.zeroPointTickets&&(i.value=d.zeroPointTickets)},resetState:()=>{e.value=!1,t.value=null,n.value=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}],i.value={formed:[],review:[],execution:[]},r.value=[],a.value=null},updateLocalStateAfterMove:(d,u,o)=>{const y=n.value.find(S=>S.employees.some(I=>I.tickets.some(j=>j.id===d.id)));if(y){const S=y.employees.find(I=>I.tickets.some(j=>j.id===d.id));S&&(S.tickets=S.tickets.filter(I=>I.id!==d.id))}const p=n.value.find(S=>S.id===o);if(p){const S=p.employees.find(I=>I.id===u);if(S){const I={...d,assigneeId:u,stageId:o};S.tickets.push(I)}}Object.keys(i.value).forEach(S=>{i.value[S]=i.value[S].filter(I=>I.id!==d.id)})},getEmployeeTickets:(d,u)=>{const o=n.value.find(p=>p.id===u);if(!o)return[];const y=o.employees.find(p=>p.id===d);return y?y.tickets||[]:[]}}}class Rt{static getApiUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(t,n={}){try{const i=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:t,params:n})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if(r.error)throw new Error(r.error_description||r.error);return r}catch(i){throw console.error("Bitrix24 API error:",i),i}}static async getProfile(){return this.call("profile",{})}static async getLeads(t={},n=["ID","NAME","EMAIL","PHONE"],i={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:t,select:n,order:i})).result||[]}}class w{static async call(t,n={}){return await Rt.call(t,n)}}class T{static get(t){const n=this.cache.get(t);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(t),null):n.data:null}static set(t,n,i=this.DEFAULT_TTL){this.cache.set(t,{data:n,timestamp:Date.now(),ttl:i})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const n=[];for(const i of this.cache.keys())i.startsWith(t)&&n.push(i);n.forEach(i=>this.cache.delete(i))}static cleanExpired(){const t=Date.now(),n=[];for(const[i,r]of this.cache.entries())t-r.timestamp>r.ttl&&n.push(i);n.forEach(i=>this.cache.delete(i))}static getStats(){const t=Date.now();let n=0,i=0;for(const r of this.cache.values())t-r.timestamp>r.ttl?n++:i++;return{total:this.cache.size,valid:i,expired:n}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((i,r)=>i-r).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}P(T,"cache",new Map),P(T,"DEFAULT_TTL",5*60*1e3),P(T,"EMPLOYEES_TTL",30*60*1e3),P(T,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{T.cleanExpired()},5*60*1e3);function D(e,t,n={}){if(!e||typeof e!="string")throw new Error("Step must be a non-empty string");const i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let r=n.description;return r||(r=bt(e,n)),{step:e,progress:i,details:{...n,description:r}}}function bt(e,t){return e==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:e==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤: ${t.filteredTickets} –∏–∑ ${t.totalTickets}...`:e==="grouping"&&t.employeeCount!==void 0?`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ ${t.employeeCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`:t.count!==void 0&&t.total!==void 0?`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${t.count} –∏–∑ ${t.total}...`:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}function U(e){if(!e||typeof e!="object")throw new Error("Progress info must be an object");const t=e.step||null;if(!t)throw new Error("Step is required in progress info");const n=e.progress!==void 0&&e.progress!==null?e.progress:e.percent!==void 0&&e.percent!==null?e.percent:void 0,i=e.details||{};return e.stage&&(i.stage=e.stage),e.stageName&&(i.stageName=e.stageName),e.stageIndex!==void 0&&(i.stageIndex=e.stageIndex),e.totalStages!==void 0&&(i.totalStages=e.totalStages),e.count!==void 0&&(i.count=e.count),e.total!==void 0&&(i.total=e.total),e.warning&&(i.warning=e.warning),{step:t,progress:n!=null?Math.max(0,Math.min(100,n)):void 0,details:i}}function ce(e,t,n){const i=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,r=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,a=typeof n=="number"&&!isNaN(n)?Math.max(0,Math.min(100,n)):0,s=i+r*a/100;return Math.max(0,Math.min(100,s))}const F=140;class x{static async getAllTickets(t,n=null){const i=[],r=t.length;try{for(let a=0;a<t.length;a++){const s=t[a],l=this.getStageName(s);if(n){const c=a/r*100;n(D("loading_tickets",c,{stage:s,stageName:l,stageIndex:a+1,totalStages:r}))}try{const c=await this.getTicketsByStage(s,!0,n?f=>{const d=ce(a/r*100,1/r*100,f.percent||0);n(D("loading_tickets",d,{stage:s,stageName:l,stageIndex:a+1,totalStages:r,count:f.count,total:f.total}))}:null);i.push(...c)}catch(c){console.error(`Error loading tickets for stage ${s}:`,c);let f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}"`;throw c.message&&(c.message.includes("HTTP error")||c.message.includes("network")?f=`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`:c.message.includes("timeout")?f=`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`:c.message.includes("403")||c.message.includes("401")?f=`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.`:f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}": ${c.message}`),new Error(f)}}}catch(a){throw console.error("Error in getAllTickets:",a),a}return i}static getStageName(t){return{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[t]||t}static async getTicketsByStage(t,n=!0,i=null){if(n){const d=T.getTicketsCacheKey(t),u=T.get(d);if(u!==null)return i&&i(U({step:"loading_tickets",percent:100,count:u.length,total:u.length})),u}const r=[];let a=0;const s=50;let l=!0,c=0,f=null;for(;l;)try{const d=await w.call("crm.item.list",{entityTypeId:F,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let u=[];if(d&&d.result&&(Array.isArray(d.result)?u=d.result:d.result.items&&Array.isArray(d.result.items)?u=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(u=d.result.data)),u.length>0){if(r.push(...u),a+=u.length,l=u.length===s,l?c=a+s:c=r.length,i){const o=c>0?Math.min(100,r.length/c*100):0;i(U({step:"loading_tickets",percent:o,count:r.length,total:c}))}f=null}else l=!1}catch(d){if(console.error(`Error loading tickets batch for stage ${t} (start: ${a}):`,d),a===0)throw f=d,new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç—ã –¥–ª—è —Å—Ç–∞–¥–∏–∏ ${t}: ${d.message||d}`);l=!1,i&&r.length>0&&i(D("loading_tickets",100,{count:r.length,total:r.length,warning:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ${r.length} —Ç–∏–∫–µ—Ç–æ–≤. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.`}))}if(f&&r.length===0)throw f;if(n){const d=T.getTicketsCacheKey(t);T.set(d,r,T.TICKETS_TTL)}return r}static async getTicket(t){return(await w.call("crm.item.get",{entityTypeId:F,id:t})).result||null}static async updateTicket(t,n){const r=(await w.call("crm.item.update",{entityTypeId:F,id:t,fields:n})).result===!0;return r&&T.invalidateTicketsCache(),r}static async createTicket(t){const n=await w.call("crm.item.add",{entityTypeId:F,fields:t}),i=n.result?parseInt(n.result):0;return i>0&&T.invalidateTicketsCache(),i}static async assignTicket(t,n,i){return await this.updateTicket(t,{assignedById:n,stageId:i})}}class Lt{static async getEmployeesByIds(t,n=!0){if(!Array.isArray(t)||t.length===0)return[];if(n){const i=T.getEmployeesCacheKey(t),r=T.get(i);if(r!==null)return console.log(`Cache hit for employees: ${t.length} employees`),r}try{const i=await w.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let r=[];if(i&&i.result&&(Array.isArray(i.result)?r=i.result:console.warn("Unexpected user.get result format:",i)),n){const a=T.getEmployeesCacheKey(t);T.set(a,r,T.EMPLOYEES_TTL)}return r}catch(i){return console.error("Error getting employees by IDs:",i),[]}}}const K=366,Bt=368,Ft=369,xt=367,zt=[K,Bt,Ft,xt],Kt=140,Y={FORMED:{bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{bitrixId:"DT140_12:PREPARATION"},EXECUTION:{bitrixId:"DT140_12:CLIENT"}},Ut={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},jt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},Vt={3:"high",2:"medium",1:"low"};function Xt(){return[Y.FORMED.bitrixId,Y.REVIEW.bitrixId,Y.EXECUTION.bitrixId]}function G(e){return Ut[e]||"formed"}function ee(e){return jt[e]||"DT140_12:UC_0VHWE2"}function Yt(){return Xt()}function Z(e){const t=parseInt(e.id||e.ID||0),n=e.title||e.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",i=e.stageId||e.STAGE_ID||"",r=e.assignedById||e.ASSIGNED_BY_ID||null,a=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",s=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"";return{id:t,title:n,priority:Wt(e.priority||e.PRIORITY),status:$t(),assigneeId:r?parseInt(r):null,stageId:G(i),createdAt:a,modifiedAt:s,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function Wt(e){return Vt[e]||"medium"}function $t(e){return"in_progress"}function Ht(e){if(!e||!e.UF_DEPARTMENT)return null;const t=Array.isArray(e.UF_DEPARTMENT)?e.UF_DEPARTMENT:[e.UF_DEPARTMENT];for(const n of t){const i=typeof n=="number"?n:parseInt(n);if(!isNaN(i)&&zt.includes(i))return i}return null}function Gt(e){const t=Ht(e);return{id:parseInt(e.ID||e.id||0),name:`${e.NAME||e.name||""} ${e.LAST_NAME||e.lastName||""}`.trim()||e.EMAIL||e.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:e.WORK_POSITION||e.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:e.EMAIL||e.email||"",sectorId:t,departmentId:e.UF_DEPARTMENT||null,tickets:[]}}function Zt(e){return Array.isArray(e)?e.map(t=>Gt(t)):[]}const z="1C",b=new Map,te=100;function qt(e){return e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||e.ufCrm7TypeProduct||e.UF_CRM_7_TYPE_PRODUCT||e.uf_crm_7_type_product||null}function Jt(e){const t=qt(e);return t?Array.isArray(t)?t.includes(z):typeof t=="object"&&t!==null&&t.value===z||t===z:!1}function Qt(e){return`filter:${e.map(n=>n.id||n.ID||"").sort().join(",")}`}function ei(){b.size>te&&Array.from(b.keys()).slice(0,Math.floor(te*.2)).forEach(t=>b.delete(t))}function ti(e){if(!Array.isArray(e))return[];const t=Qt(e),n=b.get(t);if(n!==void 0)return n;const i=e.filter(Jt);return b.set(t,i),ei(),i}const H=1051;function q(e){if(!e||typeof e!="object")return null;let t=e.assignedById||e.ASSIGNED_BY_ID||e.assignedByIdId||e.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function J(e){if(e==null)return null;typeof e=="object"&&(e=e.id||e.ID||e.value||null);const t=typeof e=="number"?e:parseInt(e);return isNaN(t)||t<=0?null:t}function ii(e,t=H){const n=q(e),i=J(n);return i===null||i===t}function ni(e,t){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(t)||(console.warn("Employees is not an array:",t),t=[]);const n=t.filter(s=>(s.id?parseInt(s.id):null)!==H),i=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:n.map(s=>({...s,isFromSector1C:s.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:n.map(s=>({...s,isFromSector1C:s.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:n.map(s=>({...s,isFromSector1C:s.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],r=new Map(i.map(s=>[s.id,s])),a=new Map;return i.forEach(s=>{const l=new Map(s.employees.map(c=>[c.id,c]));a.set(s.id,l)}),e.forEach(s=>{const l=G(s.stageId||s.STAGE_ID||""),c=r.get(l);if(c){const f=q(s),d=J(f);if(d===H)return;if(d){const u=a.get(l);let o=u.get(d);o||(o={id:d,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${d}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},c.employees.push(o),u.set(d,o));const y=Z(s);o.tickets.push(y),o.isFromSector1C?o.ticketsInsideSector.push(y):o.ticketsOutsideSector.push(y)}}}),i.forEach(s=>{s.employees.sort((l,c)=>l.isFromSector1C&&!c.isFromSector1C?-1:!l.isFromSector1C&&c.isFromSector1C?1:(l.id||0)-(c.id||0))}),i}function ri(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(n=>ii(n)).forEach(n=>{const i=G(n.stageId||n.STAGE_ID||"");t[i]&&t[i].push(Z(n))}),t):(console.warn("Tickets is not an array in getZeroPointTickets:",e),t)}function si(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(n=>{const i=q(n),r=J(i);r&&t.add(r)}),Array.from(t)}class W{static async getSectorData(t=!0,n=null){if(n&&n(D("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),t){const i=T.getSectorDataCacheKey(),r=T.get(i);if(r!==null)return n&&n(D("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫–µ—à–∞"})),r}try{n&&n(D("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const i=Yt(),r=await x.getAllTickets(i,u=>{if(n){const o=U(u),y=ce(10,40,o.progress||0);n(D(o.step||"loading_tickets",y,{...o.details,warning:o.details.warning}))}});n&&n(D("filtering",50,{totalTickets:r.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${r.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const a=ti(r);n&&n(D("filtering",50,{totalTickets:r.length,filteredTickets:a.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${r.length}`})),n&&n(D("extracting_employees",60,{filteredTickets:a.length,description:`–ê–Ω–∞–ª–∏–∑ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const s=si(a);n&&n(D("extracting_employees",60,{employeeCount:s.length,description:`–ù–∞–π–¥–µ–Ω–æ ${s.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(D("loading_employees",65,{employeeCount:s.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${s.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const l=await Lt.getEmployeesByIds(s),c=Zt(l);n&&n(D("loading_employees",90,{employeeCount:c.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${c.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(D("grouping",90,{filteredTickets:a.length,employeeCount:c.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${c.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const d={stages:ni(a,c),employees:c,zeroPointTickets:ri(a)};if(n&&n(D("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),t){const u=T.getSectorDataCacheKey();T.set(u,d,T.TICKETS_TTL)}return n&&n(D("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),d}catch(i){throw console.error("Error getting sector data:",i),n&&n({step:"error",progress:0,error:i.message}),i}}static async assignTicket(t,n,i){try{const r=ee(i),a=await x.assignTicket(t,n,r);return a&&T.invalidateTicketsCache(),a}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(t){try{const n=ee(t.stageId||"formed"),i={title:t.title,stageId:n};t.employeeId&&(i.assignedById=t.employeeId);const r=await x.createTicket(i);return r>0&&T.invalidateTicketsCache(),r}catch(n){throw console.error("Error creating ticket:",n),n}}static async getTicket(t){try{const n=await x.getTicket(t);return Z(n)}catch(n){throw console.error("Error getting ticket:",n),n}}static async addComment(t,n){try{return(await w.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+Kt,comment:n}})).result!==void 0}catch(i){throw console.error("Error adding comment:",i),i}}}function ai(){const e=v(null),t=v(0),n=v(null),i=v(null),r=v({}),a=(o,y={})=>{e.value=o,r.value=y},s=o=>{const y=typeof o=="number"&&!isNaN(o)?o:0;t.value=Math.min(100,Math.max(0,y))},l=o=>{n.value=o,i.value=null},c=o=>{i.value=o},f=()=>{i.value=null},d=()=>{e.value=null,t.value=0,n.value=null,i.value=null,r.value={}},u=E(()=>n.value||i.value);return{currentStep:e,progress:t,error:n,temporaryError:i,displayError:u,stepDetails:r,updateStep:a,updateProgress:s,setError:l,setTemporaryError:c,clearTemporaryError:f,reset:d}}function oi(e,t=""){if(console.error(`API Error ${t?`(${t})`:""}:`,e),e.message){if(e.message.includes("HTTP error"))return"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";if(e.message.includes("timeout"))return"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";if(e.message.includes("403")||e.message.includes("401"))return"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";if(e.message.includes("500"))return"–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."}return e.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}function ci(e,t="",n={}){const i={message:e.message,stack:e.stack,context:t,...n,timestamp:new Date().toISOString()};console.error("Error logged:",i)}function $(e,t="",n=null){const i=oi(e,t);ci(e,t),n&&typeof n=="function"?n(i,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:i,autoHideDelay:5e3})}function li(e){const t=oe(),n=ai(),i=v(!1);function r(o,y){const p=U(o);p.step&&y.updateStep(p.step,p.details||{}),p.progress!==void 0&&p.progress!==null&&(y.updateProgress(p.progress),y.clearTemporaryError())}const a=async(o=!0)=>{e.isLoading.value=!0,e.error.value=null,n.reset(),n.updateStep("cache_check",{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö..."}),n.updateProgress(0);try{const y=await W.getSectorData(o,p=>{r(p,n)});e.updateState(y)}catch(y){e.error.value=y.message,n.setError(y.message),$(y,"loading sector data",t.error)}finally{e.error.value?e.isLoading.value=!1:(n.updateStep("complete",{description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"}),n.updateProgress(100),setTimeout(()=>{i.value=!0,setTimeout(()=>{e.isLoading.value=!1},150),setTimeout(()=>{n.reset(),i.value=!1},400)},800))}},s=async(o,y,p)=>{if(!ae(o,y,p))return t.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞"),!1;try{const S=await W.assignTicket(o.id,y,p);return S&&(e.updateLocalStateAfterMove(o,y,p),t.success("–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω")),S}catch(S){return $(S,"assigning ticket",t.error),!1}finally{e.draggedTicket.value=null}};return{loadSectorData:a,assignTicket:s,moveTicketToStage:async(o,y)=>await s(o,o.assigneeId,y),assignTicketToEmployee:async(o,y)=>await s(o,y,o.stageId),createTicket:async o=>{const y=Pe(o);if(!y.valid){const p=y.errors.join(", ");return t.error(p),0}try{const p=await W.createTicket(o);return p>0&&(await a(!1),t.success("–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω")),p}catch(p){return $(p,"creating ticket",t.error),0}},handleTicketDragStart:o=>{e.draggedTicket.value=o},handleTicketDrop:async(o,y,p)=>{await s(o,y,p)},loadingProgress:n,isTransitioning:i}}const di={name:"DashboardSector1C",components:{DashboardStage:et,LoadingPreloader:Ot},setup(){const e=Pt(),t=li(e);ge(()=>{t.loadSectorData()});const n=()=>{t.loadSectorData(!1)},i=t.loadingProgress;return{isLoading:e.isLoading,error:e.error,stages:e.stages,zeroPointTickets:e.zeroPointTickets,employees:e.employees,draggedTicket:e.draggedTicket,currentStep:i.currentStep,progress:i.progress,stepDetails:i.stepDetails,loadingProgress:i,loadSectorData:t.loadSectorData,handleTicketDragStart:t.handleTicketDragStart,handleTicketDrop:t.handleTicketDrop,assignTicketToEmployee:t.assignTicketToEmployee,moveTicketToStage:t.moveTicketToStage,createTicket:t.createTicket,getEmployeeTickets:e.getEmployeeTickets,handleRetry:n,isTransitioning:t.isTransitioning}}},ui={key:0,class:"dashboard-content"},gi={class:"stages-container"};function fi(e,t,n,i,r,a){const s=M("LoadingPreloader"),l=M("DashboardStage");return m(),h("div",{class:L(["dashboard-sector-1c",{"is-dragging":i.draggedTicket}])},[t[0]||(t[0]=g("div",{class:"dashboard-header"},[g("h1",null,"–î–∞—à–±–æ—Ä–¥ - –°–µ–∫—Ç–æ—Ä 1–°")],-1)),B(Q,{name:"preloader-fade"},{default:R(()=>[i.isLoading||i.error||i.currentStep?(m(),A(s,{key:0,"current-step":i.currentStep,progress:i.progress,"step-details":i.stepDetails,error:i.error||null,onRetry:i.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):_("",!0)]),_:1}),B(Q,{name:"dashboard-fade"},{default:R(()=>[!i.isLoading&&!i.error&&!i.currentStep?(m(),h("div",ui,[g("div",gi,[(m(!0),h(C,null,N(i.stages,c=>(m(),A(l,{key:c.id,stage:c,"zero-point-tickets":i.zeroPointTickets[c.id]||[],onTicketMoved:i.handleTicketDrop,onTicketAssigned:i.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):_("",!0)]),_:1})],2)}const pi=O(di,[["render",fi],["__scopeId","data-v-f478d860"]]);export{pi as default};
