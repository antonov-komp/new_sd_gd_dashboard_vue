import{a as ue}from"./chunk-B5yqeUNo.js";import{C as I,L as m,f as Q,h as fe,i as k,j as B,b as P,k as b,l as h,n as pe,m as ge,o as me,E as ye,p as j,S as L}from"./chunk-rKmNpCr3.js";import{m as W,g as he,a as X}from"./chunk-DVSMqPZp.js";import{B as q}from"./chunk-UTsEWqhV.js";class Y{static notifyCacheCreationStarted(e){this.showNotification({content:`–ù–∞—á–∞—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞ –¥–ª—è –º–æ–¥—É–ª—è "${e}"...`,type:"info",autoHideDelay:3e3})}static notifyCacheCreationSuccess(e){this.showNotification({content:`‚úÖ –ö–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`,type:"success",autoHideDelay:5e3})}static notifyCacheCreationError(e,t){this.showNotification({content:`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ—à–∞ –¥–ª—è –º–æ–¥—É–ª—è "${e}": ${t}`,type:"error",autoHideDelay:7e3})}static notifyCacheUpdated(e,t="auto"){const a=t==="manual"?"–≤—Ä—É—á–Ω—É—é":"–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏";this.showNotification({content:`üîÑ –ö–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}" –æ–±–Ω–æ–≤–ª—ë–Ω ${a}`,type:"info",autoHideDelay:4e3})}static notifyCacheUsed(e){this.showNotification({content:`‚ö° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–µ—à –¥–ª—è –º–æ–¥—É–ª—è "${e}"`,type:"success",autoHideDelay:3e3})}static showNotification(e){typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:e.content,autoHideDelay:e.autoHideDelay||3e3}):console.log("[CacheNotification]",e.content)}}const Je=Object.freeze(Object.defineProperty({__proto__:null,CacheNotificationService:Y},Symbol.toStringTag,{value:"Module"}));class Se{static async getEmployeesByIds(e,t=!0){if(!Array.isArray(e)||e.length===0)return[];if(t){const a=I.getEmployeesCacheKey(e),s=I.get(a);if(s!==null)return m.debug(`Cache hit for employees: ${e.length} employees`,"EmployeeRepository"),s}try{const a=await Q.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(a&&a.result&&(Array.isArray(a.result)?s=a.result:m.warn("Unexpected user.get result format","EmployeeRepository",a)),t){const n=I.getEmployeesCacheKey(e);I.set(n,s,I.EMPLOYEES_TTL)}return s}catch(a){return m.error("Error getting employees by IDs","EmployeeRepository",a),[]}}}function ee(r){return r==null?null:String(r).trim().toLowerCase()||null}const te=[{id:"general",label:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",bitrixValue:"–ì–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"–í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≥–µ–Ω–µ—Ä–∞–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)"},{id:"external",label:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",bitrixValue:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"–í–Ω–µ—à–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞/–±–ª–æ–∫–µ—Ä—ã"},{id:"board",label:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",bitrixValue:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"–ó–∞–¥–∞—á–∏ –ø—Ä–∞–≤–ª–µ–Ω–∏—è / —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤"},{id:"errors",label:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",bitrixValue:"–û—à–∏–±–∫–∏/—Å–±–æ–∏",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã, –æ—à–∏–±–∫–∏ –∏ —Å–±–æ–∏"},{id:"operations",label:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",bitrixValue:"–¢–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"},{id:"projects",label:"–ü—Ä–æ–µ–∫—Ç—ã",bitrixValue:"–ü—Ä–æ–µ–∫—Ç—ã",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"–ü—Ä–æ–µ–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏"},{id:"optimization",label:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",bitrixValue:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è"}],A={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö/–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"},Qe=A.id,re={},ae={};[...te,A].forEach(r=>{re[r.id]=r;const e=ee(r.bitrixValue);e&&(ae[e]=r)});function Ie(r){if(!r)return A;const e=String(r).trim();return re[e]||A}function G(r){const e=ee(r);if(!e)return A;const t=ae[e];return t||A}function _e(){return[...te,A].sort((r,e)=>r.order-e.order)}function se(r){if(r&&typeof r=="object"&&r.color)return{color:r.color,backgroundColor:r.backgroundColor,textColor:r.textColor};const e=Ie(r)||G(r)||A;return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor}}_e();function ne(r){return r==null?null:String(r).trim().toLowerCase()||null}const oe=[{id:"1c-accounting",label:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",bitrixValue:"1–°.–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä 1–°"},{id:"1c-tickets",label:"1–°.–¢–∞–ª–æ–Ω—ã",bitrixValue:"1–°.–¢–∞–ª–æ–Ω—ã",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"–†–∞–±–æ—Ç–∞ —Å —Ç–∞–ª–æ–Ω–∞–º–∏ 1–°"},{id:"1c-zup",label:"1–°.–ó–£–ü",bitrixValue:"1–°.–ó–£–ü",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"–ó–∞—Ä–ø–ª–∞—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º"},{id:"1c-docflow",label:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",bitrixValue:"1–°.–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç 1–°"},{id:"1c-integrations",label:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",bitrixValue:"1–°.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è 1–°"}],E={id:"unknown",label:"–ù–µ —É–∫–∞–∑–∞–Ω–æ",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö –∏–ª–∏ –Ω–µ–∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"},Ee={},ie={};[...oe,E].forEach(r=>{Ee[r.id]=r;const e=ne(r.bitrixValue);e&&(ie[e]=r)});function Te(r){const e=ne(r);if(!e)return E;const t=ie[e];return t||E}function De(){return E}function Ae(){return[...oe,E].sort((r,e)=>r.order-e.order)}function we(r){const e=r&&typeof r=="object"?r:E;return{color:e.color||E.color,backgroundColor:e.backgroundColor||E.backgroundColor,textColor:e.textColor||E.textColor}}Ae();function N(r){const e=parseInt(r.id||r.ID||0),t=r.title||r.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",a=r.stageId||r.STAGE_ID||"",s=r.assignedById||r.ASSIGNED_BY_ID||null,n=r.createdTime||r.CREATED_DATE||r.CREATED_TIME||"",o=r.updatedTime||r.MODIFY_DATE||r.UPDATED_TIME||"",c=r.UF_SUBJECT||r.uf_subject||r.ufSubject||r.UF_SUBJECT||r.uf_subject||null,i=r.UF_CRM_7_DEPARTMENT_HEAD||r.uf_crm_7_department_head||r.ufCrm7DepartmentHead||r.UF_CRM_7_DEPARTMENT_HEAD||r.uf_crm_7_department_head||null;let l=null,u=null;if(i){const R=String(i).trim();R.length>0&&(u=R,l=R.length>17?R.substring(0,17):R)}const f=r.UF_CRM_7_UF_PRIORITY||r.uf_crm_7_uf_priority||r.ufCrm7UfPriority||r.UF_CRM_7_UF_PRIORITY||r.uf_crm_7_uf_priority||r.priority||r.PRIORITY||null,d=G(f),p=se(d),g=r.UF_SLA_SERVICE_STR||r.uf_sla_service_str||r.UfSlaServiceStr||r.ufSlaServiceStr||r.service||null,y=Te(g),S=we(y),_=r.UF_ACTION_STR||r.uf_action_str||r.UfActionStr||r.ufActionStr||r.UF_ACTION_STR||r.uf_action_str||null,U=_?String(_).trim():null,de=U&&U.length>0?U:null;return{id:e,title:t,ufSubject:c,departmentHead:l,departmentHeadFull:u,priorityId:d.id,priorityLabel:d.label,priorityColors:p,priority:d.id,priorityBitrixValue:d.bitrixValue||null,service:y,serviceLabel:y.label,serviceColors:S,serviceBitrixValue:y.bitrixValue||De().bitrixValue,actionStr:de,status:Ce(),assigneeId:s?parseInt(s):null,stageId:W(a),createdAt:n,modifiedAt:o,amount:r.opportunity||r.OPPORTUNITY||0,currency:r.currencyId||r.CURRENCY_ID||"RUB",description:r.comments||r.COMMENTS||""}}function Ce(r){return"in_progress"}function Re(r){const e=fe(r);return{id:parseInt(r.ID||r.id||0),name:`${r.NAME||r.name||""} ${r.LAST_NAME||r.lastName||""}`.trim()||r.EMAIL||r.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:r.WORK_POSITION||r.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:r.EMAIL||r.email||"",sectorId:e,departmentId:r.UF_DEPARTMENT||null,tickets:[]}}function be(r){return Array.isArray(r)?r.map(e=>Re(e)):[]}const Oe="1C",Me=["1–°"],O=new Map,x=100;function ce(r){return r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||null}function V(r){return r==null?null:String(r).trim().toUpperCase().replace(/–°/g,"C")||null}function le(r){if(!r)return[];if(Array.isArray(r))return r.map(V).filter(Boolean);if(typeof r=="object"&&r.value!==void 0){const t=V(r.value);return t?[t]:[]}const e=V(r);return e?e.split(/[;,]/).map(t=>t.trim()).filter(Boolean):[]}function Z(r){const e=ce(r),t=le(e);return t.length===0?!1:t.some(a=>a===Oe||Me.includes(a))}function Ne(r){return`filter:${r.map(t=>t.id||t.ID||"").sort().join(",")}`}function ve(){O.size>x&&Array.from(O.keys()).slice(0,Math.floor(x*.2)).forEach(e=>O.delete(e))}function ke(r){if(!Array.isArray(r))return[];const e=Ne(r),t=O.get(e);if(t!==void 0)return t;const a=r.filter(Z);try{const s=k();if(s&&B()){const n=r.filter(i=>!Z(i)),o=[],c=new Set;r.forEach(i=>{const l=ce(i),u=le(l),f=l==null?"":String(l);l!=null&&!c.has(f)&&(c.add(f),o.push({value:l,normalized:u,type:typeof l,isArray:Array.isArray(l),ticketId:i.id||i.ID}))}),s.logFiltering(r.length,a.length,n,o)}}catch(s){console.warn("Diagnostics logging error in filterBySector:",s)}return O.set(e,a),ve(),a}const v=1051;function F(r){if(!r||typeof r!="object")return null;let e=r.assignedById||r.ASSIGNED_BY_ID||r.assignedByIdId||r.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function K(r){if(r==null)return null;typeof r=="object"&&(r=r.id||r.ID||r.value||null);const e=typeof r=="number"?r:parseInt(r);return isNaN(e)||e<=0?null:e}function Be(r,e=v){const t=F(r),a=K(t);return a===null||a===e}function $e(r,e){Array.isArray(r)||(m.warn("Tickets is not an array","TicketGrouper",r),r=[]),Array.isArray(e)||(m.warn("Employees is not an array","TicketGrouper",e),e=[]);const t=e.filter(i=>(i.id?parseInt(i.id):null)!==v),a=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:t.map(i=>({...i,isFromSector1C:i.sectorId===P.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:t.map(i=>({...i,isFromSector1C:i.sectorId===P.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:t.map(i=>({...i,isFromSector1C:i.sectorId===P.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(a.map(i=>[i.id,i])),n=new Map;a.forEach(i=>{const l=new Map(i.employees.map(u=>[u.id,u]));n.set(i.id,l)});const o=[],c=[];r.forEach(i=>{const l=W(i.stageId||i.STAGE_ID||""),u=s.get(l);if(!u){c.push({id:i.id||i.ID,title:i.title||i.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:i.stageId||i.STAGE_ID,assignedById:F(i)});return}const f=F(i),d=K(f);if(d!==v)if(d){const p=n.get(l);let g=p.get(d);g||(g={id:d,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${d}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},u.employees.push(g),p.set(d,g));const y=N(i),S={...y,stageId:i.stageId||i.STAGE_ID||y.stageId,departmentHead:y.departmentHead||null,departmentHeadFull:y.departmentHeadFull||y.departmentHead||null};g.tickets.push(S),g.isFromSector1C?g.ticketsInsideSector.push(S):g.ticketsOutsideSector.push(S)}else o.push({id:i.id||i.ID,title:i.title||i.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:l,assignedById:f})}),a.forEach(i=>{i.employees.sort((l,u)=>l.isFromSector1C&&!u.isFromSector1C?-1:!l.isFromSector1C&&u.isFromSector1C?1:(l.id||0)-(u.id||0))});try{const i=k();if(i&&B()){const l={};a.forEach(f=>{let d=0,p=0;f.employees.forEach(g=>{d+=(g.ticketsInsideSector||[]).length,p+=(g.ticketsOutsideSector||[]).length}),l[f.id]={insideSector:d,outsideSector:p,total:d+p}});const u=i.metrics.grouping;Object.keys(l).forEach(f=>{u.distributionByStages[f]||(u.distributionByStages[f]={employees:{},total:0}),u.distributionByStages[f].insideSector=l[f].insideSector,u.distributionByStages[f].outsideSector=l[f].outsideSector,u.distributionByStages[f].total=l[f].total}),i.logGrouping(a,o,c)}}catch(i){m.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",i)}return a}function He(r){const e={formed:[],review:[],execution:[]};if(!Array.isArray(r))return m.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",r),e;r.filter(t=>Be(t)).forEach(t=>{const a=W(t.stageId||t.STAGE_ID||"");if(e[a]){const s=N(t),n={...s,stageId:t.stageId||t.STAGE_ID||s.stageId,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null};e[a].push(n)}});try{const t=k();t&&B()&&t.logZeroPoint(e)}catch(t){m.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",t)}return e}function Fe(r){if(!Array.isArray(r))return[];const e=new Set,t=[],a=[];r.forEach(n=>{const o=F(n),c=K(o);!o||o===null||o===void 0?t.push({id:n.id||n.ID,title:n.title||n.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:n.stageId||n.STAGE_ID}):c===v&&a.push({id:n.id||n.ID,title:n.title||n.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",stageId:n.stageId||n.STAGE_ID}),c&&e.add(c)});const s=Array.from(e);try{const n=k();n&&B()&&n.logEmployees(s,t,a)}catch(n){m.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",n)}return s}const $=new Map,Ue=10*60*1e3;function Pe(r){if(!r||typeof r!="object")return{};const e={},t=Object.keys(r);for(const a of t)a.toUpperCase().startsWith("UF_")&&(e[a]=r[a]);return e}function je(r,e=null,t=!0){if(t&&e&&$.has(e)){const n=$.get(e),o=Date.now();if(n.timestamp&&o-n.timestamp<Ue)return n.data;$.delete(e)}const a=Pe(r),s={typeProduct:a.UF_CRM_7_TYPE_PRODUCT||a.uf_crm_7_type_product||a.ufCrm7TypeProduct||null,all:a};return t&&e&&$.set(e,{data:s,timestamp:Date.now()}),s}let Le=class{static async getTicketDetails(e,t={}){const{select:a=["*"],useOriginalUfNames:s=!0,useCache:n=!0}=t;try{const o=await b.getTicket(e);if(!o)throw new Error(`–¢–∏–∫–µ—Ç —Å ID ${e} –Ω–µ –Ω–∞–π–¥–µ–Ω`);const c=je(o,e,n),i=o.UF_CRM_7_UF_PRIORITY||o.uf_crm_7_uf_priority||o.ufCrm7UfPriority||o.UF_CRM_7_UF_PRIORITY||o.uf_crm_7_uf_priority||o.priority||o.PRIORITY||null,l=G(i),u=se(l);return{id:o.id||o.ID,title:o.title||o.TITLE,stageId:o.stageId||o.STAGE_ID,assignedById:o.assignedById||o.ASSIGNED_BY_ID,createdAt:o.createdTime||o.CREATED_TIME||o.CREATED_DATE,updatedAt:o.updatedTime||o.UPDATED_TIME||o.MODIFY_DATE,priorityId:l.id,priorityLabel:l.label,priorityColors:u,priority:l.id,priorityBitrixValue:l.bitrixValue||null,opportunity:o.opportunity||o.OPPORTUNITY,currencyId:o.currencyId||o.CURRENCY_ID,comments:o.comments||o.COMMENTS,additionalFields:c,rawData:o}}catch(o){throw m.error("Error getting ticket details","TicketDetailsService",o),o}}};class J{static async getSectorData(e=!0,t=!1,a=null){let s=!1;try{if(B()){const n=k();n&&n.reset()}}catch(n){m.warn("Error resetting diagnostics","DashboardSector1CService",n)}if(a&&a(h("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),t)try{a&&a(h("backend_cache_check",5,{description:"–ü—Ä–æ–≤–µ—Ä–∫–∞ backend –∫–µ—à–∞..."}));const n=await fetch("/api/services/dashboard-sector-1c.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getSectorDataCached",params:{forceRefresh:!1,ttl:600}})});if(n.ok){const o=await n.json();if(o.success&&o.data)return a&&a(h("backend_cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ backend –∫–µ—à–∞"})),o.cache_created===!0&&Y.notifyCacheCreationSuccess("–î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° (backend)"),o.data}m.warn("Backend cache miss or error, falling back to frontend logic","DashboardSector1CService")}catch(n){m.warn("Backend cache request failed, falling back to frontend logic","DashboardSector1CService",n)}if(e){const n=I.getSectorDataCacheKey(),o=I.get(n);if(o!==null)return a&&a(h("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ in-memory –∫–µ—à–∞"})),o}try{a&&a(h("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const n=he(),o=await b.getAllTickets(n,p=>{if(a){const g=pe(p),y=ge(10,40,g.progress||0);a(h(g.step||"loading_tickets",y,{...g.details,warning:g.details.warning}))}},e);a&&a(h("filtering",50,{totalTickets:o.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${o.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const c=ke(o);a&&a(h("filtering",50,{totalTickets:o.length,filteredTickets:c.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${o.length}`})),a&&a(h("extracting_employees",60,{filteredTickets:c.length,description:`–ê–Ω–∞–ª–∏–∑ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const i=Fe(c);a&&a(h("extracting_employees",60,{employeeCount:i.length,description:`–ù–∞–π–¥–µ–Ω–æ ${i.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),a&&a(h("loading_employees",65,{employeeCount:i.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${i.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`})),me();const l=await Se.getEmployeesByIds(i),u=be(l);a&&a(h("loading_employees",90,{employeeCount:u.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${u.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),a&&a(h("grouping",90,{filteredTickets:c.length,employeeCount:u.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${c.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${u.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const d={stages:$e(c,u),employees:u,zeroPointTickets:He(c)};if(a&&a(h("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),e){const p=I.getSectorDataCacheKey();I.set(p,d,I.TICKETS_TTL),s=!0}return a&&a(h("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),s&&!t&&Y.notifyCacheCreationSuccess("–î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–°"),d}catch(n){throw m.error("Error getting sector data","DashboardSector1CService",n),a&&a({step:"error",progress:0,error:n.message}),n}}static async assignTicket(e,t,a){try{const s=X(a),n=await b.assignTicket(e,t,s);return n&&I.invalidateTicketsCache(),n}catch(s){throw m.error("Error assigning ticket","DashboardSector1CService",s),s}}static async createTicket(e){try{const t=X(e.stageId||"formed"),a={title:e.title,stageId:t};e.employeeId&&(a.assignedById=e.employeeId);const s=await b.createTicket(a);return s>0&&I.invalidateTicketsCache(),s}catch(t){throw m.error("Error creating ticket","DashboardSector1CService",t),t}}static async getTicket(e){try{const t=await b.getTicket(e);return N(t)}catch(t){throw m.error("Error getting ticket","DashboardSector1CService",t),t}}static async getTicketDetails(e,t={}){try{return await Le.getTicketDetails(e,t)}catch(a){throw m.error("Error getting ticket details","DashboardSector1CService",a),a}}static async addComment(e,t){try{return(await Q.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+ye,comment:t}})).result!==void 0}catch(a){throw m.error("Error adding comment","DashboardSector1CService",a),a}}}const T={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class tt{static getApiBaseUrl(){return ue()}static async createSnapshot(e,t,a={}){try{if(!e||typeof e!="object")throw new w("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new w("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const s=this.validateSectorData(e);if(!s.isValid)throw new w(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${s.errors.join(", ")}`,"VALIDATION_ERROR",{validation:s});const n=this.normalizeSectorData(e),c={metadata:this.generateSnapshotMetadata(t,a.createdBy,a.sectorId||T.defaultSectorId),statistics:n.statistics,ticketIds:n.ticketIds,tickets:n.tickets},i=this.validateSnapshot(c);if(!i.isValid)throw new w(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",i.warnings);const l=this.getApiBaseUrl(),u=await fetch(`${l}${T.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:t,date:this.formatDate(new Date)})});if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const f=await u.json();if(!f.success)throw new Error(f.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return f.data.snapshot}catch(s){throw console.error("SnapshotService.createSnapshot error:",s),s instanceof w?s:new w(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${s.message}`,"API_ERROR",{originalError:s})}}static async getSnapshot(e,t){try{const a=this.formatDate(e),n=`${this.getApiBaseUrl()}${T.snapshotsEndpoint}?action=get&date=${a}&type=${t}`,o=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(o.status===404)return null;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const c=await o.json();if(!c.success){if(c.message&&c.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω"))return null;throw new Error(c.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",T.defaultSectorId);const s=`${this.getApiBaseUrl()}${T.snapshotsEndpoint}?${t.toString()}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();if(!o.success)throw new Error(o.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(o.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(l){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${i.date}/${i.type}:`,l),null}}))).filter(i=>i!==null).sort((i,l)=>new Date(i.metadata.createdAt)-new Date(l.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:a=[],zeroPointTickets:s={}}=e,n={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},o=[],c=[],i=[];t.forEach(f=>{const d=f.id;if(n[d]){let p=0;f.employees.forEach(g=>{const y=g.tickets||[];p+=y.length;let S=o.find(_=>_.id===g.id);S||(S={id:g.id,name:g.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},o.push(S)),y.forEach(_=>{c.push(_.id),i.push({id:_.id,title:_.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:g.id,name:g.name},createdAt:_.createdAt||"",updatedAt:_.modifiedAt||_.updatedAt||""}),S.ticketsByStage[d]=(S.ticketsByStage[d]||0)+1,S.totalTickets+=1})}),n[d].count=p}});const l={unassigned:0,keeper:0,total:0};Object.values(s).forEach(f=>{Array.isArray(f)&&f.forEach(d=>{l.total+=1,d.assigneeId===1051||d.assignedById===1051?l.keeper+=1:l.unassigned+=1,c.push(d.id),i.push({id:d.id,title:d.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const u=Object.values(n).reduce((f,d)=>f+d.count,0)+l.total;return{statistics:{stages:{...n,total:u},employees:o,zeroPoint:l},ticketIds:[...new Set(c)],tickets:i}}static generateSnapshotMetadata(e,t,a){const s=new Date,n=-s.getTimezoneOffset(),o=Math.floor(n/60),c=n%60,i=`${o>=0?"+":""}${String(o).padStart(2,"0")}:${String(c).padStart(2,"0")}`,l=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${i}`;return{version:T.snapshotVersion,createdAt:l,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:a,sectorName:a==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${a}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${s}`}static buildFilePath(e,t){const a=typeof e=="string"?new Date(e):e,s=a.getFullYear(),n=this.getWeekNumber(a),o=this.formatDate(e);let c;if(t==="current"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`current-state-${o}-${l}.json`}else if(t==="manual"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`manual-${o}-${l}.json`}else c=`${t}-${o}.json`;return t==="current"?`current/${c}`:`${s}/week-${n}/${c}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);const s=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-s)/864e5+1)/7)}static validateSnapshot(e){const t=[],a=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const s=e.statistics.stages,n=(s.formed?.count||0)+(s.review?.count||0)+(s.execution?.count||0);s.total!==n&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${n}, —É–∫–∞–∑–∞–Ω–æ ${s.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const s=e.statistics.zeroPoint,n=(s.unassigned||0)+(s.keeper||0);s.total!==n&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${n}, —É–∫–∞–∑–∞–Ω–æ ${s.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const s=new Set(e.ticketIds),n=new Set(e.tickets.map(o=>o.id));s.size!==n.size&&a.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((o,c)=>{o.id||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),o.title||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!o.assignedTo||!o.assignedTo.id)&&a.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),o.createdAt||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),o.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${c}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:a}}static validateSectorData(e){const t=[],a=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:a}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:a})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const a=this.formatDate(e),n=`${this.getApiBaseUrl()}${T.snapshotsEndpoint}`,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:t})});if(o.status===404)return!1;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const c=await o.json();if(!c.success)throw new Error(c.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let a=0;for(const s of t)try{await this.deleteSnapshot(s.metadata.createdAt.split("T")[0],s.metadata.type)&&a++}catch(n){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${s.metadata.createdAt}:`,n)}return a}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,t=T.snapshotVersion){const a=this.getSnapshotVersion(e);return a===t||a==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${a} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,a=this.getWeekNumber(t);return{year:t.getFullYear(),week:a}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,s=(t.getDay()||7)-1,n=new Date(t);return n.setDate(t.getDate()-s),n.setHours(0,0,0,0),n}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,s=7-(t.getDay()||7),n=new Date(t);return n.setDate(t.getDate()+s),n.setHours(23,59,59,999),n}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),a=this.getWeekEndDate(e),s=this.getWeekNumberInfo(e),n=await this.getAllSnapshots({startDate:t,endDate:a}),o=n.find(l=>l.metadata.type==="week_start")||null,c=n.find(l=>l.metadata.type==="week_end")||null,i=n.filter(l=>l.metadata.type==="manual");return{weekStart:o,weekEnd:c,manual:i,weekInfo:s}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof w)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),a={week_start:0,week_end:0,manual:0,current:0},s=new Map;let n=null,o=null;t.forEach(i=>{const l=i.metadata.type;a.hasOwnProperty(l)&&a[l]++;const u=this.getWeekNumberInfo(i.metadata.createdAt),f=`${u.year}-W${u.week}`;s.set(f,(s.get(f)||0)+1);const d=new Date(i.metadata.createdAt);(!n||d<new Date(n.metadata.createdAt))&&(n=i),(!o||d>new Date(o.metadata.createdAt))&&(o=i)});const c=Array.from(s.entries()).map(([i,l])=>{const[u,f]=i.split("-W");return{year:parseInt(u),week:parseInt(f),count:l}}).sort((i,l)=>i.year!==l.year?i.year-l.year:i.week-l.week);return{total:t.length,byType:a,byWeek:c,oldest:n,newest:o}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class w extends Error{constructor(e,t,a={}){super(e),this.name="SnapshotError",this.code=t,this.details=a}}const D={formed:{bitrixId:L.formed,name:j.FORMED.name},review:{bitrixId:L.review,name:j.REVIEW.name},execution:{bitrixId:L.execution,name:j.EXECUTION.name}},M=v;function Ve(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=ze(r.stages),t=Ye(r.stages),a=We(r.zeroPointTickets||{}),s=Ge(r.zeroPointTickets||{}),n=Ke(r.stages,r.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:a,zeroPointByStage:s},ticketIds:n.ticketIds,tickets:n.tickets}}function ze(r){const e={formed:{count:0,stageId:D.formed.bitrixId,stageName:D.formed.name},review:{count:0,stageId:D.review.bitrixId,stageName:D.review.name},execution:{count:0,stageId:D.execution.bitrixId,stageName:D.execution.name},total:0};return r.forEach(t=>{if(!D[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let a=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(s=>{s.tickets&&Array.isArray(s.tickets)&&(a+=s.tickets.length)}),e[t.id].count=a,e.total+=a}),e}function Ye(r){const e=new Map;return r.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(a=>{if(!a||!a.id)return;e.has(a.id)||e.set(a.id,{id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const s=e.get(a.id),n=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;D[t.id]&&(s.ticketsByStage[t.id]=(s.ticketsByStage[t.id]||0)+n),s.totalTickets+=n})}),Array.from(e.values())}function We(r){let e=0,t=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?e++:(typeof n=="object"?n.id:n)===M?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function Ge(r){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(e).forEach(t=>{const a=r[t];Array.isArray(a)&&a.forEach(s=>{if(!s)return;const n=s.assignedTo||s.assignedById;!n||n===null?e[t].unassigned++:(typeof n=="object"?n.id:n)===M?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function Ke(r,e){const t=new Set,a=new Map;return Array.isArray(r)&&r.forEach(s=>{!s.employees||!Array.isArray(s.employees)||s.employees.forEach(n=>{!n.tickets||!Array.isArray(n.tickets)||n.tickets.forEach(o=>{if(!o||!o.id){console.warn("Ticket without ID found:",o);return}const c=parseInt(o.id);if(isNaN(c)){console.warn("Invalid ticket ID:",o.id);return}t.add(c);let i=o.assignedTo;!i&&n.id&&(i={id:n.id,name:n.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${n.id}`}),a.set(c,{id:c,title:o.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:i||null,createdAt:H(o.createdAt||o.createdTime),updatedAt:H(o.updatedAt||o.modifiedAt||o.updatedTime),stageId:o.stageId||s.id||null,departmentHead:o.departmentHead||null,departmentHeadFull:o.departmentHeadFull||o.departmentHead||null,priorityId:o.priorityId||null,priorityLabel:o.priorityLabel||null,service:o.service||null,serviceLabel:o.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(s=>{Array.isArray(s)&&s.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found in zero point:",n);return}const o=parseInt(n.id);if(isNaN(o)){console.warn("Invalid ticket ID in zero point:",n.id);return}t.add(o);let c=n.assignedTo;if(!c&&n.assignedById){const i=typeof n.assignedById=="object"?n.assignedById.id||n.assignedById.value:n.assignedById;i&&i!==M?c={id:i,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:i===M&&(c={id:M,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}a.set(o,{id:o,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:c||null,createdAt:H(n.createdAt||n.createdTime),updatedAt:H(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})}),{ticketIds:Array.from(t).sort((s,n)=>s-n),tickets:Array.from(a.values())}}function H(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const e=new Date(r);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",r),null}class rt{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,useBackendCache:a=!1,onProgress:s=null,normalize:n=!0,includeTicketDetails:o=!1}=e;try{const c=await J.getSectorData(t,a,s);return n?Ve(c):(o&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),c)}catch(c){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",c),c}}static async isDataAvailable(){try{const e=await J.getSectorData(!0);return e!=null}catch{return!1}}}const z=140,C=new Map;class at{static async getTicketDetails(e){if(!e)return console.warn("Ticket ID is required"),null;try{const t=await q.call("crm.item.list",{entityTypeId:z,filter:{id:e},select:["*"],useOriginalUfNames:"Y"});let a=[];if(t&&t.result&&(Array.isArray(t.result)?a=t.result:t.result.items&&Array.isArray(t.result.items)?a=t.result.items:t.result.data&&Array.isArray(t.result.data)&&(a=t.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${e} not found`),null;const s=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s),ticketSample:JSON.stringify(s).substring(0,500)});const n=N(s),o=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:o,mappedDepartmentHead:n.departmentHead,departmentHeadFull:o?String(o).trim():null});let c=null;if(o){const i=String(o).trim();i.length>0&&(c=i)}return{...n,departmentHeadFull:c}}catch(t){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${e}:`,t),console.error("[TicketDetailsService] Error details:",{message:t.message,stack:t.stack,ticketId:e}),null}}static async getTicketsDetails(e){if(!e||!Array.isArray(e)||e.length===0)return[];const t=[],a=[];if(e.forEach(s=>{C.has(s)?t.push(C.get(s)):a.push(s)}),a.length===0)return t;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:z});const s=await q.call("crm.item.list",{entityTypeId:z,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!s,resultType:typeof s,resultKeys:s?Object.keys(s):[],hasResultResult:!!s?.result,resultResultType:typeof s?.result,isArray:Array.isArray(s?.result),resultResultLength:Array.isArray(s?.result)?s.result.length:"not array",fullResult:s});let n=[];if(s&&s.result&&(Array.isArray(s.result)?n=s.result:s.result.items&&Array.isArray(s.result.items)?n=s.result.items:s.result.data&&Array.isArray(s.result.data)&&(n=s.result.data)),!n||n.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!s,hasResultResult:!!s?.result,resultType:typeof s?.result,result:s,resultKeys:s?Object.keys(s):[]}),t;const o=n.map((c,i)=>{i===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const l=N(c);i===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:l.id,hasDepartmentHead:!!l.departmentHead,departmentHead:l.departmentHead,mappedTicketKeys:Object.keys(l).filter(p=>p.toLowerCase().includes("department"))});const u=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;i===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:u,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(p=>p.toLowerCase().includes("department")||p.toLowerCase().includes("uf_crm"))});let f=null;if(u){const p=String(u).trim();p.length>0&&(f=p)}!f&&l.departmentHead&&(f=l.departmentHead);const d={...l,departmentHeadFull:f||l.departmentHead||null};return i===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&C.set(d.id,d),d});return[...t,...o]}catch(s){return console.error("[TicketDetailsService] Error loading tickets details batch:",s),console.error("[TicketDetailsService] Error details:",{message:s.message,stack:s.stack,ticketIdsCount:e.length,ticketIdsSample:e.slice(0,5)}),t}}static clearCache(e=1e3){C.size>e&&C.clear()}static getCacheSize(){return C.size}}export{Y as C,J as D,tt as S,at as T,rt as a,De as b,we as c,G as d,Ie as e,Qe as f,se as g,Je as h};
