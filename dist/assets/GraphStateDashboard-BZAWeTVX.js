import{_ as Ie,a as A,o as D,b as c,F as ce,e as ue,n as ne,l as ye,t as x,g as F,c as ee,G as Ve,m as Pe,f as Ae,d as Z,j as de,k as Te,H as Ze,i as oe,y as et,B as at,T as Mt,I as Ut,u as st,J as Le,K as Qe,p as lt,L as ut,x as Jt,M as Zt,N as Wt,C as zt,O as ct,D as Qt,P as ea,Q as ta,R as We,z as aa,r as sa}from"./main-Cid8sZc2.js";import{L as Ft,D as na,B as oa}from"./index-Bi9f8zhJ.js";import{S as dt,d as pt,K as la,D as Rt,B as ft,m as Lt,e as Ke,f as ge,h as xt,j as Vt,k as ra,l as ia,o as ca,T as Ht,p as ua,q as Pt}from"./index-PBFfHW8P.js";const Ce={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class _e{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new xe("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new xe("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const n=this.validateSectorData(t);if(!n.isValid)throw new xe(`Ошибка валидации данных сектора: ${n.errors.join(", ")}`,"VALIDATION_ERROR",{validation:n});const o=this.normalizeSectorData(t),u={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||Ce.defaultSectorId),statistics:o.statistics,ticketIds:o.ticketIds,tickets:o.tickets},i=this.validateSnapshot(u);if(!i.isValid)throw new xe(`Ошибка валидации слепка: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",i.warnings);const r=this.getApiBaseUrl(),p=await fetch(`${r}${Ce.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:u,type:e,date:this.formatDate(new Date)})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const g=await p.json();if(!g.success)throw new Error(g.message||"Ошибка создания слепка");return g.data.snapshot}catch(n){throw console.error("SnapshotService.createSnapshot error:",n),n instanceof xe?n:new xe(`Ошибка создания слепка: ${n.message}`,"API_ERROR",{originalError:n})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),o=`${this.getApiBaseUrl()}${Ce.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,l=await fetch(o,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(l.status===404)return null;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const u=await l.json();if(!u.success){if(u.message&&u.message.includes("не найден"))return null;throw new Error(u.message||"Ошибка получения слепка")}return u.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ce.defaultSectorId);const n=`${this.getApiBaseUrl()}${Ce.snapshotsEndpoint}?${e.toString()}`,o=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const l=await o.json();if(!l.success)throw new Error(l.message||"Ошибка получения списка слепков");return(await Promise.all(l.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(r){return console.warn(`Ошибка загрузки слепка ${i.date}/${i.type}:`,r),null}}))).filter(i=>i!==null).sort((i,r)=>new Date(i.metadata.createdAt)-new Date(r.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:n={}}=t,o={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},l=[],u=[],i=[];e.forEach(g=>{const d=g.id;if(o[d]){let v=0;g.employees.forEach(h=>{const k=h.tickets||[];v+=k.length;let S=l.find(E=>E.id===h.id);S||(S={id:h.id,name:h.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},l.push(S)),k.forEach(E=>{u.push(E.id),i.push({id:E.id,title:E.title||"Без названия",assignedTo:{id:h.id,name:h.name},createdAt:E.createdAt||"",updatedAt:E.modifiedAt||E.updatedAt||""}),S.ticketsByStage[d]=(S.ticketsByStage[d]||0)+1,S.totalTickets+=1})}),o[d].count=v}});const r={unassigned:0,keeper:0,total:0};Object.values(n).forEach(g=>{Array.isArray(g)&&g.forEach(d=>{r.total+=1,d.assigneeId===1051||d.assignedById===1051?r.keeper+=1:r.unassigned+=1,u.push(d.id),i.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const p=Object.values(o).reduce((g,d)=>g+d.count,0)+r.total;return{statistics:{stages:{...o,total:p},employees:l,zeroPoint:r},ticketIds:[...new Set(u)],tickets:i}}static generateSnapshotMetadata(t,e,a){const n=new Date,o=-n.getTimezoneOffset(),l=Math.floor(o/60),u=o%60,i=`${l>=0?"+":""}${String(l).padStart(2,"0")}:${String(u).padStart(2,"0")}`,r=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}${i}`;return{version:Ce.snapshotVersion,createdAt:r,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${n}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,n=a.getFullYear(),o=this.getWeekNumber(a),l=this.formatDate(t);let u;if(e==="current"){const i=new Date,r=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;u=`current-state-${l}-${r}.json`}else if(e==="manual"){const i=new Date,r=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;u=`manual-${l}-${r}.json`}else u=`${e}-${l}.json`;return e==="current"?`current/${u}`:`${n}/week-${o}/${u}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-n)/864e5+1)/7)}static validateSnapshot(t){var n,o,l;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const u=t.statistics.stages,i=(((n=u.formed)==null?void 0:n.count)||0)+(((o=u.review)==null?void 0:o.count)||0)+(((l=u.execution)==null?void 0:l.count)||0);u.total!==i&&a.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${u.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const u=t.statistics.zeroPoint,i=(u.unassigned||0)+(u.keeper||0);u.total!==i&&a.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${u.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const u=new Set(t.ticketIds),i=new Set(t.tickets.map(r=>r.id));u.size!==i.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((r,p)=>{r.id||e.push(`Тикет #${p}: отсутствует ID`),r.title||e.push(`Тикет #${p}: отсутствует заголовок`),(!r.assignedTo||!r.assignedTo.id)&&a.push(`Тикет #${p}: отсутствует ответственный (может быть в нулевой точке)`),r.createdAt||e.push(`Тикет #${p}: отсутствует дата создания`),r.updatedAt||e.push(`Тикет #${p}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),o=`${this.getApiBaseUrl()}${Ce.snapshotsEndpoint}`,l=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(l.status===404)return!1;if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const u=await l.json();if(!u.success)throw new Error(u.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const n of e)try{await this.deleteSnapshot(n.metadata.createdAt.split("T")[0],n.metadata.type)&&a++}catch(o){console.warn(`Ошибка удаления слепка ${n.metadata.createdAt}:`,o)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ce.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,n=(e.getDay()||7)-1,o=new Date(e);return o.setDate(e.getDate()-n),o.setHours(0,0,0,0),o}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,n=7-(e.getDay()||7),o=new Date(e);return o.setDate(e.getDate()+n),o.setHours(23,59,59,999),o}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),n=this.getWeekNumberInfo(t),o=await this.getAllSnapshots({startDate:e,endDate:a}),l=o.find(r=>r.metadata.type==="week_start")||null,u=o.find(r=>r.metadata.type==="week_end")||null,i=o.filter(r=>r.metadata.type==="manual");return{weekStart:l,weekEnd:u,manual:i,weekInfo:n}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof xe)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},n=new Map;let o=null,l=null;e.forEach(i=>{const r=i.metadata.type;a.hasOwnProperty(r)&&a[r]++;const p=this.getWeekNumberInfo(i.metadata.createdAt),g=`${p.year}-W${p.week}`;n.set(g,(n.get(g)||0)+1);const d=new Date(i.metadata.createdAt);(!o||d<new Date(o.metadata.createdAt))&&(o=i),(!l||d>new Date(l.metadata.createdAt))&&(l=i)});const u=Array.from(n.entries()).map(([i,r])=>{const[p,g]=i.split("-W");return{year:parseInt(p),week:parseInt(g),count:r}}).sort((i,r)=>i.year!==r.year?i.year-r.year:i.week-r.week);return{total:e.length,byType:a,byWeek:u,oldest:o,newest:l}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class xe extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const De={formed:{bitrixId:pt.formed,name:dt.FORMED.name},review:{bitrixId:pt.review,name:dt.REVIEW.name},execution:{bitrixId:pt.execution,name:dt.EXECUTION.name}},tt=la;function da(s){if(!s||typeof s!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!s.stages||!Array.isArray(s.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=pa(s.stages),e=ga(s.stages),a=ma(s.zeroPointTickets||{}),n=fa(s.zeroPointTickets||{}),o=ha(s.stages,s.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:n},ticketIds:o.ticketIds,tickets:o.tickets}}function pa(s){const t={formed:{count:0,stageId:De.formed.bitrixId,stageName:De.formed.name},review:{count:0,stageId:De.review.bitrixId,stageName:De.review.name},execution:{count:0,stageId:De.execution.bitrixId,stageName:De.execution.name},total:0};return s.forEach(e=>{if(!De[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(n=>{n.tickets&&Array.isArray(n.tickets)&&(a+=n.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function ga(s){const t=new Map;return s.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const n=t.get(a.id),o=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;De[e.id]&&(n.ticketsByStage[e.id]=(n.ticketsByStage[e.id]||0)+o),n.totalTickets+=o})}),Array.from(t.values())}function ma(s){let t=0,e=0;return!s||typeof s!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(s).forEach(a=>{Array.isArray(a)&&a.forEach(n=>{if(!n)return;const o=n.assignedTo||n.assignedById;!o||o===null?t++:(typeof o=="object"?o.id:o)===tt?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function fa(s){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!s||typeof s!="object"||Object.keys(t).forEach(e=>{const a=s[e];Array.isArray(a)&&a.forEach(n=>{if(!n)return;const o=n.assignedTo||n.assignedById;!o||o===null?t[e].unassigned++:(typeof o=="object"?o.id:o)===tt?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function ha(s,t){const e=new Set,a=new Map;return Array.isArray(s)&&s.forEach(n=>{!n.employees||!Array.isArray(n.employees)||n.employees.forEach(o=>{!o.tickets||!Array.isArray(o.tickets)||o.tickets.forEach(l=>{if(!l||!l.id){console.warn("Ticket without ID found:",l);return}const u=parseInt(l.id);if(isNaN(u)){console.warn("Invalid ticket ID:",l.id);return}e.add(u);let i=l.assignedTo;!i&&o.id&&(i={id:o.id,name:o.name||`Сотрудник #${o.id}`}),a.set(u,{id:u,title:l.title||"Без названия",assignedTo:i||null,createdAt:ot(l.createdAt||l.createdTime),updatedAt:ot(l.updatedAt||l.modifiedAt||l.updatedTime),stageId:l.stageId||n.id||null,departmentHead:l.departmentHead||null,departmentHeadFull:l.departmentHeadFull||l.departmentHead||null,priorityId:l.priorityId||null,priorityLabel:l.priorityLabel||null,service:l.service||null,serviceLabel:l.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(n=>{Array.isArray(n)&&n.forEach(o=>{if(!o||!o.id){console.warn("Ticket without ID found in zero point:",o);return}const l=parseInt(o.id);if(isNaN(l)){console.warn("Invalid ticket ID in zero point:",o.id);return}e.add(l);let u=o.assignedTo;if(!u&&o.assignedById){const i=typeof o.assignedById=="object"?o.assignedById.id||o.assignedById.value:o.assignedById;i&&i!==tt?u={id:i,name:"Неизвестный"}:i===tt&&(u={id:tt,name:"Хранитель объектов"})}a.set(l,{id:l,title:o.title||"Без названия",assignedTo:u||null,createdAt:ot(o.createdAt||o.createdTime),updatedAt:ot(o.updatedAt||o.modifiedAt||o.updatedTime),stageId:o.stageId||null,departmentHead:o.departmentHead||null,departmentHeadFull:o.departmentHeadFull||o.departmentHead||null,priorityId:o.priorityId||null,priorityLabel:o.priorityLabel||null,service:o.service||null,serviceLabel:o.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((n,o)=>n-o),tickets:Array.from(a.values())}}function ot(s){if(!s)return null;if(s instanceof Date)return s.toISOString();if(typeof s=="string"){if(s.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return s;const t=new Date(s);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",s),null}class ht{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:n=!0,includeTicketDetails:o=!1}=t;try{const l=await Rt.getSectorData(e,a);return n?da(l):(o&&console.warn("includeTicketDetails пока не реализовано"),l)}catch(l){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",l),l}}static async isDataAvailable(){try{const t=await Rt.getSectorData(!0);return t!=null}catch{return!1}}}class gt{static compareTwoSnapshots(t,e,a={}){const{includeTickets:n=!1,includeEmployees:o=!0}=a,l=this.validateSnapshot(t),u=this.validateSnapshot(e);if(!l.valid||!u.valid)throw new Error("Invalid snapshot structure: "+[...l.errors,...u.errors].join(", "));const i=this.buildComparisonMetadata(t,e),r=this.compareStages(t.statistics.stages,e.statistics.stages),p=o?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],g=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=n?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,v=this.buildSummary(r,p,g,d);return{metadata:i,stages:r,employees:p,zeroPoint:g,tickets:d,summary:v}}static calculateDelta(t,e){const a=this.normalizeValue(t),n=this.normalizeValue(e),o=n-a;let l=0;a!==0?l=o/a*100:n!==0&&(l=n>0?1/0:-1/0);const u=this.getTrend(o);return{value1:a,value2:n,delta:o,deltaPercent:Math.round(l*100)/100,trend:u}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var u,i;const a=["formed","review","execution"],n={};for(const r of a){const p=((u=t[r])==null?void 0:u.count)||0,g=((i=e[r])==null?void 0:i.count)||0;n[r]=this.calculateDelta(p,g)}const o=t.total||0,l=e.total||0;return n.total=this.calculateDelta(o,l),n}static compareEmployees(t,e){var u,i;const a=new Map(t.map(r=>[r.id,r])),n=new Map(e.map(r=>[r.id,r])),o=new Set([...a.keys(),...n.keys()]),l=[];for(const r of o){const p=a.get(r)||null,g=n.get(r)||null;if(!p||!g){l.push({id:r,name:(p==null?void 0:p.name)||(g==null?void 0:g.name)||"Неизвестный",snapshot1:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(p,g),trend:p?"removed":"new"});continue}const d={},v=["formed","review","execution"];for(const k of v){const S=((u=p.ticketsByStage)==null?void 0:u[k])||0,E=((i=g.ticketsByStage)==null?void 0:i[k])||0;d[k]=this.calculateDelta(S,E)}const h=this.calculateDelta(p.totalTickets||0,g.totalTickets||0);l.push({id:r,name:p.name,snapshot1:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:d,totalTickets:h},trend:h.trend})}return l}static calculateEmployeeDelta(t,e){var l,u;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},n=["formed","review","execution"];for(const i of n){const r=((l=t==null?void 0:t.ticketsByStage)==null?void 0:l[i])||0,p=((u=e==null?void 0:e.ticketsByStage)==null?void 0:u[i])||0;a[i]=this.calculateDelta(r,p)}const o=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:o}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,n){var v,h;const o=new Set(t),l=new Set(e),u=e.filter(k=>!o.has(k)),i=t.filter(k=>!l.has(k)),r=[],p=[],g=new Map(a.map(k=>[k.id,k])),d=new Map(n.map(k=>[k.id,k]));for(const k of t){if(!l.has(k))continue;const S=g.get(k),E=d.get(k);if(!S||!E)continue;const $=(((v=S.assignedTo)==null?void 0:v.id)||null)!==(((h=E.assignedTo)==null?void 0:h.id)||null),H=(S.stageId||null)!==(E.stageId||null);$||H?r.push(k):p.push(k)}return{new:u,removed:i,changed:r,unchanged:p}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),n=new Date(e.metadata.createdAt),o=new Date,l=n.getTime()-a.getTime(),u=Math.floor(l/(1e3*60*60*24)),i=Math.floor(l%(1e3*60*60*24)/(1e3*60*60)),r=Math.floor(l%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:o.toISOString(),timeDiff:{days:u,hours:i,minutes:r,totalMinutes:Math.floor(l/(1e3*60))}}}static buildSummary(t,e,a,n){var r,p,g;const o=t.total.delta,l=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,u=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,i=o!==0||l>0||u>0;return{totalDelta:o,stagesChanged:l,employeesChanged:u,hasChanges:i,newTicketsCount:((r=n==null?void 0:n.new)==null?void 0:r.length)||0,removedTicketsCount:((p=n==null?void 0:n.removed)==null?void 0:p.length)||0,changedTicketsCount:((g=n==null?void 0:n.changed)==null?void 0:g.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const n=["formed","review","execution"];for(const o of n)t.statistics.stages[o]||a.push(`Missing stage: ${o}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const l of t){const u=this.validateSnapshot(l);if(!u.valid)throw new Error("Invalid snapshot: "+u.errors.join(", "))}const a=[...t].sort((l,u)=>{const i=new Date(l.metadata.createdAt),r=new Date(u.metadata.createdAt);return i-r}),n=[];for(let l=0;l<a.length-1;l++)n.push({from:l,to:l+1,result:this.compareTwoSnapshots(a[l],a[l+1],e)});const o=this.buildTrends(a);return{snapshots:a.map((l,u)=>({index:u,date:l.metadata.createdAt,type:l.metadata.type,data:l})),comparisons:n,trends:o}}static buildTrends(t){var a,n,o,l,u,i,r,p,g,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const v of t){const h=v.statistics;e.stages.formed.push(((n=(a=h.stages)==null?void 0:a.formed)==null?void 0:n.count)||0),e.stages.review.push(((l=(o=h.stages)==null?void 0:o.review)==null?void 0:l.count)||0),e.stages.execution.push(((i=(u=h.stages)==null?void 0:u.execution)==null?void 0:i.count)||0),e.stages.total.push(((r=h.stages)==null?void 0:r.total)||0),e.zeroPoint.unassigned.push(((p=h.zeroPoint)==null?void 0:p.unassigned)||0),e.zeroPoint.keeper.push(((g=h.zeroPoint)==null?void 0:g.keeper)||0),e.zeroPoint.total.push(((d=h.zeroPoint)==null?void 0:d.total)||0)}return e}}const ya={class:"stages-container"},va={class:"stages-chips"},ka=["checked","disabled","onChange"],ba={class:"stage-chip-label"},wa={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:s=>s.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(s,{emit:t}){const e=s,a=t;function n(o,l){const u={...e.selected};u[o]=l,a("update:selected",u),a("change",o,l)}return(o,l)=>(D(),A("div",ya,[l[0]||(l[0]=c("h4",{class:"stages-title"},"Этапы для отображения:",-1)),c("div",va,[(D(!0),A(ce,null,ue(s.stages,u=>(D(),A("label",{key:u.id,class:ne(["stage-chip",{"stage-chip--active":s.selected[u.id],"stage-chip--disabled":s.disabled}])},[c("input",{type:"checkbox",checked:s.selected[u.id],disabled:s.disabled,onChange:i=>n(u.id,i.target.checked)},null,40,ka),c("span",{class:"stage-chip-color",style:ye({backgroundColor:u.color})},null,4),c("span",ba,x(u.name),1)],2))),128))])]))}},Sa=Ie(wa,[["__scopeId","data-v-fe03c03c"]]),mt=140,ze=new Map;class yt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await ft.call("crm.item.list",{entityTypeId:mt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let a=[];if(e&&e.result&&(Array.isArray(e.result)?a=e.result:e.result.items&&Array.isArray(e.result.items)?a=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(a=e.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const n=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:n.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!n.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:n.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(n),ticketSample:JSON.stringify(n).substring(0,500)});const o=Lt(n),l=n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:l,mappedDepartmentHead:o.departmentHead,departmentHeadFull:l?String(l).trim():null});let u=null;if(l){const i=String(l).trim();i.length>0&&(u=i)}return{...o,departmentHeadFull:u}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(n=>{ze.has(n)?e.push(ze.get(n)):a.push(n)}),a.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:mt});const n=await ft.call("crm.item.list",{entityTypeId:mt,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!n,resultType:typeof n,resultKeys:n?Object.keys(n):[],hasResultResult:!!(n!=null&&n.result),resultResultType:typeof(n==null?void 0:n.result),isArray:Array.isArray(n==null?void 0:n.result),resultResultLength:Array.isArray(n==null?void 0:n.result)?n.result.length:"not array",fullResult:n});let o=[];if(n&&n.result&&(Array.isArray(n.result)?o=n.result:n.result.items&&Array.isArray(n.result.items)?o=n.result.items:n.result.data&&Array.isArray(n.result.data)&&(o=n.result.data)),!o||o.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!n,hasResultResult:!!(n!=null&&n.result),resultType:typeof(n==null?void 0:n.result),result:n,resultKeys:n?Object.keys(n):[]}),e;const l=o.map((u,i)=>{i===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:u.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!u.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:u.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(u).filter(v=>v.toLowerCase().includes("department")||v.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(u).slice(0,20)});const r=Lt(u);i===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:r.id,hasDepartmentHead:!!r.departmentHead,departmentHead:r.departmentHead,mappedTicketKeys:Object.keys(r).filter(v=>v.toLowerCase().includes("department"))});const p=u.UF_CRM_7_DEPARTMENT_HEAD||u.uf_crm_7_department_head||u.ufCrm7DepartmentHead||u.UF_CRM_7_DEPARTMENT_HEAD||u.uf_crm_7_department_head||u.ufCrm7DepartmentHead||null;i===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:p,hasUF_CRM_7_DEPARTMENT_HEAD:!!u.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(u).filter(v=>v.toLowerCase().includes("department")||v.toLowerCase().includes("uf_crm"))});let g=null;if(p){const v=String(p).trim();v.length>0&&(g=v)}!g&&r.departmentHead&&(g=r.departmentHead);const d={...r,departmentHeadFull:g||r.departmentHead||null};return i===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&ze.set(d.id,d),d});return[...e,...l]}catch(n){return console.error("[TicketDetailsService] Error loading tickets details batch:",n),console.error("[TicketDetailsService] Error details:",{message:n.message,stack:n.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){ze.size>t&&ze.clear()}static getCacheSize(){return ze.size}}async function Kt(s,t,e,a=null){var r;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:s,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((r=e==null?void 0:e.tickets)==null?void 0:r.length)||0}),!s||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const n=e.tickets.filter(p=>{const g=p.assignedTo;return g?(typeof g=="object"?g.id:g)===s:!1});if(n.length===0)return[];const o=!n[0].stageId||!n[0].departmentHead;let l=null;if(o){const p=n.map(g=>g.id);if(a&&typeof a=="object")l=a;else try{const g=await yt.getTicketsDetails(p);l=new Map,g.forEach(d=>{d&&d.id&&l.set(d.id,d)})}catch(g){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",g),l=null}}return n.map(p=>{const g=p.id,d={id:g,title:p.title||"Без названия",assignedTo:p.assignedTo,createdAt:p.createdAt,updatedAt:p.updatedAt};if(l){const v=l instanceof Map?l.get(g):l[g];v?(d.stageId=v.stageId||null,d.departmentHead=v.departmentHead||null,d.departmentHeadFull=v.departmentHeadFull||v.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=p.stageId||null,d.departmentHead=p.departmentHead||null,d.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null;return d}).filter(p=>p.stageId?Ke(p.stageId)===t:!0)}function Ot(s,t=new Date){if(!s||s.length===0)return[];const e=s.length,a={};return Object.values(ge).forEach(o=>{a[o]={category:o,label:xt[o].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:xt[o].color}}),s.forEach(o=>{if(!o.createdAt){a[ge.MORE_THAN_YEAR].count++,a[ge.MORE_THAN_YEAR].tickets.push(o);return}const l=Vt(o.createdAt,t);a[l]&&(a[l].count++,a[l].tickets.push(o))}),Object.values(a).filter(o=>o.count>0).map(o=>{const l=e>0?parseFloat((o.count/e*100).toFixed(1)):0;return{...o,percentage:l,progressBarWidth:l}}).sort((o,l)=>{const u=[ge.TODAY,ge.YESTERDAY,ge.THIS_WEEK,ge.LAST_WEEK,ge.MORE_THAN_TWO_WEEKS,ge.UP_TO_ONE_MONTH,ge.MORE_THAN_TWO_MONTHS,ge.MORE_THAN_HALF_YEAR,ge.MORE_THAN_YEAR];return u.indexOf(o.category)-u.indexOf(l.category)})}function Bt(s){if(!s||s.length===0)return[];const t={};s.forEach(a=>{let n=a.departmentHeadFull||a.departmentHead;s.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(o=>o.toLowerCase().includes("department"))}),n?(n=String(n).trim(),n.length===0&&(n="Без заказчика")):n="Без заказчика",t[n]||(t[n]={departmentName:n,count:0}),t[n].count++});const e=Object.values(t);return e.sort((a,n)=>n.count!==a.count?n.count-a.count:a.departmentName.localeCompare(n.departmentName,"ru")),e}function Ea(s,t){return{sourceLevel:2,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Ca(s,t){if(!s||!t)return{sourceLevel:2,employeeId:(s==null?void 0:s.employeeId)||null,employeeName:(s==null?void 0:s.employeeName)||null,stageId:(s==null?void 0:s.stageId)||null,stageName:(s==null?void 0:s.stageName)||null,dateCategory:null,dateCategoryLabel:null,departmentName:(t==null?void 0:t.departmentName)||null,tickets:[],snapshot:(s==null?void 0:s.snapshot)||null,ticketDetails:(s==null?void 0:s.ticketDetails)||null};const e=Oe(s.tickets||[],t.departmentName);return{sourceLevel:2,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:e,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}async function Da(s,t){const e=await Kt(s.employeeId,s.stageId,s.snapshot,s.ticketDetails),a=Yt(e,s.dateCategory),n=Oe(a,t.departmentName);return{sourceLevel:3,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:s.dateCategory,dateCategoryLabel:s.dateCategoryLabel,departmentName:t.departmentName,tickets:n,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function _a(s,t){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:s.stageId,stageName:s.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Ta(s,t){var n;const e=(((n=s.snapshot)==null?void 0:n.tickets)||[]).filter(o=>o.stageId?Ke(o.stageId)===s.stageId:!1),a=Oe(e,t.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:s.stageId,stageName:s.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:a,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Aa(s,t){return!s||s.length===0?[]:s.filter(e=>e.stageId?Ke(e.stageId)===t:!1)}function Ia(s,t){return!s||s.length===0?[]:s.filter(e=>{const a=e.assignedTo;return a?(typeof a=="object"?a.id:a)===t:!1})}function Yt(s,t){if(!s||s.length===0)return[];const e=new Date;return s.filter(a=>a.createdAt?Vt(a.createdAt,e)===t:t===ge.MORE_THAN_YEAR)}function Oe(s,t){return!s||s.length===0?[]:s.filter(e=>{let a=e.departmentHeadFull||e.departmentHead;return a?(a=String(a).trim(),a.length===0&&(a="Без заказчика")):a="Без заказчика",a===t})}async function $a(s){var u;if(!s||!s.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(s.tickets&&s.tickets.length>0){let i=s.tickets;return s.departmentName&&(i=Oe(i,s.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:s.tickets.length,filteredCount:i.length,departmentFilter:s.departmentName}),i}const{snapshot:t,stageId:e,employeeId:a,dateCategory:n,departmentName:o}=s;let l=t.tickets||[];return e&&(l=Aa(l,e)),a&&(l=Ia(l,a)),n&&(l=Yt(l,n)),o&&(l=Oe(l,o)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:((u=t.tickets)==null?void 0:u.length)||0,filteredCount:l.length,filters:{stageId:e,employeeId:a,dateCategory:n,departmentName:o}}),l}function Na(s){return s?s==="review"||s==="execution"?"in_progress":s==="done"||s==="closed"?"done":"new":"new"}function Ma(s){return s.filter(t=>{const e=!t.ufSubject||t.ufSubject==="",a=t.actionStr===null||t.actionStr===void 0,n=!t.description||t.description==="";return e||a||n})}function Fa(s){const t=new Map;return s&&(Array.isArray(s)?s.forEach(e=>{e&&e.id&&t.set(e.id,e)}):typeof s=="object"&&Object.keys(s).forEach(e=>{const a=s[e];a&&a.id&&t.set(a.id,a)})),t}function Ra(s,t){var p;const e=t.get(s.id)||null,a={id:s.id,title:s.title||"Без названия",createdAt:s.createdAt||s.createdTime||"",updatedAt:s.updatedAt||s.updatedTime||s.modifiedAt||""};a.ufSubject=(e==null?void 0:e.ufSubject)||s.ufSubject||null;const n=(e==null?void 0:e.priorityId)||s.priorityId||"unknown",o=(e==null?void 0:e.priorityLabel)||s.priorityLabel||"Не указано",l=ra(n);a.priorityId=n,a.priorityLabel=o,a.priorityColors=l,a.priority=n;const u=(e==null?void 0:e.service)||s.service||ia(),i=(e==null?void 0:e.serviceLabel)||s.serviceLabel||u.label||"Не указано",r=ca(u);return a.service=u,a.serviceLabel=i,a.serviceColors=r,a.actionStr=(e==null?void 0:e.actionStr)||s.actionStr||s.ufActionStr||null,a.ufActionStr=a.actionStr,a.departmentHead=(e==null?void 0:e.departmentHead)||s.departmentHead||null,a.departmentHeadFull=(e==null?void 0:e.departmentHeadFull)||s.departmentHeadFull||s.departmentHead||null,a.description=(e==null?void 0:e.description)||s.description||s.comments||"",a.assignedTo=s.assignedTo||null,a.assigneeId=s.assigneeId||((p=s.assignedTo)==null?void 0:p.id)||null,a.stageId=s.stageId||null,!a.status&&a.stageId?a.status=Na(a.stageId):a.status=s.status||"new",a}async function La(s,t=null,e=null){if(console.time("[Performance] prepareTicketsForDisplay"),!s||s.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const a=Ma(s);console.log("[ticketListUtils] Tickets needing details:",{total:s.length,needingDetails:a.length,alreadyHaveDetails:s.length-a.length});let n=e||null;if(a.length>0&&!e){const u=a.map(i=>i.id).filter(i=>i);if(u.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:u.length,ticketIdsSample:u.slice(0,5)}),n=await yt.getTicketsDetails(u),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:(n==null?void 0:n.length)||0,sampleTicket:n!=null&&n[0]?{id:n[0].id,hasUfSubject:!!n[0].ufSubject,hasActionStr:!!n[0].actionStr,hasDescription:!!n[0].description}:null})}catch(i){console.warn("[ticketListUtils] Failed to load ticket details:",i),console.error("[ticketListUtils] Error details:",{message:i.message,stack:i.stack,ticketIdsCount:u.length}),n=null}}const o=Fa(n),l=s.map(u=>Ra(u,o));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:l.length,sampleTicket:l[0]?{id:l[0].id,hasUfSubject:!!l[0].ufSubject,hasPriorityColors:!!l[0].priorityColors,hasServiceColors:!!l[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),l}const He=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:Ta,createContextFromLevel1Time:_a,createContextFromLevel2:Ea,createContextFromLevel2Department:Ca,createContextFromLevel3:Da,filterTicketsByContext:$a,filterTicketsByDepartment:Oe,prepareTicketsForDisplay:La},Symbol.toStringTag,{value:"Module"})),Ye=10;function rt(s,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(n=>n.ticketsByStage&&n.ticketsByStage[s]>0).forEach(n=>{e.push({id:n.id,name:n.name,count:n.ticketsByStage[s]||0})});const a=xa(s,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((n,o)=>o.count-n.count)}function xa(s,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[s])return t.statistics.zeroPointByStage[s].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Gt(s,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[s])==null?void 0:e.count)||0}function it(s,t=Ye){if(!s||s.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...s].sort((l,u)=>u.count-l.count),a=e.slice(0,t),n=e.slice(t),o=n.reduce((l,u)=>l+u.count,0);return{visible:a,others:{employees:n,count:o,employeeCount:n.length}}}function qt(s,t){return!s||s.length===0?[]:t===0?s.map(e=>({...e,percentage:0})):s.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function nt(s,t,e="#007bff",a=Ye){if(!s||s.length===0)return{employees:[],others:null};const{visible:n,others:o}=it(s,a),l=qt(n,t).map(i=>({...i,progressBarWidth:i.percentage,progressBarColor:i.isKeeper?"#f59e0b":e}));let u=null;if(o.count>0){const i=parseFloat((o.count/t*100).toFixed(1));u={...o,percentage:i,progressBarWidth:i,progressBarColor:"#6c757d"}}return{employees:l,others:u}}function Ha(s,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(n=>{const o=t[n];if(!o)return;const l=rt(s,o),u=Gt(s,o);if(l.length===0)return;const{visible:i,others:r}=it(l,Ye),p=qt(i,u);e[n]=p,r.count>0&&(e.others[n]={count:r.count,employeeCount:r.employeeCount,percentage:parseFloat((r.count/u*100).toFixed(1))})}),e}function Pa(s,t="current",e=[]){const a=s[t];if(!a)return{labels:[],datasets:[]};const n=new Map;e.forEach(g=>{rt(g.id,a).forEach(v=>{n.has(v.id)||n.set(v.id,{id:v.id,name:v.name,isKeeper:v.isKeeper||!1,ticketsByStage:{}}),n.get(v.id).ticketsByStage[g.id]=v.count})});const o=Array.from(n.values()).map(g=>{const d=Object.values(g.ticketsByStage).reduce((v,h)=>v+h,0);return{...g,totalTickets:d}});o.sort((g,d)=>d.totalTickets-g.totalTickets);const{visible:l,others:u}=it(o,Ye),i=e.map(()=>""),r={};e.forEach(g=>{const d=rt(g.id,a),{visible:v}=it(d,Ye);r[g.id]=v.map(h=>({id:h.id,name:h.name,count:h.count}))});const p=l.map((g,d)=>{const v=e.map(k=>g.ticketsByStage[k.id]||0),h=e.map(k=>{if((g.ticketsByStage[k.id]||0)===0)return"transparent";const $=k.color.replace("#",""),H=parseInt($.substring(0,2),16),Q=parseInt($.substring(2,4),16),ae=parseInt($.substring(4,6),16),j=.6+d*.05;return`rgba(${H}, ${Q}, ${ae}, ${Math.min(j,.95)})`});return{label:g.name,data:v,backgroundColor:h,borderColor:e.map(k=>{const S=k.color.replace("#",""),E=parseInt(S.substring(0,2),16),$=parseInt(S.substring(2,4),16),H=parseInt(S.substring(4,6),16);return`rgba(${E}, ${$}, ${H}, 0.8)`}),borderWidth:1,meta:{employeeId:g.id,employeeName:g.name}}});if(u.count>0){const g=e.map(d=>u.employees.reduce((v,h)=>v+(h.ticketsByStage[d.id]||0),0));p.push({label:`Другие (${u.employeeCount})`,data:g,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:i,datasets:p,meta:{employeesByStage:r}}}function Oa(s,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(r=>r.id===s),n=a?a.name:"",o=a?a.color:"#007bff",l=rt(s,t),u=Gt(s,t);if(l.length===0)return{stageName:n,totalCount:0,employees:[],others:null};const i=nt(l,u,o,Ye);return{stageName:n,totalCount:u,employees:i.employees,others:i.others}}function Ba(s,t){return(t==null?void 0:t[s])||s}function ja(s,t){return(t==null?void 0:t[s])||"#007bff"}function vt({snapshots:s,graphType:t,timePoint:e,snapshotType:a}){return s?t==="line"&&e?s[e]||null:t==="bar"&&a?s[a]||null:s.current||s.weekEnd||s.weekStart||null:null}function kt(s,t){var e,a,n;return((n=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[s])==null?void 0:n.count)||0}function Ua({stageId:s,timePoint:t,meta:e,snapshots:a,stageColor:n,maxVisible:o}){if(!(e!=null&&e.employees)||!t)return null;const l=e.employees[t];if(!l||l.length===0)return null;const u=(a==null?void 0:a[t])||null,i=kt(s,u)||l.reduce((p,g)=>p+(g.count||0),0),r=nt(l,i,n,o);return{stageId:s,totalCount:i,employees:r.employees,others:r.others,snapshot:u}}function Wa({stageId:s,meta:t,snapshots:e,stageColor:a,maxVisible:n}){var r;const o=(r=t==null?void 0:t.employees)==null?void 0:r[s];if(!o||!o.employees||o.employees.length===0)return null;const l=vt({snapshots:e,graphType:"doughnut"}),u=o.totalCount??kt(s,l)??o.employees.reduce((p,g)=>p+(g.count||0),0),i=nt(o.employees,u,a,n);return{stageId:s,totalCount:u,employees:i.employees,others:i.others,snapshot:l}}function za({stageId:s,meta:t,snapshots:e,stageColor:a,maxVisible:n,snapshotType:o}){var p;const l=(p=t==null?void 0:t.employeesByStage)==null?void 0:p[s];if(!l||l.length===0)return null;const u=vt({snapshots:e,graphType:"bar",snapshotType:o}),i=kt(s,u)||l.reduce((g,d)=>g+(d.count||0),0),r=nt(l,i,a,n);return{stageId:s,totalCount:i,employees:r.employees,others:r.others,snapshot:u}}async function Xt({stageId:s,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:n=null,meta:o=null,stageColorMap:l=null,stageNameMap:u=null,maxVisible:i=10,restLoader:r=null}){if(!s)throw new Error("stageId обязателен для загрузки данных уровня 1");const p=Ba(s,u),g=ja(s,l);let d=null;if(t==="line"?d=Ua({stageId:s,timePoint:e,meta:o==null?void 0:o.line,snapshots:n,stageColor:g,maxVisible:i}):t==="doughnut"?d=Wa({stageId:s,meta:o==null?void 0:o.doughnut,snapshots:n,stageColor:g,maxVisible:i}):t==="bar"&&(d=za({stageId:s,meta:o==null?void 0:o.bar,snapshots:n,stageColor:g,maxVisible:i,snapshotType:a})),d)return{stageId:s,stageName:p,color:g,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot};if(typeof r=="function"){const v=await r({stageId:s,graphType:t,timePoint:e,snapshotType:a,snapshots:n});if(v&&Array.isArray(v.employees)){const h=v.totalCount??v.employees.reduce((S,E)=>S+(E.count||0),0),k=nt(v.employees,h,g,i);return{stageId:s,stageName:p,color:g,totalCount:h,employees:k.employees,others:k.others,snapshot:v.snapshot||vt({snapshots:n,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const Va={key:"level-1",class:"level-1"},Ka={class:"modal-header"},Ya={class:"stage-header"},Ga=["aria-expanded","onKeydown"],qa={class:"stage-title"},Xa=["aria-selected","onClick","onKeydown"],Ja={class:"stage-name"},Za={class:"modal-total"},Qa={class:"view-switcher"},es={class:"modal-body"},ts={key:0,class:"load-error"},as={key:1,class:"stage-loader"},ss={key:2},ns={key:0,class:"no-employees"},os={key:1,class:"employees-list"},ls=["onClick"],rs={class:"employee-name"},is={class:"employee-progress"},cs={class:"employee-count"},us={key:0,class:"employee-item employee-others"},ds={class:"employee-name"},ps={class:"employee-progress"},gs={class:"employee-count"},ms={key:3,class:"view-time"},fs={key:0,class:"no-data"},hs={key:1,class:"date-categories-list"},ys=["onClick"],vs={class:"category-label"},ks={class:"category-progress"},bs={class:"category-count"},ws={key:4,class:"view-departments"},Ss={key:0,class:"no-data"},Es={key:1,class:"departments-table-container"},Cs={class:"departments-table"},Ds=["onClick"],_s={class:"col-department"},Ts={class:"department-name"},As={class:"col-count"},Is={class:"count-value"},$s={key:"level-2",class:"level-2"},Ns={class:"modal-header"},Ms={class:"modal-total"},Fs={class:"modal-body"},Rs={class:"stage-info level2-stage-row"},Ls={class:"stage-badge"},xs={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},Hs={key:0},Ps={key:0,class:"no-data"},Os={key:1,class:"date-categories-list"},Bs=["onClick"],js={class:"category-label"},Us={class:"category-progress"},Ws={class:"category-count"},zs={key:1,class:"view-departments"},Vs={key:0,class:"no-data"},Ks={key:1,class:"departments-table-container"},Ys={class:"departments-table"},Gs=["onClick"],qs={class:"col-department"},Xs={class:"department-name"},Js={class:"col-count"},Zs={class:"count-value"},Qs={key:"level-3",class:"level-3"},en={class:"modal-header"},tn={class:"header-info"},an={class:"header-badges"},sn={class:"date-badge"},nn={class:"stage-badge"},on={class:"modal-total"},ln={class:"modal-body"},rn={key:0,class:"no-data"},cn={key:1,class:"departments-table-container"},un={class:"departments-table"},dn=["onClick"],pn={class:"col-department"},gn={class:"department-name"},mn={class:"col-count"},fn={class:"count-value"},hn={key:"level-4",class:"level-4"},yn={class:"modal-header"},vn={class:"header-info"},kn={key:0,class:"header-badges"},bn={key:0,class:"date-badge"},wn={key:1,class:"department-badge"},Sn={class:"stage-badge"},En={class:"modal-total"},Cn={class:"modal-body"},Dn={key:"loading",class:"loading-state"},_n={key:"error-fallback",class:"error-state-with-fallback"},Tn={class:"tickets-list-container"},An={key:"error",class:"error-state"},In={class:"error-message"},$n={key:"empty",class:"empty-state"},Nn={class:"empty-state-title"},Mn={class:"empty-state-message"},Fn={key:"tickets",class:"tickets-list-container"},Rn={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(s,{expose:t,emit:e}){const a=s,n=e,o=st(),l=F(1),u=F("time"),i=F("employees"),r=F(null),p=F([]),g=F([]),d=F(null),v=F(null),h=F(null),k=F(a.stageSwitchContext||null),S=F(!1),E=F(null),$=F(null),H=F(!1),Q=F(null),ae=F(null),j=ee(()=>{var b,N;const m=((b=k.value)==null?void 0:b.stageNameMap)||{},y=((N=k.value)==null?void 0:N.stageColorMap)||{};return Object.keys(m).map(q=>{var W;return{id:q,name:m[q],color:y[q]||"#007bff",disabled:q===(((W=r.value)==null?void 0:W.stageId)||a.stageId)}})});ee(()=>l.value>1);const P=ee(()=>{var m,y,b,N,q;switch(l.value){case 1:return((m=r.value)==null?void 0:m.stageName)||a.stageName;case 2:return((y=d.value)==null?void 0:y.employeeName)||"";case 3:return`${((b=d.value)==null?void 0:b.employeeName)||""} — ${((N=v.value)==null?void 0:N.dateCategoryLabel)||""}`;case 4:if(!((q=h.value)!=null&&q.context))return"Список тикетов";const W=h.value.context,te=[];return W.employeeName&&te.push(W.employeeName),W.dateCategoryLabel&&te.push(W.dateCategoryLabel),W.departmentName&&te.push(W.departmentName),W.stageName&&te.push(W.stageName),te.length>0?te.join(" — "):"Список тикетов";default:return""}});function G(){var m,y,b;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((m=a.employees)==null?void 0:m.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((b=(y=a.snapshot)==null?void 0:y.ticketIds)==null?void 0:b.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),r.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:r.value.stageId,hasSnapshot:!!r.value.snapshot,employeesCount:r.value.employees.length,snapshotType:r.value.snapshot?typeof r.value.snapshot:"null"}),d.value=null,v.value=null,h.value=null,l.value=1,u.value="time",i.value="employees",X(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function X(){if(!r.value||!r.value.snapshot||!r.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const m=r.value.snapshot.tickets||[],y=r.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:m.length,currentStageId:y,sampleTicket:m[0]?{id:m[0].id,stageId:m[0].stageId,hasDepartmentHead:!!m[0].departmentHead,departmentHead:m[0].departmentHead,hasDepartmentHeadFull:!!m[0].departmentHeadFull,departmentHeadFull:m[0].departmentHeadFull,allKeys:Object.keys(m[0])}:null});let b=m.filter(R=>R.stageId?Ke(R.stageId)===y:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:m.length,afterFilter:b.length,stageId:y,ticketsWithStageId:b.filter(R=>R.stageId).length,ticketsWithoutStageId:b.filter(R=>!R.stageId).length});const N=b.filter(R=>!R.departmentHead&&!R.departmentHeadFull);if(N.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:N.length,totalTickets:b.length,ticketsWithDepartment:b.filter(w=>w.departmentHead||w.departmentHeadFull).length});const R=N.map(w=>w.id).filter(w=>w);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:R.length,ticketIdsSample:R.slice(0,10)});const w=await yt.getTicketsDetails(R),f=new Map;w.forEach(C=>{C&&C.id&&f.set(C.id,C)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:w.length,detailsMapSize:f.size,sampleDetail:w[0]?{id:w[0].id,departmentHead:w[0].departmentHead,departmentHeadFull:w[0].departmentHeadFull}:null}),b=b.map(C=>{const M=f.get(C.id);return M?{...C,stageId:M.stageId||C.stageId||null,departmentHead:M.departmentHead||C.departmentHead||null,departmentHeadFull:M.departmentHeadFull||M.departmentHead||C.departmentHead||null}:C}),b=b.filter(C=>C.stageId?Ke(C.stageId)===y:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:b.length,ticketsWithDepartment:b.filter(C=>C.departmentHead||C.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(C=>!C.departmentHead&&!C.departmentHeadFull).length,ticketsWithStageId:b.filter(C=>C.stageId).length,ticketsWithoutStageId:b.filter(C=>!C.stageId).length});const _=b.length,I=b.slice(0,3).map(C=>({id:C.id,departmentHead:C.departmentHead,departmentHeadFull:C.departmentHeadFull,stageId:C.stageId}));b=b.filter(C=>C.stageId?Ke(C.stageId)===y:!0);const L=b.slice(0,3).map(C=>({id:C.id,departmentHead:C.departmentHead,departmentHeadFull:C.departmentHeadFull,stageId:C.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:_,afterStageFilter:b.length,filteredOut:_-b.length,currentStageId:y,ticketsWithDepartment:b.filter(C=>C.departmentHead||C.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(C=>!C.departmentHead&&!C.departmentHeadFull).length,sampleBeforeFilter:I,sampleAfterFilter:L,sampleWithDepartment:b.find(C=>C.departmentHead||C.departmentHeadFull)?{id:b.find(C=>C.departmentHead||C.departmentHeadFull).id,departmentHead:b.find(C=>C.departmentHead||C.departmentHeadFull).departmentHead,departmentHeadFull:b.find(C=>C.departmentHead||C.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(b.find(C=>C.departmentHead||C.departmentHeadFull)).filter(C=>C.toLowerCase().includes("department"))}:null})}catch(w){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",w),console.error("[EmployeeDetailsModal] Error details:",{message:w.message,stack:w.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:b.length,currentStageId:y,ticketsWithStageId:b.filter(R=>R.stageId).length,ticketsWithoutStageId:b.filter(R=>!R.stageId).length,ticketsWithDepartment:b.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length});const q=Ot(b);p.value=q,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:b.length,sampleTickets:b.slice(0,5).map(R=>({id:R.id,departmentHead:R.departmentHead,departmentHeadFull:R.departmentHeadFull,hasDepartmentHead:!!R.departmentHead,hasDepartmentHeadFull:!!R.departmentHeadFull,allKeys:Object.keys(R).filter(w=>w.toLowerCase().includes("department"))})),ticketsWithDepartment:b.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length});const W=Bt(b);g.value=W;const te=q.reduce((R,w)=>R+w.count,0),ie=W.reduce((R,w)=>R+w.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:y,totalTicketsForGrouping:b.length,timeCategoriesCount:q.length,totalTicketsInTimeCategories:te,departmentsCount:W.length,totalTicketsInDepartments:ie,departmentsSample:W.slice(0,5),ticketsWithDepartment:b.filter(R=>R.departmentHead||R.departmentHeadFull).length,ticketsWithoutDepartment:b.filter(R=>!R.departmentHead&&!R.departmentHeadFull).length,consistencyCheck:{totalTickets:b.length,timeCategoriesTotal:te,departmentsTotal:ie,isConsistent:b.length===te&&b.length===ie}})}catch(m){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",m),console.error("[EmployeeDetailsModal] Error stack:",m.stack)}}async function re(m){var b;if(!m){o.error("Не указан stageId для загрузки данных");return}if(((b=r.value)==null?void 0:b.stageId)===m)return;if(!k.value){o.error("Нет контекста для смены стадии (stageSwitchContext)");return}S.value=!0,E.value=null;const y=r.value?{...r.value}:null;$.value=(y==null?void 0:y.stageId)||null;try{const N=await Xt({...k.value,stageId:m});r.value={stageId:N.stageId,stageName:N.stageName,stageColor:N.color,totalCount:N.totalCount,employees:N.employees,others:N.others,snapshot:N.snapshot||(y==null?void 0:y.snapshot)||null,ticketDetails:N.ticketDetails||null},d.value=null,v.value=null,h.value=null,l.value=1,u.value="time",i.value="employees",await X()}catch(N){console.error("[EmployeeDetailsModal] Failed to reload stage data:",N),E.value=(N==null?void 0:N.message)||"Не удалось загрузить данные стадии",y&&(r.value=y),o.error(E.value)}finally{S.value=!1}}async function pe(m){if(!m||m.count===0){o.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!v.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),o.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:y}=await Le(async()=>{const{createContextFromLevel3:N}=await Promise.resolve().then(()=>He);return{createContextFromLevel3:N}},void 0),b=await y(v.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await me(b)}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",y),o.error("Ошибка перехода на список тикетов: "+y.message)}}async function $e(m){if(!m||m.count===0){o.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!r.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),o.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:y}=await Le(async()=>{const{createContextFromLevel1Department:N}=await Promise.resolve().then(()=>He);return{createContextFromLevel1Department:N}},void 0),b=y(r.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:b.stageName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await me(b)}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",y),o.error("Ошибка перехода на список тикетов: "+y.message)}}async function ke(m){if(!m||m.count===0){o.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){o.info(`В категории "${m.label}" нет тикетов`);return}if(!r.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),o.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:y}=await Le(async()=>{const{createContextFromLevel1Time:N}=await Promise.resolve().then(()=>He);return{createContextFromLevel1Time:N}},void 0),b=y(r.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:b.stageName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await me(b)}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",y),o.error("Ошибка перехода на список тикетов: "+y.message)}}Ve(()=>a.isVisible,m=>{m?G():(Ue(),Se())}),Ve(()=>a.stageSwitchContext,m=>{k.value=m},{deep:!0}),Pe(()=>{a.isVisible&&G()});async function Be(m,y=null){var b,N,q;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",m),console.log("[EmployeeDetailsModal] Current popup level:",l.value),y&&y.currentTarget&&(y.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{y.currentTarget&&(y.currentTarget.style.transform="")},150)),!m||!m.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",m);return}if(r.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),r.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:r.value.stageId,stageName:r.value.stageName,hasSnapshot:!!r.value.snapshot,snapshotType:r.value.snapshot?typeof r.value.snapshot:"null",snapshotKeys:r.value.snapshot?Object.keys(r.value.snapshot):[]}),!r.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),o.warning("ID стадии не указан");return}if(!r.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),o.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",m.id,"stage:",r.value.stageId);const W=await Kt(m.id,r.value.stageId,r.value.snapshot,r.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(W==null?void 0:W.length)||0,W),!W||W.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),o.info(`У сотрудника "${m.name}" нет тикетов на стадии "${r.value.stageName}"`);return}const te=Ot(W);console.log("[EmployeeDetailsModal] Date categories:",(te==null?void 0:te.length)||0,te);const ie=Bt(W).map(R=>({...R,tickets:Oe(W,R.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",(ie==null?void 0:ie.length)||0,ie),d.value={employeeId:m.id,employeeName:m.name,stageId:r.value.stageId,stageName:r.value.stageName,totalCount:W.length,dateCategories:te,departments:ie,tickets:W,snapshot:r.value.snapshot,ticketDetails:r.value.ticketDetails},u.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:d.value.employeeName,totalCount:d.value.totalCount,dateCategoriesCount:d.value.dateCategories.length,departmentsCount:d.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",d.value),l.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",l.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",d.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!d.value,employeeName:(b=d.value)==null?void 0:b.employeeName,dateCategoriesCount:((q=(N=d.value)==null?void 0:N.dateCategories)==null?void 0:q.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",l.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",d.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(W){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",W),console.error("[EmployeeDetailsModal] Error stack:",W.stack),o.error("Ошибка загрузки данных о тикетах: "+W.message)}}async function Ge(m){if(!m||m.count===0){o.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!d.value){o.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:y}=await Le(async()=>{const{createContextFromLevel2Department:N}=await Promise.resolve().then(()=>He);return{createContextFromLevel2Department:N}},void 0),b=y(d.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:b.employeeName,departmentName:b.departmentName,ticketsCount:b.tickets.length}),await me(b)}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",y),o.error("Ошибка перехода на список тикетов: "+y.message)}}async function je(m){if(!m||m.count===0){o.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){o.info(`В категории "${m.label}" нет тикетов`);return}if(!d.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),o.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:y}=await Le(async()=>{const{createContextFromLevel2:N}=await Promise.resolve().then(()=>He);return{createContextFromLevel2:N}},void 0),b=y(d.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:b.employeeName,dateCategory:b.dateCategoryLabel,ticketsCount:b.tickets.length}),await me(b)}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",y),o.error("Ошибка перехода на список тикетов: "+y.message)}}async function me(m){var y;if(console.time("[Performance] goToLevel4"),!m){console.error("[EmployeeDetailsModal] Context is required for level 4"),o.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:m.sourceLevel,employeeId:m.employeeId,stageId:m.stageId,dateCategory:m.dateCategory,departmentName:m.departmentName,ticketsCount:((y=m.tickets)==null?void 0:y.length)||0});try{h.value={context:m,tickets:[],totalCount:0,isLoading:!0,error:null};let b=m.tickets||[];if(b.length===0&&m.snapshot){const{filterTicketsByContext:q}=await Le(async()=>{const{filterTicketsByContext:W}=await Promise.resolve().then(()=>He);return{filterTicketsByContext:W}},void 0);b=await q(m)}(!b||b.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),b=m.tickets||[]),(!b||b.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),m.snapshot&&m.snapshot.tickets&&(b=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",b.length)));let N=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:q}=await Le(async()=>{const{prepareTicketsForDisplay:W}=await Promise.resolve().then(()=>He);return{prepareTicketsForDisplay:W}},void 0);N=await q(b,m.snapshot,m.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(q){console.error("[EmployeeDetailsModal] Error preparing tickets:",q),console.timeEnd("[Performance] prepareTicketsForDisplay"),N=b||[],o.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:b.length,preparedCount:N.length}),h.value={context:m,tickets:N,totalCount:N.length,isLoading:!1,error:null},l.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:h.value.totalCount,ticketsCount:h.value.tickets.length,isLoading:h.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",b),console.error("[EmployeeDetailsModal] Error details:",{message:b.message,stack:b.stack,context:m});let N=[];if(m.snapshot&&m.snapshot.tickets)try{const q=m.stageId;q?N=(m.snapshot.tickets||[]).filter(W=>W.stageId===q):N=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",N.length)}catch(q){console.error("[EmployeeDetailsModal] Error using fallback tickets:",q)}h.value={context:m,tickets:N,totalCount:N.length,isLoading:!1,error:{message:b.message,hasFallback:N.length>0}},N.length>0?(o.warning("Ошибка загрузки данных. Отображаются данные из кеша."),l.value=4):(o.error("Ошибка загрузки тикетов: "+b.message),be()),console.timeEnd("[Performance] goToLevel4")}}function be(){if(l.value===4){if(h.value&&h.value.context){const m=h.value.context.sourceLevel;l.value=m}else l.value=1;h.value=null}else l.value===3?(l.value=2,v.value=null,h.value=null):l.value===2&&(l.value=1,d.value=null,v.value=null,h.value=null)}function Ue(){l.value=1,r.value=null,d.value=null,v.value=null,h.value=null,u.value="time"}function we(){var q;if(!((q=h.value)!=null&&q.context))return"Нет тикетов";const{sourceLevel:m,employeeName:y,dateCategoryLabel:b,departmentName:N}=h.value.context;return m===2&&y&&b?`Нет тикетов у ${y} в категории "${b}"`:m===2&&y&&N?`Нет тикетов у ${y} у заказчика "${N}"`:m===3&&y&&N?`Нет тикетов у ${y} у заказчика "${N}"`:m===1&&b?`Нет тикетов в категории "${b}"`:m===1&&N?`Нет тикетов у заказчика "${N}"`:"Нет тикетов для отображения"}function Ne(){var y;if(!((y=h.value)!=null&&y.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:m}=h.value.context;return m?`На стадии "${m}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function qe(){var y;if(!((y=h.value)!=null&&y.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const m=h.value.context;await me(m)}function O(m){if(!m){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),o.warning("Ошибка: тикет не найден");return}if(!m.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",m),o.error("Ошибка: ID тикета не указан");return}try{const y=ua(m.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:m.id,iframeUrl:y}),!y||typeof y!="string"||y.length===0)throw new Error("Не удалось сформировать URL для тикета");const b=window.open(y,"_blank","noopener,noreferrer");if(!b||b.closed||typeof b.closed>"u")try{const N=document.createElement("a");N.href=y,N.target="_blank",N.rel="noopener noreferrer",N.style.display="none",document.body.appendChild(N),N.click(),document.body.removeChild(N),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:m.id,iframeUrl:y})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:m.id,iframeUrl:y})}catch(y){console.error("[EmployeeDetailsModal] Error opening ticket:",y),console.error("[EmployeeDetailsModal] Error details:",{message:y.message,stack:y.stack,ticket:m}),o.error("Ошибка открытия тикета: "+y.message)}}function Y(){Ue(),n("close")}t({reloadLevel1ForStage:re});function fe(m){m&&m.stopPropagation(),H.value=!H.value}function Se(){H.value&&(H.value=!1)}function he(m){if(!H.value)return;const y=Q.value,b=ae.value;y&&y.contains(m.target)||b&&b.contains(m.target)||(H.value=!1)}async function Me(m){if(m.disabled){H.value=!1;return}H.value=!1,await re(m.id)}function Xe(m){if(H.value){m.stopPropagation(),Se();return}Y()}return(m,y)=>(D(),Ae(Ut,{to:"body"},[s.isVisible?(D(),A("div",{key:0,class:"employee-details-modal",onClick:oe(Y,["self"]),onKeydown:Ze(Xe,["esc"])},[c("div",{class:"modal-content",onClick:he},[de(at,{name:"level",mode:"out-in"},{default:Te(()=>{var b,N,q,W,te,ie,R,w,f,_,I,L,C,M,V,U,K,J,B;return[l.value===1?(D(),A("div",Va,[c("div",Ka,[c("div",Ya,[c("button",{ref_key:"stageTriggerRef",ref:ae,class:"stage-trigger","aria-expanded":H.value,"aria-haspopup":"listbox",onClick:oe(fe,["stop"]),onKeydown:[Ze(oe(fe,["prevent"]),["enter"]),Ze(oe(fe,["prevent"]),["space"]),Ze(oe(Se,["stop","prevent"]),["esc"])]},[c("span",{class:"stage-color",style:ye({backgroundColor:((b=r.value)==null?void 0:b.stageColor)||((W=(N=k.value)==null?void 0:N.stageColorMap)==null?void 0:W[(q=r.value)==null?void 0:q.stageId])||((ie=(te=k.value)==null?void 0:te.stageColorMap)==null?void 0:ie[s.stageId])||"#007bff"})},null,4),c("span",qa,x(((R=r.value)==null?void 0:R.stageName)||s.stageName),1),c("span",{class:ne(["stage-caret",{open:H.value}])},"▾",2)],40,Ga),H.value?(D(),A("div",{key:0,ref_key:"stageDropdownRef",ref:Q,class:"stage-dropdown",role:"listbox"},[(D(!0),A(ce,null,ue(j.value,T=>(D(),A("div",{key:T.id,class:ne(["stage-option",{disabled:T.disabled}]),role:"option","aria-selected":T.disabled,onClick:oe(z=>Me(T),["stop"]),onKeydown:Ze(oe(z=>Me(T),["prevent"]),["enter"])},[c("span",{class:"stage-color",style:ye({backgroundColor:T.color})},null,4),c("span",Ja,x(T.name),1)],42,Xa))),128))],512)):Z("",!0)]),c("span",Za,"Всего: "+x(((w=r.value)==null?void 0:w.totalCount)||s.totalCount)+" тикетов",1),c("button",{class:"modal-close",onClick:Y,"aria-label":"Закрыть"},"×")]),c("div",Qa,[c("button",{class:ne(["view-switch-btn",{active:i.value==="employees"}]),onClick:y[0]||(y[0]=T=>i.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),c("button",{class:ne(["view-switch-btn",{active:i.value==="time"}]),onClick:y[1]||(y[1]=T=>i.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),c("button",{class:ne(["view-switch-btn",{active:i.value==="departments"}]),onClick:y[2]||(y[2]=T=>i.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),c("div",es,[E.value?(D(),A("div",ts,[c("span",null,"Ошибка: "+x(E.value),1),c("button",{class:"btn-retry-stage",onClick:y[3]||(y[3]=T=>{var z;return re(((z=r.value)==null?void 0:z.stageId)||s.stageId)})}," Повторить ")])):Z("",!0),S.value?(D(),A("div",as,[...y[7]||(y[7]=[c("div",{class:"loading-spinner small"},null,-1),c("span",null,"Загрузка стадии...",-1)])])):Z("",!0),i.value==="employees"?(D(),A("div",ss,[(((f=r.value)==null?void 0:f.employees)||s.employees).length===0&&(!((_=r.value)!=null&&_.others||s.others)||(((I=r.value)==null?void 0:I.others)||s.others).count===0)?(D(),A("div",ns," Нет данных о сотрудниках ")):(D(),A("div",os,[(D(!0),A(ce,null,ue(((L=r.value)==null?void 0:L.employees)||s.employees,T=>(D(),A("div",{key:T.id,class:ne(["employee-item",{"employee-keeper":T.isKeeper}]),onClick:oe(z=>Be(T,z),["stop"]),title:"Кликните для детализации по временным градациям"},[c("span",rs,x(T.name),1),c("div",is,[c("div",{class:"progress-bar",style:ye({width:T.progressBarWidth+"%",backgroundColor:T.progressBarColor})},null,4)]),c("span",cs,x(T.count)+" тикетов ("+x(T.percentage)+"%) ",1),y[8]||(y[8]=c("span",{class:"employee-arrow"},"→",-1))],10,ls))),128)),((C=r.value)!=null&&C.others||s.others)&&(((M=r.value)==null?void 0:M.others)||s.others).count>0?(D(),A("div",us,[c("span",ds,"Другие ("+x((((V=r.value)==null?void 0:V.others)||s.others).employeeCount)+")",1),c("div",ps,[c("div",{class:"progress-bar",style:ye({width:(((U=r.value)==null?void 0:U.others)||s.others).progressBarWidth+"%",backgroundColor:(((K=r.value)==null?void 0:K.others)||s.others).progressBarColor})},null,4)]),c("span",gs,x((((J=r.value)==null?void 0:J.others)||s.others).count)+" тикетов ("+x((((B=r.value)==null?void 0:B.others)||s.others).percentage)+"%) ",1)])):Z("",!0)]))])):i.value==="time"?(D(),A("div",ms,[p.value.length===0?(D(),A("div",fs," Загрузка данных... ")):(D(),A("div",hs,[(D(!0),A(ce,null,ue(p.value,T=>(D(),A("div",{key:T.category,class:"category-item",onClick:oe(z=>ke(T),["stop"])},[c("span",vs,x(T.label),1),c("div",ks,[c("div",{class:"progress-bar",style:ye({width:T.progressBarWidth+"%",backgroundColor:T.progressBarColor})},null,4)]),c("span",bs,x(T.count)+" тикетов ("+x(T.percentage)+"%) ",1),y[9]||(y[9]=c("span",{class:"category-arrow"},"→",-1))],8,ys))),128))]))])):i.value==="departments"?(D(),A("div",ws,[g.value.length===0?(D(),A("div",Ss," Загрузка данных... ")):(D(),A("div",Es,[c("table",Cs,[y[11]||(y[11]=c("thead",null,[c("tr",null,[c("th",{class:"col-department"},"Заказчик"),c("th",{class:"col-count"},"Количество тикетов"),c("th",{class:"col-action"})])],-1)),c("tbody",null,[(D(!0),A(ce,null,ue(g.value,(T,z)=>(D(),A("tr",{key:z,class:"department-row",onClick:oe(se=>$e(T),["stop"]),title:"Кликните для просмотра тикетов"},[c("td",_s,[c("span",Ts,x(T.departmentName),1)]),c("td",As,[c("span",Is,x(T.count),1)]),y[10]||(y[10]=c("td",{class:"col-action"},[c("span",{class:"department-arrow"},"→")],-1))],8,Ds))),128))])])]))])):Z("",!0)])])):l.value===2&&d.value?(D(),A("div",$s,[c("div",Ns,[c("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),c("h3",null,x(d.value.employeeName),1),c("span",Ms,"Всего: "+x(d.value.totalCount)+" тикетов",1),c("button",{class:"modal-close",onClick:Y,"aria-label":"Закрыть"},"×")]),c("div",Fs,[c("div",Rs,[c("span",Ls,x(d.value.stageName),1),c("div",xs,[c("button",{class:ne(["level2-sort-btn",{active:u.value==="time"}]),onClick:y[4]||(y[4]=T=>u.value="time"),title:"Сортировка по времени"}," По времени ",2),c("button",{class:ne(["level2-sort-btn",{active:u.value==="departments"}]),onClick:y[5]||(y[5]=T=>u.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),u.value==="time"?(D(),A("div",Hs,[d.value.dateCategories.length===0?(D(),A("div",Ps," Нет данных о тикетах ")):(D(),A("div",Os,[(D(!0),A(ce,null,ue(d.value.dateCategories,T=>(D(),A("div",{key:T.category,class:"category-item",onClick:oe(z=>je(T),["stop"])},[c("span",js,x(T.label),1),c("div",Us,[c("div",{class:"progress-bar",style:ye({width:T.progressBarWidth+"%",backgroundColor:T.progressBarColor})},null,4)]),c("span",Ws,x(T.count)+" тикетов ("+x(T.percentage)+"%) ",1)],8,Bs))),128))]))])):(D(),A("div",zs,[!d.value.departments||d.value.departments.length===0?(D(),A("div",Vs,[y[12]||(y[12]=et(" Для выбранного сотрудника заказчики не найдены ",-1)),c("button",{class:"btn-retry-stage",onClick:y[6]||(y[6]=T=>Be({id:d.value.employeeId,name:d.value.employeeName}))}," Обновить ")])):(D(),A("div",Ks,[c("table",Ys,[y[14]||(y[14]=c("thead",null,[c("tr",null,[c("th",{class:"col-department"},"Заказчик"),c("th",{class:"col-count"},"Количество тикетов"),c("th",{class:"col-action"})])],-1)),c("tbody",null,[(D(!0),A(ce,null,ue(d.value.departments,(T,z)=>(D(),A("tr",{key:z,class:"department-row",onClick:oe(se=>Ge(T),["stop"]),title:"Кликните для просмотра тикетов"},[c("td",qs,[c("span",Xs,x(T.departmentName),1)]),c("td",Js,[c("span",Zs,x(T.count),1)]),y[13]||(y[13]=c("td",{class:"col-action"},[c("span",{class:"department-arrow"},"→")],-1))],8,Gs))),128))])])]))]))])])):l.value===3&&v.value?(D(),A("div",Qs,[c("div",en,[c("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),c("div",tn,[c("h3",null,x(v.value.employeeName),1),c("div",an,[c("span",sn,x(v.value.dateCategoryLabel),1),c("span",nn,x(v.value.stageName),1)])]),c("span",on,"Всего: "+x(v.value.totalCount)+" тикетов",1),c("button",{class:"modal-close",onClick:Y,"aria-label":"Закрыть"},"×")]),c("div",ln,[v.value.departments.length===0?(D(),A("div",rn," Нет данных о заказчиках ")):(D(),A("div",cn,[c("table",un,[y[16]||(y[16]=c("thead",null,[c("tr",null,[c("th",{class:"col-department"},"Заказчик"),c("th",{class:"col-count"},"Количество тикетов"),c("th",{class:"col-action"})])],-1)),c("tbody",null,[(D(!0),A(ce,null,ue(v.value.departments,(T,z)=>(D(),A("tr",{key:z,class:"department-row",onClick:oe(se=>pe(T),["stop"]),title:"Кликните для просмотра тикетов"},[c("td",pn,[c("span",gn,x(T.departmentName),1)]),c("td",mn,[c("span",fn,x(T.count),1)]),y[15]||(y[15]=c("td",{class:"col-action"},[c("span",{class:"department-arrow"},"→")],-1))],8,dn))),128))])])]))])])):l.value===4&&h.value?(D(),A("div",hn,[c("div",yn,[c("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),c("div",vn,[c("h3",null,x(P.value),1),h.value.context?(D(),A("div",kn,[h.value.context.dateCategoryLabel?(D(),A("span",bn,x(h.value.context.dateCategoryLabel),1)):Z("",!0),h.value.context.departmentName?(D(),A("span",wn,x(h.value.context.departmentName),1)):Z("",!0),c("span",Sn,x(h.value.context.stageName),1)])):Z("",!0)]),c("span",En,"Всего: "+x(h.value.totalCount)+" тикетов",1),c("button",{class:"modal-close",onClick:Y,"aria-label":"Закрыть"},"×")]),c("div",Cn,[de(at,{name:"loading",mode:"out-in"},{default:Te(()=>[h.value.isLoading?(D(),A("div",Dn,[...y[17]||(y[17]=[c("div",{class:"loading-spinner"},null,-1),c("p",null,"Загрузка тикетов...",-1)])])):h.value.error&&h.value.error.hasFallback?(D(),A("div",_n,[y[18]||(y[18]=c("div",{class:"error-banner"},[c("span",{class:"error-icon"},"⚠️"),c("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),c("div",Tn,[de(Mt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(D(!0),A(ce,null,ue(h.value.tickets,(T,z)=>(D(),Ae(Ht,{key:T.id,ticket:T,draggable:!1,style:ye({"--ticket-index":z}),onClick:se=>O(T)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):h.value.error&&!h.value.error.hasFallback?(D(),A("div",An,[y[19]||(y[19]=c("div",{class:"error-icon"},"❌",-1)),y[20]||(y[20]=c("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),c("p",In,x(h.value.error.message),1),c("button",{class:"btn-retry",onClick:qe},"Повторить попытку")])):!h.value.tickets||h.value.tickets.length===0?(D(),A("div",$n,[y[21]||(y[21]=c("div",{class:"empty-state-icon"},"📭",-1)),c("h3",Nn,x(we()),1),c("p",Mn,x(Ne()),1)])):(D(),A("div",Fn,[de(Mt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Te(()=>[(D(!0),A(ce,null,ue(h.value.tickets,(T,z)=>(D(),Ae(Ht,{key:T.id,ticket:T,draggable:!1,style:ye({"--ticket-index":z}),onClick:se=>O(T)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):Z("",!0)]}),_:1})])],32)):Z("",!0)]))}},Ln=Ie(Rn,[["__scopeId","data-v-65ca978e"]]);function xn(s,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof s!="number"||s<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((l,u)=>{if(!l||!l.data||!Array.isArray(l.data))return;const i=l.data[s];i!=null&&!isNaN(i)&&a.push({datasetIndex:u,value:Number(i),y:Number(i)})}),a.length<2)return 0;const n=[];return a.forEach(l=>{let u=!1;for(const i of n){const r=i.y;if(Math.abs(l.y-r)<e){i.points.push(l),i.y=i.points.reduce((g,d)=>g+d.y,0)/i.points.length,u=!0;break}}u||n.push({points:[l],y:l.y})}),n.length===0?0:n.reduce((l,u)=>u.points.length>l.points.length?u:l,n[0]).points.length}function Hn(s,t){const e=[];return s.forEach(a=>{let n=!1;for(const o of e){const l=o.y;if(Math.abs(a.value-l)<t){o.points.push(a),o.y=o.points.reduce((u,i)=>u+i.value,0)/o.points.length,n=!0;break}}n||e.push({points:[a],y:a.value})}),e}function Pn(s,t=.5){var o,l;if(!s)return console.warn("findOverlappingPoints: chart не передан"),[];if(!s.config||s.config.type!=="line")return[];const e=(o=s.data)==null?void 0:o.datasets,a=((l=s.data)==null?void 0:l.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const n=[];return a.forEach((u,i)=>{try{if(xn(i,e,t)<2)return;const p=[];if(e.forEach((k,S)=>{if(!k||!k.data||!Array.isArray(k.data))return;const E=k.data[i];E==null||isNaN(E)||p.push({datasetIndex:S,value:Number(E),label:k.label||`Dataset ${S}`})}),p.length<2)return;const g=Hn(p,t);if(g.length===0)return;const d=g.reduce((k,S)=>S.points.length>k.points.length?S:k,g[0]);if(d.points.length<2)return;let v=null,h=null;for(let k=0;k<e.length;k++)try{const S=s.getDatasetMeta(k);if(S&&S.data&&S.data[i]){v=S,h=S.data[i];break}}catch{continue}if(!h||typeof h.x!="number"||typeof h.y!="number")return;n.push({position:i,count:d.points.length,x:h.x,y:h.y,value:d.y,points:d.points.map(k=>({datasetIndex:k.datasetIndex,value:k.value,label:k.label}))})}catch(r){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${i}:`,r)}}),n}function On(s,t){const e=[];return s.forEach(a=>{let n=!1;for(const o of e){const l=o.y;if(Math.abs(a.y-l)<t){o.points.push(a),o.y=o.points.reduce((u,i)=>u+i.y,0)/o.points.length,n=!0;break}}n||e.push({points:[a],y:a.y})}),e}function Bn(s,t,e=.5){var r,p;if(!s)return console.warn("calculatePointJitter: chart не передан"),[];if(!s.config||s.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(r=s.data)==null?void 0:r.datasets,n=((p=s.data)==null?void 0:p.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(n)||t>=n.length)return[];const o=[];if(a.forEach((g,d)=>{if(!g||!g.data||!Array.isArray(g.data))return;const v=g.data[t];if(!(v==null||isNaN(v)))try{const h=s.getDatasetMeta(d);if(h&&h.data&&h.data[t]){const k=h.data[t];k&&typeof k.x=="number"&&typeof k.y=="number"&&o.push({datasetIndex:d,value:Number(v),x:k.x,y:k.y})}}catch(h){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,h)}}),o.length===0)return[];const l=On(o,e),u=[];l.forEach(g=>{const d=g.points||[];d.length>1?d.forEach((h,k)=>{const S=(k-(d.length-1)/2)*4;u.push({datasetIndex:h.datasetIndex,jitterX:S,value:h.value})}):d.length===1&&u.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const i=new Set(u.map(g=>g.datasetIndex));return o.forEach(g=>{i.has(g.datasetIndex)||u.push({datasetIndex:g.datasetIndex,jitterX:0,value:g.value})}),u}const jn=.5,jt=6,Un=2;function Wn(s){return typeof s!="number"||s<2?jt:jt+(s-1)*Un}function zn(s,t){if(!s||!s.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=s.ctx,{x:n,y:o,points:l}=t,u=Wn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(n,o,u,0,2*Math.PI);let r="rgba(128, 128, 128, 0.3)";if(l&&l.length>0&&s.data&&s.data.datasets){const p=l[0].datasetIndex,g=s.data.datasets[p];if(g&&g.pointBackgroundColor){const d=Array.isArray(g.pointBackgroundColor)?g.pointBackgroundColor[t.position]||g.pointBackgroundColor[0]:g.pointBackgroundColor;if(d)if(d.startsWith("#")){const v=parseInt(d.slice(1,3),16),h=parseInt(d.slice(3,5),16),k=parseInt(d.slice(5,7),16);r=`rgba(${v}, ${h}, ${k}, 0.4)`}else d.startsWith("rgba")?r=d.replace(/rgba?\(([^)]+)\)/,(v,h)=>{const k=h.split(",").map(S=>S.trim());return`rgba(${k[0]}, ${k[1]}, ${k[2]}, 0.4)`}):r=d+"66"}}a.fillStyle=r,a.fill(),a.strokeStyle=r.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(r){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",r)}finally{a.restore()}}}const Vn={id:"overlappingPointsPlugin",afterDatasetsDraw:s=>{if(!(!s||!s.config||s.config.type!=="line")&&s.ctx)try{const t=Pn(s,jn);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{zn(s,a)}catch(n){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,n)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},Kn=.5,Yn={id:"pointJitterPlugin",beforeDatasetsDraw:s=>{var t,e;if(!(!s||!s.config||s.config.type!=="line")){s._jitterData||(s._jitterData={});try{const a=(t=s.data)==null?void 0:t.datasets,n=((e=s.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(n)||n.length===0)return;s._jitterData={},n.forEach((o,l)=>{const u=Bn(s,l,Kn);u&&u.length>0&&u.forEach(i=>{const r=`${i.datasetIndex}_${l}`;s._jitterData[r]=i.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:s=>{var t;if(!(!s||!s.config||s.config.type!=="line")&&s.ctx&&!(!s._jitterData||Object.keys(s._jitterData).length===0))try{const e=s.ctx,a=(t=s.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((n,o)=>{const l=s.getDatasetMeta(o);!l||l.hidden||!n.data||!Array.isArray(n.data)||n.data.forEach((u,i)=>{const r=l.data[i];if(!r||typeof r.x!="number"||typeof r.y!="number"||u==null||isNaN(u))return;const p=`${o}_${i}`,g=s._jitterData[p];if(!(g===void 0||g===0)){e.save();try{const d=n.pointStyle||"circle",v=(n.pointRadius||7)+1,h=Array.isArray(n.pointBackgroundColor)?n.pointBackgroundColor[i]||n.pointBackgroundColor[0]:n.pointBackgroundColor,k=Array.isArray(n.pointBorderColor)?n.pointBorderColor[i]||n.pointBorderColor[0]:n.pointBorderColor,S=n.pointBorderWidth||1,E=r.x+g,$=r.y;switch(e.fillStyle=h||"#007bff",e.strokeStyle=k||"#ffffff",e.lineWidth=S,e.beginPath(),d){case"circle":e.arc(E,$,v,0,2*Math.PI);break;case"triangle":e.moveTo(E,$-v),e.lineTo(E-v,$+v),e.lineTo(E+v,$+v),e.closePath();break;case"rect":case"rectRounded":const H=v*1.4;e.rect(E-H/2,$-H/2,H,H);break;case"rectRot":const Q=v*1.4;e.moveTo(E,$-Q/2),e.lineTo(E+Q/2,$),e.lineTo(E,$+Q/2),e.lineTo(E-Q/2,$),e.closePath();break;case"star":const ae=v;for(let G=0;G<5;G++){const X=G*4*Math.PI/5-Math.PI/2,re=E+ae*Math.cos(X),pe=$+ae*Math.sin(X);G===0?e.moveTo(re,pe):e.lineTo(re,pe)}e.closePath();break;case"cross":const j=v;e.moveTo(E-j,$-j),e.lineTo(E+j,$+j),e.moveTo(E+j,$-j),e.lineTo(E-j,$+j);break;case"crossRot":const P=v;e.moveTo(E-P,$),e.lineTo(E+P,$),e.moveTo(E,$-P),e.lineTo(E,$+P);break;default:e.arc(E,$,v,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),r._originalX||(r._originalX=r.x,r._originalY=r.y),r._jitterX=g,r._jitteredX=E,r._jitteredY=$}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${o}_${i}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:s=>{s._jitterData}},Gn={id:"pointLabelsPlugin",afterDatasetsDraw:s=>{var t;if(!(!s||!s.config||s.config.type!=="line")&&s.ctx)try{const e=s.ctx,a=(t=s.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((n,o)=>{const l=s.getDatasetMeta(o);if(!l||l.hidden||!n.data||!Array.isArray(n.data))return;const u=Array.isArray(n.pointBackgroundColor)?n.pointBackgroundColor[0]||"#6b7280":n.pointBackgroundColor||"#6b7280";n.data.forEach((i,r)=>{const p=l.data[r];if(!p||typeof p.x!="number"||typeof p.y!="number"||i==null||isNaN(i))return;const g=p._jitteredX!==void 0?p._jitteredX:p.x,d=p._jitteredY!==void 0?p._jitteredY:p.y,v=g+8,h=d-5,k=String(Math.round(i));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const E=e.measureText(k).width,$=11,H=3,Q=v-H,ae=h-$/2-H,j=E+H*2,P=$+H*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Q,ae,j,P),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Q,ae,j,P),e.fillStyle=u,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(k,v,h)}catch(S){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${o}_${r}:`,S)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},qn={class:"graph-state-chart"},Xn={class:"chart-header"},Jn={class:"chart-type-selector"},Zn=["onClick","title"],Qn={class:"chart-type-icon"},eo={class:"chart-type-label"},to={key:0,class:"comparison-type-selector"},ao={class:"radio-group"},so={key:0},no={key:1},oo={key:2,class:"graph-legend"},lo={key:4,class:"error-container"},ro={class:"error-message"},io={class:"chart-wrapper"},co={class:"chart-canvas-container"},uo={key:0,class:"bar-chart-stage-labels"},po={key:6,class:"no-data"},go={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(s,{emit:t}){const e=(w,f)=>typeof window>"u"?f:getComputedStyle(document.documentElement).getPropertyValue(w).trim()||f,a=s,n=t,o=F(!1),l=F(null),u=F(null),i=F({weekStart:null,weekEnd:null,current:null}),r=F(null),p=F("weekStartToWeekEnd"),g=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=F("line"),v=F(!1),h=F(""),k=F(""),S=F(0),E=F([]),$=F(null),H=F(null),Q=F(null),ae=F(null),j=F([]),P=ee(()=>{switch(d.value){case"line":return Ft;case"bar":return oa;case"doughnut":return na;default:return Ft}}),G={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},X=[{id:"formed",name:"Сформировано обращение",color:G.formed},{id:"review",name:"Рассмотрение ТЗ",color:G.review},{id:"execution",name:"Исполнение",color:G.execution}],re=ee(()=>X.reduce((w,f)=>(w[f.id]=f.name,w),{})),pe=["circle","triangle","rect","rectRot","star","cross","crossRot"],$e=F({formed:!0,review:!0,execution:!0}),ke=st(),Be={id:"employeeLabelsPlugin",afterDatasetsDraw:w=>{if(w.config.type==="bar")try{const f=w.ctx;if(!w.data||!w.data.datasets)return;const _=w.data.datasets,I=w.scales.y;_.forEach((L,C)=>{const M=w.getDatasetMeta(C);if(!M||M.hidden)return;const V=L.label||"";if(!V||V.includes("Другие"))return;const U=V.trim().split(/\s+/);let K="";if(U.length===1)K=U[0];else{const B=U[0],T=U.slice(1).join(" ");K=`${B}
${T}`}const J=K.split(`
`);L.data.forEach((B,T)=>{if(B===0||!B)return;const z=M.data[T];if(!z||typeof z.x!="number"||typeof z.y!="number")return;const se=z.x,ve=z.y+z.height+25;f.save(),f.font="bold 9px Arial, sans-serif",f.fillStyle="#6b7280",f.textAlign="center",f.textBaseline="top",f.translate(se,ve),f.rotate(-12*Math.PI/180),J.forEach((Ee,Fe)=>{const Re=Ee.trim();Re&&f.fillText(Re,0,Fe*11)}),f.restore()})})}catch(f){console.error("Error in employeeLabelsPlugin:",f)}}},Ge={id:"doughnutCenterTextPlugin",afterDraw:w=>{var z;if(w.config.type!=="doughnut")return;const{ctx:f,chartArea:_,width:I,height:L}=w;if(!w.data||!w.data.datasets||w.data.datasets.length===0)return;const C=w.data.datasets[0].meta,M=((z=C==null?void 0:C.totals)==null?void 0:z.overall)??null;if(M===null||typeof M>"u")return;const V=["Всего в секторе 1С","тикетов в работе:",`${M}`];f.save(),f.font='600 16px "Roboto", sans-serif',f.fillStyle=e("--b24-text-primary","#1f2937"),f.textAlign="center",f.textBaseline="middle";const U=(_.left+_.right)/2,K=(_.top+_.bottom)/2,J=18,B=J*V.length,T=K-B/2+4;V.forEach((se,ve)=>{ve===V.length-1&&`${se}`.length>4?f.font='700 18px "Roboto", sans-serif':f.font='600 16px "Roboto", sans-serif',f.fillText(se,U,T+ve*J)}),f.restore()}};Qe.register(Be),Qe.register(Ge);function je(){const w=new Map;[i.value.weekStart,i.value.weekEnd,i.value.current].forEach(f=>{!f||!f.statistics||!f.statistics.employees||f.statistics.employees.forEach(_=>{w.has(_.id)||w.set(_.id,{id:_.id,name:_.name})})}),j.value=Array.from(w.values()).sort((f,_)=>f.name.localeCompare(_.name))}function me(w,f="background"){var I;return((I={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[w])==null?void 0:I[f])||e("--b24-text-secondary","#6c757d")}function be(){if(!(!i.value.weekStart||!i.value.weekEnd))try{const w=gt.compareTwoSnapshots(i.value.weekStart,i.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let f=null,_=null;i.value.current&&(f=gt.compareTwoSnapshots(i.value.weekEnd,i.value.current,{includeTickets:!1,includeEmployees:!0}),_=gt.compareTwoSnapshots(i.value.weekStart,i.value.current,{includeTickets:!1,includeEmployees:!0})),r.value={weekStartToWeekEnd:w,weekEndToCurrent:f,weekStartToCurrent:_}}catch(w){console.error("Ошибка сравнения слепков:",w),ke.warning("Не удалось выполнить сравнение слепков: "+w.message)}}function Ue(w){return w?w.replace(/\s*\(\d+\)\s*$/,"").trim():""}function we(w){const f=Ue(w);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[f]||"formed"}function Ne(w){return we(w)}function qe(w){return w===0?"weekStart":w===1?"weekEnd":w===2?"current":"weekEnd"}function O(w,f,_,I,L=null,C=null,M=null,V=null){var U;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:w,stageId:f,totalCount:_,employeesCount:(I==null?void 0:I.length)||0,hasSnapshot:!!C,snapshotTicketIds:((U=C==null?void 0:C.ticketIds)==null?void 0:U.length)||0}),h.value=w,k.value=f||"",S.value=_,E.value=I||[],$.value=L&&L.count>0?L:null,H.value=C,Q.value=M,ae.value=V,v.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:k.value,hasCurrentSnapshot:!!H.value})}async function Y(w,f,_){var C,M,V,U,K,J,B;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:w,timePoint:f,hasMeta:!!_});const I=X.find(T=>T.id===w);if(!I){console.warn("[GraphStateChart] Stage not found:",w);return}const L={graphType:"line",stageId:w,stageName:I.name,timePoint:f,snapshots:i.value,meta:{line:_||null,doughnut:((V=(M=(C=u.value)==null?void 0:C.datasets)==null?void 0:M[0])==null?void 0:V.meta)||null},stageColorMap:G,stageNameMap:re.value};try{const T=await Xt({stageId:w,graphType:"line",timePoint:f,snapshots:i.value,meta:{line:_||null,doughnut:((J=(K=(U=u.value)==null?void 0:U.datasets)==null?void 0:K[0])==null?void 0:J.meta)||null},stageColorMap:G,stageNameMap:re.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:T.stageName,stageId:w,totalCount:T.totalCount,employeesCount:((B=T.employees)==null?void 0:B.length)||0,hasSnapshot:!!T.snapshot}),O(T.stageName,w,T.totalCount,T.employees,T.others,T.snapshot,null,L)}catch(T){console.error("[GraphStateChart] Failed to open modal for line point:",T),ke.error("Не удалось открыть попап для выбранной точки графика")}}function fe(w,f){var L,C,M;if(!f||!f.employees||f.employees.length===0){ke.warning("Нет данных о сотрудниках для этого этапа");return}const _=i.value.current||i.value.weekEnd||i.value.weekStart,I={graphType:"doughnut",stageId:w,stageName:f.stageName,snapshots:i.value,meta:{doughnut:((M=(C=(L=u.value)==null?void 0:L.datasets)==null?void 0:C[0])==null?void 0:M.meta)||null},stageColorMap:G,stageNameMap:re.value};O(f.stageName,w,f.totalCount,f.employees,f.others,_,null,I)}function Se(){v.value=!1,h.value="",k.value="",S.value=0,E.value=[],$.value=null,H.value=null,Q.value=null}async function he(w,f,_){if(d.value!=="line"||f.length===0)return;const I=f[0],L=I.datasetIndex,C=I.index,M=_.data.datasets[L];if(!M)return;const V=Ne(M.label),U=qe(C);await Y(V,U,M.meta||null)}function Me(w,f,_){var J,B;if(d.value!=="doughnut"||f.length===0)return;const L=f[0].index,C=_.data,M=C.labels[L],V=Ne(M),U=(B=(J=C.datasets[0])==null?void 0:J.meta)==null?void 0:B.employees,K=U==null?void 0:U[V];if(!K){console.warn("Данные о сотрудниках не найдены для этапа:",V);return}fe(V,K)}function Xe(w){var I;const f=X[w];if(!f)return 0;const _=i.value.current||i.value.weekEnd||i.value.weekStart;return!_||!_.statistics||!_.statistics.stages?0:((I=_.statistics.stages[f.id])==null?void 0:I.count)||0}function m(w){var L;const f=X.find(C=>C.id===w);if(!f)return"";const _=i.value.current||i.value.weekEnd||i.value.weekStart;if(!_||!_.statistics||!_.statistics.stages)return f.name;const I=((L=_.statistics.stages[w])==null?void 0:L.count)||0;return`${f.name} (${I})`}const y=ee(()=>{if(!u.value)return null;if(d.value==="doughnut"||d.value==="bar")return u.value;const w=u.value.datasets.filter(f=>{const _=X.find(I=>I.name===f.label);return _?$e.value[_.id]:!0});return{...u.value,datasets:w}});ee(()=>d.value!=="bar"||!u.value||!u.value.meta?null:u.value.meta.employeesByStage||null);const b=ee(()=>{const w={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(f,_,I)=>{d.value==="line"?he(f,_,I):d.value==="doughnut"&&Me(f,_,I)},onHover:(f,_,I)=>{d.value==="doughnut"&&(f.native.target.style.cursor=_.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",labels:{font:{size:d.value==="doughnut"?14:12,weight:d.value==="doughnut"?"600":"500"},boxWidth:d.value==="doughnut"?18:12,boxHeight:d.value==="doughnut"?18:12,padding:d.value==="doughnut"?14:10},onClick:(f,_,I)=>{if(d.value==="bar"){const C=_.datasetIndex;if(C!==void 0){const M=I.chart.getDatasetMeta(C);M.hidden=!M.hidden,I.chart.update()}return}const L=_.datasetIndex;if(L!==void 0){const C=I.chart.getDatasetMeta(L);C.hidden=!C.hidden,I.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:f=>{if(d.value==="bar"){const _=f[0].dataIndex,I=X[_];return I?I.name:""}return f[0].label||""},label:f=>{var C,M,V,U,K,J;const _=f.dataset.label||"",I=f.parsed.y||f.parsed||0,L=f.dataIndex;if(d.value==="bar"){const B=f.dataset,T=f.dataIndex,z=X[T],se=z?z.name:"";return`${B.label}: ${I} тикетов на этапе "${se}"`}if(d.value==="doughnut"){const B=f.dataset.data.reduce((z,se)=>z+se,0),T=B>0?(I/B*100).toFixed(1):0;return`${_}: ${I} тикетов (${T}%)`}else{if(!r.value||L===0)return`${_}: ${I} тикетов`;let B=null;const T=we(_);if(p.value==="weekStartToWeekEnd"&&L===1?B=(M=(C=r.value.weekStartToWeekEnd)==null?void 0:C.stages)==null?void 0:M[T]:p.value==="weekEndToCurrent"&&L===2&&i.value.current?B=(U=(V=r.value.weekEndToCurrent)==null?void 0:V.stages)==null?void 0:U[T]:p.value==="weekStartToCurrent"&&L===2&&i.value.current&&(B=(J=(K=r.value.weekStartToCurrent)==null?void 0:K.stages)==null?void 0:J[T]),!B)return`${_}: ${I} тикетов`;const z=B.delta,se=B.deltaPercent,ve=B.trend;let Ee=`${_}: ${I} тикетов`;if(z!==0){const Fe=z>0?"+":"",Re=ve==="increase"?"↑":ve==="decrease"?"↓":"→";Ee+=` (${Fe}${z}, ${Fe}${se.toFixed(1)}%) ${Re}`}else Ee+=" (без изменений)";return Ee}},afterBody:f=>{if(d.value==="bar"&&f.length>0){const C=f[0];C.dataset;const M=C.parsed.y||0,V=C.dataIndex,U=Xe(V);return[`${U>0?(M/U*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&f.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const C=[];if(r.value){const M=f[0].dataIndex;if(M!==0){let V=null;if(we(f[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&M===1?V=r.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&M===2?V=r.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&M===2&&(V=r.value.weekStartToCurrent),V&&V.metadata){const U=V.metadata.timeDiff;C.push(`Период: ${U.days} дн. ${U.hours} ч. ${U.minutes} мин.`)}}}return C.push("Кликните для детализации по сотрудникам"),C}if(!r.value)return[];const _=f[0].dataIndex;if(_===0)return[];let I=null;if(we(f[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&_===1?I=r.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&_===2?I=r.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&_===2&&(I=r.value.weekStartToCurrent),!I||!I.metadata)return[];const L=I.metadata.timeDiff;return[`Период: ${L.days} дн. ${L.hours} ч. ${L.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...w,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...w,cutout:"60%"}:w});function N(w){const f=new Date(w),_=f.getFullYear(),I=String(f.getMonth()+1).padStart(2,"0"),L=String(f.getDate()).padStart(2,"0");return`${_}-${I}-${L}`}function q(w){const{current:f,weekEnd:_}=w,I=f||_;if(!I||!I.statistics||!I.statistics.stages)return null;const L=[],C=[],M=[],V=[],U={},K={};if(X.forEach(B=>{var z;const T=((z=I.statistics.stages[B.id])==null?void 0:z.count)||0;if(T>0){L.push(`${B.name} (${T})`),C.push(T),M.push(B.color+"80"),V.push(B.color),K[B.id]=T;const se=Oa(B.id,I,X);se&&se.employees&&(U[B.id]=se)}}),C.length===0)return null;const J=C.reduce((B,T)=>B+T,0);return{labels:L,datasets:[{label:"Распределение по этапам",data:C,backgroundColor:M,borderColor:V,borderWidth:2,meta:{employees:U,totals:{overall:J,stages:K}}}]}}function W(w){if(d.value==="doughnut")return q(w);if(d.value==="bar"){const M=a.showCurrentState&&w.current?"current":w.weekEnd?"weekEnd":"weekStart";return Pa(w,M,X)}const{weekStart:f,weekEnd:_,current:I}=w,L=[],C=[];return X.forEach((M,V)=>{var se,ve,Ee,Fe,Re,bt,wt,St,Et,Ct,Dt,_t,Tt,At,It,$t,Nt;const U=[];if(f&&f.statistics&&f.statistics.stages){const le=f.statistics.stages[M.id];if(L.length===0){const Je=(se=f.metadata)!=null&&se.createdAt?new Date(f.metadata.createdAt):null;L.push(Je?N(Je):"Начало недели")}U.push((le==null?void 0:le.count)||0)}else L.length===0&&L.push("Начало недели"),U.push(0);if(_&&_.statistics&&_.statistics.stages){const le=_.statistics.stages[M.id];if(L.length===1){const Je=(ve=_.metadata)!=null&&ve.createdAt?new Date(_.metadata.createdAt):null;L.push(Je?N(Je):"Конец недели")}U.push((le==null?void 0:le.count)||0)}else L.length===1&&L.push("Конец недели"),U.push(0);if(I&&a.showCurrentState&&I.statistics&&I.statistics.stages){const le=I.statistics.stages[M.id];L.length===2&&L.push("Текущее состояние"),U.push((le==null?void 0:le.count)||0)}const K=["stable"];r.value?p.value==="weekStartToWeekEnd"?(K.push(((Re=(Fe=(Ee=r.value.weekStartToWeekEnd)==null?void 0:Ee.stages)==null?void 0:Fe[M.id])==null?void 0:Re.trend)||"stable"),I&&K.push(((St=(wt=(bt=r.value.weekStartToCurrent)==null?void 0:bt.stages)==null?void 0:wt[M.id])==null?void 0:St.trend)||"stable")):p.value==="weekEndToCurrent"&&I?(K.push("stable"),K.push(((Dt=(Ct=(Et=r.value.weekEndToCurrent)==null?void 0:Et.stages)==null?void 0:Ct[M.id])==null?void 0:Dt.trend)||"stable")):p.value==="weekStartToCurrent"&&I?(K.push(((At=(Tt=(_t=r.value.weekStartToWeekEnd)==null?void 0:_t.stages)==null?void 0:Tt[M.id])==null?void 0:At.trend)||"stable"),K.push(((Nt=($t=(It=r.value.weekStartToCurrent)==null?void 0:It.stages)==null?void 0:$t[M.id])==null?void 0:Nt.trend)||"stable")):(K.push("stable"),I&&K.push("stable")):(K.push("stable"),I&&K.push("stable"));let J,B,T;r.value&&d.value!=="doughnut"?(J=K.map(le=>me(le,"background")+"40"),B=K.map(le=>me(le,"border")),T=K.map(le=>me(le,"point"))):(J=M.color+"40",B=M.color,T=M.color);let z=null;d.value==="line"&&(z={employees:Ha(M.id,w)}),C.push({label:M.name,data:U,backgroundColor:(Array.isArray(J),J),borderColor:(Array.isArray(B),B),borderWidth:2,...d.value==="line"&&{pointStyle:pe[V%pe.length]},pointBackgroundColor:(Array.isArray(T),T),pointBorderColor:(Array.isArray(B),B),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:z})}),L.length===0&&(L.push("Начало недели","Конец недели"),a.showCurrentState&&L.push("Текущее состояние")),{labels:L,datasets:C}}const te=async()=>{var w,f,_;o.value=!0,l.value=null;try{const I=(w=a.period)!=null&&w.endDate?new Date(a.period.endDate):new Date,L=(f=a.period)!=null&&f.startDate?new Date(a.period.startDate):_e.getWeekStartDate(I),C=(_=a.period)!=null&&_.endDate?new Date(a.period.endDate):_e.getWeekEndDate(I),M=_e.formatDate(L),V=_e.formatDate(C),[U,K]=await Promise.all([_e.getSnapshot(M,"week_start"),_e.getSnapshot(V,"week_end")]);let J=null;a.showCurrentState&&(J=await ht.getSectorDataForSnapshot({useCache:!1,normalize:!0})),i.value={weekStart:U,weekEnd:K,current:J},je(),be(),R(),n("data-loaded",{weekStart:U,weekEnd:K,current:J})}catch(I){console.error("Error loading chart data:",I),l.value=I.message||"Ошибка загрузки данных графика",ke.error("Ошибка загрузки данных графика: "+l.value),n("error",l.value)}finally{o.value=!1}};Pe(()=>{Qe.register(Vn),Qe.register(Yn),Qe.register(Gn),te()});function ie(w){$e.value=w}const R=()=>{var f;const w=W({weekStart:i.value.weekStart,weekEnd:i.value.weekEnd,current:i.value.current});if(!u.value||!u.value.labels||u.value.labels.length!==((f=w==null?void 0:w.labels)==null?void 0:f.length))u.value=w;else if(w){const _=JSON.stringify(u.value),I=JSON.stringify(w);_!==I&&(u.value=w)}};return Ve(()=>[a.period,a.showCurrentState],()=>{te()},{deep:!0}),Ve(d,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&R()}),Ve(p,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&R()}),(w,f)=>(D(),A("div",qn,[c("div",Xn,[f[3]||(f[3]=c("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),c("div",Jn,[(D(),A(ce,null,ue(g,_=>c("button",{key:_.value,onClick:I=>d.value=_.value,class:ne(["chart-type-btn",{active:d.value===_.value}]),title:_.label},[c("span",Qn,x(_.icon),1),c("span",eo,x(_.label),1)],10,Zn)),64))])]),!o.value&&!l.value&&r.value&&d.value!=="doughnut"?(D(),A("div",to,[f[7]||(f[7]=c("h4",{class:"comparison-title"},"Тип сравнения:",-1)),c("div",ao,[c("label",null,[lt(c("input",{type:"radio","onUpdate:modelValue":f[0]||(f[0]=_=>p.value=_),value:"weekStartToWeekEnd",onChange:R},null,544),[[ut,p.value]]),f[4]||(f[4]=c("span",null,"Начало недели → Конец недели",-1))]),i.value.current?(D(),A("label",so,[lt(c("input",{type:"radio","onUpdate:modelValue":f[1]||(f[1]=_=>p.value=_),value:"weekEndToCurrent",onChange:R},null,544),[[ut,p.value]]),f[5]||(f[5]=c("span",null,"Конец недели → Текущее состояние",-1))])):Z("",!0),i.value.current?(D(),A("label",no,[lt(c("input",{type:"radio","onUpdate:modelValue":f[2]||(f[2]=_=>p.value=_),value:"weekStartToCurrent",onChange:R},null,544),[[ut,p.value]]),f[6]||(f[6]=c("span",null,"Начало недели → Текущее состояние",-1))])):Z("",!0)])])):Z("",!0),!o.value&&!l.value&&u.value?(D(),Ae(Sa,{key:1,stages:X,selected:$e.value,"onUpdate:selected":ie,onChange:R},null,8,["selected"])):Z("",!0),!o.value&&!l.value&&r.value&&d.value!=="doughnut"?(D(),A("div",oo,[...f[8]||(f[8]=[Jt('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):Z("",!0),o.value?(D(),Ae(Wt,{key:3,message:"Загрузка данных графика..."})):l.value?(D(),A("div",lo,[c("p",ro,"❌ "+x(l.value),1),c("button",{onClick:te,class:"btn-retry"},"Повторить загрузку")])):y.value?(D(),A("div",{key:5,class:ne(["chart-container",`chart-type-${d.value}`])},[c("div",io,[c("div",co,[(D(),Ae(Zt(P.value),{data:y.value,options:b.value},null,8,["data","options"]))]),d.value==="bar"?(D(),A("div",uo,[(D(),A(ce,null,ue(X,_=>c("div",{key:_.id,class:"stage-label-item"},x(m(_.id)),1)),64))])):Z("",!0)])],2)):(D(),A("div",po,[...f[9]||(f[9]=[c("p",null,"📊 Нет данных для отображения",-1),c("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),de(Ln,{"is-visible":v.value,"stage-name":h.value,"stage-id":k.value,"total-count":S.value,employees:E.value,others:$.value,snapshot:H.value,"ticket-details":Q.value,"stage-switch-context":ae.value,onClose:Se},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},mo=Ie(go,[["__scopeId","data-v-cbba196a"]]),fo={key:0,class:"create-snapshot-button-container"},ho=["disabled"],yo={class:"modal-content"},vo={class:"modal-header"},ko=["disabled"],bo={class:"modal-body"},wo={key:0,class:"progress-container"},So={class:"progress-bar-wrapper"},Eo={class:"progress-text"},Co={class:"progress-percent"},Do={class:"progress-description"},_o={key:1},To={class:"modal-footer"},Ao=["disabled"],Io=["disabled"],$o={key:0},No={key:0},Mo={key:1},Fo={key:2},Ro={key:1},Lo={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(s,{emit:t}){const e=s,a=t,n=F(e.user),o=F(!1),l=F(!1),u=F(0),i=F("idle"),r=F(""),p=st(),g=ee(()=>n.value?Qt(n.value):!1);Pe(async()=>{if(!e.user)try{const S=await zt.checkAccess();S.allowed&&(n.value=S.user)}catch(S){console.error("Error loading user:",S)}});const d=()=>{if(!g.value){p.warning("Только администраторы могут создавать слепки");return}o.value=!0},v=()=>{l.value||(o.value=!1,i.value="idle",u.value=0,r.value="")},h=async()=>{if(!l.value){if(!g.value){p.warning("Только администраторы могут создавать слепки");return}l.value=!0,i.value="loading_data",u.value=0,r.value="Инициализация загрузки данных...";try{r.value="Загрузка данных сектора из Bitrix24...";const S=await ht.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:H=>{var ae;const Q=Math.min(80,(H.progress||0)*.8);u.value=Q,i.value="loading_data",r.value=H.description||((ae=H.details)==null?void 0:ae.description)||"Загрузка данных сектора..."}});i.value="creating_snapshot",u.value=85,r.value="Создание слепка...";const E=n.value;if(!E)throw new Error("Пользователь не определён");const $=await _e.createSnapshot(S,"manual",{createdBy:{id:E.ID,name:`${E.NAME||""} ${E.LAST_NAME||""}`.trim()||E.EMAIL||`User ${E.ID}`},sectorId:"1C"});i.value="success",u.value=100,r.value="Слепок успешно создан!",p.success("Слепок состояния сектора успешно создан"),a("snapshot-created",$),setTimeout(()=>{v()},1500)}catch(S){i.value="error",u.value=0,r.value="Ошибка создания слепка",console.error("Error creating snapshot:",S);let E="Ошибка создания слепка";S.message&&(S.message.includes("загрузки данных")||S.message.includes("sector data")?E="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":S.message.includes("создания слепка")||S.message.includes("snapshot")?E="Не удалось создать слепок. Обратитесь в поддержку.":S.message.includes("валидац")||S.message.includes("validation")?E="Ошибка валидации данных. Проверьте данные сектора.":E=S.message),p.error(E)}finally{l.value=!1}}},k=S=>{S.key==="Escape"&&o.value&&!l.value&&v()};return Pe(()=>{window.addEventListener("keydown",k)}),ct(()=>{window.removeEventListener("keydown",k)}),(S,E)=>g.value?(D(),A("div",fo,[c("button",{class:"create-snapshot-btn",onClick:d,disabled:l.value,title:"Создать слепок состояния сектора"},[...E[1]||(E[1]=[c("span",{class:"btn-icon"},"📸",-1),c("span",{class:"btn-text"},"Создать слепок",-1)])],8,ho),(D(),Ae(Ut,{to:"body"},[de(at,{name:"modal"},{default:Te(()=>[o.value?(D(),A("div",{key:0,class:"modal-overlay",onClick:E[0]||(E[0]=oe($=>!l.value&&v(),["self"]))},[c("div",yo,[c("div",vo,[E[2]||(E[2]=c("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),c("button",{class:"modal-close",onClick:v,disabled:l.value,"aria-label":"Закрыть"}," ✕ ",8,ko)]),c("div",bo,[i.value!=="idle"?(D(),A("div",wo,[c("div",So,[c("div",{class:"progress-bar",style:ye({width:`${u.value}%`})},null,4)]),c("div",Eo,[c("span",Co,x(Math.round(u.value))+"%",1),c("span",Do,x(r.value),1)])])):(D(),A("div",_o,[...E[3]||(E[3]=[c("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),c("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),c("div",To,[c("button",{class:"btn btn-secondary",onClick:v,disabled:l.value}," Отмена ",8,Ao),c("button",{class:"btn btn-primary",onClick:h,disabled:l.value},[l.value?(D(),A("span",$o,[i.value==="loading_data"?(D(),A("span",No,"Загрузка данных...")):i.value==="creating_snapshot"?(D(),A("span",Mo,"Создание...")):(D(),A("span",Fo,"Обработка..."))])):(D(),A("span",Ro,"Создать"))],8,Io)])])])):Z("",!0)]),_:1})]))])):Z("",!0)}},xo=Ie(Lo,[["__scopeId","data-v-09bccee2"]]),Ho=20,Po=5*60*1e3;async function Oo({search:s="",limit:t=Ho,sectorDepartmentId:e=Pt.SECTOR_1C}={}){const a=`sector1c_employees_${s}_${t}_${e||"all"}`,n=sessionStorage.getItem(a);if(n)try{const{data:o,timestamp:l}=JSON.parse(n);if(Date.now()-l<Po)return o}catch(o){console.warn("[sector1cEmployees] Cache parse error:",o)}try{const o={ACTIVE:"Y"};e?Array.isArray(e)?o.UF_DEPARTMENT=e:o.UF_DEPARTMENT=[e]:o.UF_DEPARTMENT=[Pt.SECTOR_1C],s&&s.length>=2&&(o["%NAME"]=s,o["%LAST_NAME"]=s,o["%WORK_POSITION"]=s);const i=((await ft.call("user.get",{filter:o,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(r=>({id:parseInt(r.ID),name:Bo(r),position:r.WORK_POSITION||"",department:r.UF_DEPARTMENT||null}));try{sessionStorage.setItem(a,JSON.stringify({data:i,timestamp:Date.now()}))}catch(r){console.warn("[sector1cEmployees] Cache write error:",r)}return i}catch(o){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",o),new Error(`Не удалось загрузить сотрудников: ${o.message}`)}}function Bo(s){const t=[s.LAST_NAME,s.NAME,s.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):s.NAME||"Без имени"}const jo={class:"employee-select-field-text"},Uo={key:0,class:"employee-select-dropdown"},Wo={class:"employee-select-dropdown-search"},zo={key:0,class:"employee-select-state"},Vo={key:1,class:"employee-select-state employee-select-state--error"},Ko={key:2,class:"employee-select-state"},Yo=["checked"],Go=["checked","onChange"],qo={class:"employee-select-item-content"},Xo={class:"employee-select-item-name"},Jo={key:0,class:"employee-select-item-position"},Zo={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(s,{emit:t}){const e=s,a=t,n=F(null),o=F(null),l=F(""),u=F([]),i=F(!1),r=F(null),p=F(!1),g=ee(()=>{if(!l.value)return u.value;const j=l.value.toLowerCase();return u.value.filter(P=>P.name.toLowerCase().includes(j)||P.position&&P.position.toLowerCase().includes(j))}),d=ee(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const j=u.value.find(P=>P.id===e.selected[0]);return j?j.name:e.placeholder}return`Выбрано: ${e.selected.length} ${Q(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function v(j=""){i.value=!0,r.value=null;try{u.value=await Oo({search:j})}catch(P){r.value=P,a("error",P)}finally{i.value=!1}}function h(){a("search",l.value)}function k(){i.value||(p.value=!p.value,p.value?(u.value.length===0&&v(),ta(()=>{o.value&&o.value.focus()})):l.value="")}function S(j){n.value&&!n.value.contains(j.target)&&(p.value=!1,l.value="")}function E(j){const P=[...e.selected],G=P.indexOf(j);if(j==="all")if(G>-1)P.splice(G,1);else return a("update:selected",["all"]);else if(G>-1)P.splice(G,1);else{const X=P.indexOf("all");X>-1&&P.splice(X,1),P.push(j)}a("update:selected",P)}function $(j){return j==="all"?e.selected.includes("all"):e.selected.includes(j)||e.selected.includes("all")}const H=ee(()=>l.value?`Нет сотрудников по запросу "${l.value}"`:"Нет сотрудников сектора 1С");function Q(j,P,G,X){const re=j%10,pe=j%100;return pe>=11&&pe<=19?X:re===1?P:re>=2&&re<=4?G:X}function ae(){v(l.value)}return Ve(()=>e.selected,j=>{(!j||j.length===0)&&a("update:selected",["all"])},{immediate:!0}),Pe(()=>{document.addEventListener("click",S),(!e.selected||e.selected.length===0)&&a("update:selected",["all"])}),ct(()=>{document.removeEventListener("click",S)}),(j,P)=>(D(),A("div",{class:"employee-select",ref_key:"selectContainer",ref:n},[c("div",{class:ne(["employee-select-field",{"employee-select-field--open":p.value,"employee-select-field--disabled":i.value}]),onClick:k},[c("span",jo,x(d.value),1),c("span",{class:ne(["employee-select-field-icon",{open:p.value}])},"▼",2)],2),de(at,{name:"dropdown-fade"},{default:Te(()=>[p.value?(D(),A("div",Uo,[c("div",Wo,[lt(c("input",{"onUpdate:modelValue":P[0]||(P[0]=G=>l.value=G),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:h,onClick:P[1]||(P[1]=oe(()=>{},["stop"])),ref_key:"searchInput",ref:o},null,544),[[ea,l.value]])]),i.value?(D(),A("div",zo,[...P[6]||(P[6]=[c("span",{class:"spinner"},"⏳",-1),c("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):r.value?(D(),A("div",Vo,[c("span",null,"❌ "+x(r.value.message||"Ошибка загрузки сотрудников"),1),c("button",{onClick:[ae,P[2]||(P[2]=oe(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!i.value&&g.value.length===0&&!r.value?(D(),A("div",Ko,[c("span",null,"📭 "+x(H.value),1)])):(D(),A("div",{key:3,class:"employee-select-list",style:ye({maxHeight:`${s.maxHeight}px`})},[c("label",{class:ne(["employee-select-item",{"employee-select-item--selected":$("all")}]),onClick:P[4]||(P[4]=oe(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:$("all"),onChange:P[3]||(P[3]=G=>E("all"))},null,40,Yo),P[7]||(P[7]=c("div",{class:"employee-select-item-content"},[c("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(D(!0),A(ce,null,ue(g.value,G=>(D(),A("label",{key:G.id,class:ne(["employee-select-item",{"employee-select-item--selected":$(G.id)}]),onClick:P[5]||(P[5]=oe(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:$(G.id),onChange:X=>E(G.id)},null,40,Go),c("div",qo,[c("span",Xo,x(G.name),1),G.position?(D(),A("span",Jo,x(G.position),1)):Z("",!0)])],2))),128))],4))])):Z("",!0)]),_:1})],512))}},Qo=Ie(Zo,[["__scopeId","data-v-6b8c949b"]]),el={class:"stage-select-field-text"},tl={key:0,class:"stage-select-dropdown"},al={class:"stage-select-list"},sl=["checked"],nl=["checked","onChange"],ol={class:"stage-select-item-content"},ll={class:"stage-select-item-name"},rl={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(s,{emit:t}){const e=s,a=t,n=F(null),o=F(!1),l=ee(()=>Object.values(e.selected).every(d=>d===!0)),u=ee(()=>{if(l.value)return e.placeholder;const d=e.stages.filter(v=>e.selected[v.id]);return d.length===0?"Этапы не выбраны":d.length===1?d[0].name:`Выбрано: ${d.length} этапа(ов)`});function i(){o.value=!o.value,o.value}function r(d){n.value&&!n.value.contains(d.target)&&(o.value=!1)}function p(d,v){const h={...e.selected};h[d]=v,a("update:selected",h),a("change",d,v)}function g(){const d=l.value,v={};e.stages.forEach(h=>{v[h.id]=!d}),a("update:selected",v),a("change","all",!d)}return Pe(()=>{document.addEventListener("click",r)}),ct(()=>{document.removeEventListener("click",r)}),(d,v)=>(D(),A("div",{class:"stage-select",ref_key:"selectContainer",ref:n},[c("div",{class:ne(["stage-select-field",{"stage-select-field--open":o.value,"stage-select-field--disabled":!1}]),onClick:i},[c("span",el,x(u.value),1),c("span",{class:ne(["stage-select-field-icon",{open:o.value}])},"▼",2)],2),de(at,{name:"dropdown-fade"},{default:Te(()=>[o.value?(D(),A("div",tl,[c("div",al,[c("label",{class:ne(["stage-select-item",{"stage-select-item--selected":l.value}]),onClick:v[0]||(v[0]=oe(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:l.value,onChange:g},null,40,sl),v[2]||(v[2]=c("div",{class:"stage-select-item-content"},[c("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(D(!0),A(ce,null,ue(s.stages,h=>(D(),A("label",{key:h.id,class:ne(["stage-select-item",{"stage-select-item--selected":s.selected[h.id]}]),onClick:v[1]||(v[1]=oe(()=>{},["stop"]))},[c("input",{type:"checkbox",checked:s.selected[h.id],onChange:k=>p(h.id,k.target.checked)},null,40,nl),c("div",ol,[c("span",{class:"stage-select-item-color",style:ye({backgroundColor:h.color})},null,4),c("span",ll,x(h.name),1)])],2))),128))])])):Z("",!0)]),_:1})],512))}},il=Ie(rl,[["__scopeId","data-v-ce2229b2"]]),cl={class:"filters-panel"},ul={class:"filters-header"},dl=["disabled"],pl={class:"filters-content"},gl={class:"filter-section"},ml={class:"section-content"},fl={class:"filter-section"},hl={class:"section-content"},yl={class:"filter-section"},vl={class:"section-content"},kl=["value"],bl={key:0,class:"custom-date-range"},wl={class:"date-range-inputs"},Sl={class:"date-input-group"},El=["value","max"],Cl={class:"date-input-group"},Dl=["value","min","max"],_l={key:0,class:"filter-error"},Tl={key:1,class:"filter-hint"},Al={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(s,{emit:t}){const e=s,a=t,n=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],o=F(null),l=ee(()=>{const h=new Date;return h.setFullYear(h.getFullYear()-1),h.toISOString().split("T")[0]}),u=ee(()=>new Date().toISOString().split("T")[0]);function i(h){a("update:stages",h),a("apply")}function r(h,k){a("apply")}function p(h){a("update:employees",h),a("apply")}function g(h){a("update:dateRange",h),o.value=null,a("apply")}function d(h,k){const S={...e.customDateRange};if(S[h]=k,S.startDate&&S.endDate){const E=new Date(S.startDate),$=new Date(S.endDate);if(E>$){o.value="Начальная дата не может быть больше конечной";return}if(Math.ceil(($-E)/(1e3*60*60*24))>365){o.value="Период не может превышать 365 дней";return}}o.value=null,a("update:customDateRange",S),a("apply")}function v(){o.value=null,a("reset")}return(h,k)=>(D(),A("div",cl,[c("div",ul,[k[3]||(k[3]=c("h2",null,"Фильтры",-1)),c("button",{onClick:v,class:"btn-reset-filters",disabled:!s.hasActiveFilters}," Сбросить фильтры ",8,dl)]),c("div",pl,[c("div",gl,[k[4]||(k[4]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"📊"),et(" Этапы ")],-1)),c("div",ml,[de(il,{selected:s.stages,stages:n,placeholder:"Выберите этапы","onUpdate:selected":i,onChange:r},null,8,["selected"])])]),c("div",fl,[k[5]||(k[5]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"👥"),et(" Сотрудники сектора 1С ")],-1)),c("div",hl,[de(Qo,{selected:s.employees,"onUpdate:selected":p},null,8,["selected"])])]),c("div",yl,[k[9]||(k[9]=c("h3",{class:"section-title"},[c("span",{class:"section-icon"},"📅"),et(" Период ")],-1)),c("div",vl,[c("select",{value:s.dateRange,onChange:k[0]||(k[0]=S=>g(S.target.value)),class:"date-range-select"},[...k[6]||(k[6]=[c("option",{value:"last-week"},"Последняя неделя",-1),c("option",{value:"last-2-weeks"},"Последние 2 недели",-1),c("option",{value:"last-month"},"Последний месяц",-1),c("option",{value:"custom"},"Произвольный период",-1)])],40,kl),s.dateRange==="custom"?(D(),A("div",bl,[c("div",wl,[c("div",Sl,[k[7]||(k[7]=c("label",null,"С:",-1)),c("input",{type:"date",value:s.customDateRange.startDate,onChange:k[1]||(k[1]=S=>d("startDate",S.target.value)),max:s.customDateRange.endDate||u.value,class:"date-input"},null,40,El)]),c("div",Cl,[k[8]||(k[8]=c("label",null,"По:",-1)),c("input",{type:"date",value:s.customDateRange.endDate,onChange:k[2]||(k[2]=S=>d("endDate",S.target.value)),min:s.customDateRange.startDate||l.value,max:u.value,class:"date-input"},null,40,Dl)])]),o.value?(D(),A("small",_l,x(o.value),1)):(D(),A("small",Tl," Выберите начальную и конечную дату для отображения данных "))])):Z("",!0)])])])]))}},Il=Ie(Al,[["__scopeId","data-v-4b7456a2"]]);function $l(){const s=F(!1),t=F(null),e=F(null),a=F(0),n=st(),o=async(S=!0,E=null)=>{s.value=!0,t.value=null,a.value=0;try{const $=await ht.getSectorDataForSnapshot({useCache:S,onProgress:H=>{H&&typeof H.progress=="number"&&(a.value=H.progress),E&&E(H)},normalize:!0});return e.value=$,$}catch($){throw t.value=$.message||"Ошибка загрузки данных сектора",n.error("Ошибка загрузки данных сектора: "+t.value),$}finally{s.value=!1,a.value=100}},l=async(S,E={})=>{if(!e.value){const $="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=$,n.error($),new Error($)}s.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(S))throw new Error(`Неверный тип слепка: ${S}. Допустимые значения: week_start, week_end, manual, current`);const $=await _e.createSnapshot(e.value,S,E);return n.success("Слепок успешно создан"),$}catch($){throw t.value=$.message||"Ошибка создания слепка",n.error("Ошибка создания слепка: "+t.value),$}finally{s.value=!1}},u=()=>{s.value=!1,t.value=null,e.value=null,a.value=0},i=ee(()=>e.value!==null&&e.value!==void 0),r=F({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),p=ee(()=>{const S=new Date;let E,$;switch(r.value.dateRange){case"last-week":E=new Date(S),E.setDate(S.getDate()-7),$=S;break;case"last-2-weeks":E=new Date(S),E.setDate(S.getDate()-14),$=S;break;case"last-month":E=new Date(S),E.setMonth(S.getMonth()-1),$=S;break;case"custom":E=r.value.customDateRange.startDate?new Date(r.value.customDateRange.startDate):null,$=r.value.customDateRange.endDate?new Date(r.value.customDateRange.endDate):null;break;default:E=new Date(S),E.setDate(S.getDate()-7),$=S}return{startDate:E?E.toISOString().split("T")[0]:null,endDate:$?$.toISOString().split("T")[0]:null}}),g=()=>{v()},d=()=>{r.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},v()},v=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(r.value))}catch(S){console.error("Ошибка сохранения фильтров в localStorage:",S)}},h=()=>{try{const S=localStorage.getItem("graphStateFilters");if(S){const E=JSON.parse(S);E&&typeof E=="object"&&(r.value={stages:E.stages||{formed:!0,review:!0,execution:!0},employees:E.employees||["all"],dateRange:E.dateRange||"last-week",customDateRange:E.customDateRange||{startDate:null,endDate:null}})}}catch(S){console.error("Ошибка загрузки фильтров из localStorage:",S)}},k=ee(()=>{const S=Object.values(r.value.stages).some(H=>!H),E=!r.value.employees.includes("all"),$=r.value.dateRange!=="last-week";return S||E||$});return{isLoading:s,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:i,filters:r,selectedPeriod:p,hasActiveFilters:k,loadSectorDataForSnapshot:o,createSnapshot:l,resetState:u,applyFilters:g,resetFilters:d,saveFiltersToLocalStorage:v,loadFiltersFromLocalStorage:h}}const Nl={class:"graph-state-dashboard"},Ml={key:1,class:"error-message-container"},Fl={class:"error-message"},Rl={class:"error-text"},Ll={key:0,class:"error-details"},xl={class:"dashboard-header"},Hl={class:"header-content"},Pl={class:"breadcrumbs-row"},Ol=["aria-disabled","data-fallback","disabled"],Bl={class:"breadcrumbs","aria-label":"Навигация"},jl={class:"header-actions"},Ul=["disabled"],Wl={key:0},zl={key:1},Vl={key:3,class:"dashboard-content"},Kl={class:"chart-container"},Yl="Назад",Gl={__name:"GraphStateDashboard",setup(s){const t=(O,Y)=>typeof window>"u"?Y:getComputedStyle(document.documentElement).getPropertyValue(O).trim()||Y,e=st(),a=aa(),n={name:"dashboard-sector-1c"},{filters:o,selectedPeriod:l,hasActiveFilters:u,applyFilters:i,resetFilters:r,loadFiltersFromLocalStorage:p}=$l(),g=F(null),d=F(!0),v=F(!1),h=F("Загрузка данных..."),k=F(null),S=F(!1),E=F(!1),$=F(typeof window<"u"?window.innerWidth:1024),H=F(null),Q=F(!1),ae=ee(()=>$.value<768);ee(()=>$.value>=768&&$.value<1024),ee(()=>$.value>=1024);const j=ee(()=>typeof window>"u"?!1:window.history.length>1);ee(()=>{const O=new Date;return O.setFullYear(O.getFullYear()-1),O.toISOString().split("T")[0]}),ee(()=>new Date().toISOString().split("T")[0]);function P(O){o.value.stages=O}function G(O){o.value.employees=O}function X(O){o.value.dateRange=O}function re(O){o.value.customDateRange=O}function pe(){i()}function $e(){r(),H.value=null,pe(),e.info("Фильтры сброшены")}function ke(O){e.success("Слепок успешно создан")}function Be(O){v.value=!1,h.value="",console.log("Данные графика загружены:",O)}function Ge(O){v.value=!1,je({message:O||"Ошибка загрузки графика",details:null,type:"error"})}function je(O){k.value={message:O.message||"Произошла ошибка",details:O.details||null,type:O.type||"error",timestamp:new Date},console.error("Dashboard error:",k.value),e.error(k.value.message)}function me(){k.value=null}function be(){k.value=null,v.value=!0,h.value="Повторная загрузка данных..."}async function Ue(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}S.value=!0;try{const O=document.querySelector(".chart-container");if(!O)throw new Error("График не найден");const Y=window.html2canvas,fe=await Y(O,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Se=window.jsPDF,he=new Se("landscape","mm","a4"),Me=297,Xe=fe.height*Me/fe.width;he.setFontSize(18),he.text("График состояния сектора 1С",148.5,15,{align:"center"});const m=new Date().toLocaleDateString("ru-RU");he.setFontSize(10);const y=l.value.startDate&&l.value.endDate?`Период: ${l.value.startDate} - ${l.value.endDate}`:"Период: не указан";he.text(y,148.5,25,{align:"center"}),he.text(`Экспорт от ${m}`,148.5,30,{align:"center"}),he.addImage(fe.toDataURL("image/png"),"PNG",10,35,Me-20,Xe-20),he.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${m}`,author:"Bitrix24 Dashboard"});const b=`graph-state-${m.replace(/\//g,"-")}.pdf`;he.save(b),e.success("График успешно экспортирован в PDF")}catch(O){console.error("Ошибка экспорта в PDF:",O),je({message:"Ошибка экспорта в PDF: "+(O.message||"Неизвестная ошибка"),details:O.stack,type:"error"})}finally{S.value=!1}}function we(O){var Y;if((Y=O==null?void 0:O.preventDefault)==null||Y.call(O),!Q.value){Q.value=!0;try{if(j.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(n)}finally{Q.value=!1}}}function Ne(){typeof window<"u"&&($.value=window.innerWidth)}async function qe(){try{const O=await zt.checkAccess();O.allowed&&(g.value=O.user)}catch(O){console.error("Error loading user:",O)}}return Pe(()=>{p(),qe(),typeof window<"u"&&($.value=window.innerWidth,window.addEventListener("resize",Ne))}),ct(()=>{typeof window<"u"&&window.removeEventListener("resize",Ne)}),(O,Y)=>{const fe=sa("router-link");return D(),A("div",Nl,[v.value?(D(),Ae(Wt,{key:0,message:h.value},null,8,["message"])):Z("",!0),k.value?(D(),A("div",Ml,[c("div",Fl,[c("div",{class:"error-header"},[Y[1]||(Y[1]=c("span",{class:"error-icon"},"❌",-1)),Y[2]||(Y[2]=c("h3",null,"Ошибка",-1)),c("button",{onClick:me,class:"error-close","aria-label":"Закрыть"},"✕")]),c("p",Rl,x(k.value.message),1),k.value.details?(D(),A("div",Ll,[c("details",null,[Y[3]||(Y[3]=c("summary",null,"Детали ошибки",-1)),c("pre",null,x(k.value.details),1)])])):Z("",!0),c("div",{class:"error-actions"},[c("button",{onClick:be,class:"btn-retry"},"Повторить попытку")])])])):Z("",!0),c("div",xl,[c("div",Hl,[c("div",Pl,[c("button",{class:"btn-back-link",type:"button",onClick:we,"aria-label":Yl,"aria-disabled":!j.value,"data-fallback":!j.value,disabled:Q.value,title:"Назад"}," ← ",8,Ol),c("nav",Bl,[de(fe,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Te(()=>[...Y[4]||(Y[4]=[et(" Дашборд сектора 1С ",-1)])]),_:1}),Y[5]||(Y[5]=c("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),Y[6]||(Y[6]=c("span",{class:"breadcrumb-current"},"График состояния",-1))])]),Y[7]||(Y[7]=c("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),Y[8]||(Y[8]=c("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),c("div",jl,[c("button",{onClick:Ue,class:"btn-export-pdf",disabled:S.value||v.value,title:"Экспортировать график в PDF"},[S.value?(D(),A("span",zl,"⏳ Экспорт...")):(D(),A("span",Wl,"📄 Экспорт в PDF"))],8,Ul),de(xo,{user:g.value,onSnapshotCreated:ke},null,8,["user"])])]),ae.value?(D(),A("button",{key:2,class:"mobile-filters-toggle",onClick:Y[0]||(Y[0]=Se=>E.value=!E.value)},[Y[9]||(Y[9]=c("span",null,"Фильтры",-1)),c("span",{class:ne(["toggle-icon",{open:E.value}])},"▼",2)])):Z("",!0),c("div",{class:ne({"mobile-open":E.value&&ae.value,"mobile-closed":!E.value&&ae.value})},[de(Il,{stages:We(o).stages,employees:We(o).employees,dateRange:We(o).dateRange,customDateRange:We(o).customDateRange,hasActiveFilters:We(u),"onUpdate:stages":P,"onUpdate:employees":G,"onUpdate:dateRange":X,"onUpdate:customDateRange":re,onReset:$e,onApply:pe},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!v.value&&!k.value?(D(),A("div",Vl,[c("div",Kl,[de(mo,{period:We(l),"show-current-state":d.value,onDataLoaded:Be,onError:Ge},null,8,["period","show-current-state"])])])):Z("",!0)])}}},Zl=Ie(Gl,[["__scopeId","data-v-e995acfd"]]);export{Zl as default};
