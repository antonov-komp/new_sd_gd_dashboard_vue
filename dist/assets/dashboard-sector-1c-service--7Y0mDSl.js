var p=Object.defineProperty;var _=(d,e,t)=>e in d?p(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var y=(d,e,t)=>_(d,typeof e!="symbol"?e+"":e,t);import{B as c}from"./chunk-C5D5xwuQ.js";import{h as g,j as T,q as u,r as f}from"./chunk-CWOGIwxH.js";import"./chunk-B8ocRDN3.js";class m{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const t=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",t);const s=await this.getEmployeesByIds(t);return console.log("Loaded employees:",s.length),{stages:this.groupTicketsByStages(e,s),employees:s,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],t=[];for(const s of e){console.log(`Loading tickets for stage: ${s}`);const r=await this.getTicketsByStage(s);t.push(...r),console.log(`Loaded ${r.length} tickets for stage ${s}`)}return t}static async getTicketsByStage(e){const t=[];let s=0;const r=50;let n=!0;for(;n;)try{const a=await c.call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:s,useOriginalUfNames:"Y"});let o=[];a&&a.result&&(Array.isArray(a.result)?o=a.result:a.result.items&&Array.isArray(a.result.items)?o=a.result.items:a.result.data&&Array.isArray(a.result.data)&&(o=a.result.data)),o.length>0?(t.push(...o),s+=o.length,n=o.length===r):n=!1}catch(a){console.error(`Error loading tickets batch for stage ${e} (start: ${s}):`,a),n=!1}t.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(t[0],null,2)),console.log("Sample ticket keys:",Object.keys(t[0])),console.log("Sample ticket assignedById variants:",{assignedById:t[0].assignedById,assignedByIdId:t[0].assignedByIdId,ASSIGNED_BY_ID:t[0].ASSIGNED_BY_ID}));const l=t.filter(a=>{const o=a.UF_CRM_7_TYPE_PRODUCT||a.uf_crm_7_type_product||a.ufCrm7TypeProduct||a.UF_CRM_7_TYPE_PRODUCT||a.uf_crm_7_type_product;return Array.isArray(o)?o.includes(this.SECTOR_TAG):typeof o=="object"&&o!==null?o.value===this.SECTOR_TAG||o===this.SECTOR_TAG:o===this.SECTOR_TAG});return console.log(`Filtered ${l.length} tickets from ${t.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),l}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(s=>{const r=s.assignedById||s.assignedByIdId||s.ASSIGNED_BY_ID||s.assignedById||s.assignedById&&typeof s.assignedById=="object"&&(s.assignedById.id||s.assignedById.ID)||s.assignedById&&typeof s.assignedById=="object"&&s.assignedById.value;if(r){const n=parseInt(r);n&&!isNaN(n)&&n>0&&t.add(n)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(t))),Array.from(t)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await c.call("user.get",{filter:{ID:e}});let s=[];return t&&t.result&&(Array.isArray(t.result)?s=t.result:console.warn("Unexpected user.get result format:",t)),s.map(r=>({id:parseInt(r.ID||r.id||0),name:`${r.NAME||r.name||""} ${r.LAST_NAME||r.lastName||""}`.trim()||r.EMAIL||r.email||"Неизвестный",position:r.WORK_POSITION||r.workPosition||"Сотрудник",email:r.EMAIL||r.email||"",tickets:[]}))}catch(t){return console.error("Error getting employees by IDs:",t),[]}}static groupTicketsByStages(e,t){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(t)||(console.warn("Employees is not an array:",t),t=[]);const s=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:t.map(r=>({...r,tickets:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:t.map(r=>({...r,tickets:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:t.map(r=>({...r,tickets:[]}))}];return e.forEach(r=>{const n=this.mapStageId(r.stageId||r.STAGE_ID||""),l=s.find(a=>a.id===n);if(l){const a=r.assignedById||r.ASSIGNED_BY_ID||null,o=a?parseInt(a):null;if(o){let i=l.employees.find(I=>I.id===o);i||(i={id:o,name:`Сотрудник #${o}`,position:"Неизвестно",email:"",tickets:[]},l.employees.push(i)),i.tickets.push(this.mapTicket(r))}}}),s}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const t=parseInt(e.id||e.ID||0),s=e.title||e.TITLE||"Без названия",r=e.stageId||e.STAGE_ID||"",n=e.assignedById||e.ASSIGNED_BY_ID||null,l=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",a=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",o=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,i=g(o),I=T(i);return{id:t,title:s,priorityId:i.id,priorityLabel:i.label,priorityColors:I,priority:i.id,priorityBitrixValue:i.bitrixValue||null,status:this.mapStatus(r),assigneeId:n?parseInt(n):null,stageId:this.mapStageId(r),createdAt:l,modifiedAt:a,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return g(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const t=u(e);if(t&&t.bitrixValue)return t.bitrixValue;const s={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return s[e]?s[e]:u(f).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(s=>!(s.assignedById||s.ASSIGNED_BY_ID)).forEach(s=>{const r=this.mapStageId(s.stageId||s.STAGE_ID||"");t[r]&&t[r].push(this.mapTicket(s))}),t):(console.warn("Tickets is not an array in getZeroPointTickets:",e),t)}static async assignTicket(e,t,s){try{const r=this.mapStageIdToBitrix(s);return(await c.call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:t,stageId:r}})).result===!0}catch(r){throw console.error("Error assigning ticket:",r),r}}static async createTicket(e){try{const t=await c.call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const t=await c.call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await c.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:t}})).result!==void 0}catch(s){throw console.error("Error adding comment:",s),s}}}y(m,"ENTITY_TYPE_ID",140),y(m,"SECTOR_TAG","1C");export{m as DashboardSector1CService};
