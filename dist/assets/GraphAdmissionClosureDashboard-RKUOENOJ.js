import{_ as A,g as C,c as k,a as p,o as c,b as e,t as m,F as $,e as U,n as I,d as B,f as R,G as O,H as T,m as L,j as S,S as N,L as G}from"./main-CB9xjHMZ.js";import{F as x}from"./FiltersPanel-DhrfmcpW.js";import{L as E,D as P,B as V}from"./index-BLjWqGS2.js";import"./bitrix24-api-Irr5mCDD.js";const j={class:"ac-chart"},W={class:"ac-chart__header"},Z={class:"ac-chart__subtitle"},q={class:"ac-chart__controls"},z={class:"chart-type-selector"},H=["onClick"],X={class:"chart-type-icon"},Y={class:"chart-type-label"},J={class:"ac-chart__summary"},K={class:"summary-card summary-card--new"},Q={class:"summary-card__value"},ee={class:"summary-card summary-card--closed"},se={class:"summary-card__value"},te={class:"summary-card summary-card--stages"},ae={class:"summary-card__tags"},ne={key:0,class:"stage-tag stage-tag--empty"},oe={class:"ac-chart__body"},le={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(o,{emit:a}){const l=o,h=a,i=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],n=C("line"),t=k(()=>{var v;return((v=l.meta)==null?void 0:v.weekNumber)??"â€”"}),_=k(()=>{var w,s;const v=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],d=Array.isArray((w=l.data.series)==null?void 0:w.new)?l.data.series.new:[l.data.newTickets||0],D=Array.isArray((s=l.data.series)==null?void 0:s.closed)?l.data.series.closed:[l.data.closedTickets||0];return{labels:v,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:d,backgroundColor:T.primary,borderColor:T.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:D,backgroundColor:T.success,borderColor:T.success,tension:.3,fill:!1}]}}),b=k(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[l.data.newTickets||0,l.data.closedTickets||0],backgroundColor:[T.primary,T.success],borderWidth:1}]})),y=k(()=>{switch(n.value){case"line":return E;case"bar":return V;case"doughnut":return P;default:return E}}),g=k(()=>n.value==="doughnut"?b.value:_.value),u=k(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var v;(((v=l.data)==null?void 0:v.responsible)||[]).length>0&&h("open-responsible")},scales:n.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(v,d)=>{var D,w;return c(),p("div",j,[e("header",W,[e("div",null,[d[1]||(d[1]=e("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),e("p",Z," ÐÐµÐ´ÐµÐ»Ñ "+m(t.value)+" Â· "+m(((D=o.meta)==null?void 0:D.weekStartUtc)||"â€”")+" â€” "+m(((w=o.meta)==null?void 0:w.weekEndUtc)||"â€”")+" (UTC) ",1)]),e("div",q,[e("div",z,[(c(),p($,null,U(i,s=>e("button",{key:s.value,class:I(["chart-type-btn",{active:n.value===s.value}]),onClick:r=>n.value=s.value},[e("span",X,m(s.icon),1),e("span",Y,m(s.label),1)],10,H)),64))]),e("button",{class:"btn-link",onClick:d[0]||(d[0]=s=>v.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),e("section",J,[e("div",K,[d[2]||(d[2]=e("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",Q,m(o.data.newTickets??0),1)]),e("div",ee,[d[3]||(d[3]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",se,m(o.data.closedTickets??0),1)]),e("div",te,[d[4]||(d[4]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),e("div",ae,[(c(!0),p($,null,U(o.data.stages||[],s=>(c(),p("span",{key:s.stageId,class:"stage-tag"},m(s.stageId)+" â€” "+m(s.count),1))),128)),!o.data.stages||o.data.stages.length===0?(c(),p("span",ne," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):B("",!0)])])]),e("div",oe,[(c(),R(O(y.value),{data:g.value,options:u.value},null,8,["data","options"]))])])}}},re=A(le,[["__scopeId","data-v-9edf003d"]]),ie={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},ce={class:"modal"},de={class:"modal__header"},ue={class:"modal__body"},me={key:0,class:"modal__empty"},pe={key:1,class:"responsible-list"},he={class:"responsible-list__name"},ve={class:"responsible-list__avatar","aria-hidden":"true"},ge={class:"responsible-list__count"},_e={class:"modal__footer"},be={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]}},setup(o){const a=o,l=k(()=>(a.responsible||[]).length>0);function h(i){if(!i)return"â€”";const n=String(i).trim().split(/\s+/);return n.length===1?n[0].charAt(0).toUpperCase():`${n[0].charAt(0)}${n[1].charAt(0)}`.toUpperCase()}return(i,n)=>o.isVisible?(c(),p("div",ie,[e("div",ce,[e("header",de,[n[2]||(n[2]=e("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("button",{class:"modal__close",onClick:n[0]||(n[0]=t=>i.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),e("section",ue,[l.value?(c(),p("ul",pe,[(c(!0),p($,null,U(o.responsible,t=>(c(),p("li",{key:t.id||t.name,class:"responsible-list__item"},[e("div",he,[e("span",ve,m(h(t.name)),1),e("span",null,m(t.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1)]),e("div",ge,m(t.count??0),1)]))),128))])):(c(),p("p",me,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),e("footer",_e,[e("button",{class:"btn",onClick:n[1]||(n[1]=t=>i.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])])):B("",!0)}},ye=A(be,[["__scopeId","data-v-ac5a8b81"]]),fe="/api/graph-1c-admission-closure.php";function ke(){const o=typeof window<"u"?window.location.pathname:"",a=o.substring(0,o.lastIndexOf("/"));return(a.endsWith("/")?a.slice(0,-1):a)||""}function De(o){var l,h,i,n,t,_,b,y,g,u;if(!o)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const a=o.data||o.result||o;return{meta:a.meta||o.meta||null,data:{newTickets:((l=a.data)==null?void 0:l.newTickets)??a.newTickets??0,closedTickets:((h=a.data)==null?void 0:h.closedTickets)??a.closedTickets??0,series:{new:((n=(i=a.data)==null?void 0:i.series)==null?void 0:n.new)??((t=a.series)==null?void 0:t.new)??[0],closed:((b=(_=a.data)==null?void 0:_.series)==null?void 0:b.closed)??((y=a.series)==null?void 0:y.closed)??[0]},stages:((g=a.data)==null?void 0:g.stages)??a.stages??[],responsible:((u=a.data)==null?void 0:u.responsible)??a.responsible??[]}}}async function we(o={}){const{endpoint:a=fe,product:l="1C",weekStartUtc:h=null,weekEndUtc:i=null,useCache:n=!0,forceRefresh:t=!1}=o,_={product:l,weekStartUtc:h,weekEndUtc:i,useCache:n,forceRefresh:t},y=`${ke()}${a}`,g=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(_)});if(!g.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${g.status})`);const u=await g.json();if((u==null?void 0:u.success)===!1)throw new Error(u.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return De(u)}const Ce={class:"ac-dashboard"},Te={key:1},Re={class:"dashboard-grid"},$e={class:"filters-column"},Ue={class:"chart-column"},Ae={__name:"GraphAdmissionClosureDashboard",setup(o){const a=C(!0),l=C(null),h=C(null),i=C({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),n=C(!1),t=C({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),_=k(()=>{const s=t.value.customDateRange.startDate||t.value.customDateRange.endDate,r=t.value.employees.length===1&&t.value.employees.includes("all");return s||!r});async function b(){a.value=!0,l.value=null;try{const s=w(),{meta:r,data:f}=await we({product:"1C",weekStartUtc:s.weekStartUtc,weekEndUtc:s.weekEndUtc});h.value=r,i.value=f}catch(s){l.value=s instanceof Error?s:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",s)}finally{a.value=!1}}function y(s){t.value.stages=s}function g(s){t.value.employees=s}function u(s){t.value.dateRange=s}function v(s){t.value.customDateRange=s}function d(){t.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},D()}function D(){b()}L(()=>{b()});function w(){const s=new Date;let r=new Date(s),f=new Date(s);switch(t.value.dateRange){case"last-2-weeks":r.setDate(s.getDate()-14);break;case"last-month":r.setMonth(s.getMonth()-1);break;case"custom":t.value.customDateRange.startDate&&(r=new Date(t.value.customDateRange.startDate+"T00:00:00Z")),t.value.customDateRange.endDate&&(f=new Date(t.value.customDateRange.endDate+"T23:59:59Z"));break;case"last-week":default:r.setDate(s.getDate()-7);break}const F=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0)).toISOString(),M=new Date(Date.UTC(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),23,59,59)).toISOString();return{weekStartUtc:F,weekEndUtc:M}}return(s,r)=>(c(),p("div",Ce,[a.value?(c(),R(G,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(c(),p("div",Te,[r[2]||(r[2]=e("div",{class:"dashboard-header"},[e("div",null,[e("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),e("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),e("div",Re,[e("div",$e,[S(x,{stages:t.value.stages,employees:t.value.employees,dateRange:t.value.dateRange,customDateRange:t.value.customDateRange,hasActiveFilters:_.value,hideStages:!0,"onUpdate:stages":y,"onUpdate:employees":g,"onUpdate:dateRange":u,"onUpdate:customDateRange":v,onReset:d,onApply:D},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),e("div",Ue,[l.value?(c(),R(N,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:l.value.message},null,8,["message"])):(c(),R(re,{key:1,meta:h.value,data:i.value,onOpenResponsible:r[0]||(r[0]=f=>n.value=!0)},null,8,["meta","data"]))])])])),S(ye,{"is-visible":n.value,responsible:i.value.responsible||[],onClose:r[1]||(r[1]=f=>n.value=!1)},null,8,["is-visible","responsible"])]))}},Me=A(Ae,[["__scopeId","data-v-92f3df3e"]]);export{Me as default};
