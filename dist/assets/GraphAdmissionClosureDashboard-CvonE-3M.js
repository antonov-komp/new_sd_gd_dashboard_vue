var Z=Object.defineProperty;var x=(y,e,t)=>e in y?Z(y,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):y[e]=t;var M=(y,e,t)=>x(y,typeof e!="symbol"?e+"":e,t);import{_ as F,g as I,c as b,a as f,o as p,b as o,t as k,F as O,e as Y,n as q,d as P,f as R,G as J,H as S,I as V,j as B,k as N,B as L,T as X,l as K,m as Q,S as ee,L as te}from"./main-CTjTZ23-.js";import{F as se}from"./FiltersPanel-BVPnoR6N.js";import{L as W,D as ae,B as oe}from"./index-GJWqhde8.js";import{B as U,g as j,a as le,b as H,D as ne,T as re,c as ie}from"./priority-config-boaGNfvN.js";const ce={class:"ac-chart"},de={class:"ac-chart__header"},ue={class:"ac-chart__subtitle"},me={class:"ac-chart__controls"},ge={class:"chart-type-selector"},ye=["onClick"],pe={class:"chart-type-icon"},_e={class:"chart-type-label"},fe={class:"ac-chart__summary"},he={class:"summary-card summary-card--new"},ve={class:"summary-card__value"},Ie={class:"summary-card summary-card--closed"},Te={class:"summary-card__value"},ke={class:"summary-card summary-card--stages"},Ee={class:"summary-card__tags"},we={key:0,class:"stage-tag stage-tag--empty"},De={class:"ac-chart__body"},be={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(y,{emit:e}){const t=y,s=e,a=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],m=I("line"),d=b(()=>{var T;return((T=t.meta)==null?void 0:T.weekNumber)??"â€”"}),l=b(()=>{var E,n;const T=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],v=Array.isArray((E=t.data.series)==null?void 0:E.new)?t.data.series.new:[t.data.newTickets||0],D=Array.isArray((n=t.data.series)==null?void 0:n.closed)?t.data.series.closed:[t.data.closedTickets||0];return{labels:T,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:v,backgroundColor:S.primary,borderColor:S.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:D,backgroundColor:S.success,borderColor:S.success,tension:.3,fill:!1}]}}),g=b(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[t.data.newTickets||0,t.data.closedTickets||0],backgroundColor:[S.primary,S.success],borderWidth:1}]})),_=b(()=>{switch(m.value){case"line":return W;case"bar":return oe;case"doughnut":return ae;default:return W}}),h=b(()=>m.value==="doughnut"?g.value:l.value),w=b(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var T;(((T=t.data)==null?void 0:T.responsible)||[]).length>0&&s("open-responsible")},scales:m.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(T,v)=>{var D,E;return p(),f("div",ce,[o("header",de,[o("div",null,[v[1]||(v[1]=o("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),o("p",ue," ÐÐµÐ´ÐµÐ»Ñ "+k(d.value)+" Â· "+k(((D=y.meta)==null?void 0:D.weekStartUtc)||"â€”")+" â€” "+k(((E=y.meta)==null?void 0:E.weekEndUtc)||"â€”")+" (UTC) ",1)]),o("div",me,[o("div",ge,[(p(),f(O,null,Y(a,n=>o("button",{key:n.value,class:q(["chart-type-btn",{active:m.value===n.value}]),onClick:c=>m.value=n.value},[o("span",pe,k(n.icon),1),o("span",_e,k(n.label),1)],10,ye)),64))]),o("button",{class:"btn-link",onClick:v[0]||(v[0]=n=>T.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),o("section",fe,[o("div",he,[v[2]||(v[2]=o("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),o("div",ve,k(y.data.newTickets??0),1)]),o("div",Ie,[v[3]||(v[3]=o("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),o("div",Te,k(y.data.closedTickets??0),1)]),o("div",ke,[v[4]||(v[4]=o("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),o("div",Ee,[(p(!0),f(O,null,Y(y.data.stages||[],n=>(p(),f("span",{key:n.stageId,class:"stage-tag"},k(n.stageId)+" â€” "+k(n.count),1))),128)),!y.data.stages||y.data.stages.length===0?(p(),f("span",we," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):P("",!0)])])]),o("div",De,[(p(),R(J(_.value),{data:h.value,options:w.value},null,8,["data","options"]))])])}}},Ce=F(be,[["__scopeId","data-v-9edf003d"]]);class G{static async getSectorData(){try{const e=await this.getAllTickets();console.log("Total tickets loaded:",e.length);const t=this.extractUniqueEmployeeIds(e);console.log("Unique employee IDs:",t);const s=await this.getEmployeesByIds(t);return console.log("Loaded employees:",s.length),{stages:this.groupTicketsByStages(e,s),employees:s,zeroPointTickets:this.getZeroPointTickets(e)}}catch(e){throw console.error("Error getting sector data:",e),e}}static async getAllTickets(){const e=["DT140_12:UC_0VHWE2","DT140_12:PREPARATION","DT140_12:CLIENT"],t=[];for(const s of e){console.log(`Loading tickets for stage: ${s}`);const a=await this.getTicketsByStage(s);t.push(...a),console.log(`Loaded ${a.length} tickets for stage ${s}`)}return t}static async getTicketsByStage(e){const t=[];let s=0;const a=50;let m=!0;for(;m;)try{const l=await U.call("crm.item.list",{entityTypeId:this.ENTITY_TYPE_ID,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:s,useOriginalUfNames:"Y"});let g=[];l&&l.result&&(Array.isArray(l.result)?g=l.result:l.result.items&&Array.isArray(l.result.items)?g=l.result.items:l.result.data&&Array.isArray(l.result.data)&&(g=l.result.data)),g.length>0?(t.push(...g),s+=g.length,m=g.length===a):m=!1}catch(l){console.error(`Error loading tickets batch for stage ${e} (start: ${s}):`,l),m=!1}t.length>0&&(console.log("Sample ticket structure (full JSON):",JSON.stringify(t[0],null,2)),console.log("Sample ticket keys:",Object.keys(t[0])),console.log("Sample ticket assignedById variants:",{assignedById:t[0].assignedById,assignedByIdId:t[0].assignedByIdId,ASSIGNED_BY_ID:t[0].ASSIGNED_BY_ID}));const d=t.filter(l=>{const g=l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product||l.ufCrm7TypeProduct||l.UF_CRM_7_TYPE_PRODUCT||l.uf_crm_7_type_product;return Array.isArray(g)?g.includes(this.SECTOR_TAG):typeof g=="object"&&g!==null?g.value===this.SECTOR_TAG||g===this.SECTOR_TAG:g===this.SECTOR_TAG});return console.log(`Filtered ${d.length} tickets from ${t.length} for stage ${e} (sector tag: ${this.SECTOR_TAG})`),d}static extractUniqueEmployeeIds(e){if(!Array.isArray(e))return[];const t=new Set;return e.forEach(s=>{const a=s.assignedById||s.assignedByIdId||s.ASSIGNED_BY_ID||s.assignedById||s.assignedById&&typeof s.assignedById=="object"&&(s.assignedById.id||s.assignedById.ID)||s.assignedById&&typeof s.assignedById=="object"&&s.assignedById.value;if(a){const m=parseInt(a);m&&!isNaN(m)&&m>0&&t.add(m)}}),e.length>0&&(console.log("Sample ticket for employee extraction:",e[0]),console.log("Sample ticket assignedById variants:",{assignedById:e[0].assignedById,assignedByIdId:e[0].assignedByIdId,ASSIGNED_BY_ID:e[0].ASSIGNED_BY_ID}),console.log("Extracted employee IDs:",Array.from(t))),Array.from(t)}static async getEmployeesByIds(e){if(!Array.isArray(e)||e.length===0)return[];try{const t=await U.call("user.get",{filter:{ID:e}});let s=[];return t&&t.result&&(Array.isArray(t.result)?s=t.result:console.warn("Unexpected user.get result format:",t)),s.map(a=>({id:parseInt(a.ID||a.id||0),name:`${a.NAME||a.name||""} ${a.LAST_NAME||a.lastName||""}`.trim()||a.EMAIL||a.email||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",position:a.WORK_POSITION||a.workPosition||"Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº",email:a.EMAIL||a.email||"",tickets:[]}))}catch(t){return console.error("Error getting employees by IDs:",t),[]}}static groupTicketsByStages(e,t){Array.isArray(e)||(console.warn("Tickets is not an array:",e),e=[]),Array.isArray(t)||(console.warn("Employees is not an array:",t),t=[]);const s=[{id:"formed",name:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ",color:"#007bff",employees:t.map(a=>({...a,tickets:[]}))},{id:"review",name:"Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ Ð¢Ð—",color:"#ffc107",employees:t.map(a=>({...a,tickets:[]}))},{id:"execution",name:"Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ",color:"#28a745",employees:t.map(a=>({...a,tickets:[]}))}];return e.forEach(a=>{const m=this.mapStageId(a.stageId||a.STAGE_ID||""),d=s.find(l=>l.id===m);if(d){const l=a.assignedById||a.ASSIGNED_BY_ID||null,g=l?parseInt(l):null;if(g){let _=d.employees.find(h=>h.id===g);_||(_={id:g,name:`Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº #${g}`,position:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾",email:"",tickets:[]},d.employees.push(_)),_.tickets.push(this.mapTicket(a))}}}),s}static mapStageId(e){return{"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"}[e]||"formed"}static mapStageIdToBitrix(e){return{formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"}[e]||"DT140_12:UC_0VHWE2"}static mapTicket(e){const t=parseInt(e.id||e.ID||0),s=e.title||e.TITLE||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",a=e.stageId||e.STAGE_ID||"",m=e.assignedById||e.ASSIGNED_BY_ID||null,d=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",l=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",g=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,_=j(g),h=le(_);return{id:t,title:s,priorityId:_.id,priorityLabel:_.label,priorityColors:h,priority:_.id,priorityBitrixValue:_.bitrixValue||null,status:this.mapStatus(a),assigneeId:m?parseInt(m):null,stageId:this.mapStageId(a),createdAt:d,modifiedAt:l,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}static mapPriority(e){return j(e).id}static mapPriorityToBitrix(e){if(e&&typeof e=="object")return e.bitrixValue||null;const t=H(e);if(t&&t.bitrixValue)return t.bitrixValue;const s={3:"3",2:"2",1:"1",high:"3",medium:"2",low:"1"};return s[e]?s[e]:H(ne).bitrixValue}static mapStatus(e){return"in_progress"}static getZeroPointTickets(e){const t={formed:[],review:[],execution:[]};return Array.isArray(e)?(e.filter(s=>!(s.assignedById||s.ASSIGNED_BY_ID)).forEach(s=>{const a=this.mapStageId(s.stageId||s.STAGE_ID||"");t[a]&&t[a].push(this.mapTicket(s))}),t):(console.warn("Tickets is not an array in getZeroPointTickets:",e),t)}static async assignTicket(e,t,s){try{const a=this.mapStageIdToBitrix(s);return(await U.call("crm.item.update",{entityTypeId:this.ENTITY_TYPE_ID,id:e,fields:{assignedById:t,stageId:a}})).result===!0}catch(a){throw console.error("Error assigning ticket:",a),a}}static async createTicket(e){try{const t=await U.call("crm.item.add",{entityTypeId:this.ENTITY_TYPE_ID,fields:{title:e.title,assignedById:e.employeeId,stageId:this.mapStageIdToBitrix(e.stageId)}});return t.result?parseInt(t.result):0}catch(t){throw console.error("Error creating ticket:",t),t}}static async getTicket(e){try{const t=await U.call("crm.item.get",{entityTypeId:this.ENTITY_TYPE_ID,id:e});return this.mapTicket(t.result)}catch(t){throw console.error("Error getting ticket:",t),t}}static async addComment(e,t){try{return(await U.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+this.ENTITY_TYPE_ID,comment:t}})).result!==void 0}catch(s){throw console.error("Error adding comment:",s),s}}}M(G,"ENTITY_TYPE_ID",140),M(G,"SECTOR_TAG","1C");const Ae="/api/graph-1c-admission-closure.php";function Se(y){var t,s,a,m,d,l,g,_,h,w;if(!y)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const e=y.data||y.result||y;return{meta:e.meta||y.meta||null,data:{newTickets:((t=e.data)==null?void 0:t.newTickets)??e.newTickets??0,closedTickets:((s=e.data)==null?void 0:s.closedTickets)??e.closedTickets??0,series:{new:((m=(a=e.data)==null?void 0:a.series)==null?void 0:m.new)??((d=e.series)==null?void 0:d.new)??[0],closed:((g=(l=e.data)==null?void 0:l.series)==null?void 0:g.closed)??((_=e.series)==null?void 0:_.closed)??[0]},stages:((h=e.data)==null?void 0:h.stages)??e.stages??[],responsible:((w=e.data)==null?void 0:w.responsible)??e.responsible??[]}}}async function z(y={}){const{endpoint:e=Ae,product:t="1C",weekStartUtc:s=null,weekEndUtc:a=null,useCache:m=!0,forceRefresh:d=!1,includeTickets:l=!1}=y,_=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:t,weekStartUtc:s,weekEndUtc:a,useCache:m,forceRefresh:d,includeTickets:l})});if(!_.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${_.status})`);const h=await _.json();if((h==null?void 0:h.success)===!1)throw new Error(h.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return Se(h)}const Ue={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},Be={class:"modal"},Re={key:"level-1",class:"level-1"},$e={class:"modal__header"},Ne={class:"modal__body"},Pe={key:"loading",class:"loading-names"},Oe={key:"empty",class:"modal__empty"},Ye={key:"list",class:"responsible-list"},Me=["onClick"],Le={class:"responsible-list__name"},Ge={class:"responsible-list__count"},Fe={key:0,class:"responsible-list__arrow"},Ve={class:"modal__footer"},We={key:"level-2",class:"level-2"},je={class:"modal__header"},He={class:"modal__title"},qe={class:"modal__body"},ze={key:"loading",class:"loading-state"},Ze={key:"error",class:"error-state"},xe={class:"error-message"},Je={key:"empty",class:"empty-state"},Xe={key:"tickets",class:"tickets-list-container"},Ke={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]},weekStartUtc:{type:String,default:null},weekEndUtc:{type:String,default:null}},setup(y){const e=y,t=I(1),s=I(null),a=I([]),m=I(!1),d=I(null),l=I([]),g=I(!1);async function _(n){const c=n.filter(r=>r.id!==null&&r.id!==void 0).map(r=>r.id);if(c.length===0)return n;try{const r=await G.getEmployeesByIds(c),i=new Map;return r.forEach(u=>{i.set(u.id,u.name)}),n.map(u=>u.id&&i.has(u.id)?{...u,name:i.get(u.id)}:u)}catch(r){return console.error("[ResponsibleModal] Error enriching names:",r),n}}V(()=>e.responsible,async n=>{if(!n||n.length===0){l.value=[];return}g.value=!0;try{l.value=await _(n)}catch(c){console.error("[ResponsibleModal] Error loading employee names:",c),l.value=n}finally{g.value=!1}},{immediate:!0});const h=b(()=>(l.value||[]).length>0);async function w(n,c=null){!n||!n.id||n.count===0||(c&&c.currentTarget&&(c.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{c.currentTarget&&(c.currentTarget.style.transform="")},150)),s.value=n,t.value=2,await T(n.id))}async function T(n){m.value=!0,d.value=null;try{if(!e.weekStartUtc||!e.weekEndUtc)throw new Error("ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð½ÐµÐ´ÐµÐ»Ð¸");const r=(await z({product:"1C",weekStartUtc:e.weekStartUtc,weekEndUtc:e.weekEndUtc,includeTickets:!0})).data.responsible.find(u=>u.id===n),i=(r==null?void 0:r.tickets)||[];a.value=i.map(u=>({id:u.id,title:u.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",ufSubject:u.title||"Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ",createdTime:u.createdTime,createdAt:u.createdTime,updatedTime:u.movedTime,modifiedAt:u.movedTime,stageId:u.stageId,assignedById:u.assignedById,priorityId:"medium",priorityLabel:"Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹",priorityColors:{color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},priority:"medium"})),a.value.length===0&&(d.value=null)}catch(c){d.value=c.message||"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²",console.error("[ResponsibleModal] Error loading tickets:",c),a.value=[]}finally{m.value=!1}}function v(){t.value=1,s.value=null,a.value=[],d.value=null}function D(n){const c=ie(n.id);window.open(c,"_blank")}function E(){s.value&&T(s.value.id)}return V(()=>e.isVisible,n=>{n||(t.value=1,s.value=null,a.value=[],d.value=null)}),(n,c)=>y.isVisible?(p(),f("div",Ue,[o("div",Be,[B(L,{name:"level",mode:"out-in"},{default:N(()=>{var r;return[t.value===1?(p(),f("div",Re,[o("header",$e,[c[3]||(c[3]=o("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),o("button",{class:"modal__close",onClick:c[0]||(c[0]=i=>n.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),o("section",Ne,[B(L,{name:"loading",mode:"out-in"},{default:N(()=>[g.value?(p(),f("div",Pe,[...c[4]||(c[4]=[o("div",{class:"loading-spinner"},null,-1),o("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð¼Ñ‘Ð½ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²...",-1)])])):h.value?(p(),f("ul",Ye,[(p(!0),f(O,null,Y(l.value,i=>(p(),f("li",{key:i.id||i.name,class:q(["responsible-list__item",{"responsible-list__item--clickable":i.id&&i.count>0}]),onClick:u=>w(i,u),title:"ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°"},[o("span",Le,k(i.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1),o("span",Ge,k(i.count??0)+" Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² ",1),i.id&&i.count>0?(p(),f("span",Fe,"â†’")):P("",!0)],10,Me))),128))])):(p(),f("p",Oe,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),_:1})]),o("footer",Ve,[o("button",{class:"btn",onClick:c[1]||(c[1]=i=>n.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])):t.value===2?(p(),f("div",We,[o("header",je,[o("button",{class:"btn-back",onClick:v,"aria-label":"ÐÐ°Ð·Ð°Ð´"},"â† ÐÐ°Ð·Ð°Ð´"),o("h3",He,"Ð¢Ð¸ÐºÐµÑ‚Ñ‹ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ°: "+k(((r=s.value)==null?void 0:r.name)||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"),1),o("button",{class:"modal__close",onClick:c[2]||(c[2]=i=>n.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),o("section",qe,[B(L,{name:"loading",mode:"out-in"},{default:N(()=>[m.value?(p(),f("div",ze,[...c[5]||(c[5]=[o("div",{class:"loading-spinner"},null,-1),o("p",null,"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð²...",-1)])])):d.value?(p(),f("div",Ze,[c[6]||(c[6]=o("div",{class:"error-icon"},"âš ï¸",-1)),c[7]||(c[7]=o("p",{class:"error-title"},"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",-1)),o("p",xe,k(d.value),1),o("button",{class:"btn btn-retry",onClick:E},"ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ")])):a.value.length===0?(p(),f("div",Je,[...c[8]||(c[8]=[o("div",{class:"empty-state-icon"},"ðŸ“‹",-1),o("p",{class:"empty-state-message"},"Ð£ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ñ‚Ð¸ÐºÐµÑ‚Ð¾Ð² Ð·Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)])])):(p(),f("div",Xe,[B(X,{name:"ticket",tag:"div",class:"tickets-list"},{default:N(()=>[(p(!0),f(O,null,Y(a.value,(i,u)=>(p(),R(re,{key:i.id,ticket:i,draggable:!1,style:K({"--ticket-index":u}),onClick:D},null,8,["ticket","style"]))),128))]),_:1})]))]),_:1})])])):P("",!0)]}),_:1})])])):P("",!0)}},Qe=F(Ke,[["__scopeId","data-v-ec41a840"]]),et={class:"ac-dashboard"},tt={key:1},st={class:"dashboard-layout"},at={class:"filters-container"},ot={class:"chart-container"},lt={__name:"GraphAdmissionClosureDashboard",setup(y){const e=I(!0),t=I(null),s=I(null),a=I({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),m=I(!1),d=I({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),l=I(null),g=b(()=>{const r=d.value.customDateRange.startDate||d.value.customDateRange.endDate,i=d.value.employees.length===1&&d.value.employees.includes("all");return r||!i});async function _(){e.value=!0,t.value=null;try{let r,i;if(l.value)r=l.value.startUtc,i=l.value.endUtc;else{const C=c();r=C.weekStartUtc,i=C.weekEndUtc}const{meta:u,data:A}=await z({product:"1C",weekStartUtc:r,weekEndUtc:i});s.value=u,a.value=A,!l.value&&u&&(l.value={weekNumber:u.weekNumber,startUtc:u.weekStartUtc,endUtc:u.weekEndUtc})}catch(r){t.value=r instanceof Error?r:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",r)}finally{e.value=!1}}function h(r){d.value.stages=r}function w(r){d.value.employees=r}function T(r){d.value.dateRange=r}function v(r){d.value.customDateRange=r}function D(r){l.value=r}function E(){d.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},n()}function n(){_()}Q(()=>{_()});function c(){const r=new Date,i=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate())),u=i.getUTCDay(),A=i.getUTCDate()-u+(u===0?-6:1),C=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),A,0,0,0)),$=new Date(C);return $.setUTCDate($.getUTCDate()+6),$.setUTCHours(23,59,59,999),{weekStartUtc:C.toISOString(),weekEndUtc:$.toISOString()}}return(r,i)=>{var u,A;return p(),f("div",et,[e.value?(p(),R(te,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(p(),f("div",tt,[i[2]||(i[2]=o("div",{class:"dashboard-header"},[o("div",null,[o("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),o("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),o("div",st,[o("div",at,[B(se,{stages:d.value.stages,employees:d.value.employees,dateRange:d.value.dateRange,customDateRange:d.value.customDateRange,hasActiveFilters:g.value,hideStages:!0,weekPickerMode:!0,selectedWeek:l.value,weeksCount:52,"onUpdate:stages":h,"onUpdate:employees":w,"onUpdate:dateRange":T,"onUpdate:customDateRange":v,"onUpdate:selectedWeek":D,onReset:E,onApply:n},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters","selectedWeek"])]),o("div",ot,[t.value?(p(),R(ee,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:t.value.message},null,8,["message"])):(p(),R(Ce,{key:1,meta:s.value,data:a.value,onOpenResponsible:i[0]||(i[0]=C=>m.value=!0)},null,8,["meta","data"]))])])])),B(Qe,{"is-visible":m.value,responsible:a.value.responsible||[],"week-start-utc":((u=s.value)==null?void 0:u.weekStartUtc)||null,"week-end-utc":((A=s.value)==null?void 0:A.weekEndUtc)||null,onClose:i[1]||(i[1]=C=>m.value=!1)},null,8,["is-visible","responsible","week-start-utc","week-end-utc"])])}}},ut=F(lt,[["__scopeId","data-v-271e1b33"]]);export{ut as default};
