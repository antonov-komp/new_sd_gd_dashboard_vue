import{B as d}from"./chunk-C8Cm5yGW.js";class f extends d{constructor(){super("dashboard",3*60*1e3)}async getDepartmentsForDashboard(t={}){const{includeHead:a=!0,activeOnly:r=!0,sort:s="SORT"}=t,i={select:["ID","NAME","SORT"],order:{[s]:"ASC"}};return a&&i.select.push("UF_HEAD"),(await this.call("department.get",i)).result||[]}async getUsersForDashboard(t={}){const{departmentId:a,activeOnly:r=!0,includeProfiles:s=!1,limit:i=100}=t,e={};return r&&(e.ACTIVE="Y"),a&&(e.UF_DEPARTMENT=parseInt(a)),(await this.getUsersList(e)).slice(0,i).map(n=>({...n,fullName:`${n.NAME||""} ${n.LAST_NAME||""}`.trim(),hasPhoto:!!(n.PERSONAL_PHOTO&&n.PERSONAL_PHOTO.showUrl),departmentName:"",isOnline:!1,lastActivity:n.TIMESTAMP_X||n.DATE_REGISTER}))}async getUserStatsForDashboard(t={}){const{departmentId:a,includeInactive:r=!1}=t,s=await this.getUsersList({...a&&{UF_DEPARTMENT:parseInt(a)},...!r&&{ACTIVE:"Y"}}),i={total:s.length,active:s.filter(e=>e.ACTIVE==="Y").length,inactive:s.filter(e=>e.ACTIVE!=="Y").length,withPhoto:s.filter(e=>e.PERSONAL_PHOTO).length,byPosition:{},recentRegistrations:s.filter(e=>this.isRecentUser(e.DATE_REGISTER)).length};return s.forEach(e=>{const o=e.WORK_POSITION||"Не указана";i.byPosition[o]=(i.byPosition[o]||0)+1}),i}async getActivityChartData(t={}){const{departmentId:a,period:r="month",limit:s=30}=t,i=await this.getUsersForDashboard({departmentId:a,limit:200}),e={},o=new Date;return i.forEach(c=>{const n=c.TIMESTAMP_X||c.DATE_REGISTER;if(!n)return;const h=new Date(n),l=this.getGroupKey(h,r,o);e[l]||(e[l]={date:l,count:0,activeUsers:0}),e[l].count++,c.ACTIVE==="Y"&&e[l].activeUsers++}),Object.values(e).sort((c,n)=>c.date.localeCompare(n.date)).slice(-s)}getGroupKey(t,a,r){const s=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),e=String(t.getDate()).padStart(2,"0");switch(a){case"day":return`${s}-${i}-${e}`;case"week":const o=new Date(t);return o.setDate(t.getDate()-t.getDay()),`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`;case"month":return`${s}-${i}`;case"year":return s.toString();default:return`${s}-${i}-${e}`}}isRecentUser(t){if(!t)return!1;const a=new Date(t),s=Math.abs(new Date-a);return Math.ceil(s/(1e3*60*60*24))<=30}async getDashboardSummary(){const[t,a,r]=await Promise.all([this.getDepartmentsForDashboard(),this.getUsersForDashboard({limit:500}),this.getUserStatsForDashboard()]);return{departments:{total:t.length,withHead:t.filter(s=>s.UF_HEAD).length},users:r,system:{cacheEfficiency:this.getMetrics().cache.efficiency,avgResponseTime:Math.round(this.getMetrics().api.avgResponseTime),totalApiCalls:this.getMetrics().api.totalCalls},timestamp:new Date().toISOString()}}clearDashboardCache(t=null){const a=["user.get","department.get","crm.status.list"];t?a.forEach(r=>{r.includes(t)&&super.clearCache(r)}):a.forEach(r=>super.clearCache(r))}}export{f as D};
