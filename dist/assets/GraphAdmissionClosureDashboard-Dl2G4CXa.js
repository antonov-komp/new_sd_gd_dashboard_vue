import{_ as T,g as f,c as b,a as p,o as c,b as e,t as m,F as $,e as R,n as F,d as E,f as D,G as L,H as C,m as B,j as S,S as I,L as M}from"./main-vjOnDlDe.js";import{F as N}from"./FiltersPanel-Cnq7vMis.js";import{L as U,D as O,B as G}from"./index-C2bxWsLm.js";import"./bitrix24-api-Irr5mCDD.js";const V={class:"ac-chart"},j={class:"ac-chart__header"},x={class:"ac-chart__subtitle"},P={class:"ac-chart__controls"},q={class:"chart-type-selector"},z=["onClick"],H={class:"chart-type-icon"},W={class:"chart-type-label"},X={class:"ac-chart__summary"},J={class:"summary-card summary-card--new"},Z={class:"summary-card__value"},K={class:"summary-card summary-card--closed"},Q={class:"summary-card__value"},Y={class:"summary-card summary-card--stages"},ee={class:"summary-card__tags"},se={key:0,class:"stage-tag stage-tag--empty"},ae={class:"ac-chart__body"},te={__name:"GraphAdmissionClosureChart",props:{meta:{type:Object,default:null},data:{type:Object,default:()=>({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]})}},emits:["open-responsible"],setup(r,{emit:o}){const l=r,_=o,i=[{value:"line",label:"Ð›Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ð¹",icon:"ðŸ“ˆ"},{value:"bar",label:"Ð¡Ñ‚Ð¾Ð»Ð±Ñ‡Ð°Ñ‚Ñ‹Ð¹",icon:"ðŸ“Š"},{value:"doughnut",label:"ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ",icon:"ðŸ©"}],a=f("line"),s=b(()=>{var h;return((h=l.meta)==null?void 0:h.weekNumber)??"â€”"}),g=b(()=>{var n,t;const h=["Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ"],d=Array.isArray((n=l.data.series)==null?void 0:n.new)?l.data.series.new:[l.data.newTickets||0],y=Array.isArray((t=l.data.series)==null?void 0:t.closed)?l.data.series.closed:[l.data.closedTickets||0];return{labels:h,datasets:[{label:"ÐÐ¾Ð²Ñ‹Ðµ",data:d,backgroundColor:C.primary,borderColor:C.primary,tension:.3,fill:!1},{label:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ",data:y,backgroundColor:C.success,borderColor:C.success,tension:.3,fill:!1}]}}),v=b(()=>({labels:["ÐÐ¾Ð²Ñ‹Ðµ","Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ"],datasets:[{data:[l.data.newTickets||0,l.data.closedTickets||0],backgroundColor:[C.primary,C.success],borderWidth:1}]})),u=b(()=>{switch(a.value){case"line":return U;case"bar":return G;case"doughnut":return O;default:return U}}),k=b(()=>a.value==="doughnut"?v.value:g.value),w=b(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{enabled:!0},legend:{position:"top"}},onClick:()=>{var h;(((h=l.data)==null?void 0:h.responsible)||[]).length>0&&_("open-responsible")},scales:a.value==="doughnut"?{}:{y:{beginAtZero:!0,ticks:{precision:0}}}}));return(h,d)=>{var y,n;return c(),p("div",V,[e("header",j,[e("div",null,[d[1]||(d[1]=e("h2",{class:"ac-chart__title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡",-1)),e("p",x," ÐÐµÐ´ÐµÐ»Ñ "+m(s.value)+" Â· "+m(((y=r.meta)==null?void 0:y.weekStartUtc)||"â€”")+" â€” "+m(((n=r.meta)==null?void 0:n.weekEndUtc)||"â€”")+" (UTC) ",1)]),e("div",P,[e("div",q,[(c(),p($,null,R(i,t=>e("button",{key:t.value,class:F(["chart-type-btn",{active:a.value===t.value}]),onClick:A=>a.value=t.value},[e("span",H,m(t.icon),1),e("span",W,m(t.label),1)],10,z)),64))]),e("button",{class:"btn-link",onClick:d[0]||(d[0]=t=>h.$emit("open-responsible"))}," ðŸ‘¥ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ")])]),e("section",X,[e("div",J,[d[2]||(d[2]=e("div",{class:"summary-card__label"},"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",Z,m(r.data.newTickets??0),1)]),e("div",K,[d[3]||(d[3]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("div",Q,m(r.data.closedTickets??0),1)]),e("div",Y,[d[4]||(d[4]=e("div",{class:"summary-card__label"},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼",-1)),e("div",ee,[(c(!0),p($,null,R(r.data.stages||[],t=>(c(),p("span",{key:t.stageId,class:"stage-tag"},m(t.stageId)+" â€” "+m(t.count),1))),128)),!r.data.stages||r.data.stages.length===0?(c(),p("span",se," ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ")):E("",!0)])])]),e("div",ae,[(c(),D(L(u.value),{data:k.value,options:w.value},null,8,["data","options"]))])])}}},oe=T(te,[["__scopeId","data-v-9edf003d"]]),le={key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true"},ne={class:"modal"},re={class:"modal__header"},ie={class:"modal__body"},ce={key:0,class:"modal__empty"},de={key:1,class:"responsible-list"},ue={class:"responsible-list__name"},me={class:"responsible-list__avatar","aria-hidden":"true"},pe={class:"responsible-list__count"},_e={class:"modal__footer"},ve={__name:"ResponsibleModal",props:{isVisible:{type:Boolean,default:!1},responsible:{type:Array,default:()=>[]}},setup(r){const o=r,l=b(()=>(o.responsible||[]).length>0);function _(i){if(!i)return"â€”";const a=String(i).trim().split(/\s+/);return a.length===1?a[0].charAt(0).toUpperCase():`${a[0].charAt(0)}${a[1].charAt(0)}`.toUpperCase()}return(i,a)=>r.isVisible?(c(),p("div",le,[e("div",ne,[e("header",re,[a[2]||(a[2]=e("h3",{class:"modal__title"},"ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ",-1)),e("button",{class:"modal__close",onClick:a[0]||(a[0]=s=>i.$emit("close")),"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"}," âœ• ")]),e("section",ie,[l.value?(c(),p("ul",de,[(c(!0),p($,null,R(r.responsible,s=>(c(),p("li",{key:s.id||s.name,class:"responsible-list__item"},[e("div",ue,[e("span",me,m(_(s.name)),1),e("span",null,m(s.name||"ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½"),1)]),e("div",pe,m(s.count??0),1)]))),128))])):(c(),p("p",ce,"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼"))]),e("footer",_e,[e("button",{class:"btn",onClick:a[1]||(a[1]=s=>i.$emit("close"))},"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")])])])):E("",!0)}},he=T(ve,[["__scopeId","data-v-ac5a8b81"]]),be="/api/graph-1c-admission-closure.php";function ge(r){var l,_,i,a,s,g,v,u,k,w;if(!r)return{meta:null,data:{newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}};const o=r.data||r.result||r;return{meta:o.meta||r.meta||null,data:{newTickets:((l=o.data)==null?void 0:l.newTickets)??o.newTickets??0,closedTickets:((_=o.data)==null?void 0:_.closedTickets)??o.closedTickets??0,series:{new:((a=(i=o.data)==null?void 0:i.series)==null?void 0:a.new)??((s=o.series)==null?void 0:s.new)??[0],closed:((v=(g=o.data)==null?void 0:g.series)==null?void 0:v.closed)??((u=o.series)==null?void 0:u.closed)??[0]},stages:((k=o.data)==null?void 0:k.stages)??o.stages??[],responsible:((w=o.data)==null?void 0:w.responsible)??o.responsible??[]}}}async function ye(r={}){const{endpoint:o=be,product:l="1C",weekStartUtc:_=null,weekEndUtc:i=null,useCache:a=!0,forceRefresh:s=!1}=r,v=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({product:l,weekStartUtc:_,weekEndUtc:i,useCache:a,forceRefresh:s})});if(!v.ok)throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (${v.status})`);const u=await v.json();if((u==null?void 0:u.success)===!1)throw new Error(u.message||"Ð‘ÑÐºÐµÐ½Ð´ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ");return ge(u)}const fe={class:"ac-dashboard"},ke={key:1},we={class:"dashboard-grid"},Ce={class:"filters-column"},De={class:"chart-column"},$e={__name:"GraphAdmissionClosureDashboard",setup(r){const o=f(!0),l=f(null),_=f(null),i=f({newTickets:0,closedTickets:0,series:{new:[0],closed:[0]},stages:[],responsible:[]}),a=f(!1),s=f({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),g=b(()=>{const n=s.value.customDateRange.startDate||s.value.customDateRange.endDate,t=s.value.employees.length===1&&s.value.employees.includes("all");return n||!t});async function v(){o.value=!0,l.value=null;try{const{meta:n,data:t}=await ye({product:"1C"});_.value=n,i.value=t}catch(n){l.value=n instanceof Error?n:new Error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"),console.error("[GraphAdmissionClosureDashboard] loadData error:",n)}finally{o.value=!1}}function u(n){s.value.stages=n}function k(n){s.value.employees=n}function w(n){s.value.dateRange=n}function h(n){s.value.customDateRange=n}function d(){s.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},y()}function y(){v()}return B(()=>{v()}),(n,t)=>(c(),p("div",fe,[o.value?(c(),D(M,{key:0,message:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…..."})):(c(),p("div",ke,[t[2]||(t[2]=e("div",{class:"dashboard-header"},[e("div",null,[e("h1",{class:"dashboard-title"},"Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€Ð° 1Ð¡"),e("p",{class:"dashboard-subtitle"}," Ð”Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹ Â«Ð“Ñ€Ð°Ñ„Ð¸ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑÂ», ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð¿Ð¾Ð² ÑÐºÑ€Ñ‹Ñ‚. ")])],-1)),e("div",we,[e("div",Ce,[S(N,{stages:s.value.stages,employees:s.value.employees,dateRange:s.value.dateRange,customDateRange:s.value.customDateRange,hasActiveFilters:g.value,hideStages:!0,"onUpdate:stages":u,"onUpdate:employees":k,"onUpdate:dateRange":w,"onUpdate:customDateRange":h,onReset:d,onApply:y},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])]),e("div",De,[l.value?(c(),D(I,{key:0,type:"error",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",message:l.value.message},null,8,["message"])):(c(),D(oe,{key:1,meta:_.value,data:i.value,onOpenResponsible:t[0]||(t[0]=A=>a.value=!0)},null,8,["meta","data"]))])])])),S(he,{"is-visible":a.value,responsible:i.value.responsible||[],onClose:t[1]||(t[1]=A=>a.value=!1)},null,8,["is-visible","responsible"])]))}},Ue=T($e,[["__scopeId","data-v-72e7b5ac"]]);export{Ue as default};
