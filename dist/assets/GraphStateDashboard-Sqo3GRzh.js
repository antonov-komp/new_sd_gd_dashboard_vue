const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ticketListUtils-DLAHlRJM.js","assets/index-MhLBFhTp.js","assets/main-DHA-1UKE.js","assets/main-hkNOQW78.css","assets/index-Bxxce_5E.css","assets/index-CCYo0h_B.js"])))=>i.map(i=>d[i]);
import{_ as Ie,a as _,o as S,b as i,F as me,e as he,n as le,l as be,t as P,g as R,c as se,G as je,m as He,f as Ae,d as te,j as ue,k as Ce,i as ge,B as Ue,T as bt,H as Pt,I as $t,u as ze,J as Oe,K as Ve,p as Ge,L as at,x as Lt,M as Bt,N as Mt,C as Nt,O as Ze,D as jt,P as Wt,Q as Ut,y as Ye,R as xe,z as zt,r as Vt}from"./main-DHA-1UKE.js";import{L as Dt,D as Kt,B as Gt}from"./index-CCYo0h_B.js";import{S as st,d as nt,K as Yt,D as St,B as rt,m as Et,e as qe,f as fe,h as _t,j as qt,T as Tt,k as Xt,l as Ct}from"./index-MhLBFhTp.js";const Ee={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Te{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,n={}){try{if(!t||typeof t!="object")throw new Fe("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new Fe("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const a=this.validateSectorData(t);if(!a.isValid)throw new Fe(`Ошибка валидации данных сектора: ${a.errors.join(", ")}`,"VALIDATION_ERROR",{validation:a});const s=this.normalizeSectorData(t),l={metadata:this.generateSnapshotMetadata(e,n.createdBy,n.sectorId||Ee.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},c=this.validateSnapshot(l);if(!c.isValid)throw new Fe(`Ошибка валидации слепка: ${c.errors.join(", ")}`,"VALIDATION_ERROR",{validation:c});c.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",c.warnings);const u=this.getApiBaseUrl(),p=await fetch(`${u}${Ee.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:l,type:e,date:this.formatDate(new Date)})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const g=await p.json();if(!g.success)throw new Error(g.message||"Ошибка создания слепка");return g.data.snapshot}catch(a){throw console.error("SnapshotService.createSnapshot error:",a),a instanceof Fe?a:new Fe(`Ошибка создания слепка: ${a.message}`,"API_ERROR",{originalError:a})}}static async getSnapshot(t,e){try{const n=this.formatDate(t),s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?action=get&date=${n}&type=${e}`,o=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(o.status===404)return null;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const l=await o.json();if(!l.success){if(l.message&&l.message.includes("не найден"))return null;throw new Error(l.message||"Ошибка получения слепка")}return l.data.snapshot}catch(n){throw console.error("SnapshotService.getSnapshot error:",n),n}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",Ee.defaultSectorId);const a=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}?${e.toString()}`,s=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.json();if(!o.success)throw new Error(o.message||"Ошибка получения списка слепков");return(await Promise.all(o.data.snapshots.map(async c=>{try{return await this.getSnapshot(c.date,c.type)}catch(u){return console.warn(`Ошибка загрузки слепка ${c.date}/${c.type}:`,u),null}}))).filter(c=>c!==null).sort((c,u)=>new Date(c.metadata.createdAt)-new Date(u.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:n=[],zeroPointTickets:a={}}=t,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},o=[],l=[],c=[];e.forEach(g=>{const d=g.id;if(s[d]){let v=0;g.employees.forEach(D=>{const h=D.tickets||[];v+=h.length;let y=o.find(k=>k.id===D.id);y||(y={id:D.id,name:D.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},o.push(y)),h.forEach(k=>{l.push(k.id),c.push({id:k.id,title:k.title||"Без названия",assignedTo:{id:D.id,name:D.name},createdAt:k.createdAt||"",updatedAt:k.modifiedAt||k.updatedAt||""}),y.ticketsByStage[d]=(y.ticketsByStage[d]||0)+1,y.totalTickets+=1})}),s[d].count=v}});const u={unassigned:0,keeper:0,total:0};Object.values(a).forEach(g=>{Array.isArray(g)&&g.forEach(d=>{u.total+=1,d.assigneeId===1051||d.assignedById===1051?u.keeper+=1:u.unassigned+=1,l.push(d.id),c.push({id:d.id,title:d.title||"Без названия",assignedTo:d.assignedTo||d.assignedById?{id:d.assignedById||d.assigneeId,name:"Неизвестный"}:null,createdAt:d.createdAt||"",updatedAt:d.modifiedAt||d.updatedAt||""})})});const p=Object.values(s).reduce((g,d)=>g+d.count,0)+u.total;return{statistics:{stages:{...s,total:p},employees:o,zeroPoint:u},ticketIds:[...new Set(l)],tickets:c}}static generateSnapshotMetadata(t,e,n){const a=new Date,s=-a.getTimezoneOffset(),o=Math.floor(s/60),l=s%60,c=`${o>=0?"+":""}${String(o).padStart(2,"0")}:${String(l).padStart(2,"0")}`,u=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}T${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}${c}`;return{version:Ee.snapshotVersion,createdAt:u,createdBy:e||{id:0,name:"Система"},type:t,sectorId:n,sectorName:n==="1C"?"Сектор 1С":`Сектор ${n}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${a}`}static buildFilePath(t,e){const n=typeof t=="string"?new Date(t):t,a=n.getFullYear(),s=this.getWeekNumber(n),o=this.formatDate(t);let l;if(e==="current"){const c=new Date,u=`${String(c.getHours()).padStart(2,"0")}-${String(c.getMinutes()).padStart(2,"0")}-${String(c.getSeconds()).padStart(2,"0")}`;l=`current-state-${o}-${u}.json`}else if(e==="manual"){const c=new Date,u=`${String(c.getHours()).padStart(2,"0")}-${String(c.getMinutes()).padStart(2,"0")}-${String(c.getSeconds()).padStart(2,"0")}`;l=`manual-${o}-${u}.json`}else l=`${e}-${o}.json`;return e==="current"?`current/${l}`:`${a}/week-${s}/${l}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);const a=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-a)/864e5+1)/7)}static validateSnapshot(t){var a,s,o;const e=[],n=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const l=t.statistics.stages,c=(((a=l.formed)==null?void 0:a.count)||0)+(((s=l.review)==null?void 0:s.count)||0)+(((o=l.execution)==null?void 0:o.count)||0);l.total!==c&&n.push(`Несоответствие общего количества тикетов: ожидается ${c}, указано ${l.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const l=t.statistics.zeroPoint,c=(l.unassigned||0)+(l.keeper||0);l.total!==c&&n.push(`Несоответствие статистики нулевой точки: ожидается ${c}, указано ${l.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const l=new Set(t.ticketIds),c=new Set(t.tickets.map(u=>u.id));l.size!==c.size&&n.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((u,p)=>{u.id||e.push(`Тикет #${p}: отсутствует ID`),u.title||e.push(`Тикет #${p}: отсутствует заголовок`),(!u.assignedTo||!u.assignedTo.id)&&n.push(`Тикет #${p}: отсутствует ответственный (может быть в нулевой точке)`),u.createdAt||e.push(`Тикет #${p}: отсутствует дата создания`),u.updatedAt||e.push(`Тикет #${p}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:n}}static validateSectorData(t){const e=[],n=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:n}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:n})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const n=this.formatDate(t),s=`${this.getApiBaseUrl()}${Ee.snapshotsEndpoint}`,o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:n,type:e})});if(o.status===404)return!1;if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const l=await o.json();if(!l.success)throw new Error(l.message||"Ошибка удаления слепка");return!0}catch(n){throw console.error("SnapshotService.deleteSnapshot error:",n),n}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let n=0;for(const a of e)try{await this.deleteSnapshot(a.metadata.createdAt.split("T")[0],a.metadata.type)&&n++}catch(s){console.warn(`Ошибка удаления слепка ${a.metadata.createdAt}:`,s)}return n}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=Ee.snapshotVersion){const n=this.getSnapshotVersion(t);return n===e||n==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${n} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,n=this.getWeekNumber(e);return{year:e.getFullYear(),week:n}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,a=(e.getDay()||7)-1,s=new Date(e);return s.setDate(e.getDate()-a),s.setHours(0,0,0,0),s}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,a=7-(e.getDay()||7),s=new Date(e);return s.setDate(e.getDate()+a),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),n=this.getWeekEndDate(t),a=this.getWeekNumberInfo(t),s=await this.getAllSnapshots({startDate:e,endDate:n}),o=s.find(u=>u.metadata.type==="week_start")||null,l=s.find(u=>u.metadata.type==="week_end")||null,c=s.filter(u=>u.metadata.type==="manual");return{weekStart:o,weekEnd:l,manual:c,weekInfo:a}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof Fe)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),n={week_start:0,week_end:0,manual:0,current:0},a=new Map;let s=null,o=null;e.forEach(c=>{const u=c.metadata.type;n.hasOwnProperty(u)&&n[u]++;const p=this.getWeekNumberInfo(c.metadata.createdAt),g=`${p.year}-W${p.week}`;a.set(g,(a.get(g)||0)+1);const d=new Date(c.metadata.createdAt);(!s||d<new Date(s.metadata.createdAt))&&(s=c),(!o||d>new Date(o.metadata.createdAt))&&(o=c)});const l=Array.from(a.entries()).map(([c,u])=>{const[p,g]=c.split("-W");return{year:parseInt(p),week:parseInt(g),count:u}}).sort((c,u)=>c.year!==u.year?c.year-u.year:c.week-u.week);return{total:e.length,byType:n,byWeek:l,oldest:s,newest:o}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class Fe extends Error{constructor(t,e,n={}){super(t),this.name="SnapshotError",this.code=e,this.details=n}}const _e={formed:{bitrixId:nt.formed,name:st.FORMED.name},review:{bitrixId:nt.review,name:st.REVIEW.name},execution:{bitrixId:nt.execution,name:st.EXECUTION.name}},We=Yt;function Jt(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=Zt(r.stages),e=Qt(r.stages),n=ea(r.zeroPointTickets||{}),a=ta(r.zeroPointTickets||{}),s=aa(r.stages,r.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:n,zeroPointByStage:a},ticketIds:s.ticketIds,tickets:s.tickets}}function Zt(r){const t={formed:{count:0,stageId:_e.formed.bitrixId,stageName:_e.formed.name},review:{count:0,stageId:_e.review.bitrixId,stageName:_e.review.name},execution:{count:0,stageId:_e.execution.bitrixId,stageName:_e.execution.name},total:0};return r.forEach(e=>{if(!_e[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let n=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(a=>{a.tickets&&Array.isArray(a.tickets)&&(n+=a.tickets.length)}),t[e.id].count=n,t.total+=n}),t}function Qt(r){const t=new Map;return r.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(n=>{if(!n||!n.id)return;t.has(n.id)||t.set(n.id,{id:n.id,name:n.name||`Сотрудник #${n.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const a=t.get(n.id),s=n.tickets&&Array.isArray(n.tickets)?n.tickets.length:0;_e[e.id]&&(a.ticketsByStage[e.id]=(a.ticketsByStage[e.id]||0)+s),a.totalTickets+=s})}),Array.from(t.values())}function ea(r){let t=0,e=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(n=>{Array.isArray(n)&&n.forEach(a=>{if(!a)return;const s=a.assignedTo||a.assignedById;!s||s===null?t++:(typeof s=="object"?s.id:s)===We?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function ta(r){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(t).forEach(e=>{const n=r[e];Array.isArray(n)&&n.forEach(a=>{if(!a)return;const s=a.assignedTo||a.assignedById;!s||s===null?t[e].unassigned++:(typeof s=="object"?s.id:s)===We?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function aa(r,t){const e=new Set,n=new Map;return Array.isArray(r)&&r.forEach(a=>{!a.employees||!Array.isArray(a.employees)||a.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(o=>{if(!o||!o.id){console.warn("Ticket without ID found:",o);return}const l=parseInt(o.id);if(isNaN(l)){console.warn("Invalid ticket ID:",o.id);return}e.add(l);let c=o.assignedTo;!c&&s.id&&(c={id:s.id,name:s.name||`Сотрудник #${s.id}`}),n.set(l,{id:l,title:o.title||"Без названия",assignedTo:c||null,createdAt:Ke(o.createdAt||o.createdTime),updatedAt:Ke(o.updatedAt||o.modifiedAt||o.updatedTime),stageId:o.stageId||a.id||null,departmentHead:o.departmentHead||null,departmentHeadFull:o.departmentHeadFull||o.departmentHead||null,priorityId:o.priorityId||null,priorityLabel:o.priorityLabel||null,service:o.service||null,serviceLabel:o.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(a=>{Array.isArray(a)&&a.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const o=parseInt(s.id);if(isNaN(o)){console.warn("Invalid ticket ID in zero point:",s.id);return}e.add(o);let l=s.assignedTo;if(!l&&s.assignedById){const c=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;c&&c!==We?l={id:c,name:"Неизвестный"}:c===We&&(l={id:We,name:"Хранитель объектов"})}n.set(o,{id:o,title:s.title||"Без названия",assignedTo:l||null,createdAt:Ke(s.createdAt||s.createdTime),updatedAt:Ke(s.updatedAt||s.modifiedAt||s.updatedTime),stageId:s.stageId||null,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null,priorityId:s.priorityId||null,priorityLabel:s.priorityLabel||null,service:s.service||null,serviceLabel:s.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((a,s)=>a-s),tickets:Array.from(n.values())}}function Ke(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const t=new Date(r);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",r),null}class it{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:n=null,normalize:a=!0,includeTicketDetails:s=!1}=t;try{const o=await St.getSectorData(e,n);return a?Jt(o):(s&&console.warn("includeTicketDetails пока не реализовано"),o)}catch(o){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",o),o}}static async isDataAvailable(){try{const t=await St.getSectorData(!0);return t!=null}catch{return!1}}}class ot{static compareTwoSnapshots(t,e,n={}){const{includeTickets:a=!1,includeEmployees:s=!0}=n,o=this.validateSnapshot(t),l=this.validateSnapshot(e);if(!o.valid||!l.valid)throw new Error("Invalid snapshot structure: "+[...o.errors,...l.errors].join(", "));const c=this.buildComparisonMetadata(t,e),u=this.compareStages(t.statistics.stages,e.statistics.stages),p=s?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],g=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),d=a?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,v=this.buildSummary(u,p,g,d);return{metadata:c,stages:u,employees:p,zeroPoint:g,tickets:d,summary:v}}static calculateDelta(t,e){const n=this.normalizeValue(t),a=this.normalizeValue(e),s=a-n;let o=0;n!==0?o=s/n*100:a!==0&&(o=a>0?1/0:-1/0);const l=this.getTrend(s);return{value1:n,value2:a,delta:s,deltaPercent:Math.round(o*100)/100,trend:l}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var l,c;const n=["formed","review","execution"],a={};for(const u of n){const p=((l=t[u])==null?void 0:l.count)||0,g=((c=e[u])==null?void 0:c.count)||0;a[u]=this.calculateDelta(p,g)}const s=t.total||0,o=e.total||0;return a.total=this.calculateDelta(s,o),a}static compareEmployees(t,e){var l,c;const n=new Map(t.map(u=>[u.id,u])),a=new Map(e.map(u=>[u.id,u])),s=new Set([...n.keys(),...a.keys()]),o=[];for(const u of s){const p=n.get(u)||null,g=a.get(u)||null;if(!p||!g){o.push({id:u,name:(p==null?void 0:p.name)||(g==null?void 0:g.name)||"Неизвестный",snapshot1:p?{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0}:null,snapshot2:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,delta:this.calculateEmployeeDelta(p,g),trend:p?"removed":"new"});continue}const d={},v=["formed","review","execution"];for(const h of v){const y=((l=p.ticketsByStage)==null?void 0:l[h])||0,k=((c=g.ticketsByStage)==null?void 0:c[h])||0;d[h]=this.calculateDelta(y,k)}const D=this.calculateDelta(p.totalTickets||0,g.totalTickets||0);o.push({id:u,name:p.name,snapshot1:{ticketsByStage:p.ticketsByStage||{},totalTickets:p.totalTickets||0},snapshot2:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},delta:{ticketsByStage:d,totalTickets:D},trend:D.trend})}return o}static calculateEmployeeDelta(t,e){var o,l;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const n={},a=["formed","review","execution"];for(const c of a){const u=((o=t==null?void 0:t.ticketsByStage)==null?void 0:o[c])||0,p=((l=e==null?void 0:e.ticketsByStage)==null?void 0:l[c])||0;n[c]=this.calculateDelta(u,p)}const s=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:n,totalTickets:s}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,n,a){var v,D;const s=new Set(t),o=new Set(e),l=e.filter(h=>!s.has(h)),c=t.filter(h=>!o.has(h)),u=[],p=[],g=new Map(n.map(h=>[h.id,h])),d=new Map(a.map(h=>[h.id,h]));for(const h of t){if(!o.has(h))continue;const y=g.get(h),k=d.get(h);if(!y||!k)continue;const T=(((v=y.assignedTo)==null?void 0:v.id)||null)!==(((D=k.assignedTo)==null?void 0:D.id)||null),z=(y.stageId||null)!==(k.stageId||null);T||z?u.push(h):p.push(h)}return{new:l,removed:c,changed:u,unchanged:p}}static buildComparisonMetadata(t,e){const n=new Date(t.metadata.createdAt),a=new Date(e.metadata.createdAt),s=new Date,o=a.getTime()-n.getTime(),l=Math.floor(o/(1e3*60*60*24)),c=Math.floor(o%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(o%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:l,hours:c,minutes:u,totalMinutes:Math.floor(o/(1e3*60))}}}static buildSummary(t,e,n,a){var u,p,g;const s=t.total.delta,o=Object.keys(t).filter(d=>d==="total"?!1:t[d].delta!==0).length,l=e.filter(d=>d.trend==="new"||d.trend==="removed"?!0:d.delta.totalTickets.delta!==0).length,c=s!==0||o>0||l>0;return{totalDelta:s,stagesChanged:o,employeesChanged:l,hasChanges:c,newTicketsCount:((u=a==null?void 0:a.new)==null?void 0:u.length)||0,removedTicketsCount:((p=a==null?void 0:a.removed)==null?void 0:p.length)||0,changedTicketsCount:((g=a==null?void 0:a.changed)==null?void 0:g.length)||0}}static validateSnapshot(t){const e=[],n=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:n};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const a=["formed","review","execution"];for(const s of a)t.statistics.stages[s]||n.push(`Missing stage: ${s}`)}t.statistics.employees||n.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||n.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:n}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const o of t){const l=this.validateSnapshot(o);if(!l.valid)throw new Error("Invalid snapshot: "+l.errors.join(", "))}const n=[...t].sort((o,l)=>{const c=new Date(o.metadata.createdAt),u=new Date(l.metadata.createdAt);return c-u}),a=[];for(let o=0;o<n.length-1;o++)a.push({from:o,to:o+1,result:this.compareTwoSnapshots(n[o],n[o+1],e)});const s=this.buildTrends(n);return{snapshots:n.map((o,l)=>({index:l,date:o.metadata.createdAt,type:o.metadata.type,data:o})),comparisons:a,trends:s}}static buildTrends(t){var n,a,s,o,l,c,u,p,g,d;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const v of t){const D=v.statistics;e.stages.formed.push(((a=(n=D.stages)==null?void 0:n.formed)==null?void 0:a.count)||0),e.stages.review.push(((o=(s=D.stages)==null?void 0:s.review)==null?void 0:o.count)||0),e.stages.execution.push(((c=(l=D.stages)==null?void 0:l.execution)==null?void 0:c.count)||0),e.stages.total.push(((u=D.stages)==null?void 0:u.total)||0),e.zeroPoint.unassigned.push(((p=D.zeroPoint)==null?void 0:p.unassigned)||0),e.zeroPoint.keeper.push(((g=D.zeroPoint)==null?void 0:g.keeper)||0),e.zeroPoint.total.push(((d=D.zeroPoint)==null?void 0:d.total)||0)}return e}}const sa={class:"stages-container"},na={class:"stages-chips"},oa=["checked","disabled","onChange"],la={class:"stage-chip-label"},ra={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:r=>r.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,n=t;function a(s,o){const l={...e.selected};l[s]=o,n("update:selected",l),n("change",s,o)}return(s,o)=>(S(),_("div",sa,[o[0]||(o[0]=i("h4",{class:"stages-title"},"Этапы для отображения:",-1)),i("div",na,[(S(!0),_(me,null,he(r.stages,l=>(S(),_("label",{key:l.id,class:le(["stage-chip",{"stage-chip--active":r.selected[l.id],"stage-chip--disabled":r.disabled}])},[i("input",{type:"checkbox",checked:r.selected[l.id],disabled:r.disabled,onChange:c=>a(l.id,c.target.checked)},null,40,oa),i("span",{class:"stage-chip-color",style:be({backgroundColor:l.color})},null,4),i("span",la,P(l.name),1)],2))),128))])]))}},ia=Ie(ra,[["__scopeId","data-v-fe03c03c"]]),lt=140,Pe=new Map;class Rt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await rt.call("crm.item.list",{entityTypeId:lt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let n=[];if(e&&e.result&&(Array.isArray(e.result)?n=e.result:e.result.items&&Array.isArray(e.result.items)?n=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(n=e.result.data)),!n||n.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const a=n[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:a.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!a.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:a.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(a),ticketSample:JSON.stringify(a).substring(0,500)});const s=Et(a),o=a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||a.UF_CRM_7_DEPARTMENT_HEAD||a.uf_crm_7_department_head||a.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:o,mappedDepartmentHead:s.departmentHead,departmentHeadFull:o?String(o).trim():null});let l=null;if(o){const c=String(o).trim();c.length>0&&(l=c)}return{...s,departmentHeadFull:l}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],n=[];if(t.forEach(a=>{Pe.has(a)?e.push(Pe.get(a)):n.push(a)}),n.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:n.length,ticketIdsSample:n.slice(0,5),entityTypeId:lt});const a=await rt.call("crm.item.list",{entityTypeId:lt,filter:{id:n},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!a,resultType:typeof a,resultKeys:a?Object.keys(a):[],hasResultResult:!!(a!=null&&a.result),resultResultType:typeof(a==null?void 0:a.result),isArray:Array.isArray(a==null?void 0:a.result),resultResultLength:Array.isArray(a==null?void 0:a.result)?a.result.length:"not array",fullResult:a});let s=[];if(a&&a.result&&(Array.isArray(a.result)?s=a.result:a.result.items&&Array.isArray(a.result.items)?s=a.result.items:a.result.data&&Array.isArray(a.result.data)&&(s=a.result.data)),!s||s.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!a,hasResultResult:!!(a!=null&&a.result),resultType:typeof(a==null?void 0:a.result),result:a,resultKeys:a?Object.keys(a):[]}),e;const o=s.map((l,c)=>{c===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:l.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!l.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:l.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(l).filter(v=>v.toLowerCase().includes("department")||v.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(l).slice(0,20)});const u=Et(l);c===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:u.id,hasDepartmentHead:!!u.departmentHead,departmentHead:u.departmentHead,mappedTicketKeys:Object.keys(u).filter(v=>v.toLowerCase().includes("department"))});const p=l.UF_CRM_7_DEPARTMENT_HEAD||l.uf_crm_7_department_head||l.ufCrm7DepartmentHead||l.UF_CRM_7_DEPARTMENT_HEAD||l.uf_crm_7_department_head||l.ufCrm7DepartmentHead||null;c===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:p,hasUF_CRM_7_DEPARTMENT_HEAD:!!l.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(l).filter(v=>v.toLowerCase().includes("department")||v.toLowerCase().includes("uf_crm"))});let g=null;if(p){const v=String(p).trim();v.length>0&&(g=v)}!g&&u.departmentHead&&(g=u.departmentHead);const d={...u,departmentHeadFull:g||u.departmentHead||null};return c===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:d.id,departmentHead:d.departmentHead,departmentHeadFull:d.departmentHeadFull}),d.id&&Pe.set(d.id,d),d});return[...e,...o]}catch(a){return console.error("[TicketDetailsService] Error loading tickets details batch:",a),console.error("[TicketDetailsService] Error details:",{message:a.message,stack:a.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){Pe.size>t&&Pe.clear()}static getCacheSize(){return Pe.size}}async function ca(r,t,e,n=null){var u;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:r,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((u=e==null?void 0:e.tickets)==null?void 0:u.length)||0}),!r||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const a=e.tickets.filter(p=>{const g=p.assignedTo;return g?(typeof g=="object"?g.id:g)===r:!1});if(a.length===0)return[];const s=!a[0].stageId||!a[0].departmentHead;let o=null;if(s){const p=a.map(g=>g.id);if(n&&typeof n=="object")o=n;else try{const g=await Rt.getTicketsDetails(p);o=new Map,g.forEach(d=>{d&&d.id&&o.set(d.id,d)})}catch(g){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",g),o=null}}return a.map(p=>{const g=p.id,d={id:g,title:p.title||"Без названия",assignedTo:p.assignedTo,createdAt:p.createdAt,updatedAt:p.updatedAt};if(o){const v=o instanceof Map?o.get(g):o[g];v?(d.stageId=v.stageId||null,d.departmentHead=v.departmentHead||null,d.departmentHeadFull=v.departmentHeadFull||v.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=p.stageId||null,d.departmentHead=p.departmentHead||null,d.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null;return d}).filter(p=>p.stageId?qe(p.stageId)===t:!0)}function At(r,t=new Date){if(!r||r.length===0)return[];const e=r.length,n={};return Object.values(fe).forEach(s=>{n[s]={category:s,label:_t[s].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:_t[s].color}}),r.forEach(s=>{if(!s.createdAt){n[fe.MORE_THAN_YEAR].count++,n[fe.MORE_THAN_YEAR].tickets.push(s);return}const o=qt(s.createdAt,t);n[o]&&(n[o].count++,n[o].tickets.push(s))}),Object.values(n).filter(s=>s.count>0).map(s=>{const o=e>0?parseFloat((s.count/e*100).toFixed(1)):0;return{...s,percentage:o,progressBarWidth:o}}).sort((s,o)=>{const l=[fe.TODAY,fe.YESTERDAY,fe.THIS_WEEK,fe.LAST_WEEK,fe.MORE_THAN_TWO_WEEKS,fe.UP_TO_ONE_MONTH,fe.MORE_THAN_TWO_MONTHS,fe.MORE_THAN_HALF_YEAR,fe.MORE_THAN_YEAR];return l.indexOf(s.category)-l.indexOf(o.category)})}function da(r){if(!r||r.length===0)return[];const t={};r.forEach(n=>{let a=n.departmentHeadFull||n.departmentHead;r.indexOf(n)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:n.id,departmentHead:n.departmentHead,departmentHeadFull:n.departmentHeadFull,allKeys:Object.keys(n).filter(s=>s.toLowerCase().includes("department"))}),a?(a=String(a).trim(),a.length===0&&(a="Без заказчика")):a="Без заказчика",t[a]||(t[a]={departmentName:a,count:0}),t[a].count++});const e=Object.values(t);return e.sort((n,a)=>a.count!==n.count?a.count-n.count:n.departmentName.localeCompare(a.departmentName,"ru")),e}const ua={class:"modal-content"},pa={key:"level-1",class:"level-1"},ga={class:"modal-header"},fa={class:"modal-total"},ma={class:"view-switcher"},ha={class:"modal-body"},va={key:0},ya={key:0,class:"no-employees"},ka={key:1,class:"employees-list"},wa=["onClick"],ba={class:"employee-name"},Da={class:"employee-progress"},Sa={class:"employee-count"},Ea={key:0,class:"employee-item employee-others"},_a={class:"employee-name"},Ta={class:"employee-progress"},Ca={class:"employee-count"},Aa={key:1,class:"view-time"},Ia={key:0,class:"no-data"},$a={key:1,class:"date-categories-list"},Ma=["onClick"],Na={class:"category-label"},Ra={class:"category-progress"},Fa={class:"category-count"},Ha={key:2,class:"view-departments"},Oa={key:0,class:"no-data"},xa={key:1,class:"departments-table-container"},Pa={class:"departments-table"},La=["onClick"],Ba={class:"col-department"},ja={class:"department-name"},Wa={class:"col-count"},Ua={class:"count-value"},za={key:"level-2",class:"level-2"},Va={class:"modal-header"},Ka={class:"modal-total"},Ga={class:"modal-body"},Ya={class:"stage-info"},qa={class:"stage-badge"},Xa={key:0,class:"no-data"},Ja={key:1,class:"date-categories-list"},Za=["onClick"],Qa={class:"category-label"},es={class:"category-progress"},ts={class:"category-count"},as={key:"level-3",class:"level-3"},ss={class:"modal-header"},ns={class:"header-info"},os={class:"header-badges"},ls={class:"date-badge"},rs={class:"stage-badge"},is={class:"modal-total"},cs={class:"modal-body"},ds={key:0,class:"no-data"},us={key:1,class:"departments-table-container"},ps={class:"departments-table"},gs=["onClick"],fs={class:"col-department"},ms={class:"department-name"},hs={class:"col-count"},vs={class:"count-value"},ys={key:"level-4",class:"level-4"},ks={class:"modal-header"},ws={class:"header-info"},bs={key:0,class:"header-badges"},Ds={key:0,class:"date-badge"},Ss={key:1,class:"department-badge"},Es={class:"stage-badge"},_s={class:"modal-total"},Ts={class:"modal-body"},Cs={key:"loading",class:"loading-state"},As={key:"error-fallback",class:"error-state-with-fallback"},Is={class:"tickets-list-container"},$s={key:"error",class:"error-state"},Ms={class:"error-message"},Ns={key:"empty",class:"empty-state"},Rs={class:"empty-state-title"},Fs={class:"empty-state-message"},Hs={key:"tickets",class:"tickets-list-container"},Os={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null}},emits:["close"],setup(r,{emit:t}){const e=r,n=t,a=ze(),s=R(1),o=R("employees"),l=R(null),c=R([]),u=R([]),p=R(null),g=R(null),d=R(null);se(()=>s.value>1);const v=se(()=>{var m,b,w,N,q;switch(s.value){case 1:return((m=l.value)==null?void 0:m.stageName)||e.stageName;case 2:return((b=p.value)==null?void 0:b.employeeName)||"";case 3:return`${((w=p.value)==null?void 0:w.employeeName)||""} — ${((N=g.value)==null?void 0:N.dateCategoryLabel)||""}`;case 4:if(!((q=d.value)!=null&&q.context))return"Список тикетов";const U=d.value.context,ae=[];return U.employeeName&&ae.push(U.employeeName),U.dateCategoryLabel&&ae.push(U.dateCategoryLabel),U.departmentName&&ae.push(U.departmentName),U.stageName&&ae.push(U.stageName),ae.length>0?ae.join(" — "):"Список тикетов";default:return""}});function D(){var m,b,w;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employeesCount:((m=e.employees)==null?void 0:m.length)||0,hasSnapshot:!!e.snapshot,snapshotTicketIds:((w=(b=e.snapshot)==null?void 0:b.ticketIds)==null?void 0:w.length)||0,hasTicketDetails:!!e.ticketDetails,snapshotKeys:e.snapshot?Object.keys(e.snapshot):[]}),l.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:l.value.stageId,hasSnapshot:!!l.value.snapshot,employeesCount:l.value.employees.length,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null"}),p.value=null,g.value=null,d.value=null,s.value=1,o.value="employees",h(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function h(){if(!l.value||!l.value.snapshot||!l.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const m=l.value.snapshot.tickets||[],b=l.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:m.length,currentStageId:b,sampleTicket:m[0]?{id:m[0].id,stageId:m[0].stageId,hasDepartmentHead:!!m[0].departmentHead,departmentHead:m[0].departmentHead,hasDepartmentHeadFull:!!m[0].departmentHeadFull,departmentHeadFull:m[0].departmentHeadFull,allKeys:Object.keys(m[0])}:null});let w=m.filter(F=>F.stageId?qe(F.stageId)===b:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:m.length,afterFilter:w.length,stageId:b,ticketsWithStageId:w.filter(F=>F.stageId).length,ticketsWithoutStageId:w.filter(F=>!F.stageId).length});const N=w.filter(F=>!F.departmentHead&&!F.departmentHeadFull);if(N.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:N.length,totalTickets:w.length,ticketsWithDepartment:w.filter(X=>X.departmentHead||X.departmentHeadFull).length});const F=N.map(X=>X.id).filter(X=>X);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:F.length,ticketIdsSample:F.slice(0,10)});const X=await Rt.getTicketsDetails(F),O=new Map;X.forEach(I=>{I&&I.id&&O.set(I.id,I)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:X.length,detailsMapSize:O.size,sampleDetail:X[0]?{id:X[0].id,departmentHead:X[0].departmentHead,departmentHeadFull:X[0].departmentHeadFull}:null}),w=w.map(I=>{const M=O.get(I.id);return M?{...I,stageId:M.stageId||I.stageId||null,departmentHead:M.departmentHead||I.departmentHead||null,departmentHeadFull:M.departmentHeadFull||M.departmentHead||I.departmentHead||null}:I}),w=w.filter(I=>I.stageId?qe(I.stageId)===b:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:w.length,ticketsWithDepartment:w.filter(I=>I.departmentHead||I.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(I=>!I.departmentHead&&!I.departmentHeadFull).length,ticketsWithStageId:w.filter(I=>I.stageId).length,ticketsWithoutStageId:w.filter(I=>!I.stageId).length});const G=w.length,pe=w.slice(0,3).map(I=>({id:I.id,departmentHead:I.departmentHead,departmentHeadFull:I.departmentHeadFull,stageId:I.stageId}));w=w.filter(I=>I.stageId?qe(I.stageId)===b:!0);const De=w.slice(0,3).map(I=>({id:I.id,departmentHead:I.departmentHead,departmentHeadFull:I.departmentHeadFull,stageId:I.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:G,afterStageFilter:w.length,filteredOut:G-w.length,currentStageId:b,ticketsWithDepartment:w.filter(I=>I.departmentHead||I.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(I=>!I.departmentHead&&!I.departmentHeadFull).length,sampleBeforeFilter:pe,sampleAfterFilter:De,sampleWithDepartment:w.find(I=>I.departmentHead||I.departmentHeadFull)?{id:w.find(I=>I.departmentHead||I.departmentHeadFull).id,departmentHead:w.find(I=>I.departmentHead||I.departmentHeadFull).departmentHead,departmentHeadFull:w.find(I=>I.departmentHead||I.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(w.find(I=>I.departmentHead||I.departmentHeadFull)).filter(I=>I.toLowerCase().includes("department"))}:null})}catch(X){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",X),console.error("[EmployeeDetailsModal] Error details:",{message:X.message,stack:X.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:w.length,currentStageId:b,ticketsWithStageId:w.filter(F=>F.stageId).length,ticketsWithoutStageId:w.filter(F=>!F.stageId).length,ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const q=At(w);c.value=q,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:w.length,sampleTickets:w.slice(0,5).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,hasDepartmentHead:!!F.departmentHead,hasDepartmentHeadFull:!!F.departmentHeadFull,allKeys:Object.keys(F).filter(X=>X.toLowerCase().includes("department"))})),ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const U=da(w);u.value=U;const ae=q.reduce((F,X)=>F+X.count,0),ve=U.reduce((F,X)=>F+X.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:b,totalTicketsForGrouping:w.length,timeCategoriesCount:q.length,totalTicketsInTimeCategories:ae,departmentsCount:U.length,totalTicketsInDepartments:ve,departmentsSample:U.slice(0,5),ticketsWithDepartment:w.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:w.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,consistencyCheck:{totalTickets:w.length,timeCategoriesTotal:ae,departmentsTotal:ve,isConsistent:w.length===ae&&w.length===ve}})}catch(m){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",m),console.error("[EmployeeDetailsModal] Error stack:",m.stack)}}async function y(m){if(!m||m.count===0){a.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!g.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),a.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:b}=await Oe(async()=>{const{createContextFromLevel3:N}=await import("./ticketListUtils-DLAHlRJM.js");return{createContextFromLevel3:N}},__vite__mapDeps([0,1,2,3,4,5])),w=await b(g.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:w.employeeName,dateCategory:w.dateCategoryLabel,departmentName:w.departmentName,ticketsCount:w.tickets.length}),await Q(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",b),a.error("Ошибка перехода на список тикетов: "+b.message)}}async function k(m){if(!m||m.count===0){a.info(`У заказчика "${(m==null?void 0:m.departmentName)||"неизвестный"}" нет тикетов`);return}if(!l.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),a.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:b}=await Oe(async()=>{const{createContextFromLevel1Department:N}=await import("./ticketListUtils-DLAHlRJM.js");return{createContextFromLevel1Department:N}},__vite__mapDeps([0,1,2,3,4,5])),w=b(l.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:w.stageName,departmentName:w.departmentName,ticketsCount:w.tickets.length}),await Q(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",b),a.error("Ошибка перехода на список тикетов: "+b.message)}}async function T(m){if(!m||m.count===0){a.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){a.info(`В категории "${m.label}" нет тикетов`);return}if(!l.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),a.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:b}=await Oe(async()=>{const{createContextFromLevel1Time:N}=await import("./ticketListUtils-DLAHlRJM.js");return{createContextFromLevel1Time:N}},__vite__mapDeps([0,1,2,3,4,5])),w=b(l.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:w.stageName,dateCategory:w.dateCategoryLabel,ticketsCount:w.tickets.length}),await Q(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",b),a.error("Ошибка перехода на список тикетов: "+b.message)}}je(()=>e.isVisible,m=>{m?D():H()}),He(()=>{e.isVisible&&D()});async function z(m,b=null){var w,N,q;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",m),console.log("[EmployeeDetailsModal] Current popup level:",s.value),b&&b.currentTarget&&(b.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{b.currentTarget&&(b.currentTarget.style.transform="")},150)),!m||!m.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",m);return}if(l.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),l.value={stageName:e.stageName,stageId:e.stageId,totalCount:e.totalCount,employees:e.employees||[],others:e.others||null,snapshot:e.snapshot||null,ticketDetails:e.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:l.value.stageId,stageName:l.value.stageName,hasSnapshot:!!l.value.snapshot,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null",snapshotKeys:l.value.snapshot?Object.keys(l.value.snapshot):[]}),!l.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),a.warning("ID стадии не указан");return}if(!l.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",e.snapshot),a.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",m.id,"stage:",l.value.stageId);const U=await ca(m.id,l.value.stageId,l.value.snapshot,l.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(U==null?void 0:U.length)||0,U),!U||U.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),a.info(`У сотрудника "${m.name}" нет тикетов на стадии "${l.value.stageName}"`);return}const ae=At(U);console.log("[EmployeeDetailsModal] Date categories:",(ae==null?void 0:ae.length)||0,ae),p.value={employeeId:m.id,employeeName:m.name,stageId:l.value.stageId,stageName:l.value.stageName,totalCount:U.length,dateCategories:ae,snapshot:l.value.snapshot,ticketDetails:l.value.ticketDetails},console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),s.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",s.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:(w=p.value)==null?void 0:w.employeeName,dateCategoriesCount:((q=(N=p.value)==null?void 0:N.dateCategories)==null?void 0:q.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",s.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(U){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",U),console.error("[EmployeeDetailsModal] Error stack:",U.stack),a.error("Ошибка загрузки данных о тикетах: "+U.message)}}async function Z(m){if(!m||m.count===0){a.info(`В категории "${(m==null?void 0:m.label)||"неизвестная"}" нет тикетов`);return}if(!m.tickets||m.tickets.length===0){a.info(`В категории "${m.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),a.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:b}=await Oe(async()=>{const{createContextFromLevel2:N}=await import("./ticketListUtils-DLAHlRJM.js");return{createContextFromLevel2:N}},__vite__mapDeps([0,1,2,3,4,5])),w=b(p.value,m);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:w.employeeName,dateCategory:w.dateCategoryLabel,ticketsCount:w.tickets.length}),await Q(w)}catch(b){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",b),a.error("Ошибка перехода на список тикетов: "+b.message)}}async function Q(m){var b;if(console.time("[Performance] goToLevel4"),!m){console.error("[EmployeeDetailsModal] Context is required for level 4"),a.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:m.sourceLevel,employeeId:m.employeeId,stageId:m.stageId,dateCategory:m.dateCategory,departmentName:m.departmentName,ticketsCount:((b=m.tickets)==null?void 0:b.length)||0});try{d.value={context:m,tickets:[],totalCount:0,isLoading:!0,error:null};let w=m.tickets||[];if(w.length===0&&m.snapshot){const{filterTicketsByContext:q}=await Oe(async()=>{const{filterTicketsByContext:U}=await import("./ticketListUtils-DLAHlRJM.js");return{filterTicketsByContext:U}},__vite__mapDeps([0,1,2,3,4,5]));w=await q(m)}(!w||w.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),w=m.tickets||[]),(!w||w.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),m.snapshot&&m.snapshot.tickets&&(w=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",w.length)));let N=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:q}=await Oe(async()=>{const{prepareTicketsForDisplay:U}=await import("./ticketListUtils-DLAHlRJM.js");return{prepareTicketsForDisplay:U}},__vite__mapDeps([0,1,2,3,4,5]));N=await q(w,m.snapshot,m.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(q){console.error("[EmployeeDetailsModal] Error preparing tickets:",q),console.timeEnd("[Performance] prepareTicketsForDisplay"),N=w||[],a.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:w.length,preparedCount:N.length}),d.value={context:m,tickets:N,totalCount:N.length,isLoading:!1,error:null},s.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:d.value.totalCount,ticketsCount:d.value.tickets.length,isLoading:d.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(w){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",w),console.error("[EmployeeDetailsModal] Error details:",{message:w.message,stack:w.stack,context:m});let N=[];if(m.snapshot&&m.snapshot.tickets)try{const q=m.stageId;q?N=(m.snapshot.tickets||[]).filter(U=>U.stageId===q):N=m.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",N.length)}catch(q){console.error("[EmployeeDetailsModal] Error using fallback tickets:",q)}d.value={context:m,tickets:N,totalCount:N.length,isLoading:!1,error:{message:w.message,hasFallback:N.length>0}},N.length>0?(a.warning("Ошибка загрузки данных. Отображаются данные из кеша."),s.value=4):(a.error("Ошибка загрузки тикетов: "+w.message),L()),console.timeEnd("[Performance] goToLevel4")}}function L(){if(s.value===4){if(d.value&&d.value.context){const m=d.value.context.sourceLevel;s.value=m}else s.value=1;d.value=null}else s.value===3?(s.value=2,g.value=null,d.value=null):s.value===2&&(s.value=1,p.value=null,g.value=null,d.value=null)}function H(){s.value=1,l.value=null,p.value=null,g.value=null,d.value=null}function W(){var q;if(!((q=d.value)!=null&&q.context))return"Нет тикетов";const{sourceLevel:m,employeeName:b,dateCategoryLabel:w,departmentName:N}=d.value.context;return m===2&&b&&w?`Нет тикетов у ${b} в категории "${w}"`:m===3&&b&&N?`Нет тикетов у ${b} у заказчика "${N}"`:m===1&&w?`Нет тикетов в категории "${w}"`:m===1&&N?`Нет тикетов у заказчика "${N}"`:"Нет тикетов для отображения"}function re(){var b;if(!((b=d.value)!=null&&b.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:m}=d.value.context;return m?`На стадии "${m}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function de(){var b;if(!((b=d.value)!=null&&b.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const m=d.value.context;await Q(m)}function ie(m){if(!m){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),a.warning("Ошибка: тикет не найден");return}if(!m.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",m),a.error("Ошибка: ID тикета не указан");return}try{const b=Xt(m.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:m.id,iframeUrl:b}),!b||typeof b!="string"||b.length===0)throw new Error("Не удалось сформировать URL для тикета");const w=window.open(b,"_blank","noopener,noreferrer");if(!w||w.closed||typeof w.closed>"u")try{const N=document.createElement("a");N.href=b,N.target="_blank",N.rel="noopener noreferrer",N.style.display="none",document.body.appendChild(N),N.click(),document.body.removeChild(N),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:m.id,iframeUrl:b})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:m.id,iframeUrl:b})}catch(b){console.error("[EmployeeDetailsModal] Error opening ticket:",b),console.error("[EmployeeDetailsModal] Error details:",{message:b.message,stack:b.stack,ticket:m}),a.error("Ошибка открытия тикета: "+b.message)}}function ye(){H(),n("close")}return(m,b)=>(S(),Ae($t,{to:"body"},[r.isVisible?(S(),_("div",{key:0,class:"employee-details-modal",onClick:ge(ye,["self"]),onKeydown:Pt(ye,["esc"])},[i("div",ua,[ue(Ue,{name:"level",mode:"out-in"},{default:Ce(()=>{var w,N,q,U,ae,ve,F,X,O,G,pe,De,I;return[s.value===1?(S(),_("div",pa,[i("div",ga,[i("h3",null,P(((w=l.value)==null?void 0:w.stageName)||r.stageName),1),i("span",fa,"Всего: "+P(((N=l.value)==null?void 0:N.totalCount)||r.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),i("div",ma,[i("button",{class:le(["view-switch-btn",{active:o.value==="employees"}]),onClick:b[0]||(b[0]=M=>o.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),i("button",{class:le(["view-switch-btn",{active:o.value==="time"}]),onClick:b[1]||(b[1]=M=>o.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),i("button",{class:le(["view-switch-btn",{active:o.value==="departments"}]),onClick:b[2]||(b[2]=M=>o.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),i("div",ha,[o.value==="employees"?(S(),_("div",va,[(((q=l.value)==null?void 0:q.employees)||r.employees).length===0&&(!((U=l.value)!=null&&U.others||r.others)||(((ae=l.value)==null?void 0:ae.others)||r.others).count===0)?(S(),_("div",ya," Нет данных о сотрудниках ")):(S(),_("div",ka,[(S(!0),_(me,null,he(((ve=l.value)==null?void 0:ve.employees)||r.employees,M=>(S(),_("div",{key:M.id,class:le(["employee-item",{"employee-keeper":M.isKeeper}]),onClick:ge(ce=>z(M,ce),["stop"]),title:"Кликните для детализации по временным градациям"},[i("span",ba,P(M.name),1),i("div",Da,[i("div",{class:"progress-bar",style:be({width:M.progressBarWidth+"%",backgroundColor:M.progressBarColor})},null,4)]),i("span",Sa,P(M.count)+" тикетов ("+P(M.percentage)+"%) ",1),b[3]||(b[3]=i("span",{class:"employee-arrow"},"→",-1))],10,wa))),128)),((F=l.value)!=null&&F.others||r.others)&&(((X=l.value)==null?void 0:X.others)||r.others).count>0?(S(),_("div",Ea,[i("span",_a,"Другие ("+P((((O=l.value)==null?void 0:O.others)||r.others).employeeCount)+")",1),i("div",Ta,[i("div",{class:"progress-bar",style:be({width:(((G=l.value)==null?void 0:G.others)||r.others).progressBarWidth+"%",backgroundColor:(((pe=l.value)==null?void 0:pe.others)||r.others).progressBarColor})},null,4)]),i("span",Ca,P((((De=l.value)==null?void 0:De.others)||r.others).count)+" тикетов ("+P((((I=l.value)==null?void 0:I.others)||r.others).percentage)+"%) ",1)])):te("",!0)]))])):o.value==="time"?(S(),_("div",Aa,[c.value.length===0?(S(),_("div",Ia," Загрузка данных... ")):(S(),_("div",$a,[(S(!0),_(me,null,he(c.value,M=>(S(),_("div",{key:M.category,class:"category-item",onClick:ge(ce=>T(M),["stop"])},[i("span",Na,P(M.label),1),i("div",Ra,[i("div",{class:"progress-bar",style:be({width:M.progressBarWidth+"%",backgroundColor:M.progressBarColor})},null,4)]),i("span",Fa,P(M.count)+" тикетов ("+P(M.percentage)+"%) ",1),b[4]||(b[4]=i("span",{class:"category-arrow"},"→",-1))],8,Ma))),128))]))])):o.value==="departments"?(S(),_("div",Ha,[u.value.length===0?(S(),_("div",Oa," Загрузка данных... ")):(S(),_("div",xa,[i("table",Pa,[b[6]||(b[6]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(S(!0),_(me,null,he(u.value,(M,ce)=>(S(),_("tr",{key:ce,class:"department-row",onClick:ge(ke=>k(M),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",Ba,[i("span",ja,P(M.departmentName),1)]),i("td",Wa,[i("span",Ua,P(M.count),1)]),b[5]||(b[5]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,La))),128))])])]))])):te("",!0)])])):s.value===2&&p.value?(S(),_("div",za,[i("div",Va,[i("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),i("h3",null,P(p.value.employeeName),1),i("span",Ka,"Всего: "+P(p.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),i("div",Ga,[i("div",Ya,[i("span",qa,P(p.value.stageName),1)]),p.value.dateCategories.length===0?(S(),_("div",Xa," Нет данных о тикетах ")):(S(),_("div",Ja,[(S(!0),_(me,null,he(p.value.dateCategories,M=>(S(),_("div",{key:M.category,class:"category-item",onClick:ge(ce=>Z(M),["stop"])},[i("span",Qa,P(M.label),1),i("div",es,[i("div",{class:"progress-bar",style:be({width:M.progressBarWidth+"%",backgroundColor:M.progressBarColor})},null,4)]),i("span",ts,P(M.count)+" тикетов ("+P(M.percentage)+"%) ",1)],8,Za))),128))]))])])):s.value===3&&g.value?(S(),_("div",as,[i("div",ss,[i("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),i("div",ns,[i("h3",null,P(g.value.employeeName),1),i("div",os,[i("span",ls,P(g.value.dateCategoryLabel),1),i("span",rs,P(g.value.stageName),1)])]),i("span",is,"Всего: "+P(g.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),i("div",cs,[g.value.departments.length===0?(S(),_("div",ds," Нет данных о заказчиках ")):(S(),_("div",us,[i("table",ps,[b[8]||(b[8]=i("thead",null,[i("tr",null,[i("th",{class:"col-department"},"Заказчик"),i("th",{class:"col-count"},"Количество тикетов"),i("th",{class:"col-action"})])],-1)),i("tbody",null,[(S(!0),_(me,null,he(g.value.departments,(M,ce)=>(S(),_("tr",{key:ce,class:"department-row",onClick:ge(ke=>y(M),["stop"]),title:"Кликните для просмотра тикетов"},[i("td",fs,[i("span",ms,P(M.departmentName),1)]),i("td",hs,[i("span",vs,P(M.count),1)]),b[7]||(b[7]=i("td",{class:"col-action"},[i("span",{class:"department-arrow"},"→")],-1))],8,gs))),128))])])]))])])):s.value===4&&d.value?(S(),_("div",ys,[i("div",ks,[i("button",{class:"btn-back",onClick:L,"aria-label":"Назад"}," ← "),i("div",ws,[i("h3",null,P(v.value),1),d.value.context?(S(),_("div",bs,[d.value.context.dateCategoryLabel?(S(),_("span",Ds,P(d.value.context.dateCategoryLabel),1)):te("",!0),d.value.context.departmentName?(S(),_("span",Ss,P(d.value.context.departmentName),1)):te("",!0),i("span",Es,P(d.value.context.stageName),1)])):te("",!0)]),i("span",_s,"Всего: "+P(d.value.totalCount)+" тикетов",1),i("button",{class:"modal-close",onClick:ye,"aria-label":"Закрыть"},"×")]),i("div",Ts,[ue(Ue,{name:"loading",mode:"out-in"},{default:Ce(()=>[d.value.isLoading?(S(),_("div",Cs,[...b[9]||(b[9]=[i("div",{class:"loading-spinner"},null,-1),i("p",null,"Загрузка тикетов...",-1)])])):d.value.error&&d.value.error.hasFallback?(S(),_("div",As,[b[10]||(b[10]=i("div",{class:"error-banner"},[i("span",{class:"error-icon"},"⚠️"),i("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),i("div",Is,[ue(bt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Ce(()=>[(S(!0),_(me,null,he(d.value.tickets,(M,ce)=>(S(),Ae(Tt,{key:M.id,ticket:M,draggable:!1,style:be({"--ticket-index":ce}),onClick:ke=>ie(M)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):d.value.error&&!d.value.error.hasFallback?(S(),_("div",$s,[b[11]||(b[11]=i("div",{class:"error-icon"},"❌",-1)),b[12]||(b[12]=i("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),i("p",Ms,P(d.value.error.message),1),i("button",{class:"btn-retry",onClick:de},"Повторить попытку")])):!d.value.tickets||d.value.tickets.length===0?(S(),_("div",Ns,[b[13]||(b[13]=i("div",{class:"empty-state-icon"},"📭",-1)),i("h3",Rs,P(W()),1),i("p",Fs,P(re()),1)])):(S(),_("div",Hs,[ue(bt,{name:"ticket",tag:"div",class:"tickets-list"},{default:Ce(()=>[(S(!0),_(me,null,he(d.value.tickets,(M,ce)=>(S(),Ae(Tt,{key:M.id,ticket:M,draggable:!1,style:be({"--ticket-index":ce}),onClick:ke=>ie(M)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):te("",!0)]}),_:1})])],32)):te("",!0)]))}},xs=Ie(Os,[["__scopeId","data-v-d8e1ab60"]]),Le=10;function Xe(r,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(a=>a.ticketsByStage&&a.ticketsByStage[r]>0).forEach(a=>{e.push({id:a.id,name:a.name,count:a.ticketsByStage[r]||0})});const n=Ps(r,t);return n>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:n,isKeeper:!0}),e.sort((a,s)=>s.count-a.count)}function Ps(r,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[r])return t.statistics.zeroPointByStage[r].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Ft(r,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[r])==null?void 0:e.count)||0}function Je(r,t=Le){if(!r||r.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...r].sort((o,l)=>l.count-o.count),n=e.slice(0,t),a=e.slice(t),s=a.reduce((o,l)=>o+l.count,0);return{visible:n,others:{employees:a,count:s,employeeCount:a.length}}}function Ht(r,t){return!r||r.length===0?[]:t===0?r.map(e=>({...e,percentage:0})):r.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function Ot(r,t,e="#007bff",n=Le){if(!r||r.length===0)return{employees:[],others:null};const{visible:a,others:s}=Je(r,n),o=Ht(a,t).map(c=>({...c,progressBarWidth:c.percentage,progressBarColor:c.isKeeper?"#f59e0b":e}));let l=null;if(s.count>0){const c=parseFloat((s.count/t*100).toFixed(1));l={...s,percentage:c,progressBarWidth:c,progressBarColor:"#6c757d"}}return{employees:o,others:l}}function Ls(r,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(a=>{const s=t[a];if(!s)return;const o=Xe(r,s),l=Ft(r,s);if(o.length===0)return;const{visible:c,others:u}=Je(o,Le),p=Ht(c,l);e[a]=p,u.count>0&&(e.others[a]={count:u.count,employeeCount:u.employeeCount,percentage:parseFloat((u.count/l*100).toFixed(1))})}),e}function Bs(r,t="current",e=[]){const n=r[t];if(!n)return{labels:[],datasets:[]};const a=new Map;e.forEach(g=>{Xe(g.id,n).forEach(v=>{a.has(v.id)||a.set(v.id,{id:v.id,name:v.name,isKeeper:v.isKeeper||!1,ticketsByStage:{}}),a.get(v.id).ticketsByStage[g.id]=v.count})});const s=Array.from(a.values()).map(g=>{const d=Object.values(g.ticketsByStage).reduce((v,D)=>v+D,0);return{...g,totalTickets:d}});s.sort((g,d)=>d.totalTickets-g.totalTickets);const{visible:o,others:l}=Je(s,Le),c=e.map(()=>""),u={};e.forEach(g=>{const d=Xe(g.id,n),{visible:v}=Je(d,Le);u[g.id]=v.map(D=>({id:D.id,name:D.name,count:D.count}))});const p=o.map((g,d)=>{const v=e.map(h=>g.ticketsByStage[h.id]||0),D=e.map(h=>{if((g.ticketsByStage[h.id]||0)===0)return"transparent";const T=h.color.replace("#",""),z=parseInt(T.substring(0,2),16),Z=parseInt(T.substring(2,4),16),Q=parseInt(T.substring(4,6),16),L=.6+d*.05;return`rgba(${z}, ${Z}, ${Q}, ${Math.min(L,.95)})`});return{label:g.name,data:v,backgroundColor:D,borderColor:e.map(h=>{const y=h.color.replace("#",""),k=parseInt(y.substring(0,2),16),T=parseInt(y.substring(2,4),16),z=parseInt(y.substring(4,6),16);return`rgba(${k}, ${T}, ${z}, 0.8)`}),borderWidth:1,meta:{employeeId:g.id,employeeName:g.name}}});if(l.count>0){const g=e.map(d=>l.employees.reduce((v,D)=>v+(D.ticketsByStage[d.id]||0),0));p.push({label:`Другие (${l.employeeCount})`,data:g,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:c,datasets:p,meta:{employeesByStage:u}}}function js(r,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const n=e.find(u=>u.id===r),a=n?n.name:"",s=n?n.color:"#007bff",o=Xe(r,t),l=Ft(r,t);if(o.length===0)return{stageName:a,totalCount:0,employees:[],others:null};const c=Ot(o,l,s,Le);return{stageName:a,totalCount:l,employees:c.employees,others:c.others}}function Ws(r,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof r!="number"||r<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const n=[];if(t.forEach((o,l)=>{if(!o||!o.data||!Array.isArray(o.data))return;const c=o.data[r];c!=null&&!isNaN(c)&&n.push({datasetIndex:l,value:Number(c),y:Number(c)})}),n.length<2)return 0;const a=[];return n.forEach(o=>{let l=!1;for(const c of a){const u=c.y;if(Math.abs(o.y-u)<e){c.points.push(o),c.y=c.points.reduce((g,d)=>g+d.y,0)/c.points.length,l=!0;break}}l||a.push({points:[o],y:o.y})}),a.length===0?0:a.reduce((o,l)=>l.points.length>o.points.length?l:o,a[0]).points.length}function Us(r,t){const e=[];return r.forEach(n=>{let a=!1;for(const s of e){const o=s.y;if(Math.abs(n.value-o)<t){s.points.push(n),s.y=s.points.reduce((l,c)=>l+c.value,0)/s.points.length,a=!0;break}}a||e.push({points:[n],y:n.value})}),e}function zs(r,t=.5){var s,o;if(!r)return console.warn("findOverlappingPoints: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];const e=(s=r.data)==null?void 0:s.datasets,n=((o=r.data)==null?void 0:o.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(n)||n.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const a=[];return n.forEach((l,c)=>{try{if(Ws(c,e,t)<2)return;const p=[];if(e.forEach((h,y)=>{if(!h||!h.data||!Array.isArray(h.data))return;const k=h.data[c];k==null||isNaN(k)||p.push({datasetIndex:y,value:Number(k),label:h.label||`Dataset ${y}`})}),p.length<2)return;const g=Us(p,t);if(g.length===0)return;const d=g.reduce((h,y)=>y.points.length>h.points.length?y:h,g[0]);if(d.points.length<2)return;let v=null,D=null;for(let h=0;h<e.length;h++)try{const y=r.getDatasetMeta(h);if(y&&y.data&&y.data[c]){v=y,D=y.data[c];break}}catch{continue}if(!D||typeof D.x!="number"||typeof D.y!="number")return;a.push({position:c,count:d.points.length,x:D.x,y:D.y,value:d.y,points:d.points.map(h=>({datasetIndex:h.datasetIndex,value:h.value,label:h.label}))})}catch(u){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${c}:`,u)}}),a}function Vs(r,t){const e=[];return r.forEach(n=>{let a=!1;for(const s of e){const o=s.y;if(Math.abs(n.y-o)<t){s.points.push(n),s.y=s.points.reduce((l,c)=>l+c.y,0)/s.points.length,a=!0;break}}a||e.push({points:[n],y:n.y})}),e}function Ks(r,t,e=.5){var u,p;if(!r)return console.warn("calculatePointJitter: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const n=(u=r.data)==null?void 0:u.datasets,a=((p=r.data)==null?void 0:p.labels)||[];if(!n||!Array.isArray(n)||n.length===0)return[];if(!Array.isArray(a)||t>=a.length)return[];const s=[];if(n.forEach((g,d)=>{if(!g||!g.data||!Array.isArray(g.data))return;const v=g.data[t];if(!(v==null||isNaN(v)))try{const D=r.getDatasetMeta(d);if(D&&D.data&&D.data[t]){const h=D.data[t];h&&typeof h.x=="number"&&typeof h.y=="number"&&s.push({datasetIndex:d,value:Number(v),x:h.x,y:h.y})}}catch(D){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${d}:`,D)}}),s.length===0)return[];const o=Vs(s,e),l=[];o.forEach(g=>{const d=g.points||[];d.length>1?d.forEach((D,h)=>{const y=(h-(d.length-1)/2)*4;l.push({datasetIndex:D.datasetIndex,jitterX:y,value:D.value})}):d.length===1&&l.push({datasetIndex:d[0].datasetIndex,jitterX:0,value:d[0].value})});const c=new Set(l.map(g=>g.datasetIndex));return s.forEach(g=>{c.has(g.datasetIndex)||l.push({datasetIndex:g.datasetIndex,jitterX:0,value:g.value})}),l}const Gs=.5,It=6,Ys=2;function qs(r){return typeof r!="number"||r<2?It:It+(r-1)*Ys}function Xs(r,t){if(!r||!r.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const n=r.ctx,{x:a,y:s,points:o}=t,l=qs(e);if(n.canvas){n.save();try{n.beginPath(),n.arc(a,s,l,0,2*Math.PI);let u="rgba(128, 128, 128, 0.3)";if(o&&o.length>0&&r.data&&r.data.datasets){const p=o[0].datasetIndex,g=r.data.datasets[p];if(g&&g.pointBackgroundColor){const d=Array.isArray(g.pointBackgroundColor)?g.pointBackgroundColor[t.position]||g.pointBackgroundColor[0]:g.pointBackgroundColor;if(d)if(d.startsWith("#")){const v=parseInt(d.slice(1,3),16),D=parseInt(d.slice(3,5),16),h=parseInt(d.slice(5,7),16);u=`rgba(${v}, ${D}, ${h}, 0.4)`}else d.startsWith("rgba")?u=d.replace(/rgba?\(([^)]+)\)/,(v,D)=>{const h=D.split(",").map(y=>y.trim());return`rgba(${h[0]}, ${h[1]}, ${h[2]}, 0.4)`}):u=d+"66"}}n.fillStyle=u,n.fill(),n.strokeStyle=u.replace("0.4","0.6").replace("66","99"),n.lineWidth=1,n.stroke()}catch(u){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",u)}finally{n.restore()}}}const Js={id:"overlappingPointsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const t=zs(r,Gs);if(!Array.isArray(t)||t.length===0)return;t.filter(n=>!(!n||typeof n!="object"||typeof n.count!="number"||n.count<2||typeof n.x!="number"||typeof n.y!="number"||!isFinite(n.x)||!isFinite(n.y))).forEach(n=>{try{Xs(r,n)}catch(a){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${n.position}:`,a)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},Zs=.5,Qs={id:"pointJitterPlugin",beforeDatasetsDraw:r=>{var t,e;if(!(!r||!r.config||r.config.type!=="line")){r._jitterData||(r._jitterData={});try{const n=(t=r.data)==null?void 0:t.datasets,a=((e=r.data)==null?void 0:e.labels)||[];if(!n||!Array.isArray(n)||n.length===0||!Array.isArray(a)||a.length===0)return;r._jitterData={},a.forEach((s,o)=>{const l=Ks(r,o,Zs);l&&l.length>0&&l.forEach(c=>{const u=`${c.datasetIndex}_${o}`;r._jitterData[u]=c.jitterX})})}catch(n){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",n)}}},afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx&&!(!r._jitterData||Object.keys(r._jitterData).length===0))try{const e=r.ctx,n=(t=r.data)==null?void 0:t.datasets;if(!n||!Array.isArray(n)||n.length===0)return;n.forEach((a,s)=>{const o=r.getDatasetMeta(s);!o||o.hidden||!a.data||!Array.isArray(a.data)||a.data.forEach((l,c)=>{const u=o.data[c];if(!u||typeof u.x!="number"||typeof u.y!="number"||l==null||isNaN(l))return;const p=`${s}_${c}`,g=r._jitterData[p];if(!(g===void 0||g===0)){e.save();try{const d=a.pointStyle||"circle",v=(a.pointRadius||7)+1,D=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[c]||a.pointBackgroundColor[0]:a.pointBackgroundColor,h=Array.isArray(a.pointBorderColor)?a.pointBorderColor[c]||a.pointBorderColor[0]:a.pointBorderColor,y=a.pointBorderWidth||1,k=u.x+g,T=u.y;switch(e.fillStyle=D||"#007bff",e.strokeStyle=h||"#ffffff",e.lineWidth=y,e.beginPath(),d){case"circle":e.arc(k,T,v,0,2*Math.PI);break;case"triangle":e.moveTo(k,T-v),e.lineTo(k-v,T+v),e.lineTo(k+v,T+v),e.closePath();break;case"rect":case"rectRounded":const z=v*1.4;e.rect(k-z/2,T-z/2,z,z);break;case"rectRot":const Z=v*1.4;e.moveTo(k,T-Z/2),e.lineTo(k+Z/2,T),e.lineTo(k,T+Z/2),e.lineTo(k-Z/2,T),e.closePath();break;case"star":const Q=v;for(let W=0;W<5;W++){const re=W*4*Math.PI/5-Math.PI/2,de=k+Q*Math.cos(re),ie=T+Q*Math.sin(re);W===0?e.moveTo(de,ie):e.lineTo(de,ie)}e.closePath();break;case"cross":const L=v;e.moveTo(k-L,T-L),e.lineTo(k+L,T+L),e.moveTo(k+L,T-L),e.lineTo(k-L,T+L);break;case"crossRot":const H=v;e.moveTo(k-H,T),e.lineTo(k+H,T),e.moveTo(k,T-H),e.lineTo(k,T+H);break;default:e.arc(k,T,v,0,2*Math.PI)}d!=="cross"&&d!=="crossRot"&&e.fill(),e.stroke(),u._originalX||(u._originalX=u.x,u._originalY=u.y),u._jitterX=g,u._jitteredX=k,u._jitteredY=T}catch(d){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${s}_${c}:`,d)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:r=>{r._jitterData}},en={id:"pointLabelsPlugin",afterDatasetsDraw:r=>{var t;if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=r.ctx,n=(t=r.data)==null?void 0:t.datasets;if(!n||!Array.isArray(n)||n.length===0)return;n.forEach((a,s)=>{const o=r.getDatasetMeta(s);if(!o||o.hidden||!a.data||!Array.isArray(a.data))return;const l=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[0]||"#6b7280":a.pointBackgroundColor||"#6b7280";a.data.forEach((c,u)=>{const p=o.data[u];if(!p||typeof p.x!="number"||typeof p.y!="number"||c==null||isNaN(c))return;const g=p._jitteredX!==void 0?p._jitteredX:p.x,d=p._jitteredY!==void 0?p._jitteredY:p.y,v=g+8,D=d-5,h=String(Math.round(c));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const k=e.measureText(h).width,T=11,z=3,Z=v-z,Q=D-T/2-z,L=k+z*2,H=T+z*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(Z,Q,L,H),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(Z,Q,L,H),e.fillStyle=l,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(h,v,D)}catch(y){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${s}_${u}:`,y)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},tn={class:"graph-state-chart"},an={class:"chart-header"},sn={class:"chart-type-selector"},nn=["onClick","title"],on={class:"chart-type-icon"},ln={class:"chart-type-label"},rn={key:0,class:"comparison-type-selector"},cn={class:"radio-group"},dn={key:0},un={key:1},pn={key:2,class:"graph-legend"},gn={key:4,class:"error-container"},fn={class:"error-message"},mn={class:"chart-wrapper"},hn={class:"chart-canvas-container"},vn={key:0,class:"bar-chart-stage-labels"},yn={key:6,class:"no-data"},kn={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(r,{emit:t}){const e=(C,f)=>typeof window>"u"?f:getComputedStyle(document.documentElement).getPropertyValue(C).trim()||f,n=r,a=t,s=R(!1),o=R(null),l=R(null),c=R({weekStart:null,weekEnd:null,current:null}),u=R(null),p=R("weekStartToWeekEnd"),g=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],d=R("line"),v=R(!1),D=R(""),h=R(""),y=R(0),k=R([]),T=R(null),z=R(null),Z=R(null),Q=R([]),L=se(()=>{switch(d.value){case"line":return Dt;case"bar":return Gt;case"doughnut":return Kt;default:return Dt}}),H={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},W=[{id:"formed",name:"Сформировано обращение",color:H.formed},{id:"review",name:"Рассмотрение ТЗ",color:H.review},{id:"execution",name:"Исполнение",color:H.execution}],re=["circle","triangle","rect","rectRot","star","cross","crossRot"],de=R({formed:!0,review:!0,execution:!0}),ie=ze(),ye={id:"employeeLabelsPlugin",afterDatasetsDraw:C=>{if(C.config.type==="bar")try{const f=C.ctx;if(!C.data||!C.data.datasets)return;const E=C.data.datasets,A=C.scales.y;E.forEach(($,B)=>{const x=C.getDatasetMeta(B);if(!x||x.hidden)return;const Y=$.label||"";if(!Y||Y.includes("Другие"))return;const K=Y.trim().split(/\s+/);let j="";if(K.length===1)j=K[0];else{const V=K[0],ee=K.slice(1).join(" ");j=`${V}
${ee}`}const J=j.split(`
`);$.data.forEach((V,ee)=>{if(V===0||!V)return;const ne=x.data[ee];if(!ne||typeof ne.x!="number"||typeof ne.y!="number")return;const we=ne.x,Me=ne.y+ne.height+25;f.save(),f.font="bold 9px Arial, sans-serif",f.fillStyle="#6b7280",f.textAlign="center",f.textBaseline="top",f.translate(we,Me),f.rotate(-12*Math.PI/180),J.forEach((Se,Ne)=>{const Re=Se.trim();Re&&f.fillText(Re,0,Ne*11)}),f.restore()})})}catch(f){console.error("Error in employeeLabelsPlugin:",f)}}};Ve.register(ye);function m(){const C=new Map;[c.value.weekStart,c.value.weekEnd,c.value.current].forEach(f=>{!f||!f.statistics||!f.statistics.employees||f.statistics.employees.forEach(E=>{C.has(E.id)||C.set(E.id,{id:E.id,name:E.name})})}),Q.value=Array.from(C.values()).sort((f,E)=>f.name.localeCompare(E.name))}function b(C,f="background"){var A;return((A={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[C])==null?void 0:A[f])||e("--b24-text-secondary","#6c757d")}function w(){if(!(!c.value.weekStart||!c.value.weekEnd))try{const C=ot.compareTwoSnapshots(c.value.weekStart,c.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let f=null,E=null;c.value.current&&(f=ot.compareTwoSnapshots(c.value.weekEnd,c.value.current,{includeTickets:!1,includeEmployees:!0}),E=ot.compareTwoSnapshots(c.value.weekStart,c.value.current,{includeTickets:!1,includeEmployees:!0})),u.value={weekStartToWeekEnd:C,weekEndToCurrent:f,weekStartToCurrent:E}}catch(C){console.error("Ошибка сравнения слепков:",C),ie.warning("Не удалось выполнить сравнение слепков: "+C.message)}}function N(C){return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[C]||"formed"}function q(C){return N(C)}function U(C){return C===0?"weekStart":C===1?"weekEnd":C===2?"current":"weekEnd"}function ae(C){return c.value[C]||null}function ve(C,f,E,A,$=null,B=null,x=null){var Y;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:C,stageId:f,totalCount:E,employeesCount:(A==null?void 0:A.length)||0,hasSnapshot:!!B,snapshotTicketIds:((Y=B==null?void 0:B.ticketIds)==null?void 0:Y.length)||0}),D.value=C,h.value=f||"",y.value=E,k.value=A||[],T.value=$&&$.count>0?$:null,z.value=B,Z.value=x,v.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:h.value,hasCurrentSnapshot:!!z.value})}function F(C,f,E){var Y,K,j,J,V,ee;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:C,timePoint:f,employeeDataCount:E==null?void 0:E.length});const A=W.find(ne=>ne.id===C);if(!A){console.warn("[GraphStateChart] Stage not found:",C);return}const $=ae(f);if(console.log("[GraphStateChart] Snapshot for timePoint:",f,$?"found":"not found"),!$){console.warn("[GraphStateChart] Snapshot not found for timePoint:",f),console.warn("[GraphStateChart] Available snapshots:",{weekStart:!!c.value.weekStart,weekEnd:!!c.value.weekEnd,current:!!c.value.current});return}if(console.log("[GraphStateChart] Snapshot structure:",{hasTickets:!!$.tickets,ticketsIsArray:Array.isArray($.tickets),ticketsLength:((Y=$.tickets)==null?void 0:Y.length)||0,hasTicketIds:!!$.ticketIds,ticketIdsLength:((K=$.ticketIds)==null?void 0:K.length)||0,hasMetadata:!!$.metadata,hasStatistics:!!$.statistics,snapshotKeys:Object.keys($),snapshotType:typeof $}),!$.tickets||!Array.isArray($.tickets)){console.error("[GraphStateChart] ERROR: Snapshot does not have tickets array!"),console.error("[GraphStateChart] Snapshot:",$),ie.warning("Слепок не содержит данных о тикетах");return}const B=((V=(J=(j=$.statistics)==null?void 0:j.stages)==null?void 0:J[C])==null?void 0:V.count)||0;console.log("[GraphStateChart] Total count for stage:",B);const x=Ot(E,B,A.color,10);console.log("[GraphStateChart] Opening modal with:",{stageName:A.name,stageId:C,totalCount:B,employeesCount:((ee=x.employees)==null?void 0:ee.length)||0,hasSnapshot:!!$,snapshotHasTickets:!!$.tickets}),ve(A.name,C,B,x.employees,x.others,$,null)}function X(C,f){if(!f||!f.employees||f.employees.length===0){ie.warning("Нет данных о сотрудниках для этого этапа");return}const E=c.value.current||c.value.weekEnd||c.value.weekStart;ve(f.stageName,C,f.totalCount,f.employees,f.others,E,null)}function O(){v.value=!1,D.value="",h.value="",y.value=0,k.value=[],T.value=null,z.value=null,Z.value=null}function G(C,f,E){var J,V;if(d.value!=="line"||f.length===0)return;const A=f[0],$=A.datasetIndex,B=A.index,x=E.data.datasets[$];if(!x||!x.meta)return;const Y=q(x.label),K=U(B),j=(V=(J=x.meta)==null?void 0:J.employees)==null?void 0:V[K];!j||j.length===0||F(Y,K,j)}function pe(C,f,E){var J,V;if(d.value!=="doughnut"||f.length===0)return;const $=f[0].index,B=E.data,x=B.labels[$],Y=q(x),K=(V=(J=B.datasets[0])==null?void 0:J.meta)==null?void 0:V.employees,j=K==null?void 0:K[Y];if(!j){console.warn("Данные о сотрудниках не найдены для этапа:",Y);return}X(Y,j)}function De(C){var A;const f=W[C];if(!f)return 0;const E=c.value.current||c.value.weekEnd||c.value.weekStart;return!E||!E.statistics||!E.statistics.stages?0:((A=E.statistics.stages[f.id])==null?void 0:A.count)||0}function I(C){var $;const f=W.find(B=>B.id===C);if(!f)return"";const E=c.value.current||c.value.weekEnd||c.value.weekStart;if(!E||!E.statistics||!E.statistics.stages)return f.name;const A=(($=E.statistics.stages[C])==null?void 0:$.count)||0;return`${f.name} (${A})`}const M=se(()=>{if(!l.value)return null;if(d.value==="doughnut"||d.value==="bar")return l.value;const C=l.value.datasets.filter(f=>{const E=W.find(A=>A.name===f.label);return E?de.value[E.id]:!0});return{...l.value,datasets:C}});se(()=>d.value!=="bar"||!l.value||!l.value.meta?null:l.value.meta.employeesByStage||null);const ce=se(()=>{const C={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:d.value==="bar"?{bottom:80}:{}},onClick:(f,E,A)=>{d.value==="line"?G(f,E,A):d.value==="doughnut"&&pe(f,E,A)},onHover:(f,E,A)=>{d.value==="doughnut"&&(f.native.target.style.cursor=E.length>0?"pointer":"default")},plugins:{legend:{display:d.value!=="bar",position:d.value==="doughnut"?"right":"top",onClick:(f,E,A)=>{if(d.value==="bar"){const B=E.datasetIndex;if(B!==void 0){const x=A.chart.getDatasetMeta(B);x.hidden=!x.hidden,A.chart.update()}return}const $=E.datasetIndex;if($!==void 0){const B=A.chart.getDatasetMeta($);B.hidden=!B.hidden,A.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:f=>{if(d.value==="bar"){const E=f[0].dataIndex,A=W[E];return A?A.name:""}return f[0].label||""},label:f=>{var B,x,Y,K,j,J;const E=f.dataset.label||"",A=f.parsed.y||f.parsed||0,$=f.dataIndex;if(d.value==="bar"){const V=f.dataset,ee=f.dataIndex,ne=W[ee],we=ne?ne.name:"";return`${V.label}: ${A} тикетов на этапе "${we}"`}if(d.value==="doughnut"){const V=f.dataset.data.reduce((ne,we)=>ne+we,0),ee=V>0?(A/V*100).toFixed(1):0;return`${E}: ${A} тикетов (${ee}%)`}else{if(!u.value||$===0)return`${E}: ${A} тикетов`;let V=null;const ee=N(E);if(p.value==="weekStartToWeekEnd"&&$===1?V=(x=(B=u.value.weekStartToWeekEnd)==null?void 0:B.stages)==null?void 0:x[ee]:p.value==="weekEndToCurrent"&&$===2&&c.value.current?V=(K=(Y=u.value.weekEndToCurrent)==null?void 0:Y.stages)==null?void 0:K[ee]:p.value==="weekStartToCurrent"&&$===2&&c.value.current&&(V=(J=(j=u.value.weekStartToCurrent)==null?void 0:j.stages)==null?void 0:J[ee]),!V)return`${E}: ${A} тикетов`;const ne=V.delta,we=V.deltaPercent,Me=V.trend;let Se=`${E}: ${A} тикетов`;if(ne!==0){const Ne=ne>0?"+":"",Re=Me==="increase"?"↑":Me==="decrease"?"↓":"→";Se+=` (${Ne}${ne}, ${Ne}${we.toFixed(1)}%) ${Re}`}else Se+=" (без изменений)";return Se}},afterBody:f=>{if(d.value==="bar"&&f.length>0){const B=f[0];B.dataset;const x=B.parsed.y||0,Y=B.dataIndex,K=De(Y);return[`${K>0?(x/K*100).toFixed(1):0}% от общего количества этапа`]}if(d.value==="doughnut"&&f.length>0)return["Кликните для детализации по сотрудникам"];if(d.value==="line"){const B=[];if(u.value){const x=f[0].dataIndex;if(x!==0){let Y=null;if(N(f[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&x===1?Y=u.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&x===2?Y=u.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&x===2&&(Y=u.value.weekStartToCurrent),Y&&Y.metadata){const K=Y.metadata.timeDiff;B.push(`Период: ${K.days} дн. ${K.hours} ч. ${K.minutes} мин.`)}}}return B.push("Кликните для детализации по сотрудникам"),B}if(!u.value)return[];const E=f[0].dataIndex;if(E===0)return[];let A=null;if(N(f[0].dataset.label||""),p.value==="weekStartToWeekEnd"&&E===1?A=u.value.weekStartToWeekEnd:p.value==="weekEndToCurrent"&&E===2?A=u.value.weekEndToCurrent:p.value==="weekStartToCurrent"&&E===2&&(A=u.value.weekStartToCurrent),!A||!A.metadata)return[];const $=A.metadata.timeDiff;return[`Период: ${$.days} дн. ${$.hours} ч. ${$.minutes} мин.`]}}},title:{display:!1}}};return d.value==="line"||d.value==="bar"?{...C,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:d.value==="doughnut"?{...C,cutout:"60%"}:C});function ke(C){const f=new Date(C),E=f.getFullYear(),A=String(f.getMonth()+1).padStart(2,"0"),$=String(f.getDate()).padStart(2,"0");return`${E}-${A}-${$}`}function Qe(C){const{current:f,weekEnd:E}=C,A=f||E;if(!A||!A.statistics||!A.statistics.stages)return null;const $=[],B=[],x=[],Y=[],K={};return W.forEach(j=>{var V;const J=((V=A.statistics.stages[j.id])==null?void 0:V.count)||0;if(J>0){$.push(j.name),B.push(J),x.push(j.color+"80"),Y.push(j.color);const ee=js(j.id,A,W);ee&&ee.employees&&(K[j.id]=ee)}}),B.length===0?null:{labels:$,datasets:[{label:"Распределение по этапам",data:B,backgroundColor:x,borderColor:Y,borderWidth:2,meta:{employees:K}}]}}function et(C){if(d.value==="doughnut")return Qe(C);if(d.value==="bar"){const x=n.showCurrentState&&C.current?"current":C.weekEnd?"weekEnd":"weekStart";return Bs(C,x,W)}const{weekStart:f,weekEnd:E,current:A}=C,$=[],B=[];return W.forEach((x,Y)=>{var we,Me,Se,Ne,Re,ct,dt,ut,pt,gt,ft,mt,ht,vt,yt,kt,wt;const K=[];if(f&&f.statistics&&f.statistics.stages){const oe=f.statistics.stages[x.id];if($.length===0){const Be=(we=f.metadata)!=null&&we.createdAt?new Date(f.metadata.createdAt):null;$.push(Be?ke(Be):"Начало недели")}K.push((oe==null?void 0:oe.count)||0)}else $.length===0&&$.push("Начало недели"),K.push(0);if(E&&E.statistics&&E.statistics.stages){const oe=E.statistics.stages[x.id];if($.length===1){const Be=(Me=E.metadata)!=null&&Me.createdAt?new Date(E.metadata.createdAt):null;$.push(Be?ke(Be):"Конец недели")}K.push((oe==null?void 0:oe.count)||0)}else $.length===1&&$.push("Конец недели"),K.push(0);if(A&&n.showCurrentState&&A.statistics&&A.statistics.stages){const oe=A.statistics.stages[x.id];$.length===2&&$.push("Текущее состояние"),K.push((oe==null?void 0:oe.count)||0)}const j=["stable"];u.value?p.value==="weekStartToWeekEnd"?(j.push(((Re=(Ne=(Se=u.value.weekStartToWeekEnd)==null?void 0:Se.stages)==null?void 0:Ne[x.id])==null?void 0:Re.trend)||"stable"),A&&j.push(((ut=(dt=(ct=u.value.weekStartToCurrent)==null?void 0:ct.stages)==null?void 0:dt[x.id])==null?void 0:ut.trend)||"stable")):p.value==="weekEndToCurrent"&&A?(j.push("stable"),j.push(((ft=(gt=(pt=u.value.weekEndToCurrent)==null?void 0:pt.stages)==null?void 0:gt[x.id])==null?void 0:ft.trend)||"stable")):p.value==="weekStartToCurrent"&&A?(j.push(((vt=(ht=(mt=u.value.weekStartToWeekEnd)==null?void 0:mt.stages)==null?void 0:ht[x.id])==null?void 0:vt.trend)||"stable"),j.push(((wt=(kt=(yt=u.value.weekStartToCurrent)==null?void 0:yt.stages)==null?void 0:kt[x.id])==null?void 0:wt.trend)||"stable")):(j.push("stable"),A&&j.push("stable")):(j.push("stable"),A&&j.push("stable"));let J,V,ee;u.value&&d.value!=="doughnut"?(J=j.map(oe=>b(oe,"background")+"40"),V=j.map(oe=>b(oe,"border")),ee=j.map(oe=>b(oe,"point"))):(J=x.color+"40",V=x.color,ee=x.color);let ne=null;d.value==="line"&&(ne={employees:Ls(x.id,C)}),B.push({label:x.name,data:K,backgroundColor:(Array.isArray(J),J),borderColor:(Array.isArray(V),V),borderWidth:2,...d.value==="line"&&{pointStyle:re[Y%re.length]},pointBackgroundColor:(Array.isArray(ee),ee),pointBorderColor:(Array.isArray(V),V),pointRadius:7,pointHoverRadius:10,fill:d.value!=="line",tension:d.value==="line"?.4:0,meta:ne})}),$.length===0&&($.push("Начало недели","Конец недели"),n.showCurrentState&&$.push("Текущее состояние")),{labels:$,datasets:B}}const tt=async()=>{var C,f,E;s.value=!0,o.value=null;try{const A=(C=n.period)!=null&&C.endDate?new Date(n.period.endDate):new Date,$=(f=n.period)!=null&&f.startDate?new Date(n.period.startDate):Te.getWeekStartDate(A),B=(E=n.period)!=null&&E.endDate?new Date(n.period.endDate):Te.getWeekEndDate(A),x=Te.formatDate($),Y=Te.formatDate(B),[K,j]=await Promise.all([Te.getSnapshot(x,"week_start"),Te.getSnapshot(Y,"week_end")]);let J=null;n.showCurrentState&&(J=await it.getSectorDataForSnapshot({useCache:!1,normalize:!0})),c.value={weekStart:K,weekEnd:j,current:J},m(),w(),$e(),a("data-loaded",{weekStart:K,weekEnd:j,current:J})}catch(A){console.error("Error loading chart data:",A),o.value=A.message||"Ошибка загрузки данных графика",ie.error("Ошибка загрузки данных графика: "+o.value),a("error",o.value)}finally{s.value=!1}};He(()=>{Ve.register(Js),Ve.register(Qs),Ve.register(en),tt()});function xt(C){de.value=C}const $e=()=>{var f;const C=et({weekStart:c.value.weekStart,weekEnd:c.value.weekEnd,current:c.value.current});if(!l.value||!l.value.labels||l.value.labels.length!==((f=C==null?void 0:C.labels)==null?void 0:f.length))l.value=C;else if(C){const E=JSON.stringify(l.value),A=JSON.stringify(C);E!==A&&(l.value=C)}};return je(()=>[n.period,n.showCurrentState],()=>{tt()},{deep:!0}),je(d,()=>{(c.value.weekStart||c.value.weekEnd||c.value.current)&&$e()}),je(p,()=>{(c.value.weekStart||c.value.weekEnd||c.value.current)&&$e()}),(C,f)=>(S(),_("div",tn,[i("div",an,[f[3]||(f[3]=i("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),i("div",sn,[(S(),_(me,null,he(g,E=>i("button",{key:E.value,onClick:A=>d.value=E.value,class:le(["chart-type-btn",{active:d.value===E.value}]),title:E.label},[i("span",on,P(E.icon),1),i("span",ln,P(E.label),1)],10,nn)),64))])]),!s.value&&!o.value&&u.value&&d.value!=="doughnut"?(S(),_("div",rn,[f[7]||(f[7]=i("h4",{class:"comparison-title"},"Тип сравнения:",-1)),i("div",cn,[i("label",null,[Ge(i("input",{type:"radio","onUpdate:modelValue":f[0]||(f[0]=E=>p.value=E),value:"weekStartToWeekEnd",onChange:$e},null,544),[[at,p.value]]),f[4]||(f[4]=i("span",null,"Начало недели → Конец недели",-1))]),c.value.current?(S(),_("label",dn,[Ge(i("input",{type:"radio","onUpdate:modelValue":f[1]||(f[1]=E=>p.value=E),value:"weekEndToCurrent",onChange:$e},null,544),[[at,p.value]]),f[5]||(f[5]=i("span",null,"Конец недели → Текущее состояние",-1))])):te("",!0),c.value.current?(S(),_("label",un,[Ge(i("input",{type:"radio","onUpdate:modelValue":f[2]||(f[2]=E=>p.value=E),value:"weekStartToCurrent",onChange:$e},null,544),[[at,p.value]]),f[6]||(f[6]=i("span",null,"Начало недели → Текущее состояние",-1))])):te("",!0)])])):te("",!0),!s.value&&!o.value&&l.value?(S(),Ae(ia,{key:1,stages:W,selected:de.value,"onUpdate:selected":xt,onChange:$e},null,8,["selected"])):te("",!0),!s.value&&!o.value&&u.value&&d.value!=="doughnut"?(S(),_("div",pn,[...f[8]||(f[8]=[Lt('<h4 class="legend-title" data-v-1f8c83e2>Легенда:</h4><div class="legend-items" data-v-1f8c83e2><div class="legend-item" data-v-1f8c83e2><span class="legend-color legend-increase" data-v-1f8c83e2></span><span data-v-1f8c83e2>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-1f8c83e2><span class="legend-color legend-decrease" data-v-1f8c83e2></span><span data-v-1f8c83e2>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-1f8c83e2><span class="legend-color legend-stable" data-v-1f8c83e2></span><span data-v-1f8c83e2>Серый — без изменений</span></div></div>',2)])])):te("",!0),s.value?(S(),Ae(Mt,{key:3,message:"Загрузка данных графика..."})):o.value?(S(),_("div",gn,[i("p",fn,"❌ "+P(o.value),1),i("button",{onClick:tt,class:"btn-retry"},"Повторить загрузку")])):M.value?(S(),_("div",{key:5,class:le(["chart-container",`chart-type-${d.value}`])},[i("div",mn,[i("div",hn,[(S(),Ae(Bt(L.value),{data:M.value,options:ce.value},null,8,["data","options"]))]),d.value==="bar"?(S(),_("div",vn,[(S(),_(me,null,he(W,E=>i("div",{key:E.id,class:"stage-label-item"},P(I(E.id)),1)),64))])):te("",!0)])],2)):(S(),_("div",yn,[...f[9]||(f[9]=[i("p",null,"📊 Нет данных для отображения",-1),i("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ue(xs,{"is-visible":v.value,"stage-name":D.value,"stage-id":h.value,"total-count":y.value,employees:k.value,others:T.value,snapshot:z.value,"ticket-details":Z.value,onClose:O},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details"])]))}},wn=Ie(kn,[["__scopeId","data-v-1f8c83e2"]]),bn={key:0,class:"create-snapshot-button-container"},Dn=["disabled"],Sn={class:"modal-content"},En={class:"modal-header"},_n=["disabled"],Tn={class:"modal-body"},Cn={key:0,class:"progress-container"},An={class:"progress-bar-wrapper"},In={class:"progress-text"},$n={class:"progress-percent"},Mn={class:"progress-description"},Nn={key:1},Rn={class:"modal-footer"},Fn=["disabled"],Hn=["disabled"],On={key:0},xn={key:0},Pn={key:1},Ln={key:2},Bn={key:1},jn={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(r,{emit:t}){const e=r,n=t,a=R(e.user),s=R(!1),o=R(!1),l=R(0),c=R("idle"),u=R(""),p=ze(),g=se(()=>a.value?jt(a.value):!1);He(async()=>{if(!e.user)try{const y=await Nt.checkAccess();y.allowed&&(a.value=y.user)}catch(y){console.error("Error loading user:",y)}});const d=()=>{if(!g.value){p.warning("Только администраторы могут создавать слепки");return}s.value=!0},v=()=>{o.value||(s.value=!1,c.value="idle",l.value=0,u.value="")},D=async()=>{if(!o.value){if(!g.value){p.warning("Только администраторы могут создавать слепки");return}o.value=!0,c.value="loading_data",l.value=0,u.value="Инициализация загрузки данных...";try{u.value="Загрузка данных сектора из Bitrix24...";const y=await it.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:z=>{var Q;const Z=Math.min(80,(z.progress||0)*.8);l.value=Z,c.value="loading_data",u.value=z.description||((Q=z.details)==null?void 0:Q.description)||"Загрузка данных сектора..."}});c.value="creating_snapshot",l.value=85,u.value="Создание слепка...";const k=a.value;if(!k)throw new Error("Пользователь не определён");const T=await Te.createSnapshot(y,"manual",{createdBy:{id:k.ID,name:`${k.NAME||""} ${k.LAST_NAME||""}`.trim()||k.EMAIL||`User ${k.ID}`},sectorId:"1C"});c.value="success",l.value=100,u.value="Слепок успешно создан!",p.success("Слепок состояния сектора успешно создан"),n("snapshot-created",T),setTimeout(()=>{v()},1500)}catch(y){c.value="error",l.value=0,u.value="Ошибка создания слепка",console.error("Error creating snapshot:",y);let k="Ошибка создания слепка";y.message&&(y.message.includes("загрузки данных")||y.message.includes("sector data")?k="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":y.message.includes("создания слепка")||y.message.includes("snapshot")?k="Не удалось создать слепок. Обратитесь в поддержку.":y.message.includes("валидац")||y.message.includes("validation")?k="Ошибка валидации данных. Проверьте данные сектора.":k=y.message),p.error(k)}finally{o.value=!1}}},h=y=>{y.key==="Escape"&&s.value&&!o.value&&v()};return He(()=>{window.addEventListener("keydown",h)}),Ze(()=>{window.removeEventListener("keydown",h)}),(y,k)=>g.value?(S(),_("div",bn,[i("button",{class:"create-snapshot-btn",onClick:d,disabled:o.value,title:"Создать слепок состояния сектора"},[...k[1]||(k[1]=[i("span",{class:"btn-icon"},"📸",-1),i("span",{class:"btn-text"},"Создать слепок",-1)])],8,Dn),(S(),Ae($t,{to:"body"},[ue(Ue,{name:"modal"},{default:Ce(()=>[s.value?(S(),_("div",{key:0,class:"modal-overlay",onClick:k[0]||(k[0]=ge(T=>!o.value&&v(),["self"]))},[i("div",Sn,[i("div",En,[k[2]||(k[2]=i("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),i("button",{class:"modal-close",onClick:v,disabled:o.value,"aria-label":"Закрыть"}," ✕ ",8,_n)]),i("div",Tn,[c.value!=="idle"?(S(),_("div",Cn,[i("div",An,[i("div",{class:"progress-bar",style:be({width:`${l.value}%`})},null,4)]),i("div",In,[i("span",$n,P(Math.round(l.value))+"%",1),i("span",Mn,P(u.value),1)])])):(S(),_("div",Nn,[...k[3]||(k[3]=[i("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),i("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),i("div",Rn,[i("button",{class:"btn btn-secondary",onClick:v,disabled:o.value}," Отмена ",8,Fn),i("button",{class:"btn btn-primary",onClick:D,disabled:o.value},[o.value?(S(),_("span",On,[c.value==="loading_data"?(S(),_("span",xn,"Загрузка данных...")):c.value==="creating_snapshot"?(S(),_("span",Pn,"Создание...")):(S(),_("span",Ln,"Обработка..."))])):(S(),_("span",Bn,"Создать"))],8,Hn)])])])):te("",!0)]),_:1})]))])):te("",!0)}},Wn=Ie(jn,[["__scopeId","data-v-09bccee2"]]),Un=20,zn=5*60*1e3;async function Vn({search:r="",limit:t=Un,sectorDepartmentId:e=Ct.SECTOR_1C}={}){const n=`sector1c_employees_${r}_${t}_${e||"all"}`,a=sessionStorage.getItem(n);if(a)try{const{data:s,timestamp:o}=JSON.parse(a);if(Date.now()-o<zn)return s}catch(s){console.warn("[sector1cEmployees] Cache parse error:",s)}try{const s={ACTIVE:"Y"};e?Array.isArray(e)?s.UF_DEPARTMENT=e:s.UF_DEPARTMENT=[e]:s.UF_DEPARTMENT=[Ct.SECTOR_1C],r&&r.length>=2&&(s["%NAME"]=r,s["%LAST_NAME"]=r,s["%WORK_POSITION"]=r);const c=((await rt.call("user.get",{filter:s,select:["ID","NAME","LAST_NAME","SECOND_NAME","WORK_POSITION","UF_DEPARTMENT"],order:{LAST_NAME:"ASC",NAME:"ASC"},start:0})).result||[]).slice(0,t).map(u=>({id:parseInt(u.ID),name:Kn(u),position:u.WORK_POSITION||"",department:u.UF_DEPARTMENT||null}));try{sessionStorage.setItem(n,JSON.stringify({data:c,timestamp:Date.now()}))}catch(u){console.warn("[sector1cEmployees] Cache write error:",u)}return c}catch(s){throw console.error("[sector1cEmployees] Ошибка загрузки сотрудников:",s),new Error(`Не удалось загрузить сотрудников: ${s.message}`)}}function Kn(r){const t=[r.LAST_NAME,r.NAME,r.SECOND_NAME].filter(Boolean);return t.length>0?t.join(" "):r.NAME||"Без имени"}const Gn={class:"employee-select-field-text"},Yn={key:0,class:"employee-select-dropdown"},qn={class:"employee-select-dropdown-search"},Xn={key:0,class:"employee-select-state"},Jn={key:1,class:"employee-select-state employee-select-state--error"},Zn={key:2,class:"employee-select-state"},Qn=["checked"],eo=["checked","onChange"],to={class:"employee-select-item-content"},ao={class:"employee-select-item-name"},so={key:0,class:"employee-select-item-position"},no={__name:"EmployeeSelect",props:{selected:{type:Array,default:()=>["all"]},multiple:{type:Boolean,default:!0},placeholder:{type:String,default:"Выберите сотрудников сектора 1С"},maxHeight:{type:Number,default:300}},emits:["update:selected","search","error"],setup(r,{emit:t}){const e=r,n=t,a=R(null),s=R(null),o=R(""),l=R([]),c=R(!1),u=R(null),p=R(!1),g=se(()=>{if(!o.value)return l.value;const L=o.value.toLowerCase();return l.value.filter(H=>H.name.toLowerCase().includes(L)||H.position&&H.position.toLowerCase().includes(L))}),d=se(()=>{if(e.selected.includes("all")||e.selected.length===0)return e.placeholder;if(e.selected.length===1){const L=l.value.find(H=>H.id===e.selected[0]);return L?L.name:e.placeholder}return`Выбрано: ${e.selected.length} ${Z(e.selected.length,"сотрудника","сотрудников","сотрудников")}`});async function v(L=""){c.value=!0,u.value=null;try{l.value=await Vn({search:L})}catch(H){u.value=H,n("error",H)}finally{c.value=!1}}function D(){n("search",o.value)}function h(){c.value||(p.value=!p.value,p.value?(l.value.length===0&&v(),Ut(()=>{s.value&&s.value.focus()})):o.value="")}function y(L){a.value&&!a.value.contains(L.target)&&(p.value=!1,o.value="")}function k(L){const H=[...e.selected],W=H.indexOf(L);if(L==="all")if(W>-1)H.splice(W,1);else return n("update:selected",["all"]);else if(W>-1)H.splice(W,1);else{const re=H.indexOf("all");re>-1&&H.splice(re,1),H.push(L)}n("update:selected",H)}function T(L){return L==="all"?e.selected.includes("all"):e.selected.includes(L)||e.selected.includes("all")}const z=se(()=>o.value?`Нет сотрудников по запросу "${o.value}"`:"Нет сотрудников сектора 1С");function Z(L,H,W,re){const de=L%10,ie=L%100;return ie>=11&&ie<=19?re:de===1?H:de>=2&&de<=4?W:re}function Q(){v(o.value)}return je(()=>e.selected,L=>{(!L||L.length===0)&&n("update:selected",["all"])},{immediate:!0}),He(()=>{document.addEventListener("click",y),(!e.selected||e.selected.length===0)&&n("update:selected",["all"])}),Ze(()=>{document.removeEventListener("click",y)}),(L,H)=>(S(),_("div",{class:"employee-select",ref_key:"selectContainer",ref:a},[i("div",{class:le(["employee-select-field",{"employee-select-field--open":p.value,"employee-select-field--disabled":c.value}]),onClick:h},[i("span",Gn,P(d.value),1),i("span",{class:le(["employee-select-field-icon",{open:p.value}])},"▼",2)],2),ue(Ue,{name:"dropdown-fade"},{default:Ce(()=>[p.value?(S(),_("div",Yn,[i("div",qn,[Ge(i("input",{"onUpdate:modelValue":H[0]||(H[0]=W=>o.value=W),type:"text",placeholder:"🔍 Поиск сотрудника...",class:"employee-select-search-input",onInput:D,onClick:H[1]||(H[1]=ge(()=>{},["stop"])),ref_key:"searchInput",ref:s},null,544),[[Wt,o.value]])]),c.value?(S(),_("div",Xn,[...H[6]||(H[6]=[i("span",{class:"spinner"},"⏳",-1),i("span",null,"Загрузка сотрудников сектора 1С...",-1)])])):u.value?(S(),_("div",Jn,[i("span",null,"❌ "+P(u.value.message||"Ошибка загрузки сотрудников"),1),i("button",{onClick:[Q,H[2]||(H[2]=ge(()=>{},["stop"]))],class:"btn-retry"},"Повторить")])):!c.value&&g.value.length===0&&!u.value?(S(),_("div",Zn,[i("span",null,"📭 "+P(z.value),1)])):(S(),_("div",{key:3,class:"employee-select-list",style:be({maxHeight:`${r.maxHeight}px`})},[i("label",{class:le(["employee-select-item",{"employee-select-item--selected":T("all")}]),onClick:H[4]||(H[4]=ge(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T("all"),onChange:H[3]||(H[3]=W=>k("all"))},null,40,Qn),H[7]||(H[7]=i("div",{class:"employee-select-item-content"},[i("span",{class:"employee-select-item-name"},"Все сотрудники")],-1))],2),(S(!0),_(me,null,he(g.value,W=>(S(),_("label",{key:W.id,class:le(["employee-select-item",{"employee-select-item--selected":T(W.id)}]),onClick:H[5]||(H[5]=ge(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:T(W.id),onChange:re=>k(W.id)},null,40,eo),i("div",to,[i("span",ao,P(W.name),1),W.position?(S(),_("span",so,P(W.position),1)):te("",!0)])],2))),128))],4))])):te("",!0)]),_:1})],512))}},oo=Ie(no,[["__scopeId","data-v-6b8c949b"]]),lo={class:"stage-select-field-text"},ro={key:0,class:"stage-select-dropdown"},io={class:"stage-select-list"},co=["checked"],uo=["checked","onChange"],po={class:"stage-select-item-content"},go={class:"stage-select-item-name"},fo={__name:"StageSelect",props:{selected:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},stages:{type:Array,required:!0,default:()=>[{id:"formed",name:"Сформировано обращение",color:"#007bff"},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107"},{id:"execution",name:"Исполнение",color:"#28a745"}]},placeholder:{type:String,default:"Выберите этапы"}},emits:["update:selected","change"],setup(r,{emit:t}){const e=r,n=t,a=R(null),s=R(!1),o=se(()=>Object.values(e.selected).every(d=>d===!0)),l=se(()=>{if(o.value)return e.placeholder;const d=e.stages.filter(v=>e.selected[v.id]);return d.length===0?"Этапы не выбраны":d.length===1?d[0].name:`Выбрано: ${d.length} этапа(ов)`});function c(){s.value=!s.value,s.value}function u(d){a.value&&!a.value.contains(d.target)&&(s.value=!1)}function p(d,v){const D={...e.selected};D[d]=v,n("update:selected",D),n("change",d,v)}function g(){const d=o.value,v={};e.stages.forEach(D=>{v[D.id]=!d}),n("update:selected",v),n("change","all",!d)}return He(()=>{document.addEventListener("click",u)}),Ze(()=>{document.removeEventListener("click",u)}),(d,v)=>(S(),_("div",{class:"stage-select",ref_key:"selectContainer",ref:a},[i("div",{class:le(["stage-select-field",{"stage-select-field--open":s.value,"stage-select-field--disabled":!1}]),onClick:c},[i("span",lo,P(l.value),1),i("span",{class:le(["stage-select-field-icon",{open:s.value}])},"▼",2)],2),ue(Ue,{name:"dropdown-fade"},{default:Ce(()=>[s.value?(S(),_("div",ro,[i("div",io,[i("label",{class:le(["stage-select-item",{"stage-select-item--selected":o.value}]),onClick:v[0]||(v[0]=ge(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:o.value,onChange:g},null,40,co),v[2]||(v[2]=i("div",{class:"stage-select-item-content"},[i("span",{class:"stage-select-item-name"},"Все этапы")],-1))],2),(S(!0),_(me,null,he(r.stages,D=>(S(),_("label",{key:D.id,class:le(["stage-select-item",{"stage-select-item--selected":r.selected[D.id]}]),onClick:v[1]||(v[1]=ge(()=>{},["stop"]))},[i("input",{type:"checkbox",checked:r.selected[D.id],onChange:h=>p(D.id,h.target.checked)},null,40,uo),i("div",po,[i("span",{class:"stage-select-item-color",style:be({backgroundColor:D.color})},null,4),i("span",go,P(D.name),1)])],2))),128))])])):te("",!0)]),_:1})],512))}},mo=Ie(fo,[["__scopeId","data-v-ce2229b2"]]),ho={class:"filters-panel"},vo={class:"filters-header"},yo=["disabled"],ko={class:"filters-content"},wo={class:"filter-section"},bo={class:"section-content"},Do={class:"filter-section"},So={class:"section-content"},Eo={class:"filter-section"},_o={class:"section-content"},To=["value"],Co={key:0,class:"custom-date-range"},Ao={class:"date-range-inputs"},Io={class:"date-input-group"},$o=["value","max"],Mo={class:"date-input-group"},No=["value","min","max"],Ro={key:0,class:"filter-error"},Fo={key:1,class:"filter-hint"},Ho={__name:"FiltersPanel",props:{stages:{type:Object,required:!0,default:()=>({formed:!0,review:!0,execution:!0})},employees:{type:Array,default:()=>["all"]},dateRange:{type:String,default:"last-week"},customDateRange:{type:Object,default:()=>({startDate:null,endDate:null})},hasActiveFilters:{type:Boolean,default:!1}},emits:["update:stages","update:employees","update:dateRange","update:customDateRange","reset","apply"],setup(r,{emit:t}){const e=r,n=t,a=[{id:"formed",name:"Сформировано обращение",color:"var(--b24-primary, #007bff)"},{id:"review",name:"Рассмотрение ТЗ",color:"var(--b24-warning, #ffc107)"},{id:"execution",name:"Исполнение",color:"var(--b24-success, #28a745)"}],s=R(null),o=se(()=>{const D=new Date;return D.setFullYear(D.getFullYear()-1),D.toISOString().split("T")[0]}),l=se(()=>new Date().toISOString().split("T")[0]);function c(D){n("update:stages",D),n("apply")}function u(D,h){n("apply")}function p(D){n("update:employees",D),n("apply")}function g(D){n("update:dateRange",D),s.value=null,n("apply")}function d(D,h){const y={...e.customDateRange};if(y[D]=h,y.startDate&&y.endDate){const k=new Date(y.startDate),T=new Date(y.endDate);if(k>T){s.value="Начальная дата не может быть больше конечной";return}if(Math.ceil((T-k)/(1e3*60*60*24))>365){s.value="Период не может превышать 365 дней";return}}s.value=null,n("update:customDateRange",y),n("apply")}function v(){s.value=null,n("reset")}return(D,h)=>(S(),_("div",ho,[i("div",vo,[h[3]||(h[3]=i("h2",null,"Фильтры",-1)),i("button",{onClick:v,class:"btn-reset-filters",disabled:!r.hasActiveFilters}," Сбросить фильтры ",8,yo)]),i("div",ko,[i("div",wo,[h[4]||(h[4]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📊"),Ye(" Этапы ")],-1)),i("div",bo,[ue(mo,{selected:r.stages,stages:a,placeholder:"Выберите этапы","onUpdate:selected":c,onChange:u},null,8,["selected"])])]),i("div",Do,[h[5]||(h[5]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"👥"),Ye(" Сотрудники сектора 1С ")],-1)),i("div",So,[ue(oo,{selected:r.employees,"onUpdate:selected":p},null,8,["selected"])])]),i("div",Eo,[h[9]||(h[9]=i("h3",{class:"section-title"},[i("span",{class:"section-icon"},"📅"),Ye(" Период ")],-1)),i("div",_o,[i("select",{value:r.dateRange,onChange:h[0]||(h[0]=y=>g(y.target.value)),class:"date-range-select"},[...h[6]||(h[6]=[i("option",{value:"last-week"},"Последняя неделя",-1),i("option",{value:"last-2-weeks"},"Последние 2 недели",-1),i("option",{value:"last-month"},"Последний месяц",-1),i("option",{value:"custom"},"Произвольный период",-1)])],40,To),r.dateRange==="custom"?(S(),_("div",Co,[i("div",Ao,[i("div",Io,[h[7]||(h[7]=i("label",null,"С:",-1)),i("input",{type:"date",value:r.customDateRange.startDate,onChange:h[1]||(h[1]=y=>d("startDate",y.target.value)),max:r.customDateRange.endDate||l.value,class:"date-input"},null,40,$o)]),i("div",Mo,[h[8]||(h[8]=i("label",null,"По:",-1)),i("input",{type:"date",value:r.customDateRange.endDate,onChange:h[2]||(h[2]=y=>d("endDate",y.target.value)),min:r.customDateRange.startDate||o.value,max:l.value,class:"date-input"},null,40,No)])]),s.value?(S(),_("small",Ro,P(s.value),1)):(S(),_("small",Fo," Выберите начальную и конечную дату для отображения данных "))])):te("",!0)])])])]))}},Oo=Ie(Ho,[["__scopeId","data-v-4b7456a2"]]);function xo(){const r=R(!1),t=R(null),e=R(null),n=R(0),a=ze(),s=async(y=!0,k=null)=>{r.value=!0,t.value=null,n.value=0;try{const T=await it.getSectorDataForSnapshot({useCache:y,onProgress:z=>{z&&typeof z.progress=="number"&&(n.value=z.progress),k&&k(z)},normalize:!0});return e.value=T,T}catch(T){throw t.value=T.message||"Ошибка загрузки данных сектора",a.error("Ошибка загрузки данных сектора: "+t.value),T}finally{r.value=!1,n.value=100}},o=async(y,k={})=>{if(!e.value){const T="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=T,a.error(T),new Error(T)}r.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(y))throw new Error(`Неверный тип слепка: ${y}. Допустимые значения: week_start, week_end, manual, current`);const T=await Te.createSnapshot(e.value,y,k);return a.success("Слепок успешно создан"),T}catch(T){throw t.value=T.message||"Ошибка создания слепка",a.error("Ошибка создания слепка: "+t.value),T}finally{r.value=!1}},l=()=>{r.value=!1,t.value=null,e.value=null,n.value=0},c=se(()=>e.value!==null&&e.value!==void 0),u=R({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),p=se(()=>{const y=new Date;let k,T;switch(u.value.dateRange){case"last-week":k=new Date(y),k.setDate(y.getDate()-7),T=y;break;case"last-2-weeks":k=new Date(y),k.setDate(y.getDate()-14),T=y;break;case"last-month":k=new Date(y),k.setMonth(y.getMonth()-1),T=y;break;case"custom":k=u.value.customDateRange.startDate?new Date(u.value.customDateRange.startDate):null,T=u.value.customDateRange.endDate?new Date(u.value.customDateRange.endDate):null;break;default:k=new Date(y),k.setDate(y.getDate()-7),T=y}return{startDate:k?k.toISOString().split("T")[0]:null,endDate:T?T.toISOString().split("T")[0]:null}}),g=()=>{v()},d=()=>{u.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},v()},v=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(u.value))}catch(y){console.error("Ошибка сохранения фильтров в localStorage:",y)}},D=()=>{try{const y=localStorage.getItem("graphStateFilters");if(y){const k=JSON.parse(y);k&&typeof k=="object"&&(u.value={stages:k.stages||{formed:!0,review:!0,execution:!0},employees:k.employees||["all"],dateRange:k.dateRange||"last-week",customDateRange:k.customDateRange||{startDate:null,endDate:null}})}}catch(y){console.error("Ошибка загрузки фильтров из localStorage:",y)}},h=se(()=>{const y=Object.values(u.value.stages).some(z=>!z),k=!u.value.employees.includes("all"),T=u.value.dateRange!=="last-week";return y||k||T});return{isLoading:r,error:t,currentSectorData:e,loadingProgress:n,hasSectorData:c,filters:u,selectedPeriod:p,hasActiveFilters:h,loadSectorDataForSnapshot:s,createSnapshot:o,resetState:l,applyFilters:g,resetFilters:d,saveFiltersToLocalStorage:v,loadFiltersFromLocalStorage:D}}const Po={class:"graph-state-dashboard"},Lo={key:1,class:"error-message-container"},Bo={class:"error-message"},jo={class:"error-text"},Wo={key:0,class:"error-details"},Uo={class:"dashboard-header"},zo={class:"header-content"},Vo={class:"breadcrumbs-row"},Ko=["aria-disabled","data-fallback","disabled"],Go={class:"breadcrumbs","aria-label":"Навигация"},Yo={class:"header-actions"},qo=["disabled"],Xo={key:0},Jo={key:1},Zo={key:3,class:"dashboard-content"},Qo={class:"chart-container"},el="Назад",tl={__name:"GraphStateDashboard",setup(r){const t=(O,G)=>typeof window>"u"?G:getComputedStyle(document.documentElement).getPropertyValue(O).trim()||G,e=ze(),n=zt(),a={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:o,hasActiveFilters:l,applyFilters:c,resetFilters:u,loadFiltersFromLocalStorage:p}=xo(),g=R(null),d=R(!0),v=R(!1),D=R("Загрузка данных..."),h=R(null),y=R(!1),k=R(!1),T=R(typeof window<"u"?window.innerWidth:1024),z=R(null),Z=R(!1),Q=se(()=>T.value<768);se(()=>T.value>=768&&T.value<1024),se(()=>T.value>=1024);const L=se(()=>typeof window>"u"?!1:window.history.length>1);se(()=>{const O=new Date;return O.setFullYear(O.getFullYear()-1),O.toISOString().split("T")[0]}),se(()=>new Date().toISOString().split("T")[0]);function H(O){s.value.stages=O}function W(O){s.value.employees=O}function re(O){s.value.dateRange=O}function de(O){s.value.customDateRange=O}function ie(){c()}function ye(){u(),z.value=null,ie(),e.info("Фильтры сброшены")}function m(O){e.success("Слепок успешно создан")}function b(O){v.value=!1,D.value="",console.log("Данные графика загружены:",O)}function w(O){v.value=!1,N({message:O||"Ошибка загрузки графика",details:null,type:"error"})}function N(O){h.value={message:O.message||"Произошла ошибка",details:O.details||null,type:O.type||"error",timestamp:new Date},console.error("Dashboard error:",h.value),e.error(h.value.message)}function q(){h.value=null}function U(){h.value=null,v.value=!0,D.value="Повторная загрузка данных..."}async function ae(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}y.value=!0;try{const O=document.querySelector(".chart-container");if(!O)throw new Error("График не найден");const G=window.html2canvas,pe=await G(O,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),De=window.jsPDF,I=new De("landscape","mm","a4"),M=297,ce=pe.height*M/pe.width;I.setFontSize(18),I.text("График состояния сектора 1С",148.5,15,{align:"center"});const ke=new Date().toLocaleDateString("ru-RU");I.setFontSize(10);const Qe=o.value.startDate&&o.value.endDate?`Период: ${o.value.startDate} - ${o.value.endDate}`:"Период: не указан";I.text(Qe,148.5,25,{align:"center"}),I.text(`Экспорт от ${ke}`,148.5,30,{align:"center"}),I.addImage(pe.toDataURL("image/png"),"PNG",10,35,M-20,ce-20),I.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${ke}`,author:"Bitrix24 Dashboard"});const et=`graph-state-${ke.replace(/\//g,"-")}.pdf`;I.save(et),e.success("График успешно экспортирован в PDF")}catch(O){console.error("Ошибка экспорта в PDF:",O),N({message:"Ошибка экспорта в PDF: "+(O.message||"Неизвестная ошибка"),details:O.stack,type:"error"})}finally{y.value=!1}}function ve(O){var G;if((G=O==null?void 0:O.preventDefault)==null||G.call(O),!Z.value){Z.value=!0;try{if(L.value){n.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),n.push(a)}finally{Z.value=!1}}}function F(){typeof window<"u"&&(T.value=window.innerWidth)}async function X(){try{const O=await Nt.checkAccess();O.allowed&&(g.value=O.user)}catch(O){console.error("Error loading user:",O)}}return He(()=>{p(),X(),typeof window<"u"&&(T.value=window.innerWidth,window.addEventListener("resize",F))}),Ze(()=>{typeof window<"u"&&window.removeEventListener("resize",F)}),(O,G)=>{const pe=Vt("router-link");return S(),_("div",Po,[v.value?(S(),Ae(Mt,{key:0,message:D.value},null,8,["message"])):te("",!0),h.value?(S(),_("div",Lo,[i("div",Bo,[i("div",{class:"error-header"},[G[1]||(G[1]=i("span",{class:"error-icon"},"❌",-1)),G[2]||(G[2]=i("h3",null,"Ошибка",-1)),i("button",{onClick:q,class:"error-close","aria-label":"Закрыть"},"✕")]),i("p",jo,P(h.value.message),1),h.value.details?(S(),_("div",Wo,[i("details",null,[G[3]||(G[3]=i("summary",null,"Детали ошибки",-1)),i("pre",null,P(h.value.details),1)])])):te("",!0),i("div",{class:"error-actions"},[i("button",{onClick:U,class:"btn-retry"},"Повторить попытку")])])])):te("",!0),i("div",Uo,[i("div",zo,[i("div",Vo,[i("button",{class:"btn-back-link",type:"button",onClick:ve,"aria-label":el,"aria-disabled":!L.value,"data-fallback":!L.value,disabled:Z.value,title:"Назад"}," ← ",8,Ko),i("nav",Go,[ue(pe,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Ce(()=>[...G[4]||(G[4]=[Ye(" Дашборд сектора 1С ",-1)])]),_:1}),G[5]||(G[5]=i("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),G[6]||(G[6]=i("span",{class:"breadcrumb-current"},"График состояния",-1))])]),G[7]||(G[7]=i("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),G[8]||(G[8]=i("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),i("div",Yo,[i("button",{onClick:ae,class:"btn-export-pdf",disabled:y.value||v.value,title:"Экспортировать график в PDF"},[y.value?(S(),_("span",Jo,"⏳ Экспорт...")):(S(),_("span",Xo,"📄 Экспорт в PDF"))],8,qo),ue(Wn,{user:g.value,onSnapshotCreated:m},null,8,["user"])])]),Q.value?(S(),_("button",{key:2,class:"mobile-filters-toggle",onClick:G[0]||(G[0]=De=>k.value=!k.value)},[G[9]||(G[9]=i("span",null,"Фильтры",-1)),i("span",{class:le(["toggle-icon",{open:k.value}])},"▼",2)])):te("",!0),i("div",{class:le({"mobile-open":k.value&&Q.value,"mobile-closed":!k.value&&Q.value})},[ue(Oo,{stages:xe(s).stages,employees:xe(s).employees,dateRange:xe(s).dateRange,customDateRange:xe(s).customDateRange,hasActiveFilters:xe(l),"onUpdate:stages":H,"onUpdate:employees":W,"onUpdate:dateRange":re,"onUpdate:customDateRange":de,onReset:ye,onApply:ie},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!v.value&&!h.value?(S(),_("div",Zo,[i("div",Qo,[ue(wn,{period:xe(o),"show-current-state":d.value,onDataLoaded:b,onError:w},null,8,["period","show-current-state"])])])):te("",!0)])}}},al=Ie(tl,[["__scopeId","data-v-e995acfd"]]),ll=Object.freeze(Object.defineProperty({__proto__:null,default:al},Symbol.toStringTag,{value:"Module"}));export{ll as G,Rt as T,ca as g};
