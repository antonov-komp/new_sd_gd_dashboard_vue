const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./chunk-CWOGIwxH.js","./chunk-C5D5xwuQ.js","./chunk-B8ocRDN3.js"])))=>i.map(i=>d[i]);
import{c as _,o as E,e as u,F as ce,j as ue,n as re,x as me,t as B,g as N,l as Y,m as We,h as ze,f as we,b as V,a as de,w as $e,z as He,k as se,i as at,T as st,C as it,D as ft,J as Oe,q as qe,v as Je,G as Ct,a3 as Et,$ as ct,a0 as _t,a1 as Tt,B as ht,a2 as Be,u as $t,r as It}from"./chunk-q4E_n_Zn.js";import{_ as Ue,u as Ve,L as vt,A as yt,i as At}from"./main-BB5FJ7Hw.js";import{b as Mt,_ as ve}from"./chunk-B8ocRDN3.js";import{K as Nt,D as ut}from"./chunk-CWtDQCGE.js";import{S as Ze,a as Qe,b as xt,c as dt,d as pt,g as Ft,m as et,T as Pt}from"./chunk-CWOGIwxH.js";import{T as mt}from"./chunk-CbrOiYsv.js";import{F as Bt}from"./chunk-CAFW8TWe.js";import"./chunk-C5D5xwuQ.js";const ye={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class be{static getApiBaseUrl(){return Mt()}static async createSnapshot(e,t,a={}){try{if(!e||typeof e!="object")throw new Te("sectorData должен быть объектом","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new Te("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const l=this.validateSectorData(e);if(!l.isValid)throw new Te(`Ошибка валидации данных сектора: ${l.errors.join(", ")}`,"VALIDATION_ERROR",{validation:l});const s=this.normalizeSectorData(e),c={metadata:this.generateSnapshotMetadata(t,a.createdBy,a.sectorId||ye.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},i=this.validateSnapshot(c);if(!i.isValid)throw new Te(`Ошибка валидации слепка: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",i.warnings);const o=this.getApiBaseUrl(),C=await fetch(`${o}${ye.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:t,date:this.formatDate(new Date)})});if(!C.ok)throw new Error(`HTTP error! status: ${C.status}`);const D=await C.json();if(!D.success)throw new Error(D.message||"Ошибка создания слепка");return D.data.snapshot}catch(l){throw console.error("SnapshotService.createSnapshot error:",l),l instanceof Te?l:new Te(`Ошибка создания слепка: ${l.message}`,"API_ERROR",{originalError:l})}}static async getSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${ye.snapshotsEndpoint}?action=get&date=${a}&type=${t}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",ye.defaultSectorId);const l=`${this.getApiBaseUrl()}${ye.snapshotsEndpoint}?${t.toString()}`,s=await fetch(l,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=await s.json();if(!n.success)throw new Error(n.message||"Ошибка получения списка слепков");return(await Promise.all(n.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(o){return console.warn(`Ошибка загрузки слепка ${i.date}/${i.type}:`,o),null}}))).filter(i=>i!==null).sort((i,o)=>new Date(i.metadata.createdAt)-new Date(o.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:a=[],zeroPointTickets:l={}}=e,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},n=[],c=[],i=[];t.forEach(D=>{const p=D.id;if(s[p]){let y=0;D.employees.forEach(k=>{const I=k.tickets||[];y+=I.length;let w=n.find(b=>b.id===k.id);w||(w={id:k.id,name:k.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(w)),I.forEach(b=>{c.push(b.id),i.push({id:b.id,title:b.title||"Без названия",assignedTo:{id:k.id,name:k.name},createdAt:b.createdAt||"",updatedAt:b.modifiedAt||b.updatedAt||""}),w.ticketsByStage[p]=(w.ticketsByStage[p]||0)+1,w.totalTickets+=1})}),s[p].count=y}});const o={unassigned:0,keeper:0,total:0};Object.values(l).forEach(D=>{Array.isArray(D)&&D.forEach(p=>{o.total+=1,p.assigneeId===1051||p.assignedById===1051?o.keeper+=1:o.unassigned+=1,c.push(p.id),i.push({id:p.id,title:p.title||"Без названия",assignedTo:p.assignedTo||p.assignedById?{id:p.assignedById||p.assigneeId,name:"Неизвестный"}:null,createdAt:p.createdAt||"",updatedAt:p.modifiedAt||p.updatedAt||""})})});const C=Object.values(s).reduce((D,p)=>D+p.count,0)+o.total;return{statistics:{stages:{...s,total:C},employees:n,zeroPoint:o},ticketIds:[...new Set(c)],tickets:i}}static generateSnapshotMetadata(e,t,a){const l=new Date,s=-l.getTimezoneOffset(),n=Math.floor(s/60),c=s%60,i=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(c).padStart(2,"0")}`,o=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}T${String(l.getHours()).padStart(2,"0")}:${String(l.getMinutes()).padStart(2,"0")}:${String(l.getSeconds()).padStart(2,"0")}${i}`;return{version:ye.snapshotVersion,createdAt:o,createdBy:t||{id:0,name:"Система"},type:e,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("Некорректная дата");const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${l}`}static buildFilePath(e,t){const a=typeof e=="string"?new Date(e):e,l=a.getFullYear(),s=this.getWeekNumber(a),n=this.formatDate(e);let c;if(t==="current"){const i=new Date,o=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`current-state-${n}-${o}.json`}else if(t==="manual"){const i=new Date,o=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`manual-${n}-${o}.json`}else c=`${t}-${n}.json`;return t==="current"?`current/${c}`:`${l}/week-${s}/${c}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);const l=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-l)/864e5+1)/7)}static validateSnapshot(e){const t=[],a=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("Неверная версия формата данных"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("Неверный тип слепка"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("Неверный идентификатор сектора"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("Неверная информация о создателе")):t.push("Отсутствуют метаданные слепка"),!e.statistics)t.push("Отсутствует статистика");else{if(!e.statistics.stages)t.push("Отсутствует статистика по этапам");else{const l=e.statistics.stages,s=(l.formed?.count||0)+(l.review?.count||0)+(l.execution?.count||0);l.total!==s&&a.push(`Несоответствие общего количества тикетов: ожидается ${s}, указано ${l.total}`)}if(Array.isArray(e.statistics.employees)||t.push("Статистика по сотрудникам должна быть массивом"),!e.statistics.zeroPoint)t.push("Отсутствует статистика нулевой точки");else{const l=e.statistics.zeroPoint,s=(l.unassigned||0)+(l.keeper||0);l.total!==s&&a.push(`Несоответствие статистики нулевой точки: ожидается ${s}, указано ${l.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds должен быть массивом"),!Array.isArray(e.tickets))t.push("tickets должен быть массивом");else{const l=new Set(e.ticketIds),s=new Set(e.tickets.map(n=>n.id));l.size!==s.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),e.tickets.forEach((n,c)=>{n.id||t.push(`Тикет #${c}: отсутствует ID`),n.title||t.push(`Тикет #${c}: отсутствует заголовок`),(!n.assignedTo||!n.assignedTo.id)&&a.push(`Тикет #${c}: отсутствует ответственный (может быть в нулевой точке)`),n.createdAt||t.push(`Тикет #${c}: отсутствует дата создания`),n.updatedAt||t.push(`Тикет #${c}: отсутствует дата обновления`)})}return{isValid:t.length===0,errors:t,warnings:a}}static validateSectorData(e){const t=[],a=[];return!e||typeof e!="object"?(t.push("sectorData должен быть объектом"),{isValid:!1,errors:t,warnings:a}):(Array.isArray(e.stages)||t.push("stages должен быть массивом"),Array.isArray(e.employees)||t.push("employees должен быть массивом"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets должен быть объектом"),{isValid:t.length===0,errors:t,warnings:a})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${ye.snapshotsEndpoint}`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:t})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let a=0;for(const l of t)try{await this.deleteSnapshot(l.metadata.createdAt.split("T")[0],l.metadata.type)&&a++}catch(s){console.warn(`Ошибка удаления слепка ${l.metadata.createdAt}:`,s)}return a}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){return e?.metadata?.version||"unknown"}static async migrateSnapshot(e,t=ye.snapshotVersion){const a=this.getSnapshotVersion(e);return a===t||a==="1.0"&&t==="1.0"?e:(console.warn(`Миграция с версии ${a} на ${t} пока не реализована`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,a=this.getWeekNumber(t);return{year:t.getFullYear(),week:a}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,l=(t.getDay()||7)-1,s=new Date(t);return s.setDate(t.getDate()-l),s.setHours(0,0,0,0),s}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,l=7-(t.getDay()||7),s=new Date(t);return s.setDate(t.getDate()+l),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),a=this.getWeekEndDate(e),l=this.getWeekNumberInfo(e),s=await this.getAllSnapshots({startDate:t,endDate:a}),n=s.find(o=>o.metadata.type==="week_start")||null,c=s.find(o=>o.metadata.type==="week_end")||null,i=s.filter(o=>o.metadata.type==="manual");return{weekStart:n,weekEnd:c,manual:i,weekInfo:l}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof Te)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("валидац")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("не найден")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("версия")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("доступ")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"Неизвестная ошибка",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),a={week_start:0,week_end:0,manual:0,current:0},l=new Map;let s=null,n=null;t.forEach(i=>{const o=i.metadata.type;a.hasOwnProperty(o)&&a[o]++;const C=this.getWeekNumberInfo(i.metadata.createdAt),D=`${C.year}-W${C.week}`;l.set(D,(l.get(D)||0)+1);const p=new Date(i.metadata.createdAt);(!s||p<new Date(s.metadata.createdAt))&&(s=i),(!n||p>new Date(n.metadata.createdAt))&&(n=i)});const c=Array.from(l.entries()).map(([i,o])=>{const[C,D]=i.split("-W");return{year:parseInt(C),week:parseInt(D),count:o}}).sort((i,o)=>i.year!==o.year?i.year-o.year:i.week-o.week);return{total:t.length,byType:a,byWeek:c,oldest:s,newest:n}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class Te extends Error{constructor(e,t,a={}){super(e),this.name="SnapshotError",this.code=t,this.details=a}}const ke={formed:{bitrixId:Qe.formed,name:Ze.FORMED.name},review:{bitrixId:Qe.review,name:Ze.REVIEW.name},execution:{bitrixId:Qe.execution,name:Ze.EXECUTION.name}},je=Nt;function Lt(r){if(!r||typeof r!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!r.stages||!Array.isArray(r.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=Rt(r.stages),t=Ht(r.stages),a=Ot(r.zeroPointTickets||{}),l=Wt(r.zeroPointTickets||{}),s=jt(r.stages,r.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:a,zeroPointByStage:l},ticketIds:s.ticketIds,tickets:s.tickets}}function Rt(r){const e={formed:{count:0,stageId:ke.formed.bitrixId,stageName:ke.formed.name},review:{count:0,stageId:ke.review.bitrixId,stageName:ke.review.name},execution:{count:0,stageId:ke.execution.bitrixId,stageName:ke.execution.name},total:0};return r.forEach(t=>{if(!ke[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let a=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(l=>{l.tickets&&Array.isArray(l.tickets)&&(a+=l.tickets.length)}),e[t.id].count=a,e.total+=a}),e}function Ht(r){const e=new Map;return r.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(a=>{if(!a||!a.id)return;e.has(a.id)||e.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const l=e.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;ke[t.id]&&(l.ticketsByStage[t.id]=(l.ticketsByStage[t.id]||0)+s),l.totalTickets+=s})}),Array.from(e.values())}function Ot(r){let e=0,t=0;return!r||typeof r!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(r).forEach(a=>{Array.isArray(a)&&a.forEach(l=>{if(!l)return;const s=l.assignedTo||l.assignedById;!s||s===null?e++:(typeof s=="object"?s.id:s)===je?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function Wt(r){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!r||typeof r!="object"||Object.keys(e).forEach(t=>{const a=r[t];Array.isArray(a)&&a.forEach(l=>{if(!l)return;const s=l.assignedTo||l.assignedById;!s||s===null?e[t].unassigned++:(typeof s=="object"?s.id:s)===je?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function jt(r,e){const t=new Set,a=new Map;return Array.isArray(r)&&r.forEach(l=>{!l.employees||!Array.isArray(l.employees)||l.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const c=parseInt(n.id);if(isNaN(c)){console.warn("Invalid ticket ID:",n.id);return}t.add(c);let i=n.assignedTo;!i&&s.id&&(i={id:s.id,name:s.name||`Сотрудник #${s.id}`}),a.set(c,{id:c,title:n.title||"Без названия",assignedTo:i||null,createdAt:Ge(n.createdAt||n.createdTime),updatedAt:Ge(n.updatedAt||n.modifiedAt||n.updatedTime),stageId:n.stageId||l.id||null,departmentHead:n.departmentHead||null,departmentHeadFull:n.departmentHeadFull||n.departmentHead||null,priorityId:n.priorityId||null,priorityLabel:n.priorityLabel||null,service:n.service||null,serviceLabel:n.serviceLabel||null})})})}),e&&typeof e=="object"&&Object.values(e).forEach(l=>{Array.isArray(l)&&l.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const n=parseInt(s.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",s.id);return}t.add(n);let c=s.assignedTo;if(!c&&s.assignedById){const i=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;i&&i!==je?c={id:i,name:"Неизвестный"}:i===je&&(c={id:je,name:"Хранитель объектов"})}a.set(n,{id:n,title:s.title||"Без названия",assignedTo:c||null,createdAt:Ge(s.createdAt||s.createdTime),updatedAt:Ge(s.updatedAt||s.modifiedAt||s.updatedTime),stageId:s.stageId||null,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null,priorityId:s.priorityId||null,priorityLabel:s.priorityLabel||null,service:s.service||null,serviceLabel:s.serviceLabel||null})})}),{ticketIds:Array.from(t).sort((l,s)=>l-s),tickets:Array.from(a.values())}}function Ge(r){if(!r)return null;if(r instanceof Date)return r.toISOString();if(typeof r=="string"){if(r.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return r;const e=new Date(r);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",r),null}class nt{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,useBackendCache:a=!1,onProgress:l=null,normalize:s=!0,includeTicketDetails:n=!1}=e;try{const c=await ut.getSectorData(t,a,l);return s?Lt(c):(n&&console.warn("includeTicketDetails пока не реализовано"),c)}catch(c){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",c),c}}static async isDataAvailable(){try{const e=await ut.getSectorData(!0);return e!=null}catch{return!1}}}class tt{static compareTwoSnapshots(e,t,a={}){const{includeTickets:l=!1,includeEmployees:s=!0}=a,n=this.validateSnapshot(e),c=this.validateSnapshot(t);if(!n.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...c.errors].join(", "));const i=this.buildComparisonMetadata(e,t),o=this.compareStages(e.statistics.stages,t.statistics.stages),C=s?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],D=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),p=l?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,y=this.buildSummary(o,C,D,p);return{metadata:i,stages:o,employees:C,zeroPoint:D,tickets:p,summary:y}}static calculateDelta(e,t){const a=this.normalizeValue(e),l=this.normalizeValue(t),s=l-a;let n=0;a!==0?n=s/a*100:l!==0&&(n=l>0?1/0:-1/0);const c=this.getTrend(s);return{value1:a,value2:l,delta:s,deltaPercent:Math.round(n*100)/100,trend:c}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){const a=["formed","review","execution"],l={};for(const c of a){const i=e[c]?.count||0,o=t[c]?.count||0;l[c]=this.calculateDelta(i,o)}const s=e.total||0,n=t.total||0;return l.total=this.calculateDelta(s,n),l}static compareEmployees(e,t){const a=new Map(e.map(c=>[c.id,c])),l=new Map(t.map(c=>[c.id,c])),s=new Set([...a.keys(),...l.keys()]),n=[];for(const c of s){const i=a.get(c)||null,o=l.get(c)||null;if(!i||!o){n.push({id:c,name:i?.name||o?.name||"Неизвестный",snapshot1:i?{ticketsByStage:i.ticketsByStage||{},totalTickets:i.totalTickets||0}:null,snapshot2:o?{ticketsByStage:o.ticketsByStage||{},totalTickets:o.totalTickets||0}:null,delta:this.calculateEmployeeDelta(i,o),trend:i?"removed":"new"});continue}const C={},D=["formed","review","execution"];for(const y of D){const k=i.ticketsByStage?.[y]||0,I=o.ticketsByStage?.[y]||0;C[y]=this.calculateDelta(k,I)}const p=this.calculateDelta(i.totalTickets||0,o.totalTickets||0);n.push({id:c,name:i.name,snapshot1:{ticketsByStage:i.ticketsByStage||{},totalTickets:i.totalTickets||0},snapshot2:{ticketsByStage:o.ticketsByStage||{},totalTickets:o.totalTickets||0},delta:{ticketsByStage:C,totalTickets:p},trend:p.trend})}return n}static calculateEmployeeDelta(e,t){if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},l=["formed","review","execution"];for(const n of l){const c=e?.ticketsByStage?.[n]||0,i=t?.ticketsByStage?.[n]||0;a[n]=this.calculateDelta(c,i)}const s=this.calculateDelta(e?.totalTickets||0,t?.totalTickets||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta(e?.unassigned||0,t?.unassigned||0),keeper:this.calculateDelta(e?.keeper||0,t?.keeper||0),total:this.calculateDelta(e?.total||0,t?.total||0)}}static compareTickets(e,t,a,l){const s=new Set(e),n=new Set(t),c=t.filter(y=>!s.has(y)),i=e.filter(y=>!n.has(y)),o=[],C=[],D=new Map(a.map(y=>[y.id,y])),p=new Map(l.map(y=>[y.id,y]));for(const y of e){if(!n.has(y))continue;const k=D.get(y),I=p.get(y);if(!k||!I)continue;const w=(k.assignedTo?.id||null)!==(I.assignedTo?.id||null),b=(k.stageId||null)!==(I.stageId||null);w||b?o.push(y):C.push(y)}return{new:c,removed:i,changed:o,unchanged:C}}static buildComparisonMetadata(e,t){const a=new Date(e.metadata.createdAt),l=new Date(t.metadata.createdAt),s=new Date,n=l.getTime()-a.getTime(),c=Math.floor(n/(1e3*60*60*24)),i=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),o=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:c,hours:i,minutes:o,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,t,a,l){const s=e.total.delta,n=Object.keys(e).filter(o=>o==="total"?!1:e[o].delta!==0).length,c=t.filter(o=>o.trend==="new"||o.trend==="removed"?!0:o.delta.totalTickets.delta!==0).length,i=s!==0||n>0||c>0;return{totalDelta:s,stagesChanged:n,employeesChanged:c,hasChanges:i,newTicketsCount:l?.new?.length||0,removedTicketsCount:l?.removed?.length||0,changedTicketsCount:l?.changed?.length||0}}static validateSnapshot(e){const t=[],a=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:a};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const l=["formed","review","execution"];for(const s of l)e.statistics.stages[s]||a.push(`Missing stage: ${s}`)}e.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:a}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const c=this.validateSnapshot(n);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...e].sort((n,c)=>{const i=new Date(n.metadata.createdAt),o=new Date(c.metadata.createdAt);return i-o}),l=[];for(let n=0;n<a.length-1;n++)l.push({from:n,to:n+1,result:this.compareTwoSnapshots(a[n],a[n+1],t)});const s=this.buildTrends(a);return{snapshots:a.map((n,c)=>({index:c,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:l,trends:s}}static buildTrends(e){const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const a of e){const l=a.statistics;t.stages.formed.push(l.stages?.formed?.count||0),t.stages.review.push(l.stages?.review?.count||0),t.stages.execution.push(l.stages?.execution?.count||0),t.stages.total.push(l.stages?.total||0),t.zeroPoint.unassigned.push(l.zeroPoint?.unassigned||0),t.zeroPoint.keeper.push(l.zeroPoint?.keeper||0),t.zeroPoint.total.push(l.zeroPoint?.total||0)}return t}}const zt={class:"stages-container"},Ut={class:"stages-chips"},Vt=["checked","disabled","onChange"],Kt={class:"stage-chip-label"},Gt={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:r=>r.every(e=>e.id&&e.name&&e.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(r,{emit:e}){const t=r,a=e;function l(s,n){const c={...t.selected};c[s]=n,a("update:selected",c),a("change",s,n)}return(s,n)=>(E(),_("div",zt,[n[0]||(n[0]=u("h4",{class:"stages-title"},"Этапы для отображения:",-1)),u("div",Ut,[(E(!0),_(ce,null,ue(r.stages,c=>(E(),_("label",{key:c.id,class:re(["stage-chip",{"stage-chip--active":r.selected[c.id],"stage-chip--disabled":r.disabled}])},[u("input",{type:"checkbox",checked:r.selected[c.id],disabled:r.disabled,onChange:i=>l(c.id,i.target.checked)},null,40,Vt),u("span",{class:"stage-chip-color",style:me({backgroundColor:c.color})},null,4),u("span",Kt,B(c.name),1)],2))),128))])]))}},Xt=Ue(Gt,[["__scopeId","data-v-fe03c03c"]]),Le=10;function Xe(r,e){if(!e||!e.statistics)return[];const t=[];e.statistics.employees&&Array.isArray(e.statistics.employees)&&e.statistics.employees.filter(l=>l.ticketsByStage&&l.ticketsByStage[r]>0).forEach(l=>{t.push({id:l.id,name:l.name,count:l.ticketsByStage[r]||0})});const a=Yt(r,e);return a>0&&t.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),t.sort((l,s)=>s.count-l.count)}function Yt(r,e){if(!e||!e.statistics)return 0;if(e.statistics.zeroPointByStage&&e.statistics.zeroPointByStage[r])return e.statistics.zeroPointByStage[r].keeper||0;if(e.statistics.zeroPoint){const t=e.statistics.zeroPoint.keeper||0;return Math.floor(t/3)}return 0}function kt(r,e){return!e||!e.statistics||!e.statistics.stages?0:e.statistics.stages[r]?.count||0}function Ye(r,e=Le){if(!r||r.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const t=[...r].sort((n,c)=>c.count-n.count),a=t.slice(0,e),l=t.slice(e),s=l.reduce((n,c)=>n+c.count,0);return{visible:a,others:{employees:l,count:s,employeeCount:l.length}}}function bt(r,e){return!r||r.length===0?[]:e===0?r.map(t=>({...t,percentage:0})):r.map(t=>({...t,percentage:parseFloat((t.count/e*100).toFixed(1))}))}function Ke(r,e,t="#007bff",a=Le){if(!r||r.length===0)return{employees:[],others:null};const{visible:l,others:s}=Ye(r,a),n=bt(l,e).map(i=>({...i,progressBarWidth:i.percentage,progressBarColor:i.isKeeper?"#f59e0b":t}));let c=null;if(s.count>0){const i=parseFloat((s.count/e*100).toFixed(1));c={...s,percentage:i,progressBarWidth:i,progressBarColor:"#6c757d"}}return{employees:n,others:c}}function qt(r,e){const t={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(l=>{const s=e[l];if(!s)return;const n=Xe(r,s),c=kt(r,s);if(n.length===0)return;const{visible:i,others:o}=Ye(n,Le),C=bt(i,c);t[l]=C,o.count>0&&(t.others[l]={count:o.count,employeeCount:o.employeeCount,percentage:parseFloat((o.count/c*100).toFixed(1))})}),t}function Jt(r,e="current",t=[]){const a=r[e];if(!a)return{labels:[],datasets:[]};const l=new Map;t.forEach(D=>{Xe(D.id,a).forEach(y=>{l.has(y.id)||l.set(y.id,{id:y.id,name:y.name,isKeeper:y.isKeeper||!1,ticketsByStage:{}}),l.get(y.id).ticketsByStage[D.id]=y.count})});const s=Array.from(l.values()).map(D=>{const p=Object.values(D.ticketsByStage).reduce((y,k)=>y+k,0);return{...D,totalTickets:p}});s.sort((D,p)=>p.totalTickets-D.totalTickets);const{visible:n,others:c}=Ye(s,Le),i=t.map(()=>""),o={};t.forEach(D=>{const p=Xe(D.id,a),{visible:y}=Ye(p,Le);o[D.id]=y.map(k=>({id:k.id,name:k.name,count:k.count}))});const C=n.map((D,p)=>{const y=t.map(I=>D.ticketsByStage[I.id]||0),k=t.map(I=>{if((D.ticketsByStage[I.id]||0)===0)return"transparent";const M=I.color.replace("#",""),L=parseInt(M.substring(0,2),16),K=parseInt(M.substring(2,4),16),U=parseInt(M.substring(4,6),16),q=.6+p*.05;return`rgba(${L}, ${K}, ${U}, ${Math.min(q,.95)})`});return{label:D.name,data:y,backgroundColor:k,borderColor:t.map(I=>{const w=I.color.replace("#",""),b=parseInt(w.substring(0,2),16),M=parseInt(w.substring(2,4),16),L=parseInt(w.substring(4,6),16);return`rgba(${b}, ${M}, ${L}, 0.8)`}),borderWidth:1,meta:{employeeId:D.id,employeeName:D.name}}});if(c.count>0){const D=t.map(p=>c.employees.reduce((y,k)=>y+(k.ticketsByStage[p.id]||0),0));C.push({label:`Другие (${c.employeeCount})`,data:D,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:i,datasets:C,meta:{employeesByStage:o}}}function Zt(r,e,t=[]){if(!e)return{stageName:"",totalCount:0,employees:[],others:null};const a=t.find(o=>o.id===r),l=a?a.name:"",s=a?a.color:"#007bff",n=Xe(r,e),c=kt(r,e);if(n.length===0)return{stageName:l,totalCount:0,employees:[],others:null};const i=Ke(n,c,s,Le);return{stageName:l,totalCount:c,employees:i.employees,others:i.others}}function Qt(r,e){return e?.[r]||r}function ea(r,e){return e?.[r]||"#007bff"}function ot({snapshots:r,graphType:e,timePoint:t,snapshotType:a}){return r?e==="line"&&t?r[t]||null:e==="bar"&&a?r[a]||null:r.current||r.weekEnd||r.weekStart||null:null}function rt(r,e){return e?.statistics?.stages?.[r]?.count||0}function ta({stageId:r,timePoint:e,meta:t,snapshots:a,stageColor:l,maxVisible:s}){if(!t?.employees||!e)return null;const n=t.employees[e];if(!n||n.length===0)return null;const c=a?.[e]||null,i=rt(r,c)||n.reduce((C,D)=>C+(D.count||0),0),o=Ke(n,i,l,s);return{stageId:r,totalCount:i,employees:o.employees,others:o.others,snapshot:c}}function aa({stageId:r,meta:e,snapshots:t,stageColor:a,maxVisible:l}){const s=e?.employees?.[r];if(!s||!s.employees||s.employees.length===0)return null;const n=ot({snapshots:t,graphType:"doughnut"}),c=s.totalCount??rt(r,n)??s.employees.reduce((o,C)=>o+(C.count||0),0),i=Ke(s.employees,c,a,l);return{stageId:r,totalCount:c,employees:i.employees,others:i.others,snapshot:n}}function sa({stageId:r,meta:e,snapshots:t,stageColor:a,maxVisible:l,snapshotType:s}){const n=e?.employeesByStage?.[r];if(!n||n.length===0)return null;const c=ot({snapshots:t,graphType:"bar",snapshotType:s}),i=rt(r,c)||n.reduce((C,D)=>C+(D.count||0),0),o=Ke(n,i,a,l);return{stageId:r,totalCount:i,employees:o.employees,others:o.others,snapshot:c}}async function wt({stageId:r,graphType:e,timePoint:t=null,snapshotType:a=null,snapshots:l=null,meta:s=null,stageColorMap:n=null,stageNameMap:c=null,maxVisible:i=10,restLoader:o=null}){if(!r)throw new Error("stageId обязателен для загрузки данных уровня 1");const C=Qt(r,c),D=ea(r,n);let p=null;if(e==="line"?p=ta({stageId:r,timePoint:t,meta:s?.line,snapshots:l,stageColor:D,maxVisible:i}):e==="doughnut"?p=aa({stageId:r,meta:s?.doughnut,snapshots:l,stageColor:D,maxVisible:i}):e==="bar"&&(p=sa({stageId:r,meta:s?.bar,snapshots:l,stageColor:D,maxVisible:i,snapshotType:a})),p)return{stageId:r,stageName:C,color:D,totalCount:p.totalCount,employees:p.employees,others:p.others,snapshot:p.snapshot};if(typeof o=="function"){const y=await o({stageId:r,graphType:e,timePoint:t,snapshotType:a,snapshots:l});if(y&&Array.isArray(y.employees)){const k=y.totalCount??y.employees.reduce((w,b)=>w+(b.count||0),0),I=Ke(y.employees,k,D,i);return{stageId:r,stageName:C,color:D,totalCount:k,employees:I.employees,others:I.others,snapshot:y.snapshot||ot({snapshots:l,graphType:e,timePoint:t,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const na={key:"level-1",class:"level-1"},oa={class:"modal-header"},ra={class:"stage-header"},la=["aria-expanded","onKeydown"],ia={class:"stage-title"},ca=["aria-selected","onClick","onKeydown"],ua={class:"stage-name"},da={class:"modal-total"},pa={class:"view-switcher"},ma={class:"modal-body"},ga={key:0,class:"load-error"},fa={key:1,class:"stage-loader"},ha={key:2},va={key:0,class:"no-employees"},ya={key:1,class:"employees-list"},ka=["onClick"],ba={class:"employee-name"},wa={class:"employee-progress"},Sa={class:"employee-count"},Da={key:0,class:"employee-item employee-others"},Ca={class:"employee-name"},Ea={class:"employee-progress"},_a={class:"employee-count"},Ta={key:3,class:"view-time"},$a={key:0,class:"no-data"},Ia={key:1,class:"date-categories-list"},Aa=["onClick"],Ma={class:"category-label"},Na={class:"category-progress"},xa={class:"category-count"},Fa={key:4,class:"view-departments"},Pa={key:0,class:"no-data"},Ba={key:1,class:"departments-table-container"},La={class:"departments-table"},Ra=["onClick"],Ha={class:"col-department"},Oa={class:"department-name"},Wa={class:"col-count"},ja={class:"count-value"},za={key:"level-2",class:"level-2"},Ua={class:"modal-header"},Va={class:"modal-total"},Ka={class:"modal-body"},Ga={class:"stage-info level2-stage-row"},Xa={class:"stage-badge"},Ya={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},qa={key:0},Ja={key:0,class:"no-data"},Za={key:1,class:"date-categories-list"},Qa=["onClick"],es={class:"category-label"},ts={class:"category-progress"},as={class:"category-count"},ss={key:1,class:"view-departments"},ns={key:0,class:"no-data"},os={key:1,class:"departments-table-container"},rs={class:"departments-table"},ls=["onClick"],is={class:"col-department"},cs={class:"department-name"},us={class:"col-count"},ds={class:"count-value"},ps={key:"level-3",class:"level-3"},ms={class:"modal-header"},gs={class:"header-info"},fs={class:"header-badges"},hs={class:"date-badge"},vs={class:"stage-badge"},ys={class:"modal-total"},ks={class:"modal-body"},bs={key:0,class:"no-data"},ws={key:1,class:"departments-table-container"},Ss={class:"departments-table"},Ds=["onClick"],Cs={class:"col-department"},Es={class:"department-name"},_s={class:"col-count"},Ts={class:"count-value"},$s={key:"level-4",class:"level-4"},Is={class:"modal-header"},As={class:"header-info"},Ms={key:0,class:"header-badges"},Ns={key:0,class:"date-badge"},xs={key:1,class:"department-badge"},Fs={class:"stage-badge"},Ps={class:"modal-total"},Bs={class:"modal-body"},Ls={key:"loading",class:"loading-state"},Rs={key:"error-fallback",class:"error-state-with-fallback"},Hs={class:"tickets-list-container"},Os={key:"error",class:"error-state"},Ws={class:"error-message"},js={key:"empty",class:"empty-state"},zs={class:"empty-state-title"},Us={class:"empty-state-message"},Vs={key:"tickets",class:"tickets-list-container"},Ks={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(r,{expose:e,emit:t}){const a=r,l=t,s=Ve(),n=N(1),c=N("time"),i=N("employees"),o=N(null),C=N([]),D=N([]),p=N(null),y=N(null),k=N(null),I=N(a.stageSwitchContext||null),w=N(!1),b=N(null),M=N(null),L=N(!1),K=N(null),U=N(null),q=Y(()=>{const g=I.value?.stageNameMap||{},m=I.value?.stageColorMap||{};return Object.keys(g).map(d=>({id:d,name:g[d],color:m[d]||"#007bff",disabled:d===(o.value?.stageId||a.stageId)}))});Y(()=>n.value>1);const pe=Y(()=>{switch(n.value){case 1:return o.value?.stageName||a.stageName;case 2:return p.value?.employeeName||"";case 3:return`${p.value?.employeeName||""} — ${y.value?.dateCategoryLabel||""}`;case 4:if(!k.value?.context)return"Список тикетов";const g=k.value.context,m=[];return g.employeeName&&m.push(g.employeeName),g.dateCategoryLabel&&m.push(g.dateCategoryLabel),g.departmentName&&m.push(g.departmentName),g.stageName&&m.push(g.stageName),m.length>0?m.join(" — "):"Список тикетов";default:return""}});function ee(){console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:a.employees?.length||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:a.snapshot?.ticketIds?.length||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:o.value.stageId,hasSnapshot:!!o.value.snapshot,employeesCount:o.value.employees.length,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null"}),p.value=null,y.value=null,k.value=null,n.value=1,c.value="time",i.value="employees",G(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function G(){if(!o.value||!o.value.snapshot||!o.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const g=o.value.snapshot.tickets||[],m=o.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:g.length,currentStageId:m,sampleTicket:g[0]?{id:g[0].id,stageId:g[0].stageId,hasDepartmentHead:!!g[0].departmentHead,departmentHead:g[0].departmentHead,hasDepartmentHeadFull:!!g[0].departmentHeadFull,departmentHeadFull:g[0].departmentHeadFull,allKeys:Object.keys(g[0])}:null});let d=g.filter(x=>x.stageId?et(x.stageId)===m:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:g.length,afterFilter:d.length,stageId:m,ticketsWithStageId:d.filter(x=>x.stageId).length,ticketsWithoutStageId:d.filter(x=>!x.stageId).length});const T=d.filter(x=>!x.departmentHead&&!x.departmentHeadFull);if(T.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:T.length,totalTickets:d.length,ticketsWithDepartment:d.filter(v=>v.departmentHead||v.departmentHeadFull).length});const x=T.map(v=>v.id).filter(v=>v);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:x.length,ticketIdsSample:x.slice(0,10)});const v=await Pt.getTicketsDetails(x),f=new Map;v.forEach(h=>{h&&h.id&&f.set(h.id,h)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:v.length,detailsMapSize:f.size,sampleDetail:v[0]?{id:v[0].id,departmentHead:v[0].departmentHead,departmentHeadFull:v[0].departmentHeadFull}:null}),d=d.map(h=>{const A=f.get(h.id);return A?{...h,stageId:A.stageId||h.stageId||null,departmentHead:A.departmentHead||h.departmentHead||null,departmentHeadFull:A.departmentHeadFull||A.departmentHead||h.departmentHead||null}:h}),d=d.filter(h=>h.stageId?et(h.stageId)===m:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:d.length,ticketsWithDepartment:d.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:d.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,ticketsWithStageId:d.filter(h=>h.stageId).length,ticketsWithoutStageId:d.filter(h=>!h.stageId).length});const S=d.length,$=d.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));d=d.filter(h=>h.stageId?et(h.stageId)===m:!0);const F=d.slice(0,3).map(h=>({id:h.id,departmentHead:h.departmentHead,departmentHeadFull:h.departmentHeadFull,stageId:h.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:S,afterStageFilter:d.length,filteredOut:S-d.length,currentStageId:m,ticketsWithDepartment:d.filter(h=>h.departmentHead||h.departmentHeadFull).length,ticketsWithoutDepartment:d.filter(h=>!h.departmentHead&&!h.departmentHeadFull).length,sampleBeforeFilter:$,sampleAfterFilter:F,sampleWithDepartment:d.find(h=>h.departmentHead||h.departmentHeadFull)?{id:d.find(h=>h.departmentHead||h.departmentHeadFull).id,departmentHead:d.find(h=>h.departmentHead||h.departmentHeadFull).departmentHead,departmentHeadFull:d.find(h=>h.departmentHead||h.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(d.find(h=>h.departmentHead||h.departmentHeadFull)).filter(h=>h.toLowerCase().includes("department"))}:null})}catch(v){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",v),console.error("[EmployeeDetailsModal] Error details:",{message:v.message,stack:v.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:d.length,currentStageId:m,ticketsWithStageId:d.filter(x=>x.stageId).length,ticketsWithoutStageId:d.filter(x=>!x.stageId).length,ticketsWithDepartment:d.filter(x=>x.departmentHead||x.departmentHeadFull).length,ticketsWithoutDepartment:d.filter(x=>!x.departmentHead&&!x.departmentHeadFull).length});const W=dt(d);C.value=W,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:d.length,sampleTickets:d.slice(0,5).map(x=>({id:x.id,departmentHead:x.departmentHead,departmentHeadFull:x.departmentHeadFull,hasDepartmentHead:!!x.departmentHead,hasDepartmentHeadFull:!!x.departmentHeadFull,allKeys:Object.keys(x).filter(v=>v.toLowerCase().includes("department"))})),ticketsWithDepartment:d.filter(x=>x.departmentHead||x.departmentHeadFull).length,ticketsWithoutDepartment:d.filter(x=>!x.departmentHead&&!x.departmentHeadFull).length});const te=pt(d);D.value=te;const ae=W.reduce((x,v)=>x+v.count,0),Ee=te.reduce((x,v)=>x+v.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:m,totalTicketsForGrouping:d.length,timeCategoriesCount:W.length,totalTicketsInTimeCategories:ae,departmentsCount:te.length,totalTicketsInDepartments:Ee,departmentsSample:te.slice(0,5),ticketsWithDepartment:d.filter(x=>x.departmentHead||x.departmentHeadFull).length,ticketsWithoutDepartment:d.filter(x=>!x.departmentHead&&!x.departmentHeadFull).length,consistencyCheck:{totalTickets:d.length,timeCategoriesTotal:ae,departmentsTotal:Ee,isConsistent:d.length===ae&&d.length===Ee}})}catch(g){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",g),console.error("[EmployeeDetailsModal] Error stack:",g.stack)}}async function le(g){if(!g){s.error("Не указан stageId для загрузки данных");return}if(o.value?.stageId===g)return;if(!I.value){s.error("Нет контекста для смены стадии (stageSwitchContext)");return}w.value=!0,b.value=null;const m=o.value?{...o.value}:null;M.value=m?.stageId||null;try{const d=await wt({...I.value,stageId:g});o.value={stageId:d.stageId,stageName:d.stageName,stageColor:d.color,totalCount:d.totalCount,employees:d.employees,others:d.others,snapshot:d.snapshot||m?.snapshot||null,ticketDetails:d.ticketDetails||null},p.value=null,y.value=null,k.value=null,n.value=1,c.value="time",i.value="employees",await G()}catch(d){console.error("[EmployeeDetailsModal] Failed to reload stage data:",d),b.value=d?.message||"Не удалось загрузить данные стадии",m&&(o.value=m),s.error(b.value)}finally{w.value=!1}}async function Se(g){if(!g||g.count===0){s.info(`У заказчика "${g?.departmentName||"неизвестный"}" нет тикетов`);return}if(!y.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),s.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:m}=await ve(async()=>{const{createContextFromLevel3:T}=await import("./chunk-CWOGIwxH.js").then(W=>W.t);return{createContextFromLevel3:T}},__vite__mapDeps([0,1,2]),import.meta.url),d=await m(y.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:d.employeeName,dateCategory:d.dateCategoryLabel,departmentName:d.departmentName,ticketsCount:d.tickets.length}),await ie(d)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function De(g){if(!g||g.count===0){s.info(`У заказчика "${g?.departmentName||"неизвестный"}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),s.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:m}=await ve(async()=>{const{createContextFromLevel1Department:T}=await import("./chunk-CWOGIwxH.js").then(W=>W.t);return{createContextFromLevel1Department:T}},__vite__mapDeps([0,1,2]),import.meta.url),d=m(o.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:d.stageName,departmentName:d.departmentName,ticketsCount:d.tickets.length}),await ie(d)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function ge(g){if(!g||g.count===0){s.info(`В категории "${g?.label||"неизвестная"}" нет тикетов`);return}if(!g.tickets||g.tickets.length===0){s.info(`В категории "${g.label}" нет тикетов`);return}if(!o.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),s.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:m}=await ve(async()=>{const{createContextFromLevel1Time:T}=await import("./chunk-CWOGIwxH.js").then(W=>W.t);return{createContextFromLevel1Time:T}},__vite__mapDeps([0,1,2]),import.meta.url),d=m(o.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:d.stageName,dateCategory:d.dateCategoryLabel,ticketsCount:d.tickets.length}),await ie(d)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}We(()=>a.isVisible,g=>{g?ee():(Me(),ne())}),We(()=>a.stageSwitchContext,g=>{I.value=g},{deep:!0}),ze(()=>{a.isVisible&&ee()});async function Ie(g,m=null){if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",g),console.log("[EmployeeDetailsModal] Current popup level:",n.value),m&&m.currentTarget&&(m.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{m.currentTarget&&(m.currentTarget.style.transform="")},150)),!g||!g.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",g);return}if(o.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),o.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:o.value.stageId,stageName:o.value.stageName,hasSnapshot:!!o.value.snapshot,snapshotType:o.value.snapshot?typeof o.value.snapshot:"null",snapshotKeys:o.value.snapshot?Object.keys(o.value.snapshot):[]}),!o.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),s.warning("ID стадии не указан");return}if(!o.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),s.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",g.id,"stage:",o.value.stageId);const{filterTicketsByDepartment:d}=await ve(async()=>{const{filterTicketsByDepartment:ae}=await import("./chunk-C5D5xwuQ.js").then(Ee=>Ee.l);return{filterTicketsByDepartment:ae}},__vite__mapDeps([1,2]),import.meta.url).then(ae=>ae.LazyServiceLoader.loadTicketListUtils()),T=await xt(g.id,o.value.stageId,o.value.snapshot,o.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",T?.length||0,T),!T||T.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),s.info(`У сотрудника "${g.name}" нет тикетов на стадии "${o.value.stageName}"`);return}const W=dt(T);console.log("[EmployeeDetailsModal] Date categories:",W?.length||0,W);const te=pt(T).map(ae=>({...ae,tickets:d(T,ae.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",te?.length||0,te),p.value={employeeId:g.id,employeeName:g.name,stageId:o.value.stageId,stageName:o.value.stageName,totalCount:T.length,dateCategories:W,departments:te,tickets:T,snapshot:o.value.snapshot,ticketDetails:o.value.ticketDetails},c.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:p.value.employeeName,totalCount:p.value.totalCount,dateCategoriesCount:p.value.dateCategories.length,departmentsCount:p.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",p.value),n.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",n.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",p.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!p.value,employeeName:p.value?.employeeName,dateCategoriesCount:p.value?.dateCategories?.length||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",n.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",p.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(d){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",d),console.error("[EmployeeDetailsModal] Error stack:",d.stack),s.error("Ошибка загрузки данных о тикетах: "+d.message)}}async function Re(g){if(!g||g.count===0){s.info(`У заказчика "${g?.departmentName||"неизвестный"}" нет тикетов`);return}if(!p.value){s.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:m}=await ve(async()=>{const{createContextFromLevel2Department:T}=await import("./chunk-CWOGIwxH.js").then(W=>W.t);return{createContextFromLevel2Department:T}},__vite__mapDeps([0,1,2]),import.meta.url),d=m(p.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:d.employeeName,departmentName:d.departmentName,ticketsCount:d.tickets.length}),await ie(d)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function Ae(g){if(!g||g.count===0){s.info(`В категории "${g?.label||"неизвестная"}" нет тикетов`);return}if(!g.tickets||g.tickets.length===0){s.info(`В категории "${g.label}" нет тикетов`);return}if(!p.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),s.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:m}=await ve(async()=>{const{createContextFromLevel2:T}=await import("./chunk-CWOGIwxH.js").then(W=>W.t);return{createContextFromLevel2:T}},__vite__mapDeps([0,1,2]),import.meta.url),d=m(p.value,g);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:d.employeeName,dateCategory:d.dateCategoryLabel,ticketsCount:d.tickets.length}),await ie(d)}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",m),s.error("Ошибка перехода на список тикетов: "+m.message)}}async function ie(g){if(console.time("[Performance] goToLevel4"),!g){console.error("[EmployeeDetailsModal] Context is required for level 4"),s.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:g.sourceLevel,employeeId:g.employeeId,stageId:g.stageId,dateCategory:g.dateCategory,departmentName:g.departmentName,ticketsCount:g.tickets?.length||0});try{k.value={context:g,tickets:[],totalCount:0,isLoading:!0,error:null};let m=g.tickets||[];if(m.length===0&&g.snapshot){const{filterTicketsByContext:T}=await ve(async()=>{const{filterTicketsByContext:W}=await import("./chunk-CWOGIwxH.js").then(te=>te.t);return{filterTicketsByContext:W}},__vite__mapDeps([0,1,2]),import.meta.url);m=await T(g)}(!m||m.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),m=g.tickets||[]),(!m||m.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),g.snapshot&&g.snapshot.tickets&&(m=g.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",m.length)));let d=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:T}=await ve(async()=>{const{prepareTicketsForDisplay:W}=await import("./chunk-CWOGIwxH.js").then(te=>te.t);return{prepareTicketsForDisplay:W}},__vite__mapDeps([0,1,2]),import.meta.url);d=await T(m,g.snapshot,g.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(T){console.error("[EmployeeDetailsModal] Error preparing tickets:",T),console.timeEnd("[Performance] prepareTicketsForDisplay"),d=m||[],s.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:m.length,preparedCount:d.length}),k.value={context:g,tickets:d,totalCount:d.length,isLoading:!1,error:null},n.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:k.value.totalCount,ticketsCount:k.value.tickets.length,isLoading:k.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(m){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",m),console.error("[EmployeeDetailsModal] Error details:",{message:m.message,stack:m.stack,context:g});let d=[];if(g.snapshot&&g.snapshot.tickets)try{const T=g.stageId;T?d=(g.snapshot.tickets||[]).filter(W=>W.stageId===T):d=g.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",d.length)}catch(T){console.error("[EmployeeDetailsModal] Error using fallback tickets:",T)}k.value={context:g,tickets:d,totalCount:d.length,isLoading:!1,error:{message:m.message,hasFallback:d.length>0}},d.length>0?(s.warning("Ошибка загрузки данных. Отображаются данные из кеша."),n.value=4):(s.error("Ошибка загрузки тикетов: "+m.message),fe()),console.timeEnd("[Performance] goToLevel4")}}function fe(){if(n.value===4){if(k.value&&k.value.context){const g=k.value.context.sourceLevel;n.value=g}else n.value=1;k.value=null}else n.value===3?(n.value=2,y.value=null,k.value=null):n.value===2&&(n.value=1,p.value=null,y.value=null,k.value=null)}function Me(){n.value=1,o.value=null,p.value=null,y.value=null,k.value=null,c.value="time"}function he(){if(!k.value?.context)return"Нет тикетов";const{sourceLevel:g,employeeName:m,dateCategoryLabel:d,departmentName:T}=k.value.context;return g===2&&m&&d?`Нет тикетов у ${m} в категории "${d}"`:g===2&&m&&T?`Нет тикетов у ${m} у заказчика "${T}"`:g===3&&m&&T?`Нет тикетов у ${m} у заказчика "${T}"`:g===1&&d?`Нет тикетов в категории "${d}"`:g===1&&T?`Нет тикетов у заказчика "${T}"`:"Нет тикетов для отображения"}function Ne(){if(!k.value?.context)return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:g}=k.value.context;return g?`На стадии "${g}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function xe(){if(!k.value?.context){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const g=k.value.context;await ie(g)}function Ce(g){if(!g){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),s.warning("Ошибка: тикет не найден");return}if(!g.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",g),s.error("Ошибка: ID тикета не указан");return}try{const m=Ft(g.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:g.id,iframeUrl:m}),!m||typeof m!="string"||m.length===0)throw new Error("Не удалось сформировать URL для тикета");const d=window.open(m,"_blank","noopener,noreferrer");if(!d||d.closed||typeof d.closed>"u")try{const T=document.createElement("a");T.href=m,T.target="_blank",T.rel="noopener noreferrer",T.style.display="none",document.body.appendChild(T),T.click(),document.body.removeChild(T),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:g.id,iframeUrl:m})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:g.id,iframeUrl:m})}catch(m){console.error("[EmployeeDetailsModal] Error opening ticket:",m),console.error("[EmployeeDetailsModal] Error details:",{message:m.message,stack:m.stack,ticket:g}),s.error("Ошибка открытия тикета: "+m.message)}}function P(){Me(),l("close")}e({reloadLevel1ForStage:le});function H(g){g&&g.stopPropagation(),L.value=!L.value}function ne(){L.value&&(L.value=!1)}function Fe(g){if(!L.value)return;const m=K.value,d=U.value;m&&m.contains(g.target)||d&&d.contains(g.target)||(L.value=!1)}async function oe(g){if(g.disabled){L.value=!1;return}L.value=!1,await le(g.id)}function Pe(g){if(L.value){g.stopPropagation(),ne();return}P()}return(g,m)=>(E(),we(ft,{to:"body"},[r.isVisible?(E(),_("div",{key:0,class:"employee-details-modal",onClick:se(P,["self"]),onKeydown:He(Pe,["esc"])},[u("div",{class:"modal-content",onClick:Fe},[de(st,{name:"level",mode:"out-in"},{default:$e(()=>[n.value===1?(E(),_("div",na,[u("div",oa,[u("div",ra,[u("button",{ref_key:"stageTriggerRef",ref:U,class:"stage-trigger","aria-expanded":L.value,"aria-haspopup":"listbox",onClick:se(H,["stop"]),onKeydown:[He(se(H,["prevent"]),["enter"]),He(se(H,["prevent"]),["space"]),He(se(ne,["stop","prevent"]),["esc"])]},[u("span",{class:"stage-color",style:me({backgroundColor:o.value?.stageColor||I.value?.stageColorMap?.[o.value?.stageId]||I.value?.stageColorMap?.[r.stageId]||"#007bff"})},null,4),u("span",ia,B(o.value?.stageName||r.stageName),1),u("span",{class:re(["stage-caret",{open:L.value}])},"▾",2)],40,la),L.value?(E(),_("div",{key:0,ref_key:"stageDropdownRef",ref:K,class:"stage-dropdown",role:"listbox"},[(E(!0),_(ce,null,ue(q.value,d=>(E(),_("div",{key:d.id,class:re(["stage-option",{disabled:d.disabled}]),role:"option","aria-selected":d.disabled,onClick:se(T=>oe(d),["stop"]),onKeydown:He(se(T=>oe(d),["prevent"]),["enter"])},[u("span",{class:"stage-color",style:me({backgroundColor:d.color})},null,4),u("span",ua,B(d.name),1)],42,ca))),128))],512)):V("",!0)]),u("span",da,"Всего: "+B(o.value?.totalCount||r.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:P,"aria-label":"Закрыть"},"×")]),u("div",pa,[u("button",{class:re(["view-switch-btn",{active:i.value==="employees"}]),onClick:m[0]||(m[0]=d=>i.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),u("button",{class:re(["view-switch-btn",{active:i.value==="time"}]),onClick:m[1]||(m[1]=d=>i.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),u("button",{class:re(["view-switch-btn",{active:i.value==="departments"}]),onClick:m[2]||(m[2]=d=>i.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),u("div",ma,[b.value?(E(),_("div",ga,[u("span",null,"Ошибка: "+B(b.value),1),u("button",{class:"btn-retry-stage",onClick:m[3]||(m[3]=d=>le(o.value?.stageId||r.stageId))}," Повторить ")])):V("",!0),w.value?(E(),_("div",fa,[...m[7]||(m[7]=[u("div",{class:"loading-spinner small"},null,-1),u("span",null,"Загрузка стадии...",-1)])])):V("",!0),i.value==="employees"?(E(),_("div",ha,[(o.value?.employees||r.employees).length===0&&(!(o.value?.others||r.others)||(o.value?.others||r.others).count===0)?(E(),_("div",va," Нет данных о сотрудниках ")):(E(),_("div",ya,[(E(!0),_(ce,null,ue(o.value?.employees||r.employees,d=>(E(),_("div",{key:d.id,class:re(["employee-item",{"employee-keeper":d.isKeeper}]),onClick:se(T=>Ie(d,T),["stop"]),title:"Кликните для детализации по временным градациям"},[u("span",ba,B(d.name),1),u("div",wa,[u("div",{class:"progress-bar",style:me({width:d.progressBarWidth+"%",backgroundColor:d.progressBarColor})},null,4)]),u("span",Sa,B(d.count)+" тикетов ("+B(d.percentage)+"%) ",1),m[8]||(m[8]=u("span",{class:"employee-arrow"},"→",-1))],10,ka))),128)),(o.value?.others||r.others)&&(o.value?.others||r.others).count>0?(E(),_("div",Da,[u("span",Ca,"Другие ("+B((o.value?.others||r.others).employeeCount)+")",1),u("div",Ea,[u("div",{class:"progress-bar",style:me({width:(o.value?.others||r.others).progressBarWidth+"%",backgroundColor:(o.value?.others||r.others).progressBarColor})},null,4)]),u("span",_a,B((o.value?.others||r.others).count)+" тикетов ("+B((o.value?.others||r.others).percentage)+"%) ",1)])):V("",!0)]))])):i.value==="time"?(E(),_("div",Ta,[C.value.length===0?(E(),_("div",$a," Загрузка данных... ")):(E(),_("div",Ia,[(E(!0),_(ce,null,ue(C.value,d=>(E(),_("div",{key:d.category,class:"category-item",onClick:se(T=>ge(d),["stop"])},[u("span",Ma,B(d.label),1),u("div",Na,[u("div",{class:"progress-bar",style:me({width:d.progressBarWidth+"%",backgroundColor:d.progressBarColor})},null,4)]),u("span",xa,B(d.count)+" тикетов ("+B(d.percentage)+"%) ",1),m[9]||(m[9]=u("span",{class:"category-arrow"},"→",-1))],8,Aa))),128))]))])):i.value==="departments"?(E(),_("div",Fa,[D.value.length===0?(E(),_("div",Pa," Загрузка данных... ")):(E(),_("div",Ba,[u("table",La,[m[11]||(m[11]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(E(!0),_(ce,null,ue(D.value,(d,T)=>(E(),_("tr",{key:T,class:"department-row",onClick:se(W=>De(d),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",Ha,[u("span",Oa,B(d.departmentName),1)]),u("td",Wa,[u("span",ja,B(d.count),1)]),m[10]||(m[10]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,Ra))),128))])])]))])):V("",!0)])])):n.value===2&&p.value?(E(),_("div",za,[u("div",Ua,[u("button",{class:"btn-back",onClick:fe,"aria-label":"Назад"}," ← "),u("h3",null,B(p.value.employeeName),1),u("span",Va,"Всего: "+B(p.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:P,"aria-label":"Закрыть"},"×")]),u("div",Ka,[u("div",Ga,[u("span",Xa,B(p.value.stageName),1),u("div",Ya,[u("button",{class:re(["level2-sort-btn",{active:c.value==="time"}]),onClick:m[4]||(m[4]=d=>c.value="time"),title:"Сортировка по времени"}," По времени ",2),u("button",{class:re(["level2-sort-btn",{active:c.value==="departments"}]),onClick:m[5]||(m[5]=d=>c.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),c.value==="time"?(E(),_("div",qa,[p.value.dateCategories.length===0?(E(),_("div",Ja," Нет данных о тикетах ")):(E(),_("div",Za,[(E(!0),_(ce,null,ue(p.value.dateCategories,d=>(E(),_("div",{key:d.category,class:"category-item",onClick:se(T=>Ae(d),["stop"])},[u("span",es,B(d.label),1),u("div",ts,[u("div",{class:"progress-bar",style:me({width:d.progressBarWidth+"%",backgroundColor:d.progressBarColor})},null,4)]),u("span",as,B(d.count)+" тикетов ("+B(d.percentage)+"%) ",1)],8,Qa))),128))]))])):(E(),_("div",ss,[!p.value.departments||p.value.departments.length===0?(E(),_("div",ns,[m[12]||(m[12]=at(" Для выбранного сотрудника заказчики не найдены ",-1)),u("button",{class:"btn-retry-stage",onClick:m[6]||(m[6]=d=>Ie({id:p.value.employeeId,name:p.value.employeeName}))}," Обновить ")])):(E(),_("div",os,[u("table",rs,[m[14]||(m[14]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(E(!0),_(ce,null,ue(p.value.departments,(d,T)=>(E(),_("tr",{key:T,class:"department-row",onClick:se(W=>Re(d),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",is,[u("span",cs,B(d.departmentName),1)]),u("td",us,[u("span",ds,B(d.count),1)]),m[13]||(m[13]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,ls))),128))])])]))]))])])):n.value===3&&y.value?(E(),_("div",ps,[u("div",ms,[u("button",{class:"btn-back",onClick:fe,"aria-label":"Назад"}," ← "),u("div",gs,[u("h3",null,B(y.value.employeeName),1),u("div",fs,[u("span",hs,B(y.value.dateCategoryLabel),1),u("span",vs,B(y.value.stageName),1)])]),u("span",ys,"Всего: "+B(y.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:P,"aria-label":"Закрыть"},"×")]),u("div",ks,[y.value.departments.length===0?(E(),_("div",bs," Нет данных о заказчиках ")):(E(),_("div",ws,[u("table",Ss,[m[16]||(m[16]=u("thead",null,[u("tr",null,[u("th",{class:"col-department"},"Заказчик"),u("th",{class:"col-count"},"Количество тикетов"),u("th",{class:"col-action"})])],-1)),u("tbody",null,[(E(!0),_(ce,null,ue(y.value.departments,(d,T)=>(E(),_("tr",{key:T,class:"department-row",onClick:se(W=>Se(d),["stop"]),title:"Кликните для просмотра тикетов"},[u("td",Cs,[u("span",Es,B(d.departmentName),1)]),u("td",_s,[u("span",Ts,B(d.count),1)]),m[15]||(m[15]=u("td",{class:"col-action"},[u("span",{class:"department-arrow"},"→")],-1))],8,Ds))),128))])])]))])])):n.value===4&&k.value?(E(),_("div",$s,[u("div",Is,[u("button",{class:"btn-back",onClick:fe,"aria-label":"Назад"}," ← "),u("div",As,[u("h3",null,B(pe.value),1),k.value.context?(E(),_("div",Ms,[k.value.context.dateCategoryLabel?(E(),_("span",Ns,B(k.value.context.dateCategoryLabel),1)):V("",!0),k.value.context.departmentName?(E(),_("span",xs,B(k.value.context.departmentName),1)):V("",!0),u("span",Fs,B(k.value.context.stageName),1)])):V("",!0)]),u("span",Ps,"Всего: "+B(k.value.totalCount)+" тикетов",1),u("button",{class:"modal-close",onClick:P,"aria-label":"Закрыть"},"×")]),u("div",Bs,[de(st,{name:"loading",mode:"out-in"},{default:$e(()=>[k.value.isLoading?(E(),_("div",Ls,[...m[17]||(m[17]=[u("div",{class:"loading-spinner"},null,-1),u("p",null,"Загрузка тикетов...",-1)])])):k.value.error&&k.value.error.hasFallback?(E(),_("div",Rs,[m[18]||(m[18]=u("div",{class:"error-banner"},[u("span",{class:"error-icon"},"⚠️"),u("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),u("div",Hs,[de(it,{name:"ticket",tag:"div",class:"tickets-list"},{default:$e(()=>[(E(!0),_(ce,null,ue(k.value.tickets,(d,T)=>(E(),we(mt,{key:d.id,ticket:d,draggable:!1,style:me({"--ticket-index":T}),onClick:W=>Ce(d)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):k.value.error&&!k.value.error.hasFallback?(E(),_("div",Os,[m[19]||(m[19]=u("div",{class:"error-icon"},"❌",-1)),m[20]||(m[20]=u("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),u("p",Ws,B(k.value.error.message),1),u("button",{class:"btn-retry",onClick:xe},"Повторить попытку")])):!k.value.tickets||k.value.tickets.length===0?(E(),_("div",js,[m[21]||(m[21]=u("div",{class:"empty-state-icon"},"📭",-1)),u("h3",zs,B(he()),1),u("p",Us,B(Ne()),1)])):(E(),_("div",Vs,[de(it,{name:"ticket",tag:"div",class:"tickets-list"},{default:$e(()=>[(E(!0),_(ce,null,ue(k.value.tickets,(d,T)=>(E(),we(mt,{key:d.id,ticket:d,draggable:!1,style:me({"--ticket-index":T}),onClick:W=>Ce(d)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):V("",!0)]),_:1})])],32)):V("",!0)]))}},Gs=Ue(Ks,[["__scopeId","data-v-7fbd8a12"]]);function Xs(r,e,t=.5){if(!e||!Array.isArray(e)||e.length===0||typeof r!="number"||r<0)return 0;(typeof t!="number"||t<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),t=.5);const a=[];if(e.forEach((n,c)=>{if(!n||!n.data||!Array.isArray(n.data))return;const i=n.data[r];i!=null&&!isNaN(i)&&a.push({datasetIndex:c,value:Number(i),y:Number(i)})}),a.length<2)return 0;const l=[];return a.forEach(n=>{let c=!1;for(const i of l){const o=i.y;if(Math.abs(n.y-o)<t){i.points.push(n),i.y=i.points.reduce((D,p)=>D+p.y,0)/i.points.length,c=!0;break}}c||l.push({points:[n],y:n.y})}),l.length===0?0:l.reduce((n,c)=>c.points.length>n.points.length?c:n,l[0]).points.length}function Ys(r,e){const t=[];return r.forEach(a=>{let l=!1;for(const s of t){const n=s.y;if(Math.abs(a.value-n)<e){s.points.push(a),s.y=s.points.reduce((c,i)=>c+i.value,0)/s.points.length,l=!0;break}}l||t.push({points:[a],y:a.value})}),t}function qs(r,e=.5){if(!r)return console.warn("findOverlappingPoints: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];const t=r.data?.datasets,a=r.data?.labels||[];if(!t||!Array.isArray(t)||t.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof e!="number"||e<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),e=.5);const l=[];return a.forEach((s,n)=>{try{if(Xs(n,t,e)<2)return;const i=[];if(t.forEach((y,k)=>{if(!y||!y.data||!Array.isArray(y.data))return;const I=y.data[n];I==null||isNaN(I)||i.push({datasetIndex:k,value:Number(I),label:y.label||`Dataset ${k}`})}),i.length<2)return;const o=Ys(i,e);if(o.length===0)return;const C=o.reduce((y,k)=>k.points.length>y.points.length?k:y,o[0]);if(C.points.length<2)return;let D=null,p=null;for(let y=0;y<t.length;y++)try{const k=r.getDatasetMeta(y);if(k&&k.data&&k.data[n]){D=k,p=k.data[n];break}}catch{continue}if(!p||typeof p.x!="number"||typeof p.y!="number")return;l.push({position:n,count:C.points.length,x:p.x,y:p.y,value:C.y,points:C.points.map(y=>({datasetIndex:y.datasetIndex,value:y.value,label:y.label}))})}catch(c){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${n}:`,c)}}),l}function Js(r,e){const t=[];return r.forEach(a=>{let l=!1;for(const s of t){const n=s.y;if(Math.abs(a.y-n)<e){s.points.push(a),s.y=s.points.reduce((c,i)=>c+i.y,0)/s.points.length,l=!0;break}}l||t.push({points:[a],y:a.y})}),t}function Zs(r,e,t=.5){if(!r)return console.warn("calculatePointJitter: chart не передан"),[];if(!r.config||r.config.type!=="line")return[];if(typeof e!="number"||e<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof t!="number"||t<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),t=.5);const a=r.data?.datasets,l=r.data?.labels||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(l)||e>=l.length)return[];const s=[];if(a.forEach((o,C)=>{if(!o||!o.data||!Array.isArray(o.data))return;const D=o.data[e];if(!(D==null||isNaN(D)))try{const p=r.getDatasetMeta(C);if(p&&p.data&&p.data[e]){const y=p.data[e];y&&typeof y.x=="number"&&typeof y.y=="number"&&s.push({datasetIndex:C,value:Number(D),x:y.x,y:y.y})}}catch(p){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${C}:`,p)}}),s.length===0)return[];const n=Js(s,t),c=[];n.forEach(o=>{const C=o.points||[];C.length>1?C.forEach((p,y)=>{const k=(y-(C.length-1)/2)*4;c.push({datasetIndex:p.datasetIndex,jitterX:k,value:p.value})}):C.length===1&&c.push({datasetIndex:C[0].datasetIndex,jitterX:0,value:C[0].value})});const i=new Set(c.map(o=>o.datasetIndex));return s.forEach(o=>{i.has(o.datasetIndex)||c.push({datasetIndex:o.datasetIndex,jitterX:0,value:o.value})}),c}const Qs=.5,gt=6,en=2;function tn(r){return typeof r!="number"||r<2?gt:gt+(r-1)*en}function an(r,e){if(!r||!r.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!e||typeof e.x!="number"||typeof e.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",e);return}const t=e.count;if(typeof t!="number"||t<2)return;const a=r.ctx,{x:l,y:s,points:n}=e,c=tn(t);if(a.canvas){a.save();try{a.beginPath(),a.arc(l,s,c,0,2*Math.PI);let o="rgba(128, 128, 128, 0.3)";if(n&&n.length>0&&r.data&&r.data.datasets){const C=n[0].datasetIndex,D=r.data.datasets[C];if(D&&D.pointBackgroundColor){const p=Array.isArray(D.pointBackgroundColor)?D.pointBackgroundColor[e.position]||D.pointBackgroundColor[0]:D.pointBackgroundColor;if(p)if(p.startsWith("#")){const y=parseInt(p.slice(1,3),16),k=parseInt(p.slice(3,5),16),I=parseInt(p.slice(5,7),16);o=`rgba(${y}, ${k}, ${I}, 0.4)`}else p.startsWith("rgba")?o=p.replace(/rgba?\(([^)]+)\)/,(y,k)=>{const I=k.split(",").map(w=>w.trim());return`rgba(${I[0]}, ${I[1]}, ${I[2]}, 0.4)`}):o=p+"66"}}a.fillStyle=o,a.fill(),a.strokeStyle=o.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(o){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",o)}finally{a.restore()}}}const sn={id:"overlappingPointsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=qs(r,Qs);if(!Array.isArray(e)||e.length===0)return;e.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{an(r,a)}catch(l){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,l)}})}catch(e){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",e)}}},nn=.5,on={id:"pointJitterPlugin",beforeDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")){r._jitterData||(r._jitterData={});try{const e=r.data?.datasets,t=r.data?.labels||[];if(!e||!Array.isArray(e)||e.length===0||!Array.isArray(t)||t.length===0)return;r._jitterData={},t.forEach((a,l)=>{const s=Zs(r,l,nn);s&&s.length>0&&s.forEach(n=>{const c=`${n.datasetIndex}_${l}`;r._jitterData[c]=n.jitterX})})}catch(e){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",e)}}},afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx&&!(!r._jitterData||Object.keys(r._jitterData).length===0))try{const e=r.ctx,t=r.data?.datasets;if(!t||!Array.isArray(t)||t.length===0)return;t.forEach((a,l)=>{const s=r.getDatasetMeta(l);!s||s.hidden||!a.data||!Array.isArray(a.data)||a.data.forEach((n,c)=>{const i=s.data[c];if(!i||typeof i.x!="number"||typeof i.y!="number"||n==null||isNaN(n))return;const o=`${l}_${c}`,C=r._jitterData[o];if(!(C===void 0||C===0)){e.save();try{const D=a.pointStyle||"circle",p=(a.pointRadius||7)+1,y=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[c]||a.pointBackgroundColor[0]:a.pointBackgroundColor,k=Array.isArray(a.pointBorderColor)?a.pointBorderColor[c]||a.pointBorderColor[0]:a.pointBorderColor,I=a.pointBorderWidth||1,w=i.x+C,b=i.y;switch(e.fillStyle=y||"#007bff",e.strokeStyle=k||"#ffffff",e.lineWidth=I,e.beginPath(),D){case"circle":e.arc(w,b,p,0,2*Math.PI);break;case"triangle":e.moveTo(w,b-p),e.lineTo(w-p,b+p),e.lineTo(w+p,b+p),e.closePath();break;case"rect":case"rectRounded":const M=p*1.4;e.rect(w-M/2,b-M/2,M,M);break;case"rectRot":const L=p*1.4;e.moveTo(w,b-L/2),e.lineTo(w+L/2,b),e.lineTo(w,b+L/2),e.lineTo(w-L/2,b),e.closePath();break;case"star":const K=p;for(let pe=0;pe<5;pe++){const ee=pe*4*Math.PI/5-Math.PI/2,G=w+K*Math.cos(ee),le=b+K*Math.sin(ee);pe===0?e.moveTo(G,le):e.lineTo(G,le)}e.closePath();break;case"cross":const U=p;e.moveTo(w-U,b-U),e.lineTo(w+U,b+U),e.moveTo(w+U,b-U),e.lineTo(w-U,b+U);break;case"crossRot":const q=p;e.moveTo(w-q,b),e.lineTo(w+q,b),e.moveTo(w,b-q),e.lineTo(w,b+q);break;default:e.arc(w,b,p,0,2*Math.PI)}D!=="cross"&&D!=="crossRot"&&e.fill(),e.stroke(),i._originalX||(i._originalX=i.x,i._originalY=i.y),i._jitterX=C,i._jitteredX=w,i._jitteredY=b}catch(D){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${l}_${c}:`,D)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:r=>{r._jitterData}},rn={id:"pointLabelsPlugin",afterDatasetsDraw:r=>{if(!(!r||!r.config||r.config.type!=="line")&&r.ctx)try{const e=r.ctx,t=r.data?.datasets;if(!t||!Array.isArray(t)||t.length===0)return;t.forEach((a,l)=>{const s=r.getDatasetMeta(l);if(!s||s.hidden||!a.data||!Array.isArray(a.data))return;const n=Array.isArray(a.pointBackgroundColor)?a.pointBackgroundColor[0]||"#6b7280":a.pointBackgroundColor||"#6b7280";a.data.forEach((c,i)=>{const o=s.data[i];if(!o||typeof o.x!="number"||typeof o.y!="number"||c==null||isNaN(c))return;const C=o._jitteredX!==void 0?o._jitteredX:o.x,D=o._jitteredY!==void 0?o._jitteredY:o.y,p=C+8,y=D-5,k=String(Math.round(c));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const w=e.measureText(k).width,b=11,M=3,L=p-M,K=y-b/2-M,U=w+M*2,q=b+M*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(L,K,U,q),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(L,K,U,q),e.fillStyle=n,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(k,p,y)}catch(I){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${l}_${i}:`,I)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},ln={class:"graph-state-chart"},cn={class:"chart-header"},un={class:"chart-type-selector"},dn=["onClick","title"],pn={class:"chart-type-icon"},mn={class:"chart-type-label"},gn={key:0,class:"comparison-type-selector"},fn={class:"radio-group"},hn={key:0},vn={key:1},yn={key:2,class:"graph-legend"},kn={key:4,class:"error-container"},bn={class:"error-message"},wn={class:"chart-wrapper"},Sn={class:"chart-canvas-container"},Dn={key:0,class:"bar-chart-stage-labels"},Cn={key:6,class:"no-data"},En={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(r,{emit:e}){const t=(v,f)=>typeof window>"u"?f:getComputedStyle(document.documentElement).getPropertyValue(v).trim()||f,a=r,l=e,s=N(!1),n=N(null),c=N(null),i=N({weekStart:null,weekEnd:null,current:null}),o=N(null),C=N("weekStartToWeekEnd"),D=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],p=N("line"),y=N(!1),k=N(""),I=N(""),w=N(0),b=N([]),M=N(null),L=N(null),K=N(null),U=N(null),q=N([]),pe=Y(()=>{switch(p.value){case"line":return ct;case"bar":return Tt;case"doughnut":return _t;default:return ct}}),ee={formed:t("--b24-primary","#007bff"),review:t("--b24-warning","#ffc107"),execution:t("--b24-success","#28a745")},G=[{id:"formed",name:"Сформировано обращение",color:ee.formed},{id:"review",name:"Рассмотрение ТЗ",color:ee.review},{id:"execution",name:"Исполнение",color:ee.execution}],le=Y(()=>G.reduce((v,f)=>(v[f.id]=f.name,v),{})),Se=["circle","triangle","rect","rectRot","star","cross","crossRot"],De=N({formed:!0,review:!0,execution:!0}),ge=Ve(),Ie={id:"employeeLabelsPlugin",afterDatasetsDraw:v=>{if(v.config.type==="bar")try{const f=v.ctx;if(!v.data||!v.data.datasets)return;const S=v.data.datasets,$=v.scales.y;S.forEach((F,h)=>{const A=v.getDatasetMeta(h);if(!A||A.hidden)return;const R=F.label||"";if(!R||R.includes("Другие"))return;const O=R.trim().split(/\s+/);let j="";if(O.length===1)j=O[0];else{const z=O[0],X=O.slice(1).join(" ");j=`${z}
${X}`}const Z=j.split(`
`);F.data.forEach((z,X)=>{if(z===0||!z)return;const Q=A.data[X];if(!Q||typeof Q.x!="number"||typeof Q.y!="number")return;const J=Q.x,_e=Q.y+Q.height+25;f.save(),f.font="bold 9px Arial, sans-serif",f.fillStyle="#6b7280",f.textAlign="center",f.textBaseline="top",f.translate(J,_e),f.rotate(-12*Math.PI/180),Z.forEach((St,Dt)=>{const lt=St.trim();lt&&f.fillText(lt,0,Dt*11)}),f.restore()})})}catch(f){console.error("Error in employeeLabelsPlugin:",f)}}},Re={id:"doughnutCenterTextPlugin",afterDraw:v=>{if(v.config.type!=="doughnut")return;const{ctx:f,chartArea:S,width:$,height:F}=v;if(!v.data||!v.data.datasets||v.data.datasets.length===0)return;const A=v.data.datasets[0].meta?.totals?.overall??null;if(A===null||typeof A>"u")return;const R=["Всего в секторе 1С","тикетов в работе:",`${A}`];f.save(),f.font='600 16px "Roboto", sans-serif',f.fillStyle=t("--b24-text-primary","#1f2937"),f.textAlign="center",f.textBaseline="middle";const O=(S.left+S.right)/2,j=(S.top+S.bottom)/2,Z=18,z=Z*R.length,X=j-z/2+4;R.forEach((Q,J)=>{J===R.length-1&&`${Q}`.length>4?f.font='700 18px "Roboto", sans-serif':f.font='600 16px "Roboto", sans-serif',f.fillText(Q,O,X+J*Z)}),f.restore()}};Oe.register(Ie),Oe.register(Re);function Ae(){const v=new Map;[i.value.weekStart,i.value.weekEnd,i.value.current].forEach(f=>{!f||!f.statistics||!f.statistics.employees||f.statistics.employees.forEach(S=>{v.has(S.id)||v.set(S.id,{id:S.id,name:S.name})})}),q.value=Array.from(v.values()).sort((f,S)=>f.name.localeCompare(S.name))}function ie(v,f="background"){return{increase:{background:t("--b24-success","#28a745"),border:t("--b24-success-hover","#218838"),point:t("--b24-success","#28a745")},decrease:{background:t("--b24-danger","#dc3545"),border:t("--b24-danger-hover","#c82333"),point:t("--b24-danger","#dc3545")},stable:{background:t("--b24-text-muted","#9ca3af"),border:t("--b24-text-secondary","#6b7280"),point:t("--b24-text-muted","#9ca3af")}}[v]?.[f]||t("--b24-text-secondary","#6c757d")}function fe(){if(!(!i.value.weekStart||!i.value.weekEnd))try{const v=tt.compareTwoSnapshots(i.value.weekStart,i.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let f=null,S=null;i.value.current&&(f=tt.compareTwoSnapshots(i.value.weekEnd,i.value.current,{includeTickets:!1,includeEmployees:!0}),S=tt.compareTwoSnapshots(i.value.weekStart,i.value.current,{includeTickets:!1,includeEmployees:!0})),o.value={weekStartToWeekEnd:v,weekEndToCurrent:f,weekStartToCurrent:S}}catch(v){console.error("Ошибка сравнения слепков:",v),ge.warning("Не удалось выполнить сравнение слепков: "+v.message)}}function Me(v){return v?v.replace(/\s*\(\d+\)\s*$/,"").trim():""}function he(v){const f=Me(v);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[f]||"formed"}function Ne(v){return he(v)}function xe(v){return v===0?"weekStart":v===1?"weekEnd":v===2?"current":"weekEnd"}function Ce(v,f,S,$,F=null,h=null,A=null,R=null){console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:v,stageId:f,totalCount:S,employeesCount:$?.length||0,hasSnapshot:!!h,snapshotTicketIds:h?.ticketIds?.length||0}),k.value=v,I.value=f||"",w.value=S,b.value=$||[],M.value=F&&F.count>0?F:null,L.value=h,K.value=A,U.value=R,y.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:I.value,hasCurrentSnapshot:!!L.value})}async function P(v,f,S){console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:v,timePoint:f,hasMeta:!!S});const $=G.find(h=>h.id===v);if(!$){console.warn("[GraphStateChart] Stage not found:",v);return}const F={graphType:"line",stageId:v,stageName:$.name,timePoint:f,snapshots:i.value,meta:{line:S||null,doughnut:c.value?.datasets?.[0]?.meta||null},stageColorMap:ee,stageNameMap:le.value};try{const h=await wt({stageId:v,graphType:"line",timePoint:f,snapshots:i.value,meta:{line:S||null,doughnut:c.value?.datasets?.[0]?.meta||null},stageColorMap:ee,stageNameMap:le.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:h.stageName,stageId:v,totalCount:h.totalCount,employeesCount:h.employees?.length||0,hasSnapshot:!!h.snapshot}),Ce(h.stageName,v,h.totalCount,h.employees,h.others,h.snapshot,null,F)}catch(h){console.error("[GraphStateChart] Failed to open modal for line point:",h),ge.error("Не удалось открыть попап для выбранной точки графика")}}function H(v,f){if(!f||!f.employees||f.employees.length===0){ge.warning("Нет данных о сотрудниках для этого этапа");return}const S=i.value.current||i.value.weekEnd||i.value.weekStart,$={graphType:"doughnut",stageId:v,stageName:f.stageName,snapshots:i.value,meta:{doughnut:c.value?.datasets?.[0]?.meta||null},stageColorMap:ee,stageNameMap:le.value};Ce(f.stageName,v,f.totalCount,f.employees,f.others,S,null,$)}function ne(){y.value=!1,k.value="",I.value="",w.value=0,b.value=[],M.value=null,L.value=null,K.value=null}async function Fe(v,f,S){if(p.value!=="line"||f.length===0)return;const $=f[0],F=$.datasetIndex,h=$.index,A=S.data.datasets[F];if(!A)return;const R=Ne(A.label),O=xe(h);await P(R,O,A.meta||null)}function oe(v,f,S){if(p.value!=="doughnut"||f.length===0)return;const F=f[0].index,h=S.data,A=h.labels[F],R=Ne(A),j=h.datasets[0]?.meta?.employees?.[R];if(!j){console.warn("Данные о сотрудниках не найдены для этапа:",R);return}H(R,j)}function Pe(v){const f=G[v];if(!f)return 0;const S=i.value.current||i.value.weekEnd||i.value.weekStart;return!S||!S.statistics||!S.statistics.stages?0:S.statistics.stages[f.id]?.count||0}function g(v){const f=G.find(F=>F.id===v);if(!f)return"";const S=i.value.current||i.value.weekEnd||i.value.weekStart;if(!S||!S.statistics||!S.statistics.stages)return f.name;const $=S.statistics.stages[v]?.count||0;return`${f.name} (${$})`}const m=Y(()=>{if(!c.value)return null;if(p.value==="doughnut"||p.value==="bar")return c.value;const v=c.value.datasets.filter(f=>{const S=G.find($=>$.name===f.label);return S?De.value[S.id]:!0});return{...c.value,datasets:v}});Y(()=>p.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const d=Y(()=>{const v={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:p.value==="bar"?{bottom:80}:{}},onClick:(f,S,$)=>{p.value==="line"?Fe(f,S,$):p.value==="doughnut"&&oe(f,S,$)},onHover:(f,S,$)=>{p.value==="doughnut"&&(f.native.target.style.cursor=S.length>0?"pointer":"default")},plugins:{legend:{display:p.value!=="bar",position:p.value==="doughnut"?"right":"top",labels:{font:{size:p.value==="doughnut"?14:12,weight:p.value==="doughnut"?"600":"500"},boxWidth:p.value==="doughnut"?18:12,boxHeight:p.value==="doughnut"?18:12,padding:p.value==="doughnut"?14:10},onClick:(f,S,$)=>{if(p.value==="bar"){const h=S.datasetIndex;if(h!==void 0){const A=$.chart.getDatasetMeta(h);A.hidden=!A.hidden,$.chart.update()}return}const F=S.datasetIndex;if(F!==void 0){const h=$.chart.getDatasetMeta(F);h.hidden=!h.hidden,$.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:f=>{if(p.value==="bar"){const S=f[0].dataIndex,$=G[S];return $?$.name:""}return f[0].label||""},label:f=>{const S=f.dataset.label||"",$=f.parsed.y||f.parsed||0,F=f.dataIndex;if(p.value==="bar"){const h=f.dataset,A=f.dataIndex,R=G[A],O=R?R.name:"";return`${h.label}: ${$} тикетов на этапе "${O}"`}if(p.value==="doughnut"){const h=f.dataset.data.reduce((R,O)=>R+O,0),A=h>0?($/h*100).toFixed(1):0;return`${S}: ${$} тикетов (${A}%)`}else{if(!o.value||F===0)return`${S}: ${$} тикетов`;let h=null;const A=he(S);if(C.value==="weekStartToWeekEnd"&&F===1?h=o.value.weekStartToWeekEnd?.stages?.[A]:C.value==="weekEndToCurrent"&&F===2&&i.value.current?h=o.value.weekEndToCurrent?.stages?.[A]:C.value==="weekStartToCurrent"&&F===2&&i.value.current&&(h=o.value.weekStartToCurrent?.stages?.[A]),!h)return`${S}: ${$} тикетов`;const R=h.delta,O=h.deltaPercent,j=h.trend;let Z=`${S}: ${$} тикетов`;if(R!==0){const z=R>0?"+":"",X=j==="increase"?"↑":j==="decrease"?"↓":"→";Z+=` (${z}${R}, ${z}${O.toFixed(1)}%) ${X}`}else Z+=" (без изменений)";return Z}},afterBody:f=>{if(p.value==="bar"&&f.length>0){const h=f[0];h.dataset;const A=h.parsed.y||0,R=h.dataIndex,O=Pe(R);return[`${O>0?(A/O*100).toFixed(1):0}% от общего количества этапа`]}if(p.value==="doughnut"&&f.length>0)return["Кликните для детализации по сотрудникам"];if(p.value==="line"){const h=[];if(o.value){const A=f[0].dataIndex;if(A!==0){let R=null;if(he(f[0].dataset.label||""),C.value==="weekStartToWeekEnd"&&A===1?R=o.value.weekStartToWeekEnd:C.value==="weekEndToCurrent"&&A===2?R=o.value.weekEndToCurrent:C.value==="weekStartToCurrent"&&A===2&&(R=o.value.weekStartToCurrent),R&&R.metadata){const O=R.metadata.timeDiff;h.push(`Период: ${O.days} дн. ${O.hours} ч. ${O.minutes} мин.`)}}}return h.push("Кликните для детализации по сотрудникам"),h}if(!o.value)return[];const S=f[0].dataIndex;if(S===0)return[];let $=null;if(he(f[0].dataset.label||""),C.value==="weekStartToWeekEnd"&&S===1?$=o.value.weekStartToWeekEnd:C.value==="weekEndToCurrent"&&S===2?$=o.value.weekEndToCurrent:C.value==="weekStartToCurrent"&&S===2&&($=o.value.weekStartToCurrent),!$||!$.metadata)return[];const F=$.metadata.timeDiff;return[`Период: ${F.days} дн. ${F.hours} ч. ${F.minutes} мин.`]}}},title:{display:!1}}};return p.value==="line"||p.value==="bar"?{...v,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:p.value==="doughnut"?{...v,cutout:"60%"}:v});function T(v){const f=new Date(v),S=f.getFullYear(),$=String(f.getMonth()+1).padStart(2,"0"),F=String(f.getDate()).padStart(2,"0");return`${S}-${$}-${F}`}function W(v){const{current:f,weekEnd:S}=v,$=f||S;if(!$||!$.statistics||!$.statistics.stages)return null;const F=[],h=[],A=[],R=[],O={},j={};if(G.forEach(z=>{const X=$.statistics.stages[z.id]?.count||0;if(X>0){F.push(`${z.name} (${X})`),h.push(X),A.push(z.color+"80"),R.push(z.color),j[z.id]=X;const Q=Zt(z.id,$,G);Q&&Q.employees&&(O[z.id]=Q)}}),h.length===0)return null;const Z=h.reduce((z,X)=>z+X,0);return{labels:F,datasets:[{label:"Распределение по этапам",data:h,backgroundColor:A,borderColor:R,borderWidth:2,meta:{employees:O,totals:{overall:Z,stages:j}}}]}}function te(v){if(p.value==="doughnut")return W(v);if(p.value==="bar"){const A=a.showCurrentState&&v.current?"current":v.weekEnd?"weekEnd":"weekStart";return Jt(v,A,G)}const{weekStart:f,weekEnd:S,current:$}=v,F=[],h=[];return G.forEach((A,R)=>{const O=[];if(f&&f.statistics&&f.statistics.stages){const J=f.statistics.stages[A.id];if(F.length===0){const _e=f.metadata?.createdAt?new Date(f.metadata.createdAt):null;F.push(_e?T(_e):"Начало недели")}O.push(J?.count||0)}else F.length===0&&F.push("Начало недели"),O.push(0);if(S&&S.statistics&&S.statistics.stages){const J=S.statistics.stages[A.id];if(F.length===1){const _e=S.metadata?.createdAt?new Date(S.metadata.createdAt):null;F.push(_e?T(_e):"Конец недели")}O.push(J?.count||0)}else F.length===1&&F.push("Конец недели"),O.push(0);if($&&a.showCurrentState&&$.statistics&&$.statistics.stages){const J=$.statistics.stages[A.id];F.length===2&&F.push("Текущее состояние"),O.push(J?.count||0)}const j=["stable"];o.value?C.value==="weekStartToWeekEnd"?(j.push(o.value.weekStartToWeekEnd?.stages?.[A.id]?.trend||"stable"),$&&j.push(o.value.weekStartToCurrent?.stages?.[A.id]?.trend||"stable")):C.value==="weekEndToCurrent"&&$?(j.push("stable"),j.push(o.value.weekEndToCurrent?.stages?.[A.id]?.trend||"stable")):C.value==="weekStartToCurrent"&&$?(j.push(o.value.weekStartToWeekEnd?.stages?.[A.id]?.trend||"stable"),j.push(o.value.weekStartToCurrent?.stages?.[A.id]?.trend||"stable")):(j.push("stable"),$&&j.push("stable")):(j.push("stable"),$&&j.push("stable"));let Z,z,X;o.value&&p.value!=="doughnut"?(Z=j.map(J=>ie(J,"background")+"40"),z=j.map(J=>ie(J,"border")),X=j.map(J=>ie(J,"point"))):(Z=A.color+"40",z=A.color,X=A.color);let Q=null;p.value==="line"&&(Q={employees:qt(A.id,v)}),h.push({label:A.name,data:O,backgroundColor:(Array.isArray(Z),Z),borderColor:(Array.isArray(z),z),borderWidth:2,...p.value==="line"&&{pointStyle:Se[R%Se.length]},pointBackgroundColor:(Array.isArray(X),X),pointBorderColor:(Array.isArray(z),z),pointRadius:7,pointHoverRadius:10,fill:p.value!=="line",tension:p.value==="line"?.4:0,meta:Q})}),F.length===0&&(F.push("Начало недели","Конец недели"),a.showCurrentState&&F.push("Текущее состояние")),{labels:F,datasets:h}}const ae=async()=>{s.value=!0,n.value=null;try{const v=a.period?.endDate?new Date(a.period.endDate):new Date,f=a.period?.startDate?new Date(a.period.startDate):be.getWeekStartDate(v),S=a.period?.endDate?new Date(a.period.endDate):be.getWeekEndDate(v),$=be.formatDate(f),F=be.formatDate(S),[h,A]=await Promise.all([be.getSnapshot($,"week_start"),be.getSnapshot(F,"week_end")]);let R=null;a.showCurrentState&&(R=await nt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),i.value={weekStart:h,weekEnd:A,current:R},Ae(),fe(),x(),l("data-loaded",{weekStart:h,weekEnd:A,current:R})}catch(v){console.error("Error loading chart data:",v),n.value=v.message||"Ошибка загрузки данных графика",ge.error("Ошибка загрузки данных графика: "+n.value),l("error",n.value)}finally{s.value=!1}};ze(()=>{Oe.register(sn),Oe.register(on),Oe.register(rn),ae()});function Ee(v){De.value=v}const x=()=>{const v=te({weekStart:i.value.weekStart,weekEnd:i.value.weekEnd,current:i.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==v?.labels?.length)c.value=v;else if(v){const f=JSON.stringify(c.value),S=JSON.stringify(v);f!==S&&(c.value=v)}};return We(()=>[a.period,a.showCurrentState],()=>{ae()},{deep:!0}),We(p,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&x()}),We(C,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&x()}),(v,f)=>(E(),_("div",ln,[u("div",cn,[f[3]||(f[3]=u("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),u("div",un,[(E(),_(ce,null,ue(D,S=>u("button",{key:S.value,onClick:$=>p.value=S.value,class:re(["chart-type-btn",{active:p.value===S.value}]),title:S.label},[u("span",pn,B(S.icon),1),u("span",mn,B(S.label),1)],10,dn)),64))])]),!s.value&&!n.value&&o.value&&p.value!=="doughnut"?(E(),_("div",gn,[f[7]||(f[7]=u("h4",{class:"comparison-title"},"Тип сравнения:",-1)),u("div",fn,[u("label",null,[qe(u("input",{type:"radio","onUpdate:modelValue":f[0]||(f[0]=S=>C.value=S),value:"weekStartToWeekEnd",onChange:x},null,544),[[Je,C.value]]),f[4]||(f[4]=u("span",null,"Начало недели → Конец недели",-1))]),i.value.current?(E(),_("label",hn,[qe(u("input",{type:"radio","onUpdate:modelValue":f[1]||(f[1]=S=>C.value=S),value:"weekEndToCurrent",onChange:x},null,544),[[Je,C.value]]),f[5]||(f[5]=u("span",null,"Конец недели → Текущее состояние",-1))])):V("",!0),i.value.current?(E(),_("label",vn,[qe(u("input",{type:"radio","onUpdate:modelValue":f[2]||(f[2]=S=>C.value=S),value:"weekStartToCurrent",onChange:x},null,544),[[Je,C.value]]),f[6]||(f[6]=u("span",null,"Начало недели → Текущее состояние",-1))])):V("",!0)])])):V("",!0),!s.value&&!n.value&&c.value?(E(),we(Xt,{key:1,stages:G,selected:De.value,"onUpdate:selected":Ee,onChange:x},null,8,["selected"])):V("",!0),!s.value&&!n.value&&o.value&&p.value!=="doughnut"?(E(),_("div",yn,[...f[8]||(f[8]=[Ct('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):V("",!0),s.value?(E(),we(vt,{key:3,message:"Загрузка данных графика..."})):n.value?(E(),_("div",kn,[u("p",bn,"❌ "+B(n.value),1),u("button",{onClick:ae,class:"btn-retry"},"Повторить загрузку")])):m.value?(E(),_("div",{key:5,class:re(["chart-container",`chart-type-${p.value}`])},[u("div",wn,[u("div",Sn,[(E(),we(Et(pe.value),{data:m.value,options:d.value},null,8,["data","options"]))]),p.value==="bar"?(E(),_("div",Dn,[(E(),_(ce,null,ue(G,S=>u("div",{key:S.id,class:"stage-label-item"},B(g(S.id)),1)),64))])):V("",!0)])],2)):(E(),_("div",Cn,[...f[9]||(f[9]=[u("p",null,"📊 Нет данных для отображения",-1),u("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),de(Gs,{"is-visible":y.value,"stage-name":k.value,"stage-id":I.value,"total-count":w.value,employees:b.value,others:M.value,snapshot:L.value,"ticket-details":K.value,"stage-switch-context":U.value,onClose:ne},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},_n=Ue(En,[["__scopeId","data-v-cbba196a"]]),Tn={key:0,class:"create-snapshot-button-container"},$n=["disabled"],In={class:"modal-content"},An={class:"modal-header"},Mn=["disabled"],Nn={class:"modal-body"},xn={key:0,class:"progress-container"},Fn={class:"progress-bar-wrapper"},Pn={class:"progress-text"},Bn={class:"progress-percent"},Ln={class:"progress-description"},Rn={key:1},Hn={class:"modal-footer"},On=["disabled"],Wn=["disabled"],jn={key:0},zn={key:0},Un={key:1},Vn={key:2},Kn={key:1},Gn={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(r,{emit:e}){const t=r,a=e,l=N(t.user),s=N(!1),n=N(!1),c=N(0),i=N("idle"),o=N(""),C=Ve(),D=Y(()=>l.value?At(l.value):!1);ze(async()=>{if(!t.user)try{const w=await yt.checkAccess();w.allowed&&(l.value=w.user)}catch(w){console.error("Error loading user:",w)}});const p=()=>{if(!D.value){C.warning("Только администраторы могут создавать слепки");return}s.value=!0},y=()=>{n.value||(s.value=!1,i.value="idle",c.value=0,o.value="")},k=async()=>{if(!n.value){if(!D.value){C.warning("Только администраторы могут создавать слепки");return}n.value=!0,i.value="loading_data",c.value=0,o.value="Инициализация загрузки данных...";try{o.value="Загрузка данных сектора из Bitrix24...";const w=await nt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:L=>{const K=Math.min(80,(L.progress||0)*.8);c.value=K,i.value="loading_data",o.value=L.description||L.details?.description||"Загрузка данных сектора..."}});i.value="creating_snapshot",c.value=85,o.value="Создание слепка...";const b=l.value;if(!b)throw new Error("Пользователь не определён");const M=await be.createSnapshot(w,"manual",{createdBy:{id:b.ID,name:`${b.NAME||""} ${b.LAST_NAME||""}`.trim()||b.EMAIL||`User ${b.ID}`},sectorId:"1C"});i.value="success",c.value=100,o.value="Слепок успешно создан!",C.success("Слепок состояния сектора успешно создан"),a("snapshot-created",M),setTimeout(()=>{y()},1500)}catch(w){i.value="error",c.value=0,o.value="Ошибка создания слепка",console.error("Error creating snapshot:",w);let b="Ошибка создания слепка";w.message&&(w.message.includes("загрузки данных")||w.message.includes("sector data")?b="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":w.message.includes("создания слепка")||w.message.includes("snapshot")?b="Не удалось создать слепок. Обратитесь в поддержку.":w.message.includes("валидац")||w.message.includes("validation")?b="Ошибка валидации данных. Проверьте данные сектора.":b=w.message),C.error(b)}finally{n.value=!1}}},I=w=>{w.key==="Escape"&&s.value&&!n.value&&y()};return ze(()=>{window.addEventListener("keydown",I)}),ht(()=>{window.removeEventListener("keydown",I)}),(w,b)=>D.value?(E(),_("div",Tn,[u("button",{class:"create-snapshot-btn",onClick:p,disabled:n.value,title:"Создать слепок состояния сектора"},[...b[1]||(b[1]=[u("span",{class:"btn-icon"},"📸",-1),u("span",{class:"btn-text"},"Создать слепок",-1)])],8,$n),(E(),we(ft,{to:"body"},[de(st,{name:"modal"},{default:$e(()=>[s.value?(E(),_("div",{key:0,class:"modal-overlay",onClick:b[0]||(b[0]=se(M=>!n.value&&y(),["self"]))},[u("div",In,[u("div",An,[b[2]||(b[2]=u("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),u("button",{class:"modal-close",onClick:y,disabled:n.value,"aria-label":"Закрыть"}," ✕ ",8,Mn)]),u("div",Nn,[i.value!=="idle"?(E(),_("div",xn,[u("div",Fn,[u("div",{class:"progress-bar",style:me({width:`${c.value}%`})},null,4)]),u("div",Pn,[u("span",Bn,B(Math.round(c.value))+"%",1),u("span",Ln,B(o.value),1)])])):(E(),_("div",Rn,[...b[3]||(b[3]=[u("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),u("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),u("div",Hn,[u("button",{class:"btn btn-secondary",onClick:y,disabled:n.value}," Отмена ",8,On),u("button",{class:"btn btn-primary",onClick:k,disabled:n.value},[n.value?(E(),_("span",jn,[i.value==="loading_data"?(E(),_("span",zn,"Загрузка данных...")):i.value==="creating_snapshot"?(E(),_("span",Un,"Создание...")):(E(),_("span",Vn,"Обработка..."))])):(E(),_("span",Kn,"Создать"))],8,Wn)])])])):V("",!0)]),_:1})]))])):V("",!0)}},Xn=Ue(Gn,[["__scopeId","data-v-09bccee2"]]);function Yn(){const r=N(!1),e=N(null),t=N(null),a=N(0),l=Ve(),s=async(w=!0,b=null)=>{r.value=!0,e.value=null,a.value=0;try{const M=await nt.getSectorDataForSnapshot({useCache:w,onProgress:L=>{L&&typeof L.progress=="number"&&(a.value=L.progress),b&&b(L)},normalize:!0});return t.value=M,M}catch(M){throw e.value=M.message||"Ошибка загрузки данных сектора",l.error("Ошибка загрузки данных сектора: "+e.value),M}finally{r.value=!1,a.value=100}},n=async(w,b={})=>{if(!t.value){const M="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw e.value=M,l.error(M),new Error(M)}r.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(w))throw new Error(`Неверный тип слепка: ${w}. Допустимые значения: week_start, week_end, manual, current`);const M=await be.createSnapshot(t.value,w,b);return l.success("Слепок успешно создан"),M}catch(M){throw e.value=M.message||"Ошибка создания слепка",l.error("Ошибка создания слепка: "+e.value),M}finally{r.value=!1}},c=()=>{r.value=!1,e.value=null,t.value=null,a.value=0},i=Y(()=>t.value!==null&&t.value!==void 0),o=N({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),C=Y(()=>{const w=new Date;let b,M;switch(o.value.dateRange){case"last-week":b=new Date(w),b.setDate(w.getDate()-7),M=w;break;case"last-2-weeks":b=new Date(w),b.setDate(w.getDate()-14),M=w;break;case"last-month":b=new Date(w),b.setMonth(w.getMonth()-1),M=w;break;case"custom":b=o.value.customDateRange.startDate?new Date(o.value.customDateRange.startDate):null,M=o.value.customDateRange.endDate?new Date(o.value.customDateRange.endDate):null;break;default:b=new Date(w),b.setDate(w.getDate()-7),M=w}return{startDate:b?b.toISOString().split("T")[0]:null,endDate:M?M.toISOString().split("T")[0]:null}}),D=()=>{y()},p=()=>{o.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},y()},y=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(o.value))}catch(w){console.error("Ошибка сохранения фильтров в localStorage:",w)}},k=()=>{try{const w=localStorage.getItem("graphStateFilters");if(w){const b=JSON.parse(w);b&&typeof b=="object"&&(o.value={stages:b.stages||{formed:!0,review:!0,execution:!0},employees:b.employees||["all"],dateRange:b.dateRange||"last-week",customDateRange:b.customDateRange||{startDate:null,endDate:null}})}}catch(w){console.error("Ошибка загрузки фильтров из localStorage:",w)}},I=Y(()=>{const w=Object.values(o.value.stages).some(L=>!L),b=!o.value.employees.includes("all"),M=o.value.dateRange!=="last-week";return w||b||M});return{isLoading:r,error:e,currentSectorData:t,loadingProgress:a,hasSectorData:i,filters:o,selectedPeriod:C,hasActiveFilters:I,loadSectorDataForSnapshot:s,createSnapshot:n,resetState:c,applyFilters:D,resetFilters:p,saveFiltersToLocalStorage:y,loadFiltersFromLocalStorage:k}}const qn={class:"graph-state-dashboard"},Jn={key:1,class:"error-message-container"},Zn={class:"error-message"},Qn={class:"error-text"},eo={key:0,class:"error-details"},to={class:"dashboard-header"},ao={class:"header-content"},so={class:"breadcrumbs-row"},no=["aria-disabled","data-fallback","disabled"],oo={class:"breadcrumbs","aria-label":"Навигация"},ro={class:"header-actions"},lo=["disabled"],io={key:0},co={key:1},uo={key:3,class:"dashboard-content"},po={class:"chart-container"},mo="Назад",go={__name:"GraphStateDashboard",setup(r){const e=(P,H)=>typeof window>"u"?H:getComputedStyle(document.documentElement).getPropertyValue(P).trim()||H,t=Ve(),a=$t(),l={name:"dashboard-sector-1c"},{filters:s,selectedPeriod:n,hasActiveFilters:c,applyFilters:i,resetFilters:o,loadFiltersFromLocalStorage:C}=Yn(),D=N(null),p=N(!0),y=N(!1),k=N("Загрузка данных..."),I=N(null),w=N(!1),b=N(!1),M=N(typeof window<"u"?window.innerWidth:1024),L=N(null),K=N(!1),U=Y(()=>M.value<768);Y(()=>M.value>=768&&M.value<1024),Y(()=>M.value>=1024);const q=Y(()=>typeof window>"u"?!1:window.history.length>1);Y(()=>{const P=new Date;return P.setFullYear(P.getFullYear()-1),P.toISOString().split("T")[0]}),Y(()=>new Date().toISOString().split("T")[0]);function pe(P){s.value.stages=P}function ee(P){s.value.employees=P}function G(P){s.value.dateRange=P}function le(P){s.value.customDateRange=P}function Se(){i()}function De(){o(),L.value=null,Se(),t.info("Фильтры сброшены")}function ge(P){t.success("Слепок успешно создан")}function Ie(P){y.value=!1,k.value="",console.log("Данные графика загружены:",P)}function Re(P){y.value=!1,Ae({message:P||"Ошибка загрузки графика",details:null,type:"error"})}function Ae(P){I.value={message:P.message||"Произошла ошибка",details:P.details||null,type:P.type||"error",timestamp:new Date},console.error("Dashboard error:",I.value),t.error(I.value.message)}function ie(){I.value=null}function fe(){I.value=null,y.value=!0,k.value="Повторная загрузка данных..."}async function Me(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}w.value=!0;try{const P=document.querySelector(".chart-container");if(!P)throw new Error("График не найден");const H=window.html2canvas,ne=await H(P,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),Fe=window.jsPDF,oe=new Fe("landscape","mm","a4"),Pe=297,g=ne.height*Pe/ne.width;oe.setFontSize(18),oe.text("График состояния сектора 1С",148.5,15,{align:"center"});const m=new Date().toLocaleDateString("ru-RU");oe.setFontSize(10);const d=n.value.startDate&&n.value.endDate?`Период: ${n.value.startDate} - ${n.value.endDate}`:"Период: не указан";oe.text(d,148.5,25,{align:"center"}),oe.text(`Экспорт от ${m}`,148.5,30,{align:"center"}),oe.addImage(ne.toDataURL("image/png"),"PNG",10,35,Pe-20,g-20),oe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${m}`,author:"Bitrix24 Dashboard"});const T=`graph-state-${m.replace(/\//g,"-")}.pdf`;oe.save(T),t.success("График успешно экспортирован в PDF")}catch(P){console.error("Ошибка экспорта в PDF:",P),Ae({message:"Ошибка экспорта в PDF: "+(P.message||"Неизвестная ошибка"),details:P.stack,type:"error"})}finally{w.value=!1}}function he(P){if(P?.preventDefault?.(),!K.value){K.value=!0;try{if(q.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(l)}finally{K.value=!1}}}function Ne(){a.push("/")}function xe(){typeof window<"u"&&(M.value=window.innerWidth)}async function Ce(){try{const P=await yt.checkAccess();P.allowed&&(D.value=P.user)}catch(P){console.error("Error loading user:",P)}}return ze(()=>{C(),Ce(),typeof window<"u"&&(M.value=window.innerWidth,window.addEventListener("resize",xe))}),ht(()=>{typeof window<"u"&&window.removeEventListener("resize",xe)}),(P,H)=>{const ne=It("router-link");return E(),_("div",qn,[y.value?(E(),we(vt,{key:0,message:k.value},null,8,["message"])):V("",!0),I.value?(E(),_("div",Jn,[u("div",Zn,[u("div",{class:"error-header"},[H[1]||(H[1]=u("span",{class:"error-icon"},"❌",-1)),H[2]||(H[2]=u("h3",null,"Ошибка",-1)),u("button",{onClick:ie,class:"error-close","aria-label":"Закрыть"},"✕")]),u("p",Qn,B(I.value.message),1),I.value.details?(E(),_("div",eo,[u("details",null,[H[3]||(H[3]=u("summary",null,"Детали ошибки",-1)),u("pre",null,B(I.value.details),1)])])):V("",!0),u("div",{class:"error-actions"},[u("button",{onClick:fe,class:"btn-retry"},"Повторить попытку")])])])):V("",!0),u("div",to,[u("div",ao,[u("div",so,[u("button",{class:"btn-home-link",type:"button",onClick:Ne,title:"Перейти на главную страницу","aria-label":"Перейти на главную страницу"}," Главная "),H[9]||(H[9]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),u("button",{class:"btn-back-link",type:"button",onClick:he,"aria-label":mo,"aria-disabled":!q.value,"data-fallback":!q.value,disabled:K.value,title:"Назад"}," ← ",8,no),u("nav",oo,[de(ne,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:$e(()=>[...H[4]||(H[4]=[at(" Дашборд сектора 1С ",-1)])]),_:1}),H[6]||(H[6]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),H[7]||(H[7]=u("span",{class:"breadcrumb-current"},"График состояния",-1)),H[8]||(H[8]=u("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),de(ne,{to:{name:"dashboard-graph-admission-closure"},class:"breadcrumb-link"},{default:$e(()=>[...H[5]||(H[5]=[at(" График приёма и закрытий ",-1)])]),_:1})])]),H[10]||(H[10]=u("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),H[11]||(H[11]=u("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),u("div",ro,[u("button",{onClick:Me,class:"btn-export-pdf",disabled:w.value||y.value,title:"Экспортировать график в PDF"},[w.value?(E(),_("span",co,"⏳ Экспорт...")):(E(),_("span",io,"📄 Экспорт в PDF"))],8,lo),de(Xn,{user:D.value,onSnapshotCreated:ge},null,8,["user"])])]),U.value?(E(),_("button",{key:2,class:"mobile-filters-toggle",onClick:H[0]||(H[0]=Fe=>b.value=!b.value)},[H[12]||(H[12]=u("span",null,"Фильтры",-1)),u("span",{class:re(["toggle-icon",{open:b.value}])},"▼",2)])):V("",!0),u("div",{class:re({"mobile-open":b.value&&U.value,"mobile-closed":!b.value&&U.value})},[de(Bt,{stages:Be(s).stages,employees:Be(s).employees,dateRange:Be(s).dateRange,customDateRange:Be(s).customDateRange,hasActiveFilters:Be(c),"onUpdate:stages":pe,"onUpdate:employees":ee,"onUpdate:dateRange":G,"onUpdate:customDateRange":le,onReset:De,onApply:Se},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!y.value&&!I.value?(E(),_("div",uo,[u("div",po,[de(_n,{period:Be(n),"show-current-state":p.value,onDataLoaded:Ie,onError:Re},null,8,["period","show-current-state"])])])):V("",!0)])}}},Do=Ue(go,[["__scopeId","data-v-831b0079"]]);export{Do as default};
