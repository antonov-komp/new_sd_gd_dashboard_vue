import{_ as et,a as I,o as T,b as d,F as ge,e as me,n as ie,l as ye,t as B,g as L,c as ae,I as Je,m as Qe,f as Te,d as q,j as ve,k as We,J as Xe,i as oe,y as Bt,B as pt,T as It,K as Ot,u as tt,M as Fe,N as qe,p as rt,O as lt,x as qt,G as Jt,L as jt,C as Wt,P as Ut,D as Zt,Q as Oe,z as Qt,r as ea}from"./main-CTjTZ23-.js";import{L as Nt,D as ta,B as aa}from"./index-GJWqhde8.js";import{K as sa,D as Mt,m as $t,b as Ue,d as na,e as oa}from"./index-CvE_40pm.js";import{S as it,d as ct,B as Ft,e as le,f as Ht,h as zt,a as ra,T as Lt,c as la}from"./priority-config-boaGNfvN.js";import{F as ia}from"./FiltersPanel-BVPnoR6N.js";const De={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class _e{static getApiBaseUrl(){const t=window.location.pathname;return t.substring(0,t.lastIndexOf("/"))}static async createSnapshot(t,e,a={}){try{if(!t||typeof t!="object")throw new He("sectorData должен быть объектом","VALIDATION_ERROR");if(!e||!["week_start","week_end","manual","current"].includes(e))throw new He("type должен быть одним из: week_start, week_end, manual, current","VALIDATION_ERROR");const n=this.validateSectorData(t);if(!n.isValid)throw new He(`Ошибка валидации данных сектора: ${n.errors.join(", ")}`,"VALIDATION_ERROR",{validation:n});const o=this.normalizeSectorData(t),c={metadata:this.generateSnapshotMetadata(e,a.createdBy,a.sectorId||De.defaultSectorId),statistics:o.statistics,ticketIds:o.ticketIds,tickets:o.tickets},i=this.validateSnapshot(c);if(!i.isValid)throw new He(`Ошибка валидации слепка: ${i.errors.join(", ")}`,"VALIDATION_ERROR",{validation:i});i.warnings.length>0&&console.warn("Предупреждения при валидации слепка:",i.warnings);const l=this.getApiBaseUrl(),f=await fetch(`${l}${De.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:e,date:this.formatDate(new Date)})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const m=await f.json();if(!m.success)throw new Error(m.message||"Ошибка создания слепка");return m.data.snapshot}catch(n){throw console.error("SnapshotService.createSnapshot error:",n),n instanceof He?n:new He(`Ошибка создания слепка: ${n.message}`,"API_ERROR",{originalError:n})}}static async getSnapshot(t,e){try{const a=this.formatDate(t),o=`${this.getApiBaseUrl()}${De.snapshotsEndpoint}?action=get&date=${a}&type=${e}`,r=await fetch(o,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(r.status===404)return null;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const c=await r.json();if(!c.success){if(c.message&&c.message.includes("не найден"))return null;throw new Error(c.message||"Ошибка получения слепка")}return c.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(t={}){try{const e=new URLSearchParams;e.append("action","list"),t.startDate&&e.append("startDate",this.formatDate(t.startDate)),t.endDate&&e.append("endDate",this.formatDate(t.endDate)),t.type&&e.append("type",t.type),t.sectorId?e.append("sectorId",t.sectorId):e.append("sectorId",De.defaultSectorId);const n=`${this.getApiBaseUrl()}${De.snapshotsEndpoint}?${e.toString()}`,o=await fetch(n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=await o.json();if(!r.success)throw new Error(r.message||"Ошибка получения списка слепков");return(await Promise.all(r.data.snapshots.map(async i=>{try{return await this.getSnapshot(i.date,i.type)}catch(l){return console.warn(`Ошибка загрузки слепка ${i.date}/${i.type}:`,l),null}}))).filter(i=>i!==null).sort((i,l)=>new Date(i.metadata.createdAt)-new Date(l.metadata.createdAt))}catch(e){throw console.error("SnapshotService.getAllSnapshots error:",e),e}}static normalizeSectorData(t){const{stages:e=[],employees:a=[],zeroPointTickets:n={}}=t,o={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"Сформировано обращение"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"Рассмотрение ТЗ"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"Исполнение"}},r=[],c=[],i=[];e.forEach(m=>{const u=m.id;if(o[u]){let k=0;m.employees.forEach(w=>{const _=w.tickets||[];k+=_.length;let D=r.find(S=>S.id===w.id);D||(D={id:w.id,name:w.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},r.push(D)),_.forEach(S=>{c.push(S.id),i.push({id:S.id,title:S.title||"Без названия",assignedTo:{id:w.id,name:w.name},createdAt:S.createdAt||"",updatedAt:S.modifiedAt||S.updatedAt||""}),D.ticketsByStage[u]=(D.ticketsByStage[u]||0)+1,D.totalTickets+=1})}),o[u].count=k}});const l={unassigned:0,keeper:0,total:0};Object.values(n).forEach(m=>{Array.isArray(m)&&m.forEach(u=>{l.total+=1,u.assigneeId===1051||u.assignedById===1051?l.keeper+=1:l.unassigned+=1,c.push(u.id),i.push({id:u.id,title:u.title||"Без названия",assignedTo:u.assignedTo||u.assignedById?{id:u.assignedById||u.assigneeId,name:"Неизвестный"}:null,createdAt:u.createdAt||"",updatedAt:u.modifiedAt||u.updatedAt||""})})});const f=Object.values(o).reduce((m,u)=>m+u.count,0)+l.total;return{statistics:{stages:{...o,total:f},employees:r,zeroPoint:l},ticketIds:[...new Set(c)],tickets:i}}static generateSnapshotMetadata(t,e,a){const n=new Date,o=-n.getTimezoneOffset(),r=Math.floor(o/60),c=o%60,i=`${r>=0?"+":""}${String(r).padStart(2,"0")}:${String(c).padStart(2,"0")}`,l=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}${i}`;return{version:De.snapshotVersion,createdAt:l,createdBy:e||{id:0,name:"Система"},type:t,sectorId:a,sectorName:a==="1C"?"Сектор 1С":`Сектор ${a}`}}static formatDate(t){if(t||(t=new Date),typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;t=new Date(t)}if(!(t instanceof Date)||isNaN(t.getTime()))throw new Error("Некорректная дата");const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${n}`}static buildFilePath(t,e){const a=typeof t=="string"?new Date(t):t,n=a.getFullYear(),o=this.getWeekNumber(a),r=this.formatDate(t);let c;if(e==="current"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`current-state-${r}-${l}.json`}else if(e==="manual"){const i=new Date,l=`${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}`;c=`manual-${r}-${l}.json`}else c=`${e}-${r}.json`;return e==="current"?`current/${c}`:`${n}/week-${o}/${c}`}static getWeekNumber(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-n)/864e5+1)/7)}static validateSnapshot(t){var n,o,r;const e=[],a=[];if(t.metadata?((!t.metadata.version||typeof t.metadata.version!="string")&&e.push("Неверная версия формата данных"),(!t.metadata.createdAt||!this.isValidISODate(t.metadata.createdAt))&&e.push("Неверная дата создания"),["week_start","week_end","manual","current"].includes(t.metadata.type)||e.push("Неверный тип слепка"),(!t.metadata.sectorId||typeof t.metadata.sectorId!="string")&&e.push("Неверный идентификатор сектора"),(!t.metadata.createdBy||!t.metadata.createdBy.id||!t.metadata.createdBy.name)&&e.push("Неверная информация о создателе")):e.push("Отсутствуют метаданные слепка"),!t.statistics)e.push("Отсутствует статистика");else{if(!t.statistics.stages)e.push("Отсутствует статистика по этапам");else{const c=t.statistics.stages,i=(((n=c.formed)==null?void 0:n.count)||0)+(((o=c.review)==null?void 0:o.count)||0)+(((r=c.execution)==null?void 0:r.count)||0);c.total!==i&&a.push(`Несоответствие общего количества тикетов: ожидается ${i}, указано ${c.total}`)}if(Array.isArray(t.statistics.employees)||e.push("Статистика по сотрудникам должна быть массивом"),!t.statistics.zeroPoint)e.push("Отсутствует статистика нулевой точки");else{const c=t.statistics.zeroPoint,i=(c.unassigned||0)+(c.keeper||0);c.total!==i&&a.push(`Несоответствие статистики нулевой точки: ожидается ${i}, указано ${c.total}`)}}if(Array.isArray(t.ticketIds)||e.push("ticketIds должен быть массивом"),!Array.isArray(t.tickets))e.push("tickets должен быть массивом");else{const c=new Set(t.ticketIds),i=new Set(t.tickets.map(l=>l.id));c.size!==i.size&&a.push("Количество ID в ticketIds не совпадает с количеством тикетов"),t.tickets.forEach((l,f)=>{l.id||e.push(`Тикет #${f}: отсутствует ID`),l.title||e.push(`Тикет #${f}: отсутствует заголовок`),(!l.assignedTo||!l.assignedTo.id)&&a.push(`Тикет #${f}: отсутствует ответственный (может быть в нулевой точке)`),l.createdAt||e.push(`Тикет #${f}: отсутствует дата создания`),l.updatedAt||e.push(`Тикет #${f}: отсутствует дата обновления`)})}return{isValid:e.length===0,errors:e,warnings:a}}static validateSectorData(t){const e=[],a=[];return!t||typeof t!="object"?(e.push("sectorData должен быть объектом"),{isValid:!1,errors:e,warnings:a}):(Array.isArray(t.stages)||e.push("stages должен быть массивом"),Array.isArray(t.employees)||e.push("employees должен быть массивом"),(!t.zeroPointTickets||typeof t.zeroPointTickets!="object")&&e.push("zeroPointTickets должен быть объектом"),{isValid:e.length===0,errors:e,warnings:a})}static isValidISODate(t){if(typeof t!="string")return!1;const e=new Date(t);return!isNaN(e.getTime())&&t.includes("T")}static async deleteSnapshot(t,e){try{const a=this.formatDate(t),o=`${this.getApiBaseUrl()}${De.snapshotsEndpoint}`,r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:e})});if(r.status===404)return!1;if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const c=await r.json();if(!c.success)throw new Error(c.message||"Ошибка удаления слепка");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(t){try{const e=await this.getAllSnapshots(t);let a=0;for(const n of e)try{await this.deleteSnapshot(n.metadata.createdAt.split("T")[0],n.metadata.type)&&a++}catch(o){console.warn(`Ошибка удаления слепка ${n.metadata.createdAt}:`,o)}return a}catch(e){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",e),e}}static getSnapshotVersion(t){var e;return((e=t==null?void 0:t.metadata)==null?void 0:e.version)||"unknown"}static async migrateSnapshot(t,e=De.snapshotVersion){const a=this.getSnapshotVersion(t);return a===e||a==="1.0"&&e==="1.0"?t:(console.warn(`Миграция с версии ${a} на ${e} пока не реализована`),{...t,metadata:{...t.metadata,version:e}})}static getWeekNumberInfo(t){const e=typeof t=="string"?new Date(t):t,a=this.getWeekNumber(e);return{year:e.getFullYear(),week:a}}static getWeekStartDate(t){const e=typeof t=="string"?new Date(t):t,n=(e.getDay()||7)-1,o=new Date(e);return o.setDate(e.getDate()-n),o.setHours(0,0,0,0),o}static getWeekEndDate(t){const e=typeof t=="string"?new Date(t):t,n=7-(e.getDay()||7),o=new Date(e);return o.setDate(e.getDate()+n),o.setHours(23,59,59,999),o}static async getSnapshotsForWeek(t){try{const e=this.getWeekStartDate(t),a=this.getWeekEndDate(t),n=this.getWeekNumberInfo(t),o=await this.getAllSnapshots({startDate:e,endDate:a}),r=o.find(l=>l.metadata.type==="week_start")||null,c=o.find(l=>l.metadata.type==="week_end")||null,i=o.filter(l=>l.metadata.type==="manual");return{weekStart:r,weekEnd:c,manual:i,weekInfo:n}}catch(e){throw console.error("SnapshotService.getSnapshotsForWeek error:",e),e}}static handleError(t){if(t instanceof He)return{message:t.message,code:t.code,details:t.details};let e="UNKNOWN_ERROR";return t.message.includes("валидац")?e="VALIDATION_ERROR":t.message.includes("404")||t.message.includes("не найден")?e="NOT_FOUND":t.message.includes("HTTP")||t.message.includes("API")?e="API_ERROR":t.message.includes("версия")||t.message.includes("version")?e="VERSION_MISMATCH":(t.message.includes("доступ")||t.message.includes("permission"))&&(e="PERMISSION_DENIED"),{message:t.message||"Неизвестная ошибка",code:e,details:{originalError:t}}}static async getSnapshotsStatistics(t={}){try{const e=await this.getAllSnapshots(t),a={week_start:0,week_end:0,manual:0,current:0},n=new Map;let o=null,r=null;e.forEach(i=>{const l=i.metadata.type;a.hasOwnProperty(l)&&a[l]++;const f=this.getWeekNumberInfo(i.metadata.createdAt),m=`${f.year}-W${f.week}`;n.set(m,(n.get(m)||0)+1);const u=new Date(i.metadata.createdAt);(!o||u<new Date(o.metadata.createdAt))&&(o=i),(!r||u>new Date(r.metadata.createdAt))&&(r=i)});const c=Array.from(n.entries()).map(([i,l])=>{const[f,m]=i.split("-W");return{year:parseInt(f),week:parseInt(m),count:l}}).sort((i,l)=>i.year!==l.year?i.year-l.year:i.week-l.week);return{total:e.length,byType:a,byWeek:c,oldest:o,newest:r}}catch(e){throw console.error("SnapshotService.getSnapshotsStatistics error:",e),e}}}class He extends Error{constructor(t,e,a={}){super(t),this.name="SnapshotError",this.code=e,this.details=a}}const Ce={formed:{bitrixId:ct.formed,name:it.FORMED.name},review:{bitrixId:ct.review,name:it.REVIEW.name},execution:{bitrixId:ct.execution,name:it.EXECUTION.name}},Ze=sa;function ca(s){if(!s||typeof s!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!s.stages||!Array.isArray(s.stages))throw new Error("Invalid sector data: stages are required and must be an array");const t=ua(s.stages),e=da(s.stages),a=pa(s.zeroPointTickets||{}),n=ga(s.zeroPointTickets||{}),o=ma(s.stages,s.zeroPointTickets||{});return{statistics:{stages:t,employees:e,zeroPoint:a,zeroPointByStage:n},ticketIds:o.ticketIds,tickets:o.tickets}}function ua(s){const t={formed:{count:0,stageId:Ce.formed.bitrixId,stageName:Ce.formed.name},review:{count:0,stageId:Ce.review.bitrixId,stageName:Ce.review.name},execution:{count:0,stageId:Ce.execution.bitrixId,stageName:Ce.execution.name},total:0};return s.forEach(e=>{if(!Ce[e.id]){console.warn(`Unknown stage ID: ${e.id}`);return}let a=0;e.employees&&Array.isArray(e.employees)&&e.employees.forEach(n=>{n.tickets&&Array.isArray(n.tickets)&&(a+=n.tickets.length)}),t[e.id].count=a,t.total+=a}),t}function da(s){const t=new Map;return s.forEach(e=>{!e.employees||!Array.isArray(e.employees)||e.employees.forEach(a=>{if(!a||!a.id)return;t.has(a.id)||t.set(a.id,{id:a.id,name:a.name||`Сотрудник #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const n=t.get(a.id),o=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;Ce[e.id]&&(n.ticketsByStage[e.id]=(n.ticketsByStage[e.id]||0)+o),n.totalTickets+=o})}),Array.from(t.values())}function pa(s){let t=0,e=0;return!s||typeof s!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(s).forEach(a=>{Array.isArray(a)&&a.forEach(n=>{if(!n)return;const o=n.assignedTo||n.assignedById;!o||o===null?t++:(typeof o=="object"?o.id:o)===Ze?e++:t++})}),{unassigned:t,keeper:e,total:t+e})}function ga(s){const t={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!s||typeof s!="object"||Object.keys(t).forEach(e=>{const a=s[e];Array.isArray(a)&&a.forEach(n=>{if(!n)return;const o=n.assignedTo||n.assignedById;!o||o===null?t[e].unassigned++:(typeof o=="object"?o.id:o)===Ze?t[e].keeper++:t[e].unassigned++,t[e].total++})}),t}function ma(s,t){const e=new Set,a=new Map;return Array.isArray(s)&&s.forEach(n=>{!n.employees||!Array.isArray(n.employees)||n.employees.forEach(o=>{!o.tickets||!Array.isArray(o.tickets)||o.tickets.forEach(r=>{if(!r||!r.id){console.warn("Ticket without ID found:",r);return}const c=parseInt(r.id);if(isNaN(c)){console.warn("Invalid ticket ID:",r.id);return}e.add(c);let i=r.assignedTo;!i&&o.id&&(i={id:o.id,name:o.name||`Сотрудник #${o.id}`}),a.set(c,{id:c,title:r.title||"Без названия",assignedTo:i||null,createdAt:st(r.createdAt||r.createdTime),updatedAt:st(r.updatedAt||r.modifiedAt||r.updatedTime),stageId:r.stageId||n.id||null,departmentHead:r.departmentHead||null,departmentHeadFull:r.departmentHeadFull||r.departmentHead||null,priorityId:r.priorityId||null,priorityLabel:r.priorityLabel||null,service:r.service||null,serviceLabel:r.serviceLabel||null})})})}),t&&typeof t=="object"&&Object.values(t).forEach(n=>{Array.isArray(n)&&n.forEach(o=>{if(!o||!o.id){console.warn("Ticket without ID found in zero point:",o);return}const r=parseInt(o.id);if(isNaN(r)){console.warn("Invalid ticket ID in zero point:",o.id);return}e.add(r);let c=o.assignedTo;if(!c&&o.assignedById){const i=typeof o.assignedById=="object"?o.assignedById.id||o.assignedById.value:o.assignedById;i&&i!==Ze?c={id:i,name:"Неизвестный"}:i===Ze&&(c={id:Ze,name:"Хранитель объектов"})}a.set(r,{id:r,title:o.title||"Без названия",assignedTo:c||null,createdAt:st(o.createdAt||o.createdTime),updatedAt:st(o.updatedAt||o.modifiedAt||o.updatedTime),stageId:o.stageId||null,departmentHead:o.departmentHead||null,departmentHeadFull:o.departmentHeadFull||o.departmentHead||null,priorityId:o.priorityId||null,priorityLabel:o.priorityLabel||null,service:o.service||null,serviceLabel:o.serviceLabel||null})})}),{ticketIds:Array.from(e).sort((n,o)=>n-o),tickets:Array.from(a.values())}}function st(s){if(!s)return null;if(s instanceof Date)return s.toISOString();if(typeof s=="string"){if(s.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return s;const t=new Date(s);if(!isNaN(t.getTime()))return t.toISOString()}return console.warn("Invalid date format:",s),null}class gt{static async getSectorDataForSnapshot(t={}){const{useCache:e=!0,onProgress:a=null,normalize:n=!0,includeTicketDetails:o=!1}=t;try{const r=await Mt.getSectorData(e,a);return n?ca(r):(o&&console.warn("includeTicketDetails пока не реализовано"),r)}catch(r){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",r),r}}static async isDataAvailable(){try{const t=await Mt.getSectorData(!0);return t!=null}catch{return!1}}}class ut{static compareTwoSnapshots(t,e,a={}){const{includeTickets:n=!1,includeEmployees:o=!0}=a,r=this.validateSnapshot(t),c=this.validateSnapshot(e);if(!r.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...r.errors,...c.errors].join(", "));const i=this.buildComparisonMetadata(t,e),l=this.compareStages(t.statistics.stages,e.statistics.stages),f=o?this.compareEmployees(t.statistics.employees||[],e.statistics.employees||[]):[],m=this.compareZeroPoint(t.statistics.zeroPoint||{},e.statistics.zeroPoint||{}),u=n?this.compareTickets(t.ticketIds||[],e.ticketIds||[],t.tickets||[],e.tickets||[]):null,k=this.buildSummary(l,f,m,u);return{metadata:i,stages:l,employees:f,zeroPoint:m,tickets:u,summary:k}}static calculateDelta(t,e){const a=this.normalizeValue(t),n=this.normalizeValue(e),o=n-a;let r=0;a!==0?r=o/a*100:n!==0&&(r=n>0?1/0:-1/0);const c=this.getTrend(o);return{value1:a,value2:n,delta:o,deltaPercent:Math.round(r*100)/100,trend:c}}static normalizeValue(t){return t==null||isNaN(t)?0:Number(t)}static getTrend(t){return t>0?"increase":t<0?"decrease":"stable"}static compareStages(t,e){var c,i;const a=["formed","review","execution"],n={};for(const l of a){const f=((c=t[l])==null?void 0:c.count)||0,m=((i=e[l])==null?void 0:i.count)||0;n[l]=this.calculateDelta(f,m)}const o=t.total||0,r=e.total||0;return n.total=this.calculateDelta(o,r),n}static compareEmployees(t,e){var c,i;const a=new Map(t.map(l=>[l.id,l])),n=new Map(e.map(l=>[l.id,l])),o=new Set([...a.keys(),...n.keys()]),r=[];for(const l of o){const f=a.get(l)||null,m=n.get(l)||null;if(!f||!m){r.push({id:l,name:(f==null?void 0:f.name)||(m==null?void 0:m.name)||"Неизвестный",snapshot1:f?{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0}:null,snapshot2:m?{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0}:null,delta:this.calculateEmployeeDelta(f,m),trend:f?"removed":"new"});continue}const u={},k=["formed","review","execution"];for(const _ of k){const D=((c=f.ticketsByStage)==null?void 0:c[_])||0,S=((i=m.ticketsByStage)==null?void 0:i[_])||0;u[_]=this.calculateDelta(D,S)}const w=this.calculateDelta(f.totalTickets||0,m.totalTickets||0);r.push({id:l,name:f.name,snapshot1:{ticketsByStage:f.ticketsByStage||{},totalTickets:f.totalTickets||0},snapshot2:{ticketsByStage:m.ticketsByStage||{},totalTickets:m.totalTickets||0},delta:{ticketsByStage:u,totalTickets:w},trend:w.trend})}return r}static calculateEmployeeDelta(t,e){var r,c;if(!t&&!e)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},n=["formed","review","execution"];for(const i of n){const l=((r=t==null?void 0:t.ticketsByStage)==null?void 0:r[i])||0,f=((c=e==null?void 0:e.ticketsByStage)==null?void 0:c[i])||0;a[i]=this.calculateDelta(l,f)}const o=this.calculateDelta((t==null?void 0:t.totalTickets)||0,(e==null?void 0:e.totalTickets)||0);return{ticketsByStage:a,totalTickets:o}}static compareZeroPoint(t,e){return{unassigned:this.calculateDelta((t==null?void 0:t.unassigned)||0,(e==null?void 0:e.unassigned)||0),keeper:this.calculateDelta((t==null?void 0:t.keeper)||0,(e==null?void 0:e.keeper)||0),total:this.calculateDelta((t==null?void 0:t.total)||0,(e==null?void 0:e.total)||0)}}static compareTickets(t,e,a,n){var k,w;const o=new Set(t),r=new Set(e),c=e.filter(_=>!o.has(_)),i=t.filter(_=>!r.has(_)),l=[],f=[],m=new Map(a.map(_=>[_.id,_])),u=new Map(n.map(_=>[_.id,_]));for(const _ of t){if(!r.has(_))continue;const D=m.get(_),S=u.get(_);if(!D||!S)continue;const N=(((k=D.assignedTo)==null?void 0:k.id)||null)!==(((w=S.assignedTo)==null?void 0:w.id)||null),x=(D.stageId||null)!==(S.stageId||null);N||x?l.push(_):f.push(_)}return{new:c,removed:i,changed:l,unchanged:f}}static buildComparisonMetadata(t,e){const a=new Date(t.metadata.createdAt),n=new Date(e.metadata.createdAt),o=new Date,r=n.getTime()-a.getTime(),c=Math.floor(r/(1e3*60*60*24)),i=Math.floor(r%(1e3*60*60*24)/(1e3*60*60)),l=Math.floor(r%(1e3*60*60)/(1e3*60));return{snapshot1Date:t.metadata.createdAt,snapshot2Date:e.metadata.createdAt,comparisonDate:o.toISOString(),timeDiff:{days:c,hours:i,minutes:l,totalMinutes:Math.floor(r/(1e3*60))}}}static buildSummary(t,e,a,n){var l,f,m;const o=t.total.delta,r=Object.keys(t).filter(u=>u==="total"?!1:t[u].delta!==0).length,c=e.filter(u=>u.trend==="new"||u.trend==="removed"?!0:u.delta.totalTickets.delta!==0).length,i=o!==0||r>0||c>0;return{totalDelta:o,stagesChanged:r,employeesChanged:c,hasChanges:i,newTicketsCount:((l=n==null?void 0:n.new)==null?void 0:l.length)||0,removedTicketsCount:((f=n==null?void 0:n.removed)==null?void 0:f.length)||0,changedTicketsCount:((m=n==null?void 0:n.changed)==null?void 0:m.length)||0}}static validateSnapshot(t){const e=[],a=[];if(!t)return e.push("Snapshot is null or undefined"),{valid:!1,errors:e,warnings:a};if(t.metadata?(t.metadata.createdAt||e.push("Missing metadata.createdAt"),t.metadata.type||e.push("Missing metadata.type")):e.push("Missing metadata field"),!t.statistics)e.push("Missing statistics field");else{if(!t.statistics.stages)e.push("Missing statistics.stages");else{const n=["formed","review","execution"];for(const o of n)t.statistics.stages[o]||a.push(`Missing stage: ${o}`)}t.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),t.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:e.length===0,errors:e,warnings:a}}static compareMultipleSnapshots(t,e={}){if(!Array.isArray(t)||t.length<2)throw new Error("At least 2 snapshots required for comparison");for(const r of t){const c=this.validateSnapshot(r);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const a=[...t].sort((r,c)=>{const i=new Date(r.metadata.createdAt),l=new Date(c.metadata.createdAt);return i-l}),n=[];for(let r=0;r<a.length-1;r++)n.push({from:r,to:r+1,result:this.compareTwoSnapshots(a[r],a[r+1],e)});const o=this.buildTrends(a);return{snapshots:a.map((r,c)=>({index:c,date:r.metadata.createdAt,type:r.metadata.type,data:r})),comparisons:n,trends:o}}static buildTrends(t){var a,n,o,r,c,i,l,f,m,u;const e={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const k of t){const w=k.statistics;e.stages.formed.push(((n=(a=w.stages)==null?void 0:a.formed)==null?void 0:n.count)||0),e.stages.review.push(((r=(o=w.stages)==null?void 0:o.review)==null?void 0:r.count)||0),e.stages.execution.push(((i=(c=w.stages)==null?void 0:c.execution)==null?void 0:i.count)||0),e.stages.total.push(((l=w.stages)==null?void 0:l.total)||0),e.zeroPoint.unassigned.push(((f=w.zeroPoint)==null?void 0:f.unassigned)||0),e.zeroPoint.keeper.push(((m=w.zeroPoint)==null?void 0:m.keeper)||0),e.zeroPoint.total.push(((u=w.zeroPoint)==null?void 0:u.total)||0)}return e}}const fa={class:"stages-container"},ha={class:"stages-chips"},ya=["checked","disabled","onChange"],va={class:"stage-chip-label"},ka={__name:"StageChips",props:{stages:{type:Array,required:!0,validator:s=>s.every(t=>t.id&&t.name&&t.color)},selected:{type:Object,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:selected","change"],setup(s,{emit:t}){const e=s,a=t;function n(o,r){const c={...e.selected};c[o]=r,a("update:selected",c),a("change",o,r)}return(o,r)=>(T(),I("div",fa,[r[0]||(r[0]=d("h4",{class:"stages-title"},"Этапы для отображения:",-1)),d("div",ha,[(T(!0),I(ge,null,me(s.stages,c=>(T(),I("label",{key:c.id,class:ie(["stage-chip",{"stage-chip--active":s.selected[c.id],"stage-chip--disabled":s.disabled}])},[d("input",{type:"checkbox",checked:s.selected[c.id],disabled:s.disabled,onChange:i=>n(c.id,i.target.checked)},null,40,ya),d("span",{class:"stage-chip-color",style:ye({backgroundColor:c.color})},null,4),d("span",va,B(c.name),1)],2))),128))])]))}},ba=et(ka,[["__scopeId","data-v-fe03c03c"]]),dt=140,je=new Map;class mt{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const e=await Ft.call("crm.item.list",{entityTypeId:dt,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let a=[];if(e&&e.result&&(Array.isArray(e.result)?a=e.result:e.result.items&&Array.isArray(e.result.items)?a=e.result.items:e.result.data&&Array.isArray(e.result.data)&&(a=e.result.data)),!a||a.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const n=a[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:n.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!n.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:n.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(n),ticketSample:JSON.stringify(n).substring(0,500)});const o=$t(n),r=n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:r,mappedDepartmentHead:o.departmentHead,departmentHeadFull:r?String(r).trim():null});let c=null;if(r){const i=String(r).trim();i.length>0&&(c=i)}return{...o,departmentHeadFull:c}}catch(e){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,e),console.error("[TicketDetailsService] Error details:",{message:e.message,stack:e.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const e=[],a=[];if(t.forEach(n=>{je.has(n)?e.push(je.get(n)):a.push(n)}),a.length===0)return e;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:a.length,ticketIdsSample:a.slice(0,5),entityTypeId:dt});const n=await Ft.call("crm.item.list",{entityTypeId:dt,filter:{id:a},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!n,resultType:typeof n,resultKeys:n?Object.keys(n):[],hasResultResult:!!(n!=null&&n.result),resultResultType:typeof(n==null?void 0:n.result),isArray:Array.isArray(n==null?void 0:n.result),resultResultLength:Array.isArray(n==null?void 0:n.result)?n.result.length:"not array",fullResult:n});let o=[];if(n&&n.result&&(Array.isArray(n.result)?o=n.result:n.result.items&&Array.isArray(n.result.items)?o=n.result.items:n.result.data&&Array.isArray(n.result.data)&&(o=n.result.data)),!o||o.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!n,hasResultResult:!!(n!=null&&n.result),resultType:typeof(n==null?void 0:n.result),result:n,resultKeys:n?Object.keys(n):[]}),e;const r=o.map((c,i)=>{i===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:c.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:c.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(c).filter(k=>k.toLowerCase().includes("department")||k.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(c).slice(0,20)});const l=$t(c);i===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:l.id,hasDepartmentHead:!!l.departmentHead,departmentHead:l.departmentHead,mappedTicketKeys:Object.keys(l).filter(k=>k.toLowerCase().includes("department"))});const f=c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||c.UF_CRM_7_DEPARTMENT_HEAD||c.uf_crm_7_department_head||c.ufCrm7DepartmentHead||null;i===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:f,hasUF_CRM_7_DEPARTMENT_HEAD:!!c.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(c).filter(k=>k.toLowerCase().includes("department")||k.toLowerCase().includes("uf_crm"))});let m=null;if(f){const k=String(f).trim();k.length>0&&(m=k)}!m&&l.departmentHead&&(m=l.departmentHead);const u={...l,departmentHeadFull:m||l.departmentHead||null};return i===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:u.id,departmentHead:u.departmentHead,departmentHeadFull:u.departmentHeadFull}),u.id&&je.set(u.id,u),u});return[...e,...r]}catch(n){return console.error("[TicketDetailsService] Error loading tickets details batch:",n),console.error("[TicketDetailsService] Error details:",{message:n.message,stack:n.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),e}}static clearCache(t=1e3){je.size>t&&je.clear()}static getCacheSize(){return je.size}}async function Vt(s,t,e,a=null){var l;if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:s,stageId:t,hasSnapshot:!!e,snapshotType:e?typeof e:"null",snapshotKeys:e?Object.keys(e):[],hasTickets:!!(e!=null&&e.tickets),ticketsIsArray:Array.isArray(e==null?void 0:e.tickets),ticketsLength:((l=e==null?void 0:e.tickets)==null?void 0:l.length)||0}),!s||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!e)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!e.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(e)),[];if(!Array.isArray(e.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof e.tickets),[];const n=e.tickets.filter(f=>{const m=f.assignedTo;return m?(typeof m=="object"?m.id:m)===s:!1});if(n.length===0)return[];const o=!n[0].stageId||!n[0].departmentHead;let r=null;if(o){const f=n.map(m=>m.id);if(a&&typeof a=="object")r=a;else try{const m=await mt.getTicketsDetails(f);r=new Map,m.forEach(u=>{u&&u.id&&r.set(u.id,u)})}catch(m){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",m),r=null}}return n.map(f=>{const m=f.id,u={id:m,title:f.title||"Без названия",assignedTo:f.assignedTo,createdAt:f.createdAt,updatedAt:f.updatedAt};if(r){const k=r instanceof Map?r.get(m):r[m];k?(u.stageId=k.stageId||null,u.departmentHead=k.departmentHead||null,u.departmentHeadFull=k.departmentHeadFull||k.departmentHead||null):(u.stageId=null,u.departmentHead=null)}else u.stageId=f.stageId||null,u.departmentHead=f.departmentHead||null,u.departmentHeadFull=f.departmentHeadFull||f.departmentHead||null;return u}).filter(f=>f.stageId?Ue(f.stageId)===t:!0)}function Rt(s,t=new Date){if(!s||s.length===0)return[];const e=s.length,a={};return Object.values(le).forEach(o=>{a[o]={category:o,label:Ht[o].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:Ht[o].color}}),s.forEach(o=>{if(!o.createdAt){a[le.MORE_THAN_YEAR].count++,a[le.MORE_THAN_YEAR].tickets.push(o);return}const r=zt(o.createdAt,t);a[r]&&(a[r].count++,a[r].tickets.push(o))}),Object.values(a).filter(o=>o.count>0).map(o=>{const r=e>0?parseFloat((o.count/e*100).toFixed(1)):0;return{...o,percentage:r,progressBarWidth:r}}).sort((o,r)=>{const c=[le.TODAY,le.YESTERDAY,le.THIS_WEEK,le.LAST_WEEK,le.MORE_THAN_TWO_WEEKS,le.UP_TO_ONE_MONTH,le.MORE_THAN_TWO_MONTHS,le.MORE_THAN_HALF_YEAR,le.MORE_THAN_YEAR];return c.indexOf(o.category)-c.indexOf(r.category)})}function Pt(s){if(!s||s.length===0)return[];const t={};s.forEach(a=>{let n=a.departmentHeadFull||a.departmentHead;s.indexOf(a)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:a.id,departmentHead:a.departmentHead,departmentHeadFull:a.departmentHeadFull,allKeys:Object.keys(a).filter(o=>o.toLowerCase().includes("department"))}),n?(n=String(n).trim(),n.length===0&&(n="Без заказчика")):n="Без заказчика",t[n]||(t[n]={departmentName:n,count:0}),t[n].count++});const e=Object.values(t);return e.sort((a,n)=>n.count!==a.count?n.count-a.count:a.departmentName.localeCompare(n.departmentName,"ru")),e}function wa(s,t){return{sourceLevel:2,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Sa(s,t){if(!s||!t)return{sourceLevel:2,employeeId:(s==null?void 0:s.employeeId)||null,employeeName:(s==null?void 0:s.employeeName)||null,stageId:(s==null?void 0:s.stageId)||null,stageName:(s==null?void 0:s.stageName)||null,dateCategory:null,dateCategoryLabel:null,departmentName:(t==null?void 0:t.departmentName)||null,tickets:[],snapshot:(s==null?void 0:s.snapshot)||null,ticketDetails:(s==null?void 0:s.ticketDetails)||null};const e=Re(s.tickets||[],t.departmentName);return{sourceLevel:2,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:e,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}async function Ea(s,t){const e=await Vt(s.employeeId,s.stageId,s.snapshot,s.ticketDetails),a=Kt(e,s.dateCategory),n=Re(a,t.departmentName);return{sourceLevel:3,employeeId:s.employeeId,employeeName:s.employeeName,stageId:s.stageId,stageName:s.stageName,dateCategory:s.dateCategory,dateCategoryLabel:s.dateCategoryLabel,departmentName:t.departmentName,tickets:n,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Da(s,t){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:s.stageId,stageName:s.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function Ca(s,t){var n;const e=(((n=s.snapshot)==null?void 0:n.tickets)||[]).filter(o=>o.stageId?Ue(o.stageId)===s.stageId:!1),a=Re(e,t.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:s.stageId,stageName:s.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:a,snapshot:s.snapshot,ticketDetails:s.ticketDetails}}function _a(s,t){return!s||s.length===0?[]:s.filter(e=>e.stageId?Ue(e.stageId)===t:!1)}function Ta(s,t){return!s||s.length===0?[]:s.filter(e=>{const a=e.assignedTo;return a?(typeof a=="object"?a.id:a)===t:!1})}function Kt(s,t){if(!s||s.length===0)return[];const e=new Date;return s.filter(a=>a.createdAt?zt(a.createdAt,e)===t:t===le.MORE_THAN_YEAR)}function Re(s,t){return!s||s.length===0?[]:s.filter(e=>{let a=e.departmentHeadFull||e.departmentHead;return a?(a=String(a).trim(),a.length===0&&(a="Без заказчика")):a="Без заказчика",a===t})}async function Aa(s){var c;if(!s||!s.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(s.tickets&&s.tickets.length>0){let i=s.tickets;return s.departmentName&&(i=Re(i,s.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:s.tickets.length,filteredCount:i.length,departmentFilter:s.departmentName}),i}const{snapshot:t,stageId:e,employeeId:a,dateCategory:n,departmentName:o}=s;let r=t.tickets||[];return e&&(r=_a(r,e)),a&&(r=Ta(r,a)),n&&(r=Kt(r,n)),o&&(r=Re(r,o)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:((c=t.tickets)==null?void 0:c.length)||0,filteredCount:r.length,filters:{stageId:e,employeeId:a,dateCategory:n,departmentName:o}}),r}function Ia(s){return s?s==="review"||s==="execution"?"in_progress":s==="done"||s==="closed"?"done":"new":"new"}function Na(s){return s.filter(t=>{const e=!t.ufSubject||t.ufSubject==="",a=t.actionStr===null||t.actionStr===void 0,n=!t.description||t.description==="";return e||a||n})}function Ma(s){const t=new Map;return s&&(Array.isArray(s)?s.forEach(e=>{e&&e.id&&t.set(e.id,e)}):typeof s=="object"&&Object.keys(s).forEach(e=>{const a=s[e];a&&a.id&&t.set(a.id,a)})),t}function $a(s,t){var f;const e=t.get(s.id)||null,a={id:s.id,title:s.title||"Без названия",createdAt:s.createdAt||s.createdTime||"",updatedAt:s.updatedAt||s.updatedTime||s.modifiedAt||""};a.ufSubject=(e==null?void 0:e.ufSubject)||s.ufSubject||null;const n=(e==null?void 0:e.priorityId)||s.priorityId||"unknown",o=(e==null?void 0:e.priorityLabel)||s.priorityLabel||"Не указано",r=ra(n);a.priorityId=n,a.priorityLabel=o,a.priorityColors=r,a.priority=n;const c=(e==null?void 0:e.service)||s.service||na(),i=(e==null?void 0:e.serviceLabel)||s.serviceLabel||c.label||"Не указано",l=oa(c);return a.service=c,a.serviceLabel=i,a.serviceColors=l,a.actionStr=(e==null?void 0:e.actionStr)||s.actionStr||s.ufActionStr||null,a.ufActionStr=a.actionStr,a.departmentHead=(e==null?void 0:e.departmentHead)||s.departmentHead||null,a.departmentHeadFull=(e==null?void 0:e.departmentHeadFull)||s.departmentHeadFull||s.departmentHead||null,a.description=(e==null?void 0:e.description)||s.description||s.comments||"",a.assignedTo=s.assignedTo||null,a.assigneeId=s.assigneeId||((f=s.assignedTo)==null?void 0:f.id)||null,a.stageId=s.stageId||null,!a.status&&a.stageId?a.status=Ia(a.stageId):a.status=s.status||"new",a}async function Fa(s,t=null,e=null){if(console.time("[Performance] prepareTicketsForDisplay"),!s||s.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const a=Na(s);console.log("[ticketListUtils] Tickets needing details:",{total:s.length,needingDetails:a.length,alreadyHaveDetails:s.length-a.length});let n=e||null;if(a.length>0&&!e){const c=a.map(i=>i.id).filter(i=>i);if(c.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:c.length,ticketIdsSample:c.slice(0,5)}),n=await mt.getTicketsDetails(c),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:(n==null?void 0:n.length)||0,sampleTicket:n!=null&&n[0]?{id:n[0].id,hasUfSubject:!!n[0].ufSubject,hasActionStr:!!n[0].actionStr,hasDescription:!!n[0].description}:null})}catch(i){console.warn("[ticketListUtils] Failed to load ticket details:",i),console.error("[ticketListUtils] Error details:",{message:i.message,stack:i.stack,ticketIdsCount:c.length}),n=null}}const o=Ma(n),r=s.map(c=>$a(c,o));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:r.length,sampleTicket:r[0]?{id:r[0].id,hasUfSubject:!!r[0].ufSubject,hasPriorityColors:!!r[0].priorityColors,hasServiceColors:!!r[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),r}const Le=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:Ca,createContextFromLevel1Time:Da,createContextFromLevel2:wa,createContextFromLevel2Department:Sa,createContextFromLevel3:Ea,filterTicketsByContext:Aa,filterTicketsByDepartment:Re,prepareTicketsForDisplay:Fa},Symbol.toStringTag,{value:"Module"})),ze=10;function nt(s,t){if(!t||!t.statistics)return[];const e=[];t.statistics.employees&&Array.isArray(t.statistics.employees)&&t.statistics.employees.filter(n=>n.ticketsByStage&&n.ticketsByStage[s]>0).forEach(n=>{e.push({id:n.id,name:n.name,count:n.ticketsByStage[s]||0})});const a=Ha(s,t);return a>0&&e.push({id:1051,name:"Хранитель объектов (Неразобранное)",count:a,isKeeper:!0}),e.sort((n,o)=>o.count-n.count)}function Ha(s,t){if(!t||!t.statistics)return 0;if(t.statistics.zeroPointByStage&&t.statistics.zeroPointByStage[s])return t.statistics.zeroPointByStage[s].keeper||0;if(t.statistics.zeroPoint){const e=t.statistics.zeroPoint.keeper||0;return Math.floor(e/3)}return 0}function Yt(s,t){var e;return!t||!t.statistics||!t.statistics.stages?0:((e=t.statistics.stages[s])==null?void 0:e.count)||0}function ot(s,t=ze){if(!s||s.length===0)return{visible:[],others:{employees:[],count:0,employeeCount:0}};const e=[...s].sort((r,c)=>c.count-r.count),a=e.slice(0,t),n=e.slice(t),o=n.reduce((r,c)=>r+c.count,0);return{visible:a,others:{employees:n,count:o,employeeCount:n.length}}}function Gt(s,t){return!s||s.length===0?[]:t===0?s.map(e=>({...e,percentage:0})):s.map(e=>({...e,percentage:parseFloat((e.count/t*100).toFixed(1))}))}function at(s,t,e="#007bff",a=ze){if(!s||s.length===0)return{employees:[],others:null};const{visible:n,others:o}=ot(s,a),r=Gt(n,t).map(i=>({...i,progressBarWidth:i.percentage,progressBarColor:i.isKeeper?"#f59e0b":e}));let c=null;if(o.count>0){const i=parseFloat((o.count/t*100).toFixed(1));c={...o,percentage:i,progressBarWidth:i,progressBarColor:"#6c757d"}}return{employees:r,others:c}}function La(s,t){const e={weekStart:[],weekEnd:[],current:[],others:{weekStart:{count:0,employeeCount:0},weekEnd:{count:0,employeeCount:0},current:{count:0,employeeCount:0}}};return["weekStart","weekEnd","current"].forEach(n=>{const o=t[n];if(!o)return;const r=nt(s,o),c=Yt(s,o);if(r.length===0)return;const{visible:i,others:l}=ot(r,ze),f=Gt(i,c);e[n]=f,l.count>0&&(e.others[n]={count:l.count,employeeCount:l.employeeCount,percentage:parseFloat((l.count/c*100).toFixed(1))})}),e}function Ra(s,t="current",e=[]){const a=s[t];if(!a)return{labels:[],datasets:[]};const n=new Map;e.forEach(m=>{nt(m.id,a).forEach(k=>{n.has(k.id)||n.set(k.id,{id:k.id,name:k.name,isKeeper:k.isKeeper||!1,ticketsByStage:{}}),n.get(k.id).ticketsByStage[m.id]=k.count})});const o=Array.from(n.values()).map(m=>{const u=Object.values(m.ticketsByStage).reduce((k,w)=>k+w,0);return{...m,totalTickets:u}});o.sort((m,u)=>u.totalTickets-m.totalTickets);const{visible:r,others:c}=ot(o,ze),i=e.map(()=>""),l={};e.forEach(m=>{const u=nt(m.id,a),{visible:k}=ot(u,ze);l[m.id]=k.map(w=>({id:w.id,name:w.name,count:w.count}))});const f=r.map((m,u)=>{const k=e.map(_=>m.ticketsByStage[_.id]||0),w=e.map(_=>{if((m.ticketsByStage[_.id]||0)===0)return"transparent";const N=_.color.replace("#",""),x=parseInt(N.substring(0,2),16),G=parseInt(N.substring(2,4),16),ee=parseInt(N.substring(4,6),16),Z=.6+u*.05;return`rgba(${x}, ${G}, ${ee}, ${Math.min(Z,.95)})`});return{label:m.name,data:k,backgroundColor:w,borderColor:e.map(_=>{const D=_.color.replace("#",""),S=parseInt(D.substring(0,2),16),N=parseInt(D.substring(2,4),16),x=parseInt(D.substring(4,6),16);return`rgba(${S}, ${N}, ${x}, 0.8)`}),borderWidth:1,meta:{employeeId:m.id,employeeName:m.name}}});if(c.count>0){const m=e.map(u=>c.employees.reduce((k,w)=>k+(w.ticketsByStage[u.id]||0),0));f.push({label:`Другие (${c.employeeCount})`,data:m,backgroundColor:"rgba(108, 117, 125, 0.5)",borderColor:"#6c757d",borderWidth:1})}return{labels:i,datasets:f,meta:{employeesByStage:l}}}function Pa(s,t,e=[]){if(!t)return{stageName:"",totalCount:0,employees:[],others:null};const a=e.find(l=>l.id===s),n=a?a.name:"",o=a?a.color:"#007bff",r=nt(s,t),c=Yt(s,t);if(r.length===0)return{stageName:n,totalCount:0,employees:[],others:null};const i=at(r,c,o,ze);return{stageName:n,totalCount:c,employees:i.employees,others:i.others}}function xa(s,t){return(t==null?void 0:t[s])||s}function Ba(s,t){return(t==null?void 0:t[s])||"#007bff"}function ft({snapshots:s,graphType:t,timePoint:e,snapshotType:a}){return s?t==="line"&&e?s[e]||null:t==="bar"&&a?s[a]||null:s.current||s.weekEnd||s.weekStart||null:null}function ht(s,t){var e,a,n;return((n=(a=(e=t==null?void 0:t.statistics)==null?void 0:e.stages)==null?void 0:a[s])==null?void 0:n.count)||0}function Oa({stageId:s,timePoint:t,meta:e,snapshots:a,stageColor:n,maxVisible:o}){if(!(e!=null&&e.employees)||!t)return null;const r=e.employees[t];if(!r||r.length===0)return null;const c=(a==null?void 0:a[t])||null,i=ht(s,c)||r.reduce((f,m)=>f+(m.count||0),0),l=at(r,i,n,o);return{stageId:s,totalCount:i,employees:l.employees,others:l.others,snapshot:c}}function ja({stageId:s,meta:t,snapshots:e,stageColor:a,maxVisible:n}){var l;const o=(l=t==null?void 0:t.employees)==null?void 0:l[s];if(!o||!o.employees||o.employees.length===0)return null;const r=ft({snapshots:e,graphType:"doughnut"}),c=o.totalCount??ht(s,r)??o.employees.reduce((f,m)=>f+(m.count||0),0),i=at(o.employees,c,a,n);return{stageId:s,totalCount:c,employees:i.employees,others:i.others,snapshot:r}}function Wa({stageId:s,meta:t,snapshots:e,stageColor:a,maxVisible:n,snapshotType:o}){var f;const r=(f=t==null?void 0:t.employeesByStage)==null?void 0:f[s];if(!r||r.length===0)return null;const c=ft({snapshots:e,graphType:"bar",snapshotType:o}),i=ht(s,c)||r.reduce((m,u)=>m+(u.count||0),0),l=at(r,i,a,n);return{stageId:s,totalCount:i,employees:l.employees,others:l.others,snapshot:c}}async function Xt({stageId:s,graphType:t,timePoint:e=null,snapshotType:a=null,snapshots:n=null,meta:o=null,stageColorMap:r=null,stageNameMap:c=null,maxVisible:i=10,restLoader:l=null}){if(!s)throw new Error("stageId обязателен для загрузки данных уровня 1");const f=xa(s,c),m=Ba(s,r);let u=null;if(t==="line"?u=Oa({stageId:s,timePoint:e,meta:o==null?void 0:o.line,snapshots:n,stageColor:m,maxVisible:i}):t==="doughnut"?u=ja({stageId:s,meta:o==null?void 0:o.doughnut,snapshots:n,stageColor:m,maxVisible:i}):t==="bar"&&(u=Wa({stageId:s,meta:o==null?void 0:o.bar,snapshots:n,stageColor:m,maxVisible:i,snapshotType:a})),u)return{stageId:s,stageName:f,color:m,totalCount:u.totalCount,employees:u.employees,others:u.others,snapshot:u.snapshot};if(typeof l=="function"){const k=await l({stageId:s,graphType:t,timePoint:e,snapshotType:a,snapshots:n});if(k&&Array.isArray(k.employees)){const w=k.totalCount??k.employees.reduce((D,S)=>D+(S.count||0),0),_=at(k.employees,w,m,i);return{stageId:s,stageName:f,color:m,totalCount:w,employees:_.employees,others:_.others,snapshot:k.snapshot||ft({snapshots:n,graphType:t,timePoint:e,snapshotType:a})}}}throw new Error("Данные для выбранной стадии недоступны (meta/REST)")}const Ua={key:"level-1",class:"level-1"},za={class:"modal-header"},Va={class:"stage-header"},Ka=["aria-expanded","onKeydown"],Ya={class:"stage-title"},Ga=["aria-selected","onClick","onKeydown"],Xa={class:"stage-name"},qa={class:"modal-total"},Ja={class:"view-switcher"},Za={class:"modal-body"},Qa={key:0,class:"load-error"},es={key:1,class:"stage-loader"},ts={key:2},as={key:0,class:"no-employees"},ss={key:1,class:"employees-list"},ns=["onClick"],os={class:"employee-name"},rs={class:"employee-progress"},ls={class:"employee-count"},is={key:0,class:"employee-item employee-others"},cs={class:"employee-name"},us={class:"employee-progress"},ds={class:"employee-count"},ps={key:3,class:"view-time"},gs={key:0,class:"no-data"},ms={key:1,class:"date-categories-list"},fs=["onClick"],hs={class:"category-label"},ys={class:"category-progress"},vs={class:"category-count"},ks={key:4,class:"view-departments"},bs={key:0,class:"no-data"},ws={key:1,class:"departments-table-container"},Ss={class:"departments-table"},Es=["onClick"],Ds={class:"col-department"},Cs={class:"department-name"},_s={class:"col-count"},Ts={class:"count-value"},As={key:"level-2",class:"level-2"},Is={class:"modal-header"},Ns={class:"modal-total"},Ms={class:"modal-body"},$s={class:"stage-info level2-stage-row"},Fs={class:"stage-badge"},Hs={class:"level2-sort-switch",role:"group","aria-label":"Переключение сортировки"},Ls={key:0},Rs={key:0,class:"no-data"},Ps={key:1,class:"date-categories-list"},xs=["onClick"],Bs={class:"category-label"},Os={class:"category-progress"},js={class:"category-count"},Ws={key:1,class:"view-departments"},Us={key:0,class:"no-data"},zs={key:1,class:"departments-table-container"},Vs={class:"departments-table"},Ks=["onClick"],Ys={class:"col-department"},Gs={class:"department-name"},Xs={class:"col-count"},qs={class:"count-value"},Js={key:"level-3",class:"level-3"},Zs={class:"modal-header"},Qs={class:"header-info"},en={class:"header-badges"},tn={class:"date-badge"},an={class:"stage-badge"},sn={class:"modal-total"},nn={class:"modal-body"},on={key:0,class:"no-data"},rn={key:1,class:"departments-table-container"},ln={class:"departments-table"},cn=["onClick"],un={class:"col-department"},dn={class:"department-name"},pn={class:"col-count"},gn={class:"count-value"},mn={key:"level-4",class:"level-4"},fn={class:"modal-header"},hn={class:"header-info"},yn={key:0,class:"header-badges"},vn={key:0,class:"date-badge"},kn={key:1,class:"department-badge"},bn={class:"stage-badge"},wn={class:"modal-total"},Sn={class:"modal-body"},En={key:"loading",class:"loading-state"},Dn={key:"error-fallback",class:"error-state-with-fallback"},Cn={class:"tickets-list-container"},_n={key:"error",class:"error-state"},Tn={class:"error-message"},An={key:"empty",class:"empty-state"},In={class:"empty-state-title"},Nn={class:"empty-state-message"},Mn={key:"tickets",class:"tickets-list-container"},$n={__name:"EmployeeDetailsModal",props:{isVisible:{type:Boolean,default:!1},stageName:{type:String,required:!0},stageId:{type:String,default:""},totalCount:{type:Number,required:!0},employees:{type:Array,default:()=>[]},others:{type:Object,default:null},snapshot:{type:Object,default:null},ticketDetails:{type:Object,default:null},stageSwitchContext:{type:Object,default:null}},emits:["close"],setup(s,{expose:t,emit:e}){const a=s,n=e,o=tt(),r=L(1),c=L("time"),i=L("employees"),l=L(null),f=L([]),m=L([]),u=L(null),k=L(null),w=L(null),_=L(a.stageSwitchContext||null),D=L(!1),S=L(null),N=L(null),x=L(!1),G=L(null),ee=L(null),Z=ae(()=>{var y,M;const p=((y=_.value)==null?void 0:y.stageNameMap)||{},h=((M=_.value)==null?void 0:M.stageColorMap)||{};return Object.keys(p).map(K=>{var j;return{id:K,name:p[K],color:h[K]||"#007bff",disabled:K===(((j=l.value)==null?void 0:j.stageId)||a.stageId)}})});ae(()=>r.value>1);const re=ae(()=>{var p,h,y,M,K;switch(r.value){case 1:return((p=l.value)==null?void 0:p.stageName)||a.stageName;case 2:return((h=u.value)==null?void 0:h.employeeName)||"";case 3:return`${((y=u.value)==null?void 0:y.employeeName)||""} — ${((M=k.value)==null?void 0:M.dateCategoryLabel)||""}`;case 4:if(!((K=w.value)!=null&&K.context))return"Список тикетов";const j=w.value.context,X=[];return j.employeeName&&X.push(j.employeeName),j.dateCategoryLabel&&X.push(j.dateCategoryLabel),j.departmentName&&X.push(j.departmentName),j.stageName&&X.push(j.stageName),X.length>0?X.join(" — "):"Список тикетов";default:return""}});function se(){var p,h,y;console.log("[EmployeeDetailsModal] Initializing level 1 with props:",{stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employeesCount:((p=a.employees)==null?void 0:p.length)||0,hasSnapshot:!!a.snapshot,snapshotTicketIds:((y=(h=a.snapshot)==null?void 0:h.ticketIds)==null?void 0:y.length)||0,hasTicketDetails:!!a.ticketDetails,snapshotKeys:a.snapshot?Object.keys(a.snapshot):[]}),l.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null},console.log("[EmployeeDetailsModal] Level 1 data initialized:",{stageId:l.value.stageId,hasSnapshot:!!l.value.snapshot,employeesCount:l.value.employees.length,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null"}),u.value=null,k.value=null,w.value=null,r.value=1,c.value="time",i.value="employees",Q(),console.log("[EmployeeDetailsModal] Popup level set to 1, ready for clicks")}async function Q(){if(!l.value||!l.value.snapshot||!l.value.stageId){console.warn("[EmployeeDetailsModal] Cannot load level 1 view data - missing required data");return}try{const p=l.value.snapshot.tickets||[],h=l.value.stageId;console.log("[EmployeeDetailsModal] Loading level 1 view data:",{totalSnapshotTickets:p.length,currentStageId:h,sampleTicket:p[0]?{id:p[0].id,stageId:p[0].stageId,hasDepartmentHead:!!p[0].departmentHead,departmentHead:p[0].departmentHead,hasDepartmentHeadFull:!!p[0].departmentHeadFull,departmentHeadFull:p[0].departmentHeadFull,allKeys:Object.keys(p[0])}:null});let y=p.filter(F=>F.stageId?Ue(F.stageId)===h:!0);console.log("[EmployeeDetailsModal] Filtered tickets by stage:",{beforeFilter:p.length,afterFilter:y.length,stageId:h,ticketsWithStageId:y.filter(F=>F.stageId).length,ticketsWithoutStageId:y.filter(F=>!F.stageId).length});const M=y.filter(F=>!F.departmentHead&&!F.departmentHeadFull);if(M.length>0){console.log("[EmployeeDetailsModal] DepartmentHead missing for some tickets, loading via API...",{ticketsNeedingDetails:M.length,totalTickets:y.length,ticketsWithDepartment:y.filter(v=>v.departmentHead||v.departmentHeadFull).length});const F=M.map(v=>v.id).filter(v=>v);try{console.log("[EmployeeDetailsModal] Loading details for tickets:",{ticketIdsCount:F.length,ticketIdsSample:F.slice(0,10)});const v=await mt.getTicketsDetails(F),g=new Map;v.forEach(b=>{b&&b.id&&g.set(b.id,b)}),console.log("[EmployeeDetailsModal] Details loaded from API:",{detailsCount:v.length,detailsMapSize:g.size,sampleDetail:v[0]?{id:v[0].id,departmentHead:v[0].departmentHead,departmentHeadFull:v[0].departmentHeadFull}:null}),y=y.map(b=>{const $=g.get(b.id);return $?{...b,stageId:$.stageId||b.stageId||null,departmentHead:$.departmentHead||b.departmentHead||null,departmentHeadFull:$.departmentHeadFull||$.departmentHead||b.departmentHead||null}:b}),y=y.filter(b=>b.stageId?Ue(b.stageId)===h:!0),console.log("[EmployeeDetailsModal] Ticket details merged (before stage filter):",{totalTickets:y.length,ticketsWithDepartment:y.filter(b=>b.departmentHead||b.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(b=>!b.departmentHead&&!b.departmentHeadFull).length,ticketsWithStageId:y.filter(b=>b.stageId).length,ticketsWithoutStageId:y.filter(b=>!b.stageId).length});const E=y.length,A=y.slice(0,3).map(b=>({id:b.id,departmentHead:b.departmentHead,departmentHeadFull:b.departmentHeadFull,stageId:b.stageId}));y=y.filter(b=>b.stageId?Ue(b.stageId)===h:!0);const H=y.slice(0,3).map(b=>({id:b.id,departmentHead:b.departmentHead,departmentHeadFull:b.departmentHeadFull,stageId:b.stageId}));console.log("[EmployeeDetailsModal] Ticket details merged (after stage filter):",{beforeStageFilter:E,afterStageFilter:y.length,filteredOut:E-y.length,currentStageId:h,ticketsWithDepartment:y.filter(b=>b.departmentHead||b.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(b=>!b.departmentHead&&!b.departmentHeadFull).length,sampleBeforeFilter:A,sampleAfterFilter:H,sampleWithDepartment:y.find(b=>b.departmentHead||b.departmentHeadFull)?{id:y.find(b=>b.departmentHead||b.departmentHeadFull).id,departmentHead:y.find(b=>b.departmentHead||b.departmentHeadFull).departmentHead,departmentHeadFull:y.find(b=>b.departmentHead||b.departmentHeadFull).departmentHeadFull,allKeys:Object.keys(y.find(b=>b.departmentHead||b.departmentHeadFull)).filter(b=>b.toLowerCase().includes("department"))}:null})}catch(v){console.warn("[EmployeeDetailsModal] Failed to load ticket details via API, using snapshot data:",v),console.error("[EmployeeDetailsModal] Error details:",{message:v.message,stack:v.stack})}}else console.log("[EmployeeDetailsModal] All tickets have departmentHead, skipping API load");console.log("[EmployeeDetailsModal] Final tickets for grouping (only current stage):",{totalTickets:y.length,currentStageId:h,ticketsWithStageId:y.filter(F=>F.stageId).length,ticketsWithoutStageId:y.filter(F=>!F.stageId).length,ticketsWithDepartment:y.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const K=Rt(y);f.value=K,console.log("[EmployeeDetailsModal] Before groupTicketsByDepartment:",{ticketsCount:y.length,sampleTickets:y.slice(0,5).map(F=>({id:F.id,departmentHead:F.departmentHead,departmentHeadFull:F.departmentHeadFull,hasDepartmentHead:!!F.departmentHead,hasDepartmentHeadFull:!!F.departmentHeadFull,allKeys:Object.keys(F).filter(v=>v.toLowerCase().includes("department"))})),ticketsWithDepartment:y.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length});const j=Pt(y);m.value=j;const X=K.reduce((F,v)=>F+v.count,0),ne=j.reduce((F,v)=>F+v.count,0);console.log("[EmployeeDetailsModal] Level 1 view data loaded (only current stage):",{currentStageId:h,totalTicketsForGrouping:y.length,timeCategoriesCount:K.length,totalTicketsInTimeCategories:X,departmentsCount:j.length,totalTicketsInDepartments:ne,departmentsSample:j.slice(0,5),ticketsWithDepartment:y.filter(F=>F.departmentHead||F.departmentHeadFull).length,ticketsWithoutDepartment:y.filter(F=>!F.departmentHead&&!F.departmentHeadFull).length,consistencyCheck:{totalTickets:y.length,timeCategoriesTotal:X,departmentsTotal:ne,isConsistent:y.length===X&&y.length===ne}})}catch(p){console.error("[EmployeeDetailsModal] Error loading level 1 view data:",p),console.error("[EmployeeDetailsModal] Error stack:",p.stack)}}async function ce(p){var y;if(!p){o.error("Не указан stageId для загрузки данных");return}if(((y=l.value)==null?void 0:y.stageId)===p)return;if(!_.value){o.error("Нет контекста для смены стадии (stageSwitchContext)");return}D.value=!0,S.value=null;const h=l.value?{...l.value}:null;N.value=(h==null?void 0:h.stageId)||null;try{const M=await Xt({..._.value,stageId:p});l.value={stageId:M.stageId,stageName:M.stageName,stageColor:M.color,totalCount:M.totalCount,employees:M.employees,others:M.others,snapshot:M.snapshot||(h==null?void 0:h.snapshot)||null,ticketDetails:M.ticketDetails||null},u.value=null,k.value=null,w.value=null,r.value=1,c.value="time",i.value="employees",await Q()}catch(M){console.error("[EmployeeDetailsModal] Failed to reload stage data:",M),S.value=(M==null?void 0:M.message)||"Не удалось загрузить данные стадии",h&&(l.value=h),o.error(S.value)}finally{D.value=!1}}async function fe(p){if(!p||p.count===0){o.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!k.value){console.error("[EmployeeDetailsModal] Level 3 data not found"),o.error("Ошибка: данные уровня 3 не найдены");return}try{const{createContextFromLevel3:h}=await Fe(async()=>{const{createContextFromLevel3:M}=await Promise.resolve().then(()=>Le);return{createContextFromLevel3:M}},void 0),y=await h(k.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 3:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await ue(y)}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 3:",h),o.error("Ошибка перехода на список тикетов: "+h.message)}}async function Ae(p){if(!p||p.count===0){o.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!l.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),o.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Department:h}=await Fe(async()=>{const{createContextFromLevel1Department:M}=await Promise.resolve().then(()=>Le);return{createContextFromLevel1Department:M}},void 0),y=h(l.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (department):",{stageName:y.stageName,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await ue(y)}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (department):",h),o.error("Ошибка перехода на список тикетов: "+h.message)}}async function ke(p){if(!p||p.count===0){o.info(`В категории "${(p==null?void 0:p.label)||"неизвестная"}" нет тикетов`);return}if(!p.tickets||p.tickets.length===0){o.info(`В категории "${p.label}" нет тикетов`);return}if(!l.value){console.error("[EmployeeDetailsModal] Level 1 data not found"),o.error("Ошибка: данные уровня 1 не найдены");return}try{const{createContextFromLevel1Time:h}=await Fe(async()=>{const{createContextFromLevel1Time:M}=await Promise.resolve().then(()=>Le);return{createContextFromLevel1Time:M}},void 0),y=h(l.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 1 (time):",{stageName:y.stageName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await ue(y)}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 1 (time):",h),o.error("Ошибка перехода на список тикетов: "+h.message)}}Je(()=>a.isVisible,p=>{p?se():(Be(),Se())}),Je(()=>a.stageSwitchContext,p=>{_.value=p},{deep:!0}),Qe(()=>{a.isVisible&&se()});async function Pe(p,h=null){var y,M,K;if(console.log("[EmployeeDetailsModal] ====== handleEmployeeClick START ======"),console.log("[EmployeeDetailsModal] Employee clicked:",p),console.log("[EmployeeDetailsModal] Current popup level:",r.value),h&&h.currentTarget&&(h.currentTarget.style.transform="scale(0.98)",setTimeout(()=>{h.currentTarget&&(h.currentTarget.style.transform="")},150)),!p||!p.id){console.warn("[EmployeeDetailsModal] Invalid employee data:",p);return}if(l.value||(console.log("[EmployeeDetailsModal] Level 1 data not found, initializing from props"),l.value={stageName:a.stageName,stageId:a.stageId,totalCount:a.totalCount,employees:a.employees||[],others:a.others||null,snapshot:a.snapshot||null,ticketDetails:a.ticketDetails||null}),console.log("[EmployeeDetailsModal] Level 1 data:",{stageId:l.value.stageId,stageName:l.value.stageName,hasSnapshot:!!l.value.snapshot,snapshotType:l.value.snapshot?typeof l.value.snapshot:"null",snapshotKeys:l.value.snapshot?Object.keys(l.value.snapshot):[]}),!l.value.stageId){console.error("[EmployeeDetailsModal] ERROR: ID стадии не указан"),o.warning("ID стадии не указан");return}if(!l.value.snapshot){console.error("[EmployeeDetailsModal] ERROR: Слепок с данными не передан"),console.error("[EmployeeDetailsModal] Props snapshot:",a.snapshot),o.warning("Слепок с данными не передан");return}try{console.log("[EmployeeDetailsModal] Loading tickets for employee:",p.id,"stage:",l.value.stageId);const j=await Vt(p.id,l.value.stageId,l.value.snapshot,l.value.ticketDetails);if(console.log("[EmployeeDetailsModal] Loaded tickets:",(j==null?void 0:j.length)||0,j),!j||j.length===0){console.warn("[EmployeeDetailsModal] No tickets found for employee"),o.info(`У сотрудника "${p.name}" нет тикетов на стадии "${l.value.stageName}"`);return}const X=Rt(j);console.log("[EmployeeDetailsModal] Date categories:",(X==null?void 0:X.length)||0,X);const ne=Pt(j).map(F=>({...F,tickets:Re(j,F.departmentName)}));console.log("[EmployeeDetailsModal] Employee departments:",(ne==null?void 0:ne.length)||0,ne),u.value={employeeId:p.id,employeeName:p.name,stageId:l.value.stageId,stageName:l.value.stageName,totalCount:j.length,dateCategories:X,departments:ne,tickets:j,snapshot:l.value.snapshot,ticketDetails:l.value.ticketDetails},c.value="time",console.log("[EmployeeDetailsModal] Level 2 data set:",{employeeName:u.value.employeeName,totalCount:u.value.totalCount,dateCategoriesCount:u.value.dateCategories.length,departmentsCount:u.value.departments.length}),console.log("[EmployeeDetailsModal] Transitioning to level 2"),console.log("[EmployeeDetailsModal] Level 2 data before set:",u.value),r.value=2,console.log("[EmployeeDetailsModal] Popup level set to:",r.value),console.log("[EmployeeDetailsModal] Level 2 data after set:",u.value),console.log("[EmployeeDetailsModal] Level 2 data check:",{hasLevel2Data:!!u.value,employeeName:(y=u.value)==null?void 0:y.employeeName,dateCategoriesCount:((K=(M=u.value)==null?void 0:M.dateCategories)==null?void 0:K.length)||0}),setTimeout(()=>{console.log("[EmployeeDetailsModal] After timeout - popupLevel:",r.value),console.log("[EmployeeDetailsModal] After timeout - level2Data:",u.value)},100),console.log("[EmployeeDetailsModal] ====== handleEmployeeClick END ======")}catch(j){console.error("[EmployeeDetailsModal] ERROR loading employee tickets:",j),console.error("[EmployeeDetailsModal] Error stack:",j.stack),o.error("Ошибка загрузки данных о тикетах: "+j.message)}}async function Ve(p){if(!p||p.count===0){o.info(`У заказчика "${(p==null?void 0:p.departmentName)||"неизвестный"}" нет тикетов`);return}if(!u.value){o.error("Ошибка: данные сотрудника не найдены");return}try{const{createContextFromLevel2Department:h}=await Fe(async()=>{const{createContextFromLevel2Department:M}=await Promise.resolve().then(()=>Le);return{createContextFromLevel2Department:M}},void 0),y=h(u.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2 (department):",{employeeName:y.employeeName,departmentName:y.departmentName,ticketsCount:y.tickets.length}),await ue(y)}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2 (department):",h),o.error("Ошибка перехода на список тикетов: "+h.message)}}async function xe(p){if(!p||p.count===0){o.info(`В категории "${(p==null?void 0:p.label)||"неизвестная"}" нет тикетов`);return}if(!p.tickets||p.tickets.length===0){o.info(`В категории "${p.label}" нет тикетов`);return}if(!u.value){console.error("[EmployeeDetailsModal] Level 2 data not found"),o.error("Ошибка: данные уровня 2 не найдены");return}try{const{createContextFromLevel2:h}=await Fe(async()=>{const{createContextFromLevel2:M}=await Promise.resolve().then(()=>Le);return{createContextFromLevel2:M}},void 0),y=h(u.value,p);console.log("[EmployeeDetailsModal] Transitioning to level 4 from level 2:",{employeeName:y.employeeName,dateCategory:y.dateCategoryLabel,ticketsCount:y.tickets.length}),await ue(y)}catch(h){console.error("[EmployeeDetailsModal] Error transitioning to level 4 from level 2:",h),o.error("Ошибка перехода на список тикетов: "+h.message)}}async function ue(p){var h;if(console.time("[Performance] goToLevel4"),!p){console.error("[EmployeeDetailsModal] Context is required for level 4"),o.error("Ошибка: контекст перехода не указан"),console.timeEnd("[Performance] goToLevel4");return}console.log("[EmployeeDetailsModal] Transitioning to level 4:",{sourceLevel:p.sourceLevel,employeeId:p.employeeId,stageId:p.stageId,dateCategory:p.dateCategory,departmentName:p.departmentName,ticketsCount:((h=p.tickets)==null?void 0:h.length)||0});try{w.value={context:p,tickets:[],totalCount:0,isLoading:!0,error:null};let y=p.tickets||[];if(y.length===0&&p.snapshot){const{filterTicketsByContext:K}=await Fe(async()=>{const{filterTicketsByContext:j}=await Promise.resolve().then(()=>Le);return{filterTicketsByContext:j}},void 0);y=await K(p)}(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets found after filtering, using context tickets"),y=p.tickets||[]),(!y||y.length===0)&&(console.warn("[EmployeeDetailsModal] No tickets in context, trying snapshot"),p.snapshot&&p.snapshot.tickets&&(y=p.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using tickets from snapshot:",y.length)));let M=[];try{console.time("[Performance] prepareTicketsForDisplay");const{prepareTicketsForDisplay:K}=await Fe(async()=>{const{prepareTicketsForDisplay:j}=await Promise.resolve().then(()=>Le);return{prepareTicketsForDisplay:j}},void 0);M=await K(y,p.snapshot,p.ticketDetails),console.timeEnd("[Performance] prepareTicketsForDisplay")}catch(K){console.error("[EmployeeDetailsModal] Error preparing tickets:",K),console.timeEnd("[Performance] prepareTicketsForDisplay"),M=y||[],o.warning("Некоторые данные тикетов не удалось загрузить. Отображаются базовые данные.")}console.log("[EmployeeDetailsModal] Tickets prepared for level 4:",{filteredCount:y.length,preparedCount:M.length}),w.value={context:p,tickets:M,totalCount:M.length,isLoading:!1,error:null},r.value=4,console.log("[EmployeeDetailsModal] Level 4 initialized:",{totalCount:w.value.totalCount,ticketsCount:w.value.tickets.length,isLoading:w.value.isLoading}),console.timeEnd("[Performance] goToLevel4")}catch(y){console.error("[EmployeeDetailsModal] Error transitioning to level 4:",y),console.error("[EmployeeDetailsModal] Error details:",{message:y.message,stack:y.stack,context:p});let M=[];if(p.snapshot&&p.snapshot.tickets)try{const K=p.stageId;K?M=(p.snapshot.tickets||[]).filter(j=>j.stageId===K):M=p.snapshot.tickets||[],console.log("[EmployeeDetailsModal] Using fallback tickets from snapshot:",M.length)}catch(K){console.error("[EmployeeDetailsModal] Error using fallback tickets:",K)}w.value={context:p,tickets:M,totalCount:M.length,isLoading:!1,error:{message:y.message,hasFallback:M.length>0}},M.length>0?(o.warning("Ошибка загрузки данных. Отображаются данные из кеша."),r.value=4):(o.error("Ошибка загрузки тикетов: "+y.message),be()),console.timeEnd("[Performance] goToLevel4")}}function be(){if(r.value===4){if(w.value&&w.value.context){const p=w.value.context.sourceLevel;r.value=p}else r.value=1;w.value=null}else r.value===3?(r.value=2,k.value=null,w.value=null):r.value===2&&(r.value=1,u.value=null,k.value=null,w.value=null)}function Be(){r.value=1,l.value=null,u.value=null,k.value=null,w.value=null,c.value="time"}function we(){var K;if(!((K=w.value)!=null&&K.context))return"Нет тикетов";const{sourceLevel:p,employeeName:h,dateCategoryLabel:y,departmentName:M}=w.value.context;return p===2&&h&&y?`Нет тикетов у ${h} в категории "${y}"`:p===2&&h&&M?`Нет тикетов у ${h} у заказчика "${M}"`:p===3&&h&&M?`Нет тикетов у ${h} у заказчика "${M}"`:p===1&&y?`Нет тикетов в категории "${y}"`:p===1&&M?`Нет тикетов у заказчика "${M}"`:"Нет тикетов для отображения"}function Ie(){var h;if(!((h=w.value)!=null&&h.context))return"Попробуйте выбрать другую категорию или заказчика.";const{stageName:p}=w.value.context;return p?`На стадии "${p}" нет тикетов, соответствующих выбранным критериям.`:"Попробуйте выбрать другую категорию или заказчика."}async function Ke(){var h;if(!((h=w.value)!=null&&h.context)){console.error("[EmployeeDetailsModal] Cannot retry: context not found");return}const p=w.value.context;await ue(p)}function R(p){if(!p){console.warn("[EmployeeDetailsModal] Ticket is null or undefined"),o.warning("Ошибка: тикет не найден");return}if(!p.id){console.error("[EmployeeDetailsModal] Ticket ID is missing:",p),o.error("Ошибка: ID тикета не указан");return}try{const h=la(p.id);if(console.log("[EmployeeDetailsModal] Opening ticket:",{ticketId:p.id,iframeUrl:h}),!h||typeof h!="string"||h.length===0)throw new Error("Не удалось сформировать URL для тикета");const y=window.open(h,"_blank","noopener,noreferrer");if(!y||y.closed||typeof y.closed>"u")try{const M=document.createElement("a");M.href=h,M.target="_blank",M.rel="noopener noreferrer",M.style.display="none",document.body.appendChild(M),M.click(),document.body.removeChild(M),console.log("[EmployeeDetailsModal] Ticket opened via alternative method:",{ticketId:p.id,iframeUrl:h})}catch{throw new Error("Не удалось открыть новую вкладку. Возможно, заблокирован popup blocker. Попробуйте разрешить всплывающие окна для этого сайта.")}else console.log("[EmployeeDetailsModal] Ticket opened successfully:",{ticketId:p.id,iframeUrl:h})}catch(h){console.error("[EmployeeDetailsModal] Error opening ticket:",h),console.error("[EmployeeDetailsModal] Error details:",{message:h.message,stack:h.stack,ticket:p}),o.error("Ошибка открытия тикета: "+h.message)}}function V(){Be(),n("close")}t({reloadLevel1ForStage:ce});function de(p){p&&p.stopPropagation(),x.value=!x.value}function Se(){x.value&&(x.value=!1)}function pe(p){if(!x.value)return;const h=G.value,y=ee.value;h&&h.contains(p.target)||y&&y.contains(p.target)||(x.value=!1)}async function Ne(p){if(p.disabled){x.value=!1;return}x.value=!1,await ce(p.id)}function Ye(p){if(x.value){p.stopPropagation(),Se();return}V()}return(p,h)=>(T(),Te(Ot,{to:"body"},[s.isVisible?(T(),I("div",{key:0,class:"employee-details-modal",onClick:oe(V,["self"]),onKeydown:Xe(Ye,["esc"])},[d("div",{class:"modal-content",onClick:pe},[ve(pt,{name:"level",mode:"out-in"},{default:We(()=>{var y,M,K,j,X,ne,F,v,g,E,A,H,b,$,U,O,z,Y,P;return[r.value===1?(T(),I("div",Ua,[d("div",za,[d("div",Va,[d("button",{ref_key:"stageTriggerRef",ref:ee,class:"stage-trigger","aria-expanded":x.value,"aria-haspopup":"listbox",onClick:oe(de,["stop"]),onKeydown:[Xe(oe(de,["prevent"]),["enter"]),Xe(oe(de,["prevent"]),["space"]),Xe(oe(Se,["stop","prevent"]),["esc"])]},[d("span",{class:"stage-color",style:ye({backgroundColor:((y=l.value)==null?void 0:y.stageColor)||((j=(M=_.value)==null?void 0:M.stageColorMap)==null?void 0:j[(K=l.value)==null?void 0:K.stageId])||((ne=(X=_.value)==null?void 0:X.stageColorMap)==null?void 0:ne[s.stageId])||"#007bff"})},null,4),d("span",Ya,B(((F=l.value)==null?void 0:F.stageName)||s.stageName),1),d("span",{class:ie(["stage-caret",{open:x.value}])},"▾",2)],40,Ka),x.value?(T(),I("div",{key:0,ref_key:"stageDropdownRef",ref:G,class:"stage-dropdown",role:"listbox"},[(T(!0),I(ge,null,me(Z.value,C=>(T(),I("div",{key:C.id,class:ie(["stage-option",{disabled:C.disabled}]),role:"option","aria-selected":C.disabled,onClick:oe(W=>Ne(C),["stop"]),onKeydown:Xe(oe(W=>Ne(C),["prevent"]),["enter"])},[d("span",{class:"stage-color",style:ye({backgroundColor:C.color})},null,4),d("span",Xa,B(C.name),1)],42,Ga))),128))],512)):q("",!0)]),d("span",qa,"Всего: "+B(((v=l.value)==null?void 0:v.totalCount)||s.totalCount)+" тикетов",1),d("button",{class:"modal-close",onClick:V,"aria-label":"Закрыть"},"×")]),d("div",Ja,[d("button",{class:ie(["view-switch-btn",{active:i.value==="employees"}]),onClick:h[0]||(h[0]=C=>i.value="employees"),title:"Отображение по сотрудникам"}," 👥 По сотрудникам ",2),d("button",{class:ie(["view-switch-btn",{active:i.value==="time"}]),onClick:h[1]||(h[1]=C=>i.value="time"),title:"Отображение по временным градациям"}," 📅 По времени ",2),d("button",{class:ie(["view-switch-btn",{active:i.value==="departments"}]),onClick:h[2]||(h[2]=C=>i.value="departments"),title:"Отображение по заказчикам"}," 🏢 По заказчикам ",2)]),d("div",Za,[S.value?(T(),I("div",Qa,[d("span",null,"Ошибка: "+B(S.value),1),d("button",{class:"btn-retry-stage",onClick:h[3]||(h[3]=C=>{var W;return ce(((W=l.value)==null?void 0:W.stageId)||s.stageId)})}," Повторить ")])):q("",!0),D.value?(T(),I("div",es,[...h[7]||(h[7]=[d("div",{class:"loading-spinner small"},null,-1),d("span",null,"Загрузка стадии...",-1)])])):q("",!0),i.value==="employees"?(T(),I("div",ts,[(((g=l.value)==null?void 0:g.employees)||s.employees).length===0&&(!((E=l.value)!=null&&E.others||s.others)||(((A=l.value)==null?void 0:A.others)||s.others).count===0)?(T(),I("div",as," Нет данных о сотрудниках ")):(T(),I("div",ss,[(T(!0),I(ge,null,me(((H=l.value)==null?void 0:H.employees)||s.employees,C=>(T(),I("div",{key:C.id,class:ie(["employee-item",{"employee-keeper":C.isKeeper}]),onClick:oe(W=>Pe(C,W),["stop"]),title:"Кликните для детализации по временным градациям"},[d("span",os,B(C.name),1),d("div",rs,[d("div",{class:"progress-bar",style:ye({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),d("span",ls,B(C.count)+" тикетов ("+B(C.percentage)+"%) ",1),h[8]||(h[8]=d("span",{class:"employee-arrow"},"→",-1))],10,ns))),128)),((b=l.value)!=null&&b.others||s.others)&&((($=l.value)==null?void 0:$.others)||s.others).count>0?(T(),I("div",is,[d("span",cs,"Другие ("+B((((U=l.value)==null?void 0:U.others)||s.others).employeeCount)+")",1),d("div",us,[d("div",{class:"progress-bar",style:ye({width:(((O=l.value)==null?void 0:O.others)||s.others).progressBarWidth+"%",backgroundColor:(((z=l.value)==null?void 0:z.others)||s.others).progressBarColor})},null,4)]),d("span",ds,B((((Y=l.value)==null?void 0:Y.others)||s.others).count)+" тикетов ("+B((((P=l.value)==null?void 0:P.others)||s.others).percentage)+"%) ",1)])):q("",!0)]))])):i.value==="time"?(T(),I("div",ps,[f.value.length===0?(T(),I("div",gs," Загрузка данных... ")):(T(),I("div",ms,[(T(!0),I(ge,null,me(f.value,C=>(T(),I("div",{key:C.category,class:"category-item",onClick:oe(W=>ke(C),["stop"])},[d("span",hs,B(C.label),1),d("div",ys,[d("div",{class:"progress-bar",style:ye({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),d("span",vs,B(C.count)+" тикетов ("+B(C.percentage)+"%) ",1),h[9]||(h[9]=d("span",{class:"category-arrow"},"→",-1))],8,fs))),128))]))])):i.value==="departments"?(T(),I("div",ks,[m.value.length===0?(T(),I("div",bs," Загрузка данных... ")):(T(),I("div",ws,[d("table",Ss,[h[11]||(h[11]=d("thead",null,[d("tr",null,[d("th",{class:"col-department"},"Заказчик"),d("th",{class:"col-count"},"Количество тикетов"),d("th",{class:"col-action"})])],-1)),d("tbody",null,[(T(!0),I(ge,null,me(m.value,(C,W)=>(T(),I("tr",{key:W,class:"department-row",onClick:oe(J=>Ae(C),["stop"]),title:"Кликните для просмотра тикетов"},[d("td",Ds,[d("span",Cs,B(C.departmentName),1)]),d("td",_s,[d("span",Ts,B(C.count),1)]),h[10]||(h[10]=d("td",{class:"col-action"},[d("span",{class:"department-arrow"},"→")],-1))],8,Es))),128))])])]))])):q("",!0)])])):r.value===2&&u.value?(T(),I("div",As,[d("div",Is,[d("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),d("h3",null,B(u.value.employeeName),1),d("span",Ns,"Всего: "+B(u.value.totalCount)+" тикетов",1),d("button",{class:"modal-close",onClick:V,"aria-label":"Закрыть"},"×")]),d("div",Ms,[d("div",$s,[d("span",Fs,B(u.value.stageName),1),d("div",Hs,[d("button",{class:ie(["level2-sort-btn",{active:c.value==="time"}]),onClick:h[4]||(h[4]=C=>c.value="time"),title:"Сортировка по времени"}," По времени ",2),d("button",{class:ie(["level2-sort-btn",{active:c.value==="departments"}]),onClick:h[5]||(h[5]=C=>c.value="departments"),title:"Сортировка по заказчикам"}," По заказчикам ",2)])]),c.value==="time"?(T(),I("div",Ls,[u.value.dateCategories.length===0?(T(),I("div",Rs," Нет данных о тикетах ")):(T(),I("div",Ps,[(T(!0),I(ge,null,me(u.value.dateCategories,C=>(T(),I("div",{key:C.category,class:"category-item",onClick:oe(W=>xe(C),["stop"])},[d("span",Bs,B(C.label),1),d("div",Os,[d("div",{class:"progress-bar",style:ye({width:C.progressBarWidth+"%",backgroundColor:C.progressBarColor})},null,4)]),d("span",js,B(C.count)+" тикетов ("+B(C.percentage)+"%) ",1)],8,xs))),128))]))])):(T(),I("div",Ws,[!u.value.departments||u.value.departments.length===0?(T(),I("div",Us,[h[12]||(h[12]=Bt(" Для выбранного сотрудника заказчики не найдены ",-1)),d("button",{class:"btn-retry-stage",onClick:h[6]||(h[6]=C=>Pe({id:u.value.employeeId,name:u.value.employeeName}))}," Обновить ")])):(T(),I("div",zs,[d("table",Vs,[h[14]||(h[14]=d("thead",null,[d("tr",null,[d("th",{class:"col-department"},"Заказчик"),d("th",{class:"col-count"},"Количество тикетов"),d("th",{class:"col-action"})])],-1)),d("tbody",null,[(T(!0),I(ge,null,me(u.value.departments,(C,W)=>(T(),I("tr",{key:W,class:"department-row",onClick:oe(J=>Ve(C),["stop"]),title:"Кликните для просмотра тикетов"},[d("td",Ys,[d("span",Gs,B(C.departmentName),1)]),d("td",Xs,[d("span",qs,B(C.count),1)]),h[13]||(h[13]=d("td",{class:"col-action"},[d("span",{class:"department-arrow"},"→")],-1))],8,Ks))),128))])])]))]))])])):r.value===3&&k.value?(T(),I("div",Js,[d("div",Zs,[d("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),d("div",Qs,[d("h3",null,B(k.value.employeeName),1),d("div",en,[d("span",tn,B(k.value.dateCategoryLabel),1),d("span",an,B(k.value.stageName),1)])]),d("span",sn,"Всего: "+B(k.value.totalCount)+" тикетов",1),d("button",{class:"modal-close",onClick:V,"aria-label":"Закрыть"},"×")]),d("div",nn,[k.value.departments.length===0?(T(),I("div",on," Нет данных о заказчиках ")):(T(),I("div",rn,[d("table",ln,[h[16]||(h[16]=d("thead",null,[d("tr",null,[d("th",{class:"col-department"},"Заказчик"),d("th",{class:"col-count"},"Количество тикетов"),d("th",{class:"col-action"})])],-1)),d("tbody",null,[(T(!0),I(ge,null,me(k.value.departments,(C,W)=>(T(),I("tr",{key:W,class:"department-row",onClick:oe(J=>fe(C),["stop"]),title:"Кликните для просмотра тикетов"},[d("td",un,[d("span",dn,B(C.departmentName),1)]),d("td",pn,[d("span",gn,B(C.count),1)]),h[15]||(h[15]=d("td",{class:"col-action"},[d("span",{class:"department-arrow"},"→")],-1))],8,cn))),128))])])]))])])):r.value===4&&w.value?(T(),I("div",mn,[d("div",fn,[d("button",{class:"btn-back",onClick:be,"aria-label":"Назад"}," ← "),d("div",hn,[d("h3",null,B(re.value),1),w.value.context?(T(),I("div",yn,[w.value.context.dateCategoryLabel?(T(),I("span",vn,B(w.value.context.dateCategoryLabel),1)):q("",!0),w.value.context.departmentName?(T(),I("span",kn,B(w.value.context.departmentName),1)):q("",!0),d("span",bn,B(w.value.context.stageName),1)])):q("",!0)]),d("span",wn,"Всего: "+B(w.value.totalCount)+" тикетов",1),d("button",{class:"modal-close",onClick:V,"aria-label":"Закрыть"},"×")]),d("div",Sn,[ve(pt,{name:"loading",mode:"out-in"},{default:We(()=>[w.value.isLoading?(T(),I("div",En,[...h[17]||(h[17]=[d("div",{class:"loading-spinner"},null,-1),d("p",null,"Загрузка тикетов...",-1)])])):w.value.error&&w.value.error.hasFallback?(T(),I("div",Dn,[h[18]||(h[18]=d("div",{class:"error-banner"},[d("span",{class:"error-icon"},"⚠️"),d("span",{class:"error-message"},"Ошибка загрузки данных. Отображаются данные из кеша.")],-1)),d("div",Cn,[ve(It,{name:"ticket",tag:"div",class:"tickets-list"},{default:We(()=>[(T(!0),I(ge,null,me(w.value.tickets,(C,W)=>(T(),Te(Lt,{key:C.id,ticket:C,draggable:!1,style:ye({"--ticket-index":W}),onClick:J=>R(C)},null,8,["ticket","style","onClick"]))),128))]),_:1})])])):w.value.error&&!w.value.error.hasFallback?(T(),I("div",_n,[h[19]||(h[19]=d("div",{class:"error-icon"},"❌",-1)),h[20]||(h[20]=d("h3",{class:"error-title"},"Ошибка загрузки данных",-1)),d("p",Tn,B(w.value.error.message),1),d("button",{class:"btn-retry",onClick:Ke},"Повторить попытку")])):!w.value.tickets||w.value.tickets.length===0?(T(),I("div",An,[h[21]||(h[21]=d("div",{class:"empty-state-icon"},"📭",-1)),d("h3",In,B(we()),1),d("p",Nn,B(Ie()),1)])):(T(),I("div",Mn,[ve(It,{name:"ticket",tag:"div",class:"tickets-list"},{default:We(()=>[(T(!0),I(ge,null,me(w.value.tickets,(C,W)=>(T(),Te(Lt,{key:C.id,ticket:C,draggable:!1,style:ye({"--ticket-index":W}),onClick:J=>R(C)},null,8,["ticket","style","onClick"]))),128))]),_:1})]))]),_:1})])])):q("",!0)]}),_:1})])],32)):q("",!0)]))}},Fn=et($n,[["__scopeId","data-v-65ca978e"]]);function Hn(s,t,e=.5){if(!t||!Array.isArray(t)||t.length===0||typeof s!="number"||s<0)return 0;(typeof e!="number"||e<=0)&&(console.warn("getOverlapCount: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=[];if(t.forEach((r,c)=>{if(!r||!r.data||!Array.isArray(r.data))return;const i=r.data[s];i!=null&&!isNaN(i)&&a.push({datasetIndex:c,value:Number(i),y:Number(i)})}),a.length<2)return 0;const n=[];return a.forEach(r=>{let c=!1;for(const i of n){const l=i.y;if(Math.abs(r.y-l)<e){i.points.push(r),i.y=i.points.reduce((m,u)=>m+u.y,0)/i.points.length,c=!0;break}}c||n.push({points:[r],y:r.y})}),n.length===0?0:n.reduce((r,c)=>c.points.length>r.points.length?c:r,n[0]).points.length}function Ln(s,t){const e=[];return s.forEach(a=>{let n=!1;for(const o of e){const r=o.y;if(Math.abs(a.value-r)<t){o.points.push(a),o.y=o.points.reduce((c,i)=>c+i.value,0)/o.points.length,n=!0;break}}n||e.push({points:[a],y:a.value})}),e}function Rn(s,t=.5){var o,r;if(!s)return console.warn("findOverlappingPoints: chart не передан"),[];if(!s.config||s.config.type!=="line")return[];const e=(o=s.data)==null?void 0:o.datasets,a=((r=s.data)==null?void 0:r.labels)||[];if(!e||!Array.isArray(e)||e.length===0)return[];if(!Array.isArray(a)||a.length===0)return[];(typeof t!="number"||t<=0)&&(console.warn("findOverlappingPoints: threshold должен быть положительным числом, используется 0.5"),t=.5);const n=[];return a.forEach((c,i)=>{try{if(Hn(i,e,t)<2)return;const f=[];if(e.forEach((_,D)=>{if(!_||!_.data||!Array.isArray(_.data))return;const S=_.data[i];S==null||isNaN(S)||f.push({datasetIndex:D,value:Number(S),label:_.label||`Dataset ${D}`})}),f.length<2)return;const m=Ln(f,t);if(m.length===0)return;const u=m.reduce((_,D)=>D.points.length>_.points.length?D:_,m[0]);if(u.points.length<2)return;let k=null,w=null;for(let _=0;_<e.length;_++)try{const D=s.getDatasetMeta(_);if(D&&D.data&&D.data[i]){k=D,w=D.data[i];break}}catch{continue}if(!w||typeof w.x!="number"||typeof w.y!="number")return;n.push({position:i,count:u.points.length,x:w.x,y:w.y,value:u.y,points:u.points.map(_=>({datasetIndex:_.datasetIndex,value:_.value,label:_.label}))})}catch(l){console.warn(`findOverlappingPoints: ошибка при обработке позиции ${i}:`,l)}}),n}function Pn(s,t){const e=[];return s.forEach(a=>{let n=!1;for(const o of e){const r=o.y;if(Math.abs(a.y-r)<t){o.points.push(a),o.y=o.points.reduce((c,i)=>c+i.y,0)/o.points.length,n=!0;break}}n||e.push({points:[a],y:a.y})}),e}function xn(s,t,e=.5){var l,f;if(!s)return console.warn("calculatePointJitter: chart не передан"),[];if(!s.config||s.config.type!=="line")return[];if(typeof t!="number"||t<0)return console.warn("calculatePointJitter: positionIndex должен быть неотрицательным числом"),[];(typeof e!="number"||e<=0)&&(console.warn("calculatePointJitter: threshold должен быть положительным числом, используется 0.5"),e=.5);const a=(l=s.data)==null?void 0:l.datasets,n=((f=s.data)==null?void 0:f.labels)||[];if(!a||!Array.isArray(a)||a.length===0)return[];if(!Array.isArray(n)||t>=n.length)return[];const o=[];if(a.forEach((m,u)=>{if(!m||!m.data||!Array.isArray(m.data))return;const k=m.data[t];if(!(k==null||isNaN(k)))try{const w=s.getDatasetMeta(u);if(w&&w.data&&w.data[t]){const _=w.data[t];_&&typeof _.x=="number"&&typeof _.y=="number"&&o.push({datasetIndex:u,value:Number(k),x:_.x,y:_.y})}}catch(w){console.warn(`calculatePointJitter: ошибка при получении meta для dataset ${u}:`,w)}}),o.length===0)return[];const r=Pn(o,e),c=[];r.forEach(m=>{const u=m.points||[];u.length>1?u.forEach((w,_)=>{const D=(_-(u.length-1)/2)*4;c.push({datasetIndex:w.datasetIndex,jitterX:D,value:w.value})}):u.length===1&&c.push({datasetIndex:u[0].datasetIndex,jitterX:0,value:u[0].value})});const i=new Set(c.map(m=>m.datasetIndex));return o.forEach(m=>{i.has(m.datasetIndex)||c.push({datasetIndex:m.datasetIndex,jitterX:0,value:m.value})}),c}const Bn=.5,xt=6,On=2;function jn(s){return typeof s!="number"||s<2?xt:xt+(s-1)*On}function Wn(s,t){if(!s||!s.ctx){console.warn("drawEnlargedPoint: chart или ctx недоступен");return}if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("drawEnlargedPoint: невалидные координаты overlap",t);return}const e=t.count;if(typeof e!="number"||e<2)return;const a=s.ctx,{x:n,y:o,points:r}=t,c=jn(e);if(a.canvas){a.save();try{a.beginPath(),a.arc(n,o,c,0,2*Math.PI);let l="rgba(128, 128, 128, 0.3)";if(r&&r.length>0&&s.data&&s.data.datasets){const f=r[0].datasetIndex,m=s.data.datasets[f];if(m&&m.pointBackgroundColor){const u=Array.isArray(m.pointBackgroundColor)?m.pointBackgroundColor[t.position]||m.pointBackgroundColor[0]:m.pointBackgroundColor;if(u)if(u.startsWith("#")){const k=parseInt(u.slice(1,3),16),w=parseInt(u.slice(3,5),16),_=parseInt(u.slice(5,7),16);l=`rgba(${k}, ${w}, ${_}, 0.4)`}else u.startsWith("rgba")?l=u.replace(/rgba?\(([^)]+)\)/,(k,w)=>{const _=w.split(",").map(D=>D.trim());return`rgba(${_[0]}, ${_[1]}, ${_[2]}, 0.4)`}):l=u+"66"}}a.fillStyle=l,a.fill(),a.strokeStyle=l.replace("0.4","0.6").replace("66","99"),a.lineWidth=1,a.stroke()}catch(l){console.warn("drawEnlargedPoint: ошибка при отрисовке увеличенной точки:",l)}finally{a.restore()}}}const Un={id:"overlappingPointsPlugin",afterDatasetsDraw:s=>{if(!(!s||!s.config||s.config.type!=="line")&&s.ctx)try{const t=Rn(s,Bn);if(!Array.isArray(t)||t.length===0)return;t.filter(a=>!(!a||typeof a!="object"||typeof a.count!="number"||a.count<2||typeof a.x!="number"||typeof a.y!="number"||!isFinite(a.x)||!isFinite(a.y))).forEach(a=>{try{Wn(s,a)}catch(n){console.warn(`overlappingPointsPlugin: ошибка при отрисовке увеличенной точки для позиции ${a.position}:`,n)}})}catch(t){console.warn("overlappingPointsPlugin: ошибка в afterDatasetsDraw:",t)}}},zn=.5,Vn={id:"pointJitterPlugin",beforeDatasetsDraw:s=>{var t,e;if(!(!s||!s.config||s.config.type!=="line")){s._jitterData||(s._jitterData={});try{const a=(t=s.data)==null?void 0:t.datasets,n=((e=s.data)==null?void 0:e.labels)||[];if(!a||!Array.isArray(a)||a.length===0||!Array.isArray(n)||n.length===0)return;s._jitterData={},n.forEach((o,r)=>{const c=xn(s,r,zn);c&&c.length>0&&c.forEach(i=>{const l=`${i.datasetIndex}_${r}`;s._jitterData[l]=i.jitterX})})}catch(a){console.warn("pointJitterPlugin: ошибка в beforeDatasetsDraw:",a)}}},afterDatasetsDraw:s=>{var t;if(!(!s||!s.config||s.config.type!=="line")&&s.ctx&&!(!s._jitterData||Object.keys(s._jitterData).length===0))try{const e=s.ctx,a=(t=s.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((n,o)=>{const r=s.getDatasetMeta(o);!r||r.hidden||!n.data||!Array.isArray(n.data)||n.data.forEach((c,i)=>{const l=r.data[i];if(!l||typeof l.x!="number"||typeof l.y!="number"||c==null||isNaN(c))return;const f=`${o}_${i}`,m=s._jitterData[f];if(!(m===void 0||m===0)){e.save();try{const u=n.pointStyle||"circle",k=(n.pointRadius||7)+1,w=Array.isArray(n.pointBackgroundColor)?n.pointBackgroundColor[i]||n.pointBackgroundColor[0]:n.pointBackgroundColor,_=Array.isArray(n.pointBorderColor)?n.pointBorderColor[i]||n.pointBorderColor[0]:n.pointBorderColor,D=n.pointBorderWidth||1,S=l.x+m,N=l.y;switch(e.fillStyle=w||"#007bff",e.strokeStyle=_||"#ffffff",e.lineWidth=D,e.beginPath(),u){case"circle":e.arc(S,N,k,0,2*Math.PI);break;case"triangle":e.moveTo(S,N-k),e.lineTo(S-k,N+k),e.lineTo(S+k,N+k),e.closePath();break;case"rect":case"rectRounded":const x=k*1.4;e.rect(S-x/2,N-x/2,x,x);break;case"rectRot":const G=k*1.4;e.moveTo(S,N-G/2),e.lineTo(S+G/2,N),e.lineTo(S,N+G/2),e.lineTo(S-G/2,N),e.closePath();break;case"star":const ee=k;for(let se=0;se<5;se++){const Q=se*4*Math.PI/5-Math.PI/2,ce=S+ee*Math.cos(Q),fe=N+ee*Math.sin(Q);se===0?e.moveTo(ce,fe):e.lineTo(ce,fe)}e.closePath();break;case"cross":const Z=k;e.moveTo(S-Z,N-Z),e.lineTo(S+Z,N+Z),e.moveTo(S+Z,N-Z),e.lineTo(S-Z,N+Z);break;case"crossRot":const re=k;e.moveTo(S-re,N),e.lineTo(S+re,N),e.moveTo(S,N-re),e.lineTo(S,N+re);break;default:e.arc(S,N,k,0,2*Math.PI)}u!=="cross"&&u!=="crossRot"&&e.fill(),e.stroke(),l._originalX||(l._originalX=l.x,l._originalY=l.y),l._jitterX=m,l._jitteredX=S,l._jitteredY=N}catch(u){console.warn(`pointJitterPlugin: ошибка при отрисовке точки ${o}_${i}:`,u)}finally{e.restore()}}})})}catch(e){console.warn("pointJitterPlugin: ошибка в afterDatasetsDraw:",e)}},afterDraw:s=>{s._jitterData}},Kn={id:"pointLabelsPlugin",afterDatasetsDraw:s=>{var t;if(!(!s||!s.config||s.config.type!=="line")&&s.ctx)try{const e=s.ctx,a=(t=s.data)==null?void 0:t.datasets;if(!a||!Array.isArray(a)||a.length===0)return;a.forEach((n,o)=>{const r=s.getDatasetMeta(o);if(!r||r.hidden||!n.data||!Array.isArray(n.data))return;const c=Array.isArray(n.pointBackgroundColor)?n.pointBackgroundColor[0]||"#6b7280":n.pointBackgroundColor||"#6b7280";n.data.forEach((i,l)=>{const f=r.data[l];if(!f||typeof f.x!="number"||typeof f.y!="number"||i==null||isNaN(i))return;const m=f._jitteredX!==void 0?f._jitteredX:f.x,u=f._jitteredY!==void 0?f._jitteredY:f.y,k=m+8,w=u-5,_=String(Math.round(i));e.save();try{e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle";const S=e.measureText(_).width,N=11,x=3,G=k-x,ee=w-N/2-x,Z=S+x*2,re=N+x*2;e.fillStyle="rgba(255, 255, 255, 0.95)",e.fillRect(G,ee,Z,re),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.strokeRect(G,ee,Z,re),e.fillStyle=c,e.font="11px Arial, sans-serif",e.textAlign="left",e.textBaseline="middle",e.fillText(_,k,w)}catch(D){console.warn(`pointLabelsPlugin: ошибка при отрисовке подписи для точки ${o}_${l}:`,D)}finally{e.restore()}})})}catch(e){console.warn("pointLabelsPlugin: ошибка в afterDatasetsDraw:",e)}}},Yn={class:"graph-state-chart"},Gn={class:"chart-header"},Xn={class:"chart-type-selector"},qn=["onClick","title"],Jn={class:"chart-type-icon"},Zn={class:"chart-type-label"},Qn={key:0,class:"comparison-type-selector"},eo={class:"radio-group"},to={key:0},ao={key:1},so={key:2,class:"graph-legend"},no={key:4,class:"error-container"},oo={class:"error-message"},ro={class:"chart-wrapper"},lo={class:"chart-canvas-container"},io={key:0,class:"bar-chart-stage-labels"},co={key:6,class:"no-data"},uo={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(s,{emit:t}){const e=(v,g)=>typeof window>"u"?g:getComputedStyle(document.documentElement).getPropertyValue(v).trim()||g,a=s,n=t,o=L(!1),r=L(null),c=L(null),i=L({weekStart:null,weekEnd:null,current:null}),l=L(null),f=L("weekStartToWeekEnd"),m=[{value:"line",label:"Линейный",icon:"📈"},{value:"bar",label:"Столбчатый",icon:"📊"},{value:"doughnut",label:"Круговая",icon:"🍩"}],u=L("line"),k=L(!1),w=L(""),_=L(""),D=L(0),S=L([]),N=L(null),x=L(null),G=L(null),ee=L(null),Z=L([]),re=ae(()=>{switch(u.value){case"line":return Nt;case"bar":return aa;case"doughnut":return ta;default:return Nt}}),se={formed:e("--b24-primary","#007bff"),review:e("--b24-warning","#ffc107"),execution:e("--b24-success","#28a745")},Q=[{id:"formed",name:"Сформировано обращение",color:se.formed},{id:"review",name:"Рассмотрение ТЗ",color:se.review},{id:"execution",name:"Исполнение",color:se.execution}],ce=ae(()=>Q.reduce((v,g)=>(v[g.id]=g.name,v),{})),fe=["circle","triangle","rect","rectRot","star","cross","crossRot"],Ae=L({formed:!0,review:!0,execution:!0}),ke=tt(),Pe={id:"employeeLabelsPlugin",afterDatasetsDraw:v=>{if(v.config.type==="bar")try{const g=v.ctx;if(!v.data||!v.data.datasets)return;const E=v.data.datasets,A=v.scales.y;E.forEach((H,b)=>{const $=v.getDatasetMeta(b);if(!$||$.hidden)return;const U=H.label||"";if(!U||U.includes("Другие"))return;const O=U.trim().split(/\s+/);let z="";if(O.length===1)z=O[0];else{const P=O[0],C=O.slice(1).join(" ");z=`${P}
${C}`}const Y=z.split(`
`);H.data.forEach((P,C)=>{if(P===0||!P)return;const W=$.data[C];if(!W||typeof W.x!="number"||typeof W.y!="number")return;const J=W.x,he=W.y+W.height+25;g.save(),g.font="bold 9px Arial, sans-serif",g.fillStyle="#6b7280",g.textAlign="center",g.textBaseline="top",g.translate(J,he),g.rotate(-12*Math.PI/180),Y.forEach((Ee,Me)=>{const $e=Ee.trim();$e&&g.fillText($e,0,Me*11)}),g.restore()})})}catch(g){console.error("Error in employeeLabelsPlugin:",g)}}},Ve={id:"doughnutCenterTextPlugin",afterDraw:v=>{var W;if(v.config.type!=="doughnut")return;const{ctx:g,chartArea:E,width:A,height:H}=v;if(!v.data||!v.data.datasets||v.data.datasets.length===0)return;const b=v.data.datasets[0].meta,$=((W=b==null?void 0:b.totals)==null?void 0:W.overall)??null;if($===null||typeof $>"u")return;const U=["Всего в секторе 1С","тикетов в работе:",`${$}`];g.save(),g.font='600 16px "Roboto", sans-serif',g.fillStyle=e("--b24-text-primary","#1f2937"),g.textAlign="center",g.textBaseline="middle";const O=(E.left+E.right)/2,z=(E.top+E.bottom)/2,Y=18,P=Y*U.length,C=z-P/2+4;U.forEach((J,he)=>{he===U.length-1&&`${J}`.length>4?g.font='700 18px "Roboto", sans-serif':g.font='600 16px "Roboto", sans-serif',g.fillText(J,O,C+he*Y)}),g.restore()}};qe.register(Pe),qe.register(Ve);function xe(){const v=new Map;[i.value.weekStart,i.value.weekEnd,i.value.current].forEach(g=>{!g||!g.statistics||!g.statistics.employees||g.statistics.employees.forEach(E=>{v.has(E.id)||v.set(E.id,{id:E.id,name:E.name})})}),Z.value=Array.from(v.values()).sort((g,E)=>g.name.localeCompare(E.name))}function ue(v,g="background"){var A;return((A={increase:{background:e("--b24-success","#28a745"),border:e("--b24-success-hover","#218838"),point:e("--b24-success","#28a745")},decrease:{background:e("--b24-danger","#dc3545"),border:e("--b24-danger-hover","#c82333"),point:e("--b24-danger","#dc3545")},stable:{background:e("--b24-text-muted","#9ca3af"),border:e("--b24-text-secondary","#6b7280"),point:e("--b24-text-muted","#9ca3af")}}[v])==null?void 0:A[g])||e("--b24-text-secondary","#6c757d")}function be(){if(!(!i.value.weekStart||!i.value.weekEnd))try{const v=ut.compareTwoSnapshots(i.value.weekStart,i.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let g=null,E=null;i.value.current&&(g=ut.compareTwoSnapshots(i.value.weekEnd,i.value.current,{includeTickets:!1,includeEmployees:!0}),E=ut.compareTwoSnapshots(i.value.weekStart,i.value.current,{includeTickets:!1,includeEmployees:!0})),l.value={weekStartToWeekEnd:v,weekEndToCurrent:g,weekStartToCurrent:E}}catch(v){console.error("Ошибка сравнения слепков:",v),ke.warning("Не удалось выполнить сравнение слепков: "+v.message)}}function Be(v){return v?v.replace(/\s*\(\d+\)\s*$/,"").trim():""}function we(v){const g=Be(v);return{"Сформировано обращение":"formed","Рассмотрение ТЗ":"review",Исполнение:"execution"}[g]||"formed"}function Ie(v){return we(v)}function Ke(v){return v===0?"weekStart":v===1?"weekEnd":v===2?"current":"weekEnd"}function R(v,g,E,A,H=null,b=null,$=null,U=null){var O;console.log("[GraphStateChart] openEmployeeDetailsModal called:",{stageName:v,stageId:g,totalCount:E,employeesCount:(A==null?void 0:A.length)||0,hasSnapshot:!!b,snapshotTicketIds:((O=b==null?void 0:b.ticketIds)==null?void 0:O.length)||0}),w.value=v,_.value=g||"",D.value=E,S.value=A||[],N.value=H&&H.count>0?H:null,x.value=b,G.value=$,ee.value=U,k.value=!0,console.log("[GraphStateChart] Modal state set:",{modalStageId:_.value,hasCurrentSnapshot:!!x.value})}async function V(v,g,E){var b,$,U,O,z,Y,P;console.log("[GraphStateChart] openEmployeeDetailsModalForLine:",{stageId:v,timePoint:g,hasMeta:!!E});const A=Q.find(C=>C.id===v);if(!A){console.warn("[GraphStateChart] Stage not found:",v);return}const H={graphType:"line",stageId:v,stageName:A.name,timePoint:g,snapshots:i.value,meta:{line:E||null,doughnut:((U=($=(b=c.value)==null?void 0:b.datasets)==null?void 0:$[0])==null?void 0:U.meta)||null},stageColorMap:se,stageNameMap:ce.value};try{const C=await Xt({stageId:v,graphType:"line",timePoint:g,snapshots:i.value,meta:{line:E||null,doughnut:((Y=(z=(O=c.value)==null?void 0:O.datasets)==null?void 0:z[0])==null?void 0:Y.meta)||null},stageColorMap:se,stageNameMap:ce.value,maxVisible:10});console.log("[GraphStateChart] Opening modal with level1:",{stageName:C.stageName,stageId:v,totalCount:C.totalCount,employeesCount:((P=C.employees)==null?void 0:P.length)||0,hasSnapshot:!!C.snapshot}),R(C.stageName,v,C.totalCount,C.employees,C.others,C.snapshot,null,H)}catch(C){console.error("[GraphStateChart] Failed to open modal for line point:",C),ke.error("Не удалось открыть попап для выбранной точки графика")}}function de(v,g){var H,b,$;if(!g||!g.employees||g.employees.length===0){ke.warning("Нет данных о сотрудниках для этого этапа");return}const E=i.value.current||i.value.weekEnd||i.value.weekStart,A={graphType:"doughnut",stageId:v,stageName:g.stageName,snapshots:i.value,meta:{doughnut:(($=(b=(H=c.value)==null?void 0:H.datasets)==null?void 0:b[0])==null?void 0:$.meta)||null},stageColorMap:se,stageNameMap:ce.value};R(g.stageName,v,g.totalCount,g.employees,g.others,E,null,A)}function Se(){k.value=!1,w.value="",_.value="",D.value=0,S.value=[],N.value=null,x.value=null,G.value=null}async function pe(v,g,E){if(u.value!=="line"||g.length===0)return;const A=g[0],H=A.datasetIndex,b=A.index,$=E.data.datasets[H];if(!$)return;const U=Ie($.label),O=Ke(b);await V(U,O,$.meta||null)}function Ne(v,g,E){var Y,P;if(u.value!=="doughnut"||g.length===0)return;const H=g[0].index,b=E.data,$=b.labels[H],U=Ie($),O=(P=(Y=b.datasets[0])==null?void 0:Y.meta)==null?void 0:P.employees,z=O==null?void 0:O[U];if(!z){console.warn("Данные о сотрудниках не найдены для этапа:",U);return}de(U,z)}function Ye(v){var A;const g=Q[v];if(!g)return 0;const E=i.value.current||i.value.weekEnd||i.value.weekStart;return!E||!E.statistics||!E.statistics.stages?0:((A=E.statistics.stages[g.id])==null?void 0:A.count)||0}function p(v){var H;const g=Q.find(b=>b.id===v);if(!g)return"";const E=i.value.current||i.value.weekEnd||i.value.weekStart;if(!E||!E.statistics||!E.statistics.stages)return g.name;const A=((H=E.statistics.stages[v])==null?void 0:H.count)||0;return`${g.name} (${A})`}const h=ae(()=>{if(!c.value)return null;if(u.value==="doughnut"||u.value==="bar")return c.value;const v=c.value.datasets.filter(g=>{const E=Q.find(A=>A.name===g.label);return E?Ae.value[E.id]:!0});return{...c.value,datasets:v}});ae(()=>u.value!=="bar"||!c.value||!c.value.meta?null:c.value.meta.employeesByStage||null);const y=ae(()=>{const v={responsive:!0,maintainAspectRatio:!1,resizeDelay:0,layout:{padding:u.value==="bar"?{bottom:80}:{}},onClick:(g,E,A)=>{u.value==="line"?pe(g,E,A):u.value==="doughnut"&&Ne(g,E,A)},onHover:(g,E,A)=>{u.value==="doughnut"&&(g.native.target.style.cursor=E.length>0?"pointer":"default")},plugins:{legend:{display:u.value!=="bar",position:u.value==="doughnut"?"right":"top",labels:{font:{size:u.value==="doughnut"?14:12,weight:u.value==="doughnut"?"600":"500"},boxWidth:u.value==="doughnut"?18:12,boxHeight:u.value==="doughnut"?18:12,padding:u.value==="doughnut"?14:10},onClick:(g,E,A)=>{if(u.value==="bar"){const b=E.datasetIndex;if(b!==void 0){const $=A.chart.getDatasetMeta(b);$.hidden=!$.hidden,A.chart.update()}return}const H=E.datasetIndex;if(H!==void 0){const b=A.chart.getDatasetMeta(H);b.hidden=!b.hidden,A.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:g=>{if(u.value==="bar"){const E=g[0].dataIndex,A=Q[E];return A?A.name:""}return g[0].label||""},label:g=>{var b,$,U,O,z,Y;const E=g.dataset.label||"",A=g.parsed.y||g.parsed||0,H=g.dataIndex;if(u.value==="bar"){const P=g.dataset,C=g.dataIndex,W=Q[C],J=W?W.name:"";return`${P.label}: ${A} тикетов на этапе "${J}"`}if(u.value==="doughnut"){const P=g.dataset.data.reduce((W,J)=>W+J,0),C=P>0?(A/P*100).toFixed(1):0;return`${E}: ${A} тикетов (${C}%)`}else{if(!l.value||H===0)return`${E}: ${A} тикетов`;let P=null;const C=we(E);if(f.value==="weekStartToWeekEnd"&&H===1?P=($=(b=l.value.weekStartToWeekEnd)==null?void 0:b.stages)==null?void 0:$[C]:f.value==="weekEndToCurrent"&&H===2&&i.value.current?P=(O=(U=l.value.weekEndToCurrent)==null?void 0:U.stages)==null?void 0:O[C]:f.value==="weekStartToCurrent"&&H===2&&i.value.current&&(P=(Y=(z=l.value.weekStartToCurrent)==null?void 0:z.stages)==null?void 0:Y[C]),!P)return`${E}: ${A} тикетов`;const W=P.delta,J=P.deltaPercent,he=P.trend;let Ee=`${E}: ${A} тикетов`;if(W!==0){const Me=W>0?"+":"",$e=he==="increase"?"↑":he==="decrease"?"↓":"→";Ee+=` (${Me}${W}, ${Me}${J.toFixed(1)}%) ${$e}`}else Ee+=" (без изменений)";return Ee}},afterBody:g=>{if(u.value==="bar"&&g.length>0){const b=g[0];b.dataset;const $=b.parsed.y||0,U=b.dataIndex,O=Ye(U);return[`${O>0?($/O*100).toFixed(1):0}% от общего количества этапа`]}if(u.value==="doughnut"&&g.length>0)return["Кликните для детализации по сотрудникам"];if(u.value==="line"){const b=[];if(l.value){const $=g[0].dataIndex;if($!==0){let U=null;if(we(g[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&$===1?U=l.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&$===2?U=l.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&$===2&&(U=l.value.weekStartToCurrent),U&&U.metadata){const O=U.metadata.timeDiff;b.push(`Период: ${O.days} дн. ${O.hours} ч. ${O.minutes} мин.`)}}}return b.push("Кликните для детализации по сотрудникам"),b}if(!l.value)return[];const E=g[0].dataIndex;if(E===0)return[];let A=null;if(we(g[0].dataset.label||""),f.value==="weekStartToWeekEnd"&&E===1?A=l.value.weekStartToWeekEnd:f.value==="weekEndToCurrent"&&E===2?A=l.value.weekEndToCurrent:f.value==="weekStartToCurrent"&&E===2&&(A=l.value.weekStartToCurrent),!A||!A.metadata)return[];const H=A.metadata.timeDiff;return[`Период: ${H.days} дн. ${H.hours} ч. ${H.minutes} мин.`]}}},title:{display:!1}}};return u.value==="line"||u.value==="bar"?{...v,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:u.value==="doughnut"?{...v,cutout:"60%"}:v});function M(v){const g=new Date(v),E=g.getFullYear(),A=String(g.getMonth()+1).padStart(2,"0"),H=String(g.getDate()).padStart(2,"0");return`${E}-${A}-${H}`}function K(v){const{current:g,weekEnd:E}=v,A=g||E;if(!A||!A.statistics||!A.statistics.stages)return null;const H=[],b=[],$=[],U=[],O={},z={};if(Q.forEach(P=>{var W;const C=((W=A.statistics.stages[P.id])==null?void 0:W.count)||0;if(C>0){H.push(`${P.name} (${C})`),b.push(C),$.push(P.color+"80"),U.push(P.color),z[P.id]=C;const J=Pa(P.id,A,Q);J&&J.employees&&(O[P.id]=J)}}),b.length===0)return null;const Y=b.reduce((P,C)=>P+C,0);return{labels:H,datasets:[{label:"Распределение по этапам",data:b,backgroundColor:$,borderColor:U,borderWidth:2,meta:{employees:O,totals:{overall:Y,stages:z}}}]}}function j(v){if(u.value==="doughnut")return K(v);if(u.value==="bar"){const $=a.showCurrentState&&v.current?"current":v.weekEnd?"weekEnd":"weekStart";return Ra(v,$,Q)}const{weekStart:g,weekEnd:E,current:A}=v,H=[],b=[];return Q.forEach(($,U)=>{var J,he,Ee,Me,$e,yt,vt,kt,bt,wt,St,Et,Dt,Ct,_t,Tt,At;const O=[];if(g&&g.statistics&&g.statistics.stages){const te=g.statistics.stages[$.id];if(H.length===0){const Ge=(J=g.metadata)!=null&&J.createdAt?new Date(g.metadata.createdAt):null;H.push(Ge?M(Ge):"Начало недели")}O.push((te==null?void 0:te.count)||0)}else H.length===0&&H.push("Начало недели"),O.push(0);if(E&&E.statistics&&E.statistics.stages){const te=E.statistics.stages[$.id];if(H.length===1){const Ge=(he=E.metadata)!=null&&he.createdAt?new Date(E.metadata.createdAt):null;H.push(Ge?M(Ge):"Конец недели")}O.push((te==null?void 0:te.count)||0)}else H.length===1&&H.push("Конец недели"),O.push(0);if(A&&a.showCurrentState&&A.statistics&&A.statistics.stages){const te=A.statistics.stages[$.id];H.length===2&&H.push("Текущее состояние"),O.push((te==null?void 0:te.count)||0)}const z=["stable"];l.value?f.value==="weekStartToWeekEnd"?(z.push((($e=(Me=(Ee=l.value.weekStartToWeekEnd)==null?void 0:Ee.stages)==null?void 0:Me[$.id])==null?void 0:$e.trend)||"stable"),A&&z.push(((kt=(vt=(yt=l.value.weekStartToCurrent)==null?void 0:yt.stages)==null?void 0:vt[$.id])==null?void 0:kt.trend)||"stable")):f.value==="weekEndToCurrent"&&A?(z.push("stable"),z.push(((St=(wt=(bt=l.value.weekEndToCurrent)==null?void 0:bt.stages)==null?void 0:wt[$.id])==null?void 0:St.trend)||"stable")):f.value==="weekStartToCurrent"&&A?(z.push(((Ct=(Dt=(Et=l.value.weekStartToWeekEnd)==null?void 0:Et.stages)==null?void 0:Dt[$.id])==null?void 0:Ct.trend)||"stable"),z.push(((At=(Tt=(_t=l.value.weekStartToCurrent)==null?void 0:_t.stages)==null?void 0:Tt[$.id])==null?void 0:At.trend)||"stable")):(z.push("stable"),A&&z.push("stable")):(z.push("stable"),A&&z.push("stable"));let Y,P,C;l.value&&u.value!=="doughnut"?(Y=z.map(te=>ue(te,"background")+"40"),P=z.map(te=>ue(te,"border")),C=z.map(te=>ue(te,"point"))):(Y=$.color+"40",P=$.color,C=$.color);let W=null;u.value==="line"&&(W={employees:La($.id,v)}),b.push({label:$.name,data:O,backgroundColor:(Array.isArray(Y),Y),borderColor:(Array.isArray(P),P),borderWidth:2,...u.value==="line"&&{pointStyle:fe[U%fe.length]},pointBackgroundColor:(Array.isArray(C),C),pointBorderColor:(Array.isArray(P),P),pointRadius:7,pointHoverRadius:10,fill:u.value!=="line",tension:u.value==="line"?.4:0,meta:W})}),H.length===0&&(H.push("Начало недели","Конец недели"),a.showCurrentState&&H.push("Текущее состояние")),{labels:H,datasets:b}}const X=async()=>{var v,g,E;o.value=!0,r.value=null;try{const A=(v=a.period)!=null&&v.endDate?new Date(a.period.endDate):new Date,H=(g=a.period)!=null&&g.startDate?new Date(a.period.startDate):_e.getWeekStartDate(A),b=(E=a.period)!=null&&E.endDate?new Date(a.period.endDate):_e.getWeekEndDate(A),$=_e.formatDate(H),U=_e.formatDate(b),[O,z]=await Promise.all([_e.getSnapshot($,"week_start"),_e.getSnapshot(U,"week_end")]);let Y=null;a.showCurrentState&&(Y=await gt.getSectorDataForSnapshot({useCache:!1,normalize:!0})),i.value={weekStart:O,weekEnd:z,current:Y},xe(),be(),F(),n("data-loaded",{weekStart:O,weekEnd:z,current:Y})}catch(A){console.error("Error loading chart data:",A),r.value=A.message||"Ошибка загрузки данных графика",ke.error("Ошибка загрузки данных графика: "+r.value),n("error",r.value)}finally{o.value=!1}};Qe(()=>{qe.register(Un),qe.register(Vn),qe.register(Kn),X()});function ne(v){Ae.value=v}const F=()=>{var g;const v=j({weekStart:i.value.weekStart,weekEnd:i.value.weekEnd,current:i.value.current});if(!c.value||!c.value.labels||c.value.labels.length!==((g=v==null?void 0:v.labels)==null?void 0:g.length))c.value=v;else if(v){const E=JSON.stringify(c.value),A=JSON.stringify(v);E!==A&&(c.value=v)}};return Je(()=>[a.period,a.showCurrentState],()=>{X()},{deep:!0}),Je(u,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&F()}),Je(f,()=>{(i.value.weekStart||i.value.weekEnd||i.value.current)&&F()}),(v,g)=>(T(),I("div",Yn,[d("div",Gn,[g[3]||(g[3]=d("h3",{class:"chart-title"},"График состояния сектора 1С",-1)),d("div",Xn,[(T(),I(ge,null,me(m,E=>d("button",{key:E.value,onClick:A=>u.value=E.value,class:ie(["chart-type-btn",{active:u.value===E.value}]),title:E.label},[d("span",Jn,B(E.icon),1),d("span",Zn,B(E.label),1)],10,qn)),64))])]),!o.value&&!r.value&&l.value&&u.value!=="doughnut"?(T(),I("div",Qn,[g[7]||(g[7]=d("h4",{class:"comparison-title"},"Тип сравнения:",-1)),d("div",eo,[d("label",null,[rt(d("input",{type:"radio","onUpdate:modelValue":g[0]||(g[0]=E=>f.value=E),value:"weekStartToWeekEnd",onChange:F},null,544),[[lt,f.value]]),g[4]||(g[4]=d("span",null,"Начало недели → Конец недели",-1))]),i.value.current?(T(),I("label",to,[rt(d("input",{type:"radio","onUpdate:modelValue":g[1]||(g[1]=E=>f.value=E),value:"weekEndToCurrent",onChange:F},null,544),[[lt,f.value]]),g[5]||(g[5]=d("span",null,"Конец недели → Текущее состояние",-1))])):q("",!0),i.value.current?(T(),I("label",ao,[rt(d("input",{type:"radio","onUpdate:modelValue":g[2]||(g[2]=E=>f.value=E),value:"weekStartToCurrent",onChange:F},null,544),[[lt,f.value]]),g[6]||(g[6]=d("span",null,"Начало недели → Текущее состояние",-1))])):q("",!0)])])):q("",!0),!o.value&&!r.value&&c.value?(T(),Te(ba,{key:1,stages:Q,selected:Ae.value,"onUpdate:selected":ne,onChange:F},null,8,["selected"])):q("",!0),!o.value&&!r.value&&l.value&&u.value!=="doughnut"?(T(),I("div",so,[...g[8]||(g[8]=[qt('<h4 class="legend-title" data-v-cbba196a>Легенда:</h4><div class="legend-items" data-v-cbba196a><div class="legend-item" data-v-cbba196a><span class="legend-color legend-increase" data-v-cbba196a></span><span data-v-cbba196a>Зелёный — рост количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-decrease" data-v-cbba196a></span><span data-v-cbba196a>Красный — снижение количества тикетов</span></div><div class="legend-item" data-v-cbba196a><span class="legend-color legend-stable" data-v-cbba196a></span><span data-v-cbba196a>Серый — без изменений</span></div></div>',2)])])):q("",!0),o.value?(T(),Te(jt,{key:3,message:"Загрузка данных графика..."})):r.value?(T(),I("div",no,[d("p",oo,"❌ "+B(r.value),1),d("button",{onClick:X,class:"btn-retry"},"Повторить загрузку")])):h.value?(T(),I("div",{key:5,class:ie(["chart-container",`chart-type-${u.value}`])},[d("div",ro,[d("div",lo,[(T(),Te(Jt(re.value),{data:h.value,options:y.value},null,8,["data","options"]))]),u.value==="bar"?(T(),I("div",io,[(T(),I(ge,null,me(Q,E=>d("div",{key:E.id,class:"stage-label-item"},B(p(E.id)),1)),64))])):q("",!0)])],2)):(T(),I("div",co,[...g[9]||(g[9]=[d("p",null,"📊 Нет данных для отображения",-1),d("p",{class:"no-data-hint"},"Создайте слепки для отображения графика",-1)])])),ve(Fn,{"is-visible":k.value,"stage-name":w.value,"stage-id":_.value,"total-count":D.value,employees:S.value,others:N.value,snapshot:x.value,"ticket-details":G.value,"stage-switch-context":ee.value,onClose:Se},null,8,["is-visible","stage-name","stage-id","total-count","employees","others","snapshot","ticket-details","stage-switch-context"])]))}},po=et(uo,[["__scopeId","data-v-cbba196a"]]),go={key:0,class:"create-snapshot-button-container"},mo=["disabled"],fo={class:"modal-content"},ho={class:"modal-header"},yo=["disabled"],vo={class:"modal-body"},ko={key:0,class:"progress-container"},bo={class:"progress-bar-wrapper"},wo={class:"progress-text"},So={class:"progress-percent"},Eo={class:"progress-description"},Do={key:1},Co={class:"modal-footer"},_o=["disabled"],To=["disabled"],Ao={key:0},Io={key:0},No={key:1},Mo={key:2},$o={key:1},Fo={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(s,{emit:t}){const e=s,a=t,n=L(e.user),o=L(!1),r=L(!1),c=L(0),i=L("idle"),l=L(""),f=tt(),m=ae(()=>n.value?Zt(n.value):!1);Qe(async()=>{if(!e.user)try{const D=await Wt.checkAccess();D.allowed&&(n.value=D.user)}catch(D){console.error("Error loading user:",D)}});const u=()=>{if(!m.value){f.warning("Только администраторы могут создавать слепки");return}o.value=!0},k=()=>{r.value||(o.value=!1,i.value="idle",c.value=0,l.value="")},w=async()=>{if(!r.value){if(!m.value){f.warning("Только администраторы могут создавать слепки");return}r.value=!0,i.value="loading_data",c.value=0,l.value="Инициализация загрузки данных...";try{l.value="Загрузка данных сектора из Bitrix24...";const D=await gt.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:x=>{var ee;const G=Math.min(80,(x.progress||0)*.8);c.value=G,i.value="loading_data",l.value=x.description||((ee=x.details)==null?void 0:ee.description)||"Загрузка данных сектора..."}});i.value="creating_snapshot",c.value=85,l.value="Создание слепка...";const S=n.value;if(!S)throw new Error("Пользователь не определён");const N=await _e.createSnapshot(D,"manual",{createdBy:{id:S.ID,name:`${S.NAME||""} ${S.LAST_NAME||""}`.trim()||S.EMAIL||`User ${S.ID}`},sectorId:"1C"});i.value="success",c.value=100,l.value="Слепок успешно создан!",f.success("Слепок состояния сектора успешно создан"),a("snapshot-created",N),setTimeout(()=>{k()},1500)}catch(D){i.value="error",c.value=0,l.value="Ошибка создания слепка",console.error("Error creating snapshot:",D);let S="Ошибка создания слепка";D.message&&(D.message.includes("загрузки данных")||D.message.includes("sector data")?S="Не удалось загрузить данные сектора. Проверьте подключение к Bitrix24.":D.message.includes("создания слепка")||D.message.includes("snapshot")?S="Не удалось создать слепок. Обратитесь в поддержку.":D.message.includes("валидац")||D.message.includes("validation")?S="Ошибка валидации данных. Проверьте данные сектора.":S=D.message),f.error(S)}finally{r.value=!1}}},_=D=>{D.key==="Escape"&&o.value&&!r.value&&k()};return Qe(()=>{window.addEventListener("keydown",_)}),Ut(()=>{window.removeEventListener("keydown",_)}),(D,S)=>m.value?(T(),I("div",go,[d("button",{class:"create-snapshot-btn",onClick:u,disabled:r.value,title:"Создать слепок состояния сектора"},[...S[1]||(S[1]=[d("span",{class:"btn-icon"},"📸",-1),d("span",{class:"btn-text"},"Создать слепок",-1)])],8,mo),(T(),Te(Ot,{to:"body"},[ve(pt,{name:"modal"},{default:We(()=>[o.value?(T(),I("div",{key:0,class:"modal-overlay",onClick:S[0]||(S[0]=oe(N=>!r.value&&k(),["self"]))},[d("div",fo,[d("div",ho,[S[2]||(S[2]=d("h3",{class:"modal-title"},"Создать слепок состояния сектора",-1)),d("button",{class:"modal-close",onClick:k,disabled:r.value,"aria-label":"Закрыть"}," ✕ ",8,yo)]),d("div",vo,[i.value!=="idle"?(T(),I("div",ko,[d("div",bo,[d("div",{class:"progress-bar",style:ye({width:`${c.value}%`})},null,4)]),d("div",wo,[d("span",So,B(Math.round(c.value))+"%",1),d("span",Eo,B(l.value),1)])])):(T(),I("div",Do,[...S[3]||(S[3]=[d("p",{class:"modal-description"},' Будет создан слепок текущего состояния сектора 1С. Слепок будет сохранён с типом "manual" (ручной). ',-1),d("p",{class:"modal-warning"}," ⚠️ Процесс создания слепка может занять некоторое время. ",-1)])]))]),d("div",Co,[d("button",{class:"btn btn-secondary",onClick:k,disabled:r.value}," Отмена ",8,_o),d("button",{class:"btn btn-primary",onClick:w,disabled:r.value},[r.value?(T(),I("span",Ao,[i.value==="loading_data"?(T(),I("span",Io,"Загрузка данных...")):i.value==="creating_snapshot"?(T(),I("span",No,"Создание...")):(T(),I("span",Mo,"Обработка..."))])):(T(),I("span",$o,"Создать"))],8,To)])])])):q("",!0)]),_:1})]))])):q("",!0)}},Ho=et(Fo,[["__scopeId","data-v-09bccee2"]]);function Lo(){const s=L(!1),t=L(null),e=L(null),a=L(0),n=tt(),o=async(D=!0,S=null)=>{s.value=!0,t.value=null,a.value=0;try{const N=await gt.getSectorDataForSnapshot({useCache:D,onProgress:x=>{x&&typeof x.progress=="number"&&(a.value=x.progress),S&&S(x)},normalize:!0});return e.value=N,N}catch(N){throw t.value=N.message||"Ошибка загрузки данных сектора",n.error("Ошибка загрузки данных сектора: "+t.value),N}finally{s.value=!1,a.value=100}},r=async(D,S={})=>{if(!e.value){const N="Сначала загрузите данные сектора через loadSectorDataForSnapshot()";throw t.value=N,n.error(N),new Error(N)}s.value=!0,t.value=null;try{if(!["week_start","week_end","manual","current"].includes(D))throw new Error(`Неверный тип слепка: ${D}. Допустимые значения: week_start, week_end, manual, current`);const N=await _e.createSnapshot(e.value,D,S);return n.success("Слепок успешно создан"),N}catch(N){throw t.value=N.message||"Ошибка создания слепка",n.error("Ошибка создания слепка: "+t.value),N}finally{s.value=!1}},c=()=>{s.value=!1,t.value=null,e.value=null,a.value=0},i=ae(()=>e.value!==null&&e.value!==void 0),l=L({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),f=ae(()=>{const D=new Date;let S,N;switch(l.value.dateRange){case"last-week":S=new Date(D),S.setDate(D.getDate()-7),N=D;break;case"last-2-weeks":S=new Date(D),S.setDate(D.getDate()-14),N=D;break;case"last-month":S=new Date(D),S.setMonth(D.getMonth()-1),N=D;break;case"custom":S=l.value.customDateRange.startDate?new Date(l.value.customDateRange.startDate):null,N=l.value.customDateRange.endDate?new Date(l.value.customDateRange.endDate):null;break;default:S=new Date(D),S.setDate(D.getDate()-7),N=D}return{startDate:S?S.toISOString().split("T")[0]:null,endDate:N?N.toISOString().split("T")[0]:null}}),m=()=>{k()},u=()=>{l.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},k()},k=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(l.value))}catch(D){console.error("Ошибка сохранения фильтров в localStorage:",D)}},w=()=>{try{const D=localStorage.getItem("graphStateFilters");if(D){const S=JSON.parse(D);S&&typeof S=="object"&&(l.value={stages:S.stages||{formed:!0,review:!0,execution:!0},employees:S.employees||["all"],dateRange:S.dateRange||"last-week",customDateRange:S.customDateRange||{startDate:null,endDate:null}})}}catch(D){console.error("Ошибка загрузки фильтров из localStorage:",D)}},_=ae(()=>{const D=Object.values(l.value.stages).some(x=>!x),S=!l.value.employees.includes("all"),N=l.value.dateRange!=="last-week";return D||S||N});return{isLoading:s,error:t,currentSectorData:e,loadingProgress:a,hasSectorData:i,filters:l,selectedPeriod:f,hasActiveFilters:_,loadSectorDataForSnapshot:o,createSnapshot:r,resetState:c,applyFilters:m,resetFilters:u,saveFiltersToLocalStorage:k,loadFiltersFromLocalStorage:w}}const Ro={class:"graph-state-dashboard"},Po={key:1,class:"error-message-container"},xo={class:"error-message"},Bo={class:"error-text"},Oo={key:0,class:"error-details"},jo={class:"dashboard-header"},Wo={class:"header-content"},Uo={class:"breadcrumbs-row"},zo=["aria-disabled","data-fallback","disabled"],Vo={class:"breadcrumbs","aria-label":"Навигация"},Ko={class:"header-actions"},Yo=["disabled"],Go={key:0},Xo={key:1},qo={key:3,class:"dashboard-content"},Jo={class:"chart-container"},Zo="Назад",Qo={__name:"GraphStateDashboard",setup(s){const t=(R,V)=>typeof window>"u"?V:getComputedStyle(document.documentElement).getPropertyValue(R).trim()||V,e=tt(),a=Qt(),n={name:"dashboard-sector-1c"},{filters:o,selectedPeriod:r,hasActiveFilters:c,applyFilters:i,resetFilters:l,loadFiltersFromLocalStorage:f}=Lo(),m=L(null),u=L(!0),k=L(!1),w=L("Загрузка данных..."),_=L(null),D=L(!1),S=L(!1),N=L(typeof window<"u"?window.innerWidth:1024),x=L(null),G=L(!1),ee=ae(()=>N.value<768);ae(()=>N.value>=768&&N.value<1024),ae(()=>N.value>=1024);const Z=ae(()=>typeof window>"u"?!1:window.history.length>1);ae(()=>{const R=new Date;return R.setFullYear(R.getFullYear()-1),R.toISOString().split("T")[0]}),ae(()=>new Date().toISOString().split("T")[0]);function re(R){o.value.stages=R}function se(R){o.value.employees=R}function Q(R){o.value.dateRange=R}function ce(R){o.value.customDateRange=R}function fe(){i()}function Ae(){l(),x.value=null,fe(),e.info("Фильтры сброшены")}function ke(R){e.success("Слепок успешно создан")}function Pe(R){k.value=!1,w.value="",console.log("Данные графика загружены:",R)}function Ve(R){k.value=!1,xe({message:R||"Ошибка загрузки графика",details:null,type:"error"})}function xe(R){_.value={message:R.message||"Произошла ошибка",details:R.details||null,type:R.type||"error",timestamp:new Date},console.error("Dashboard error:",_.value),e.error(_.value.message)}function ue(){_.value=null}function be(){_.value=null,k.value=!0,w.value="Повторная загрузка данных..."}async function Be(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){e.warning("Экспорт в PDF временно недоступен. Необходимо установить библиотеки jspdf и html2canvas."),console.warn("Для экспорта в PDF установите: npm install jspdf html2canvas");return}D.value=!0;try{const R=document.querySelector(".chart-container");if(!R)throw new Error("График не найден");const V=window.html2canvas,de=await V(R,{scale:2,useCORS:!0,logging:!1,backgroundColor:t("--b24-bg-white","#ffffff")}),Se=window.jsPDF,pe=new Se("landscape","mm","a4"),Ne=297,Ye=de.height*Ne/de.width;pe.setFontSize(18),pe.text("График состояния сектора 1С",148.5,15,{align:"center"});const p=new Date().toLocaleDateString("ru-RU");pe.setFontSize(10);const h=r.value.startDate&&r.value.endDate?`Период: ${r.value.startDate} - ${r.value.endDate}`:"Период: не указан";pe.text(h,148.5,25,{align:"center"}),pe.text(`Экспорт от ${p}`,148.5,30,{align:"center"}),pe.addImage(de.toDataURL("image/png"),"PNG",10,35,Ne-20,Ye-20),pe.setProperties({title:"График состояния сектора 1С",subject:`Экспорт от ${p}`,author:"Bitrix24 Dashboard"});const y=`graph-state-${p.replace(/\//g,"-")}.pdf`;pe.save(y),e.success("График успешно экспортирован в PDF")}catch(R){console.error("Ошибка экспорта в PDF:",R),xe({message:"Ошибка экспорта в PDF: "+(R.message||"Неизвестная ошибка"),details:R.stack,type:"error"})}finally{D.value=!1}}function we(R){var V;if((V=R==null?void 0:R.preventDefault)==null||V.call(R),!G.value){G.value=!0;try{if(Z.value){a.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),a.push(n)}finally{G.value=!1}}}function Ie(){typeof window<"u"&&(N.value=window.innerWidth)}async function Ke(){try{const R=await Wt.checkAccess();R.allowed&&(m.value=R.user)}catch(R){console.error("Error loading user:",R)}}return Qe(()=>{f(),Ke(),typeof window<"u"&&(N.value=window.innerWidth,window.addEventListener("resize",Ie))}),Ut(()=>{typeof window<"u"&&window.removeEventListener("resize",Ie)}),(R,V)=>{const de=ea("router-link");return T(),I("div",Ro,[k.value?(T(),Te(jt,{key:0,message:w.value},null,8,["message"])):q("",!0),_.value?(T(),I("div",Po,[d("div",xo,[d("div",{class:"error-header"},[V[1]||(V[1]=d("span",{class:"error-icon"},"❌",-1)),V[2]||(V[2]=d("h3",null,"Ошибка",-1)),d("button",{onClick:ue,class:"error-close","aria-label":"Закрыть"},"✕")]),d("p",Bo,B(_.value.message),1),_.value.details?(T(),I("div",Oo,[d("details",null,[V[3]||(V[3]=d("summary",null,"Детали ошибки",-1)),d("pre",null,B(_.value.details),1)])])):q("",!0),d("div",{class:"error-actions"},[d("button",{onClick:be,class:"btn-retry"},"Повторить попытку")])])])):q("",!0),d("div",jo,[d("div",Wo,[d("div",Uo,[d("button",{class:"btn-back-link",type:"button",onClick:we,"aria-label":Zo,"aria-disabled":!Z.value,"data-fallback":!Z.value,disabled:G.value,title:"Назад"}," ← ",8,zo),d("nav",Vo,[ve(de,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:We(()=>[...V[4]||(V[4]=[Bt(" Дашборд сектора 1С ",-1)])]),_:1}),V[5]||(V[5]=d("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),V[6]||(V[6]=d("span",{class:"breadcrumb-current"},"График состояния",-1))])]),V[7]||(V[7]=d("h1",{class:"dashboard-title"},"График состояния сектора 1С",-1)),V[8]||(V[8]=d("p",{class:"dashboard-subtitle"}," Визуализация изменений состояния сектора во времени ",-1))]),d("div",Ko,[d("button",{onClick:Be,class:"btn-export-pdf",disabled:D.value||k.value,title:"Экспортировать график в PDF"},[D.value?(T(),I("span",Xo,"⏳ Экспорт...")):(T(),I("span",Go,"📄 Экспорт в PDF"))],8,Yo),ve(Ho,{user:m.value,onSnapshotCreated:ke},null,8,["user"])])]),ee.value?(T(),I("button",{key:2,class:"mobile-filters-toggle",onClick:V[0]||(V[0]=Se=>S.value=!S.value)},[V[9]||(V[9]=d("span",null,"Фильтры",-1)),d("span",{class:ie(["toggle-icon",{open:S.value}])},"▼",2)])):q("",!0),d("div",{class:ie({"mobile-open":S.value&&ee.value,"mobile-closed":!S.value&&ee.value})},[ve(ia,{stages:Oe(o).stages,employees:Oe(o).employees,dateRange:Oe(o).dateRange,customDateRange:Oe(o).customDateRange,hasActiveFilters:Oe(c),"onUpdate:stages":re,"onUpdate:employees":se,"onUpdate:dateRange":Q,"onUpdate:customDateRange":ce,onReset:Ae,onApply:fe},null,8,["stages","employees","dateRange","customDateRange","hasActiveFilters"])],2),!k.value&&!_.value?(T(),I("div",qo,[d("div",Jo,[ve(po,{period:Oe(r),"show-current-state":u.value,onDataLoaded:Pe,onError:Ve},null,8,["period","show-current-state"])])])):q("",!0)])}}},or=et(Qo,[["__scopeId","data-v-e995acfd"]]);export{or as default};
