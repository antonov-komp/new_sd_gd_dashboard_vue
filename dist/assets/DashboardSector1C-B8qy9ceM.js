var le=Object.defineProperty;var de=(t,e,n)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var O=(t,e,n)=>de(t,typeof e!="symbol"?e+"":e,n);import{_ as M,c as h,a as u,b as _,t as k,n as L,o as m,F as C,r as N,d as b,e as A,f as v,g as E,w as P,T as V,h as B,i as ue,j as ie,k as Q,l as ge,u as fe}from"./main-BYGptfs-.js";const ye={name:"TicketCard",props:{ticket:{type:Object,required:!0},draggable:{type:Boolean,default:!0}},emits:["click","drag-start","drag-end"],setup(t,{emit:e}){return{getPriorityLabel:r=>({high:"–í—ã—Å–æ–∫–∏–π",medium:"–°—Ä–µ–¥–Ω–∏–π",low:"–ù–∏–∑–∫–∏–π"})[r]||r,getStatusLabel:r=>({in_progress:"–í —Ä–∞–±–æ—Ç–µ",new:"–ù–æ–≤—ã–π",done:"–í—ã–ø–æ–ª–Ω–µ–Ω–æ",pending:"–û–∂–∏–¥–∞–Ω–∏–µ"})[r]||r,handleDragStart:r=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("application/json",JSON.stringify(t.ticket)),r.dataTransfer.setDragImage(r.target,0,0),e("drag-start",t.ticket)},handleDragEnd:()=>{e("drag-end")}}}},me=["draggable"],pe={class:"ticket-header"},he={class:"ticket-id"},ke={class:"ticket-title"},Te={class:"ticket-meta"},_e={class:"ticket-status"},Se={key:0,class:"ticket-description"};function De(t,e,n,i,s,a){return m(),h("div",{class:L(["ticket-card",{"priority-high":n.ticket.priority==="high","priority-medium":n.ticket.priority==="medium","priority-low":n.ticket.priority==="low"}]),draggable:n.draggable,onClick:e[0]||(e[0]=r=>t.$emit("click",n.ticket)),onDragstart:e[1]||(e[1]=(...r)=>i.handleDragStart&&i.handleDragStart(...r)),onDragend:e[2]||(e[2]=(...r)=>i.handleDragEnd&&i.handleDragEnd(...r))},[u("div",pe,[e[3]||(e[3]=u("span",{class:"ticket-icon"},"üé´",-1)),u("span",he,"#"+k(n.ticket.id),1)]),u("div",ke,k(n.ticket.title),1),u("div",Te,[u("span",{class:L(["ticket-priority",`priority-${n.ticket.priority}`])},k(i.getPriorityLabel(n.ticket.priority)),3),u("span",_e,k(i.getStatusLabel(n.ticket.status)),1)]),n.ticket.description?(m(),h("div",Se,k(n.ticket.description),1)):_("",!0)],42,me)}const ne=M(ye,[["render",De],["__scopeId","data-v-b255f359"]]),ve={name:"ZeroPoint",components:{TicketCard:ne},props:{tickets:{type:Array,default:()=>[]},stageId:{type:String,required:!0}},emits:["ticket-dragged","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){return{handleTicketDragStart:i=>{e("ticket-dragged",i)}}}},Ee={class:"zero-point"},Ie={class:"zero-point-header"},Ae={class:"tickets-count"},Ce={class:"zero-point-tickets"},we={key:0,class:"empty-state"};function Ne(t,e,n,i,s,a){const r=b("TicketCard");return m(),h("div",Ee,[u("div",Ie,[e[0]||(e[0]=u("span",{class:"zero-point-icon"},"üì•",-1)),e[1]||(e[1]=u("h3",null,"[0] –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞",-1)),u("span",Ae,"("+k(n.tickets.length)+")",1)]),e[3]||(e[3]=u("div",{class:"zero-point-description"},[u("p",null,"–í—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã"),u("p",{class:"hint"},"–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–∏–∫–µ—Ç –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")],-1)),u("div",Ce,[(m(!0),h(C,null,N(n.tickets,l=>(m(),A(r,{key:l.id,ticket:l,draggable:!0,onDragStart:o=>i.handleTicketDragStart(l),onClick:o=>t.$emit("ticket-clicked",l)},null,8,["ticket","onDragStart","onClick"]))),128)),n.tickets.length===0?(m(),h("div",we,[...e[2]||(e[2]=[u("p",null,"–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤",-1)])])):_("",!0)])])}const be=M(ve,[["render",Ne],["__scopeId","data-v-252e877d"]]);function Me(t){return typeof t=="number"&&t>0&&!isNaN(t)}function se(t){return typeof t=="number"&&t>0&&!isNaN(t)}function re(t){return typeof t=="string"&&["formed","review","execution"].includes(t)}function Oe(t){return!t||typeof t!="object"?!1:Me(t.id)&&typeof t.title=="string"&&t.title.trim().length>0}function ae(t,e,n){return!(!Oe(t)||!se(e)||!re(n)||t.assigneeId===e&&t.stageId===n)}function Pe(t){const e=[];return!t||typeof t!="object"?(e.push("–î–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{valid:!1,errors:e}):((!t.title||typeof t.title!="string"||t.title.trim().length===0)&&e.push("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),t.stageId&&!re(t.stageId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å—Ç–∞–¥–∏–∏"),t.employeeId&&!se(t.employeeId)&&e.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"),{valid:e.length===0,errors:e})}function oe(){const t=(a,r="info",l=5e3)=>{typeof BX<"u"&&BX.UI&&BX.UI.Notification?BX.UI.Notification.Center.notify({content:a,autoHideDelay:l}):console.log(`[${r.toUpperCase()}] ${a}`)};return{notify:t,success:(a,r=3e3)=>{t(a,"success",r)},error:(a,r=5e3)=>{t(a,"error",r)},info:(a,r=4e3)=>{t(a,"info",r)},warning:(a,r=4e3)=>{t(a,"warning",r)}}}function Re(t){const e=oe(),n=v(!1);return{isDropZoneActive:n,handleDragStart:(o,f)=>{o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("application/json",JSON.stringify(f)),o.dataTransfer.setDragImage(o.target,0,0)},handleDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move",n.value=!0},handleDragLeave:o=>{const f=o.currentTarget.getBoundingClientRect(),d=o.clientX,g=o.clientY;(d<f.left||d>f.right||g<f.top||g>f.bottom)&&(n.value=!1)},handleDrop:async(o,f,d)=>{o.preventDefault(),n.value=!1;const g=o.dataTransfer.getData("application/json");if(g)try{const c=JSON.parse(g);if(!ae(c,f,d)){e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞");return}t&&typeof t=="function"&&await t(c,f,d)}catch(c){console.error("Error parsing ticket data:",c),e.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞")}},handleDragEnd:o=>{n.value=!1}}}const Le={name:"EmployeeColumn",components:{TicketCard:ne},props:{employee:{type:Object,required:!0},stageId:{type:String,required:!0}},emits:["ticket-clicked","ticket-dropped"],setup(t,{emit:e}){const i=Re(async(g,c,y)=>{e("ticket-dropped",g,c)}),s=E(()=>t.employee.isFromSector1C?Array.isArray(t.employee.tickets)?t.employee.tickets:[]:Array.isArray(t.employee.ticketsInsideSector)?t.employee.ticketsInsideSector:[]),a=E(()=>t.employee.isFromSector1C?[]:Array.isArray(t.employee.ticketsOutsideSector)?t.employee.ticketsOutsideSector:Array.isArray(t.employee.tickets)?t.employee.tickets:[]),r=E(()=>t.employee.isFromSector1C?Array.isArray(t.employee.tickets)?t.employee.tickets:[]:[]),l=E(()=>s.value.length+a.value.length),o=g=>{i.handleDrop(g,t.employee.id,t.stageId)},f=g=>{},d=()=>{console.log("Add ticket for employee:",t.employee.id)};return{isDropZoneActive:i.isDropZoneActive,handleDragOver:i.handleDragOver,handleDragLeave:i.handleDragLeave,handleDrop:o,ticketsInsideSector:s,ticketsOutsideSector:a,ticketsToDisplay:r,totalTicketsCount:l,handleTicketDragStart:f,handleAddTicket:d}}},Be={class:"employee-header"},Fe={class:"employee-info"},xe={class:"employee-details"},ze={class:"employee-name"},Ke={key:0,class:"employee-position"},Ue={class:"tickets-count"},je={class:"tickets-list"},Ve={key:0,class:"tickets-section tickets-inside-sector"},Xe={key:1,class:"tickets-section tickets-outside-sector"},Ye={class:"section-header"},We={class:"section-count"},He={key:2,class:"empty-state"};function $e(t,e,n,i,s,a){const r=b("TicketCard");return m(),h("div",{class:L(["employee-column",{"drop-zone-active":i.isDropZoneActive}]),onDragover:e[1]||(e[1]=ue((...l)=>i.handleDragOver&&i.handleDragOver(...l),["prevent"])),onDragleave:e[2]||(e[2]=(...l)=>i.handleDragLeave&&i.handleDragLeave(...l)),onDrop:e[3]||(e[3]=(...l)=>i.handleDrop&&i.handleDrop(...l))},[u("div",Be,[u("div",Fe,[e[4]||(e[4]=u("span",{class:"employee-icon"},"üë§",-1)),u("div",xe,[u("div",ze,k(n.employee.name),1),n.employee.position?(m(),h("div",Ke,k(n.employee.position),1)):_("",!0)])]),u("div",Ue," üìä –¢–∏–∫–µ—Ç–æ–≤: "+k(i.totalTicketsCount),1)]),u("div",je,[n.employee.isFromSector1C?(m(),A(V,{key:0,name:"ticket",tag:"div"},{default:P(()=>[(m(!0),h(C,null,N(i.ticketsToDisplay,l=>(m(),A(r,{key:l.id,ticket:l,draggable:!0,onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})):(m(),h(C,{key:1},[i.ticketsInsideSector.length>0?(m(),h("div",Ve,[B(V,{name:"ticket",tag:"div"},{default:P(()=>[(m(!0),h(C,null,N(i.ticketsInsideSector,l=>(m(),A(r,{key:l.id,ticket:l,draggable:!0,onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0),i.ticketsOutsideSector.length>0?(m(),h("div",Xe,[u("div",Ye,[e[5]||(e[5]=u("span",{class:"section-badge"},"–í–Ω–µ —Å–µ–∫—Ç–æ—Ä–∞",-1)),u("span",We,k(i.ticketsOutsideSector.length),1)]),B(V,{name:"ticket",tag:"div"},{default:P(()=>[(m(!0),h(C,null,N(i.ticketsOutsideSector,l=>(m(),A(r,{key:l.id,ticket:l,draggable:!0,class:"ticket-outside-sector",onClick:o=>t.$emit("ticket-clicked",l),onDragStart:i.handleTicketDragStart},null,8,["ticket","onClick","onDragStart"]))),128))]),_:1})])):_("",!0)],64)),i.totalTicketsCount===0?(m(),h("div",He,[e[6]||(e[6]=u("p",null,"–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤",-1)),u("button",{class:"add-ticket-btn",onClick:e[0]||(e[0]=(...l)=>i.handleAddTicket&&i.handleAddTicket(...l))}," + –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç ")])):_("",!0)])],34)}const Ge=M(Le,[["render",$e],["__scopeId","data-v-5779d978"]]),Ze={name:"DashboardStage",components:{ZeroPoint:be,EmployeeColumn:Ge},props:{stage:{type:Object,required:!0},zeroPointTickets:{type:Array,default:()=>[]}},emits:["ticket-moved","ticket-assigned","ticket-clicked"],setup(t,{emit:e}){const n=v(!1),i=E(()=>{const g=Array.isArray(t.zeroPointTickets)?t.zeroPointTickets.length:0,c=Array.isArray(t.stage.employees)?t.stage.employees.reduce((y,p)=>Array.isArray(p.ticketsInsideSector)?y+p.ticketsInsideSector.length:p.isFromSector1C&&Array.isArray(p.tickets)?y+p.tickets.length:y,0):0;return g+c}),s=E(()=>Array.isArray(t.stage.employees)?t.stage.employees.reduce((g,c)=>Array.isArray(c.ticketsOutsideSector)?g+c.ticketsOutsideSector.length:!c.isFromSector1C&&Array.isArray(c.tickets)?g+c.tickets.length:g,0):0),a=E(()=>i.value+s.value),r=E(()=>{var p;const g=((p=t.stage)==null?void 0:p.name)||"–°—Ç–∞–¥–∏—è",c=i.value,y=s.value;return y===0?`${g} (${c})`:`${g} (${c} / ${y})`});return{isDragging:n,ticketsCountInsideSector:i,ticketsCountOutsideSector:s,totalTicketsCount:a,stageNameWithCount:r,handleTicketDragged:g=>{n.value=!0},handleTicketAssigned:(g,c)=>{e("ticket-assigned",g,c)},handleTicketDropped:(g,c)=>{e("ticket-moved",g,c,t.stage.id),n.value=!1},handleTicketClicked:g=>{console.log("Ticket clicked:",g),e("ticket-clicked",g)}}}},qe={class:"stage-header"},Je={class:"stage-content"},Qe={class:"employees-container"};function et(t,e,n,i,s,a){const r=b("ZeroPoint"),l=b("EmployeeColumn");return m(),h("div",{class:"dashboard-stage",style:ie({borderLeftColor:n.stage.color})},[u("div",qe,[u("h2",null,k(i.stageNameWithCount),1)]),u("div",Je,[B(r,{tickets:n.zeroPointTickets,"stage-id":n.stage.id,onTicketDragged:i.handleTicketDragged,onTicketAssigned:i.handleTicketAssigned,onTicketClicked:i.handleTicketClicked},null,8,["tickets","stage-id","onTicketDragged","onTicketAssigned","onTicketClicked"]),u("div",Qe,[(m(!0),h(C,null,N(n.stage.employees,o=>(m(),A(l,{key:o.id,employee:o,"stage-id":n.stage.id,onTicketClicked:i.handleTicketClicked,onTicketDropped:i.handleTicketDropped},null,8,["employee","stage-id","onTicketClicked","onTicketDropped"]))),128))])])],4)}const tt=M(Ze,[["render",et],["__scopeId","data-v-3eed4deb"]]),X={cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},it={loading_tickets:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24..."},filtering:{title:"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤",description:"–û—Ç–±–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ —Å–µ–∫—Ç–æ—Ä–∞ 1–°..."},extracting_employees:{title:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."},loading_employees:{title:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",description:"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö..."},grouping:{title:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",description:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º..."},caching:{title:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à",description:"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."},cache_check:{title:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞",description:"–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."},cache_hit:{title:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",description:"–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞..."},complete:{title:"–ì–æ—Ç–æ–≤–æ!",description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"},error:{title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}},nt={name:"LoadingPreloader",props:{currentStep:{type:String,default:null},progress:{type:Number,default:0},stepDetails:{type:Object,default:()=>({})},error:{type:String,default:null}},emits:["retry"],setup(t,{emit:e}){const n=E(()=>{var g;const{currentStep:f,stepDetails:d}=t;return d!=null&&d.description?{title:f?((g=X[f])==null?void 0:g.title)||f:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:d.description}:f?X[f]?X[f]:it[f]||{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."}:{title:"–ó–∞–≥—Ä—É–∑–∫–∞...",description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."}}),i=E(()=>n.value.title),s=E(()=>n.value.description),a=E(()=>t.stepDetails),r=E(()=>{const f=t.progress;return f==null||isNaN(f)?0:Math.round(Math.max(0,Math.min(100,f)))});return{stepTitle:i,stepDescription:s,details:a,displayProgress:r,getStageDisplayName:f=>f?{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ","–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[f]||f:"",handleRetry:()=>{e("retry")}}}},st={class:"preloader-backdrop"},rt={class:"preloader-container"},at={class:"preloader-content-scrollable"},ot={key:0,class:"spinner-container"},ct={class:"preloader-content"},lt={class:"step-title"},dt={key:0,class:"step-description"},ut={key:1,class:"progress-container"},gt={class:"progress-bar"},ft={class:"progress-text"},yt={key:2,class:"step-details"},mt={key:0,class:"detail-description"},pt={key:1,class:"detail-item"},ht={class:"detail-value"},kt={key:0,class:"detail-total"},Tt={key:2,class:"detail-item"},_t={class:"detail-value"},St={key:0,class:"detail-total"},Dt={key:3,class:"detail-item"},vt={class:"detail-value"},Et={key:0,class:"detail-total"},It={key:4,class:"detail-item"},At={class:"detail-value"},Ct={key:5,class:"detail-warning"},wt={key:0,class:"error-container"},Nt={class:"error-content"},bt={class:"error-message"};function Mt(t,e,n,i,s,a){return m(),h("div",{class:L(["loading-preloader",{"has-error":n.error}])},[u("div",st,[u("div",rt,[u("div",at,[n.error?_("",!0):(m(),h("div",ot,[...e[1]||(e[1]=[u("div",{class:"spinner"},null,-1)])])),u("div",ct,[u("h3",lt,k(i.stepTitle),1),i.stepDescription?(m(),h("p",dt,k(i.stepDescription),1)):_("",!0),n.error?_("",!0):(m(),h("div",ut,[u("div",gt,[u("div",{class:"progress-fill",style:ie({width:i.displayProgress+"%"})},null,4)]),u("span",ft,k(i.displayProgress)+"%",1)])),n.error?_("",!0):(m(),h("div",yt,[i.details.description?(m(),h("div",mt,k(i.details.description),1)):_("",!0),i.details.count!==void 0?(m(),h("div",pt,[e[2]||(e[2]=u("span",{class:"detail-label"},"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),u("span",ht,k(i.details.count),1),i.details.total!==void 0?(m(),h("span",kt," –∏–∑ "+k(i.details.total),1)):_("",!0)])):_("",!0),i.details.filteredTickets!==void 0?(m(),h("div",Tt,[e[3]||(e[3]=u("span",{class:"detail-label"},"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤:",-1)),u("span",_t,k(i.details.filteredTickets),1),i.details.totalTickets!==void 0?(m(),h("span",St," –∏–∑ "+k(i.details.totalTickets),1)):_("",!0)])):_("",!0),i.details.stage?(m(),h("div",Dt,[e[4]||(e[4]=u("span",{class:"detail-label"},"–°—Ç–∞–¥–∏—è:",-1)),u("span",vt,k(i.getStageDisplayName(i.details.stage)),1),i.details.stageIndex&&i.details.totalStages?(m(),h("span",Et," ("+k(i.details.stageIndex)+"/"+k(i.details.totalStages)+") ",1)):_("",!0)])):_("",!0),i.details.employeeCount!==void 0?(m(),h("div",It,[e[5]||(e[5]=u("span",{class:"detail-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:",-1)),u("span",At,k(i.details.employeeCount),1)])):_("",!0),i.details.warning?(m(),h("div",Ct,[u("span",null,"‚ö†Ô∏è "+k(i.details.warning),1)])):_("",!0)]))])])])]),n.error?(m(),h("div",wt,[u("div",Nt,[e[6]||(e[6]=u("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),u("p",bt,k(n.error),1),u("button",{onClick:e[0]||(e[0]=(...r)=>i.handleRetry&&i.handleRetry(...r)),class:"retry-button"}," –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É ")])])):_("",!0)],2)}const Ot=M(nt,[["render",Mt],["__scopeId","data-v-d129ff19"]]);function Pt(){const t=v(!1),e=v(null),n=v([{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}]),i=v({formed:[],review:[],execution:[]}),s=v([]),a=v(null);return{isLoading:t,error:e,stages:n,zeroPointTickets:i,employees:s,draggedTicket:a,updateState:d=>{d.stages&&(n.value=d.stages),d.employees&&(s.value=d.employees),d.zeroPointTickets&&(i.value=d.zeroPointTickets)},resetState:()=>{t.value=!1,e.value=null,n.value=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:[]},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:[]},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:[]}],i.value={formed:[],review:[],execution:[]},s.value=[],a.value=null},updateLocalStateAfterMove:(d,g,c)=>{const y=n.value.find(S=>S.employees.some(I=>I.tickets.some(j=>j.id===d.id)));if(y){const S=y.employees.find(I=>I.tickets.some(j=>j.id===d.id));S&&(S.tickets=S.tickets.filter(I=>I.id!==d.id))}const p=n.value.find(S=>S.id===c);if(p){const S=p.employees.find(I=>I.id===g);if(S){const I={...d,assigneeId:g,stageId:c};S.tickets.push(I)}}Object.keys(i.value).forEach(S=>{i.value[S]=i.value[S].filter(I=>I.id!==d.id)})},getEmployeeTickets:(d,g)=>{const c=n.value.find(p=>p.id===g);if(!c)return[];const y=c.employees.find(p=>p.id===d);return y?y.tickets||[]:[]}}}class Rt{static getApiUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))+"/api/bitrix24.php"}static async call(e,n={}){try{const i=await fetch(this.getApiUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:e,params:n})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const s=await i.json();if(s.error)throw new Error(s.error_description||s.error);return s}catch(i){throw console.error("Bitrix24 API error:",i),i}}static async getProfile(){return this.call("profile",{})}static async getLeads(e={},n=["ID","NAME","EMAIL","PHONE"],i={ID:"DESC"}){return(await this.call("crm.lead.list",{filter:e,select:n,order:i})).result||[]}}class w{static async call(e,n={}){return await Rt.call(e,n)}}class T{static get(e){const n=this.cache.get(e);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(e),null):n.data:null}static set(e,n,i=this.DEFAULT_TTL){this.cache.set(e,{data:n,timestamp:Date.now(),ttl:i})}static delete(e){this.cache.delete(e)}static clear(){this.cache.clear()}static invalidateByPrefix(e){const n=[];for(const i of this.cache.keys())i.startsWith(e)&&n.push(i);n.forEach(i=>this.cache.delete(i))}static cleanExpired(){const e=Date.now(),n=[];for(const[i,s]of this.cache.entries())e-s.timestamp>s.ttl&&n.push(i);n.forEach(i=>this.cache.delete(i))}static getStats(){const e=Date.now();let n=0,i=0;for(const s of this.cache.values())e-s.timestamp>s.ttl?n++:i++;return{total:this.cache.size,valid:i,expired:n}}static getTicketsCacheKey(e){return`tickets:stage:${e}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(e){return`employees:ids:${[...e].sort((i,s)=>i-s).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}O(T,"cache",new Map),O(T,"DEFAULT_TTL",5*60*1e3),O(T,"EMPLOYEES_TTL",30*60*1e3),O(T,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{T.cleanExpired()},5*60*1e3);function D(t,e,n={}){if(!t||typeof t!="string")throw new Error("Step must be a non-empty string");const i=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0;let s=n.description;return s||(s=Lt(t,n)),{step:t,progress:i,details:{...n,description:s}}}function Lt(t,e){return t==="loading_tickets"&&e.stageName&&e.stageIndex!==void 0?`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ —Å—Ç–∞–¥–∏–∏ "${e.stageName}" (${e.stageIndex}/${e.totalStages||1})...`:t==="filtering"&&e.filteredTickets!==void 0&&e.totalTickets!==void 0?`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤: ${e.filteredTickets} –∏–∑ ${e.totalTickets}...`:t==="grouping"&&e.employeeCount!==void 0?`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ ${e.employeeCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`:e.count!==void 0&&e.total!==void 0?`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${e.count} –∏–∑ ${e.total}...`:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}function U(t){if(!t||typeof t!="object")throw new Error("Progress info must be an object");const e=t.step||null;if(!e)throw new Error("Step is required in progress info");const n=t.progress!==void 0&&t.progress!==null?t.progress:t.percent!==void 0&&t.percent!==null?t.percent:void 0,i=t.details||{};return t.stage&&(i.stage=t.stage),t.stageName&&(i.stageName=t.stageName),t.stageIndex!==void 0&&(i.stageIndex=t.stageIndex),t.totalStages!==void 0&&(i.totalStages=t.totalStages),t.count!==void 0&&(i.count=t.count),t.total!==void 0&&(i.total=t.total),t.warning&&(i.warning=t.warning),{step:e,progress:n!=null?Math.max(0,Math.min(100,n)):void 0,details:i}}function ce(t,e,n){const i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,s=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,a=typeof n=="number"&&!isNaN(n)?Math.max(0,Math.min(100,n)):0,r=i+s*a/100;return Math.max(0,Math.min(100,r))}const F=140;class x{static async getAllTickets(e,n=null){const i=[],s=e.length;try{for(let a=0;a<e.length;a++){const r=e[a],l=this.getStageName(r);if(n){const o=a/s*100;n(D("loading_tickets",o,{stage:r,stageName:l,stageIndex:a+1,totalStages:s}))}try{const o=await this.getTicketsByStage(r,!0,n?f=>{const d=ce(a/s*100,1/s*100,f.percent||0);n(D("loading_tickets",d,{stage:r,stageName:l,stageIndex:a+1,totalStages:s,count:f.count,total:f.total}))}:null);i.push(...o)}catch(o){console.error(`Error loading tickets for stage ${r}:`,o);let f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}"`;throw o.message&&(o.message.includes("HTTP error")||o.message.includes("network")?f=`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`:o.message.includes("timeout")?f=`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`:o.message.includes("403")||o.message.includes("401")?f=`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞–¥–∏–∏ "${l}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.`:f=`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–¥–∏–∏ "${l}": ${o.message}`),new Error(f)}}}catch(a){throw console.error("Error in getAllTickets:",a),a}return i}static getStageName(e){return{"DT140_12:UC_0VHWE2":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ","DT140_12:PREPARATION":"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó","DT140_12:CLIENT":"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}[e]||e}static async getTicketsByStage(e,n=!0,i=null){if(n){const d=T.getTicketsCacheKey(e),g=T.get(d);if(g!==null)return i&&i(U({step:"loading_tickets",percent:100,count:g.length,total:g.length})),g}const s=[];let a=0;const r=50;let l=!0,o=0,f=null;for(;l;)try{const d=await w.call("crm.item.list",{entityTypeId:F,filter:{stageId:e},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let g=[];if(d&&d.result&&(Array.isArray(d.result)?g=d.result:d.result.items&&Array.isArray(d.result.items)?g=d.result.items:d.result.data&&Array.isArray(d.result.data)&&(g=d.result.data)),g.length>0){if(s.push(...g),a+=g.length,l=g.length===r,l?o=a+r:o=s.length,i){const c=o>0?Math.min(100,s.length/o*100):0;i(U({step:"loading_tickets",percent:c,count:s.length,total:o}))}f=null}else l=!1}catch(d){if(console.error(`Error loading tickets batch for stage ${e} (start: ${a}):`,d),a===0)throw f=d,new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç—ã –¥–ª—è —Å—Ç–∞–¥–∏–∏ ${e}: ${d.message||d}`);l=!1,i&&s.length>0&&i(D("loading_tickets",100,{count:s.length,total:s.length,warning:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ${s.length} —Ç–∏–∫–µ—Ç–æ–≤. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.`}))}if(f&&s.length===0)throw f;if(n){const d=T.getTicketsCacheKey(e);T.set(d,s,T.TICKETS_TTL)}return s}static async getTicket(e){return(await w.call("crm.item.get",{entityTypeId:F,id:e})).result||null}static async updateTicket(e,n){const s=(await w.call("crm.item.update",{entityTypeId:F,id:e,fields:n})).result===!0;return s&&T.invalidateTicketsCache(),s}static async createTicket(e){const n=await w.call("crm.item.add",{entityTypeId:F,fields:e}),i=n.result?parseInt(n.result):0;return i>0&&T.invalidateTicketsCache(),i}static async assignTicket(e,n,i){return await this.updateTicket(e,{assignedById:n,stageId:i})}}class Bt{static async getEmployeesByIds(e,n=!0){if(!Array.isArray(e)||e.length===0)return[];if(n){const i=T.getEmployeesCacheKey(e),s=T.get(i);if(s!==null)return console.log(`Cache hit for employees: ${e.length} employees`),s}try{const i=await w.call("user.get",{filter:{ID:e},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(i&&i.result&&(Array.isArray(i.result)?s=i.result:console.warn("Unexpected user.get result format:",i)),n){const a=T.getEmployeesCacheKey(e);T.set(a,s,T.EMPLOYEES_TTL)}return s}catch(i){return console.error("Error getting employees by IDs:",i),[]}}}const K=366,Ft=368,xt=369,zt=367,Kt=[K,Ft,xt,zt],Ut=140,Y={FORMED:{bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{bitrixId:"DT140_12:PREPARATION"},EXECUTION:{bitrixId:"DT140_12:CLIENT"}},jt={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},Vt={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"},Xt={3:"high",2:"medium",1:"low"};function Yt(){return[Y.FORMED.bitrixId,Y.REVIEW.bitrixId,Y.EXECUTION.bitrixId]}function G(t){return jt[t]||"formed"}function ee(t){return Vt[t]||"DT140_12:UC_0VHWE2"}function Wt(){return Yt()}function Z(t){const e=parseInt(t.id||t.ID||0),n=t.title||t.TITLE||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",i=t.stageId||t.STAGE_ID||"",s=t.assignedById||t.ASSIGNED_BY_ID||null,a=t.createdTime||t.CREATED_DATE||t.CREATED_TIME||"",r=t.updatedTime||t.MODIFY_DATE||t.UPDATED_TIME||"";return{id:e,title:n,priority:Ht(t.priority||t.PRIORITY),status:$t(),assigneeId:s?parseInt(s):null,stageId:G(i),createdAt:a,modifiedAt:r,amount:t.opportunity||t.OPPORTUNITY||0,currency:t.currencyId||t.CURRENCY_ID||"RUB",description:t.comments||t.COMMENTS||""}}function Ht(t){return Xt[t]||"medium"}function $t(t){return"in_progress"}function Gt(t){if(!t||!t.UF_DEPARTMENT)return null;const e=Array.isArray(t.UF_DEPARTMENT)?t.UF_DEPARTMENT:[t.UF_DEPARTMENT];for(const n of e){const i=typeof n=="number"?n:parseInt(n);if(!isNaN(i)&&Kt.includes(i))return i}return null}function Zt(t){const e=Gt(t);return{id:parseInt(t.ID||t.id||0),name:`${t.NAME||t.name||""} ${t.LAST_NAME||t.lastName||""}`.trim()||t.EMAIL||t.email||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",position:t.WORK_POSITION||t.workPosition||"–°–æ—Ç—Ä—É–¥–Ω–∏–∫",email:t.EMAIL||t.email||"",sectorId:e,departmentId:t.UF_DEPARTMENT||null,tickets:[]}}function qt(t){return Array.isArray(t)?t.map(e=>Zt(e)):[]}const z="1C",R=new Map,te=100;function Jt(t){return t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||t.ufCrm7TypeProduct||t.UF_CRM_7_TYPE_PRODUCT||t.uf_crm_7_type_product||null}function Qt(t){const e=Jt(t);return e?Array.isArray(e)?e.includes(z):typeof e=="object"&&e!==null&&e.value===z||e===z:!1}function ei(t){return`filter:${t.map(n=>n.id||n.ID||"").sort().join(",")}`}function ti(){R.size>te&&Array.from(R.keys()).slice(0,Math.floor(te*.2)).forEach(e=>R.delete(e))}function ii(t){if(!Array.isArray(t))return[];const e=ei(t),n=R.get(e);if(n!==void 0)return n;const i=t.filter(Qt);return R.set(e,i),ti(),i}const $=1051;function q(t){if(!t||typeof t!="object")return null;let e=t.assignedById||t.ASSIGNED_BY_ID||t.assignedByIdId||t.assignedById;return e&&typeof e=="object"&&(e=e.id||e.ID||e.value||null),e||null}function J(t){if(t==null)return null;typeof t=="object"&&(t=t.id||t.ID||t.value||null);const e=typeof t=="number"?t:parseInt(t);return isNaN(e)||e<=0?null:e}function ni(t,e=$){const n=q(t),i=J(n);return i===null||i===e}function si(t,e){Array.isArray(t)||(console.warn("Tickets is not an array:",t),t=[]),Array.isArray(e)||(console.warn("Employees is not an array:",e),e=[]);const n=e.filter(r=>(r.id?parseInt(r.id):null)!==$),i=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:"#007bff",employees:n.map(r=>({...r,isFromSector1C:r.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:"#ffc107",employees:n.map(r=>({...r,isFromSector1C:r.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:"#28a745",employees:n.map(r=>({...r,isFromSector1C:r.sectorId===K,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(i.map(r=>[r.id,r])),a=new Map;return i.forEach(r=>{const l=new Map(r.employees.map(o=>[o.id,o]));a.set(r.id,l)}),t.forEach(r=>{const l=G(r.stageId||r.STAGE_ID||""),o=s.get(l);if(o){const f=q(r),d=J(f);if(d===$)return;if(d){const g=a.get(l);let c=g.get(d);c||(c={id:d,name:`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${d}`,position:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},o.employees.push(c),g.set(d,c));const y=Z(r);c.tickets.push(y),c.isFromSector1C?c.ticketsInsideSector.push(y):c.ticketsOutsideSector.push(y)}}}),i.forEach(r=>{r.employees.sort((l,o)=>l.isFromSector1C&&!o.isFromSector1C?-1:!l.isFromSector1C&&o.isFromSector1C?1:(l.id||0)-(o.id||0))}),i}function ri(t){const e={formed:[],review:[],execution:[]};return Array.isArray(t)?(t.filter(n=>ni(n)).forEach(n=>{const i=G(n.stageId||n.STAGE_ID||"");e[i]&&e[i].push(Z(n))}),e):(console.warn("Tickets is not an array in getZeroPointTickets:",t),e)}function ai(t){if(!Array.isArray(t))return[];const e=new Set;return t.forEach(n=>{const i=q(n),s=J(i);s&&e.add(s)}),Array.from(e)}class W{static async getSectorData(e=!0,n=null){if(n&&n(D("cache_check",0,{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏..."})),e){const i=T.getSectorDataCacheKey(),s=T.get(i);if(s!==null)return n&&n(D("cache_hit",100,{description:"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫–µ—à–∞"})),s}try{n&&n(D("loading_tickets",10,{description:"–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ Bitrix24..."}));const i=Wt(),s=await x.getAllTickets(i,g=>{if(n){const c=U(g),y=ce(10,40,c.progress||0);n(D(c.step||"loading_tickets",y,{...c.details,warning:c.details.warning}))}});n&&n(D("filtering",50,{totalTickets:s.length,description:`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${s.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —Å–µ–∫—Ç–æ—Ä—É 1–°...`}));const a=ii(s);n&&n(D("filtering",50,{totalTickets:s.length,filteredTickets:a.length,description:`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –∏–∑ ${s.length}`})),n&&n(D("extracting_employees",60,{filteredTickets:a.length,description:`–ê–Ω–∞–ª–∏–∑ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const r=ai(a);n&&n(D("extracting_employees",60,{employeeCount:r.length,description:`–ù–∞–π–¥–µ–Ω–æ ${r.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(D("loading_employees",65,{employeeCount:r.length,description:`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${r.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...`}));const l=await Bt.getEmployeesByIds(r),o=qt(l);n&&n(D("loading_employees",90,{employeeCount:o.length,description:`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö ${o.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`})),n&&n(D("grouping",90,{filteredTickets:a.length,employeeCount:o.length,description:`–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ${a.length} —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º –∏ ${o.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...`}));const d={stages:si(a,o),employees:o,zeroPointTickets:ri(a)};if(n&&n(D("caching",95,{description:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."})),e){const g=T.getSectorDataCacheKey();T.set(g,d,T.TICKETS_TTL)}return n&&n(D("complete",100,{description:"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"})),d}catch(i){throw console.error("Error getting sector data:",i),n&&n({step:"error",progress:0,error:i.message}),i}}static async assignTicket(e,n,i){try{const s=ee(i),a=await x.assignTicket(e,n,s);return a&&T.invalidateTicketsCache(),a}catch(s){throw console.error("Error assigning ticket:",s),s}}static async createTicket(e){try{const n=ee(e.stageId||"formed"),i={title:e.title,stageId:n};e.employeeId&&(i.assignedById=e.employeeId);const s=await x.createTicket(i);return s>0&&T.invalidateTicketsCache(),s}catch(n){throw console.error("Error creating ticket:",n),n}}static async getTicket(e){try{const n=await x.getTicket(e);return Z(n)}catch(n){throw console.error("Error getting ticket:",n),n}}static async addComment(e,n){try{return(await w.call("crm.timeline.comment.add",{fields:{entityId:e,entityType:"DYNAMIC_"+Ut,comment:n}})).result!==void 0}catch(i){throw console.error("Error adding comment:",i),i}}}function oi(){const t=v(null),e=v(0),n=v(null),i=v(null),s=v({}),a=(c,y={})=>{t.value=c,s.value=y},r=c=>{const y=typeof c=="number"&&!isNaN(c)?c:0;e.value=Math.min(100,Math.max(0,y))},l=c=>{n.value=c,i.value=null},o=c=>{i.value=c},f=()=>{i.value=null},d=()=>{t.value=null,e.value=0,n.value=null,i.value=null,s.value={}},g=E(()=>n.value||i.value);return{currentStep:t,progress:e,error:n,temporaryError:i,displayError:g,stepDetails:s,updateStep:a,updateProgress:r,setError:l,setTemporaryError:o,clearTemporaryError:f,reset:d}}function ci(t,e=""){if(console.error(`API Error ${e?`(${e})`:""}:`,t),t.message){if(t.message.includes("HTTP error"))return"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";if(t.message.includes("timeout"))return"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";if(t.message.includes("403")||t.message.includes("401"))return"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";if(t.message.includes("500"))return"–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."}return t.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}function li(t,e="",n={}){const i={message:t.message,stack:t.stack,context:e,...n,timestamp:new Date().toISOString()};console.error("Error logged:",i)}function H(t,e="",n=null){const i=ci(t,e);li(t,e),n&&typeof n=="function"?n(i,"error"):typeof BX<"u"&&BX.UI&&BX.UI.Notification&&BX.UI.Notification.Center.notify({content:i,autoHideDelay:5e3})}function di(t){const e=oe(),n=oi(),i=v(!1);function s(c,y){const p=U(c);p.step&&y.updateStep(p.step,p.details||{}),p.progress!==void 0&&p.progress!==null&&(y.updateProgress(p.progress),y.clearTemporaryError())}const a=async(c=!0)=>{t.isLoading.value=!0,t.error.value=null,n.reset(),n.updateStep("cache_check",{description:"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö..."}),n.updateProgress(0);try{const y=await W.getSectorData(c,p=>{s(p,n)});t.updateState(y)}catch(y){t.error.value=y.message,n.setError(y.message),H(y,"loading sector data",e.error)}finally{t.error.value?t.isLoading.value=!1:(n.updateStep("complete",{description:"–î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"}),n.updateProgress(100),setTimeout(()=>{i.value=!0,setTimeout(()=>{t.isLoading.value=!1},150),setTimeout(()=>{n.reset(),i.value=!1},400)},800))}},r=async(c,y,p)=>{if(!ae(c,y,p))return e.warning("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç —Å—é–¥–∞"),!1;try{const S=await W.assignTicket(c.id,y,p);return S&&(t.updateLocalStateAfterMove(c,y,p),e.success("–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω")),S}catch(S){return H(S,"assigning ticket",e.error),!1}finally{t.draggedTicket.value=null}};return{loadSectorData:a,assignTicket:r,moveTicketToStage:async(c,y)=>await r(c,c.assigneeId,y),assignTicketToEmployee:async(c,y)=>await r(c,y,c.stageId),createTicket:async c=>{const y=Pe(c);if(!y.valid){const p=y.errors.join(", ");return e.error(p),0}try{const p=await W.createTicket(c);return p>0&&(await a(!1),e.success("–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω")),p}catch(p){return H(p,"creating ticket",e.error),0}},handleTicketDragStart:c=>{t.draggedTicket.value=c},handleTicketDrop:async(c,y,p)=>{await r(c,y,p)},loadingProgress:n,isTransitioning:i}}const ui={name:"DashboardSector1C",components:{DashboardStage:tt,LoadingPreloader:Ot},setup(){const t=fe(),e=Pt(),n=di(e);ge(()=>{n.loadSectorData()});const i=()=>{t.push("/")},s=()=>{n.loadSectorData(!1)},a=n.loadingProgress;return{isLoading:e.isLoading,error:e.error,stages:e.stages,zeroPointTickets:e.zeroPointTickets,employees:e.employees,draggedTicket:e.draggedTicket,currentStep:a.currentStep,progress:a.progress,stepDetails:a.stepDetails,loadingProgress:a,loadSectorData:n.loadSectorData,handleTicketDragStart:n.handleTicketDragStart,handleTicketDrop:n.handleTicketDrop,assignTicketToEmployee:n.assignTicketToEmployee,moveTicketToStage:n.moveTicketToStage,createTicket:n.createTicket,getEmployeeTickets:e.getEmployeeTickets,handleRetry:s,isTransitioning:n.isTransitioning,goBack:i}}},gi={class:"dashboard-header"},fi={key:0,class:"dashboard-content"},yi={class:"stages-container"};function mi(t,e,n,i,s,a){const r=b("LoadingPreloader"),l=b("DashboardStage");return m(),h("div",{class:L(["dashboard-sector-1c",{"is-dragging":i.draggedTicket}])},[u("div",gi,[u("button",{class:"back-button",onClick:e[0]||(e[0]=(...o)=>i.goBack&&i.goBack(...o)),"aria-label":"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é"},[...e[2]||(e[2]=[u("span",{class:"back-button-icon"},"‚Üê",-1),u("span",{class:"back-button-text"},"–ù–ê–ó–ê–î",-1)])]),e[3]||(e[3]=u("h1",null,"–î–∞—à–±–æ—Ä–¥ - –°–µ–∫—Ç–æ—Ä 1–°",-1))]),B(Q,{name:"preloader-fade"},{default:P(()=>[i.isLoading||i.error||i.currentStep?(m(),A(r,{key:0,"current-step":i.currentStep,progress:i.progress,"step-details":i.stepDetails,error:i.error||null,onRetry:i.handleRetry},null,8,["current-step","progress","step-details","error","onRetry"])):_("",!0)]),_:1}),B(Q,{name:"dashboard-fade"},{default:P(()=>[!i.isLoading&&!i.error&&!i.currentStep?(m(),h("div",fi,[u("div",yi,[(m(!0),h(C,null,N(i.stages,o=>(m(),A(l,{key:o.id,stage:o,"zero-point-tickets":i.zeroPointTickets[o.id]||[],onTicketMoved:i.handleTicketDrop,onTicketAssigned:i.assignTicketToEmployee},null,8,["stage","zero-point-tickets","onTicketMoved","onTicketAssigned"]))),128))])])):_("",!0)]),_:1}),u("button",{class:"floating-back-button",onClick:e[1]||(e[1]=(...o)=>i.goBack&&i.goBack(...o)),"aria-label":"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é",title:"–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é"},[...e[4]||(e[4]=[u("span",{class:"floating-back-button-icon"},"‚Üê",-1)])])],2)}const ki=M(ui,[["render",mi],["__scopeId","data-v-a3fb73fb"]]);export{ki as default};
