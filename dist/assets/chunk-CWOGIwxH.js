import{B as O}from"./chunk-C5D5xwuQ.js";const I={SECTOR_1C:366,SECTOR_HARDWARE:368,SECTOR_BITRIX24:369,SECTOR_PDM:367,KEEPER:1051},G=[I.SECTOR_1C,I.SECTOR_HARDWARE,I.SECTOR_BITRIX24,I.SECTOR_PDM];function Ie(e){return G.includes(e)}const X=140,N={FORMED:{name:"Сформировано обращение",bitrixId:"DT140_12:UC_0VHWE2"},REVIEW:{name:"Рассмотрение ТЗ",bitrixId:"DT140_12:PREPARATION"},EXECUTION:{name:"Исполнение",bitrixId:"DT140_12:CLIENT"}},q={"DT140_12:UC_0VHWE2":"formed","DT140_12:PREPARATION":"review","DT140_12:CLIENT":"execution"},J={formed:"DT140_12:UC_0VHWE2",review:"DT140_12:PREPARATION",execution:"DT140_12:CLIENT"};function Q(){return[N.FORMED.bitrixId,N.REVIEW.bitrixId,N.EXECUTION.bitrixId]}const Z="https://bitrix24.kompo.by",ee="servisdeskitotdel";function Se(e){return`${Z}/page/${ee}/servisdesk/type/${X}/details/${e}/`}const c={TODAY:"today",YESTERDAY:"yesterday",THIS_WEEK:"this_week",LAST_WEEK:"last_week",MORE_THAN_TWO_WEEKS:"more_than_two_weeks",UP_TO_ONE_MONTH:"up_to_one_month",MORE_THAN_TWO_MONTHS:"more_than_two_months",MORE_THAN_HALF_YEAR:"more_than_half_year",MORE_THAN_YEAR:"more_than_year"},b={[c.TODAY]:{label:"СЕГОДНЯ",color:"#28a745",backgroundColor:"#d4edda",textColor:"#155724"},[c.YESTERDAY]:{label:"ВЧЕРА",color:"#20c997",backgroundColor:"#d1f2eb",textColor:"#0c5460"},[c.THIS_WEEK]:{label:"НА ЭТОЙ НЕДЕЛЕ",color:"#17a2b8",backgroundColor:"#d1ecf1",textColor:"#0c5460"},[c.LAST_WEEK]:{label:"НА ПРОШЛОЙ НЕДЕЛЕ",color:"#ffc107",backgroundColor:"#fff3cd",textColor:"#856404"},[c.MORE_THAN_TWO_WEEKS]:{label:"БОЛЕЕ ДВУХ НЕДЕЛЬ",color:"#fd7e14",backgroundColor:"#ffe5d0",textColor:"#7d3f00"},[c.UP_TO_ONE_MONTH]:{label:"ДО 1 МЕСЯЦА",color:"#dc3545",backgroundColor:"#f8d7da",textColor:"#721c24"},[c.MORE_THAN_TWO_MONTHS]:{label:"БОЛЕЕ 2 МЕСЯЦЕВ",color:"#6c757d",backgroundColor:"#e2e3e5",textColor:"#383d41"},[c.MORE_THAN_HALF_YEAR]:{label:"БОЛЕЕ ПОЛУГОДА",color:"#6c757d",backgroundColor:"#d6d8db",textColor:"#212529"},[c.MORE_THAN_YEAR]:{label:"БОЛЕЕ ГОДА",color:"#343a40",backgroundColor:"#c6c8ca",textColor:"#000000"}};function Re(e){if(!e)return null;const t=String(e).trim();if(t.length===0)return null;try{const r=new Date(t);return isNaN(r.getTime())?(console.warn("Invalid date format:",e),null):r}catch(r){return console.error("Error parsing date:",e,r),null}}function D(e){if(!e)return"";let t;if(e instanceof Date?t=e:t=new Date(e),isNaN(t.getTime()))return"";const r=t.getDate(),o=t.getMonth()+1,n=t.getFullYear(),l=String(r).padStart(2,"0"),a=String(o).padStart(2,"0"),s=String(n);return`${l}.${a}.${s}`}function Ne(e,t=new Date){if(!e)return"";const r=e instanceof Date?e:new Date(e),o=t instanceof Date?t:new Date(t);if(isNaN(r.getTime())||isNaN(o.getTime()))return D(r);const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),a=new Date(o.getFullYear(),o.getMonth(),o.getDate())-n,s=Math.floor(a/(1e3*60*60*24));return s===0?"Сегодня":D(r)}function F(e,t=new Date){if(!e)return c.MORE_THAN_YEAR;const r=e instanceof Date?e:new Date(e),o=t instanceof Date?t:new Date(t);if(isNaN(r.getTime())||isNaN(o.getTime()))return c.MORE_THAN_YEAR;const n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),l=new Date(o.getFullYear(),o.getMonth(),o.getDate()),a=l-n;if(a<0)return c.TODAY;const s=Math.floor(a/(1e3*60*60*24)),f=Math.floor(s/7),i=Math.floor(s/30),u=Math.floor(s/365);if(s===0)return c.TODAY;if(s===1)return c.YESTERDAY;const d=new Date(l),p=l.getDay(),m=p===0?6:p-1;if(d.setDate(l.getDate()-m),d.setHours(0,0,0,0),n>=d&&s<7)return c.THIS_WEEK;const C=new Date(d);return C.setDate(d.getDate()-7),n>=C&&n<d?c.LAST_WEEK:f>=2&&i<1?c.MORE_THAN_TWO_WEEKS:i>=1&&i<2?c.UP_TO_ONE_MONTH:i>=2&&i<6?c.MORE_THAN_TWO_MONTHS:i>=6&&u<1?c.MORE_THAN_HALF_YEAR:c.MORE_THAN_YEAR}function S(e){return q[e]||"formed"}function De(e){return J[e]||"DT140_12:UC_0VHWE2"}function he(){return Q()}function U(e){return e==null?null:String(e).trim().toLowerCase()||null}const L=[{id:"general",label:"Генеральский",bitrixValue:"Генеральский",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:1,description:"Высший приоритет (генеральский уровень)"},{id:"external",label:"Внешние обстоятельства",bitrixValue:"Внешние обстоятельства",color:"#d63384",backgroundColor:"#fce8f3",textColor:"#8a1c56",order:2,description:"Внешние обстоятельства/блокеры"},{id:"board",label:"Задачи правления и совета директоров",bitrixValue:"Задачи правления и совета директоров",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:3,description:"Задачи правления / совета директоров"},{id:"errors",label:"Ошибки/сбои",bitrixValue:"Ошибки/сбои",color:"#dc3545",backgroundColor:"#fdecef",textColor:"#8c1b29",order:4,description:"Инциденты, ошибки и сбои"},{id:"operations",label:"Текущая деятельность",bitrixValue:"Текущая деятельность",color:"#6c757d",backgroundColor:"#f1f3f5",textColor:"#343a40",order:5,description:"Операционная деятельность"},{id:"projects",label:"Проекты",bitrixValue:"Проекты",color:"#198754",backgroundColor:"#e9f6ef",textColor:"#0f5132",order:6,description:"Проектные задачи"},{id:"optimization",label:"Оптимизация",bitrixValue:"Оптимизация",color:"#ffc107",backgroundColor:"#fff8e1",textColor:"#8c6d1f",order:7,description:"Оптимизация и улучшения"}],_={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых/неизвестных значений"},He=_.id,k={},w={};[...L,_].forEach(e=>{k[e.id]=e;const t=U(e.bitrixValue);t&&(w[t]=e)});function te(e){if(!e)return _;const t=String(e).trim();return k[t]||_}function P(e){const t=U(e);if(!t)return _;const r=w[t];return r||_}function re(){return[...L,_].sort((e,t)=>e.order-t.order)}function Y(e){if(e&&typeof e=="object"&&e.color)return{color:e.color,backgroundColor:e.backgroundColor,textColor:e.textColor};const t=te(e)||P(e)||_;return{color:t.color,backgroundColor:t.backgroundColor,textColor:t.textColor}}re();function j(e){return e==null?null:String(e).trim().toLowerCase()||null}const B=[{id:"1c-accounting",label:"1С.Бухгалтерия",bitrixValue:"1С.Бухгалтерия",color:"#0d6efd",backgroundColor:"#e7f1ff",textColor:"#0a58ca",order:1,description:"Бухгалтерский контур 1С"},{id:"1c-tickets",label:"1С.Талоны",bitrixValue:"1С.Талоны",color:"#20c997",backgroundColor:"#e6f7f1",textColor:"#0f5132",order:2,description:"Работа с талонами 1С"},{id:"1c-zup",label:"1С.ЗУП",bitrixValue:"1С.ЗУП",color:"#6f42c1",backgroundColor:"#f4edfd",textColor:"#3a275f",order:3,description:"Зарплата и управление персоналом"},{id:"1c-docflow",label:"1С.Документооборот",bitrixValue:"1С.Документооборот",color:"#fd7e14",backgroundColor:"#fff3e6",textColor:"#b54708",order:4,description:"Документооборот 1С"},{id:"1c-integrations",label:"1С.Интеграции",bitrixValue:"1С.Интеграции",color:"#0ca678",backgroundColor:"#e8f7f2",textColor:"#0b4f38",order:5,description:"Интеграции и сопряжения 1С"}],g={id:"unknown",label:"Не указано",bitrixValue:null,color:"#ced4da",backgroundColor:"#f1f3f5",textColor:"#6c757d",order:99,description:"Fallback для пустых или неидентифицированных значений"},oe={},V={};[...B,g].forEach(e=>{oe[e.id]=e;const t=j(e.bitrixValue);t&&(V[t]=e)});function ne(e){const t=j(e);if(!t)return g;const r=V[t];return r||g}function W(){return g}function ae(){return[...B,g].sort((e,t)=>e.order-t.order)}function v(e){const t=e&&typeof e=="object"?e:g;return{color:t.color||g.color,backgroundColor:t.backgroundColor||g.backgroundColor,textColor:t.textColor||g.textColor}}ae();function M(e){const t=parseInt(e.id||e.ID||0),r=e.title||e.TITLE||"Без названия",o=e.stageId||e.STAGE_ID||"",n=e.assignedById||e.ASSIGNED_BY_ID||null,l=e.createdTime||e.CREATED_DATE||e.CREATED_TIME||"",a=e.updatedTime||e.MODIFY_DATE||e.UPDATED_TIME||"",s=e.UF_SUBJECT||e.uf_subject||e.ufSubject||e.UF_SUBJECT||e.uf_subject||null,f=e.UF_CRM_7_DEPARTMENT_HEAD||e.uf_crm_7_department_head||e.ufCrm7DepartmentHead||e.UF_CRM_7_DEPARTMENT_HEAD||e.uf_crm_7_department_head||null;let i=null,u=null;if(f){const y=String(f).trim();y.length>0&&(u=y,i=y.length>17?y.substring(0,17):y)}const d=e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.ufCrm7UfPriority||e.UF_CRM_7_UF_PRIORITY||e.uf_crm_7_uf_priority||e.priority||e.PRIORITY||null,p=P(d),m=Y(p),C=e.UF_SLA_SERVICE_STR||e.uf_sla_service_str||e.UfSlaServiceStr||e.ufSlaServiceStr||e.service||null,A=ne(C),x=v(A),H=e.UF_ACTION_STR||e.uf_action_str||e.UfActionStr||e.ufActionStr||e.UF_ACTION_STR||e.uf_action_str||null,R=H?String(H).trim():null,$=R&&R.length>0?R:null;return{id:t,title:r,ufSubject:s,departmentHead:i,departmentHeadFull:u,priorityId:p.id,priorityLabel:p.label,priorityColors:m,priority:p.id,priorityBitrixValue:p.bitrixValue||null,service:A,serviceLabel:A.label,serviceColors:x,serviceBitrixValue:A.bitrixValue||W().bitrixValue,actionStr:$,status:se(),assigneeId:n?parseInt(n):null,stageId:S(o),createdAt:l,modifiedAt:a,amount:e.opportunity||e.OPPORTUNITY||0,currency:e.currencyId||e.CURRENCY_ID||"RUB",description:e.comments||e.COMMENTS||""}}function se(e){return"in_progress"}const h=140,E=new Map;class K{static async getTicketDetails(t){if(!t)return console.warn("Ticket ID is required"),null;try{const r=await O.call("crm.item.list",{entityTypeId:h,filter:{id:t},select:["*"],useOriginalUfNames:"Y"});let o=[];if(r&&r.result&&(Array.isArray(r.result)?o=r.result:r.result.items&&Array.isArray(r.result.items)?o=r.result.items:r.result.data&&Array.isArray(r.result.data)&&(o=r.result.data)),!o||o.length===0)return console.warn(`[TicketDetailsService] Ticket with ID ${t} not found`),null;const n=o[0];console.log("[TicketDetailsService] Bitrix24 ticket response:",{id:n.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!n.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:n.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(n),ticketSample:JSON.stringify(n).substring(0,500)});const l=M(n),a=n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||n.UF_CRM_7_DEPARTMENT_HEAD||n.uf_crm_7_department_head||n.ufCrm7DepartmentHead||null;console.log("[TicketDetailsService] Extracted departmentHead:",{ufDepartmentHead:a,mappedDepartmentHead:l.departmentHead,departmentHeadFull:a?String(a).trim():null});let s=null;if(a){const f=String(a).trim();f.length>0&&(s=f)}return{...l,departmentHeadFull:s}}catch(r){return console.error(`[TicketDetailsService] Error loading ticket details for ID ${t}:`,r),console.error("[TicketDetailsService] Error details:",{message:r.message,stack:r.stack,ticketId:t}),null}}static async getTicketsDetails(t){if(!t||!Array.isArray(t)||t.length===0)return[];const r=[],o=[];if(t.forEach(n=>{E.has(n)?r.push(E.get(n)):o.push(n)}),o.length===0)return r;try{console.log("[TicketDetailsService] Loading tickets via API:",{ticketIdsCount:o.length,ticketIdsSample:o.slice(0,5),entityTypeId:h});const n=await O.call("crm.item.list",{entityTypeId:h,filter:{id:o},select:["*"],useOriginalUfNames:"Y"});console.log("[TicketDetailsService] API response received:",{hasResult:!!n,resultType:typeof n,resultKeys:n?Object.keys(n):[],hasResultResult:!!n?.result,resultResultType:typeof n?.result,isArray:Array.isArray(n?.result),resultResultLength:Array.isArray(n?.result)?n.result.length:"not array",fullResult:n});let l=[];if(n&&n.result&&(Array.isArray(n.result)?l=n.result:n.result.items&&Array.isArray(n.result.items)?l=n.result.items:n.result.data&&Array.isArray(n.result.data)&&(l=n.result.data)),!l||l.length===0)return console.warn("[TicketDetailsService] No tickets in API response:",{hasResult:!!n,hasResultResult:!!n?.result,resultType:typeof n?.result,result:n,resultKeys:n?Object.keys(n):[]}),r;const a=l.map((s,f)=>{f===0&&console.log("[TicketDetailsService] Batch response sample (first ticket):",{id:s.id,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,UF_CRM_7_DEPARTMENT_HEAD:s.UF_CRM_7_DEPARTMENT_HEAD,allKeys:Object.keys(s).filter(m=>m.toLowerCase().includes("department")||m.toLowerCase().includes("uf_crm")),sampleTicketKeys:Object.keys(s).slice(0,20)});const i=M(s);f===0&&console.log("[TicketDetailsService] After mapTicket:",{ticketId:i.id,hasDepartmentHead:!!i.departmentHead,departmentHead:i.departmentHead,mappedTicketKeys:Object.keys(i).filter(m=>m.toLowerCase().includes("department"))});const u=s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||s.UF_CRM_7_DEPARTMENT_HEAD||s.uf_crm_7_department_head||s.ufCrm7DepartmentHead||null;f===0&&console.log("[TicketDetailsService] Extracting departmentHead from bitrixTicket:",{ufDepartmentHead:u,hasUF_CRM_7_DEPARTMENT_HEAD:!!s.UF_CRM_7_DEPARTMENT_HEAD,bitrixTicketKeys:Object.keys(s).filter(m=>m.toLowerCase().includes("department")||m.toLowerCase().includes("uf_crm"))});let d=null;if(u){const m=String(u).trim();m.length>0&&(d=m)}!d&&i.departmentHead&&(d=i.departmentHead);const p={...i,departmentHeadFull:d||i.departmentHead||null};return f===0&&console.log("[TicketDetailsService] Final ticket details:",{ticketId:p.id,departmentHead:p.departmentHead,departmentHeadFull:p.departmentHeadFull}),p.id&&E.set(p.id,p),p});return[...r,...a]}catch(n){return console.error("[TicketDetailsService] Error loading tickets details batch:",n),console.error("[TicketDetailsService] Error details:",{message:n.message,stack:n.stack,ticketIdsCount:t.length,ticketIdsSample:t.slice(0,5)}),r}}static clearCache(t=1e3){E.size>t&&E.clear()}static getCacheSize(){return E.size}}async function le(e,t,r,o=null){if(console.log("[popupNavigationUtils] getEmployeeTicketsForStage called:",{employeeId:e,stageId:t,hasSnapshot:!!r,snapshotType:r?typeof r:"null",snapshotKeys:r?Object.keys(r):[],hasTickets:!!r?.tickets,ticketsIsArray:Array.isArray(r?.tickets),ticketsLength:r?.tickets?.length||0}),!e||!t)return console.warn("[popupNavigationUtils] Employee ID and stage ID are required"),[];if(!r)return console.warn("[popupNavigationUtils] Snapshot is null or undefined"),[];if(!r.tickets)return console.warn("[popupNavigationUtils] Snapshot.tickets is missing. Snapshot keys:",Object.keys(r)),[];if(!Array.isArray(r.tickets))return console.warn("[popupNavigationUtils] Snapshot.tickets is not an array. Type:",typeof r.tickets),[];const n=r.tickets.filter(i=>{const u=i.assignedTo;return u?(typeof u=="object"?u.id:u)===e:!1});if(n.length===0)return[];const l=!n[0].stageId||!n[0].departmentHead;let a=null;if(l){const i=n.map(u=>u.id);if(o&&typeof o=="object")a=o;else try{const u=await K.getTicketsDetails(i);a=new Map,u.forEach(d=>{d&&d.id&&a.set(d.id,d)})}catch(u){console.warn("[popupNavigationUtils] Failed to load ticket details from API, using snapshot data:",u),a=null}}return n.map(i=>{const u=i.id,d={id:u,title:i.title||"Без названия",assignedTo:i.assignedTo,createdAt:i.createdAt,updatedAt:i.updatedAt};if(a){const p=a instanceof Map?a.get(u):a[u];p?(d.stageId=p.stageId||null,d.departmentHead=p.departmentHead||null,d.departmentHeadFull=p.departmentHeadFull||p.departmentHead||null):(d.stageId=null,d.departmentHead=null)}else d.stageId=i.stageId||null,d.departmentHead=i.departmentHead||null,d.departmentHeadFull=i.departmentHeadFull||i.departmentHead||null;return d}).filter(i=>i.stageId?S(i.stageId)===t:!0)}function Oe(e,t=new Date){if(!e||e.length===0)return[];const r=e.length,o={};return Object.values(c).forEach(l=>{o[l]={category:l,label:b[l].label,count:0,tickets:[],percentage:0,progressBarWidth:0,progressBarColor:b[l].color}}),e.forEach(l=>{if(!l.createdAt){o[c.MORE_THAN_YEAR].count++,o[c.MORE_THAN_YEAR].tickets.push(l);return}const a=F(l.createdAt,t);o[a]&&(o[a].count++,o[a].tickets.push(l))}),Object.values(o).filter(l=>l.count>0).map(l=>{const a=r>0?parseFloat((l.count/r*100).toFixed(1)):0;return{...l,percentage:a,progressBarWidth:a}}).sort((l,a)=>{const s=[c.TODAY,c.YESTERDAY,c.THIS_WEEK,c.LAST_WEEK,c.MORE_THAN_TWO_WEEKS,c.UP_TO_ONE_MONTH,c.MORE_THAN_TWO_MONTHS,c.MORE_THAN_HALF_YEAR,c.MORE_THAN_YEAR];return s.indexOf(l.category)-s.indexOf(a.category)})}function be(e){if(!e||e.length===0)return[];const t={};e.forEach(o=>{let n=o.departmentHeadFull||o.departmentHead;e.indexOf(o)<3&&console.log("[popupNavigationUtils] groupTicketsByDepartment - ticket sample:",{ticketId:o.id,departmentHead:o.departmentHead,departmentHeadFull:o.departmentHeadFull,allKeys:Object.keys(o).filter(l=>l.toLowerCase().includes("department"))}),n?(n=String(n).trim(),n.length===0&&(n="Без заказчика")):n="Без заказчика",t[n]||(t[n]={departmentName:n,count:0}),t[n].count++});const r=Object.values(t);return r.sort((o,n)=>n.count!==o.count?n.count-o.count:o.departmentName.localeCompare(n.departmentName,"ru")),r}function ie(e,t){return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function ce(e,t){if(!e||!t)return{sourceLevel:2,employeeId:e?.employeeId||null,employeeName:e?.employeeName||null,stageId:e?.stageId||null,stageName:e?.stageName||null,dateCategory:null,dateCategoryLabel:null,departmentName:t?.departmentName||null,tickets:[],snapshot:e?.snapshot||null,ticketDetails:e?.ticketDetails||null};const r=T(e.tickets||[],t.departmentName);return{sourceLevel:2,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:r,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}async function de(e,t){const r=await le(e.employeeId,e.stageId,e.snapshot,e.ticketDetails),o=z(r,e.dateCategory),n=T(o,t.departmentName);return{sourceLevel:3,employeeId:e.employeeId,employeeName:e.employeeName,stageId:e.stageId,stageName:e.stageName,dateCategory:e.dateCategory,dateCategoryLabel:e.dateCategoryLabel,departmentName:t.departmentName,tickets:n,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function ue(e,t){return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:t.category,dateCategoryLabel:t.label,departmentName:null,tickets:t.tickets||[],snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function fe(e,t){const r=(e.snapshot?.tickets||[]).filter(n=>n.stageId?S(n.stageId)===e.stageId:!1),o=T(r,t.departmentName);return{sourceLevel:1,employeeId:null,employeeName:null,stageId:e.stageId,stageName:e.stageName,dateCategory:null,dateCategoryLabel:null,departmentName:t.departmentName,tickets:o,snapshot:e.snapshot,ticketDetails:e.ticketDetails}}function pe(e,t){return!e||e.length===0?[]:e.filter(r=>r.stageId?S(r.stageId)===t:!1)}function me(e,t){return!e||e.length===0?[]:e.filter(r=>{const o=r.assignedTo;return o?(typeof o=="object"?o.id:o)===t:!1})}function z(e,t){if(!e||e.length===0)return[];const r=new Date;return e.filter(o=>o.createdAt?F(o.createdAt,r)===t:t===c.MORE_THAN_YEAR)}function T(e,t){return!e||e.length===0?[]:e.filter(r=>{let o=r.departmentHeadFull||r.departmentHead;return o?(o=String(o).trim(),o.length===0&&(o="Без заказчика")):o="Без заказчика",o===t})}async function ge(e){if(!e||!e.snapshot)return console.warn("[ticketListUtils] Invalid context or missing snapshot"),[];if(e.tickets&&e.tickets.length>0){let s=e.tickets;return e.departmentName&&(s=T(s,e.departmentName)),console.log("[ticketListUtils] Using tickets from context:",{originalCount:e.tickets.length,filteredCount:s.length,departmentFilter:e.departmentName}),s}const{snapshot:t,stageId:r,employeeId:o,dateCategory:n,departmentName:l}=e;let a=t.tickets||[];return r&&(a=pe(a,r)),o&&(a=me(a,o)),n&&(a=z(a,n)),l&&(a=T(a,l)),console.log("[ticketListUtils] Filtered tickets from snapshot:",{totalInSnapshot:t.tickets?.length||0,filteredCount:a.length,filters:{stageId:r,employeeId:o,dateCategory:n,departmentName:l}}),a}function _e(e){return e?e==="review"||e==="execution"?"in_progress":e==="done"||e==="closed"?"done":"new":"new"}function Ee(e){return e.filter(t=>{const r=!t.ufSubject||t.ufSubject==="",o=t.actionStr===null||t.actionStr===void 0,n=!t.description||t.description==="";return r||o||n})}function Te(e){const t=new Map;return e&&(Array.isArray(e)?e.forEach(r=>{r&&r.id&&t.set(r.id,r)}):typeof e=="object"&&Object.keys(e).forEach(r=>{const o=e[r];o&&o.id&&t.set(o.id,o)})),t}function ye(e,t){const r=t.get(e.id)||null,o={id:e.id,title:e.title||"Без названия",createdAt:e.createdAt||e.createdTime||"",updatedAt:e.updatedAt||e.updatedTime||e.modifiedAt||""};o.ufSubject=r?.ufSubject||e.ufSubject||null;const n=r?.priorityId||e.priorityId||"unknown",l=r?.priorityLabel||e.priorityLabel||"Не указано",a=Y(n);o.priorityId=n,o.priorityLabel=l,o.priorityColors=a,o.priority=n;const s=r?.service||e.service||W(),f=r?.serviceLabel||e.serviceLabel||s.label||"Не указано",i=v(s);return o.service=s,o.serviceLabel=f,o.serviceColors=i,o.actionStr=r?.actionStr||e.actionStr||e.ufActionStr||null,o.ufActionStr=o.actionStr,o.departmentHead=r?.departmentHead||e.departmentHead||null,o.departmentHeadFull=r?.departmentHeadFull||e.departmentHeadFull||e.departmentHead||null,o.description=r?.description||e.description||e.comments||"",o.assignedTo=e.assignedTo||null,o.assigneeId=e.assigneeId||e.assignedTo?.id||null,o.stageId=e.stageId||null,!o.status&&o.stageId?o.status=_e(o.stageId):o.status=e.status||"new",o}async function Ce(e,t=null,r=null){if(console.time("[Performance] prepareTicketsForDisplay"),!e||e.length===0)return console.timeEnd("[Performance] prepareTicketsForDisplay"),[];const o=Ee(e);console.log("[ticketListUtils] Tickets needing details:",{total:e.length,needingDetails:o.length,alreadyHaveDetails:e.length-o.length});let n=r||null;if(o.length>0&&!r){const s=o.map(f=>f.id).filter(f=>f);if(s.length>0)try{console.log("[ticketListUtils] Loading ticket details via API:",{ticketIdsCount:s.length,ticketIdsSample:s.slice(0,5)}),n=await K.getTicketsDetails(s),console.log("[ticketListUtils] Ticket details loaded:",{loadedCount:n?.length||0,sampleTicket:n?.[0]?{id:n[0].id,hasUfSubject:!!n[0].ufSubject,hasActionStr:!!n[0].actionStr,hasDescription:!!n[0].description}:null})}catch(f){console.warn("[ticketListUtils] Failed to load ticket details:",f),console.error("[ticketListUtils] Error details:",{message:f.message,stack:f.stack,ticketIdsCount:s.length}),n=null}}const l=Te(n),a=e.map(s=>ye(s,l));return console.log("[ticketListUtils] Tickets prepared for display:",{totalPrepared:a.length,sampleTicket:a[0]?{id:a[0].id,hasUfSubject:!!a[0].ufSubject,hasPriorityColors:!!a[0].priorityColors,hasServiceColors:!!a[0].serviceColors}:null}),console.timeEnd("[Performance] prepareTicketsForDisplay"),a}const Me=Object.freeze(Object.defineProperty({__proto__:null,createContextFromLevel1Department:fe,createContextFromLevel1Time:ue,createContextFromLevel2:ie,createContextFromLevel2Department:ce,createContextFromLevel3:de,filterTicketsByContext:ge,filterTicketsByDepartment:T,prepareTicketsForDisplay:Ce},Symbol.toStringTag,{value:"Module"}));export{b as D,X as E,N as S,K as T,J as a,le as b,Oe as c,be as d,I as e,M as f,Se as g,P as h,Ie as i,Y as j,he as k,De as l,S as m,Ne as n,F as o,Re as p,te as q,He as r,Me as t};
