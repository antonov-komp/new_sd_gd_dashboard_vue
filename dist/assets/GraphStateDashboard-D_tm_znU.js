import{_ as Ie,r as C,c as j,m as ve,G as Te,a as _,o as T,b as l,d as P,g as we,F as le,f as ce,j as ye,t as W,p as L,H as Ee,v as he,n as Ce,x as Ye,I as Je,u as Se,L as Ke,C as Ge,J as qe,k as me,l as Xe,i as Ze,B as Qe,K as et,D as tt,M as F,q as Ve,N as Le,z as at,e as st,y as nt}from"./main-CflQYwfj.js";import{L as ze,D as rt,B as ot}from"./index-fhfDMLu8.js";import{S as _e,d as $e,K as it,D as He}from"./index-dNmKZW5X.js";const Y={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class Z{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,s={}){try{if(!e||typeof e!="object")throw new ee("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new ee("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const o=this.validateSectorData(e);if(!o.isValid)throw new ee(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});const a=this.normalizeSectorData(e),c={metadata:this.generateSnapshotMetadata(t,s.createdBy,s.sectorId||Y.defaultSectorId),statistics:a.statistics,ticketIds:a.ticketIds,tickets:a.tickets},r=this.validateSnapshot(c);if(!r.isValid)throw new ee(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});r.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",r.warnings);const i=this.getApiBaseUrl(),g=await fetch(`${i}${Y.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:c,type:t,date:this.formatDate(new Date)})});if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const y=await g.json();if(!y.success)throw new Error(y.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return y.data.snapshot}catch(o){throw console.error("SnapshotService.createSnapshot error:",o),o instanceof ee?o:new ee(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${o.message}`,"API_ERROR",{originalError:o})}}static async getSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${Y.snapshotsEndpoint}?action=get&date=${s}&type=${t}`,n=await fetch(a,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!c.success)throw new Error(c.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return c.data.snapshot}catch(s){throw console.error("SnapshotService.getSnapshot error:",s),s}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",Y.defaultSectorId);const o=`${this.getApiBaseUrl()}${Y.snapshotsEndpoint}?${t.toString()}`,a=await fetch(o,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(!n.success)throw new Error(n.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(n.data.snapshots.map(async r=>{try{return await this.getSnapshot(r.date,r.type)}catch(i){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${r.date}/${r.type}:`,i),null}}))).filter(r=>r!==null).sort((r,i)=>new Date(r.metadata.createdAt)-new Date(i.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:s=[],zeroPointTickets:o={}}=e,a={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},n=[],c=[],r=[];t.forEach(y=>{const m=y.id;if(a[m]){let B=0;y.employees.forEach($=>{const A=$.tickets||[];B+=A.length;let f=n.find(h=>h.id===$.id);f||(f={id:$.id,name:$.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(f)),A.forEach(h=>{c.push(h.id),r.push({id:h.id,title:h.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:$.id,name:$.name},createdAt:h.createdAt||"",updatedAt:h.modifiedAt||h.updatedAt||""}),f.ticketsByStage[m]=(f.ticketsByStage[m]||0)+1,f.totalTickets+=1})}),a[m].count=B}});const i={unassigned:0,keeper:0,total:0};Object.values(o).forEach(y=>{Array.isArray(y)&&y.forEach(m=>{i.total+=1,m.assigneeId===1051||m.assignedById===1051?i.keeper+=1:i.unassigned+=1,c.push(m.id),r.push({id:m.id,title:m.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:m.assignedTo||m.assignedById?{id:m.assignedById||m.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:m.createdAt||"",updatedAt:m.modifiedAt||m.updatedAt||""})})});const g=Object.values(a).reduce((y,m)=>y+m.count,0)+i.total;return{statistics:{stages:{...a,total:g},employees:n,zeroPoint:i},ticketIds:[...new Set(c)],tickets:r}}static generateSnapshotMetadata(e,t,s){const o=new Date,a=-o.getTimezoneOffset(),n=Math.floor(a/60),c=a%60,r=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(c).padStart(2,"0")}`,i=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}T${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}:${String(o.getSeconds()).padStart(2,"0")}${r}`;return{version:Y.snapshotVersion,createdAt:i,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:s,sectorName:s==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${s}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${o}`}static buildFilePath(e,t){const s=typeof e=="string"?new Date(e):e,o=s.getFullYear(),a=this.getWeekNumber(s),n=this.formatDate(e);let c;if(t==="current"){const r=new Date,i=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;c=`current-state-${n}-${i}.json`}else if(t==="manual"){const r=new Date,i=`${String(r.getHours()).padStart(2,"0")}-${String(r.getMinutes()).padStart(2,"0")}-${String(r.getSeconds()).padStart(2,"0")}`;c=`manual-${n}-${i}.json`}else c=`${t}-${n}.json`;return t==="current"?`current/${c}`:`${o}/week-${a}/${c}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),s=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-s);const o=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-o)/864e5+1)/7)}static validateSnapshot(e){var o,a,n;const t=[],s=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const c=e.statistics.stages,r=(((o=c.formed)==null?void 0:o.count)||0)+(((a=c.review)==null?void 0:a.count)||0)+(((n=c.execution)==null?void 0:n.count)||0);c.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${c.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const c=e.statistics.zeroPoint,r=(c.unassigned||0)+(c.keeper||0);c.total!==r&&s.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${r}, —É–∫–∞–∑–∞–Ω–æ ${c.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const c=new Set(e.ticketIds),r=new Set(e.tickets.map(i=>i.id));c.size!==r.size&&s.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((i,g)=>{i.id||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),i.title||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!i.assignedTo||!i.assignedTo.id)&&s.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),i.createdAt||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),i.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:s}}static validateSectorData(e){const t=[],s=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:s}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:s})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const s=this.formatDate(e),a=`${this.getApiBaseUrl()}${Y.snapshotsEndpoint}`,n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:s,type:t})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!c.success)throw new Error(c.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(s){throw console.error("SnapshotService.deleteSnapshot error:",s),s}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let s=0;for(const o of t)try{await this.deleteSnapshot(o.metadata.createdAt.split("T")[0],o.metadata.type)&&s++}catch(a){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${o.metadata.createdAt}:`,a)}return s}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=Y.snapshotVersion){const s=this.getSnapshotVersion(e);return s===t||s==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${s} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,s=this.getWeekNumber(t);return{year:t.getFullYear(),week:s}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,o=(t.getDay()||7)-1,a=new Date(t);return a.setDate(t.getDate()-o),a.setHours(0,0,0,0),a}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,o=7-(t.getDay()||7),a=new Date(t);return a.setDate(t.getDate()+o),a.setHours(23,59,59,999),a}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),s=this.getWeekEndDate(e),o=this.getWeekNumberInfo(e),a=await this.getAllSnapshots({startDate:t,endDate:s}),n=a.find(i=>i.metadata.type==="week_start")||null,c=a.find(i=>i.metadata.type==="week_end")||null,r=a.filter(i=>i.metadata.type==="manual");return{weekStart:n,weekEnd:c,manual:r,weekInfo:o}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof ee)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),s={week_start:0,week_end:0,manual:0,current:0},o=new Map;let a=null,n=null;t.forEach(r=>{const i=r.metadata.type;s.hasOwnProperty(i)&&s[i]++;const g=this.getWeekNumberInfo(r.metadata.createdAt),y=`${g.year}-W${g.week}`;o.set(y,(o.get(y)||0)+1);const m=new Date(r.metadata.createdAt);(!a||m<new Date(a.metadata.createdAt))&&(a=r),(!n||m>new Date(n.metadata.createdAt))&&(n=r)});const c=Array.from(o.entries()).map(([r,i])=>{const[g,y]=r.split("-W");return{year:parseInt(g),week:parseInt(y),count:i}}).sort((r,i)=>r.year!==i.year?r.year-i.year:r.week-i.week);return{total:t.length,byType:s,byWeek:c,oldest:a,newest:n}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class ee extends Error{constructor(e,t,s={}){super(e),this.name="SnapshotError",this.code=t,this.details=s}}const J={formed:{bitrixId:$e.formed,name:_e.FORMED.name},review:{bitrixId:$e.review,name:_e.REVIEW.name},execution:{bitrixId:$e.execution,name:_e.EXECUTION.name}},de=it;function lt(S){if(!S||typeof S!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!S.stages||!Array.isArray(S.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=ct(S.stages),t=dt(S.stages),s=ut(S.zeroPointTickets||{}),o=pt(S.zeroPointTickets||{}),a=ft(S.stages,S.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:s,zeroPointByStage:o},ticketIds:a.ticketIds,tickets:a.tickets}}function ct(S){const e={formed:{count:0,stageId:J.formed.bitrixId,stageName:J.formed.name},review:{count:0,stageId:J.review.bitrixId,stageName:J.review.name},execution:{count:0,stageId:J.execution.bitrixId,stageName:J.execution.name},total:0};return S.forEach(t=>{if(!J[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let s=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(o=>{o.tickets&&Array.isArray(o.tickets)&&(s+=o.tickets.length)}),e[t.id].count=s,e.total+=s}),e}function dt(S){const e=new Map;return S.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(s=>{if(!s||!s.id)return;e.has(s.id)||e.set(s.id,{id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const o=e.get(s.id),a=s.tickets&&Array.isArray(s.tickets)?s.tickets.length:0;J[t.id]&&(o.ticketsByStage[t.id]=(o.ticketsByStage[t.id]||0)+a),o.totalTickets+=a})}),Array.from(e.values())}function ut(S){let e=0,t=0;return!S||typeof S!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(S).forEach(s=>{Array.isArray(s)&&s.forEach(o=>{if(!o)return;const a=o.assignedTo||o.assignedById;!a||a===null?e++:(typeof a=="object"?a.id:a)===de?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function pt(S){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!S||typeof S!="object"||Object.keys(e).forEach(t=>{const s=S[t];Array.isArray(s)&&s.forEach(o=>{if(!o)return;const a=o.assignedTo||o.assignedById;!a||a===null?e[t].unassigned++:(typeof a=="object"?a.id:a)===de?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function ft(S,e){const t=new Set,s=new Map;return Array.isArray(S)&&S.forEach(o=>{!o.employees||!Array.isArray(o.employees)||o.employees.forEach(a=>{!a.tickets||!Array.isArray(a.tickets)||a.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const c=parseInt(n.id);if(isNaN(c)){console.warn("Invalid ticket ID:",n.id);return}t.add(c);let r=n.assignedTo;!r&&a.id&&(r={id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`}),s.set(c,{id:c,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:r||null,createdAt:ge(n.createdAt||n.createdTime),updatedAt:ge(n.updatedAt||n.modifiedAt||n.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(o=>{Array.isArray(o)&&o.forEach(a=>{if(!a||!a.id){console.warn("Ticket without ID found in zero point:",a);return}const n=parseInt(a.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",a.id);return}t.add(n);let c=a.assignedTo;if(!c&&a.assignedById){const r=typeof a.assignedById=="object"?a.assignedById.id||a.assignedById.value:a.assignedById;r&&r!==de?c={id:r,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:r===de&&(c={id:de,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}s.set(n,{id:n,title:a.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:c||null,createdAt:ge(a.createdAt||a.createdTime),updatedAt:ge(a.updatedAt||a.modifiedAt||a.updatedTime)})})}),{ticketIds:Array.from(t).sort((o,a)=>o-a),tickets:Array.from(s.values())}}function ge(S){if(!S)return null;if(S instanceof Date)return S.toISOString();if(typeof S=="string"){if(S.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return S;const e=new Date(S);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",S),null}class Be{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:s=null,normalize:o=!0,includeTicketDetails:a=!1}=e;try{const n=await He.getSectorData(t,s);return o?lt(n):(a&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),n)}catch(n){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",n),n}}static async isDataAvailable(){try{const e=await He.getSectorData(!0);return e!=null}catch{return!1}}}class Ae{static compareTwoSnapshots(e,t,s={}){const{includeTickets:o=!1,includeEmployees:a=!0}=s,n=this.validateSnapshot(e),c=this.validateSnapshot(t);if(!n.valid||!c.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...c.errors].join(", "));const r=this.buildComparisonMetadata(e,t),i=this.compareStages(e.statistics.stages,t.statistics.stages),g=a?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],y=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),m=o?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,B=this.buildSummary(i,g,y,m);return{metadata:r,stages:i,employees:g,zeroPoint:y,tickets:m,summary:B}}static calculateDelta(e,t){const s=this.normalizeValue(e),o=this.normalizeValue(t),a=o-s;let n=0;s!==0?n=a/s*100:o!==0&&(n=o>0?1/0:-1/0);const c=this.getTrend(a);return{value1:s,value2:o,delta:a,deltaPercent:Math.round(n*100)/100,trend:c}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var c,r;const s=["formed","review","execution"],o={};for(const i of s){const g=((c=e[i])==null?void 0:c.count)||0,y=((r=t[i])==null?void 0:r.count)||0;o[i]=this.calculateDelta(g,y)}const a=e.total||0,n=t.total||0;return o.total=this.calculateDelta(a,n),o}static compareEmployees(e,t){var c,r;const s=new Map(e.map(i=>[i.id,i])),o=new Map(t.map(i=>[i.id,i])),a=new Set([...s.keys(),...o.keys()]),n=[];for(const i of a){const g=s.get(i)||null,y=o.get(i)||null;if(!g||!y){n.push({id:i,name:(g==null?void 0:g.name)||(y==null?void 0:y.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,snapshot2:y?{ticketsByStage:y.ticketsByStage||{},totalTickets:y.totalTickets||0}:null,delta:this.calculateEmployeeDelta(g,y),trend:g?"removed":"new"});continue}const m={},B=["formed","review","execution"];for(const A of B){const f=((c=g.ticketsByStage)==null?void 0:c[A])||0,h=((r=y.ticketsByStage)==null?void 0:r[A])||0;m[A]=this.calculateDelta(f,h)}const $=this.calculateDelta(g.totalTickets||0,y.totalTickets||0);n.push({id:i,name:g.name,snapshot1:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},snapshot2:{ticketsByStage:y.ticketsByStage||{},totalTickets:y.totalTickets||0},delta:{ticketsByStage:m,totalTickets:$},trend:$.trend})}return n}static calculateEmployeeDelta(e,t){var n,c;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const s={},o=["formed","review","execution"];for(const r of o){const i=((n=e==null?void 0:e.ticketsByStage)==null?void 0:n[r])||0,g=((c=t==null?void 0:t.ticketsByStage)==null?void 0:c[r])||0;s[r]=this.calculateDelta(i,g)}const a=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:s,totalTickets:a}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,s,o){var B,$;const a=new Set(e),n=new Set(t),c=t.filter(A=>!a.has(A)),r=e.filter(A=>!n.has(A)),i=[],g=[],y=new Map(s.map(A=>[A.id,A])),m=new Map(o.map(A=>[A.id,A]));for(const A of e){if(!n.has(A))continue;const f=y.get(A),h=m.get(A);if(!f||!h)continue;const E=(((B=f.assignedTo)==null?void 0:B.id)||null)!==((($=h.assignedTo)==null?void 0:$.id)||null),M=(f.stageId||null)!==(h.stageId||null);E||M?i.push(A):g.push(A)}return{new:c,removed:r,changed:i,unchanged:g}}static buildComparisonMetadata(e,t){const s=new Date(e.metadata.createdAt),o=new Date(t.metadata.createdAt),a=new Date,n=o.getTime()-s.getTime(),c=Math.floor(n/(1e3*60*60*24)),r=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:a.toISOString(),timeDiff:{days:c,hours:r,minutes:i,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,t,s,o){var i,g,y;const a=e.total.delta,n=Object.keys(e).filter(m=>m==="total"?!1:e[m].delta!==0).length,c=t.filter(m=>m.trend==="new"||m.trend==="removed"?!0:m.delta.totalTickets.delta!==0).length,r=a!==0||n>0||c>0;return{totalDelta:a,stagesChanged:n,employeesChanged:c,hasChanges:r,newTicketsCount:((i=o==null?void 0:o.new)==null?void 0:i.length)||0,removedTicketsCount:((g=o==null?void 0:o.removed)==null?void 0:g.length)||0,changedTicketsCount:((y=o==null?void 0:o.changed)==null?void 0:y.length)||0}}static validateSnapshot(e){const t=[],s=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:s};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const o=["formed","review","execution"];for(const a of o)e.statistics.stages[a]||s.push(`Missing stage: ${a}`)}e.statistics.employees||s.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||s.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:s}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const c=this.validateSnapshot(n);if(!c.valid)throw new Error("Invalid snapshot: "+c.errors.join(", "))}const s=[...e].sort((n,c)=>{const r=new Date(n.metadata.createdAt),i=new Date(c.metadata.createdAt);return r-i}),o=[];for(let n=0;n<s.length-1;n++)o.push({from:n,to:n+1,result:this.compareTwoSnapshots(s[n],s[n+1],t)});const a=this.buildTrends(s);return{snapshots:s.map((n,c)=>({index:c,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:o,trends:a}}static buildTrends(e){var s,o,a,n,c,r,i,g,y,m;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const B of e){const $=B.statistics;t.stages.formed.push(((o=(s=$.stages)==null?void 0:s.formed)==null?void 0:o.count)||0),t.stages.review.push(((n=(a=$.stages)==null?void 0:a.review)==null?void 0:n.count)||0),t.stages.execution.push(((r=(c=$.stages)==null?void 0:c.execution)==null?void 0:r.count)||0),t.stages.total.push(((i=$.stages)==null?void 0:i.total)||0),t.zeroPoint.unassigned.push(((g=$.zeroPoint)==null?void 0:g.unassigned)||0),t.zeroPoint.keeper.push(((y=$.zeroPoint)==null?void 0:y.keeper)||0),t.zeroPoint.total.push(((m=$.zeroPoint)==null?void 0:m.total)||0)}return t}}const gt={class:"graph-state-chart"},ht={class:"chart-header"},mt={class:"chart-type-selector"},vt=["onClick","title"],wt={class:"chart-type-icon"},yt={class:"chart-type-label"},St={key:0,class:"comparison-type-selector"},kt={class:"radio-group"},bt={key:0},Dt={key:1},Tt={key:1,class:"chart-filters"},Et=["onUpdate:modelValue"],_t={class:"filter-label"},$t={key:2,class:"graph-legend"},At={key:4,class:"error-container"},Ct={class:"error-message"},It={key:5,class:"chart-container"},Bt={key:6,class:"no-data"},Rt={key:7,class:"employees-details"},xt={class:"employees-details-content"},Mt={class:"stage-details-header"},Ot={class:"stage-details-name"},Ft={class:"stage-details-count"},Nt={class:"stage-details-employees"},Pt={class:"employee-detail-name"},Wt={class:"employee-detail-count"},jt={key:0,class:"no-employees-in-stage"},Ut={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(S,{emit:e}){const t=(b,u)=>typeof window>"u"?u:getComputedStyle(document.documentElement).getPropertyValue(b).trim()||u,s=S,o=e,a=C(!1),n=C(null),c=C(null),r=C({weekStart:null,weekEnd:null,current:null}),i=C(null),g=C("weekStartToWeekEnd"),y=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],m=C("line"),B=C(!0),$=C([]),A=j(()=>{switch(m.value){case"line":return ze;case"bar":return ot;case"doughnut":return rt;default:return ze}}),f={formed:t("--b24-primary","#007bff"),review:t("--b24-warning","#ffc107"),execution:t("--b24-success","#28a745")},h=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:f.formed},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:f.review},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:f.execution}],E=C({formed:!0,review:!0,execution:!0});function M(b){var p;const u=r.value.current||r.value.weekEnd||r.value.weekStart;return!u||!u.statistics||!u.statistics.stages?0:((p=u.statistics.stages[b])==null?void 0:p.count)||0}function U(b){const u=r.value.current||r.value.weekEnd||r.value.weekStart;if(!u||!u.statistics)return[];const p=[];u.statistics.employees&&Array.isArray(u.statistics.employees)&&u.statistics.employees.filter(k=>k.ticketsByStage&&k.ticketsByStage[b]>0).forEach(k=>{p.push({id:k.id,name:k.name,count:k.ticketsByStage[b]||0})});const v=G(b);return v>0&&p.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:v,isKeeper:!0}),p.sort((k,O)=>O.count-k.count)}function G(b){const u=r.value.current||r.value.weekEnd||r.value.weekStart;if(!u||!u.statistics)return 0;if(u.statistics.zeroPointByStage&&u.statistics.zeroPointByStage[b])return u.statistics.zeroPointByStage[b].keeper||0;if(u.statistics.zeroPoint){const p=u.statistics.zeroPoint.keeper||0;return Math.floor(p/3)}return 0}const te=Se();function ae(){const b=new Map;[r.value.weekStart,r.value.weekEnd,r.value.current].forEach(u=>{!u||!u.statistics||!u.statistics.employees||u.statistics.employees.forEach(p=>{b.has(p.id)||b.set(p.id,{id:p.id,name:p.name})})}),$.value=Array.from(b.values()).sort((u,p)=>u.name.localeCompare(p.name))}function se(b,u="background"){var v;return((v={increase:{background:t("--b24-success","#28a745"),border:t("--b24-success-hover","#218838"),point:t("--b24-success","#28a745")},decrease:{background:t("--b24-danger","#dc3545"),border:t("--b24-danger-hover","#c82333"),point:t("--b24-danger","#dc3545")},stable:{background:t("--b24-text-muted","#9ca3af"),border:t("--b24-text-secondary","#6b7280"),point:t("--b24-text-muted","#9ca3af")}}[b])==null?void 0:v[u])||t("--b24-text-secondary","#6c757d")}function ue(){if(!(!r.value.weekStart||!r.value.weekEnd))try{const b=Ae.compareTwoSnapshots(r.value.weekStart,r.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let u=null,p=null;r.value.current&&(u=Ae.compareTwoSnapshots(r.value.weekEnd,r.value.current,{includeTickets:!1,includeEmployees:!0}),p=Ae.compareTwoSnapshots(r.value.weekStart,r.value.current,{includeTickets:!1,includeEmployees:!0})),i.value={weekStartToWeekEnd:b,weekEndToCurrent:u,weekStartToCurrent:p}}catch(b){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",b),te.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+b.message)}}function z(b){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[b]||"formed"}const pe=j(()=>{if(!c.value)return null;if(m.value==="doughnut")return c.value;const b=c.value.datasets.filter(u=>{const p=h.find(v=>v.name===u.label);return p?E.value[p.id]:!0});return{...c.value,datasets:b}}),ke=j(()=>{const b={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:m.value==="doughnut"?"right":"top",onClick:(u,p,v)=>{const k=p.datasetIndex;if(k!==void 0){const O=v.chart.getDatasetMeta(k);O.hidden=!O.hidden,v.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:u=>u[0].label||"",label:u=>{var O,x,w,d,R,D;const p=u.dataset.label||"",v=u.parsed.y||u.parsed||0,k=u.dataIndex;if(m.value==="doughnut"){const I=u.dataset.data.reduce((H,K)=>H+K,0),V=I>0?(v/I*100).toFixed(1):0;return`${p}: ${v} (${V}%)`}else{if(!i.value||k===0||m.value==="doughnut")return`${p}: ${v}`;let I=null;const V=z(p);if(g.value==="weekStartToWeekEnd"&&k===1?I=(x=(O=i.value.weekStartToWeekEnd)==null?void 0:O.stages)==null?void 0:x[V]:g.value==="weekEndToCurrent"&&k===2&&r.current?I=(d=(w=i.value.weekEndToCurrent)==null?void 0:w.stages)==null?void 0:d[V]:g.value==="weekStartToCurrent"&&k===2&&r.current&&(I=(D=(R=i.value.weekStartToCurrent)==null?void 0:R.stages)==null?void 0:D[V]),!I)return`${p}: ${v}`;const H=I.delta,K=I.deltaPercent,Q=I.trend;let X=`${p}: ${v}`;if(H!==0){const oe=H>0?"+":"",fe=Q==="increase"?"‚Üë":Q==="decrease"?"‚Üì":"‚Üí";X+=` (${oe}${H}, ${oe}${K.toFixed(1)}%) ${fe}`}else X+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return X}},afterBody:u=>{if(m.value==="doughnut"||!i.value)return[];const p=u[0].dataIndex;if(p===0)return[];let v=null;if(z(u[0].dataset.label||""),g.value==="weekStartToWeekEnd"&&p===1?v=i.value.weekStartToWeekEnd:g.value==="weekEndToCurrent"&&p===2?v=i.value.weekEndToCurrent:g.value==="weekStartToCurrent"&&p===2&&(v=i.value.weekStartToCurrent),!v||!v.metadata)return[];const k=v.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${k.days} –¥–Ω. ${k.hours} —á. ${k.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return m.value==="line"||m.value==="bar"?{...b,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:m.value==="doughnut"?{...b,cutout:"60%"}:b});function ne(b){const u=new Date(b),p=u.getFullYear(),v=String(u.getMonth()+1).padStart(2,"0"),k=String(u.getDate()).padStart(2,"0");return`${p}-${v}-${k}`}function be(b){const{current:u,weekEnd:p}=b,v=u||p;if(!v||!v.statistics||!v.statistics.stages)return null;const k=[],O=[],x=[],w=[];return h.forEach(d=>{var D;const R=((D=v.statistics.stages[d.id])==null?void 0:D.count)||0;R>0&&(k.push(d.name),O.push(R),x.push(d.color+"80"),w.push(d.color))}),O.length===0?null:{labels:k,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:O,backgroundColor:x,borderColor:w,borderWidth:2}]}}function De(b){if(m.value==="doughnut")return be(b);const{weekStart:u,weekEnd:p,current:v}=b,k=[],O=[];return h.forEach(x=>{var V,H,K,Q,X,oe,fe,Re,xe,Me,Oe,Fe,Ne,Pe,We,je,Ue;const w=[];if(u&&u.statistics&&u.statistics.stages){const N=u.statistics.stages[x.id];if(k.length===0){const ie=(V=u.metadata)!=null&&V.createdAt?new Date(u.metadata.createdAt):null;k.push(ie?ne(ie):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}w.push((N==null?void 0:N.count)||0)}else k.length===0&&k.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),w.push(0);if(p&&p.statistics&&p.statistics.stages){const N=p.statistics.stages[x.id];if(k.length===1){const ie=(H=p.metadata)!=null&&H.createdAt?new Date(p.metadata.createdAt):null;k.push(ie?ne(ie):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}w.push((N==null?void 0:N.count)||0)}else k.length===1&&k.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),w.push(0);if(v&&s.showCurrentState&&v.statistics&&v.statistics.stages){const N=v.statistics.stages[x.id];k.length===2&&k.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),w.push((N==null?void 0:N.count)||0)}const d=["stable"];i.value?g.value==="weekStartToWeekEnd"?(d.push(((X=(Q=(K=i.value.weekStartToWeekEnd)==null?void 0:K.stages)==null?void 0:Q[x.id])==null?void 0:X.trend)||"stable"),v&&d.push(((Re=(fe=(oe=i.value.weekStartToCurrent)==null?void 0:oe.stages)==null?void 0:fe[x.id])==null?void 0:Re.trend)||"stable")):g.value==="weekEndToCurrent"&&v?(d.push("stable"),d.push(((Oe=(Me=(xe=i.value.weekEndToCurrent)==null?void 0:xe.stages)==null?void 0:Me[x.id])==null?void 0:Oe.trend)||"stable")):g.value==="weekStartToCurrent"&&v?(d.push(((Pe=(Ne=(Fe=i.value.weekStartToWeekEnd)==null?void 0:Fe.stages)==null?void 0:Ne[x.id])==null?void 0:Pe.trend)||"stable"),d.push(((Ue=(je=(We=i.value.weekStartToCurrent)==null?void 0:We.stages)==null?void 0:je[x.id])==null?void 0:Ue.trend)||"stable")):(d.push("stable"),v&&d.push("stable")):(d.push("stable"),v&&d.push("stable"));let R,D,I;i.value&&m.value!=="doughnut"?(R=d.map(N=>se(N,"background")+"40"),D=d.map(N=>se(N,"border")),I=d.map(N=>se(N,"point"))):(R=x.color+"40",D=x.color,I=x.color),O.push({label:x.name,data:w,backgroundColor:(Array.isArray(R),R),borderColor:(Array.isArray(D),D),borderWidth:2,pointBackgroundColor:(Array.isArray(I),I),pointBorderColor:(Array.isArray(D),D),pointRadius:6,pointHoverRadius:8,fill:m.value!=="line",tension:m.value==="line"?.4:0})}),k.length===0&&(k.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),s.showCurrentState&&k.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:k,datasets:O}}const re=async()=>{var b,u,p;a.value=!0,n.value=null;try{const v=(b=s.period)!=null&&b.endDate?new Date(s.period.endDate):new Date,k=(u=s.period)!=null&&u.startDate?new Date(s.period.startDate):Z.getWeekStartDate(v),O=(p=s.period)!=null&&p.endDate?new Date(s.period.endDate):Z.getWeekEndDate(v),x=Z.formatDate(k),w=Z.formatDate(O),[d,R]=await Promise.all([Z.getSnapshot(x,"week_start"),Z.getSnapshot(w,"week_end")]);let D=null;s.showCurrentState&&(D=await Be.getSectorDataForSnapshot({useCache:!1,normalize:!0})),r.value={weekStart:d,weekEnd:R,current:D},ae(),ue(),q(),o("data-loaded",{weekStart:d,weekEnd:R,current:D})}catch(v){console.error("Error loading chart data:",v),n.value=v.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",te.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+n.value),o("error",n.value)}finally{a.value=!1}};ve(()=>{re()});const q=()=>{c.value=De({weekStart:r.value.weekStart,weekEnd:r.value.weekEnd,current:r.value.current})};return Te(()=>[s.period,s.showCurrentState],()=>{re()},{deep:!0}),Te(m,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&q()}),Te(g,()=>{(r.value.weekStart||r.value.weekEnd||r.value.current)&&q()}),(b,u)=>(T(),_("div",gt,[l("div",ht,[u[3]||(u[3]=l("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),l("div",mt,[(T(),_(le,null,ce(y,p=>l("button",{key:p.value,onClick:v=>m.value=p.value,class:ye(["chart-type-btn",{active:m.value===p.value}]),title:p.label},[l("span",wt,W(p.icon),1),l("span",yt,W(p.label),1)],10,vt)),64))])]),!a.value&&!n.value&&i.value&&m.value!=="doughnut"?(T(),_("div",St,[u[7]||(u[7]=l("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),l("div",kt,[l("label",null,[L(l("input",{type:"radio","onUpdate:modelValue":u[0]||(u[0]=p=>g.value=p),value:"weekStartToWeekEnd",onChange:q},null,544),[[Ee,g.value]]),u[4]||(u[4]=l("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),r.value.current?(T(),_("label",bt,[L(l("input",{type:"radio","onUpdate:modelValue":u[1]||(u[1]=p=>g.value=p),value:"weekEndToCurrent",onChange:q},null,544),[[Ee,g.value]]),u[5]||(u[5]=l("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0),r.value.current?(T(),_("label",Dt,[L(l("input",{type:"radio","onUpdate:modelValue":u[2]||(u[2]=p=>g.value=p),value:"weekStartToCurrent",onChange:q},null,544),[[Ee,g.value]]),u[6]||(u[6]=l("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0)])])):P("",!0),!a.value&&!n.value&&c.value?(T(),_("div",Tt,[(T(),_(le,null,ce(h,p=>l("label",{key:p.id,class:"filter-checkbox"},[L(l("input",{type:"checkbox","onUpdate:modelValue":v=>E.value[p.id]=v,onChange:q},null,40,Et),[[he,E.value[p.id]]]),l("span",{class:"filter-color",style:Ce({backgroundColor:p.color})},null,4),l("span",_t,W(p.name),1)])),64))])):P("",!0),!a.value&&!n.value&&i.value&&m.value!=="doughnut"?(T(),_("div",$t,[...u[8]||(u[8]=[Ye('<h4 class="legend-title" data-v-b4f51d6b>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-b4f51d6b><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-increase" data-v-b4f51d6b></span><span data-v-b4f51d6b>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-decrease" data-v-b4f51d6b></span><span data-v-b4f51d6b>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-stable" data-v-b4f51d6b></span><span data-v-b4f51d6b>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):P("",!0),a.value?(T(),we(Ke,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):n.value?(T(),_("div",At,[l("p",Ct,"‚ùå "+W(n.value),1),l("button",{onClick:re,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):pe.value?(T(),_("div",It,[(T(),we(Je(A.value),{data:pe.value,options:ke.value,height:300},null,8,["data","options"]))])):(T(),_("div",Bt,[...u[9]||(u[9]=[l("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),l("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),!a.value&&!n.value&&c.value&&B.value?(T(),_("div",Rt,[u[10]||(u[10]=l("h4",{class:"employees-details-title"},"–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º",-1)),l("div",xt,[(T(),_(le,null,ce(h,p=>l("div",{key:p.id,class:"stage-details"},[l("div",Mt,[l("span",{class:"stage-details-color",style:Ce({backgroundColor:p.color})},null,4),l("h5",Ot,W(p.name),1),l("span",Ft," –í—Å–µ–≥–æ: "+W(M(p.id))+" —Ç–∏–∫–µ—Ç–æ–≤ ",1)]),l("div",Nt,[(T(!0),_(le,null,ce(U(p.id),v=>(T(),_("div",{key:`${p.id}-${v.id}`,class:ye(["employee-detail-item",{"employee-detail-keeper":v.isKeeper}])},[l("span",Pt,W(v.name),1),l("span",Wt,W(v.count)+" —Ç–∏–∫–µ—Ç–æ–≤",1)],2))),128)),U(p.id).length===0?(T(),_("div",jt," –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ ")):P("",!0)])])),64))])])):P("",!0)]))}},Vt=Ie(Ut,[["__scopeId","data-v-b4f51d6b"]]),Lt={key:0,class:"create-snapshot-button-container"},zt=["disabled"],Ht={class:"modal-content"},Kt={class:"modal-header"},Gt=["disabled"],qt={class:"modal-body"},Xt={key:0,class:"progress-container"},Yt={class:"progress-bar-wrapper"},Jt={class:"progress-text"},Zt={class:"progress-percent"},Qt={class:"progress-description"},ea={key:1},ta={class:"modal-footer"},aa=["disabled"],sa=["disabled"],na={key:0},ra={key:0},oa={key:1},ia={key:2},la={key:1},ca={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(S,{emit:e}){const t=S,s=e,o=C(t.user),a=C(!1),n=C(!1),c=C(0),r=C("idle"),i=C(""),g=Se(),y=j(()=>o.value?tt(o.value):!1);ve(async()=>{if(!t.user)try{const f=await Ge.checkAccess();f.allowed&&(o.value=f.user)}catch(f){console.error("Error loading user:",f)}});const m=()=>{if(!y.value){g.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}a.value=!0},B=()=>{n.value||(a.value=!1,r.value="idle",c.value=0,i.value="")},$=async()=>{if(!n.value){if(!y.value){g.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}n.value=!0,r.value="loading_data",c.value=0,i.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{i.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const f=await Be.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:M=>{var G;const U=Math.min(80,(M.progress||0)*.8);c.value=U,r.value="loading_data",i.value=M.description||((G=M.details)==null?void 0:G.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});r.value="creating_snapshot",c.value=85,i.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const h=o.value;if(!h)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const E=await Z.createSnapshot(f,"manual",{createdBy:{id:h.ID,name:`${h.NAME||""} ${h.LAST_NAME||""}`.trim()||h.EMAIL||`User ${h.ID}`},sectorId:"1C"});r.value="success",c.value=100,i.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",g.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),s("snapshot-created",E),setTimeout(()=>{B()},1500)}catch(f){r.value="error",c.value=0,i.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",f);let h="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";f.message&&(f.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||f.message.includes("sector data")?h="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":f.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||f.message.includes("snapshot")?h="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":f.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||f.message.includes("validation")?h="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":h=f.message),g.error(h)}finally{n.value=!1}}},A=f=>{f.key==="Escape"&&a.value&&!n.value&&B()};return ve(()=>{window.addEventListener("keydown",A)}),qe(()=>{window.removeEventListener("keydown",A)}),(f,h)=>y.value?(T(),_("div",Lt,[l("button",{class:"create-snapshot-btn",onClick:m,disabled:n.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...h[1]||(h[1]=[l("span",{class:"btn-icon"},"üì∏",-1),l("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,zt),(T(),we(et,{to:"body"},[me(Qe,{name:"modal"},{default:Xe(()=>[a.value?(T(),_("div",{key:0,class:"modal-overlay",onClick:h[0]||(h[0]=Ze(E=>!n.value&&B(),["self"]))},[l("div",Ht,[l("div",Kt,[h[2]||(h[2]=l("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),l("button",{class:"modal-close",onClick:B,disabled:n.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,Gt)]),l("div",qt,[r.value!=="idle"?(T(),_("div",Xt,[l("div",Yt,[l("div",{class:"progress-bar",style:Ce({width:`${c.value}%`})},null,4)]),l("div",Jt,[l("span",Zt,W(Math.round(c.value))+"%",1),l("span",Qt,W(i.value),1)])])):(T(),_("div",ea,[...h[3]||(h[3]=[l("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),l("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),l("div",ta,[l("button",{class:"btn btn-secondary",onClick:B,disabled:n.value}," –û—Ç–º–µ–Ω–∞ ",8,aa),l("button",{class:"btn btn-primary",onClick:$,disabled:n.value},[n.value?(T(),_("span",na,[r.value==="loading_data"?(T(),_("span",ra,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):r.value==="creating_snapshot"?(T(),_("span",oa,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(T(),_("span",ia,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(T(),_("span",la,"–°–æ–∑–¥–∞—Ç—å"))],8,sa)])])])):P("",!0)]),_:1})]))])):P("",!0)}},da=Ie(ca,[["__scopeId","data-v-09bccee2"]]);function ua(){const S=C(!1),e=C(null),t=C(null),s=C(0),o=Se(),a=async(f=!0,h=null)=>{S.value=!0,e.value=null,s.value=0;try{const E=await Be.getSectorDataForSnapshot({useCache:f,onProgress:M=>{M&&typeof M.progress=="number"&&(s.value=M.progress),h&&h(M)},normalize:!0});return t.value=E,E}catch(E){throw e.value=E.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",o.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+e.value),E}finally{S.value=!1,s.value=100}},n=async(f,h={})=>{if(!t.value){const E="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw e.value=E,o.error(E),new Error(E)}S.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(f))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${f}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const E=await Z.createSnapshot(t.value,f,h);return o.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),E}catch(E){throw e.value=E.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",o.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+e.value),E}finally{S.value=!1}},c=()=>{S.value=!1,e.value=null,t.value=null,s.value=0},r=j(()=>t.value!==null&&t.value!==void 0),i=C({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),g=j(()=>{const f=new Date;let h,E;switch(i.value.dateRange){case"last-week":h=new Date(f),h.setDate(f.getDate()-7),E=f;break;case"last-2-weeks":h=new Date(f),h.setDate(f.getDate()-14),E=f;break;case"last-month":h=new Date(f),h.setMonth(f.getMonth()-1),E=f;break;case"custom":h=i.value.customDateRange.startDate?new Date(i.value.customDateRange.startDate):null,E=i.value.customDateRange.endDate?new Date(i.value.customDateRange.endDate):null;break;default:h=new Date(f),h.setDate(f.getDate()-7),E=f}return{startDate:h?h.toISOString().split("T")[0]:null,endDate:E?E.toISOString().split("T")[0]:null}}),y=()=>{B()},m=()=>{i.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},B()},B=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(i.value))}catch(f){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",f)}},$=()=>{try{const f=localStorage.getItem("graphStateFilters");if(f){const h=JSON.parse(f);h&&typeof h=="object"&&(i.value={stages:h.stages||{formed:!0,review:!0,execution:!0},employees:h.employees||["all"],dateRange:h.dateRange||"last-week",customDateRange:h.customDateRange||{startDate:null,endDate:null}})}}catch(f){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",f)}},A=j(()=>{const f=Object.values(i.value.stages).some(M=>!M),h=!i.value.employees.includes("all"),E=i.value.dateRange!=="last-week";return f||h||E});return{isLoading:S,error:e,currentSectorData:t,loadingProgress:s,hasSectorData:r,filters:i,selectedPeriod:g,hasActiveFilters:A,loadSectorDataForSnapshot:a,createSnapshot:n,resetState:c,applyFilters:y,resetFilters:m,saveFiltersToLocalStorage:B,loadFiltersFromLocalStorage:$}}const pa={class:"graph-state-dashboard"},fa={key:1,class:"error-message-container"},ga={class:"error-message"},ha={class:"error-text"},ma={key:0,class:"error-details"},va={class:"dashboard-header"},wa={class:"header-content"},ya={class:"breadcrumbs-row"},Sa=["aria-disabled","data-fallback","disabled"],ka={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},ba={class:"header-actions"},Da=["disabled"],Ta={key:0},Ea={key:1},_a={class:"filters-header"},$a=["disabled"],Aa={class:"filters-content"},Ca={class:"filter-group"},Ia={class:"checkbox-group"},Ba={class:"checkbox-item"},Ra={class:"checkbox-item"},xa={class:"checkbox-item"},Ma={class:"filter-group"},Oa=["value"],Fa={class:"filter-group"},Na={key:0,class:"filter-group custom-date-range"},Pa={class:"date-range-inputs"},Wa={class:"date-input-group"},ja=["max"],Ua={class:"date-input-group"},Va=["min","max"],La={key:0,class:"filter-error"},za={key:1,class:"filter-hint"},Ha={key:3,class:"dashboard-content"},Ka={class:"chart-container"},Ga="–ù–∞–∑–∞–¥",qa={__name:"GraphStateDashboard",setup(S){const e=(w,d)=>typeof window>"u"?d:getComputedStyle(document.documentElement).getPropertyValue(w).trim()||d,t=Se(),s=at(),o={name:"dashboard-sector-1c"},{filters:a,selectedPeriod:n,hasActiveFilters:c,applyFilters:r,resetFilters:i,loadFiltersFromLocalStorage:g}=ua(),y=C(null),m=C(!0),B=C([]),$=C(!1),A=C("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),f=C(null),h=C(!1),E=C(!1),M=C(typeof window<"u"?window.innerWidth:1024),U=C(null),G=C(!1),te=j(()=>M.value<768);j(()=>M.value>=768&&M.value<1024),j(()=>M.value>=1024);const ae=j(()=>typeof window>"u"?!1:window.history.length>1),se=j(()=>{const w=new Date;return w.setFullYear(w.getFullYear()-1),w.toISOString().split("T")[0]}),ue=j(()=>new Date().toISOString().split("T")[0]);function z(){r()}function pe(){i(),U.value=null,z(),t.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function ke(){a.value.dateRange!=="custom"&&(U.value=null,z())}function ne(){const w=be(a.value.customDateRange.startDate,a.value.customDateRange.endDate);if(!w.valid){U.value=w.error;return}U.value=null,z()}function be(w,d){if(!w||!d)return{valid:!1,error:"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–±–µ –¥–∞—Ç—ã"};const R=new Date(w),D=new Date(d);return R>D?{valid:!1,error:"–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π"}:Math.ceil((D-R)/(1e3*60*60*24))>365?{valid:!1,error:"–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π"}:{valid:!0}}function De(w){t.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function re(w){$.value=!1,A.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",w)}function q(w){$.value=!1,b({message:w||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function b(w){f.value={message:w.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:w.details||null,type:w.type||"error",timestamp:new Date},console.error("Dashboard error:",f.value),t.error(f.value.message)}function u(){f.value=null}function p(){f.value=null,$.value=!0,A.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function v(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}h.value=!0;try{const w=document.querySelector(".chart-container");if(!w)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const d=window.html2canvas,R=await d(w,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),D=window.jsPDF,I=new D("landscape","mm","a4"),V=297,H=R.height*V/R.width;I.setFontSize(18),I.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const K=new Date().toLocaleDateString("ru-RU");I.setFontSize(10);const Q=n.value.startDate&&n.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${n.value.startDate} - ${n.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";I.text(Q,148.5,25,{align:"center"}),I.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${K}`,148.5,30,{align:"center"}),I.addImage(R.toDataURL("image/png"),"PNG",10,35,V-20,H-20),I.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${K}`,author:"Bitrix24 Dashboard"});const X=`graph-state-${K.replace(/\//g,"-")}.pdf`;I.save(X),t.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(w){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",w),b({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(w.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:w.stack,type:"error"})}finally{h.value=!1}}function k(w){var d;if((d=w==null?void 0:w.preventDefault)==null||d.call(w),!G.value){G.value=!0;try{if(ae.value){s.back();return}console.warn("GraphStateDashboard: fallback navigation to dashboard-sector-1c"),s.push(o)}finally{G.value=!1}}}function O(){typeof window<"u"&&(M.value=window.innerWidth)}async function x(){try{const w=await Ge.checkAccess();w.allowed&&(y.value=w.user)}catch(w){console.error("Error loading user:",w)}}return ve(()=>{g(),x(),typeof window<"u"&&(M.value=window.innerWidth,window.addEventListener("resize",O))}),qe(()=>{typeof window<"u"&&window.removeEventListener("resize",O)}),(w,d)=>{const R=st("router-link");return T(),_("div",pa,[$.value?(T(),we(Ke,{key:0,message:A.value},null,8,["message"])):P("",!0),f.value?(T(),_("div",fa,[l("div",ga,[l("div",{class:"error-header"},[d[8]||(d[8]=l("span",{class:"error-icon"},"‚ùå",-1)),d[9]||(d[9]=l("h3",null,"–û—à–∏–±–∫–∞",-1)),l("button",{onClick:u,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),l("p",ha,W(f.value.message),1),f.value.details?(T(),_("div",ma,[l("details",null,[d[10]||(d[10]=l("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),l("pre",null,W(f.value.details),1)])])):P("",!0),l("div",{class:"error-actions"},[l("button",{onClick:p,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):P("",!0),l("div",va,[l("div",wa,[l("div",ya,[l("button",{class:"btn-back-link",type:"button",onClick:k,"aria-label":Ga,"aria-disabled":!ae.value,"data-fallback":!ae.value,disabled:G.value,title:"–ù–∞–∑–∞–¥"}," ‚Üê ",8,Sa),l("nav",ka,[me(R,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Xe(()=>[...d[11]||(d[11]=[nt(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),d[12]||(d[12]=l("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),d[13]||(d[13]=l("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))])]),d[14]||(d[14]=l("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),d[15]||(d[15]=l("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),l("div",ba,[l("button",{onClick:v,class:"btn-export-pdf",disabled:h.value||$.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[h.value?(T(),_("span",Ea,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(T(),_("span",Ta,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,Da),me(da,{user:y.value,onSnapshotCreated:De},null,8,["user"])])]),te.value?(T(),_("button",{key:2,class:"mobile-filters-toggle",onClick:d[0]||(d[0]=D=>E.value=!E.value)},[d[16]||(d[16]=l("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),l("span",{class:ye(["toggle-icon",{open:E.value}])},"‚ñº",2)])):P("",!0),l("div",{class:ye(["filters-panel",{"mobile-open":E.value&&te.value,"mobile-closed":!E.value&&te.value}])},[l("div",_a,[d[17]||(d[17]=l("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),l("button",{onClick:pe,class:"btn-reset-filters",disabled:!F(c)}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,$a)]),l("div",Aa,[l("div",Ca,[d[21]||(d[21]=l("label",{class:"filter-label"},"–≠—Ç–∞–ø—ã:",-1)),l("div",Ia,[l("label",Ba,[L(l("input",{type:"checkbox","onUpdate:modelValue":d[1]||(d[1]=D=>F(a).stages.formed=D),onChange:z},null,544),[[he,F(a).stages.formed]]),d[18]||(d[18]=l("span",null,"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",-1))]),l("label",Ra,[L(l("input",{type:"checkbox","onUpdate:modelValue":d[2]||(d[2]=D=>F(a).stages.review=D),onChange:z},null,544),[[he,F(a).stages.review]]),d[19]||(d[19]=l("span",null,"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",-1))]),l("label",xa,[L(l("input",{type:"checkbox","onUpdate:modelValue":d[3]||(d[3]=D=>F(a).stages.execution=D),onChange:z},null,544),[[he,F(a).stages.execution]]),d[20]||(d[20]=l("span",null,"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",-1))])])]),l("div",Ma,[d[23]||(d[23]=l("label",{class:"filter-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:",-1)),L(l("select",{"onUpdate:modelValue":d[4]||(d[4]=D=>F(a).employees=D),multiple:"",onChange:z,class:"employees-select",size:"5"},[d[22]||(d[22]=l("option",{value:"all"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",-1)),(T(!0),_(le,null,ce(B.value,D=>(T(),_("option",{key:D.id,value:D.id},W(D.name),9,Oa))),128))],544),[[Ve,F(a).employees]]),d[24]||(d[24]=l("small",{class:"filter-hint"}," –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac) ",-1))]),l("div",Fa,[d[26]||(d[26]=l("label",{class:"filter-label"},"–ü–µ—Ä–∏–æ–¥:",-1)),L(l("select",{"onUpdate:modelValue":d[5]||(d[5]=D=>F(a).dateRange=D),onChange:ke,class:"date-range-select"},[...d[25]||(d[25]=[l("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),l("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),l("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),l("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],544),[[Ve,F(a).dateRange]])]),F(a).dateRange==="custom"?(T(),_("div",Na,[d[29]||(d[29]=l("label",{class:"filter-label"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥:",-1)),l("div",Pa,[l("div",Wa,[d[27]||(d[27]=l("label",null,"–°:",-1)),L(l("input",{type:"date","onUpdate:modelValue":d[6]||(d[6]=D=>F(a).customDateRange.startDate=D),onChange:ne,max:F(a).customDateRange.endDate||ue.value,class:"date-input"},null,40,ja),[[Le,F(a).customDateRange.startDate]])]),l("div",Ua,[d[28]||(d[28]=l("label",null,"–ü–æ:",-1)),L(l("input",{type:"date","onUpdate:modelValue":d[7]||(d[7]=D=>F(a).customDateRange.endDate=D),onChange:ne,min:F(a).customDateRange.startDate||se.value,max:ue.value,class:"date-input"},null,40,Va),[[Le,F(a).customDateRange.endDate]])])]),U.value?(T(),_("small",La,W(U.value),1)):(T(),_("small",za," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):P("",!0)])],2),!$.value&&!f.value?(T(),_("div",Ha,[l("div",Ka,[me(Vt,{period:F(n),"show-current-state":m.value,onDataLoaded:re,onError:q},null,8,["period","show-current-state"])])])):P("",!0)])}}},Za=Ie(qa,[["__scopeId","data-v-957cfd49"]]);export{Za as default};
