var V=Object.defineProperty;var q=(r,t,e)=>t in r?V(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var k=(r,t,e)=>q(r,typeof t!="symbol"?t+"":t,e);import{D as z}from"./chunk-CkjSx-Pz.js";import{i as Z,C as K}from"./main-CRD-9ltg.js";import{i as J,e as B,m as P,f as v,h as X,j as Q,k as tt,l as G,E as et}from"./chunk-DB8knvNz.js";const M="dashboard-sector-1c-logger-level",_={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4};class it{static getLevel(){if(typeof localStorage<"u"){const t=localStorage.getItem(M);if(t&&_[t]!==void 0)return t}return"ERROR"}static setLevel(t){return _[t]!==void 0?(typeof localStorage<"u"&&localStorage.setItem(M,t),!0):!1}static isEnabled(t,e=null){const i=e||this.getLevel();if(i==="NONE")return!1;const s=_[t]||0,a=_[i]||0;return s<=a}static getLevels(){return{..._}}static reset(){typeof localStorage<"u"&&localStorage.removeItem(M)}}class f{static getLevelColor(t){return{ERROR:"#dc3545",WARN:"#ffc107",INFO:"#17a2b8",DEBUG:"#6c757d"}[t]||"#6c757d"}static formatMessage(t,e,i=""){const s=new Date().toISOString(),a=this.getLevelColor(t),n=`%c[${s}] %c[${t}] %c[${i||"Unknown"}] %c${e}`,u=["color: #6c757d; font-weight: normal",`color: ${a}; font-weight: bold`,"color: #007bff; font-weight: normal","color: #212529; font-weight: normal"];return{formatted:n,styles:u}}static log(t,e,i="",s=null){if(!it.isEnabled(t))return;const a=this.formatMessage(t,e,i),n=[a.formatted,...a.styles];switch(s!=null&&n.push(s),t){case"ERROR":console.error(...n);break;case"WARN":console.warn(...n);break;case"INFO":console.info(...n);break;case"DEBUG":console.log(...n);break;default:console.log(...n)}}static error(t,e="",i=null){this.log("ERROR",t,e,i)}static warn(t,e="",i=null){this.log("WARN",t,e,i)}static info(t,e="",i=null){this.log("INFO",t,e,i)}static debug(t,e="",i=null){this.log("DEBUG",t,e,i)}}class rt{constructor(){this.reset()}reset(){this.metrics={ticketsLoading:{stages:{},totalLoaded:0},filtering:{total:0,filtered:0,rejected:[],tagValueExamples:[]},employees:{uniqueIds:[],totalUnique:0,ticketsWithoutAssignedById:[],ticketsWithAssignedById1051:[]},grouping:{distributionByStages:{},ticketsNotInColumn:[],unknownStages:[]},zeroPoint:{byStage:{}}}}logTicketsLoading(t,e,i,s=null){this.metrics.ticketsLoading.stages[t]||(this.metrics.ticketsLoading.stages[t]={loaded:0,batches:[],total:0});const a=this.metrics.ticketsLoading.stages[t];a.loaded=i,a.batches.push({count:e,total:i,next:s}),a.total=i,this.metrics.ticketsLoading.totalLoaded=Object.values(this.metrics.ticketsLoading.stages).reduce((n,u)=>n+u.total,0)}logFiltering(t,e,i=[],s=[]){this.metrics.filtering.total=t,this.metrics.filtering.filtered=e,this.metrics.filtering.rejected=i.slice(0,50),this.metrics.filtering.tagValueExamples=s.slice(0,20)}logEmployees(t,e=[],i=[]){this.metrics.employees.uniqueIds=t,this.metrics.employees.totalUnique=t.length,this.metrics.employees.ticketsWithoutAssignedById=e.slice(0,50),this.metrics.employees.ticketsWithAssignedById1051=i.slice(0,50)}logGrouping(t,e=[],i=[]){t.forEach(s=>{const a={};let n=0;s.employees.forEach(u=>{const c=(u.ticketsInsideSector||[]).length+(u.ticketsOutsideSector||[]).length;a[u.id]=c,n+=c}),this.metrics.grouping.distributionByStages[s.id]={employees:a,total:n}}),this.metrics.grouping.ticketsNotInColumn=e.slice(0,50),this.metrics.grouping.unknownStages=i.slice(0,50)}logZeroPoint(t){Object.keys(t).forEach(e=>{this.metrics.zeroPoint.byStage[e]=Array.isArray(t[e])?t[e].length:0})}getMetrics(){return this.metrics}getProblematicTickets(){return{withoutAssignedById:this.metrics.employees.ticketsWithoutAssignedById,withAssignedById1051:this.metrics.employees.ticketsWithAssignedById1051,withoutSectorTag:this.metrics.filtering.rejected,notInColumn:this.metrics.grouping.ticketsNotInColumn,unknownStage:this.metrics.grouping.unknownStages}}exportToJSON(){return JSON.stringify({metrics:this.metrics,problematicTickets:this.getProblematicTickets(),timestamp:new Date().toISOString()},null,2)}}let $=null;function E(){return $||($=new rt),$}function T(r=null,t=null){if(t&&!Z(t))return!1;if(r&&r.query&&r.query.diagnostics==="true")return!0;if(typeof window<"u"&&window.location){const e=window.location.hash;if(e){const s=e.split("?");if(s.length>1){const a=s[1];if(new URLSearchParams(a).get("diagnostics")==="true")return!0}if(e.includes("diagnostics=true"))return!0}if(new URLSearchParams(window.location.search).get("diagnostics")==="true")return!0}return typeof localStorage<"u"?localStorage.getItem("dashboard-sector-1c-diagnostics")==="true":!1}class I{static async call(t,e={}){return await new z().call(t,e)}}class h{static get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>e.ttl?(this.cache.delete(t),null):e.data:null}static set(t,e,i=this.DEFAULT_TTL){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:i})}static delete(t){this.cache.delete(t)}static clear(){this.cache.clear()}static invalidateByPrefix(t){const e=[];for(const i of this.cache.keys())i.startsWith(t)&&e.push(i);e.forEach(i=>this.cache.delete(i))}static cleanExpired(){const t=Date.now(),e=[];for(const[i,s]of this.cache.entries())t-s.timestamp>s.ttl&&e.push(i);e.forEach(i=>this.cache.delete(i))}static getStats(){const t=Date.now();let e=0,i=0;for(const s of this.cache.values())t-s.timestamp>s.ttl?e++:i++;return{total:this.cache.size,valid:i,expired:e}}static getTicketsCacheKey(t){return`tickets:stage:${t}`}static getAllTicketsCacheKey(){return"tickets:all"}static getEmployeesCacheKey(t){return`employees:ids:${[...t].sort((i,s)=>i-s).join(",")}`}static getSectorDataCacheKey(){return"sector:data"}static invalidateTicketsCache(){this.invalidateByPrefix("tickets:"),this.invalidateByPrefix("sector:")}static invalidateEmployeesCache(){this.invalidateByPrefix("employees:")}}k(h,"cache",new Map),k(h,"DEFAULT_TTL",5*60*1e3),k(h,"EMPLOYEES_TTL",30*60*1e3),k(h,"TICKETS_TTL",5*60*1e3);typeof window<"u"&&setInterval(()=>{h.cleanExpired()},5*60*1e3);function y(r,t,e={}){if(!r||typeof r!="string")throw new Error("Step must be a non-empty string");const i=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0;let s=e.description;return s||(s=st(r,e)),{step:r,progress:i,details:{...e,description:s}}}function st(r,t){return r==="loading_tickets"&&t.stageName&&t.stageIndex!==void 0?`Загрузка тикетов стадии "${t.stageName}" (${t.stageIndex}/${t.totalStages||1})...`:r==="filtering"&&t.filteredTickets!==void 0&&t.totalTickets!==void 0?`Фильтрация тикетов: ${t.filteredTickets} из ${t.totalTickets}...`:r==="grouping"&&t.employeeCount!==void 0?`Группировка тикетов по ${t.employeeCount} сотрудникам...`:t.count!==void 0&&t.total!==void 0?`Обработка: ${t.count} из ${t.total}...`:"Загрузка данных..."}function F(r){if(!r||typeof r!="object")throw new Error("Progress info must be an object");const t=r.step||null;if(!t)throw new Error("Step is required in progress info");const e=r.progress!==void 0&&r.progress!==null?r.progress:r.percent!==void 0&&r.percent!==null?r.percent:void 0,i=r.details||{};return r.stage&&(i.stage=r.stage),r.stageName&&(i.stageName=r.stageName),r.stageIndex!==void 0&&(i.stageIndex=r.stageIndex),r.totalStages!==void 0&&(i.totalStages=r.totalStages),r.count!==void 0&&(i.count=r.count),r.total!==void 0&&(i.total=r.total),r.warning&&(i.warning=r.warning),{step:t,progress:e!=null?Math.max(0,Math.min(100,e)):void 0,details:i}}function Y(r,t,e){const i=typeof r=="number"&&!isNaN(r)?Math.max(0,Math.min(100,r)):0,s=typeof t=="number"&&!isNaN(t)?Math.max(0,Math.min(100,t)):0,a=typeof e=="number"&&!isNaN(e)?Math.max(0,Math.min(100,e)):0,n=i+s*a/100;return Math.max(0,Math.min(100,n))}const A=140;class w{static async getAllTickets(t,e=null,i=!0){const s=[],a=t.length;try{for(let n=0;n<t.length;n++){const u=t[n],c=this.getStageName(u);if(e){const l=n/a*100;e(y("loading_tickets",l,{stage:u,stageName:c,stageIndex:n+1,totalStages:a}))}try{const l=await this.getTicketsByStage(u,i,e?o=>{const d=Y(n/a*100,1/a*100,o.percent||0);e(y("loading_tickets",d,{stage:u,stageName:c,stageIndex:n+1,totalStages:a,count:o.count,total:o.total}))}:null);s.push(...l)}catch(l){f.error(`Error loading tickets for stage ${u}`,"TicketRepository",l);let o=`Ошибка загрузки стадии "${c}"`;throw l.message&&(l.message.includes("HTTP error")||l.message.includes("network")?o=`Ошибка соединения при загрузке стадии "${c}". Проверьте подключение к интернету.`:l.message.includes("timeout")?o=`Превышено время ожидания при загрузке стадии "${c}". Попробуйте позже.`:l.message.includes("403")||l.message.includes("401")?o=`Ошибка доступа при загрузке стадии "${c}". Проверьте права доступа.`:o=`Ошибка загрузки стадии "${c}": ${l.message}`),new Error(o)}}}catch(n){throw f.error("Error in getAllTickets","TicketRepository",n),n}return s}static getStageName(t){return{"DT140_12:UC_0VHWE2":"Сформировано обращение","DT140_12:PREPARATION":"Рассмотрение ТЗ","DT140_12:CLIENT":"Исполнение"}[t]||t}static async getTicketsByStage(t,e=!0,i=null){if(e){const o=h.getTicketsCacheKey(t),d=h.get(o);if(d!==null){try{const g=E();g&&T()&&g.logTicketsLoading(t,d.length,d.length,null)}catch(g){f.warn("Diagnostics logging error (cache hit) in getTicketsByStage","TicketRepository",g)}return i&&i(F({step:"loading_tickets",percent:100,count:d.length,total:d.length})),d}}const s=[];let a=0;const n=50;let u=!0,c=0,l=null;for(;u;)try{const o=await I.call("crm.item.list",{entityTypeId:A,filter:{stageId:t},select:["*"],order:{id:"DESC"},start:a,useOriginalUfNames:"Y"});let d=[];if(o&&o.result&&(Array.isArray(o.result)?d=o.result:o.result.items&&Array.isArray(o.result.items)?d=o.result.items:o.result.data&&Array.isArray(o.result.data)&&(d=o.result.data)),d.length>0){s.push(...d),a+=d.length;const g=o?.result?.next??o?.next,p=g!=null&&g!==""&&String(g)!=="0";u=d.length===n&&p,T()&&f.debug(`[Pagination] Stage: ${t}, Batch: ${d.length}, Total: ${s.length}, Start: ${a}, NextValue: ${g}, HasNext: ${p}, HasMore: ${u}`,"TicketRepository");try{const m=E();m&&T()&&(f.debug(`[Pagination Debug] Stage: ${t}, Batch: ${d.length}, Total: ${s.length}`,"TicketRepository",{resultStructure:{hasResult:!!o?.result,resultIsArray:Array.isArray(o?.result),hasItems:!!o?.result?.items,hasData:!!o?.result?.data,hasNext:!!g,nextValue:g,nextType:typeof g,resultKeys:o?.result?Object.keys(o.result):[]}}),m.logTicketsLoading(t,d.length,s.length,g||null))}catch(m){f.warn("Diagnostics logging error","TicketRepository",m)}if(u?c=a+n:c=s.length,i){const m=c>0?Math.min(100,s.length/c*100):0;i(F({step:"loading_tickets",percent:m,count:s.length,total:c}))}l=null}else u=!1}catch(o){if(f.error(`Error loading tickets batch for stage ${t} (start: ${a})`,"TicketRepository",o),a===0)throw l=o,new Error(`Не удалось загрузить тикеты для стадии ${t}: ${o.message||o}`);u=!1,i&&s.length>0&&i(y("loading_tickets",100,{count:s.length,total:s.length,warning:`Загружено частично: ${s.length} тикетов. Ошибка при загрузке остальных.`}))}if(l&&s.length===0)throw l;if(e){const o=h.getTicketsCacheKey(t);h.set(o,s,h.TICKETS_TTL)}return s}static async getTicket(t){return(await I.call("crm.item.get",{entityTypeId:A,id:t})).result||null}static async updateTicket(t,e){const s=(await I.call("crm.item.update",{entityTypeId:A,id:t,fields:e})).result===!0;return s&&h.invalidateTicketsCache(),s}static async createTicket(t){const e=await I.call("crm.item.add",{entityTypeId:A,fields:t}),i=e.result?parseInt(e.result):0;return i>0&&h.invalidateTicketsCache(),i}static async assignTicket(t,e,i){return await this.updateTicket(t,{assignedById:e,stageId:i})}}class nt{static async getEmployeesByIds(t,e=!0){if(!Array.isArray(t)||t.length===0)return[];if(e){const i=h.getEmployeesCacheKey(t),s=h.get(i);if(s!==null)return f.debug(`Cache hit for employees: ${t.length} employees`,"EmployeeRepository"),s}try{const i=await I.call("user.get",{filter:{ID:t},select:["ID","NAME","LAST_NAME","EMAIL","WORK_POSITION","UF_DEPARTMENT"]});let s=[];if(i&&i.result&&(Array.isArray(i.result)?s=i.result:f.warn("Unexpected user.get result format","EmployeeRepository",i)),e){const a=h.getEmployeesCacheKey(t);h.set(a,s,h.EMPLOYEES_TTL)}return s}catch(i){return f.error("Error getting employees by IDs","EmployeeRepository",i),[]}}}const C=new Map;function at(){C.clear()}function ct(r){if(!r)return[];if(Array.isArray(r))return r.filter(e=>typeof e=="number"||!isNaN(parseInt(e))).map(e=>typeof e=="number"?e:parseInt(e));if(typeof r=="number")return[r];const t=parseInt(r);return isNaN(t)?[]:[t]}function ot(r,t=!0){const e=r.id||r.ID;if(!r||!e)return null;if(t&&C.has(e))return C.get(e);const i=r.UF_DEPARTMENT||r.departmentId,s=ct(i);for(const a of s)if(J(a)){const u=a;return t&&C.set(e,u),u}return t&&C.set(e,null),null}function lt(r){const t=ot(r);return{id:parseInt(r.ID||r.id||0),name:`${r.NAME||r.name||""} ${r.LAST_NAME||r.lastName||""}`.trim()||r.EMAIL||r.email||"Неизвестный",position:r.WORK_POSITION||r.workPosition||"Сотрудник",email:r.EMAIL||r.email||"",sectorId:t,departmentId:r.UF_DEPARTMENT||null,tickets:[]}}function ut(r){return Array.isArray(r)?r.map(t=>lt(t)):[]}const dt="1C",gt=["1С"],D=new Map,U=100;function W(r){return r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||r.ufCrm7TypeProduct||r.UF_CRM_7_TYPE_PRODUCT||r.uf_crm_7_type_product||null}function L(r){return r==null?null:String(r).trim().toUpperCase().replace(/С/g,"C")||null}function H(r){if(!r)return[];if(Array.isArray(r))return r.map(L).filter(Boolean);if(typeof r=="object"&&r.value!==void 0){const e=L(r.value);return e?[e]:[]}const t=L(r);return t?t.split(/[;,]/).map(e=>e.trim()).filter(Boolean):[]}function j(r){const t=W(r),e=H(t);return e.length===0?!1:e.some(i=>i===dt||gt.includes(i))}function ft(r){return`filter:${r.map(e=>e.id||e.ID||"").sort().join(",")}`}function ht(){D.size>U&&Array.from(D.keys()).slice(0,Math.floor(U*.2)).forEach(t=>D.delete(t))}function mt(r){if(!Array.isArray(r))return[];const t=ft(r),e=D.get(t);if(e!==void 0)return e;const i=r.filter(j);try{const s=E();if(s&&T()){const a=r.filter(c=>!j(c)),n=[],u=new Set;r.forEach(c=>{const l=W(c),o=H(l),d=l==null?"":String(l);l!=null&&!u.has(d)&&(u.add(d),n.push({value:l,normalized:o,type:typeof l,isArray:Array.isArray(l),ticketId:c.id||c.ID}))}),s.logFiltering(r.length,i.length,a,n)}}catch(s){console.warn("Diagnostics logging error in filterBySector:",s)}return D.set(t,i),ht(),i}const R=1051;function b(r){if(!r||typeof r!="object")return null;let t=r.assignedById||r.ASSIGNED_BY_ID||r.assignedByIdId||r.assignedById;return t&&typeof t=="object"&&(t=t.id||t.ID||t.value||null),t||null}function x(r){if(r==null)return null;typeof r=="object"&&(r=r.id||r.ID||r.value||null);const t=typeof r=="number"?r:parseInt(r);return isNaN(t)||t<=0?null:t}function yt(r,t=R){const e=b(r),i=x(e);return i===null||i===t}function pt(r,t){Array.isArray(r)||(f.warn("Tickets is not an array","TicketGrouper",r),r=[]),Array.isArray(t)||(f.warn("Employees is not an array","TicketGrouper",t),t=[]);const e=t.filter(c=>(c.id?parseInt(c.id):null)!==R),i=[{id:"formed",name:"Сформировано обращение",color:"#007bff",employees:e.map(c=>({...c,isFromSector1C:c.sectorId===B.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"review",name:"Рассмотрение ТЗ",color:"#ffc107",employees:e.map(c=>({...c,isFromSector1C:c.sectorId===B.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))},{id:"execution",name:"Исполнение",color:"#28a745",employees:e.map(c=>({...c,isFromSector1C:c.sectorId===B.SECTOR_1C,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]}))}],s=new Map(i.map(c=>[c.id,c])),a=new Map;i.forEach(c=>{const l=new Map(c.employees.map(o=>[o.id,o]));a.set(c.id,l)});const n=[],u=[];r.forEach(c=>{const l=P(c.stageId||c.STAGE_ID||""),o=s.get(l);if(!o){u.push({id:c.id||c.ID,title:c.title||c.TITLE||"Без названия",stageId:c.stageId||c.STAGE_ID,assignedById:b(c)});return}const d=b(c),g=x(d);if(g!==R)if(g){const p=a.get(l);let m=p.get(g);m||(m={id:g,name:`Сотрудник #${g}`,position:"Неизвестно",email:"",sectorId:null,departmentId:null,isFromSector1C:!1,tickets:[],ticketsInsideSector:[],ticketsOutsideSector:[]},o.employees.push(m),p.set(g,m));const S=v(c),O={...S,stageId:c.stageId||c.STAGE_ID||S.stageId,departmentHead:S.departmentHead||null,departmentHeadFull:S.departmentHeadFull||S.departmentHead||null};m.tickets.push(O),m.isFromSector1C?m.ticketsInsideSector.push(O):m.ticketsOutsideSector.push(O)}else n.push({id:c.id||c.ID,title:c.title||c.TITLE||"Без названия",stageId:l,assignedById:d})}),i.forEach(c=>{c.employees.sort((l,o)=>l.isFromSector1C&&!o.isFromSector1C?-1:!l.isFromSector1C&&o.isFromSector1C?1:(l.id||0)-(o.id||0))});try{const c=E();if(c&&T()){const l={};i.forEach(d=>{let g=0,p=0;d.employees.forEach(m=>{g+=(m.ticketsInsideSector||[]).length,p+=(m.ticketsOutsideSector||[]).length}),l[d.id]={insideSector:g,outsideSector:p,total:g+p}});const o=c.metrics.grouping;Object.keys(l).forEach(d=>{o.distributionByStages[d]||(o.distributionByStages[d]={employees:{},total:0}),o.distributionByStages[d].insideSector=l[d].insideSector,o.distributionByStages[d].outsideSector=l[d].outsideSector,o.distributionByStages[d].total=l[d].total}),c.logGrouping(i,n,u)}}catch(c){f.warn("Diagnostics logging error in groupTicketsByStages","TicketGrouper",c)}return i}function Tt(r){const t={formed:[],review:[],execution:[]};if(!Array.isArray(r))return f.warn("Tickets is not an array in getZeroPointTickets","TicketGrouper",r),t;r.filter(e=>yt(e)).forEach(e=>{const i=P(e.stageId||e.STAGE_ID||"");if(t[i]){const s=v(e),a={...s,stageId:e.stageId||e.STAGE_ID||s.stageId,departmentHead:s.departmentHead||null,departmentHeadFull:s.departmentHeadFull||s.departmentHead||null};t[i].push(a)}});try{const e=E();e&&T()&&e.logZeroPoint(t)}catch(e){f.warn("Diagnostics logging error in getZeroPointTickets","TicketGrouper",e)}return t}function St(r){if(!Array.isArray(r))return[];const t=new Set,e=[],i=[];r.forEach(a=>{const n=b(a),u=x(n);!n||n===null||n===void 0?e.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID}):u===R&&i.push({id:a.id||a.ID,title:a.title||a.TITLE||"Без названия",stageId:a.stageId||a.STAGE_ID}),u&&t.add(u)});const s=Array.from(t);try{const a=E();a&&T()&&a.logEmployees(s,e,i)}catch(a){f.warn("Diagnostics logging error in extractUniqueEmployeeIds","TicketGrouper",a)}return s}const N=new Map,Et=10*60*1e3;function It(r){if(!r||typeof r!="object")return{};const t={},e=Object.keys(r);for(const i of e)i.toUpperCase().startsWith("UF_")&&(t[i]=r[i]);return t}function kt(r,t=null,e=!0){if(e&&t&&N.has(t)){const a=N.get(t),n=Date.now();if(a.timestamp&&n-a.timestamp<Et)return a.data;N.delete(t)}const i=It(r),s={typeProduct:i.UF_CRM_7_TYPE_PRODUCT||i.uf_crm_7_type_product||i.ufCrm7TypeProduct||null,all:i};return e&&t&&N.set(t,{data:s,timestamp:Date.now()}),s}class _t{static async getTicketDetails(t,e={}){const{select:i=["*"],useOriginalUfNames:s=!0,useCache:a=!0}=e;try{const n=await w.getTicket(t);if(!n)throw new Error(`Тикет с ID ${t} не найден`);const u=kt(n,t,a),c=n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.ufCrm7UfPriority||n.UF_CRM_7_UF_PRIORITY||n.uf_crm_7_uf_priority||n.priority||n.PRIORITY||null,l=X(c),o=Q(l);return{id:n.id||n.ID,title:n.title||n.TITLE,stageId:n.stageId||n.STAGE_ID,assignedById:n.assignedById||n.ASSIGNED_BY_ID,createdAt:n.createdTime||n.CREATED_TIME||n.CREATED_DATE,updatedAt:n.updatedTime||n.UPDATED_TIME||n.MODIFY_DATE,priorityId:l.id,priorityLabel:l.label,priorityColors:o,priority:l.id,priorityBitrixValue:l.bitrixValue||null,opportunity:n.opportunity||n.OPPORTUNITY,currencyId:n.currencyId||n.CURRENCY_ID,comments:n.comments||n.COMMENTS,additionalFields:u,rawData:n}}catch(n){throw f.error("Error getting ticket details","TicketDetailsService",n),n}}}class Nt{static async getSectorData(t=!0,e=!1,i=null){let s=!1;try{if(T()){const a=E();a&&a.reset()}}catch(a){f.warn("Error resetting diagnostics","DashboardSector1CService",a)}if(i&&i(y("cache_check",0,{description:"Инициализация загрузки..."})),e)try{i&&i(y("backend_cache_check",5,{description:"Проверка backend кеша..."}));const a=await fetch("/api/services/dashboard-sector-1c.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getSectorDataCached",params:{forceRefresh:!1,ttl:600}})});if(a.ok){const n=await a.json();if(n.success&&n.data)return i&&i(y("backend_cache_hit",100,{description:"Данные загружены из backend кеша"})),n.cache_created===!0&&K.notifyCacheCreationSuccess("Дашборд сектора 1С (backend)"),n.data}f.warn("Backend cache miss or error, falling back to frontend logic","DashboardSector1CService")}catch(a){f.warn("Backend cache request failed, falling back to frontend logic","DashboardSector1CService",a)}if(t){const a=h.getSectorDataCacheKey(),n=h.get(a);if(n!==null)return i&&i(y("cache_hit",100,{description:"Данные загружены из in-memory кеша"})),n}try{i&&i(y("loading_tickets",10,{description:"Начало загрузки тикетов из Bitrix24..."}));const a=tt(),n=await w.getAllTickets(a,p=>{if(i){const m=F(p),S=Y(10,40,m.progress||0);i(y(m.step||"loading_tickets",S,{...m.details,warning:m.details.warning}))}},t);i&&i(y("filtering",50,{totalTickets:n.length,description:`Фильтрация ${n.length} тикетов по сектору 1С...`}));const u=mt(n);i&&i(y("filtering",50,{totalTickets:n.length,filteredTickets:u.length,description:`Отфильтровано ${u.length} тикетов из ${n.length}`})),i&&i(y("extracting_employees",60,{filteredTickets:u.length,description:`Анализ ${u.length} тикетов для определения сотрудников...`}));const c=St(u);i&&i(y("extracting_employees",60,{employeeCount:c.length,description:`Найдено ${c.length} уникальных сотрудников`})),i&&i(y("loading_employees",65,{employeeCount:c.length,description:`Загрузка данных ${c.length} сотрудников...`})),at();const l=await nt.getEmployeesByIds(c),o=ut(l);i&&i(y("loading_employees",90,{employeeCount:o.length,description:`Загружено данных ${o.length} сотрудников`})),i&&i(y("grouping",90,{filteredTickets:u.length,employeeCount:o.length,description:`Группировка ${u.length} тикетов по этапам и ${o.length} сотрудникам...`}));const g={stages:pt(u,o),employees:o,zeroPointTickets:Tt(u)};if(i&&i(y("caching",95,{description:"Сохранение результатов в кеш для ускорения следующих загрузок..."})),t){const p=h.getSectorDataCacheKey();h.set(p,g,h.TICKETS_TTL),s=!0}return i&&i(y("complete",100,{description:"Загрузка завершена"})),s&&!e&&K.notifyCacheCreationSuccess("Дашборд сектора 1С"),g}catch(a){throw f.error("Error getting sector data","DashboardSector1CService",a),i&&i({step:"error",progress:0,error:a.message}),a}}static async assignTicket(t,e,i){try{const s=G(i),a=await w.assignTicket(t,e,s);return a&&h.invalidateTicketsCache(),a}catch(s){throw f.error("Error assigning ticket","DashboardSector1CService",s),s}}static async createTicket(t){try{const e=G(t.stageId||"formed"),i={title:t.title,stageId:e};t.employeeId&&(i.assignedById=t.employeeId);const s=await w.createTicket(i);return s>0&&h.invalidateTicketsCache(),s}catch(e){throw f.error("Error creating ticket","DashboardSector1CService",e),e}}static async getTicket(t){try{const e=await w.getTicket(t);return v(e)}catch(e){throw f.error("Error getting ticket","DashboardSector1CService",e),e}}static async getTicketDetails(t,e={}){try{return await _t.getTicketDetails(t,e)}catch(i){throw f.error("Error getting ticket details","DashboardSector1CService",i),i}}static async addComment(t,e){try{return(await I.call("crm.timeline.comment.add",{fields:{entityId:t,entityType:"DYNAMIC_"+et,comment:e}})).result!==void 0}catch(i){throw f.error("Error adding comment","DashboardSector1CService",i),i}}}export{h as C,Nt as D,R as K,f as L,w as T,it as a,at as c,E as g,T as i,F as n};
