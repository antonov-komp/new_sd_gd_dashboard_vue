import{_ as Ie,r as A,c as j,m as ve,G as Te,a as E,o as k,b as d,d as P,g as we,F as re,f as oe,j as ye,t as W,p as U,H as Ee,v as he,n as Ce,x as Ye,I as Je,u as Se,L as Ke,C as qe,J as Ge,k as me,l as Xe,i as Ze,B as Qe,K as et,D as tt,M as x,q as Ve,N as Le,e as at,y as st}from"./main-BeNH-5j6.js";import{L as ze,D as nt,B as rt}from"./index-D43AEfmN.js";import{S as $e,d as Ae,K as ot,D as He}from"./index-C3lruD61.js";const K={apiBaseUrl:"",snapshotsEndpoint:"/api/snapshots.php",defaultSectorId:"1C",snapshotVersion:"1.0",timeout:3e4};class G{static getApiBaseUrl(){const e=window.location.pathname;return e.substring(0,e.lastIndexOf("/"))}static async createSnapshot(e,t,a={}){try{if(!e||typeof e!="object")throw new Y("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º","VALIDATION_ERROR");if(!t||!["week_start","week_end","manual","current"].includes(t))throw new Y("type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: week_start, week_end, manual, current","VALIDATION_ERROR");const r=this.validateSectorData(e);if(!r.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: ${r.errors.join(", ")}`,"VALIDATION_ERROR",{validation:r});const s=this.normalizeSectorData(e),u={metadata:this.generateSnapshotMetadata(t,a.createdBy,a.sectorId||K.defaultSectorId),statistics:s.statistics,ticketIds:s.ticketIds,tickets:s.tickets},o=this.validateSnapshot(u);if(!o.isValid)throw new Y(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞: ${o.errors.join(", ")}`,"VALIDATION_ERROR",{validation:o});o.warnings.length>0&&console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:",o.warnings);const l=this.getApiBaseUrl(),g=await fetch(`${l}${K.snapshotsEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"create",snapshot:u,type:t,date:this.formatDate(new Date)})});if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const v=await g.json();if(!v.success)throw new Error(v.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞");return v.data.snapshot}catch(r){throw console.error("SnapshotService.createSnapshot error:",r),r instanceof Y?r:new Y(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: ${r.message}`,"API_ERROR",{originalError:r})}}static async getSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?action=get&date=${a}&type=${t}`,n=await fetch(s,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(n.status===404)return null;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const u=await n.json();if(!u.success)throw new Error(u.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return u.data.snapshot}catch(a){throw console.error("SnapshotService.getSnapshot error:",a),a}}static async getAllSnapshots(e={}){try{const t=new URLSearchParams;t.append("action","list"),e.startDate&&t.append("startDate",this.formatDate(e.startDate)),e.endDate&&t.append("endDate",this.formatDate(e.endDate)),e.type&&t.append("type",e.type),e.sectorId?t.append("sectorId",e.sectorId):t.append("sectorId",K.defaultSectorId);const r=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}?${t.toString()}`,s=await fetch(r,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=await s.json();if(!n.success)throw new Error(n.message||"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–µ–ø–∫–æ–≤");return(await Promise.all(n.data.snapshots.map(async o=>{try{return await this.getSnapshot(o.date,o.type)}catch(l){return console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–ø–∫–∞ ${o.date}/${o.type}:`,l),null}}))).filter(o=>o!==null).sort((o,l)=>new Date(o.metadata.createdAt)-new Date(l.metadata.createdAt))}catch(t){throw console.error("SnapshotService.getAllSnapshots error:",t),t}}static normalizeSectorData(e){const{stages:t=[],employees:a=[],zeroPointTickets:r={}}=e,s={formed:{count:0,stageId:"DT140_12:UC_0VHWE2",stageName:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ"},review:{count:0,stageId:"DT140_12:PREPARATION",stageName:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó"},execution:{count:0,stageId:"DT140_12:CLIENT",stageName:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"}},n=[],u=[],o=[];t.forEach(v=>{const h=v.id;if(s[h]){let C=0;v.employees.forEach(T=>{const $=T.tickets||[];C+=$.length;let m=n.find(f=>f.id===T.id);m||(m={id:T.id,name:T.name,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0},n.push(m)),$.forEach(f=>{u.push(f.id),o.push({id:f.id,title:f.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:{id:T.id,name:T.name},createdAt:f.createdAt||"",updatedAt:f.modifiedAt||f.updatedAt||""}),m.ticketsByStage[h]=(m.ticketsByStage[h]||0)+1,m.totalTickets+=1})}),s[h].count=C}});const l={unassigned:0,keeper:0,total:0};Object.values(r).forEach(v=>{Array.isArray(v)&&v.forEach(h=>{l.total+=1,h.assigneeId===1051||h.assignedById===1051?l.keeper+=1:l.unassigned+=1,u.push(h.id),o.push({id:h.id,title:h.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:h.assignedTo||h.assignedById?{id:h.assignedById||h.assigneeId,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:null,createdAt:h.createdAt||"",updatedAt:h.modifiedAt||h.updatedAt||""})})});const g=Object.values(s).reduce((v,h)=>v+h.count,0)+l.total;return{statistics:{stages:{...s,total:g},employees:n,zeroPoint:l},ticketIds:[...new Set(u)],tickets:o}}static generateSnapshotMetadata(e,t,a){const r=new Date,s=-r.getTimezoneOffset(),n=Math.floor(s/60),u=s%60,o=`${n>=0?"+":""}${String(n).padStart(2,"0")}:${String(u).padStart(2,"0")}`,l=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}T${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}:${String(r.getSeconds()).padStart(2,"0")}${o}`;return{version:K.snapshotVersion,createdAt:l,createdBy:t||{id:0,name:"–°–∏—Å—Ç–µ–º–∞"},type:e,sectorId:a,sectorName:a==="1C"?"–°–µ–∫—Ç–æ—Ä 1–°":`–°–µ–∫—Ç–æ—Ä ${a}`}}static formatDate(e){if(e||(e=new Date),typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;e=new Date(e)}if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞");const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${r}`}static buildFilePath(e,t){const a=typeof e=="string"?new Date(e):e,r=a.getFullYear(),s=this.getWeekNumber(a),n=this.formatDate(e);let u;if(t==="current"){const o=new Date,l=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;u=`current-state-${n}-${l}.json`}else if(t==="manual"){const o=new Date,l=`${String(o.getHours()).padStart(2,"0")}-${String(o.getMinutes()).padStart(2,"0")}-${String(o.getSeconds()).padStart(2,"0")}`;u=`manual-${n}-${l}.json`}else u=`${t}-${n}.json`;return t==="current"?`current/${u}`:`${r}/week-${s}/${u}`}static getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);const r=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-r)/864e5+1)/7)}static validateSnapshot(e){var r,s,n;const t=[],a=[];if(e.metadata?((!e.metadata.version||typeof e.metadata.version!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"),(!e.metadata.createdAt||!this.isValidISODate(e.metadata.createdAt))&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),["week_start","week_end","manual","current"].includes(e.metadata.type)||t.push("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞"),(!e.metadata.sectorId||typeof e.metadata.sectorId!="string")&&t.push("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞"),(!e.metadata.createdBy||!e.metadata.createdBy.id||!e.metadata.createdBy.name)&&t.push("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ")):t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–µ–ø–∫–∞"),!e.statistics)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");else{if(!e.statistics.stages)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º");else{const u=e.statistics.stages,o=(((r=u.formed)==null?void 0:r.count)||0)+(((s=u.review)==null?void 0:s.count)||0)+(((n=u.execution)==null?void 0:n.count)||0);u.total!==o&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${o}, —É–∫–∞–∑–∞–Ω–æ ${u.total}`)}if(Array.isArray(e.statistics.employees)||t.push("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!e.statistics.zeroPoint)t.push("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏");else{const u=e.statistics.zeroPoint,o=(u.unassigned||0)+(u.keeper||0);u.total!==o&&a.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${o}, —É–∫–∞–∑–∞–Ω–æ ${u.total}`)}}if(Array.isArray(e.ticketIds)||t.push("ticketIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),!Array.isArray(e.tickets))t.push("tickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");else{const u=new Set(e.ticketIds),o=new Set(e.tickets.map(l=>l.id));u.size!==o.size&&a.push("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ID –≤ ticketIds –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–∏–∫–µ—Ç–æ–≤"),e.tickets.forEach((l,g)=>{l.id||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`),l.title||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫`),(!l.assignedTo||!l.assignedTo.id)&&a.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–µ)`),l.createdAt||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`),l.updatedAt||t.push(`–¢–∏–∫–µ—Ç #${g}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`)})}return{isValid:t.length===0,errors:t,warnings:a}}static validateSectorData(e){const t=[],a=[];return!e||typeof e!="object"?(t.push("sectorData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:!1,errors:t,warnings:a}):(Array.isArray(e.stages)||t.push("stages –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),Array.isArray(e.employees)||t.push("employees –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º"),(!e.zeroPointTickets||typeof e.zeroPointTickets!="object")&&t.push("zeroPointTickets –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º"),{isValid:t.length===0,errors:t,warnings:a})}static isValidISODate(e){if(typeof e!="string")return!1;const t=new Date(e);return!isNaN(t.getTime())&&e.includes("T")}static async deleteSnapshot(e,t){try{const a=this.formatDate(e),s=`${this.getApiBaseUrl()}${K.snapshotsEndpoint}`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"delete",date:a,type:t})});if(n.status===404)return!1;if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const u=await n.json();if(!u.success)throw new Error(u.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞");return!0}catch(a){throw console.error("SnapshotService.deleteSnapshot error:",a),a}}static async deleteSnapshotsByPeriod(e){try{const t=await this.getAllSnapshots(e);let a=0;for(const r of t)try{await this.deleteSnapshot(r.metadata.createdAt.split("T")[0],r.metadata.type)&&a++}catch(s){console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–µ–ø–∫–∞ ${r.metadata.createdAt}:`,s)}return a}catch(t){throw console.error("SnapshotService.deleteSnapshotsByPeriod error:",t),t}}static getSnapshotVersion(e){var t;return((t=e==null?void 0:e.metadata)==null?void 0:t.version)||"unknown"}static async migrateSnapshot(e,t=K.snapshotVersion){const a=this.getSnapshotVersion(e);return a===t||a==="1.0"&&t==="1.0"?e:(console.warn(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${a} –Ω–∞ ${t} –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`),{...e,metadata:{...e.metadata,version:t}})}static getWeekNumberInfo(e){const t=typeof e=="string"?new Date(e):e,a=this.getWeekNumber(t);return{year:t.getFullYear(),week:a}}static getWeekStartDate(e){const t=typeof e=="string"?new Date(e):e,r=(t.getDay()||7)-1,s=new Date(t);return s.setDate(t.getDate()-r),s.setHours(0,0,0,0),s}static getWeekEndDate(e){const t=typeof e=="string"?new Date(e):e,r=7-(t.getDay()||7),s=new Date(t);return s.setDate(t.getDate()+r),s.setHours(23,59,59,999),s}static async getSnapshotsForWeek(e){try{const t=this.getWeekStartDate(e),a=this.getWeekEndDate(e),r=this.getWeekNumberInfo(e),s=await this.getAllSnapshots({startDate:t,endDate:a}),n=s.find(l=>l.metadata.type==="week_start")||null,u=s.find(l=>l.metadata.type==="week_end")||null,o=s.filter(l=>l.metadata.type==="manual");return{weekStart:n,weekEnd:u,manual:o,weekInfo:r}}catch(t){throw console.error("SnapshotService.getSnapshotsForWeek error:",t),t}}static handleError(e){if(e instanceof Y)return{message:e.message,code:e.code,details:e.details};let t="UNKNOWN_ERROR";return e.message.includes("–≤–∞–ª–∏–¥–∞—Ü")?t="VALIDATION_ERROR":e.message.includes("404")||e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")?t="NOT_FOUND":e.message.includes("HTTP")||e.message.includes("API")?t="API_ERROR":e.message.includes("–≤–µ—Ä—Å–∏—è")||e.message.includes("version")?t="VERSION_MISMATCH":(e.message.includes("–¥–æ—Å—Ç—É–ø")||e.message.includes("permission"))&&(t="PERMISSION_DENIED"),{message:e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",code:t,details:{originalError:e}}}static async getSnapshotsStatistics(e={}){try{const t=await this.getAllSnapshots(e),a={week_start:0,week_end:0,manual:0,current:0},r=new Map;let s=null,n=null;t.forEach(o=>{const l=o.metadata.type;a.hasOwnProperty(l)&&a[l]++;const g=this.getWeekNumberInfo(o.metadata.createdAt),v=`${g.year}-W${g.week}`;r.set(v,(r.get(v)||0)+1);const h=new Date(o.metadata.createdAt);(!s||h<new Date(s.metadata.createdAt))&&(s=o),(!n||h>new Date(n.metadata.createdAt))&&(n=o)});const u=Array.from(r.entries()).map(([o,l])=>{const[g,v]=o.split("-W");return{year:parseInt(g),week:parseInt(v),count:l}}).sort((o,l)=>o.year!==l.year?o.year-l.year:o.week-l.week);return{total:t.length,byType:a,byWeek:u,oldest:s,newest:n}}catch(t){throw console.error("SnapshotService.getSnapshotsStatistics error:",t),t}}}class Y extends Error{constructor(e,t,a={}){super(e),this.name="SnapshotError",this.code=t,this.details=a}}const q={formed:{bitrixId:Ae.formed,name:$e.FORMED.name},review:{bitrixId:Ae.review,name:$e.REVIEW.name},execution:{bitrixId:Ae.execution,name:$e.EXECUTION.name}},ie=ot;function it(y){if(!y||typeof y!="object")throw new Error("Invalid sector data: sectorData must be an object");if(!y.stages||!Array.isArray(y.stages))throw new Error("Invalid sector data: stages are required and must be an array");const e=lt(y.stages),t=ct(y.stages),a=dt(y.zeroPointTickets||{}),r=ut(y.zeroPointTickets||{}),s=pt(y.stages,y.zeroPointTickets||{});return{statistics:{stages:e,employees:t,zeroPoint:a,zeroPointByStage:r},ticketIds:s.ticketIds,tickets:s.tickets}}function lt(y){const e={formed:{count:0,stageId:q.formed.bitrixId,stageName:q.formed.name},review:{count:0,stageId:q.review.bitrixId,stageName:q.review.name},execution:{count:0,stageId:q.execution.bitrixId,stageName:q.execution.name},total:0};return y.forEach(t=>{if(!q[t.id]){console.warn(`Unknown stage ID: ${t.id}`);return}let a=0;t.employees&&Array.isArray(t.employees)&&t.employees.forEach(r=>{r.tickets&&Array.isArray(r.tickets)&&(a+=r.tickets.length)}),e[t.id].count=a,e.total+=a}),e}function ct(y){const e=new Map;return y.forEach(t=>{!t.employees||!Array.isArray(t.employees)||t.employees.forEach(a=>{if(!a||!a.id)return;e.has(a.id)||e.set(a.id,{id:a.id,name:a.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${a.id}`,ticketsByStage:{formed:0,review:0,execution:0},totalTickets:0});const r=e.get(a.id),s=a.tickets&&Array.isArray(a.tickets)?a.tickets.length:0;q[t.id]&&(r.ticketsByStage[t.id]=(r.ticketsByStage[t.id]||0)+s),r.totalTickets+=s})}),Array.from(e.values())}function dt(y){let e=0,t=0;return!y||typeof y!="object"?{unassigned:0,keeper:0,total:0}:(Object.values(y).forEach(a=>{Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?e++:(typeof s=="object"?s.id:s)===ie?t++:e++})}),{unassigned:e,keeper:t,total:e+t})}function ut(y){const e={formed:{keeper:0,unassigned:0,total:0},review:{keeper:0,unassigned:0,total:0},execution:{keeper:0,unassigned:0,total:0}};return!y||typeof y!="object"||Object.keys(e).forEach(t=>{const a=y[t];Array.isArray(a)&&a.forEach(r=>{if(!r)return;const s=r.assignedTo||r.assignedById;!s||s===null?e[t].unassigned++:(typeof s=="object"?s.id:s)===ie?e[t].keeper++:e[t].unassigned++,e[t].total++})}),e}function pt(y,e){const t=new Set,a=new Map;return Array.isArray(y)&&y.forEach(r=>{!r.employees||!Array.isArray(r.employees)||r.employees.forEach(s=>{!s.tickets||!Array.isArray(s.tickets)||s.tickets.forEach(n=>{if(!n||!n.id){console.warn("Ticket without ID found:",n);return}const u=parseInt(n.id);if(isNaN(u)){console.warn("Invalid ticket ID:",n.id);return}t.add(u);let o=n.assignedTo;!o&&s.id&&(o={id:s.id,name:s.name||`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${s.id}`}),a.set(u,{id:u,title:n.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:o||null,createdAt:ge(n.createdAt||n.createdTime),updatedAt:ge(n.updatedAt||n.modifiedAt||n.updatedTime)})})})}),e&&typeof e=="object"&&Object.values(e).forEach(r=>{Array.isArray(r)&&r.forEach(s=>{if(!s||!s.id){console.warn("Ticket without ID found in zero point:",s);return}const n=parseInt(s.id);if(isNaN(n)){console.warn("Invalid ticket ID in zero point:",s.id);return}t.add(n);let u=s.assignedTo;if(!u&&s.assignedById){const o=typeof s.assignedById=="object"?s.assignedById.id||s.assignedById.value:s.assignedById;o&&o!==ie?u={id:o,name:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"}:o===ie&&(u={id:ie,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤"})}a.set(n,{id:n,title:s.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",assignedTo:u||null,createdAt:ge(s.createdAt||s.createdTime),updatedAt:ge(s.updatedAt||s.modifiedAt||s.updatedTime)})})}),{ticketIds:Array.from(t).sort((r,s)=>r-s),tickets:Array.from(a.values())}}function ge(y){if(!y)return null;if(y instanceof Date)return y.toISOString();if(typeof y=="string"){if(y.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/))return y;const e=new Date(y);if(!isNaN(e.getTime()))return e.toISOString()}return console.warn("Invalid date format:",y),null}class Be{static async getSectorDataForSnapshot(e={}){const{useCache:t=!0,onProgress:a=null,normalize:r=!0,includeTicketDetails:s=!1}=e;try{const n=await He.getSectorData(t,a);return r?it(n):(s&&console.warn("includeTicketDetails –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"),n)}catch(n){throw console.error("SectorDataAdapter.getSectorDataForSnapshot error:",n),n}}static async isDataAvailable(){try{const e=await He.getSectorData(!0);return e!=null}catch{return!1}}}class _e{static compareTwoSnapshots(e,t,a={}){const{includeTickets:r=!1,includeEmployees:s=!0}=a,n=this.validateSnapshot(e),u=this.validateSnapshot(t);if(!n.valid||!u.valid)throw new Error("Invalid snapshot structure: "+[...n.errors,...u.errors].join(", "));const o=this.buildComparisonMetadata(e,t),l=this.compareStages(e.statistics.stages,t.statistics.stages),g=s?this.compareEmployees(e.statistics.employees||[],t.statistics.employees||[]):[],v=this.compareZeroPoint(e.statistics.zeroPoint||{},t.statistics.zeroPoint||{}),h=r?this.compareTickets(e.ticketIds||[],t.ticketIds||[],e.tickets||[],t.tickets||[]):null,C=this.buildSummary(l,g,v,h);return{metadata:o,stages:l,employees:g,zeroPoint:v,tickets:h,summary:C}}static calculateDelta(e,t){const a=this.normalizeValue(e),r=this.normalizeValue(t),s=r-a;let n=0;a!==0?n=s/a*100:r!==0&&(n=r>0?1/0:-1/0);const u=this.getTrend(s);return{value1:a,value2:r,delta:s,deltaPercent:Math.round(n*100)/100,trend:u}}static normalizeValue(e){return e==null||isNaN(e)?0:Number(e)}static getTrend(e){return e>0?"increase":e<0?"decrease":"stable"}static compareStages(e,t){var u,o;const a=["formed","review","execution"],r={};for(const l of a){const g=((u=e[l])==null?void 0:u.count)||0,v=((o=t[l])==null?void 0:o.count)||0;r[l]=this.calculateDelta(g,v)}const s=e.total||0,n=t.total||0;return r.total=this.calculateDelta(s,n),r}static compareEmployees(e,t){var u,o;const a=new Map(e.map(l=>[l.id,l])),r=new Map(t.map(l=>[l.id,l])),s=new Set([...a.keys(),...r.keys()]),n=[];for(const l of s){const g=a.get(l)||null,v=r.get(l)||null;if(!g||!v){n.push({id:l,name:(g==null?void 0:g.name)||(v==null?void 0:v.name)||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",snapshot1:g?{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0}:null,snapshot2:v?{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0}:null,delta:this.calculateEmployeeDelta(g,v),trend:g?"removed":"new"});continue}const h={},C=["formed","review","execution"];for(const $ of C){const m=((u=g.ticketsByStage)==null?void 0:u[$])||0,f=((o=v.ticketsByStage)==null?void 0:o[$])||0;h[$]=this.calculateDelta(m,f)}const T=this.calculateDelta(g.totalTickets||0,v.totalTickets||0);n.push({id:l,name:g.name,snapshot1:{ticketsByStage:g.ticketsByStage||{},totalTickets:g.totalTickets||0},snapshot2:{ticketsByStage:v.ticketsByStage||{},totalTickets:v.totalTickets||0},delta:{ticketsByStage:h,totalTickets:T},trend:T.trend})}return n}static calculateEmployeeDelta(e,t){var n,u;if(!e&&!t)return{ticketsByStage:{},totalTickets:{delta:0,trend:"stable"}};const a={},r=["formed","review","execution"];for(const o of r){const l=((n=e==null?void 0:e.ticketsByStage)==null?void 0:n[o])||0,g=((u=t==null?void 0:t.ticketsByStage)==null?void 0:u[o])||0;a[o]=this.calculateDelta(l,g)}const s=this.calculateDelta((e==null?void 0:e.totalTickets)||0,(t==null?void 0:t.totalTickets)||0);return{ticketsByStage:a,totalTickets:s}}static compareZeroPoint(e,t){return{unassigned:this.calculateDelta((e==null?void 0:e.unassigned)||0,(t==null?void 0:t.unassigned)||0),keeper:this.calculateDelta((e==null?void 0:e.keeper)||0,(t==null?void 0:t.keeper)||0),total:this.calculateDelta((e==null?void 0:e.total)||0,(t==null?void 0:t.total)||0)}}static compareTickets(e,t,a,r){var C,T;const s=new Set(e),n=new Set(t),u=t.filter($=>!s.has($)),o=e.filter($=>!n.has($)),l=[],g=[],v=new Map(a.map($=>[$.id,$])),h=new Map(r.map($=>[$.id,$]));for(const $ of e){if(!n.has($))continue;const m=v.get($),f=h.get($);if(!m||!f)continue;const b=(((C=m.assignedTo)==null?void 0:C.id)||null)!==(((T=f.assignedTo)==null?void 0:T.id)||null),R=(m.stageId||null)!==(f.stageId||null);b||R?l.push($):g.push($)}return{new:u,removed:o,changed:l,unchanged:g}}static buildComparisonMetadata(e,t){const a=new Date(e.metadata.createdAt),r=new Date(t.metadata.createdAt),s=new Date,n=r.getTime()-a.getTime(),u=Math.floor(n/(1e3*60*60*24)),o=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),l=Math.floor(n%(1e3*60*60)/(1e3*60));return{snapshot1Date:e.metadata.createdAt,snapshot2Date:t.metadata.createdAt,comparisonDate:s.toISOString(),timeDiff:{days:u,hours:o,minutes:l,totalMinutes:Math.floor(n/(1e3*60))}}}static buildSummary(e,t,a,r){var l,g,v;const s=e.total.delta,n=Object.keys(e).filter(h=>h==="total"?!1:e[h].delta!==0).length,u=t.filter(h=>h.trend==="new"||h.trend==="removed"?!0:h.delta.totalTickets.delta!==0).length,o=s!==0||n>0||u>0;return{totalDelta:s,stagesChanged:n,employeesChanged:u,hasChanges:o,newTicketsCount:((l=r==null?void 0:r.new)==null?void 0:l.length)||0,removedTicketsCount:((g=r==null?void 0:r.removed)==null?void 0:g.length)||0,changedTicketsCount:((v=r==null?void 0:r.changed)==null?void 0:v.length)||0}}static validateSnapshot(e){const t=[],a=[];if(!e)return t.push("Snapshot is null or undefined"),{valid:!1,errors:t,warnings:a};if(e.metadata?(e.metadata.createdAt||t.push("Missing metadata.createdAt"),e.metadata.type||t.push("Missing metadata.type")):t.push("Missing metadata field"),!e.statistics)t.push("Missing statistics field");else{if(!e.statistics.stages)t.push("Missing statistics.stages");else{const r=["formed","review","execution"];for(const s of r)e.statistics.stages[s]||a.push(`Missing stage: ${s}`)}e.statistics.employees||a.push("Missing statistics.employees (may be empty array)"),e.statistics.zeroPoint||a.push("Missing statistics.zeroPoint")}return{valid:t.length===0,errors:t,warnings:a}}static compareMultipleSnapshots(e,t={}){if(!Array.isArray(e)||e.length<2)throw new Error("At least 2 snapshots required for comparison");for(const n of e){const u=this.validateSnapshot(n);if(!u.valid)throw new Error("Invalid snapshot: "+u.errors.join(", "))}const a=[...e].sort((n,u)=>{const o=new Date(n.metadata.createdAt),l=new Date(u.metadata.createdAt);return o-l}),r=[];for(let n=0;n<a.length-1;n++)r.push({from:n,to:n+1,result:this.compareTwoSnapshots(a[n],a[n+1],t)});const s=this.buildTrends(a);return{snapshots:a.map((n,u)=>({index:u,date:n.metadata.createdAt,type:n.metadata.type,data:n})),comparisons:r,trends:s}}static buildTrends(e){var a,r,s,n,u,o,l,g,v,h;const t={stages:{formed:[],review:[],execution:[],total:[]},zeroPoint:{unassigned:[],keeper:[],total:[]}};for(const C of e){const T=C.statistics;t.stages.formed.push(((r=(a=T.stages)==null?void 0:a.formed)==null?void 0:r.count)||0),t.stages.review.push(((n=(s=T.stages)==null?void 0:s.review)==null?void 0:n.count)||0),t.stages.execution.push(((o=(u=T.stages)==null?void 0:u.execution)==null?void 0:o.count)||0),t.stages.total.push(((l=T.stages)==null?void 0:l.total)||0),t.zeroPoint.unassigned.push(((g=T.zeroPoint)==null?void 0:g.unassigned)||0),t.zeroPoint.keeper.push(((v=T.zeroPoint)==null?void 0:v.keeper)||0),t.zeroPoint.total.push(((h=T.zeroPoint)==null?void 0:h.total)||0)}return t}}const ft={class:"graph-state-chart"},gt={class:"chart-header"},ht={class:"chart-type-selector"},mt=["onClick","title"],vt={class:"chart-type-icon"},wt={class:"chart-type-label"},yt={key:0,class:"comparison-type-selector"},St={class:"radio-group"},kt={key:0},bt={key:1},Dt={key:1,class:"chart-filters"},Tt=["onUpdate:modelValue"],Et={class:"filter-label"},$t={key:2,class:"graph-legend"},At={key:4,class:"error-container"},_t={class:"error-message"},Ct={key:5,class:"chart-container"},It={key:6,class:"no-data"},Bt={key:7,class:"employees-details"},xt={class:"employees-details-content"},Rt={class:"stage-details-header"},Mt={class:"stage-details-name"},Ot={class:"stage-details-count"},Ft={class:"stage-details-employees"},Nt={class:"employee-detail-name"},Pt={class:"employee-detail-count"},Wt={key:0,class:"no-employees-in-stage"},jt={__name:"GraphStateChart",props:{period:{type:Object,default:null},showCurrentState:{type:Boolean,default:!0}},emits:["data-loaded","error"],setup(y,{emit:e}){const t=(S,p)=>typeof window>"u"?p:getComputedStyle(document.documentElement).getPropertyValue(S).trim()||p,a=y,r=e,s=A(!1),n=A(null),u=A(null),o=A({weekStart:null,weekEnd:null,current:null}),l=A(null),g=A("weekStartToWeekEnd"),v=[{value:"line",label:"–õ–∏–Ω–µ–π–Ω—ã–π",icon:"üìà"},{value:"bar",label:"–°—Ç–æ–ª–±—á–∞—Ç—ã–π",icon:"üìä"},{value:"doughnut",label:"–ö—Ä—É–≥–æ–≤–∞—è",icon:"üç©"}],h=A("line"),C=A(!0),T=A([]),$=j(()=>{switch(h.value){case"line":return ze;case"bar":return rt;case"doughnut":return nt;default:return ze}}),m={formed:t("--b24-primary","#007bff"),review:t("--b24-warning","#ffc107"),execution:t("--b24-success","#28a745")},f=[{id:"formed",name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",color:m.formed},{id:"review",name:"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",color:m.review},{id:"execution",name:"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",color:m.execution}],b=A({formed:!0,review:!0,execution:!0});function R(S){var c;const p=o.value.current||o.value.weekEnd||o.value.weekStart;return!p||!p.statistics||!p.statistics.stages?0:((c=p.statistics.stages[S])==null?void 0:c.count)||0}function J(S){const p=o.value.current||o.value.weekEnd||o.value.weekStart;if(!p||!p.statistics)return[];const c=[];p.statistics.employees&&Array.isArray(p.statistics.employees)&&p.statistics.employees.filter(w=>w.ticketsByStage&&w.ticketsByStage[S]>0).forEach(w=>{c.push({id:w.id,name:w.name,count:w.ticketsByStage[S]||0})});const i=X(S);return i>0&&c.push({id:1051,name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—ä–µ–∫—Ç–æ–≤ (–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ)",count:i,isKeeper:!0}),c.sort((w,D)=>D.count-w.count)}function X(S){const p=o.value.current||o.value.weekEnd||o.value.weekStart;if(!p||!p.statistics)return 0;if(p.statistics.zeroPointByStage&&p.statistics.zeroPointByStage[S])return p.statistics.zeroPointByStage[S].keeper||0;if(p.statistics.zeroPoint){const c=p.statistics.zeroPoint.keeper||0;return Math.floor(c/3)}return 0}const V=Se();function ke(){const S=new Map;[o.value.weekStart,o.value.weekEnd,o.value.current].forEach(p=>{!p||!p.statistics||!p.statistics.employees||p.statistics.employees.forEach(c=>{S.has(c.id)||S.set(c.id,{id:c.id,name:c.name})})}),T.value=Array.from(S.values()).sort((p,c)=>p.name.localeCompare(c.name))}function ee(S,p="background"){var i;return((i={increase:{background:t("--b24-success","#28a745"),border:t("--b24-success-hover","#218838"),point:t("--b24-success","#28a745")},decrease:{background:t("--b24-danger","#dc3545"),border:t("--b24-danger-hover","#c82333"),point:t("--b24-danger","#dc3545")},stable:{background:t("--b24-text-muted","#9ca3af"),border:t("--b24-text-secondary","#6b7280"),point:t("--b24-text-muted","#9ca3af")}}[S])==null?void 0:i[p])||t("--b24-text-secondary","#6c757d")}function le(){if(!(!o.value.weekStart||!o.value.weekEnd))try{const S=_e.compareTwoSnapshots(o.value.weekStart,o.value.weekEnd,{includeTickets:!1,includeEmployees:!0});let p=null,c=null;o.value.current&&(p=_e.compareTwoSnapshots(o.value.weekEnd,o.value.current,{includeTickets:!1,includeEmployees:!0}),c=_e.compareTwoSnapshots(o.value.weekStart,o.value.current,{includeTickets:!1,includeEmployees:!0})),l.value={weekStartToWeekEnd:S,weekEndToCurrent:p,weekStartToCurrent:c}}catch(S){console.error("–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–ª–µ–ø–∫–æ–≤:",S),V.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–µ–ø–∫–æ–≤: "+S.message)}}function ce(S){return{"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ":"formed","–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó":"review",–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:"execution"}[S]||"formed"}const de=j(()=>{if(!u.value)return null;if(h.value==="doughnut")return u.value;const S=u.value.datasets.filter(p=>{const c=f.find(i=>i.name===p.label);return c?b.value[c.id]:!0});return{...u.value,datasets:S}}),be=j(()=>{const S={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:h.value==="doughnut"?"right":"top",onClick:(p,c,i)=>{const w=c.datasetIndex;if(w!==void 0){const D=i.chart.getDatasetMeta(w);D.hidden=!D.hidden,i.chart.update()}}},tooltip:{enabled:!0,mode:"index",intersect:!1,callbacks:{title:p=>p[0].label||"",label:p=>{var D,_,F,I,M,B;const c=p.dataset.label||"",i=p.parsed.y||p.parsed||0,w=p.dataIndex;if(h.value==="doughnut"){const O=p.dataset.data.reduce((H,Z)=>H+Z,0),z=O>0?(i/O*100).toFixed(1):0;return`${c}: ${i} (${z}%)`}else{if(!l.value||w===0||h.value==="doughnut")return`${c}: ${i}`;let O=null;const z=ce(c);if(g.value==="weekStartToWeekEnd"&&w===1?O=(_=(D=l.value.weekStartToWeekEnd)==null?void 0:D.stages)==null?void 0:_[z]:g.value==="weekEndToCurrent"&&w===2&&o.current?O=(I=(F=l.value.weekEndToCurrent)==null?void 0:F.stages)==null?void 0:I[z]:g.value==="weekStartToCurrent"&&w===2&&o.current&&(O=(B=(M=l.value.weekStartToCurrent)==null?void 0:M.stages)==null?void 0:B[z]),!O)return`${c}: ${i}`;const H=O.delta,Z=O.deltaPercent,ae=O.trend;let Q=`${c}: ${i}`;if(H!==0){const se=H>0?"+":"",fe=ae==="increase"?"‚Üë":ae==="decrease"?"‚Üì":"‚Üí";Q+=` (${se}${H}, ${se}${Z.toFixed(1)}%) ${fe}`}else Q+=" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)";return Q}},afterBody:p=>{if(h.value==="doughnut"||!l.value)return[];const c=p[0].dataIndex;if(c===0)return[];let i=null;if(ce(p[0].dataset.label||""),g.value==="weekStartToWeekEnd"&&c===1?i=l.value.weekStartToWeekEnd:g.value==="weekEndToCurrent"&&c===2?i=l.value.weekEndToCurrent:g.value==="weekStartToCurrent"&&c===2&&(i=l.value.weekStartToCurrent),!i||!i.metadata)return[];const w=i.metadata.timeDiff;return[`–ü–µ—Ä–∏–æ–¥: ${w.days} –¥–Ω. ${w.hours} —á. ${w.minutes} –º–∏–Ω.`]}}},title:{display:!1}}};return h.value==="line"||h.value==="bar"?{...S,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}:h.value==="doughnut"?{...S,cutout:"60%"}:S});function ue(S){const p=new Date(S),c=p.getFullYear(),i=String(p.getMonth()+1).padStart(2,"0"),w=String(p.getDate()).padStart(2,"0");return`${c}-${i}-${w}`}function pe(S){const{current:p,weekEnd:c}=S,i=p||c;if(!i||!i.statistics||!i.statistics.stages)return null;const w=[],D=[],_=[],F=[];return f.forEach(I=>{var B;const M=((B=i.statistics.stages[I.id])==null?void 0:B.count)||0;M>0&&(w.push(I.name),D.push(M),_.push(I.color+"80"),F.push(I.color))}),D.length===0?null:{labels:w,datasets:[{label:"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º",data:D,backgroundColor:_,borderColor:F,borderWidth:2}]}}function De(S){if(h.value==="doughnut")return pe(S);const{weekStart:p,weekEnd:c,current:i}=S,w=[],D=[];return f.forEach(_=>{var z,H,Z,ae,Q,se,fe,xe,Re,Me,Oe,Fe,Ne,Pe,We,je,Ue;const F=[];if(p&&p.statistics&&p.statistics.stages){const N=p.statistics.stages[_.id];if(w.length===0){const ne=(z=p.metadata)!=null&&z.createdAt?new Date(p.metadata.createdAt):null;w.push(ne?ue(ne):"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏")}F.push((N==null?void 0:N.count)||0)}else w.length===0&&w.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏"),F.push(0);if(c&&c.statistics&&c.statistics.stages){const N=c.statistics.stages[_.id];if(w.length===1){const ne=(H=c.metadata)!=null&&H.createdAt?new Date(c.metadata.createdAt):null;w.push(ne?ue(ne):"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏")}F.push((N==null?void 0:N.count)||0)}else w.length===1&&w.push("–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),F.push(0);if(i&&a.showCurrentState&&i.statistics&&i.statistics.stages){const N=i.statistics.stages[_.id];w.length===2&&w.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"),F.push((N==null?void 0:N.count)||0)}const I=["stable"];l.value?g.value==="weekStartToWeekEnd"?(I.push(((Q=(ae=(Z=l.value.weekStartToWeekEnd)==null?void 0:Z.stages)==null?void 0:ae[_.id])==null?void 0:Q.trend)||"stable"),i&&I.push(((xe=(fe=(se=l.value.weekStartToCurrent)==null?void 0:se.stages)==null?void 0:fe[_.id])==null?void 0:xe.trend)||"stable")):g.value==="weekEndToCurrent"&&i?(I.push("stable"),I.push(((Oe=(Me=(Re=l.value.weekEndToCurrent)==null?void 0:Re.stages)==null?void 0:Me[_.id])==null?void 0:Oe.trend)||"stable")):g.value==="weekStartToCurrent"&&i?(I.push(((Pe=(Ne=(Fe=l.value.weekStartToWeekEnd)==null?void 0:Fe.stages)==null?void 0:Ne[_.id])==null?void 0:Pe.trend)||"stable"),I.push(((Ue=(je=(We=l.value.weekStartToCurrent)==null?void 0:We.stages)==null?void 0:je[_.id])==null?void 0:Ue.trend)||"stable")):(I.push("stable"),i&&I.push("stable")):(I.push("stable"),i&&I.push("stable"));let M,B,O;l.value&&h.value!=="doughnut"?(M=I.map(N=>ee(N,"background")+"40"),B=I.map(N=>ee(N,"border")),O=I.map(N=>ee(N,"point"))):(M=_.color+"40",B=_.color,O=_.color),D.push({label:_.name,data:F,backgroundColor:(Array.isArray(M),M),borderColor:(Array.isArray(B),B),borderWidth:2,pointBackgroundColor:(Array.isArray(O),O),pointBorderColor:(Array.isArray(B),B),pointRadius:6,pointHoverRadius:8,fill:h.value!=="line",tension:h.value==="line"?.4:0})}),w.length===0&&(w.push("–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏","–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏"),a.showCurrentState&&w.push("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")),{labels:w,datasets:D}}const te=async()=>{var S,p,c;s.value=!0,n.value=null;try{const i=(S=a.period)!=null&&S.endDate?new Date(a.period.endDate):new Date,w=(p=a.period)!=null&&p.startDate?new Date(a.period.startDate):G.getWeekStartDate(i),D=(c=a.period)!=null&&c.endDate?new Date(a.period.endDate):G.getWeekEndDate(i),_=G.formatDate(w),F=G.formatDate(D),[I,M]=await Promise.all([G.getSnapshot(_,"week_start"),G.getSnapshot(F,"week_end")]);let B=null;a.showCurrentState&&(B=await Be.getSectorDataForSnapshot({useCache:!1,normalize:!0})),o.value={weekStart:I,weekEnd:M,current:B},ke(),le(),L(),r("data-loaded",{weekStart:I,weekEnd:M,current:B})}catch(i){console.error("Error loading chart data:",i),n.value=i.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞",V.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: "+n.value),r("error",n.value)}finally{s.value=!1}};ve(()=>{te()});const L=()=>{u.value=De({weekStart:o.value.weekStart,weekEnd:o.value.weekEnd,current:o.value.current})};return Te(()=>[a.period,a.showCurrentState],()=>{te()},{deep:!0}),Te(h,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&L()}),Te(g,()=>{(o.value.weekStart||o.value.weekEnd||o.value.current)&&L()}),(S,p)=>(k(),E("div",ft,[d("div",gt,[p[3]||(p[3]=d("h3",{class:"chart-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),d("div",ht,[(k(),E(re,null,oe(v,c=>d("button",{key:c.value,onClick:i=>h.value=c.value,class:ye(["chart-type-btn",{active:h.value===c.value}]),title:c.label},[d("span",vt,W(c.icon),1),d("span",wt,W(c.label),1)],10,mt)),64))])]),!s.value&&!n.value&&l.value&&h.value!=="doughnut"?(k(),E("div",yt,[p[7]||(p[7]=d("h4",{class:"comparison-title"},"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:",-1)),d("div",St,[d("label",null,[U(d("input",{type:"radio","onUpdate:modelValue":p[0]||(p[0]=c=>g.value=c),value:"weekStartToWeekEnd",onChange:L},null,544),[[Ee,g.value]]),p[4]||(p[4]=d("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",-1))]),o.value.current?(k(),E("label",kt,[U(d("input",{type:"radio","onUpdate:modelValue":p[1]||(p[1]=c=>g.value=c),value:"weekEndToCurrent",onChange:L},null,544),[[Ee,g.value]]),p[5]||(p[5]=d("span",null,"–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0),o.value.current?(k(),E("label",bt,[U(d("input",{type:"radio","onUpdate:modelValue":p[2]||(p[2]=c=>g.value=c),value:"weekStartToCurrent",onChange:L},null,544),[[Ee,g.value]]),p[6]||(p[6]=d("span",null,"–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Üí –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",-1))])):P("",!0)])])):P("",!0),!s.value&&!n.value&&u.value?(k(),E("div",Dt,[(k(),E(re,null,oe(f,c=>d("label",{key:c.id,class:"filter-checkbox"},[U(d("input",{type:"checkbox","onUpdate:modelValue":i=>b.value[c.id]=i,onChange:L},null,40,Tt),[[he,b.value[c.id]]]),d("span",{class:"filter-color",style:Ce({backgroundColor:c.color})},null,4),d("span",Et,W(c.name),1)])),64))])):P("",!0),!s.value&&!n.value&&l.value&&h.value!=="doughnut"?(k(),E("div",$t,[...p[8]||(p[8]=[Ye('<h4 class="legend-title" data-v-b4f51d6b>–õ–µ–≥–µ–Ω–¥–∞:</h4><div class="legend-items" data-v-b4f51d6b><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-increase" data-v-b4f51d6b></span><span data-v-b4f51d6b>–ó–µ–ª—ë–Ω—ã–π ‚Äî —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-decrease" data-v-b4f51d6b></span><span data-v-b4f51d6b>–ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤</span></div><div class="legend-item" data-v-b4f51d6b><span class="legend-color legend-stable" data-v-b4f51d6b></span><span data-v-b4f51d6b>–°–µ—Ä—ã–π ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span></div></div>',2)])])):P("",!0),s.value?(k(),we(Ke,{key:3,message:"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞..."})):n.value?(k(),E("div",At,[d("p",_t,"‚ùå "+W(n.value),1),d("button",{onClick:te,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É")])):de.value?(k(),E("div",Ct,[(k(),we(Je($.value),{data:de.value,options:be.value,height:300},null,8,["data","options"]))])):(k(),E("div",It,[...p[9]||(p[9]=[d("p",null,"üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",-1),d("p",{class:"no-data-hint"},"–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",-1)])])),!s.value&&!n.value&&u.value&&C.value?(k(),E("div",Bt,[p[10]||(p[10]=d("h4",{class:"employees-details-title"},"–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º",-1)),d("div",xt,[(k(),E(re,null,oe(f,c=>d("div",{key:c.id,class:"stage-details"},[d("div",Rt,[d("span",{class:"stage-details-color",style:Ce({backgroundColor:c.color})},null,4),d("h5",Mt,W(c.name),1),d("span",Ot," –í—Å–µ–≥–æ: "+W(R(c.id))+" —Ç–∏–∫–µ—Ç–æ–≤ ",1)]),d("div",Ft,[(k(!0),E(re,null,oe(J(c.id),i=>(k(),E("div",{key:`${c.id}-${i.id}`,class:ye(["employee-detail-item",{"employee-detail-keeper":i.isKeeper}])},[d("span",Nt,W(i.name),1),d("span",Pt,W(i.count)+" —Ç–∏–∫–µ—Ç–æ–≤",1)],2))),128)),J(c.id).length===0?(k(),E("div",Wt," –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ ")):P("",!0)])])),64))])])):P("",!0)]))}},Ut=Ie(jt,[["__scopeId","data-v-b4f51d6b"]]),Vt={key:0,class:"create-snapshot-button-container"},Lt=["disabled"],zt={class:"modal-content"},Ht={class:"modal-header"},Kt=["disabled"],qt={class:"modal-body"},Gt={key:0,class:"progress-container"},Xt={class:"progress-bar-wrapper"},Yt={class:"progress-text"},Jt={class:"progress-percent"},Zt={class:"progress-description"},Qt={key:1},ea={class:"modal-footer"},ta=["disabled"],aa=["disabled"],sa={key:0},na={key:0},ra={key:1},oa={key:2},ia={key:1},la={__name:"CreateSnapshotButton",props:{user:{type:Object,default:null}},emits:["snapshot-created"],setup(y,{emit:e}){const t=y,a=e,r=A(t.user),s=A(!1),n=A(!1),u=A(0),o=A("idle"),l=A(""),g=Se(),v=j(()=>r.value?tt(r.value):!1);ve(async()=>{if(!t.user)try{const m=await qe.checkAccess();m.allowed&&(r.value=m.user)}catch(m){console.error("Error loading user:",m)}});const h=()=>{if(!v.value){g.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}s.value=!0},C=()=>{n.value||(s.value=!1,o.value="idle",u.value=0,l.value="")},T=async()=>{if(!n.value){if(!v.value){g.warning("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–ø–∫–∏");return}n.value=!0,o.value="loading_data",u.value=0,l.value="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...";try{l.value="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞ –∏–∑ Bitrix24...";const m=await Be.getSectorDataForSnapshot({useCache:!0,normalize:!0,onProgress:R=>{var X;const J=Math.min(80,(R.progress||0)*.8);u.value=J,o.value="loading_data",l.value=R.description||((X=R.details)==null?void 0:X.description)||"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞..."}});o.value="creating_snapshot",u.value=85,l.value="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–ø–∫–∞...";const f=r.value;if(!f)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");const b=await G.createSnapshot(m,"manual",{createdBy:{id:f.ID,name:`${f.NAME||""} ${f.LAST_NAME||""}`.trim()||f.EMAIL||`User ${f.ID}`},sectorId:"1C"});o.value="success",u.value=100,l.value="–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",g.success("–°–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),a("snapshot-created",b),setTimeout(()=>{C()},1500)}catch(m){o.value="error",u.value=0,l.value="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",console.error("Error creating snapshot:",m);let f="–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞";m.message&&(m.message.includes("–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")||m.message.includes("sector data")?f="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24.":m.message.includes("—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞")||m.message.includes("snapshot")?f="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.":m.message.includes("–≤–∞–ª–∏–¥–∞—Ü")||m.message.includes("validation")?f="–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.":f=m.message),g.error(f)}finally{n.value=!1}}},$=m=>{m.key==="Escape"&&s.value&&!n.value&&C()};return ve(()=>{window.addEventListener("keydown",$)}),Ge(()=>{window.removeEventListener("keydown",$)}),(m,f)=>v.value?(k(),E("div",Vt,[d("button",{class:"create-snapshot-btn",onClick:h,disabled:n.value,title:"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞"},[...f[1]||(f[1]=[d("span",{class:"btn-icon"},"üì∏",-1),d("span",{class:"btn-text"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫",-1)])],8,Lt),(k(),we(et,{to:"body"},[me(Qe,{name:"modal"},{default:Xe(()=>[s.value?(k(),E("div",{key:0,class:"modal-overlay",onClick:f[0]||(f[0]=Ze(b=>!n.value&&C(),["self"]))},[d("div",zt,[d("div",Ht,[f[2]||(f[2]=d("h3",{class:"modal-title"},"–°–æ–∑–¥–∞—Ç—å —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞",-1)),d("button",{class:"modal-close",onClick:C,disabled:n.value,"aria-label":"–ó–∞–∫—Ä—ã—Ç—å"}," ‚úï ",8,Kt)]),d("div",qt,[o.value!=="idle"?(k(),E("div",Gt,[d("div",Xt,[d("div",{class:"progress-bar",style:Ce({width:`${u.value}%`})},null,4)]),d("div",Yt,[d("span",Jt,W(Math.round(u.value))+"%",1),d("span",Zt,W(l.value),1)])])):(k(),E("div",Qt,[...f[3]||(f[3]=[d("p",{class:"modal-description"},' –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–ª–µ–ø–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°. –°–ª–µ–ø–æ–∫ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å —Ç–∏–ø–æ–º "manual" (—Ä—É—á–Ω–æ–π). ',-1),d("p",{class:"modal-warning"}," ‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. ",-1)])]))]),d("div",ea,[d("button",{class:"btn btn-secondary",onClick:C,disabled:n.value}," –û—Ç–º–µ–Ω–∞ ",8,ta),d("button",{class:"btn btn-primary",onClick:T,disabled:n.value},[n.value?(k(),E("span",sa,[o.value==="loading_data"?(k(),E("span",na,"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")):o.value==="creating_snapshot"?(k(),E("span",ra,"–°–æ–∑–¥–∞–Ω–∏–µ...")):(k(),E("span",oa,"–û–±—Ä–∞–±–æ—Ç–∫–∞..."))])):(k(),E("span",ia,"–°–æ–∑–¥–∞—Ç—å"))],8,aa)])])])):P("",!0)]),_:1})]))])):P("",!0)}},ca=Ie(la,[["__scopeId","data-v-09bccee2"]]);function da(){const y=A(!1),e=A(null),t=A(null),a=A(0),r=Se(),s=async(m=!0,f=null)=>{y.value=!0,e.value=null,a.value=0;try{const b=await Be.getSectorDataForSnapshot({useCache:m,onProgress:R=>{R&&typeof R.progress=="number"&&(a.value=R.progress),f&&f(R)},normalize:!0});return t.value=b,b}catch(b){throw e.value=b.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞",r.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–∞: "+e.value),b}finally{y.value=!1,a.value=100}},n=async(m,f={})=>{if(!t.value){const b="–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ loadSectorDataForSnapshot()";throw e.value=b,r.error(b),new Error(b)}y.value=!0,e.value=null;try{if(!["week_start","week_end","manual","current"].includes(m))throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–ª–µ–ø–∫–∞: ${m}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: week_start, week_end, manual, current`);const b=await G.createSnapshot(t.value,m,f);return r.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"),b}catch(b){throw e.value=b.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞",r.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–µ–ø–∫–∞: "+e.value),b}finally{y.value=!1}},u=()=>{y.value=!1,e.value=null,t.value=null,a.value=0},o=j(()=>t.value!==null&&t.value!==void 0),l=A({stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}}),g=j(()=>{const m=new Date;let f,b;switch(l.value.dateRange){case"last-week":f=new Date(m),f.setDate(m.getDate()-7),b=m;break;case"last-2-weeks":f=new Date(m),f.setDate(m.getDate()-14),b=m;break;case"last-month":f=new Date(m),f.setMonth(m.getMonth()-1),b=m;break;case"custom":f=l.value.customDateRange.startDate?new Date(l.value.customDateRange.startDate):null,b=l.value.customDateRange.endDate?new Date(l.value.customDateRange.endDate):null;break;default:f=new Date(m),f.setDate(m.getDate()-7),b=m}return{startDate:f?f.toISOString().split("T")[0]:null,endDate:b?b.toISOString().split("T")[0]:null}}),v=()=>{C()},h=()=>{l.value={stages:{formed:!0,review:!0,execution:!0},employees:["all"],dateRange:"last-week",customDateRange:{startDate:null,endDate:null}},C()},C=()=>{try{localStorage.setItem("graphStateFilters",JSON.stringify(l.value))}catch(m){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ localStorage:",m)}},T=()=>{try{const m=localStorage.getItem("graphStateFilters");if(m){const f=JSON.parse(m);f&&typeof f=="object"&&(l.value={stages:f.stages||{formed:!0,review:!0,execution:!0},employees:f.employees||["all"],dateRange:f.dateRange||"last-week",customDateRange:f.customDateRange||{startDate:null,endDate:null}})}}catch(m){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage:",m)}},$=j(()=>{const m=Object.values(l.value.stages).some(R=>!R),f=!l.value.employees.includes("all"),b=l.value.dateRange!=="last-week";return m||f||b});return{isLoading:y,error:e,currentSectorData:t,loadingProgress:a,hasSectorData:o,filters:l,selectedPeriod:g,hasActiveFilters:$,loadSectorDataForSnapshot:s,createSnapshot:n,resetState:u,applyFilters:v,resetFilters:h,saveFiltersToLocalStorage:C,loadFiltersFromLocalStorage:T}}const ua={class:"graph-state-dashboard"},pa={key:1,class:"error-message-container"},fa={class:"error-message"},ga={class:"error-text"},ha={key:0,class:"error-details"},ma={class:"dashboard-header"},va={class:"header-content"},wa={class:"breadcrumbs","aria-label":"–ù–∞–≤–∏–≥–∞—Ü–∏—è"},ya={class:"header-actions"},Sa=["disabled"],ka={key:0},ba={key:1},Da={class:"filters-header"},Ta=["disabled"],Ea={class:"filters-content"},$a={class:"filter-group"},Aa={class:"checkbox-group"},_a={class:"checkbox-item"},Ca={class:"checkbox-item"},Ia={class:"checkbox-item"},Ba={class:"filter-group"},xa=["value"],Ra={class:"filter-group"},Ma={key:0,class:"filter-group custom-date-range"},Oa={class:"date-range-inputs"},Fa={class:"date-input-group"},Na=["max"],Pa={class:"date-input-group"},Wa=["min","max"],ja={key:0,class:"filter-error"},Ua={key:1,class:"filter-hint"},Va={key:3,class:"dashboard-content"},La={class:"chart-container"},za={__name:"GraphStateDashboard",setup(y){const e=(c,i)=>typeof window>"u"?i:getComputedStyle(document.documentElement).getPropertyValue(c).trim()||i,t=Se(),{filters:a,selectedPeriod:r,hasActiveFilters:s,applyFilters:n,resetFilters:u,loadFiltersFromLocalStorage:o}=da(),l=A(null),g=A(!0),v=A([]),h=A(!1),C=A("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."),T=A(null),$=A(!1),m=A(!1),f=A(typeof window<"u"?window.innerWidth:1024),b=A(null),R=j(()=>f.value<768);j(()=>f.value>=768&&f.value<1024),j(()=>f.value>=1024);const J=j(()=>{const c=new Date;return c.setFullYear(c.getFullYear()-1),c.toISOString().split("T")[0]}),X=j(()=>new Date().toISOString().split("T")[0]);function V(){n()}function ke(){u(),b.value=null,V(),t.info("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")}function ee(){a.value.dateRange!=="custom"&&(b.value=null,V())}function le(){const c=ce(a.value.customDateRange.startDate,a.value.customDateRange.endDate);if(!c.valid){b.value=c.error;return}b.value=null,V()}function ce(c,i){if(!c||!i)return{valid:!1,error:"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–±–µ –¥–∞—Ç—ã"};const w=new Date(c),D=new Date(i);return w>D?{valid:!1,error:"–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π"}:Math.ceil((D-w)/(1e3*60*60*24))>365?{valid:!1,error:"–ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π"}:{valid:!0}}function de(c){t.success("–°–ª–µ–ø–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")}function be(c){h.value=!1,C.value="",console.log("–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",c)}function ue(c){h.value=!1,pe({message:c||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞",details:null,type:"error"})}function pe(c){T.value={message:c.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:c.details||null,type:c.type||"error",timestamp:new Date},console.error("Dashboard error:",T.value),t.error(T.value.message)}function De(){T.value=null}function te(){T.value=null,h.value=!0,C.value="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."}async function L(){if(typeof window>"u"||!window.jsPDF||!window.html2canvas){t.warning("–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ jspdf –∏ html2canvas."),console.warn("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install jspdf html2canvas");return}$.value=!0;try{const c=document.querySelector(".chart-container");if(!c)throw new Error("–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");const i=window.html2canvas,w=await i(c,{scale:2,useCORS:!0,logging:!1,backgroundColor:e("--b24-bg-white","#ffffff")}),D=window.jsPDF,_=new D("landscape","mm","a4"),F=297,I=w.height*F/w.width;_.setFontSize(18),_.text("–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",148.5,15,{align:"center"});const M=new Date().toLocaleDateString("ru-RU");_.setFontSize(10);const B=r.value.startDate&&r.value.endDate?`–ü–µ—Ä–∏–æ–¥: ${r.value.startDate} - ${r.value.endDate}`:"–ü–µ—Ä–∏–æ–¥: –Ω–µ —É–∫–∞–∑–∞–Ω";_.text(B,148.5,25,{align:"center"}),_.text(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${M}`,148.5,30,{align:"center"}),_.addImage(w.toDataURL("image/png"),"PNG",10,35,F-20,I-20),_.setProperties({title:"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",subject:`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç ${M}`,author:"Bitrix24 Dashboard"});const O=`graph-state-${M.replace(/\//g,"-")}.pdf`;_.save(O),t.success("–ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF")}catch(c){console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:",c),pe({message:"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: "+(c.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),details:c.stack,type:"error"})}finally{$.value=!1}}function S(){typeof window<"u"&&(f.value=window.innerWidth)}async function p(){try{const c=await qe.checkAccess();c.allowed&&(l.value=c.user)}catch(c){console.error("Error loading user:",c)}}return ve(()=>{o(),p(),typeof window<"u"&&(f.value=window.innerWidth,window.addEventListener("resize",S))}),Ge(()=>{typeof window<"u"&&window.removeEventListener("resize",S)}),(c,i)=>{const w=at("router-link");return k(),E("div",ua,[h.value?(k(),we(Ke,{key:0,message:C.value},null,8,["message"])):P("",!0),T.value?(k(),E("div",pa,[d("div",fa,[d("div",{class:"error-header"},[i[8]||(i[8]=d("span",{class:"error-icon"},"‚ùå",-1)),i[9]||(i[9]=d("h3",null,"–û—à–∏–±–∫–∞",-1)),d("button",{onClick:De,class:"error-close","aria-label":"–ó–∞–∫—Ä—ã—Ç—å"},"‚úï")]),d("p",ga,W(T.value.message),1),T.value.details?(k(),E("div",ha,[d("details",null,[i[10]||(i[10]=d("summary",null,"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏",-1)),d("pre",null,W(T.value.details),1)])])):P("",!0),d("div",{class:"error-actions"},[d("button",{onClick:te,class:"btn-retry"},"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É")])])])):P("",!0),d("div",ma,[d("div",va,[d("nav",wa,[me(w,{to:{name:"dashboard-sector-1c"},class:"breadcrumb-link"},{default:Xe(()=>[...i[11]||(i[11]=[st(" –î–∞—à–±–æ—Ä–¥ —Å–µ–∫—Ç–æ—Ä–∞ 1–° ",-1)])]),_:1}),i[12]||(i[12]=d("span",{class:"breadcrumb-separator","aria-hidden":"true"},"/",-1)),i[13]||(i[13]=d("span",{class:"breadcrumb-current"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è",-1))]),i[14]||(i[14]=d("h1",{class:"dashboard-title"},"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ 1–°",-1)),i[15]||(i[15]=d("p",{class:"dashboard-subtitle"}," –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ ",-1))]),d("div",ya,[d("button",{onClick:L,class:"btn-export-pdf",disabled:$.value||h.value,title:"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ PDF"},[$.value?(k(),E("span",ba,"‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...")):(k(),E("span",ka,"üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"))],8,Sa),me(ca,{user:l.value,onSnapshotCreated:de},null,8,["user"])])]),R.value?(k(),E("button",{key:2,class:"mobile-filters-toggle",onClick:i[0]||(i[0]=D=>m.value=!m.value)},[i[16]||(i[16]=d("span",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),d("span",{class:ye(["toggle-icon",{open:m.value}])},"‚ñº",2)])):P("",!0),d("div",{class:ye(["filters-panel",{"mobile-open":m.value&&R.value,"mobile-closed":!m.value&&R.value}])},[d("div",Da,[i[17]||(i[17]=d("h2",null,"–§–∏–ª—å—Ç—Ä—ã",-1)),d("button",{onClick:ke,class:"btn-reset-filters",disabled:!x(s)}," –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã ",8,Ta)]),d("div",Ea,[d("div",$a,[i[21]||(i[21]=d("label",{class:"filter-label"},"–≠—Ç–∞–ø—ã:",-1)),d("div",Aa,[d("label",_a,[U(d("input",{type:"checkbox","onUpdate:modelValue":i[1]||(i[1]=D=>x(a).stages.formed=D),onChange:V},null,544),[[he,x(a).stages.formed]]),i[18]||(i[18]=d("span",null,"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ",-1))]),d("label",Ca,[U(d("input",{type:"checkbox","onUpdate:modelValue":i[2]||(i[2]=D=>x(a).stages.review=D),onChange:V},null,544),[[he,x(a).stages.review]]),i[19]||(i[19]=d("span",null,"–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¢–ó",-1))]),d("label",Ia,[U(d("input",{type:"checkbox","onUpdate:modelValue":i[3]||(i[3]=D=>x(a).stages.execution=D),onChange:V},null,544),[[he,x(a).stages.execution]]),i[20]||(i[20]=d("span",null,"–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",-1))])])]),d("div",Ba,[i[23]||(i[23]=d("label",{class:"filter-label"},"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:",-1)),U(d("select",{"onUpdate:modelValue":i[4]||(i[4]=D=>x(a).employees=D),multiple:"",onChange:V,class:"employees-select",size:"5"},[i[22]||(i[22]=d("option",{value:"all"},"–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",-1)),(k(!0),E(re,null,oe(v.value,D=>(k(),E("option",{key:D.id,value:D.id},W(D.name),9,xa))),128))],544),[[Ve,x(a).employees]]),i[24]||(i[24]=d("small",{class:"filter-hint"}," –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac) ",-1))]),d("div",Ra,[i[26]||(i[26]=d("label",{class:"filter-label"},"–ü–µ—Ä–∏–æ–¥:",-1)),U(d("select",{"onUpdate:modelValue":i[5]||(i[5]=D=>x(a).dateRange=D),onChange:ee,class:"date-range-select"},[...i[25]||(i[25]=[d("option",{value:"last-week"},"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è",-1),d("option",{value:"last-2-weeks"},"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏",-1),d("option",{value:"last-month"},"–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",-1),d("option",{value:"custom"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥",-1)])],544),[[Ve,x(a).dateRange]])]),x(a).dateRange==="custom"?(k(),E("div",Ma,[i[29]||(i[29]=d("label",{class:"filter-label"},"–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥:",-1)),d("div",Oa,[d("div",Fa,[i[27]||(i[27]=d("label",null,"–°:",-1)),U(d("input",{type:"date","onUpdate:modelValue":i[6]||(i[6]=D=>x(a).customDateRange.startDate=D),onChange:le,max:x(a).customDateRange.endDate||X.value,class:"date-input"},null,40,Na),[[Le,x(a).customDateRange.startDate]])]),d("div",Pa,[i[28]||(i[28]=d("label",null,"–ü–æ:",-1)),U(d("input",{type:"date","onUpdate:modelValue":i[7]||(i[7]=D=>x(a).customDateRange.endDate=D),onChange:le,min:x(a).customDateRange.startDate||J.value,max:X.value,class:"date-input"},null,40,Wa),[[Le,x(a).customDateRange.endDate]])])]),b.value?(k(),E("small",ja,W(b.value),1)):(k(),E("small",Ua," –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö "))])):P("",!0)])],2),!h.value&&!T.value?(k(),E("div",Va,[d("div",La,[me(Ut,{period:x(r),"show-current-state":g.value,onDataLoaded:be,onError:ue},null,8,["period","show-current-state"])])])):P("",!0)])}}},Ga=Ie(za,[["__scopeId","data-v-a47eb6b6"]]);export{Ga as default};
