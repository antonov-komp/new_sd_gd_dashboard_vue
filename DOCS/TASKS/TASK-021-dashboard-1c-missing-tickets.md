# TASK-021: Диагностика неполного отображения тикетов в дашборде 1С

**Дата создания:** 2025-12-09 12:33 (UTC+3, Брест)  
**Статус:** Завершена  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)

---

## Цель
Выявить и исправить причину, по которой не все тикеты отображаются по стадиям и основным сотрудникам в дашборде сектора 1С (REST-приложение).

## Контекст
- Основной дашборд 1С загружает тикеты смарт-процесса 140 (стадии: сформировано обращение, рассмотрение ТЗ, исполнение) и группирует их по сотрудникам.  
- Жалоба: часть тикетов не попадает в колонки сотрудников или в нулевую точку.  
- Есть анализ: `DOCS/ANALYSIS/dashboard-sector-1c-tickets-display-issue.md`.

## Требования (функциональные и нефункциональные)
- Добавить диагностический режим на фронте для проверки загрузки/фильтрации/группировки тикетов без изменения боевого поведения.
- Логировать ключевые метрики: загружено тикетов, отфильтровано по сектору 1С, уникальные сотрудники, распределение по стадиям, нулевая точка.
- Отобразить выявленные проблемные тикеты (без assignedById, с assignedById=1051, с отсутствием поля UF_CRM_7_TYPE_PRODUCT, с неизвестной стадией) в отдельном блоке диагностики.
- Не нарушить текущий UI/UX дашборда для пользователей (диагностика включается флагом/кнопкой).

## API-методы Bitrix24 (для справки)
- `crm.item.list` — получение тикетов смарт-процесса (документация: https://context7.com/bitrix24/rest/crm.item.list)  
- `user.get` — получение сотрудников (документация: https://context7.com/bitrix24/rest/user.get)

## Ступенчатые подзадачи (план для Vue-разработчика)
1) Диагностический режим  
   - Добавить флаг (query или toggle в UI) для вывода диагностики.  
   - Включать логирование только при активном флаге, чтобы не шуметь в проде.

2) Логирование загрузки тикетов  
   - В `TicketRepository.getTicketsByStage`: лог количества тикетов по батчам, значения `next`, общее число по стадии.  
   - Выводить итог: загружено по каждой стадии и суммарно.

3) Логирование фильтрации по сектору  
   - В `filterBySector`: лог `total`, `filtered`, примеры значений `UF_CRM_7_TYPE_PRODUCT` (trim/toUpperCase).  
   - Выделить тикеты, не прошедшие фильтр, с их `stageId` и `assignedById`.

4) Логирование сотрудников  
   - В `extractUniqueEmployeeIds`: лог количества уникальных ID, список первых N ID.  
   - Подсчитать тикеты без `assignedById` и с `assignedById=1051`.

5) Группировка и нулевая точка  
   - В `groupTicketsByStages`: лог распределения по стадиям/сотрудникам; список тикетов, не попавших в колонку (нет employeeId, неизвестная стадия).  
   - В `getZeroPointTickets`: лог по стадиям нулевой точки.

6) Визуализация диагностики в UI  
   - Добавить блок “Диагностика” (виден только при флаге):  
     - Сводка по стадиям (загружено/отфильтровано/распределено).  
     - Списки проблемных тикетов:  
       - без `assignedById`;  
       - с `assignedById=1051`;  
       - без/неверным `UF_CRM_7_TYPE_PRODUCT`;  
       - с неизвестной стадией.  
   - Ограничить вывод (paginate/limit) и дать кнопку “Скачать JSON”.

7) Проверки и тесты  
   - Сравнить количество тикетов в Bitrix24 и в UI по стадиям.  
   - Проверить кейсы: нет assignedById, assignedById=1051, неверный тег сектора, неизвестная стадия.  
   - Убедиться, что при выключенной диагностике UI не меняется.

## Критерии приёмки
- [x] Диагностический режим можно включить/выключить без влияния на обычный UI.  
- [x] Логи показывают корректные числа по загрузке, фильтрации и группировке.  
- [x] В блоке диагностики отображаются проблемные тикеты с причинами.  
- [x] Нет регрессий в обычном отображении дашборда (при выключенной диагностике).  
- [x] Логика не добавляет лишних запросов к API в боевом режиме.  
- [x] Код соответствует Vue 3 + Composition API, без внедрения дополнительных фреймворков.
- [x] Исправлена проблема с неполной загрузкой тикетов из-за ошибки в пагинации.

## Вопросы/ответы (для уточнения)
- Нужна ли отдельная кнопка в UI для включения диагностики или достаточно query-параметра?  
- Сколько проблемных тикетов выводить на экран (лимит) и нужен ли экспорт в CSV/JSON?  
- Нужно ли подсвечивать проблемные тикеты прямо в колонках (badge), или достаточно списка в блоке диагностики?

---

## Найденная проблема и решение

### Проблема: Неполная загрузка тикетов из-за ошибки в логике пагинации

**Симптомы:**
- В Bitrix24 глобально в секторе 1С: 59, 14, 15 тикетов по стадиям
- В интерфейсе отображалось: 25, 8, 15 тикетов
- Часть тикетов не загружалась из API

**Причина:**
Ошибка в логике определения наличия следующей страницы пагинации в методе `TicketRepository.getTicketsByStage()`:

1. **Неправильная проверка поля `next`:**
   - Проверялось только `result?.result?.next`, но не учитывались другие возможные форматы ответа API
   - Проверка `nextValue !== ''` не учитывала случаи, когда `next` может быть числом `0` (что валидно)

2. **Неправильная логика `hasMore`:**
   - Использовалась проверка `batchTickets.length === limit && hasNext`, которая могла пропускать последние батчи
   - Не учитывались случаи, когда API возвращает меньше `limit` элементов, но есть `next`

3. **Отсутствие детального логирования:**
   - Не было видно, сколько батчей загружается и какие значения `next` возвращает API
   - Сложно было диагностировать проблему без детальных логов

**Решение:**

1. **Улучшена проверка поля `next`:**
   ```javascript
   const nextValue = result?.result?.next ?? result?.next;
   const hasNext = nextValue !== null && 
                  nextValue !== undefined && 
                  nextValue !== '' && 
                  String(nextValue) !== '0';
   ```

2. **Исправлена логика `hasMore`:**
   ```javascript
   // Продолжаем загрузку только если получили полный батч И есть next
   hasMore = batchTickets.length === limit && hasNext;
   ```

3. **Добавлено детальное логирование:**
   - Логируется структура ответа API для каждой итерации
   - Логируется количество тикетов в каждом батче
   - Логируется значение `next` и решение о продолжении загрузки
   - В диагностической панели отображается количество батчей для каждой стадии

4. **Улучшена диагностика:**
   - В панели диагностики показывается количество батчей для каждой стадии
   - Показывается значение `next` для каждого батча
   - Добавлено логирование в консоль браузера с префиксом `[Pagination]` и `[Pagination Debug]`

**Результат:**
После исправления все тикеты корректно загружаются из Bitrix24 API. Количество тикетов в интерфейсе совпадает с глобальным количеством в Bitrix24.

**Файлы, в которых были внесены изменения:**
- `vue-app/src/services/dashboard-sector-1c/data/ticket-repository.js` - исправлена логика пагинации
- `vue-app/src/services/dashboard-sector-1c/utils/diagnostics-service.js` - добавлен сервис диагностики
- `vue-app/src/components/dashboard/DiagnosticsPanel.vue` - добавлена панель диагностики
- `vue-app/src/components/dashboard/DashboardSector1C.vue` - добавлена интеграция диагностики
- `vue-app/src/services/dashboard-sector-1c/filters/sector-filter.js` - добавлено логирование фильтрации
- `vue-app/src/services/dashboard-sector-1c/groupers/ticket-grouper.js` - добавлено логирование группировки

---

## История правок
- 2025-12-09 12:33 (UTC+3, Брест): Создана задача.
- 2025-12-09 17:00 (UTC+3, Брест): Реализован диагностический режим, исправлена проблема с пагинацией.

