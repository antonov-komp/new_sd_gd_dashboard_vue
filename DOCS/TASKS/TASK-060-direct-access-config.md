# TASK-060: Конфигурация прямого доступа к приложению

**Дата создания:** 2025-12-23 08:22 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js) + DevOps

---

## Описание

Реализовать систему конфигурации для управления прямым доступом к приложению через браузер. При открытии приложения напрямую по ссылке (не в iframe Bitrix24) должна проверяться конфигурация, и если она разрешает прямой доступ, то используется токен первичного администратора из `settings.php`.

---

## Контекст

В настоящее время приложение может открываться двумя способами:

1. **В iframe Bitrix24** — используется токен пользователя интерфейса (того, кто открыл приложение)
2. **Напрямую в браузере** — используется токен владельца установки (из `settings.json`)

**Проблема:** При прямом открытии в браузере приложение не может определить, кто именно открыл его, и всегда использует токен владельца установки. Это создаёт потенциальную проблему безопасности.

**Решение:** Добавить конфигурационный файл в корне приложения, который контролирует, разрешён ли прямой доступ. Если прямой доступ разрешён (`true`), то используется токен первичного администратора из `settings.php`.

---

## Модули и компоненты

### Backend (PHP)

- `direct-access-config.php` — конфигурационный файл в корне приложения
- `api/direct-access-config.php` — API endpoint для чтения конфигурации (опционально)

### Frontend (Vue.js)

- `vue-app/src/services/access-control-service.js` — модификация логики проверки доступа
- `vue-app/src/services/bitrix24-bx-api.js` — модификация логики определения пользователя
- `vue-app/src/utils/direct-access-config.js` — утилита для работы с конфигурацией прямого доступа

---

## Зависимости

- Использует `settings.php` для получения токена первичного администратора
- Использует `crest.php` для работы с Bitrix24 REST API
- Зависит от `AccessControlService` для проверки доступа

---

## Ступенчатые подзадачи

### 1. Создание конфигурационного файла

**Файл:** `/var/www/app/public/rest_api_aps/sd_it_gen_plan/direct-access-config.php`

**Структура:**
```php
<?php
/**
 * Конфигурация прямого доступа к приложению
 * 
 * Контролирует, разрешён ли прямой доступ к приложению через браузер
 * (не в iframe Bitrix24)
 * 
 * Значения:
 * - true: Прямой доступ разрешён, используется токен первичного администратора из settings.php
 * - false: Прямой доступ запрещён, показывается сообщение об ошибке
 * 
 * ВАЖНО: Для безопасности рекомендуется установить false в production
 */

return [
    'allow_direct_access' => false,  // По умолчанию запрещено
    'message_on_deny' => 'Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24.'
];
```

**Требования:**
- Файл должен быть в корне приложения
- Должен возвращать массив с настройками
- По умолчанию `allow_direct_access = false` (безопасность)
- Должен быть добавлен в `.gitignore` (если содержит секреты)

### 2. Создание API endpoint для чтения конфигурации

**Файл:** `/var/www/app/public/rest_api_aps/sd_it_gen_plan/api/direct-access-config.php`

**Назначение:** Предоставить Vue.js приложению доступ к конфигурации прямого доступа

**Формат ответа:**
```json
{
  "allow_direct_access": false,
  "message_on_deny": "Прямой доступ к приложению запрещён..."
}
```

**Реализация:**
```php
<?php
/**
 * API endpoint для получения конфигурации прямого доступа
 * 
 * Возвращает настройки прямого доступа из direct-access-config.php
 */

header('Content-Type: application/json; charset=utf-8');

$configPath = __DIR__ . '/../direct-access-config.php';

if (!file_exists($configPath)) {
    // Если конфиг не существует, возвращаем значения по умолчанию
    echo json_encode([
        'allow_direct_access' => false,
        'message_on_deny' => 'Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24.'
    ]);
    exit;
}

$config = require $configPath;

echo json_encode([
    'allow_direct_access' => $config['allow_direct_access'] ?? false,
    'message_on_deny' => $config['message_on_deny'] ?? 'Прямой доступ к приложению запрещён.'
]);
```

### 3. Создание утилиты для работы с конфигурацией (Vue.js)

**Файл:** `vue-app/src/utils/direct-access-config.js`

**Назначение:** Утилита для чтения конфигурации прямого доступа из API

**Реализация:**
```javascript
/**
 * Утилита для работы с конфигурацией прямого доступа
 * 
 * Читает настройки прямого доступа из API endpoint
 */

import { getApiUrl } from './path-utils.js';

let cachedConfig = null;

/**
 * Получение конфигурации прямого доступа
 * 
 * @returns {Promise<object>} Конфигурация прямого доступа
 */
export async function getDirectAccessConfig() {
  if (cachedConfig) {
    return cachedConfig;
  }
  
  try {
    const response = await fetch(getApiUrl('/api/direct-access-config.php'));
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const config = await response.json();
    cachedConfig = config;
    
    return config;
  } catch (error) {
    console.error('Error loading direct access config:', error);
    // Возвращаем значения по умолчанию при ошибке
    return {
      allow_direct_access: false,
      message_on_deny: 'Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24.'
    };
  }
}

/**
 * Проверка, разрешён ли прямой доступ
 * 
 * @returns {Promise<boolean>} true, если прямой доступ разрешён
 */
export async function isDirectAccessAllowed() {
  const config = await getDirectAccessConfig();
  return config.allow_direct_access === true;
}
```

### 4. Модификация AccessControlService

**Файл:** `vue-app/src/services/access-control-service.js`

**Изменения:**

1. Добавить проверку конфигурации прямого доступа при определении пользователя
2. Если приложение открыто напрямую (не в iframe) и прямой доступ разрешён — использовать токен первичного администратора
3. Если приложение открыто напрямую и прямой доступ запрещён — показать сообщение об ошибке

**Логика:**

```javascript
static async checkAccess() {
  try {
    // Проверка контекста
    const isInsideB24 = isInsideBitrix24();
    
    // Если не внутри Bitrix24, проверяем конфигурацию прямого доступа
    if (!isInsideB24) {
      const { isDirectAccessAllowed, getDirectAccessConfig } = await import('@/utils/direct-access-config.js');
      
      const allowDirectAccess = await isDirectAccessAllowed();
      
      if (!allowDirectAccess) {
        // Прямой доступ запрещён
        const config = await getDirectAccessConfig();
        return new AccessCheckResult(
          false,
          AccessErrorCodes.ACCESS_DENIED,
          config.message_on_deny || 'Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24.'
        );
      }
      
      // Прямой доступ разрешён — используем токен первичного администратора
      // Это будет обработано в getCurrentUser() через прокси API
      // Прокси API использует токен из settings.php (первичный администратор)
    }
    
    // Остальная логика проверки доступа...
    // (получение пользователя, проверка отделов и т.д.)
  } catch (error) {
    // Обработка ошибок...
  }
}
```

### 5. Модификация логики определения пользователя

**Файл:** `vue-app/src/services/bitrix24-bx-api.js`

**Изменения:**

При прямом открытии (standalone режим) и разрешённом прямом доступе:
- Использовать прокси API, который вернёт владельца токена из `settings.php`
- Этот токен принадлежит первичному администратору

**Логика уже реализована:**
```javascript
static async getCurrentUser() {
  // ...
  } else {
    // Если мы не внутри Bitrix24 (standalone режим), 
    // то прокси - единственный способ, но он вернёт владельца токена
    console.warn('Not inside Bitrix24, using proxy API (will return token owner, not interface user)');
    return await Bitrix24ApiService.getCurrentUser();
  }
}
```

**Дополнить комментариями:**
- Указать, что при разрешённом прямом доступе это ожидаемое поведение
- Владелец токена из `settings.php` — это первичный администратор

### 6. Обновление IndexPage.vue

**Файл:** `vue-app/src/components/IndexPage.vue`

**Изменения:**

При отображении сообщения об ошибке доступа:
- Если ошибка связана с запретом прямого доступа — показать специальное сообщение
- Предложить открыть приложение через интерфейс Bitrix24

---

## Технические требования

### Конфигурационный файл

- **Формат:** PHP массив (return array)
- **Расположение:** Корень приложения (`/var/www/app/public/rest_api_aps/sd_it_gen_plan/direct-access-config.php`)
- **Права доступа:** `644` (чтение для всех, запись для владельца)
- **Безопасность:** Можно добавить в `.gitignore`, если содержит секреты (но в данном случае не содержит)

### API Endpoint

- **URL:** `/api/direct-access-config.php`
- **Метод:** GET
- **Формат ответа:** JSON
- **Кеширование:** На стороне клиента (Vue.js)

### Vue.js утилита

- **Кеширование:** Конфигурация кешируется после первой загрузки
- **Fallback:** При ошибке загрузки возвращаются значения по умолчанию (безопасность)

---

## Критерии приёмки

- [ ] Создан файл `direct-access-config.php` в корне приложения
- [ ] Создан API endpoint `/api/direct-access-config.php`
- [ ] Создана утилита `direct-access-config.js` для Vue.js
- [ ] Модифицирован `AccessControlService` для проверки конфигурации
- [ ] При открытии в iframe Bitrix24 — используется токен пользователя интерфейса (как сейчас)
- [ ] При прямом открытии и `allow_direct_access = false` — показывается сообщение об ошибке
- [ ] При прямом открытии и `allow_direct_access = true` — используется токен первичного администратора из `settings.php`
- [ ] Конфигурация кешируется на стороне клиента
- [ ] При ошибке загрузки конфигурации используются безопасные значения по умолчанию
- [ ] Код соответствует стандартам проекта
- [ ] Добавлены комментарии с объяснением логики

---

## Тестирование

### Тест 1: Открытие в iframe Bitrix24

**Шаги:**
1. Открыть приложение через интерфейс Bitrix24 (placement, виджет)
2. Проверить, что определяется пользователь интерфейса
3. Проверить, что проверка доступа работает корректно

**Ожидаемый результат:**
- ✅ Определяется пользователь интерфейса (тот, кто открыл)
- ✅ Проверка доступа выполняется для пользователя интерфейса

### Тест 2: Прямое открытие при `allow_direct_access = false`

**Шаги:**
1. Установить `allow_direct_access = false` в `direct-access-config.php`
2. Открыть приложение напрямую в браузере: `https://back.kompo.by/rest_api_aps/sd_it_gen_plan/index.php`
3. Проверить сообщение об ошибке

**Ожидаемый результат:**
- ❌ Показывается сообщение: "Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24."
- ❌ Приложение не загружается

### Тест 3: Прямое открытие при `allow_direct_access = true`

**Шаги:**
1. Установить `allow_direct_access = true` в `direct-access-config.php`
2. Открыть приложение напрямую в браузере
3. Проверить, что используется токен первичного администратора

**Ожидаемый результат:**
- ✅ Приложение загружается
- ✅ Определяется владелец токена из `settings.php` (первичный администратор)
- ✅ Проверка доступа выполняется для первичного администратора

### Тест 4: Ошибка загрузки конфигурации

**Шаги:**
1. Удалить или переименовать `direct-access-config.php`
2. Открыть приложение напрямую в браузере
3. Проверить поведение

**Ожидаемый результат:**
- ❌ Используются безопасные значения по умолчанию (`allow_direct_access = false`)
- ❌ Показывается сообщение об ошибке доступа

---

## Безопасность

### Рекомендации

1. **По умолчанию:** `allow_direct_access = false` (безопасность)
2. **В production:** Рекомендуется оставить `false`
3. **В development:** Можно установить `true` для удобства разработки
4. **Логирование:** Логировать попытки прямого доступа (опционально)

### Потенциальные риски

- ⚠️ При `allow_direct_access = true` любой, кто знает URL, может открыть приложение
- ⚠️ Используется токен первичного администратора, что даёт полный доступ
- ✅ Риск минимизирован тем, что по умолчанию прямой доступ запрещён

---

## Примеры использования

### Пример 1: Запрет прямого доступа (production)

**Файл:** `direct-access-config.php`
```php
<?php
return [
    'allow_direct_access' => false,
    'message_on_deny' => 'Прямой доступ к приложению запрещён. Откройте приложение через интерфейс Bitrix24.'
];
```

### Пример 2: Разрешение прямого доступа (development)

**Файл:** `direct-access-config.php`
```php
<?php
return [
    'allow_direct_access' => true,
    'message_on_deny' => 'Прямой доступ к приложению запрещён.'
];
```

---

## История правок

- 2025-12-23 08:22 (UTC+3, Брест): Создана задача

---

## Связанные документы

- [Архитектура точки входа](../ARCHITECTURE/application-entry-point.md)
- [Механизм проверки пользователя](../ARCHITECTURE/user-authentication-authorization.md)
- [Settings.php](../../settings.php) — конфигурация первичного администратора

