# TASK-010: Рефакторинг кода дашборда сектора 1С (TASK-006 и TASK-007)

**Дата создания:** 2025-12-06 14:29 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Исполнитель:** Рефактор-менеджер  
**Связанные задачи:** TASK-006, TASK-007

---

## Описание

Провести комплексный рефакторинг кода, реализованного в рамках задач TASK-006 и TASK-007, с целью улучшения структуры, читаемости, поддерживаемости и производительности без нарушения существующей логики работы.

**Цель рефакторинга:**
- Устранить дублирование кода
- Улучшить читаемость и структуру
- Оптимизировать производительность
- Улучшить обработку ошибок
- Упростить поддержку кода

**Важно:** Все изменения должны сохранять существующую функциональность и не нарушать логику работы дашборда.

---

## Контекст

**Анализ реализованного кода:**

### TASK-006 (Нулевая точка для тикетов с ответственным 1051):
- ✅ Константа `KEEPER_OBJECTS_ID = 1051` вынесена в начало файла `ticket-grouper.js`
- ✅ Функция `getZeroPointTickets()` обновлена для включения тикетов с ответственным 1051
- ✅ Функция `groupTicketsByStages()` обновлена для исключения тикетов с ответственным 1051
- ✅ Сотрудник с ID 1051 исключён из списка сотрудников этапа

**Выявленные проблемы:**
1. Дублирование логики извлечения `assignedById` в разных местах (ticket-grouper.js, extractUniqueEmployeeIds)
2. Сложная логика проверки полей `assignedById` с множественными вариантами имени поля
3. Отсутствие единой утилиты для работы с полем `assignedById`

### TASK-007 (Анимированный прелоадер):
- ✅ Создан композабл `useLoadingProgress.js` для управления прогрессом
- ✅ Создан компонент `LoadingPreloader.vue` с анимацией и детальной информацией
- ✅ Добавлена поддержка колбэков прогресса в `DashboardSector1CService.getSectorData()`
- ✅ Добавлена поддержка колбэков прогресса в `TicketRepository.getAllTickets()`
- ✅ Фиксированный размер контейнера прелоадера

**Выявленные проблемы:**
1. Множественные `console.log` для отладки остались в коде
2. Сложная вложенная структура колбэков прогресса (onProgress внутри onProgress)
3. Дублирование логики формирования `details` для колбэков прогресса
4. Отсутствие типизации для колбэков прогресса
5. Сложная логика обновления прогресса в `useDashboardActions.js`

---

## Модули и компоненты

### Файлы для рефакторинга:

1. **`vue-app/src/services/dashboard-sector-1c/groupers/ticket-grouper.js`**
   - Вынести логику извлечения `assignedById` в утилиту
   - Упростить проверку на `KEEPER_OBJECTS_ID`

2. **`vue-app/src/services/dashboard-sector-1c/data/ticket-repository.js`**
   - Убрать избыточные `console.log`
   - Упростить структуру колбэков прогресса
   - Вынести логику формирования `details` в отдельную функцию

3. **`vue-app/src/services/dashboard-sector-1c/index.js`**
   - Убрать избыточные `console.log`
   - Упростить структуру колбэков прогресса
   - Вынести логику формирования `details` в отдельную функцию

4. **`vue-app/src/composables/useLoadingProgress.js`**
   - Убрать избыточные `console.log`
   - Улучшить типизацию (JSDoc)

5. **`vue-app/src/composables/useDashboardActions.js`**
   - Убрать избыточные `console.log`
   - Упростить логику обновления прогресса
   - Вынести логику обработки колбэков прогресса в отдельную функцию

6. **`vue-app/src/components/dashboard/LoadingPreloader.vue`**
   - Улучшить типизацию props (JSDoc)
   - Оптимизировать computed свойства

### Новые файлы для создания:

1. **`vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js`**
   - Утилита для извлечения `assignedById` из тикета
   - Утилита для проверки, является ли тикет нулевой точкой

2. **`vue-app/src/services/dashboard-sector-1c/utils/progress-utils.js`**
   - Утилита для формирования объекта `details` для колбэков прогресса
   - Утилита для нормализации данных прогресса

---

## Зависимости

### От других задач:
- **TASK-006** — должна быть завершена
- **TASK-007** — должна быть завершена

### От модулей:
- Все существующие модули дашборда сектора 1С

---

## Ступенчатые подзадачи

### Шаг 1: Создание утилиты для работы с полем `assignedById`

**Файл:** `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js`

**Цель:** Устранить дублирование логики извлечения `assignedById` из тикетов.

**Реализация:**
- Создать функцию `getAssignedById(ticket)` для извлечения ID ответственного
- Создать функцию `parseEmployeeId(assignedById)` для парсинга ID
- Создать функцию `isZeroPointTicket(ticket, keeperId)` для проверки, является ли тикет нулевой точкой
- Обновить все места использования логики `assignedById` для использования новых утилит

**Критерии приёмки:**
- [ ] Файл `ticket-utils.js` создан
- [ ] Функция `getAssignedById()` реализована и протестирована
- [ ] Функция `parseEmployeeId()` реализована и протестирована
- [ ] Функция `isZeroPointTicket()` реализована и протестирована
- [ ] Все места использования логики `assignedById` обновлены
- [ ] Логика работы не нарушена (тикеты с ответственным 1051 попадают в нулевую точку)

---

### Шаг 2: Рефакторинг `ticket-grouper.js` с использованием утилит

**Файл:** `vue-app/src/services/dashboard-sector-1c/groupers/ticket-grouper.js`

**Цель:** Упростить код группировки тикетов, используя новые утилиты.

**Реализация:**
- Импортировать утилиты из `ticket-utils.js`
- Заменить логику извлечения `assignedById` на вызов `getAssignedById()`
- Заменить проверку на `KEEPER_OBJECTS_ID` на вызов `isZeroPointTicket()`
- Упростить функцию `extractUniqueEmployeeIds()` с использованием утилит

**Критерии приёмки:**
- [ ] Импортированы утилиты из `ticket-utils.js`
- [ ] Функция `getZeroPointTickets()` использует утилиты
- [ ] Функция `groupTicketsByStages()` использует утилиты
- [ ] Функция `extractUniqueEmployeeIds()` использует утилиты
- [ ] Логика работы не нарушена
- [ ] Код стал более читаемым

---

### Шаг 3: Создание утилиты для работы с прогрессом загрузки

**Файл:** `vue-app/src/services/dashboard-sector-1c/utils/progress-utils.js`

**Цель:** Устранить дублирование логики формирования объектов прогресса.

**Реализация:**
- Создать функцию `createProgressDetails(step, progress, details)` для формирования объекта деталей прогресса
- Создать функцию `normalizeProgressData(progressInfo)` для нормализации данных прогресса
- Создать функцию `calculateProgress(baseProgress, range, percent)` для расчёта прогресса

**Критерии приёмки:**
- [ ] Файл `progress-utils.js` создан
- [ ] Функция `createProgressDetails()` реализована
- [ ] Функция `normalizeProgressData()` реализована
- [ ] Функция `calculateProgress()` реализована
- [ ] Все функции протестированы

---

### Шаг 4: Рефакторинг `ticket-repository.js` — упрощение колбэков прогресса

**Файл:** `vue-app/src/services/dashboard-sector-1c/data/ticket-repository.js`

**Цель:** Упростить структуру колбэков прогресса и убрать избыточные `console.log`.

**Реализация:**
- Импортировать утилиты из `progress-utils.js`
- Заменить дублирующуюся логику формирования `details` на вызовы утилит
- Убрать избыточные `console.log` (оставить только критичные)
- Упростить вложенные колбэки прогресса

**Критерии приёмки:**
- [ ] Импортированы утилиты из `progress-utils.js`
- [ ] Логика формирования `details` вынесена в утилиты
- [ ] Избыточные `console.log` удалены
- [ ] Структура колбэков упрощена
- [ ] Логика работы не нарушена (прелоадер отображает корректную информацию)

---

### Шаг 5: Рефакторинг `index.js` (DashboardSector1CService) — упрощение колбэков прогресса

**Файл:** `vue-app/src/services/dashboard-sector-1c/index.js`

**Цель:** Упростить структуру колбэков прогресса и убрать избыточные `console.log`.

**Реализация:**
- Импортировать утилиты из `progress-utils.js`
- Заменить дублирующуюся логику формирования `details` на вызовы утилит
- Убрать избыточные `console.log` (оставить только критичные)
- Упростить структуру колбэков прогресса

**Критерии приёмки:**
- [ ] Импортированы утилиты из `progress-utils.js`
- [ ] Логика формирования `details` вынесена в утилиты
- [ ] Избыточные `console.log` удалены
- [ ] Структура колбэков упрощена
- [ ] Логика работы не нарушена (прелоадер отображает корректную информацию)

---

### Шаг 6: Рефакторинг `useLoadingProgress.js` — улучшение типизации и уборка логов

**Файл:** `vue-app/src/composables/useLoadingProgress.js`

**Цель:** Улучшить типизацию и убрать избыточные `console.log`.

**Реализация:**
- Добавить JSDoc комментарии с типами для всех функций
- Убрать избыточные `console.log` (оставить только критичные)
- Улучшить документацию функций

**Критерии приёмки:**
- [ ] Добавлены JSDoc комментарии с типами
- [ ] Избыточные `console.log` удалены
- [ ] Документация функций улучшена
- [ ] Логика работы не нарушена

---

### Шаг 7: Рефакторинг `useDashboardActions.js` — упрощение логики прогресса

**Файл:** `vue-app/src/composables/useDashboardActions.js`

**Цель:** Упростить логику обработки колбэков прогресса и убрать избыточные `console.log`.

**Реализация:**
- Импортировать утилиты из `progress-utils.js`
- Вынести логику обработки колбэков прогресса в отдельную функцию `handleProgressCallback(progressInfo, loadingProgress)`
- Упростить логику обновления прогресса
- Убрать избыточные `console.log` (оставить только критичные)

**Критерии приёмки:**
- [ ] Импортированы утилиты из `progress-utils.js`
- [ ] Создана функция `handleProgressCallback()`
- [ ] Логика обработки колбэков упрощена
- [ ] Избыточные `console.log` удалены
- [ ] Логика работы не нарушена (прелоадер обновляется корректно)

---

### Шаг 8: Рефакторинг `LoadingPreloader.vue` — улучшение типизации и оптимизация

**Файл:** `vue-app/src/components/dashboard/LoadingPreloader.vue`

**Цель:** Улучшить типизацию props и оптимизировать computed свойства.

**Реализация:**
- Добавить JSDoc комментарии с типами для всех props
- Оптимизировать computed свойства (избежать лишних вычислений)
- Улучшить документацию компонента

**Критерии приёмки:**
- [ ] Добавлены JSDoc комментарии с типами для props
- [ ] Computed свойства оптимизированы
- [ ] Документация компонента улучшена
- [ ] Логика работы не нарушена (прелоадер отображается корректно)

---

### Шаг 9: Оптимизация производительности — мемоизация и кеширование

**Файлы:** Все файлы, связанные с дашбордом сектора 1С

**Цель:** Оптимизировать производительность без нарушения логики.

**Реализация:**
- Проверить возможность мемоизации вычислений в `ticket-grouper.js`
- Оптимизировать фильтрацию тикетов (если возможно)
- Проверить использование кеша (уже реализовано в `sector-filter.js`)

**Критерии приёмки:**
- [ ] Проведён анализ производительности
- [ ] Выявлены узкие места (если есть)
- [ ] Оптимизации применены (если возможно)
- [ ] Логика работы не нарушена
- [ ] Производительность улучшена или не ухудшилась

---

### Шаг 10: Финальная проверка и документация

**Файлы:** Все изменённые файлы + документация

**Цель:** Убедиться, что все изменения работают корректно и задокументированы.

**Реализация:**
- Провести полное тестирование всех изменений
- Обновить документацию в `DOCS/` (если нужно)
- Создать краткое описание изменений для команды
- Убедиться, что все критерии приёмки выполнены

**Критерии приёмки:**
- [ ] Все изменения протестированы
- [ ] Логика работы не нарушена:
  - [ ] Тикеты с ответственным 1051 попадают в нулевую точку
  - [ ] Тикеты с ответственным 1051 не отображаются в колонках сотрудников
  - [ ] Сотрудник с ID 1051 не отображается в рендере стадий
  - [ ] Прелоадер отображается и обновляется корректно
  - [ ] Все этапы загрузки отображаются корректно
- [ ] Документация обновлена (если нужно)
- [ ] Код соответствует стандартам проекта
- [ ] Все критерии приёмки из предыдущих шагов выполнены

---

## Технические требования

### Принципы рефакторинга:

1. **Не нарушать логику работы**
   - Все существующие тесты должны проходить
   - Функциональность должна работать идентично

2. **Улучшать читаемость**
   - Код должен быть понятным и самодокументируемым
   - Комментарии должны объяснять "почему", а не "что"

3. **Устранять дублирование**
   - Выносить общую логику в утилиты
   - Использовать DRY принцип

4. **Улучшать поддерживаемость**
   - Код должен быть легко изменяемым
   - Изменения в одном месте не должны требовать изменений в других

5. **Оптимизировать производительность**
   - Не ухудшать производительность
   - При возможности — улучшать

### Стандарты кода:

- **JavaScript:** ES6+ синтаксис
- **Vue.js:** Composition API, Vue 3.x
- **Комментарии:** JSDoc для функций и типов
- **Именование:** camelCase для переменных и функций, PascalCase для классов

---

## Критерии приёмки (общие)

- [ ] Все 10 шагов выполнены
- [ ] Логика работы не нарушена:
  - [ ] Тикеты с ответственным 1051 попадают в нулевую точку
  - [ ] Тикеты с ответственным 1051 не отображаются в колонках сотрудников
  - [ ] Сотрудник с ID 1051 не отображается в рендере стадий
  - [ ] Прелоадер отображается и обновляется корректно
  - [ ] Все этапы загрузки отображаются корректно
- [ ] Дублирование кода устранено
- [ ] Избыточные `console.log` удалены
- [ ] Типизация улучшена (JSDoc)
- [ ] Код стал более читаемым
- [ ] Производительность не ухудшилась
- [ ] Документация обновлена (если нужно)

---

## Тестирование

### Функциональное тестирование:

1. **Проверка логики нулевой точки (TASK-006):**
   - Тикеты с ответственным 1051 попадают в нулевую точку
   - Тикеты с ответственным 1051 не отображаются в колонках сотрудников
   - Сотрудник с ID 1051 не отображается в рендере стадий
   - Тикеты без ответственного работают как раньше

2. **Проверка прелоадера (TASK-007):**
   - Прелоадер отображается при загрузке
   - Все этапы загрузки отображаются корректно
   - Прогресс-бар обновляется корректно
   - Детали этапа отображаются корректно
   - Ошибки обрабатываются корректно

3. **Проверка производительности:**
   - Время загрузки не увеличилось
   - Использование памяти не увеличилось

### Интеграционное тестирование:

1. Проверить работу дашборда в целом
2. Проверить работу с кешем
3. Проверить работу с ошибками

---

## История правок

- **2025-12-06 14:29 (UTC+3, Брест):** Создана задача TASK-010 для рефакторинга кода TASK-006 и TASK-007

---

**Автор:** Рефактор-менеджер  
**Статус:** Новая

