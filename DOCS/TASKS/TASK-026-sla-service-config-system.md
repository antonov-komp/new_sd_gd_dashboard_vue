# TASK-026: Система конфигурации значения "В работе" (UF_SLA_SERVICE_STR) для тикетов сектора 1С

**Дата создания:** 2025-12-11 18:30 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Родительская задача:** Нет

## Описание

Реализация централизованной системы конфигурации для значения плашки "В работе" в карточках тикетов канбан-доски сектора 1С. Значение берётся из пользовательского поля Bitrix24 `UF_SLA_SERVICE_STR` (текст). Необходимо описать устойчивые значения сервиса, их визуальное отображение (цвета/стили), обработку пустых и неидентифицированных значений, а также интеграцию в мапперы и компоненты Vue.

## Контекст

В карточках тикетов дашборда сектора 1С используется плашка "В работе". Источник данных — поле `UF_SLA_SERVICE_STR` в Bitrix24. Требуется сделать единый конфиг по аналогии с задачей `TASK-025` (приоритеты), чтобы все компоненты отображали значение консистентно и имели fallback для пустых/неизвестных значений.

Устойчивые значения из Bitrix24:
- 1С.Бухгалтерия  
- 1С.Талоны  
- 1С.ЗУП  
- 1С.Документооборот  
- 1С.Интеграции

**Важно:** это отдельный конфиг только для сектора 1С. Аналогичные конфиги как самостоятельные инструменты будут создаваться под другие секторы отдельно (с собственными значениями и визуальными параметрами).

## Цель задачи

1. Создать конфигурационный файл для значений `UF_SLA_SERVICE_STR` с визуальными параметрами.
2. Обновить маппер тикетов для работы с `UF_SLA_SERVICE_STR`.
3. Обновить компонент `TicketCard.vue` для отображения плашки "В работе" через новый конфиг.
4. Добавить обработку пустых/неидентифицированных значений (значение по умолчанию).
5. Обеспечить единообразное отображение во всех компонентах дашборда сектора 1С.

---

## План реализации (5 этапов)

### Этап 1: Создание конфигурационного файла значения "В работе"

**Цель этапа:** Создать централизованный конфигурационный файл с определением устойчивых значений `UF_SLA_SERVICE_STR`, их визуального отображения и утилит.

#### Подзадачи этапа 1:
1.1. Создание файла конфигурации  
- Создать файл `vue-app/src/config/service-config.js`.  
- Определить структуру конфигурации значения "В работе".  
- Добавить все устойчивые значения из Bitrix24 (см. список выше).  
- Определить визуальные параметры (цвет, фон, цвет текста, порядок).

1.2. Определение структуры данных  
- Объект значения: `id`, `label`, `bitrixValue`, `color`, `backgroundColor`, `textColor`, `order`, `description` (опц.).  
- Определить позицию значения по умолчанию (fallback).

1.3. Утилиты для работы с конфигом  
- Функция получения значения по строке из Bitrix24.  
- Функция получения значения по умолчанию (пустое/неидентифицированное).  
- Функция получения всех значений.  
- Валидация входного значения.

1.4. Интеграция с существующими константами  
- Проверить зависимость от `constants.js`.  
- Определить стратегию миграции (постепенная/полная).  
- Сохранить обратную совместимость при необходимости.

**Результат этапа 1:**  
- Создан `service-config.js` с полной конфигурацией.  
- Определены утилиты работы со значением "В работе".  
- Документирована структура конфига.

---

### Этап 2: Обновление маппера тикетов для работы с UF_SLA_SERVICE_STR

**Цель этапа:** Извлекать значение "В работе" из `UF_SLA_SERVICE_STR`, маппить через новый конфиг и сохранять обратную совместимость.

#### Подзадачи этапа 2:
2.1. Анализ текущего маппера  
- Изучить логику получения значения "В работе" в `ticket-mapper.js`.  
- Найти точки использования старых полей (если есть).

2.2. Извлечение значения из тикета  
- Добавить извлечение `UF_SLA_SERVICE_STR` (учесть варианты регистра/форматов, camelCase).  
- Добавить fallback на старое поле (если использовалось ранее).

2.3. Интеграция с конфигом  
- Импортировать `service-config.js` в маппер.  
- Использовать утилиту получения значения по строке Bitrix24.  
- Обработать неидентифицированные значения (fallback).

2.4. Обновление обратного маппинга  
- Обновить функцию отправки значения обратно в Bitrix24 (текстовые значения).  
- Убедиться в корректной передаче `UF_SLA_SERVICE_STR` при обновлениях.

**Результат этапа 2:**  
- Маппер обновлён для `UF_SLA_SERVICE_STR`.  
- Значения корректно маппятся через конфиг.  
- Обратная совместимость сохранена.

---

### Этап 3: Обновление компонента TicketCard.vue

**Цель этапа:** Отображать плашку "В работе" в карточке тикета с использованием нового конфига.

#### Подзадачи этапа 3:
3.1. Анализ текущего отображения  
- Проверить шаблон `TicketCard.vue` (блок плашки "В работе").  
- Найти функции получения значения/лейбла.

3.2. Интеграция конфига  
- Импортировать конфиг и утилиты в компонент.  
- Обновить функцию получения лейбла/цветов из конфига.  
- Добавить функцию получения визуальных параметров.

3.3. Обновление шаблона  
- Отрисовывать плашку с динамическими стилями (фон/текст) из конфига.  
- Обрабатывать неидентифицированные/пустые значения через fallback.

3.4. Обновление стилей  
- Заменить статические классы на динамические стили или CSS-переменные.  
- Обеспечить читаемость для всех значений.

**Результат этапа 3:**  
- `TicketCard.vue` использует новый конфиг для плашки "В работе".  
- Цвета и лейблы соответствуют конфигу.  
- Fallback отображается корректно.

---

### Этап 4: Обработка пустых и неидентифицированных значений

**Цель этапа:** Реализовать устойчивый fallback для пустых/неизвестных `UF_SLA_SERVICE_STR`.

#### Подзадачи этапа 4:
4.1. Стратегия обработки  
- Определить поведение для пустого значения.  
- Определить поведение для значения, отсутствующего в конфиге.  
- Определить визуальное отображение (нейтральный цвет, текст "Не указано" или оригинал).

4.2. Реализация в конфиге  
- Добавить значение по умолчанию в `service-config.js` (последним в списке).  
- Настроить нейтральную палитру для fallback.

4.3. Обновление маппера  
- Проверять наличие значения в конфиге.  
- Подставлять fallback при отсутствии.  
- Логировать неидентифицированные случаи (для отладки).

4.4. Обновление компонента  
- Отображать корректный текст/цвет для fallback.  
- Добавить визуальную индикацию (например, иконка вопроса при необходимости).

**Результат этапа 4:**  
- Пустые/неизвестные значения обрабатываются через fallback.  
- Пользователь видит понятное отображение.

---

### Этап 5: Тестирование и интеграция

**Цель этапа:** Протестировать новую систему и распространить её на все компоненты, использующие плашку "В работе".

#### Подзадачи этапа 5:
5.1. Поиск использования  
- Найти все места, где отображается/используется `UF_SLA_SERVICE_STR`.  
- Составить перечень компонентов/утилит для обновления.

5.2. Обновление компонентов дашборда  
- Обновить связанные компоненты (канбан, списки, фильтры).  
- Обновить экспорт/импорт данных, если поле используется.

5.3. Тестирование  
- Проверить отображение всех значений из конфига.  
- Проверить пустые/неизвестные значения.  
- Проверить в разных браузерах/устройствах.  
- Оценить производительность (избыточные перерисовки).

5.4. Документирование  
- Обновить документацию по структуре значений "В работе".  
- Добавить примеры использования конфига.  
- Описать процесс добавления новых значений.

**Результат этапа 5:**  
- Все компоненты обновлены и используют новый конфиг.  
- Система протестирована, регрессий нет.  
- Документация актуализирована.

---

## Модули и компоненты

### Новые файлы:
- `vue-app/src/config/service-config.js` — конфигурационный файл значений "В работе".

### Файлы для изменения:
- `vue-app/src/services/dashboard-sector-1c/mappers/ticket-mapper.js` — маппер тикетов.
- `vue-app/src/components/dashboard/TicketCard.vue` — компонент карточки тикета.
- `vue-app/src/services/dashboard-sector-1c/utils/constants.js` — константы (при необходимости обратной совместимости).

### Файлы для проверки (возможные изменения):
- Все компоненты, где отображается `UF_SLA_SERVICE_STR`/плашка "В работе".  
- Сервисы/утилиты, работающие с этим полем.  
- Экспорт/импорт данных, если поле используется.

---

## Зависимости

### Внутренние:
- Использует структуру данных Bitrix24 `crm.item.list`.  
- Интегрируется с существующим маппером тикетов и компонентами дашборда.

### Внешние:
- Bitrix24 REST API для получения/обновления тикетов.  
- Поле `UF_SLA_SERVICE_STR` должно быть доступно в ответах API.

---

## API-методы Bitrix24

- `crm.item.list` — получение списка тикетов (с `UF_SLA_SERVICE_STR`).  
  - Документация: https://context7.com/bitrix24/rest/crm.item.list  
- `crm.item.update` — обновление тикета (запись `UF_SLA_SERVICE_STR`).  
  - Документация: https://context7.com/bitrix24/rest/crm.item.update

---

## Технические требования

### Структура конфига значения "В работе":
```javascript
{
  id: 'string',              // Уникальный идентификатор
  label: 'string',           // Отображаемое название
  bitrixValue: 'string',     // Значение в Bitrix24 (UF_SLA_SERVICE_STR)
  color: 'string',           // Цвет рамки/акцента
  backgroundColor: 'string', // Цвет фона плашки
  textColor: 'string',       // Цвет текста
  order: number,             // Порядок сортировки
  description: 'string'      // Описание (опционально)
}
```

### Устойчивые значения Bitrix24:
- 1С.Бухгалтерия  
- 1С.Талоны  
- 1С.ЗУП  
- 1С.Документооборот  
- 1С.Интеграции  

### Обработка неидентифицированных значений:
- Пустое значение → значение по умолчанию.  
- Значение отсутствует в конфиге → значение по умолчанию.  
- Визуальное отображение: нейтральный цвет (серый), текст "Не указано" или оригинальное значение (решить на этапе 4).

---

## Критерии приёмки

### Этап 1:
- [ ] Создан `service-config.js` с полной конфигурацией.  
- [ ] Все устойчивые значения добавлены.  
- [ ] Добавлен fallback по умолчанию.  
- [ ] Созданы утилиты для работы с конфигом.  
- [ ] Структура конфига задокументирована.

### Этап 2:
- [ ] Маппер обновлён для `UF_SLA_SERVICE_STR`.  
- [ ] Обработаны варианты именования поля.  
- [ ] Интегрирован конфиг и fallback.  
- [ ] Обратная совместимость сохранена.

### Этап 3:
- [ ] `TicketCard.vue` использует новый конфиг.  
- [ ] Цвета/лейблы соответствуют конфигу.  
- [ ] Fallback отображается корректно.

### Этап 4:
- [ ] Пустые/неизвестные значения используют fallback.  
- [ ] Визуальное отображение понятное пользователю.  
- [ ] Логирование неидентифицированных значений реализовано (при необходимости).

### Этап 5:
- [ ] Все компоненты обновлены.  
- [ ] Система протестирована, регрессий нет.  
- [ ] Документация обновлена.

---

## Тестирование

### Функциональное:
1. Отображение всех устойчивых значений в карточке тикета.  
2. Обработка пустого значения.  
3. Обработка неидентифицированного значения.  
4. Проверка корректности цветов/стилей.  
5. Проверка в разных браузерах.

### Интеграционное:
1. Загрузка `UF_SLA_SERVICE_STR` из Bitrix24 (`crm.item.list`).  
2. Маппинг значения через конфиг в маппере.  
3. Отображение в `TicketCard.vue`.  
4. Работа в канбан-сетке.

### Производительность:
1. Проверить отсутствие лишних перерисовок при смене значения.  
2. Оценить скорость загрузки конфига.  
3. Проверить использование памяти.

---

## История правок

- 2025-12-11 18:30 (UTC+3, Брест): Создана задача TASK-026 с планом реализации из 5 этапов.

---

## Следующие шаги

После этого плана будут созданы детальные документы по этапам:
- `TASK-026-01-service-config-creation.md` — Этап 1  
- `TASK-026-02-ticket-mapper-update.md` — Этап 2  
- `TASK-026-03-ticket-card-update.md` — Этап 3  
- `TASK-026-04-unidentified-service-handling.md` — Этап 4  
- `TASK-026-05-testing-and-integration.md` — Этап 5


