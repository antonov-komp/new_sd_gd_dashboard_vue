# TASK-025: Система конфигурации приоритетов на основе UF_CRM_7_UF_PRIORITY

**Дата создания:** 2025-12-11 18:00 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Родительская задача:** Нет

## Описание

Реализация системы конфигурации приоритетов для тикетов на основе пользовательского поля Bitrix24 `UF_CRM_7_UF_PRIORITY`. Создание конфигурационного файла с определением всех возможных приоритетов, их визуального отображения (цвета) и обработки неидентифицированных значений.

## Контекст

В системе дашборда сектора 1С используется канбан-сетка с тикетами. В карточках тикетов отображается "ЧИП" приоритета. Приоритет хранится в пользовательском поле Bitrix24 `UF_CRM_7_UF_PRIORITY` как текстовое значение. Необходимо создать централизованную систему конфигурации приоритетов для единообразного отображения во всех компонентах приложения.

## Текущее состояние

- Приоритеты отображаются в компоненте `TicketCard.vue` как "high", "medium", "low"
- Маппинг приоритетов находится в `constants.js` (числовые значения 1, 2, 3)
- Реальное поле приоритета: `UF_CRM_7_UF_PRIORITY` (текстовое поле)
- Значения приоритетов в Bitrix24:
  - Генеральский
  - Внешние обстоятельства
  - Задачи правления и совета директоров
  - Ошибки/сбои
  - Текущая деятельность
  - Проекты
  - Оптимизация

## Цель задачи

1. Создать конфигурационный файл приоритетов с визуальным отображением
2. Обновить маппер тикетов для работы с `UF_CRM_7_UF_PRIORITY`
3. Обновить компонент `TicketCard.vue` для использования нового конфига
4. Добавить обработку неидентифицированных/пустых приоритетов
5. Обеспечить единообразное отображение приоритетов во всех компонентах

---

## План реализации (5 этапов)

### Этап 1: Создание конфигурационного файла приоритетов

**Цель этапа:** Создать централизованный конфигурационный файл с определением всех приоритетов, их визуального отображения и утилит для работы с ними.

#### Подзадачи этапа 1:

1.1. Создание файла конфигурации приоритетов
- Создать файл `vue-app/src/config/priority-config.js`
- Определить структуру конфигурации приоритетов
- Добавить все известные приоритеты из Bitrix24
- Определить визуальные параметры (цвета, стили)

1.2. Определение структуры данных приоритета
- Структура объекта приоритета (id, label, color, backgroundColor, textColor, order)
- Определение позиции для неидентифицированного приоритета
- Добавление метаданных (описание, иконка при необходимости)

1.3. Создание утилит для работы с приоритетами
- Функция получения приоритета по значению из Bitrix24
- Функция получения приоритета по умолчанию (для пустых/неидентифицированных)
- Функция получения всех приоритетов
- Функция валидации значения приоритета

1.4. Интеграция с существующими константами
- Проверка зависимостей от `constants.js`
- Определение стратегии миграции (постепенная или полная замена)
- Сохранение обратной совместимости (если требуется)

**Результат этапа 1:**
- Создан файл `priority-config.js` с полной конфигурацией приоритетов
- Определены все утилиты для работы с приоритетами
- Документирована структура конфигурации

---

### Этап 2: Обновление маппера тикетов для работы с UF_CRM_7_UF_PRIORITY

**Цель этапа:** Обновить маппер тикетов для извлечения приоритета из пользовательского поля `UF_CRM_7_UF_PRIORITY` и использования нового конфига приоритетов.

#### Подзадачи этапа 2:

2.1. Анализ текущего маппера приоритетов
- Изучить функцию `mapPriority()` в `ticket-mapper.js`
- Определить места для изменений
- Проверить использование приоритетов в других частях кода

2.2. Обновление функции извлечения приоритета
- Добавить извлечение `UF_CRM_7_UF_PRIORITY` из объекта тикета
- Обработать все варианты именования поля (верхний/нижний регистр, camelCase)
- Добавить fallback на старое поле `priority` (для обратной совместимости)

2.3. Интеграция с конфигом приоритетов
- Импортировать конфиг приоритетов в маппер
- Использовать функцию получения приоритета из конфига
- Обработать случай неидентифицированного приоритета

2.4. Обновление функции обратного маппинга
- Обновить `mapPriorityToBitrix()` для работы с текстовыми значениями
- Обеспечить корректную отправку приоритета обратно в Bitrix24

**Результат этапа 2:**
- Маппер тикетов обновлён для работы с `UF_CRM_7_UF_PRIORITY`
- Приоритеты корректно извлекаются и маппятся через конфиг
- Обратная совместимость сохранена (если требуется)

---

### Этап 3: Обновление компонента TicketCard.vue

**Цель этапа:** Обновить компонент карточки тикета для использования нового конфига приоритетов и корректного отображения визуальных параметров.

#### Подзадачи этапа 3:

3.1. Анализ текущей реализации отображения приоритета
- Изучить использование приоритета в шаблоне `TicketCard.vue`
- Определить места для изменений (классы, стили, текст)
- Проверить функцию `getPriorityLabel()`

3.2. Интеграция конфига приоритетов в компонент
- Импортировать конфиг и утилиты приоритетов
- Обновить функцию `getPriorityLabel()` для использования конфига
- Добавить функцию получения визуальных параметров приоритета

3.3. Обновление шаблона компонента
- Обновить отображение чипа приоритета с использованием данных из конфига
- Применить динамические стили (цвета фона, текста) из конфига
- Добавить обработку неидентифицированного приоритета

3.4. Обновление стилей компонента
- Заменить статические классы приоритетов на динамические
- Использовать CSS-переменные для цветов из конфига
- Обеспечить корректное отображение всех приоритетов

**Результат этапа 3:**
- Компонент `TicketCard.vue` использует новый конфиг приоритетов
- Приоритеты отображаются с корректными цветами из конфига
- Неидентифицированные приоритеты обрабатываются корректно

---

### Этап 4: Обработка неидентифицированных и пустых приоритетов

**Цель этапа:** Реализовать корректную обработку случаев, когда приоритет отсутствует, пуст или не идентифицирован в конфиге.

#### Подзадачи этапа 4:

4.1. Определение стратегии обработки неидентифицированных приоритетов
- Определить поведение для пустого значения
- Определить поведение для значения, отсутствующего в конфиге
- Определить визуальное отображение (цвет, текст, иконка)

4.2. Реализация fallback-логики в конфиге
- Добавить приоритет по умолчанию в конфиг
- Определить порядок приоритета по умолчанию (последний в списке)
- Настроить визуальные параметры (нейтральный цвет)

4.3. Обновление маппера для обработки неидентифицированных значений
- Добавить проверку наличия приоритета в конфиге
- Использовать приоритет по умолчанию при отсутствии значения
- Логировать неидентифицированные приоритеты (для отладки)

4.4. Обновление компонента для отображения неидентифицированных приоритетов
- Отображать корректный текст и цвет для неидентифицированного приоритета
- Добавить визуальную индикацию (например, иконку вопроса)
- Обеспечить читаемость и понятность для пользователя

**Результат этапа 4:**
- Неидентифицированные и пустые приоритеты обрабатываются корректно
- Определён приоритет по умолчанию с визуальным отображением
- Пользователь видит понятное отображение для всех случаев

---

### Этап 5: Тестирование и интеграция во все компоненты

**Цель этапа:** Протестировать систему приоритетов, обновить все компоненты, использующие приоритеты, и обеспечить единообразное отображение.

#### Подзадачи этапа 5:

5.1. Поиск всех мест использования приоритетов
- Найти все компоненты, использующие приоритеты
- Проверить сервисы и утилиты, работающие с приоритетами
- Составить список компонентов для обновления

5.2. Обновление компонентов дашборда
- Обновить компоненты, отображающие приоритеты (если есть)
- Обновить фильтры и сортировки по приоритетам
- Обновить экспорт данных (если приоритеты экспортируются)

5.3. Тестирование функциональности
- Проверить отображение всех приоритетов из конфига
- Проверить обработку неидентифицированных приоритетов
- Проверить работу в разных браузерах и устройствах
- Проверить производительность (нет ли лишних перерисовок)

5.4. Документирование изменений
- Обновить документацию по структуре приоритетов
- Добавить примеры использования конфига
- Задокументировать процесс добавления новых приоритетов

**Результат этапа 5:**
- Все компоненты обновлены и используют новый конфиг
- Система приоритетов протестирована и работает корректно
- Документация обновлена

---

## Модули и компоненты

### Новые файлы:
- `vue-app/src/config/priority-config.js` — конфигурационный файл приоритетов

### Файлы для изменения:
- `vue-app/src/services/dashboard-sector-1c/mappers/ticket-mapper.js` — маппер тикетов
- `vue-app/src/components/dashboard/TicketCard.vue` — компонент карточки тикета
- `vue-app/src/services/dashboard-sector-1c/utils/constants.js` — константы (возможно, для обратной совместимости)

### Файлы для проверки (возможные изменения):
- Все компоненты, использующие приоритеты
- Сервисы, работающие с приоритетами
- Утилиты для экспорта/импорта данных

---

## Зависимости

### Внутренние зависимости:
- Использует структуру данных из Bitrix24 API (`crm.item.list`)
- Интегрируется с существующим маппером тикетов
- Используется в компонентах дашборда

### Внешние зависимости:
- Bitrix24 REST API для получения данных тикетов
- Поле `UF_CRM_7_UF_PRIORITY` должно быть доступно в ответе API

---

## API-методы Bitrix24

- `crm.item.list` — получение списка тикетов (должно включать `UF_CRM_7_UF_PRIORITY`)
  - Документация: https://context7.com/bitrix24/rest/crm.item.list
- `crm.item.update` — обновление тикета (при изменении приоритета)
  - Документация: https://context7.com/bitrix24/rest/crm.item.update

---

## Технические требования

### Структура конфига приоритетов:
```javascript
{
  id: 'string',              // Уникальный идентификатор
  label: 'string',           // Отображаемое название
  bitrixValue: 'string',     // Значение в Bitrix24
  color: 'string',           // Цвет для визуального отображения
  backgroundColor: 'string', // Цвет фона чипа
  textColor: 'string',       // Цвет текста чипа
  order: number,             // Порядок сортировки
  description: 'string'      // Описание (опционально)
}
```

### Значения приоритетов в Bitrix24:
- Генеральский
- Внешние обстоятельства
- Задачи правления и совета директоров
- Ошибки/сбои
- Текущая деятельность
- Проекты
- Оптимизация

### Обработка неидентифицированных приоритетов:
- Пустое значение → приоритет по умолчанию
- Значение, отсутствующее в конфиге → приоритет по умолчанию
- Визуальное отображение: нейтральный цвет (серый), текст "Не указано" или оригинальное значение

---

## Критерии приёмки

### Этап 1:
- [ ] Создан файл `priority-config.js` с полной конфигурацией
- [ ] Определены все 7 приоритетов из Bitrix24
- [ ] Добавлен приоритет по умолчанию для неидентифицированных значений
- [ ] Созданы утилиты для работы с приоритетами
- [ ] Документирована структура конфига

### Этап 2:
- [ ] Маппер обновлён для работы с `UF_CRM_7_UF_PRIORITY`
- [ ] Обработаны все варианты именования поля
- [ ] Интегрирован конфиг приоритетов
- [ ] Обратная совместимость сохранена (если требуется)

### Этап 3:
- [ ] Компонент `TicketCard.vue` использует новый конфиг
- [ ] Приоритеты отображаются с корректными цветами
- [ ] Неидентифицированные приоритеты обрабатываются

### Этап 4:
- [ ] Пустые приоритеты обрабатываются корректно
- [ ] Неидентифицированные приоритеты используют приоритет по умолчанию
- [ ] Визуальное отображение понятно для пользователя

### Этап 5:
- [ ] Все компоненты обновлены
- [ ] Система протестирована
- [ ] Документация обновлена
- [ ] Нет регрессий в существующем функционале

---

## Тестирование

### Функциональное тестирование:
1. Проверить отображение всех приоритетов из конфига в карточке тикета
2. Проверить обработку пустого приоритета
3. Проверить обработку неидентифицированного приоритета
4. Проверить корректность цветов и стилей
5. Проверить работу в разных браузерах

### Интеграционное тестирование:
1. Проверить загрузку данных из Bitrix24 API
2. Проверить маппинг приоритетов в маппере
3. Проверить отображение в компоненте `TicketCard.vue`
4. Проверить работу в канбан-сетке

### Тестирование производительности:
1. Проверить, нет ли лишних перерисовок при изменении приоритетов
2. Проверить скорость загрузки конфига
3. Проверить использование памяти

---

## История правок

- 2025-12-11 18:00 (UTC+3, Брест): Создана задача TASK-025 с планом реализации из 5 этапов

---

## Следующие шаги

После создания этого плана будут созданы детальные документы для каждого этапа:
- `TASK-025-01-priority-config-creation.md` — Этап 1
- `TASK-025-02-ticket-mapper-update.md` — Этап 2
- `TASK-025-03-ticket-card-update.md` — Этап 3
- `TASK-025-04-unidentified-priority-handling.md` — Этап 4
- `TASK-025-05-testing-and-integration.md` — Этап 5

