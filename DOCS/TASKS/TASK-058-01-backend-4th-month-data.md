# TASK-058-01: Backend ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-18 08:31 (UTC+3, –ë—Ä–µ—Å—Ç)  
**–°—Ç–∞—Ç—É—Å:** üìù –ß–µ—Ä–Ω–æ–≤–∏–∫  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** Bitrix24 –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç (Backend Developer)  
**–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞:** [TASK-058: –£–ª—É—á—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è "–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–µ–º–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–π —Å–µ–∫—Ç–æ—Ä–∞ 1–°" ‚Äî —Ä–µ–∂–∏–º 3 –º–µ—Å—è—Ü–∞](./TASK-058-enrichment-3-months-mode.md)  
**–≠—Ç–∞–ø:** 1 –∏–∑ 5

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å Backend API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞ 4-–π –º–µ—Å—è—Ü (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥) –≤ —Ä–µ–∂–∏–º–µ 3 –º–µ—Å—è—Ü–∞. –î–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤ —á–∏–ø–∞—Ö –∏ –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.

---

## üéØ –ö–æ–Ω—Ç–µ–∫—Å—Ç

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–§–∞–π–ª:** `api/graph-1c-admission-closure.php`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
- –§—É–Ω–∫—Ü–∏—è `calculateLastThreeMonths()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 3 –º–µ—Å—è—Ü–∞ (—Ç–µ–∫—É—â–∏–π + 2 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö)
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∑–∞ —ç—Ç–∏ 3 –º–µ—Å—è—Ü–∞
- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "success": true,
  "data": {
    "newTickets": 150,
    "newTicketsByMonth": [
      {
        "month": 10,
        "monthName": "–û–∫—Ç—è–±—Ä—å",
        "count": 50
      },
      {
        "month": 11,
        "monthName": "–ù–æ—è–±—Ä—å",
        "count": 60
      },
      {
        "month": 12,
        "monthName": "–î–µ–∫–∞–±—Ä—å",
        "count": 40
      }
    ],
    "closedTickets": 240,
    "closedTicketsByMonth": [...],
    "carryoverTickets": 90,
    "carryoverTicketsByMonth": [...]
  }
}
```

### –¢—Ä–µ–±—É–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
- –ü–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ 4 –º–µ—Å—è—Ü–∞ (3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è + 1 –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤)
- –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—Ç–≤–µ—Ç API –ø–æ–ª–µ `previousPeriodData` —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ 4-–≥–æ –º–µ—Å—è—Ü–∞
- –î–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–ª–∏—è—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Å—Å–∏–≤—ã `*ByMonth`

**–ü—Ä–∏–º–µ—Ä –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "success": true,
  "data": {
    "newTickets": 150,
    "newTicketsByMonth": [...], // 3 –º–µ—Å—è—Ü–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    "closedTickets": 240,
    "closedTicketsByMonth": [...], // 3 –º–µ—Å—è—Ü–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    "carryoverTickets": 90,
    "carryoverTicketsByMonth": [...], // 3 –º–µ—Å—è—Ü–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    "previousPeriodData": {
      "newTickets": 133,        // 4-–π –º–µ—Å—è—Ü (—Å–µ–Ω—Ç—è–±—Ä—å)
      "closedTickets": 200,     // 4-–π –º–µ—Å—è—Ü
      "carryoverTickets": 75    // 4-–π –º–µ—Å—è—Ü
    }
  }
}
```

---

## üîç –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

### 1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Å—è—Ü–µ–≤

**–§–∞–π–ª:** `api/graph-1c-admission-closure.php`  
**–§—É–Ω–∫—Ü–∏—è:** `calculateLastThreeMonths()` (—Å—Ç—Ä–æ–∫–∞ 106)

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é `calculateLastFourMonths()` –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
2. –§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ 4 –º–µ—Å—è—Ü–∞ (–æ—Ç 3-–≥–æ –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `calculateLastThreeMonths()` –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å

**–í–∞—Ä–∏–∞–Ω—Ç 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```php
/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –º–µ—Å—è—Ü–∞ –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
 * TASK-058-01: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞ 4-–º–µ—Å—è—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è + 1 –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤)
 * 
 * @return array –ú–∞—Å—Å–∏–≤ –º–µ—Å—è—Ü–µ–≤ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ –Ω–µ–¥–µ–ª—è–º–∏ (4 –º–µ—Å—è—Ü–∞)
 * @throws Exception –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
 */
function calculateLastFourMonths(): array
{
    try {
        $tz = new DateTimeZone('UTC');
        $now = new DateTimeImmutable('now', $tz);
        $months = [];
        
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        $currentMonth = $now->modify('first day of this month');
        // 3 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥ (–Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞)
        $threeMonthsAgo = $currentMonth->modify('-3 months');
        
        $monthNames = [
            1 => '–Ø–Ω–≤–∞—Ä—å', 2 => '–§–µ–≤—Ä–∞–ª—å', 3 => '–ú–∞—Ä—Ç', 4 => '–ê–ø—Ä–µ–ª—å',
            5 => '–ú–∞–π', 6 => '–ò—é–Ω—å', 7 => '–ò—é–ª—å', 8 => '–ê–≤–≥—É—Å—Ç',
            9 => '–°–µ–Ω—Ç—è–±—Ä—å', 10 => '–û–∫—Ç—è–±—Ä—å', 11 => '–ù–æ—è–±—Ä—å', 12 => '–î–µ–∫–∞–±—Ä—å'
        ];
        
        for ($i = 0; $i < 4; $i++) {
            $monthStart = $threeMonthsAgo->modify("+{$i} months");
            $monthEnd = $monthStart->modify('last day of this month')->setTime(23, 59, 59);
            
            $months[] = [
                'monthNumber' => (int)$monthStart->format('n'),
                'monthName' => $monthNames[(int)$monthStart->format('n')],
                'year' => (int)$monthStart->format('Y'),
                'monthStartUtc' => $monthStart->setTime(0, 0, 0)->format('Y-m-d\TH:i:s\Z'),
                'monthEndUtc' => $monthEnd->format('Y-m-d\TH:i:s\Z'),
                'monthStart' => $monthStart->setTime(0, 0, 0),
                'monthEnd' => $monthEnd,
                'weeks' => calculateWeeksInMonth($monthStart->setTime(0, 0, 0), $monthEnd)
            ];
        }
        
        return $months;
    } catch (Exception $e) {
        error_log('[calculateLastFourMonths] Error: ' . $e->getMessage());
        throw new Exception('Failed to calculate last four months: ' . $e->getMessage());
    }
}
```

### 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∂–∏–º–∞ –º–µ—Å—è—Ü–µ–≤

**–§–∞–π–ª:** `api/graph-1c-admission-closure.php`  
**–°—Ç—Ä–æ–∫–∞:** ~510 (–æ–±—Ä–∞–±–æ—Ç–∫–∞ `periodMode === 'months'`)

**–ó–∞–¥–∞—á–∏:**
1. –í—ã–∑–≤–∞—Ç—å `calculateLastFourMonths()` –≤–º–µ—Å—Ç–æ `calculateLastThreeMonths()`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 4-–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ `previousPeriodData`
4. –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è 4-–≥–æ –º–µ—Å—è—Ü–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**
```php
// TASK-053-03: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–∏–æ–¥–∞
if ($periodMode === 'months') {
    // TASK-058-01: –ü–æ–ª—É—á–∞–µ–º 4 –º–µ—Å—è—Ü–∞ (3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è + 1 –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤)
    $allMonths = calculateLastFourMonths();
    
    // –ü–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $months = array_slice($allMonths, 0, 3);
    
    // 4-–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    $previousMonth = $allMonths[3] ?? null;
    
    // –ü–µ—Ä–∏–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 (–≤–∫–ª—é—á–∞—è 4-–π –º–µ—Å—è—Ü)
    $periodStartUtc = $allMonths[0]['monthStartUtc']; // –°–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º–µ—Å—è—Ü (4-–π)
    $periodEndUtc = $months[2]['monthEndUtc']; // –ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –∏–∑ 3-—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    $periodStart = new DateTimeImmutable($periodStartUtc, new DateTimeZone('UTC'));
    $periodEnd = new DateTimeImmutable($periodEndUtc, new DateTimeZone('UTC'));
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
}
```

### 3. –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞

**–§–∞–π–ª:** `api/graph-1c-admission-closure.php`  
**–°—Ç—Ä–æ–∫–∞:** ~891 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞, –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 905)

**–ó–∞–¥–∞—á–∏:**
1. –ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞ (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891), —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ 4-–π –º–µ—Å—è—Ü
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ª–æ–≥–∏–∫—É –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:
   - `isInRange()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –¥–∞—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω
   - `isCarryoverTicket()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—è—â–µ–≥–æ —Ç–∏–∫–µ—Ç–∞
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `product=1C` (—É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –º–∞—Å—Å–∏–≤—É `$tickets`)
3. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞:
   - `newTickets` ‚Äî –Ω–æ–≤—ã–µ —Ç–∏–∫–µ—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤ 4-–º –º–µ—Å—è—Ü–µ
   - `closedTickets` ‚Äî –∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã, –∑–∞–∫—Ä—ã—Ç—ã–µ –≤ 4-–º –º–µ—Å—è—Ü–µ
   - `carryoverTickets` ‚Äî –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
4. –î–æ–±–∞–≤–∏—Ç—å `previousPeriodData` –≤ –æ—Ç–≤–µ—Ç API

**–í–∞–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ `$tickets` (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ product=1C –Ω–∞ —Å—Ç—Ä–æ–∫–µ 720), –∞ –Ω–µ `$allTicketsMap`.

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞:**
```php
// –ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞ (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891, –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 905)

// TASK-058-01: –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
$previousPeriodData = [
    'newTickets' => 0,
    'closedTickets' => 0,
    'carryoverTickets' => 0
];

if ($previousMonth) {
    $previousMonthStart = $previousMonth['monthStart'];
    $previousMonthEnd = $previousMonth['monthEnd'];
    
    error_log("[MONTHS] Calculating previous period data for month: {$previousMonth['monthName']} {$previousMonth['year']}");
    
    // –ü–æ–¥—Å—á–µ—Ç –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ 4-–≥–æ –º–µ—Å—è—Ü–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 788-793)
    foreach ($tickets as $ticket) {
        $createdTime = $ticket['createdTime'] ?? null;
        if (isInRange($createdTime, $previousMonthStart, $previousMonthEnd)) {
            $previousPeriodData['newTickets']++;
        }
    }
    
    // –ü–æ–¥—Å—á–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ 4-–≥–æ –º–µ—Å—è—Ü–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 796-815)
    foreach ($tickets as $ticket) {
        $movedTime = $ticket['movedTime'] ?? $ticket['updatedTime'] ?? null;
        $stageId = $ticket['stageId'] ?? null;
        $stageId = $stageId ? strtoupper($stageId) : null;
        
        if ($stageId && in_array($stageId, $closingStages, true)) {
            if (isInRange($movedTime, $previousMonthStart, $previousMonthEnd)) {
                $previousPeriodData['closedTickets']++;
            }
        }
    }
    
    // –ü–æ–¥—Å—á–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
    // –ü–µ—Ä–µ—Ö–æ–¥—è—â–∏–µ = —Ç–∏–∫–µ—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ –Ω–∞—á–∞–ª–∞ 4-–≥–æ –º–µ—Å—è—Ü–∞, –Ω–æ –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Ä–∞–±–æ—á–∏—Ö —Å—Ç–∞–¥–∏—è—Ö –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 818-831)
    foreach ($tickets as $ticket) {
        if (isCarryoverTicket($ticket, $previousMonthStart, $previousMonthStart, $targetStages, $closingStages)) {
            $previousPeriodData['carryoverTickets']++;
        }
    }
    
    error_log("[MONTHS] Previous period data (4th month): " . json_encode($previousPeriodData));
} else {
    error_log("[MONTHS] Warning: Previous month (4th) not found, previousPeriodData will be empty");
}
```

**–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π:**
   - `isInRange($date, $start, $end)` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –¥–∞—Ç–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω
   - `isCarryoverTicket($ticket, $periodStart, $periodEnd, $targetStages, $closingStages)` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–∏–∫–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏–º
   - –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ product=1C:**
   - –ú–∞—Å—Å–∏–≤ `$tickets` —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –ø–æ product=1C (—Å—Ç—Ä–æ–∫–∞ 720)
   - –ù–µ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `UF_CRM_7_TYPE_PRODUCT`

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `isInRange()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç (—Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç null –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã DateTimeImmutable, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è `isInRange()` —É–∂–µ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ 4-–π –º–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ previousPeriodData –≤ –æ—Ç–≤–µ—Ç

**–§–∞–π–ª:** `api/graph-1c-admission-closure.php`  
**–°—Ç—Ä–æ–∫–∞:** ~905-938 (—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ months)

**–ó–∞–¥–∞—á–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `previousPeriodData` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ (–≤ –º–∞—Å—Å–∏–≤ `data`)
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ `months`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–Ω–µ –ª–æ–º–∞—Ç—å —Ä–µ–∂–∏–º `weeks`)
4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ `previousPeriodData` –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω

**–¢–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –≤—Å—Ç–∞–≤–∫–∏:**
- –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ `$totalCarryoverTickets`)
- –ü–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 905 (–ø–µ—Ä–µ–¥ `jsonResponse`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**
```php
// –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞)

// TASK-058-01: –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
$previousPeriodData = [
    'newTickets' => 0,
    'closedTickets' => 0,
    'carryoverTickets' => 0
];

if ($previousMonth) {
    // ... —Ä–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö (—Å–º. —Ä–∞–∑–¥–µ–ª 3) ...
}

// –í –±–ª–æ–∫–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ months (—Å—Ç—Ä–æ–∫–∞ ~905)
jsonResponse([
    'success' => true,
    'meta' => [
        'periodMode' => 'months',
        'periodStartUtc' => $periodStartUtc,
        'periodEndUtc' => $periodEndUtc,
        'months' => array_map(function($month) {
            return [
                'monthNumber' => $month['monthNumber'],
                'monthName' => $month['monthName'],
                'year' => $month['year'],
                'monthStartUtc' => $month['monthStartUtc'],
                'monthEndUtc' => $month['monthEndUtc'],
                'weeks' => array_map(function($week) {
                    return [
                        'weekNumber' => $week['weekNumber'],
                        'weekStartUtc' => $week['weekStartUtc'],
                        'weekEndUtc' => $week['weekEndUtc']
                    ];
                }, $month['weeks'])
            ];
        }, $months)
    ],
    'data' => [
        'newTickets' => $totalNewTickets,
        'newTicketsByMonth' => $newTicketsByMonth,
        'closedTickets' => $totalClosedTickets,
        'closedTicketsByMonth' => $closedTicketsByMonth,
        'carryoverTickets' => $totalCarryoverTickets,
        'carryoverTicketsByMonth' => $carryoverTicketsByMonth,
        'stages' => $stages,
        'responsible' => [], // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        // TASK-058-01: –î–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        'previousPeriodData' => $previousPeriodData
    ]
]);
```

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `previousPeriodData`:**
   - –í—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º (–Ω–µ null), –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã
   - –ï—Å–ª–∏ —Ä–∞—Å—á–µ—Ç –Ω–µ —É–¥–∞–ª—Å—è, –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç 0
   - Frontend –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 0 –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
   - –ü–æ–ª–µ `previousPeriodData` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ `months`
   - –í —Ä–µ–∂–∏–º–µ `weeks` —ç—Ç–æ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –æ—Ç–≤–µ—Ç)
   - Frontend –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `$previousMonth` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `$tickets` –Ω–µ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ `isInRange()` –∏ `isCarryoverTicket()` –¥–æ—Å—Ç—É–ø–Ω—ã

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ó–∞–ø—Ä–æ—Å—ã –∫ Bitrix24 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ 4-–π –º–µ—Å—è—Ü –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω ‚Üí `previousPeriodData` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ —Ä–∞—Å—á–µ—Ç 4-–≥–æ –º–µ—Å—è—Ü–∞ –Ω–µ —É–¥–∞–ª—Å—è
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ `error_log`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–∞—Ç–∞–º–∏

**–î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
```php
// TASK-058-01: –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
$previousPeriodData = [
    'newTickets' => 0,
    'closedTickets' => 0,
    'carryoverTickets' => 0
];

try {
    if ($previousMonth) {
        $previousMonthStart = $previousMonth['monthStart'];
        $previousMonthEnd = $previousMonth['monthEnd'];
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞—Ç
        if (!($previousMonthStart instanceof DateTimeImmutable) || 
            !($previousMonthEnd instanceof DateTimeImmutable)) {
            throw new Exception('Invalid date objects for previous month');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–∞—Å—Å–∏–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤
        if (!is_array($tickets) || empty($tickets)) {
            error_log("[MONTHS] Warning: Tickets array is empty, cannot calculate previous period data");
        } else {
            // ... —Ä–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö ...
        }
    } else {
        error_log("[MONTHS] Warning: Previous month (4th) not found, previousPeriodData will be empty");
    }
} catch (Exception $e) {
    error_log("[MONTHS] Error calculating previous period data: " . $e->getMessage());
    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    $previousPeriodData = [
        'newTickets' => 0,
        'closedTickets' => 0,
        'carryoverTickets' => 0
    ];
}
```

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –†–µ–∂–∏–º `weeks` –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã API –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü–æ–ª–µ `previousPeriodData` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `calculateLastFourMonths()` –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è
- [ ] API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 4 –º–µ—Å—è—Ü–∞ –≤ —Ä–µ–∂–∏–º–µ `months`
- [ ] –ü–æ–ª–µ `previousPeriodData` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç API
- [ ] –î–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
  - [ ] `newTickets` ‚Äî –Ω–æ–≤—ã–µ —Ç–∏–∫–µ—Ç—ã 4-–≥–æ –º–µ—Å—è—Ü–∞
  - [ ] `closedTickets` ‚Äî –∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã 4-–≥–æ –º–µ—Å—è—Ü–∞
  - [ ] `carryoverTickets` ‚Äî –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Å—Å–∏–≤—ã `*ByMonth` —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ 3 –º–µ—Å—è—Ü–∞ (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
- [ ] –†–µ–∂–∏–º `weeks` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ 4-–≥–æ –º–µ—Å—è—Ü–∞
- [ ] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

---

## üìö –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä 1: –§—É–Ω–∫—Ü–∏—è calculateLastFourMonths()

```php
/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –º–µ—Å—è—Ü–∞ –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
 * TASK-058-01: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞ 4-–º–µ—Å—è—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
 * 
 * @return array –ú–∞—Å—Å–∏–≤ –º–µ—Å—è—Ü–µ–≤ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ –Ω–µ–¥–µ–ª—è–º–∏ (4 –º–µ—Å—è—Ü–∞)
 * @throws Exception –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
 */
function calculateLastFourMonths(): array
{
    try {
        $tz = new DateTimeZone('UTC');
        $now = new DateTimeImmutable('now', $tz);
        $months = [];
        
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        $currentMonth = $now->modify('first day of this month');
        // 3 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥ (–Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞)
        $threeMonthsAgo = $currentMonth->modify('-3 months');
        
        $monthNames = [
            1 => '–Ø–Ω–≤–∞—Ä—å', 2 => '–§–µ–≤—Ä–∞–ª—å', 3 => '–ú–∞—Ä—Ç', 4 => '–ê–ø—Ä–µ–ª—å',
            5 => '–ú–∞–π', 6 => '–ò—é–Ω—å', 7 => '–ò—é–ª—å', 8 => '–ê–≤–≥—É—Å—Ç',
            9 => '–°–µ–Ω—Ç—è–±—Ä—å', 10 => '–û–∫—Ç—è–±—Ä—å', 11 => '–ù–æ—è–±—Ä—å', 12 => '–î–µ–∫–∞–±—Ä—å'
        ];
        
        for ($i = 0; $i < 4; $i++) {
            $monthStart = $threeMonthsAgo->modify("+{$i} months");
            $monthEnd = $monthStart->modify('last day of this month')->setTime(23, 59, 59);
            
            $months[] = [
                'monthNumber' => (int)$monthStart->format('n'),
                'monthName' => $monthNames[(int)$monthStart->format('n')],
                'year' => (int)$monthStart->format('Y'),
                'monthStartUtc' => $monthStart->setTime(0, 0, 0)->format('Y-m-d\TH:i:s\Z'),
                'monthEndUtc' => $monthEnd->format('Y-m-d\TH:i:s\Z'),
                'monthStart' => $monthStart->setTime(0, 0, 0),
                'monthEnd' => $monthEnd,
                'weeks' => calculateWeeksInMonth($monthStart->setTime(0, 0, 0), $monthEnd)
            ];
        }
        
        return $months;
    } catch (Exception $e) {
        error_log('[calculateLastFourMonths] Error: ' . $e->getMessage());
        throw new Exception('Failed to calculate last four months: ' . $e->getMessage());
    }
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç previousPeriodData —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

```php
// –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞)
// –ü–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 905 (–ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞)

// TASK-058-01: –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
$previousPeriodData = [
    'newTickets' => 0,
    'closedTickets' => 0,
    'carryoverTickets' => 0
];

try {
    if ($previousMonth && isset($previousMonth['monthStart']) && isset($previousMonth['monthEnd'])) {
        $previousMonthStart = $previousMonth['monthStart'];
        $previousMonthEnd = $previousMonth['monthEnd'];
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞—Ç
        if (!($previousMonthStart instanceof DateTimeImmutable) || 
            !($previousMonthEnd instanceof DateTimeImmutable)) {
            throw new Exception('Invalid date objects for previous month');
        }
        
        error_log("[MONTHS] Calculating previous period data for month: {$previousMonth['monthName']} {$previousMonth['year']}");
        error_log("[MONTHS] Previous month period: {$previousMonthStart->format('Y-m-d H:i:s')} to {$previousMonthEnd->format('Y-m-d H:i:s')}");
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–∞—Å—Å–∏–≤–∞ —Ç–∏–∫–µ—Ç–æ–≤
        if (!is_array($tickets)) {
            error_log("[MONTHS] Warning: Tickets is not an array");
        } elseif (empty($tickets)) {
            error_log("[MONTHS] Warning: Tickets array is empty, cannot calculate previous period data");
        } else {
            // –ü–æ–¥—Å—á–µ—Ç –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ 4-–≥–æ –º–µ—Å—è—Ü–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 788-793)
            foreach ($tickets as $ticket) {
                $createdTime = $ticket['createdTime'] ?? null;
                if (isInRange($createdTime, $previousMonthStart, $previousMonthEnd)) {
                    $previousPeriodData['newTickets']++;
                }
            }
            
            // –ü–æ–¥—Å—á–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ 4-–≥–æ –º–µ—Å—è—Ü–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 796-815)
            foreach ($tickets as $ticket) {
                $movedTime = $ticket['movedTime'] ?? $ticket['updatedTime'] ?? null;
                $stageId = $ticket['stageId'] ?? null;
                $stageId = $stageId ? strtoupper($stageId) : null;
                
                if ($stageId && in_array($stageId, $closingStages, true)) {
                    if (isInRange($movedTime, $previousMonthStart, $previousMonthEnd)) {
                        $previousPeriodData['closedTickets']++;
                    }
                }
            }
            
            // –ü–æ–¥—Å—á–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
            // –ü–µ—Ä–µ—Ö–æ–¥—è—â–∏–µ = —Ç–∏–∫–µ—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ –Ω–∞—á–∞–ª–∞ 4-–≥–æ –º–µ—Å—è—Ü–∞, –Ω–æ –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Ä–∞–±–æ—á–∏—Ö —Å—Ç–∞–¥–∏—è—Ö –Ω–∞ –Ω–∞—á–∞–ª–æ 4-–≥–æ –º–µ—Å—è—Ü–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è 3 –º–µ—Å—è—Ü–µ–≤ (—Å—Ç—Ä–æ–∫–∏ 818-831)
            foreach ($tickets as $ticket) {
                if (isCarryoverTicket($ticket, $previousMonthStart, $previousMonthStart, $targetStages, $closingStages)) {
                    $previousPeriodData['carryoverTickets']++;
                }
            }
            
            error_log("[MONTHS] Previous period data (4th month): " . json_encode($previousPeriodData));
        }
    } else {
        error_log("[MONTHS] Warning: Previous month (4th) not found or invalid, previousPeriodData will be empty");
    }
} catch (Exception $e) {
    error_log("[MONTHS] Error calculating previous period data: " . $e->getMessage());
    error_log("[MONTHS] Stack trace: " . $e->getTraceAsString());
    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    $previousPeriodData = [
        'newTickets' => 0,
        'closedTickets' => 0,
        'carryoverTickets' => 0
    ];
}

// –î–∞–ª–µ–µ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ ~905) –¥–æ–±–∞–≤–∏—Ç—å:
// 'previousPeriodData' => $previousPeriodData
```

**–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π:**
   - `isInRange($date, $start, $end)` ‚Äî —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç null –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç
   - `isCarryoverTicket($ticket, $periodStart, $periodEnd, $targetStages, $closingStages)` ‚Äî —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ
   - –ù–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã DateTimeImmutable –≤—Ä—É—á–Ω—É—é

2. **–ú–∞—Å—Å–∏–≤ `$tickets`:**
   - –£–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –ø–æ product=1C (—Å—Ç—Ä–æ–∫–∞ 720)
   - –ù–µ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `UF_CRM_7_TYPE_PRODUCT`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ `$tickets`, –∞ –Ω–µ `$allTicketsMap`

3. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞
   - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–æ–¥–∞

---

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **TASK-053-03:** Backend API –¥–ª—è 3-–º–µ—Å—è—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- **TASK-058:** –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫

- **2025-12-18 08:31 (UTC+3, –ë—Ä–µ—Å—Ç):** –°–æ–∑–¥–∞–Ω –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —ç—Ç–∞–ø–∞ 1
  - –û–ø–∏—Å–∞–Ω–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Å—è—Ü–µ–≤
  - –û–ø–∏—Å–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö 4-–≥–æ –º–µ—Å—è—Ü–∞
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

---

## ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–í–∞–∂–Ω–æ:** –î–∞–Ω–Ω—ã–µ 4-–≥–æ –º–µ—Å—è—Ü–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–ª–∏—è—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Å—Å–∏–≤—ã `*ByMonth`
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å API, –Ω–æ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞ 4 –º–µ—Å—è—Ü–∞

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ calculateLastFourMonths()

1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª `api/graph-1c-admission-closure.php`
2. –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é `calculateLastThreeMonths()` (—Å—Ç—Ä–æ–∫–∞ 106)
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é `calculateLastFourMonths()` –ø–æ—Å–ª–µ –Ω–µ—ë (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 145)
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ `calculateLastThreeMonths()`
5. –ò–∑–º–µ–Ω–∏—Ç—å —Ü–∏–∫–ª —Å `for ($i = 0; $i < 3; $i++)` –Ω–∞ `for ($i = 0; $i < 4; $i++)`
6. –ò–∑–º–µ–Ω–∏—Ç—å `$twoMonthsAgo` –Ω–∞ `$threeMonthsAgo`
7. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–º–æ—â—å—é `var_dump(calculateLastFourMonths())`

### –®–∞–≥ 2: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∂–∏–º–∞ months

1. –ù–∞–π—Ç–∏ –±–ª–æ–∫ `if ($periodMode === 'months')` (—Å—Ç—Ä–æ–∫–∞ ~510)
2. –ó–∞–º–µ–Ω–∏—Ç—å `$months = calculateLastThreeMonths();` –Ω–∞:
   ```php
   $allMonths = calculateLastFourMonths();
   $months = array_slice($allMonths, 0, 3);
   $previousMonth = $allMonths[3] ?? null;
   ```
3. –û–±–Ω–æ–≤–∏—Ç—å `$periodStartUtc` –∏ `$periodEndUtc` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è 4-–≥–æ –º–µ—Å—è—Ü–∞:
   ```php
   $periodStartUtc = $allMonths[0]['monthStartUtc']; // –°–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º–µ—Å—è—Ü (4-–π)
   $periodEndUtc = $months[2]['monthEndUtc']; // –ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –∏–∑ 3-—Ö
   ```
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∫ Bitrix24 –≤–∫–ª—é—á–∞—é—Ç 4-–π –º–µ—Å—è—Ü

### –®–∞–≥ 3: –†–∞—Å—á–µ—Ç previousPeriodData

1. –ù–∞–π—Ç–∏ –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 3 –º–µ—Å—è—Ü–∞ (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 891)
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ `previousPeriodData` (—Å–º. –ü—Ä–∏–º–µ—Ä 2)
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `isInRange()` –∏ `isCarryoverTicket()`
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ `$tickets` (–Ω–µ `$allTicketsMap`)
5. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å try-catch
6. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ previousPeriodData –≤ –æ—Ç–≤–µ—Ç

1. –ù–∞–π—Ç–∏ –±–ª–æ–∫ `jsonResponse([...])` –¥–ª—è —Ä–µ–∂–∏–º–∞ months (—Å—Ç—Ä–æ–∫–∞ ~905)
2. –î–æ–±–∞–≤–∏—Ç—å `'previousPeriodData' => $previousPeriodData` –≤ –º–∞—Å—Å–∏–≤ `data`
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ `months`
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç API

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API —Å `periodMode: 'months'`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –ø–æ–ª–µ `previousPeriodData`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `previousPeriodData` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∞—Å—Å–∏–≤—ã `*ByMonth` —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ 3 –º–µ—Å—è—Ü–∞
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Å—è—Ü–µ–≤

```php
// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
$allMonths = calculateLastFourMonths();
error_log("[MONTHS] All 4 months: " . json_encode(array_map(function($m) {
    return $m['monthName'] . ' ' . $m['year'];
}, $allMonths)));

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ:
// - –ü–µ—Ä–≤—ã–π –º–µ—Å—è—Ü (–∏–Ω–¥–µ–∫—Å 0) = 3 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
// - –ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü (–∏–Ω–¥–µ–∫—Å 3) = —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
// - –í—Å–µ–≥–æ 4 –º–µ—Å—è—Ü–∞
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

```php
// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
error_log("[MONTHS] Period for Bitrix24 queries:");
error_log("[MONTHS] Start: {$periodStartUtc} (4th month start)");
error_log("[MONTHS] End: {$periodEndUtc} (3rd month end)");
error_log("[MONTHS] Previous month: " . ($previousMonth ? $previousMonth['monthName'] . ' ' . $previousMonth['year'] : 'NOT FOUND'));
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ previousPeriodData

```php
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
if ($previousPeriodData['newTickets'] < 0 || 
    $previousPeriodData['closedTickets'] < 0 || 
    $previousPeriodData['carryoverTickets'] < 0) {
    error_log("[MONTHS] ERROR: Negative values in previousPeriodData!");
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –ª–æ–≥–∏—á–Ω—ã
if ($previousPeriodData['newTickets'] > 10000 || 
    $previousPeriodData['closedTickets'] > 10000) {
    error_log("[MONTHS] WARNING: Unusually high values in previousPeriodData!");
}
```

