# TASK-067-8: Обновление прокси в legacy файле

**Дата создания:** 2025-12-23 (UTC+3, Брест)  
**Статус:** Завершена  
**Приоритет:** Средний  
**Дата завершения:** 2025-12-23 (UTC+3, Брест)  
**Родитель:** TASK-067  
**Цель:** Обновить legacy файл для перенаправления месячного режима на новый модуль.

## Область
- Обновить прокси в `api/graph-1c-admission-closure.php`:
  - Добавить перенаправление для periodMode=months
  - Оба режима (weeks и months) должны перенаправляться на новый модуль
- Убедиться, что оба режима перенаправляются корректно
- Протестировать перенаправление

## Требования к реализации
- Файл: `api/graph-1c-admission-closure.php`
- Обновить код перенаправления:
  ```php
  if ($periodMode === 'weeks') {
      require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
      exit;
  }
  
  if ($periodMode === 'months') {
      require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
      exit;
  }
  ```
- Удалить код месячного режима из legacy (будет в этапе 67-9)

## Детальная структура прокси

### Текущий код (до обновления)
```php
// Строки 663-667
if ($periodMode === 'weeks') {
    require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
    exit; // bootstrap.php уже отправит ответ и завершит выполнение
}

// Строки 669-1693: код месячного режима (legacy)
if ($periodMode === 'months') {
    // ... весь код месячного режима ...
}
```

### Целевой код (после обновления)
```php
// Строки 663-667: weeks режим
if ($periodMode === 'weeks') {
    require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
    exit;
}

// НОВОЕ: months режим
if ($periodMode === 'months') {
    require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
    exit;
}

// Строки 669-1693: код месячного режима (legacy) - остаётся до этапа 67-9
```

## План выполнения
1) Прочитать текущий код прокси в legacy файле:
   - Строки 640-661: парсинг параметров и валидация
   - Строки 663-667: прокси для weeks режима
   - Строки 669-1693: код месячного режима (legacy)
2) Добавить перенаправление для months режима:
   - **Место вставки:** после строки 667 (после weeks прокси)
   - **Код:**
     ```php
     // TASK-067-8: Для месячного режима используем новый модуль
     if ($periodMode === 'months') {
         require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
         exit; // bootstrap.php уже отправит ответ и завершит выполнение
     }
     ```
   - **Важно:** код месячного режима (строки 669-1693) пока остаётся (будет удалён в этапе 67-9)
3) Проверить синтаксис PHP:
   ```bash
   php -l api/graph-1c-admission-closure.php
   ```
4) Протестировать перенаправление:
   - **Тест 1: weeks режим**
     - Запрос: `{"periodMode": "weeks", "product": "1C"}`
     - Ожидаемое: ответ из нового модуля
     - Проверить логи: запрос должен попасть в новый модуль
   - **Тест 2: months режим**
     - Запрос: `{"periodMode": "months", "product": "1C"}`
     - Ожидаемое: ответ из нового модуля (не из legacy кода)
     - Проверить логи: запрос должен попасть в новый модуль
   - **Тест 3: Сравнение ответов**
     - Запрос к новому модулю (через прокси)
     - Запрос к legacy коду (временно, до удаления)
     - Сравнить JSON ответы (должны быть идентичны)
5) Убедиться, что код месячного режима ещё не удалён:
   - Проверить наличие блока `if ($periodMode === 'months') { ... }` (строки 669-1693)
   - Этот код будет удалён в этапе 67-9 после успешного тестирования

## Артефакты
- Обновлённый `api/graph-1c-admission-closure.php`

## Критерии приёмки
- [x] Прокси обновлён (добавлено перенаправление для months)
- [x] Оба режима (weeks и months) перенаправляются на новый модуль
- [ ] Тесты перенаправления пройдены (требуется ручное тестирование):
  - weeks режим работает через новый модуль
  - months режим работает через новый модуль
- [ ] Ответы идентичны (новый модуль vs legacy до обновления)

## Результаты реализации (2025-12-23, UTC+3, Брест)

### ✅ Выполнено:

1. **Добавлено перенаправление для months режима** (строки 669-673)
   ```php
   // TASK-067-8: Для месячного режима используем новый модуль
   if ($periodMode === 'months') {
       require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
       exit; // bootstrap.php уже отправит ответ и завершит выполнение
   }
   ```

2. **Оба режима перенаправляются на новый модуль:**
   - weeks режим (строки 664-667)
   - months режим (строки 669-673)

3. **Legacy код месячного режима остаётся** (строки 675-1699)
   - Будет удалён в TASK-067-9 после успешного тестирования
   - Добавлен комментарий: "будет удалено в TASK-067-9"

4. **Синтаксис PHP корректен** (проверено: `php -l`)

### ⏳ Требуется:
- Ручное тестирование перенаправления (weeks и months режимы)
- Сравнение ответов нового модуля с legacy (до удаления legacy кода)

### Вывод:
**Прокси обновлён.** Оба режима (weeks и months) теперь перенаправляются на новый модуль. Legacy код месячного режима остаётся до этапа 67-9.

## Риски и заметки
- Важно, чтобы оба режима работали через новый модуль после обновления прокси
- Код месячного режима в legacy пока остаётся (будет удалён в этапе 67-9)
- Обратная совместимость должна быть сохранена (путь API не меняется)

