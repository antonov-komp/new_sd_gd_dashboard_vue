# TASK-038-03: UI/UX попапа 1-го уровня — переключение между стадиями (Vue)

**Дата создания:** 2025-12-15 12:20 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Связь:** Этап 3 эпика TASK-038 (`TASK-038-popup-stage-switching.md`)  
**Модуль:** График состояния сектора 1С (`EmployeeDetailsModal.vue`)  

## Цель
Добавить интерактивный UI для выбора стадий внутри попапа 1-го уровня: при клике на название текущей стадии открывать список оставшихся стадий (всего три), позволять выбрать другую стадию, показывать лоадер и обновлять данные уровня 1 без закрытия модального окна.

## Требования к UI/UX
- Заголовок стадии в попапе уровня 1 — кликабельный, раскрывает список двух альтернативных стадий.
- Элемент списка стадии: цветной маркер (цвет стадии), название, при наведении/фокусе — подсветка.
- После выбора стадии: список закрывается, показывается лоадер в области уровня 1, данные обновляются.
- Сохраняются существующие элементы уровня 1: прогресс-бары сотрудников, “Другие”, хранитель.
- Поддержка клавиатуры: TAB-навигация по пунктам списка, Enter — выбрать, ESC — закрыть список; ESC по-прежнему закрывает попап.
- Состояние “нет данных”: краткий плейсхолдер, не скрывать контрол стадии.

## Состояния и логика
- Состояния: `currentStageId`, `isStageListOpen`, `isStageLoading`, `loadError`, `availableStages[]`, `level1Data`.
- Действия:
  - Клик/Enter по заголовку стадии → toggle `isStageListOpen`.
  - Клик/Enter по стадии в списке → `isStageLoading=true`, закрыть список, вызвать загрузчик (этап 2), обновить `level1Data/currentStageId`, сбросить `level2/level3`, `loadError=null`, `isStageLoading=false`.
  - Ошибка → `loadError` + уведомление в UI; не менять текущую стадию.
- Закрытие списка по клику вне или ESC.

## Вёрстка и стили
- Dropdown/лист стадий под заголовком (positioned), не перекрывает основное содержимое.
- Цветовые маркеры стадий брать из единого словаря (синий/жёлтый/зелёный).
- Лоадер для области уровня 1 (skeleton/спиннер) поверх данных на время загрузки.
- Состояния disabled для элементов списка, если уже выбранная стадия = currentStageId.
- Минимальные размеры hit-area (не менее 36px высотой), чтобы кликать удобно.
- При открытом списке — клик вне закрывает; фокус-ловушка не требуется, но фокус возвращается на триггер.

## Интеграция с данными (использовать результат этапа 2)
- Подключить единый загрузчик `loadStageLevel1(...)` с приоритетом метаданных и фолбэком REST.
- При успехе обновлять `level1Data`, `currentStageId`; сбрасывать `level2Data/level3Data`.
- При ошибке — показывать `loadError`, оставлять прежние данные.

## Тестовые сценарии (ручные)
- Клик по названию стадии → список → выбор новой стадии → лоадер → обновление данных.
- Повторный выбор той же стадии → ничего не меняется, список закрывается.
- Ошибка загрузки → уведомление, данные не сброшены.
- Клавиатурно: TAB → пункт списка → Enter выбрать; ESC закрывает список; ESC в попапе закрывает модалку.
- Проверка на всех типах графиков (line/bar/doughnut) при наличии метаданных и при REST-фолбэке.

## Критерии приёмки
- Список стадий открывается по клику/Enter, корректно закрывается по клику вне/ESC.
- Доступность: TAB/Enter/ESC работает; фокус корректно возвращается после закрытия списка.
- После выбора стадии показывается лоадер, данные уровня 1 обновляются, попап не закрывается.
- Цвета/лейблы стадий берутся из единого словаря; disabled для текущей стадии.
- Ошибки/таймауты отображаются без ломания текущего стейта.

## Связанные материалы
- `DOCS/TASKS/TASK-038-popup-stage-switching.md`
- `DOCS/TASKS/TASK-038-01-popup-stage-switching-analysis.md`
- `DOCS/TASKS/TASK-038-02-popup-stage-switching-data.md`
- `DOCS/ANALYSIS/graph-state-popup-interactive-levels-analysis.md`
- `DOCS/USER-GUIDE/graph-state-sector-1c/00-overview.md`
- `vue-app/src/components/graph-state/EmployeeDetailsModal.vue`

