# TASK-038-04: Навигация и состояния при переключении стадий в попапе 1-го уровня (Vue)

**Дата создания:** 2025-12-15 12:25 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Связь:** Этап 4 эпика TASK-038 (`TASK-038-popup-stage-switching.md`)  
**Модуль:** График состояния сектора 1С (`EmployeeDetailsModal.vue`)  

## Цель
Организовать корректную навигацию и управление состояниями попапа при смене стадии: сбрасывать вложенные уровни (2/3), поддерживать back/esc, сохранять UX-целостность (фокус, скролл), устойчивость к ошибкам и повторным попыткам загрузки.

## Требования к навигации и стейтам
- При выборе новой стадии:
  - Сбрасывать данные уровней 2 и 3 (`level2Data`, `level3Data`, `popupLevel` → 1).
  - Очищать ошибки (`loadError=null`), выставлять `isStageLoading=true` до завершения загрузки.
  - Не закрывать модалку; сохранение положения скролла и фокуса внутри попапа.
- Хранить `previousStageId` для безопасного отката при ошибке загрузки новой стадии.
- Back/ESC:
  - ESC закрывает попап (как сейчас), но не ломает внутренние обработчики dropdown (этап 3).
  - Кнопка “Назад” на уровнях 2/3 работает в рамках выбранной стадии; после смены стадии уровни 2/3 недоступны, пока не будут заново заполнены.
- Ошибки/таймауты:
  - При ошибке загрузки новой стадии: показывать уведомление, не менять `currentStageId/level1Data`, `popupLevel` остаётся 1.
  - Кнопка “Повторить” повторяет загрузку с тем же stageId/context.

## Состояния и события
- Состояния: `currentStageId`, `popupLevel` (1/2/3), `level1Data`, `level2Data`, `level3Data`, `isStageLoading`, `loadError`, `isStageListOpen`.
- События:
  - `onStageSelect(stageId)` → загрузка уровня 1, сброс 2/3.
  - `onLevel2Back()` → `popupLevel=1`, восстановление `level1Data`.
  - `onLevel3Back()` → `popupLevel=2`, восстановление `level2Data`.
  - `onRetry()` → повторная загрузка выбранной стадии.

## Интеграция (зависимость от этапов 2 и 3)
- Использовать загрузчик данных уровня 1 (этап 2) с приоритетом метаданных → REST.
- Использовать UI dropdown из этапа 3 для триггера смены стадии.
- Обновлять стейты строго через единый поток: select → load → success/fail → set state.

## Технические заметки
- Сброс уровней: при выборе новой стадии нужно гарантировать `popupLevel=1` и очистку данных 2/3, чтобы исключить неконсистентность.
- Фокус/скролл: при закрытии списка стадий возвращать фокус к заголовку/кнопке; не дергать scroll контейнера попапа.
- ESC: убедиться, что обработчик ESC dropdown не блокирует глобальный ESC попапа; порядок слушателей — сначала закрыть список, затем (при повторном ESC) закрыть попап.
- Логирование: при ошибке загрузки новой стадии логировать stageId/context; не спамить консоль.

## Тестовые сценарии (ручные)
- Выбор новой стадии → лоадер → успешная загрузка → уровни 2/3 сброшены, попап остаётся открыт.
- Ошибка загрузки → уведомление, данные прежней стадии остаются, `popupLevel=1`.
- Повторная попытка после ошибки → успешная загрузка обновляет данные.
- Из уровней 2/3: “Назад” возвращает к 1 в рамках выбранной стадии; после смены стадии уровни 2/3 пустые.
- ESC: один раз — закрывает список (если открыт); второй раз — закрывает попап.

## Критерии приёмки
- При смене стадии попап остаётся на уровне 1, вложенные уровни очищены, лоадер показывается.
- Ошибки/таймауты не ломают текущие данные; есть кнопка “Повторить”.
- Back/ESC работают предсказуемо: порядок закрытия — dropdown → попап.
- Фокус и скролл остаются стабильными; нет “прыжков” контента.

## Связанные материалы
- `DOCS/TASKS/TASK-038-popup-stage-switching.md`
- `DOCS/TASKS/TASK-038-01-popup-stage-switching-analysis.md`
- `DOCS/TASKS/TASK-038-02-popup-stage-switching-data.md`
- `DOCS/TASKS/TASK-038-03-popup-stage-switching-ui.md`
- `DOCS/ANALYSIS/graph-state-popup-interactive-levels-analysis.md`
- `vue-app/src/components/graph-state/EmployeeDetailsModal.vue`

