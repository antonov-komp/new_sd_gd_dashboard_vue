# TASK-003-03: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π, –æ—Ç–≤–µ—Ç 200

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-05 22:19 (UTC+3, –ë—Ä–µ—Å—Ç)  
**–°—Ç–∞—Ç—É—Å:** –ù–æ–≤–∞—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** Bitrix24 –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç (Vue.js)  
**–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞:** [TASK-003](./TASK-003-webhook-handler-system.md)

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞ –æ—Ç Bitrix24, –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—É–±–ª–µ–π —Å–æ–±—ã—Ç–∏–π (idempotency) –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç Bitrix24 (HTTP 200). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤.

---

## üéØ –ö–æ–Ω—Ç–µ–∫—Å—Ç

–≠—Ç–∞ –ø–æ–¥–∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏:
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç** ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ Bitrix24 –ø–æ–ª—É—á–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–°–≤—è–∑–∏:**
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: TASK-003-01, TASK-003-02
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–µ—ë: TASK-003-04

---

## üìÅ –ú–æ–¥—É–ª–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- `api/webhook-handler.php` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ handler –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–µ–π
- `logs/webhooks/processed/` ‚Äî –ø–∞–ø–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –û—Ç –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á:
- **TASK-003-01** ‚Äî PHP handler –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω
- **TASK-003-02** ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –û—Ç –º–æ–¥—É–ª–µ–π:
- –ù–µ—Ç

---

## üìù –°—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –≤–µ–±—Ö—É–∫–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∏–∑ payload
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
   - –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—É–±–ª–µ–π (idempotency):
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–æ–±—ã—Ç–∏—è (–∏–∑ payload –∏–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
   - –•—Ä–∞–Ω–µ–Ω–∏–µ ID –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ —Ñ–∞–π–ª–µ)
   - –ü—Ä–æ–ø—É—Å–∫ –¥—É–±–ª–µ–π —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º HTTP 200

3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç Bitrix24:
   - HTTP 200 –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - HTTP 200 –¥–ª—è –¥—É–±–ª–µ–π (–Ω–µ –æ—à–∏–±–∫–∞)
   - HTTP 400 –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - HTTP 401 –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏
   - JSON –æ—Ç–≤–µ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ

4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ handler:
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –æ—Ç–≤–µ—Ç

---

## ‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏:

Bitrix24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Bitrix-Signature` –∏–ª–∏ –≤ payload.

**–ê–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. –í—ã—á–∏—Å–ª–∏—Ç—å HMAC-SHA256 –∏–∑ payload + —Å–µ–∫—Ä–µ—Ç
3. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ–¥–ø–∏—Å—å—é –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞/payload
4. –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- https://context7.com/bitrix24/rest/webhook/
- https://apidocs.bitrix24.ru/rest_help/general/webhooks/index.php

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π (Idempotency):

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
1. **–ü–æ ID —Å–æ–±—ã—Ç–∏—è** (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ payload)
2. **–ü–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏** (event + timestamp + entity_id)
3. **–•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏** (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
4. **–•—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª–µ** (–¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ + —Ñ–∞–π–ª–∞ (–¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

```json
{
  "success": true,
  "event": "ONTASKADD",
  "processed": true,
  "timestamp": "2025-12-05T22:19:00+03:00"
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ó–∞–ø—Ä–æ—Å—ã —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (HTTP 401)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] –î—É–±–ª–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- [ ] –î—É–±–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç HTTP 200 (–Ω–µ –æ—à–∏–±–∫–∞)
- [ ] –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –•—Ä–∞–Ω–µ–Ω–∏–µ ID –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Handler –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200 –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] JSON –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏:

```php
<?php
/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞ –æ—Ç Bitrix24
 * 
 * @param string $rawBody Raw body –∑–∞–ø—Ä–æ—Å–∞
 * @param string $signature –ü–æ–¥–ø–∏—Å—å –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
 * @param string $secret –°–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞
 * @return bool –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏
 */
function validateWebhookSignature($rawBody, $signature, $secret) {
    if (empty($signature) || empty($secret)) {
        return false;
    }
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ HMAC-SHA256
    $computedSignature = hash_hmac('sha256', $rawBody, $secret);
    
    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π (–∑–∞—â–∏—Ç–∞ –æ—Ç timing attacks)
    return hash_equals($signature, $computedSignature);
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –≤–µ–±—Ö—É–∫–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
 * 
 * @return string –°–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞
 */
function getWebhookSecret() {
    // –í–∞—Ä–∏–∞–Ω—Ç 1: –ò–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    $configFile = __DIR__ . '/../config/webhook-secret.php';
    if (file_exists($configFile)) {
        return include $configFile;
    }
    
    // –í–∞—Ä–∏–∞–Ω—Ç 2: –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    $secret = getenv('BITRIX24_WEBHOOK_SECRET');
    if ($secret) {
        return $secret;
    }
    
    // –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–∑ settings.json (–µ—Å–ª–∏ —Ç–∞–º —Ö—Ä–∞–Ω–∏—Ç—Å—è)
    $settingsFile = __DIR__ . '/../settings.json';
    if (file_exists($settingsFile)) {
        $settings = json_decode(file_get_contents($settingsFile), true);
        return $settings['webhook_secret'] ?? null;
    }
    
    return null;
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π:

```php
<?php
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
 * 
 * @param string $eventId –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è
 * @return bool true, –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
 */
function isEventProcessed($eventId) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    static $processedEvents = [];
    if (isset($processedEvents[$eventId])) {
        return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ñ–∞–π–ª–µ (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
    $processedFile = __DIR__ . '/../logs/webhooks/processed/' . date('Y-m-d') . '.json';
    if (file_exists($processedFile)) {
        $processed = json_decode(file_get_contents($processedFile), true) ?? [];
        if (in_array($eventId, $processed)) {
            return true;
        }
    }
    
    return false;
}

/**
 * –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ
 * 
 * @param string $eventId –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è
 */
function markEventAsProcessed($eventId) {
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
    static $processedEvents = [];
    $processedEvents[$eventId] = true;
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
    $processedDir = __DIR__ . '/../logs/webhooks/processed/';
    if (!is_dir($processedDir)) {
        mkdir($processedDir, 0755, true);
    }
    
    $processedFile = $processedDir . date('Y-m-d') . '.json';
    $processed = [];
    if (file_exists($processedFile)) {
        $processed = json_decode(file_get_contents($processedFile), true) ?? [];
    }
    
    if (!in_array($eventId, $processed)) {
        $processed[] = $eventId;
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –º–∞—Å—Å–∏–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10000 —Å–æ–±—ã—Ç–∏–π)
        if (count($processed) > 10000) {
            $processed = array_slice($processed, -10000);
        }
        
        file_put_contents(
            $processedFile,
            json_encode($processed, JSON_PRETTY_PRINT),
            LOCK_EX
        );
    }
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–æ–±—ã—Ç–∏—è
 * 
 * @param array $payload Payload –≤–µ–±—Ö—É–∫–∞
 * @return string –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è
 */
function generateEventId($payload) {
    // –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ID –∏–∑ payload (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (isset($payload['data']['TASK']['ID'])) {
        return $payload['event'] . '_' . $payload['data']['TASK']['ID'] . '_' . ($payload['ts'] ?? time());
    }
    
    if (isset($payload['data']['FIELDS']['ID'])) {
        return $payload['event'] . '_' . $payload['data']['FIELDS']['ID'] . '_' . ($payload['ts'] ?? time());
    }
    
    // –í–∞—Ä–∏–∞–Ω—Ç 2: –í—ã—á–∏—Å–ª–∏—Ç—å –∏–∑ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª–µ–π
    $event = $payload['event'] ?? '';
    $ts = $payload['ts'] ?? time();
    $dataHash = md5(json_encode($payload['data'] ?? []));
    
    return $event . '_' . $ts . '_' . substr($dataHash, 0, 8);
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handler:

```php
<?php
// –í api/webhook-handler.php

try {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ raw body
    $rawBody = file_get_contents('php://input');
    
    if (empty($rawBody)) {
        throw new Exception('Empty request body');
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
    $signature = $_SERVER['HTTP_X_BITRIX_SIGNATURE'] ?? null;
    $secret = getWebhookSecret();
    
    if (!validateWebhookSignature($rawBody, $signature, $secret)) {
        http_response_code(401);
        echo json_encode([
            'error' => 'Invalid signature',
            'error_description' => 'Webhook signature validation failed'
        ]);
        exit;
    }
    
    // –ü–∞—Ä—Å–∏–Ω–≥ JSON
    $payload = json_decode($rawBody, true);
    
    if (json_last_error() !== JSON_ERROR_NONE) {
        throw new Exception('Invalid JSON: ' . json_last_error_msg());
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if (!isset($payload['event']) || !isset($payload['data'])) {
        throw new Exception('Missing required fields');
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —Å–æ–±—ã—Ç–∏—è
    $eventId = generateEventId($payload);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π
    if (isEventProcessed($eventId)) {
        // –î—É–±–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç HTTP 200 (–Ω–µ –æ—à–∏–±–∫–∞)
        http_response_code(200);
        echo json_encode([
            'success' => true,
            'event' => $payload['event'],
            'processed' => false,
            'duplicate' => true,
            'timestamp' => date('c')
        ]);
        exit;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
    $eventType = $payload['event'];
    $eventData = $payload['data'];
    $category = determineCategory($eventType);
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    $clientIp = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
    logWebhookEvent($eventType, $eventData, $category, $payload, $clientIp);
    
    // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ
    markEventAsProcessed($eventId);
    
    // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    http_response_code(200);
    echo json_encode([
        'success' => true,
        'event' => $eventType,
        'processed' => true,
        'timestamp' => date('c')
    ]);
    
} catch (Exception $e) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    http_response_code(400);
    echo json_encode([
        'error' => 'Webhook processing failed',
        'error_description' => $e->getMessage()
    ]);
    
    logWebhookError($e, $payload ?? null);
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏:

1. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å –≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É (HTTP 200)

2. **–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –ø–æ–¥–ø–∏—Å—å:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (HTTP 401)

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø–∏—Å–∏:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (HTTP 401)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–µ–π:

1. **–ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–î—É–±–ª–∏–∫–∞—Ç —Å–æ–±—ã—Ç–∏—è:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ –∂–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP 200 —Å —Ñ–ª–∞–≥–æ–º `duplicate: true`

3. **–†–∞–∑–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤:

1. **–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP 200
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JSON –æ—Ç–≤–µ—Ç —Å `success: true`

2. **–î—É–±–ª–∏–∫–∞—Ç:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP 200 (–Ω–µ –æ—à–∏–±–∫–∞)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JSON –æ—Ç–≤–µ—Ç —Å `duplicate: true`

3. **–û—à–∏–±–∫–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP 400 –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP 401 –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Bitrix24 REST API - –í–µ–±—Ö—É–∫–∏](https://context7.com/bitrix24/rest/webhook/)
- [HMAC –≤ PHP](https://www.php.net/manual/en/function.hash-hmac.php)
- [Idempotency –≤ –≤–µ–±-API](https://restfulapi.net/idempotent-rest-apis/)

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫

- **2025-12-05 22:19 (UTC+3, –ë—Ä–µ—Å—Ç):** –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∞ TASK-003-03

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- **–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è:** [TASK-003: –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤](./TASK-003-webhook-handler-system.md)
- **–ü—Ä–µ–¥—ã–¥—É—â–∞—è:** [TASK-003-02: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ JSON](./TASK-003-02-webhook-logging.md)
- **–°–ª–µ–¥—É—é—â–∞—è:** [TASK-003-04: Vue.js –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤](./TASK-003-04-webhook-logs-vue.md)

