# TASK-043: Попап «По стадиям» для новых тикетов модуля «График приёма и закрытий сектора 1С»

**Дата создания:** 2025-12-16 13:28 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связь с задачей:** Расширение функциональности TASK-042

## Этапы реализации

Задача разделена на последовательные этапы:

1. **[TASK-043-01](TASK-043-01-chart-click-handlers.md)** — Разделение обработчиков кликов на графике для «Новых» и «Закрытых» тикетов
2. **[TASK-043-02](TASK-043-02-api-stages-extension.md)** — Расширение API для получения новых тикетов по стадиям
3. **[TASK-043-03](TASK-043-03-stages-modal-implementation.md)** — Реализация попапа «По стадиям» для новых тикетов

**Порядок выполнения:** Этапы должны выполняться последовательно, так как каждый этап зависит от предыдущего.

## Цель

Реализовать отдельный попап «По стадиям» для новых тикетов, который открывается при клике на точку «Новые тикеты» на графике. В попапе отображается сортировка новых тикетов по стадиям (3 рабочие стадии + 3 закрывающие стадии).

## Контекст

- **Текущее состояние:** 
  - В модуле «График приёма и закрытий сектора 1С» есть график с двумя точками: «Новые» и «Закрытые»
  - При клике на любую точку открывается один и тот же попап `ResponsibleModal` (закрытые тикеты, отображение «По сотрудникам»)
  - API возвращает данные о новых и закрытых тикетах, но попап показывает только закрытые
- **Проблема:** 
  - Нет возможности просмотреть новые тикеты отдельно
  - Нет попапа для отображения новых тикетов по стадиям
- **Требуется:** 
  1. Разделить обработчики кликов: «Закрытые» → `ResponsibleModal` (уже есть), «Новые» → новый попап `StagesModal`
  2. Создать попап `StagesModal` с отображением «По стадиям» для новых тикетов
  3. В попапе отображать 6 стадий: 3 рабочие + 3 закрывающие
  4. При клике на стадию открывать уровень 2 со списком тикетов этой стадии

## Анализ стадий

### Рабочие стадии (targetStages)
Используются для новых тикетов, которые находятся в работе:

1. **DT140_12:UC_0VHWE2** — «Сформировано обращение» (formed)
2. **DT140_12:PREPARATION** — «Рассмотрение ТЗ» (review)
3. **DT140_12:CLIENT** — «Исполнение» (execution)

### Закрывающие стадии (closingStages)
Используются для тикетов, которые были закрыты, но могут появиться в новых тикетах, если были созданы в неделю:

1. **DT140_12:SUCCESS** — «Успешно закрыто»
2. **DT140_12:FAIL** — «Закрыто с ошибкой»
3. **DT140_12:UC_0GBU8Z** — «Закрыто» (альтернативная закрывающая стадия)

**Примечание:** Новые тикеты — это тикеты, созданные в неделю (`createdTime` в диапазоне `[weekStartUtc, weekEndUtc]`), независимо от стадии.

## Структура попапа «По стадиям»

### Уровень 1: Список стадий

**Отображение:**
- Заголовок: «Новые тикеты по стадиям»
- Список из 6 стадий с количеством тикетов в каждой
- Визуальное оформление аналогично `EmployeeDetailsModal` (вид «По стадиям»)

**Структура данных:**
```javascript
stages: [
  {
    stageId: 'DT140_12:UC_0VHWE2',
    stageName: 'Сформировано обращение',
    count: 5,
    color: '#007bff' // Цвет стадии
  },
  {
    stageId: 'DT140_12:PREPARATION',
    stageName: 'Рассмотрение ТЗ',
    count: 3,
    color: '#ffc107'
  },
  // ... остальные стадии
]
```

### Уровень 2: Список тикетов стадии

**Отображение:**
- Заголовок: «Тикеты стадии: [Название стадии]»
- Кнопка «Назад» для возврата на уровень 1
- Список тикетов через компонент `TicketCard`
- Stagger-анимация при появлении карточек

**Структура данных:**
```javascript
tickets: [
  {
    id: 12345,
    title: 'Название тикета',
    createdTime: '2025-12-10T10:00:00Z',
    stageId: 'DT140_12:UC_0VHWE2',
    // ... другие поля
  }
]
```

## Аналогичная реализация

В модуле «График состояния сектора 1С» используется попап `EmployeeDetailsModal.vue` с переключателем стадий в заголовке. Для нового модуля нужен упрощённый вариант:
- Уровень 1: Список стадий с количеством тикетов
- Уровень 2: Список тикетов выбранной стадии

## Общее описание задач

> **Примечание:** Детальное описание каждой задачи находится в соответствующих файлах этапов (TASK-043-01, TASK-043-02, TASK-043-03).

### 1) Разделение обработчиков кликов на графике
**См. [TASK-043-01](TASK-043-01-chart-click-handlers.md)**

**Проблема:**
- В `GraphAdmissionClosureChart.vue` обработчик `onClick` открывает только `ResponsibleModal` для закрытых тикетов
- Нет различия между кликом на «Новые» и «Закрытые»

**Решение:**
- Определить, на какой dataset кликнули (по `datasetIndex`)
- Если клик на «Закрытые» → открыть `ResponsibleModal`
- Если клик на «Новые» → открыть новый `StagesModal`

**Реализация:**
```javascript
// В chartOptions
onClick: (event, elements, chart) => {
  if (elements.length === 0) return;
  
  const element = elements[0];
  const datasetIndex = element.datasetIndex;
  const dataset = chart.data.datasets[datasetIndex];
  
  if (dataset.label === 'Закрытые') {
    emit('open-responsible');
  } else if (dataset.label === 'Новые') {
    emit('open-stages');
  }
}
```

### 2) Расширение API для получения новых тикетов по стадиям
**См. [TASK-043-02](TASK-043-02-api-stages-extension.md)**

**Текущее состояние API:**
- Endpoint: `POST /api/graph-1c-admission-closure.php`
- Возвращает `newTickets`, `closedTickets`, `stages[]` (только для закрытых)
- **Не возвращает новые тикеты по стадиям**

**Требуется:**
- Добавить опциональный параметр `includeNewTicketsByStages: true`
- При запросе возвращать массив `newTicketsByStages[]` с количеством новых тикетов по каждой стадии
- Опционально: возвращать сами тикеты для каждой стадии (если `includeTickets: true`)

**Структура ответа API (расширенная):**
```json
{
  "success": true,
  "meta": { ... },
  "data": {
    "newTickets": 14,
    "closedTickets": 34,
    "newTicketsByStages": [
      {
        "stageId": "DT140_12:UC_0VHWE2",
        "stageName": "Сформировано обращение",
        "count": 5,
        "tickets": [ ... ] // если includeTickets: true
      }
    ],
    "stages": [ ... ], // для закрытых
    "responsible": [ ... ]
  }
}
```

**Логика в API:**
- Фильтровать новые тикеты по `createdTime` в диапазоне `[weekStartUtc, weekEndUtc]`
- Группировать по `stageId`
- Подсчитывать количество для каждой стадии
- Возвращать все 6 стадий (даже если count = 0)

### 3) Реализация попапа «По стадиям»
**См. [TASK-043-03](TASK-043-03-stages-modal-implementation.md)**

**Текущий компонент:** Новый компонент `StagesModal.vue`

**Требуется:**
- Создать компонент `StagesModal.vue` аналогично `ResponsibleModal.vue`
- Уровень 1: Список стадий с количеством тикетов
- Уровень 2: Список тикетов выбранной стадии
- Использовать те же плавные переходы и ленивую загрузку
- Интегрировать компонент `TicketCard` для отображения тикетов

**Структура компонента:**
```vue
<template>
  <div v-if="isVisible" class="modal-backdrop">
    <div class="modal">
      <Transition name="level" mode="out-in">
        <!-- Уровень 1: Список стадий -->
        <div v-if="popupLevel === 1" key="level-1">
          <header>
            <h3>Новые тикеты по стадиям</h3>
          </header>
          <section>
            <ul class="stages-list">
              <li
                v-for="stage in stages"
                :key="stage.stageId"
                @click="handleStageClick(stage)"
              >
                <span class="stage-color" :style="{ backgroundColor: stage.color }"></span>
                <span class="stage-name">{{ stage.stageName }}</span>
                <span class="stage-count">{{ stage.count }} тикетов</span>
                <span class="stage-arrow">→</span>
              </li>
            </ul>
          </section>
        </div>
        
        <!-- Уровень 2: Список тикетов стадии -->
        <div v-else-if="popupLevel === 2" key="level-2">
          <header>
            <button @click="goBack">← Назад</button>
            <h3>Тикеты стадии: {{ selectedStage?.stageName }}</h3>
          </header>
          <section>
            <TransitionGroup name="ticket">
              <TicketCard
                v-for="ticket in tickets"
                :key="ticket.id"
                :ticket="ticket"
              />
            </TransitionGroup>
          </section>
        </div>
      </Transition>
    </div>
  </div>
</template>
```

## Технические требования

### API (бэкенд)

**Расширение endpoint:** `POST /api/graph-1c-admission-closure.php`

**Новый параметр (опциональный):**
```json
{
  "product": "1C",
  "weekStartUtc": "2025-12-08T00:00:00Z",
  "weekEndUtc": "2025-12-15T23:59:59Z",
  "includeNewTicketsByStages": true,  // новый параметр
  "includeTickets": true  // опционально, для получения тикетов
}
```

**Логика в API:**
- Если `includeNewTicketsByStages === true`, группировать новые тикеты по стадиям
- Фильтровать по `createdTime` в диапазоне `[weekStartUtc, weekEndUtc]`
- Группировать по `stageId`
- Возвращать все 6 стадий (даже если count = 0)
- Если `includeTickets === true`, включать массив `tickets[]` для каждой стадии

### Фронтенд (Vue.js)

**Компоненты:**
- `StagesModal.vue` — новый компонент попапа «По стадиям»
- `GraphAdmissionClosureChart.vue` — модификация для разделения обработчиков кликов
- `GraphAdmissionClosureDashboard.vue` — добавление состояния для `StagesModal`

**Сервисы:**
- `admissionClosureService.js` — расширение для поддержки `includeNewTicketsByStages`

**Утилиты:**
- Константы стадий и их цветов (можно переиспользовать из `dashboard-sector-1c-service.js`)

## Порядок выполнения этапов

Этапы должны выполняться последовательно:

1. **TASK-043-01** — Разделение обработчиков кликов (фронтенд)
   - Модификация `GraphAdmissionClosureChart.vue`
   - Определение dataset по клику
   - Эмит разных событий для «Новых» и «Закрытых»

2. **TASK-043-02** — Расширение API (бэкенд)
   - Добавление параметра `includeNewTicketsByStages`
   - Модификация логики агрегации для новых тикетов по стадиям
   - Формирование ответа с `newTicketsByStages[]`

3. **TASK-043-03** — Попап «По стадиям» (фронтенд)
   - Создание компонента `StagesModal.vue`
   - Реализация двух уровней (список стадий → список тикетов)
   - Интеграция с API и компонентом `TicketCard`

## Критерии приёмки

- [ ] При клике на «Закрытые» открывается `ResponsibleModal` (как раньше)
- [ ] При клике на «Новые» открывается новый `StagesModal`
- [ ] В `StagesModal` отображаются все 6 стадий с количеством тикетов
- [ ] При клике на стадию открывается уровень 2 со списком тикетов
- [ ] Тикеты отображаются через компонент `TicketCard`
- [ ] Кнопка «Назад» возвращает на уровень 1
- [ ] API возвращает `newTicketsByStages[]` при `includeNewTicketsByStages: true`
- [ ] Новые тикеты фильтруются по `createdTime` в диапазоне недели
- [ ] Все стадии отображаются (даже если count = 0)
- [ ] Плавные переходы и ленивая загрузка работают (как в TASK-042-04)
- [ ] Визуальное оформление соответствует `ResponsibleModal` и `EmployeeDetailsModal`

## Дополнительные уточнения

### Цвета стадий

**Рабочие стадии:**
- `DT140_12:UC_0VHWE2` (formed) — синий `#007bff`
- `DT140_12:PREPARATION` (review) — жёлтый `#ffc107`
- `DT140_12:CLIENT` (execution) — зелёный `#28a745`

**Закрывающие стадии:**
- `DT140_12:SUCCESS` — зелёный `#28a745`
- `DT140_12:FAIL` — красный `#dc3545`
- `DT140_12:UC_0GBU8Z` — серый `#6c757d`

### Оптимизация производительности
- Загружать тикеты только при переходе на уровень 2 (ленивая загрузка)
- Использовать кэширование данных стадий
- Минимизировать запросы к API

### Совместимость с существующим кодом
- Не ломать текущую функциональность `ResponsibleModal`
- Переиспользовать компоненты и утилиты где возможно
- Следовать существующим паттернам и стилям

## История правок

- 2025-12-16 13:28 (UTC+3, Брест): Создана задача

