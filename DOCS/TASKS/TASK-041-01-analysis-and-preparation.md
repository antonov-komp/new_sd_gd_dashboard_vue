# TASK-041-01: Подготовка и анализ для модуля «График приёма и закрытий сектора 1С»

**Дата создания:** 2025-12-15 12:32 (UTC+0300, Brest)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связь с задачей:** Шаг 1 из TASK-041

## Цель этапа
Подготовить основу для разработки модуля: понять текущую реализацию графиков сектора 1С, подтвердить фильтрацию по продукту 1С как первый шаг, зафиксировать схему данных для ответственных и закрывающих стадий, уточнить контракт бэкенда для недельной агрегации (UTC, ISO-8601).

## Контекст
- Базовый модуль: «График состояния сектора 1С» — используем его структуру/доступы/фильтры как эталон.
- Новый модуль: «График приёма и закрытий сектора 1С» (TASK-041).
- Неделя: ISO-8601 (пн–вс), расчёт границ и номера недели — на бэкенде, в UTC.
- Ответственные берём из `assignedById` (или вариантов) как в текущих модулях (см. `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js`).

## Задачи этапа
1) Анализ текущего кода модулей сектора 1С  
   - Изучить структуру, доступы, фильтры, графические компоненты.  
   - Найти точки применения фильтра по `product` (1С) и подтвердить, что он применяется первым.  
   - Зафиксировать используемые компоненты графиков для повторного использования.

2) Ответственные (assigned)  
   - Изучить, как в модулях 1 и 2 извлекается ответственный: `getAssignedById`, `parseEmployeeId`, `isZeroPointTicket` в `ticket-utils.js`.  
   - Зафиксировать правила обработки «нулевой точки» (нет ответственного или `KEEPER_OBJECTS_ID = 1051`).  
   - Подготовить описание для бэкенда: какие поля/форматы нужны для агрегации ответственных в новом модуле.

3) Закрывающие стадии и данные  
   - Подтвердить список закрывающих стадий: `DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`.  
   - Зафиксировать, что новые считаются по `createdTime` в границах недели (UTC), закрытые — по `movedTime` + stageId ∈ списку.  
   - Проверить примеры в логах (`logs/2025-12-15/11/1765786306_callCurl_5109403log.json`) на наличие нужных полей (`createdTime`, `movedTime`, `stageId`, `UF_CRM_7_TYPE_PRODUCT`, `assignedById`).

4) Контракт бэкенда (уточнение)  
   - Согласовать ожидаемый ответ: `meta` (weekNumber, weekStartUtc, weekEndUtc), `data.newTickets`, `data.closedTickets`, `data.series.new[]/closed[]`, `data.stages[]`, `data.responsible[]`.  
   - Уточнить входные фильтры: `product=1C`, `weekStartUtc`, `weekEndUtc` (формируется бэкендом).  
   - Требование: все даты в ответе — UTC ISO8601.

5) Риски и ограничения  
   - Вариативность поля assigned (строка/число/объект) — подтвердить, что бэкенд нормализует/пробрасывает как число.  
   - Нулевая точка (нет ответственного, keeper) — решить, включаем/исключаем в агрегациях попапа (следовать текущей логике модулей 1/2).  
   - Проверить, нет ли дополнительных закрывающих стадий на проде (если появятся — правится на бэкенде).

## Ожидаемые результаты этапа
- Конспект найденных мест фильтра по `product` и подтверждение порядка его применения (первый шаг).  
- Подтверждённый список функций/утилит для ответственных (reuse из `ticket-utils.js`) и правила нулевой точки.  
- Подтверждённый список закрывающих стадий и используемых полей (`createdTime`, `movedTime`, `stageId`, `UF_CRM_7_TYPE_PRODUCT`, `assignedById`).  
- Уточнённый/зафиксированный черновой контракт бэкенда для недельной агрегации (UTC).  
- Краткий список рисков/допущений, требующих ответа/подтверждения.

## Критерии приёмки этапа
- Найдены и задокументированы точки применения фильтра по продукту 1С (первым шагом).  
- Описана и согласована логика получения ответственных (с нулевой точкой) как в модулях 1/2.  
- Подтверждён список закрывающих стадий и полей для расчётов.  
- Задокументирован ожидаемый бэкенд-ответ (meta + data + responsible) и входные фильтры.  
- Зафиксированы риски/допущения, переданы на согласование (если есть).

## Дополнительные уточнения
- Просмотреть текущие реализации графиков и попапов: `vue-app/src/components/graph-state/GraphStateChart.vue`, `vue-app/src/components/graph-state/EmployeeDetailsModal.vue`.  
- Для попапов изучить загрузчик данных: `vue-app/src/utils/graph-state/stageLevel1Loader.js` (для понимания паттернов, без прямого реюза).  
- Проверить утилиты ответственных: `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js` — зафиксировать используемые функции и правила нулевой точки (keeper=1051).  
- Подтвердить в коде, где применяется фильтр `product` первым шагом (аналог первых двух модулей), и отметить файлы/функции, отвечающие за это.

