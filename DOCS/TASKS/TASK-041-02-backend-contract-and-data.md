# TASK-041-02: Бэкенд-контракт и данные для модуля «График приёма и закрытий сектора 1С»

**Дата создания:** 2025-12-15 12:35 (UTC+0300, Brest)  
**Дата завершения:** 2025-12-15 18:00 (UTC+0300, Brest)  
**Статус:** ✅ Завершено  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связь с задачей:** Шаг 2 из TASK-041

## Цель этапа
Уточнить и зафиксировать контракт REST-эндпоинта для нового модуля, включая расчёт недель (UTC, ISO-8601), фильтрацию по продукту 1С на бэкенде, структуру ответа для графиков и попапа ответственных, а также требования к входным параметрам.

## Контекст
- Базовый модуль: «График состояния сектора 1С» — используем его фильтры/доступы/структуру.
- Новый модуль: «График приёма и закрытий сектора 1С» (TASK-041). Селектор этапов отсутствует, все стадии показываются сразу.
- Неделя: ISO-8601 (пн–вс). Расчёт `weekNumber`, `weekStartUtc`, `weekEndUtc` выполняет бэкенд. Все даты нормализуются к UTC.
- Ответственные: `assignedById` (или варианты) — логика получения совпадает с модулями 1 и 2 (`ticket-utils.js`).
- Закрывающие стадии: `DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`.

## Задачи этапа
1) Зафиксировать конечный REST-эндпоинт  
   - Имя/путь эндпоинта для модуля.  
   - Требования к авторизации/доступам (такие же, как в модуле «График состояния сектора 1С»).

2) Входные параметры (пример)  
   - `product`: строка, обязательный — фильтр на сектор 1С, применяется первым.  
   - `weekStartUtc`, `weekEndUtc`: даты ISO8601, обязательные — вычисляются бэкендом для текущей недели (пн–вс).  
   - Дополнительно (опционально): служебные фильтры, если нужны для унификации с текущим модулем.

3) Обязательная логика на бэкенде  
   - Фильтрация по `UF_CRM_7_TYPE_PRODUCT` = «1C» (или эквивалент) первым шагом.  
   - Нормализация времени: привести `createdTime` и `movedTime` к UTC перед фильтрацией.  
   - «Новые»: счёт тикетов с `createdTime` ∈ [weekStartUtc, weekEndUtc].  
   - «Закрытые»: счёт тикетов с `movedTime` ∈ [weekStartUtc, weekEndUtc] и `stageId` ∈ {`DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`}.  
   - Серии (для линейного/бар): агрегаты за неделю (массивы `new[]`, `closed[]`; пока по одной точке).  
   - Stages: распределение закрытых по стадиям (для цветовых серий/легенд).  
   - Responsible: агрегировать ответственных по `assignedById` (или альтернативным полям) → `{ id, name, count }`, учитывать правила «нулевой точки» как в модулях 1/2 (keeper=1051, пустые → ноль).

4) Структура ответа (уточнение/финализация)  
```json
{
  "meta": {
    "weekNumber": 51,
    "weekStartUtc": "2025-12-15T00:00:00Z",
    "weekEndUtc": "2025-12-21T23:59:59Z"
  },
  "data": {
    "newTickets": 12,
    "closedTickets": 8,
    "series": {
      "new": [12],
      "closed": [8]
    },
    "stages": [
      { "stageId": "DT140_12:SUCCESS", "count": 5 },
      { "stageId": "DT140_12:FAIL", "count": 2 },
      { "stageId": "DT140_12:UC_0GBU8Z", "count": 1 }
    ],
    "responsible": [
      { "id": 123, "name": "Иванов Иван", "count": 4 },
      { "id": 456, "name": "Петров Пётр", "count": 3 }
    ]
  }
}
```
- Все даты — UTC.  
- Серии — агрегаты за неделю (одна точка).  
- Responsible — агрегаты по ответственным; поведение нулевой точки — как в модулях 1/2 (уточнить включение/исключение).

5) Проверка полей по логам  
   - Подтвердить наличие в логах: `createdTime`, `movedTime`, `stageId`, `UF_CRM_7_TYPE_PRODUCT`, `assignedById` (или варианты).  
   - Если встречаются альтернативные поля (например, `assignedByIdId`, `ASSIGNED_BY_ID`, объект с `id/ID/value`), бэкенд обязан нормализовать в одном поле для ответа.

6) Допущения и риски  
   - Возможные новые закрывающие стадии на проде — должны добавляться на бэкенде без изменений фронта.  
   - Вариативность ответственных: если `assigned` отсутствует или keeper=1051 — согласовать, как учитывать в агрегатах (следовать текущей логике модулей 1/2).  
   - Нагрузка: убедиться, что агрегация по неделе и фильтр по продукту выполняются эффективно (использовать кеш/батчи, если есть).

## Ожидаемые результаты этапа
- Зафиксированный путь/имя REST-эндпоинта и требования к авторизации.  
- Согласованный формат входных параметров (`product`, `weekStartUtc`, `weekEndUtc`).  
- Финализированная схема ответа (meta + data + series + stages + responsible) с UTC-датами.  
- Подтверждение по логам наличия нужных полей и договорённость о нормализации ответственных на бэкенде.  
- Список допущений/рисков, переданный на согласование.

## Критерии приёмки этапа
- Описан и согласован REST-эндпоинт (путь, авторизация).  
- Зафиксирован формат входных фильтров и расчёт недель (UTC, ISO-8601) на бэкенде.  
- Утверждена структура ответа и список закрывающих стадий.  
- Подтверждена нормализация `assignedById` и правила нулевой точки для агрегатов ответственных.  
- Отражены риски/допущения и отмечены точки для подтверждения.  

## Дополнительные уточнения
- Рекомендуется сразу нормализовать поле ответственных в ответе (числовой `responsible.id`), чтобы фронт не повторял парсинг.  
- Формат ключей ответа — camelCase (как в примере), без дублирования разных регистров.  
- Закрывающие стадии лучше держать в конфиге бэкенда (список), чтобы расширять без правок фронта.  
- При отсутствии данных возвращать нули и пустые массивы (`series.new = [0]`, `series.closed = [0]`, `stages = []`, `responsible = []`), чтобы UI не ломался.  
- Логи (`logs/YYYY-MM-DD/HH/*log.json`) использовать для верификации схемы полей; при изменениях Bitrix полей фиксировать их маппинг на бэкенде.

## Промежуточная фиксация 2025-12-15 12:49 (UTC+03:00, Brest)
- **Endpoint (предложение фронта):** `POST /api/graph-1c-admission-closure.php` (аналогично `api/get-sector-data.php`, X-Requested-With + cookie auth как в текущем дашборде).  
- **Вход:** `product` (required, строка, default=`"1C"`), `weekStartUtc`/`weekEndUtc` (ISO8601, рассчитываются на бэке для текущей недели, фронт передаёт пустыми), опционально `useCache`/`forceRefresh` для согласования.  
- **Ответ (UTC, camelCase):** `meta { weekNumber, weekStartUtc, weekEndUtc }`, `data { newTickets, closedTickets, series { new[], closed[] }, stages[{stageId,count}], responsible[{id,name,count}] }`. Пустые выборки → нули/пустые массивы.  
- **Нормализация ответственных:** бэкенд приводит `responsible.id` к числу из полей `assignedById/ASSIGNED_BY_ID/assignedByIdId/{id|ID|value}`; нулевая точка = отсутствует либо keeper=1051 (как в `ticket-utils.js`).  
- **Фильтр продукта:** первый шаг на бэке — `UF_CRM_7_TYPE_PRODUCT` через аналог `sector-filter.js` (поддержка `1C`/`1С`).  
- **Поля в исходных данных:** подтверждены в фронтовом маппере `ticket-mapper.js` — `createdTime|CREATED_DATE`, `movedTime|UPDATED_TIME`, `stageId|STAGE_ID`, `UF_CRM_7_TYPE_PRODUCT`, `assignedById|ASSIGNED_BY_ID`.  
- **Закрывающие стадии:** список фиксирован на бэке `{DT140_12:SUCCESS, DT140_12:FAIL, DT140_12:UC_0GBU8Z}`, хранить в конфиге для расширения без правок фронта.  
- **Риски/допущения:** (1) нужны явные имена в ответах для stage labels/цветов — фронт переиспользует текущий маппинг, ждём подтверждения; (2) поведение для keeper/без ответственного — оставить как в модуле 1/2 (агрегируется в «Не назначен» либо отдельная группа) — требуется финальное решение бэка; (3) желателен кэш недельных агрегаций на бэке из логов для снижения нагрузки Bitrix.

## Финальная реализация 2025-12-15 18:00 (UTC+03:00, Brest)

### ✅ Реализованный контракт

**Endpoint:** `POST /api/graph-1c-admission-closure.php`

**Входные параметры:**
```json
{
  "product": "1C",
  "weekStartUtc": "2025-12-08T00:00:00Z",
  "weekEndUtc": "2025-12-15T23:59:59Z",
  "useCache": true,
  "forceRefresh": false,
  "debug": false
}
```

**Формат ответа:**
```json
{
  "success": true,
  "meta": {
    "weekNumber": 50,
    "weekStartUtc": "2025-12-08T00:00:00Z",
    "weekEndUtc": "2025-12-15T23:59:59Z"
  },
  "data": {
    "newTickets": 14,
    "closedTickets": 34,
    "series": {
      "new": [14],
      "closed": [34]
    },
    "stages": [
      { "stageId": "DT140_12:SUCCESS", "count": 32 },
      { "stageId": "DT140_12:UC_0GBU8Z", "count": 2 }
    ],
    "responsible": [
      { "id": 1006, "name": "ID 1006", "count": 10 },
      { "id": 994, "name": "ID 994", "count": 10 },
      { "id": null, "name": "Не назначен", "count": 0 }
    ]
  },
  "debug": {
    "fetchedTotal": 39,
    "sample": [...],
    "stageCounts": {...},
    "params": {...}
  }
}
```

### ✅ Реализованная логика бэкенда

1. **Унификация источника данных:**
   - Используется та же цепочка получения тикетов, что и в модулях 1/2
   - Смарт-процесс 140, все релевантные стадии (formed, review, execution, closing)
   - Фильтр `product=1C` применяется первым шагом

2. **Оптимизация запросов:**
   - Два целевых запроса к Bitrix24 вместо полной выборки:
     - Тикеты, созданные в неделю (`createdTime` в диапазоне)
     - Тикеты, закрытые в неделю (`movedTime` в диапазоне + закрывающие стадии)
   - Объединение результатов по ID (без дублей)

3. **Расчёт недели:**
   - ISO-8601 (понедельник–воскресенье)
   - Все расчёты в UTC
   - Номер недели вычисляется автоматически

4. **Подсчёт новых тикетов:**
   - Фильтр: `createdTime` в диапазоне `[weekStartUtc, weekEndUtc]`
   - После фильтрации по `product=1C`

5. **Подсчёт закрытых тикетов:**
   - Фильтр: `movedTime` (fallback на `updatedTime`) в диапазоне `[weekStartUtc, weekEndUtc]`
   - И `stageId` в списке закрывающих стадий: `DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`
   - После фильтрации по `product=1C`

6. **Агрегация ответственных:**
   - Нормализация `assignedById` (поддержка различных форматов полей)
   - Нулевая точка: `null` или `KEEPER_OBJECTS_ID = 1051` → "Не назначен"
   - Агрегация по ID с подсчётом количества

7. **Обработка ошибок:**
   - При ошибках API возвращается `{ "success": false, "message": "..." }`
   - При отсутствии данных возвращаются нули и пустые массивы

### ✅ Исправленные проблемы

1. **Синтаксическая ошибка PHP:** исправлен дублирующийся код в цикле обработки тикетов
2. **404 ошибка:** исправлен путь к API endpoint
3. **Оптимизация производительности:** вместо полной выборки всех тикетов используются два целевых запроса с фильтрами по датам

### ✅ Статус: КОНТРАКТ РЕАЛИЗОВАН И ПРОТЕСТИРОВАН

