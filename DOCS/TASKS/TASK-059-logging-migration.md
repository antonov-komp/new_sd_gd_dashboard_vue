# TASK-059: Перенос логов из nginx в локальное хранилище

**Дата создания:** 2025-12-18  
**Статус:** ✅ Завершена  
**Приоритет:** Средний

## Описание

Логи приложения перенесены из глобального nginx лога (`/var/log/nginx/back-antonov-mark-error.log`) в локальное хранилище приложения (`logs/app/`).

## Изменения

### 1. Создана структура локальных логов

- **Директория:** `logs/app/`
- **Формат файлов:** `graph-admission-closure-YYYY-MM-DD.log`
- **Ротация:** Автоматическая по дням (один файл на день)

### 2. Настроено логирование в API endpoint

**Файл:** `api/graph-1c-admission-closure.php`

Добавлена функция `setupAppLogging()`, которая:
- Создаёт директорию для логов, если её нет
- Настраивает `ini_set('error_log', ...)` для записи в локальный файл
- Автоматически разделяет логи по дням

### 3. Обновлён скрипт анализа производительности

**Файл:** `scripts/analyze-months-performance.sh`

- По умолчанию использует локальный лог приложения (сегодняшний день)
- Поддерживает анализ старых логов из nginx
- Улучшена обработка отсутствующих файлов

## Использование

### Просмотр логов

```bash
# Логи за сегодня
tail -f logs/app/graph-admission-closure-$(date +%Y-%m-%d).log

# Логи за конкретную дату
cat logs/app/graph-admission-closure-2025-12-18.log
```

### Анализ производительности

```bash
# Анализ из локального лога (по умолчанию - сегодня)
./scripts/analyze-months-performance.sh

# Анализ из конкретного файла
./scripts/analyze-months-performance.sh logs/app/graph-admission-closure-2025-12-18.log

# Анализ из старого nginx лога
./scripts/analyze-months-performance.sh /var/log/nginx/back-antonov-mark-error.log
```

### Очистка старых логов

```bash
# Удалить логи старше 30 дней
find logs/app -name "*.log" -mtime +30 -delete

# Удалить логи старше 7 дней
find logs/app -name "*.log" -mtime +7 -delete
```

## Преимущества

1. **Локальность:** Логи хранятся в проекте, не требуют root-доступа
2. **Удобство:** Легко найти и проанализировать логи
3. **Ротация:** Автоматическое разделение по дням
4. **Git:** Логи не попадают в репозиторий (уже в `.gitignore`)

## Формат логов

Логи сохраняют тот же формат, что и раньше, с префиксами:
- `[MONTHS]` - логи режима "3 месяца"
- `[MONTHS-QUERY1]` - логи запроса 1
- `[MONTHS-QUERY2]` - логи запроса 2
- `[MONTHS-QUERY3]` - логи запроса 3
- `[MONTHS-AGGREGATION]` - логи агрегации
- `[MONTHS-PERFORMANCE]` - метрики производительности
- `[Cache]` - логи кеширования
- `[PARALLEL-QUERIES]` - логи параллельных запросов

## Права доступа

- Директория: `755` (www-data:www-data)
- Файлы логов: `644` (www-data:www-data)
- Автоматическое создание директории при первом запросе

## Примечания

- Старые логи в nginx остаются доступными для исторического анализа
- Новые логи автоматически создаются при первом запросе к API
- Скрипт анализа поддерживает оба источника логов

