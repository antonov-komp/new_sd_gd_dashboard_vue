# TASK-050-01: Анализ и изучение документации Bitrix24 для модуля «Трудозатраты на Тикеты сектора 1С»

**Дата создания:** 2025-12-17 09:30 (UTC+3, Брест)  
**Дата завершения:** 2025-12-17 11:00 (UTC+3, Брест)  
**Статус:** ✅ Завершён  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связь с задачей:** Этап 1 из TASK-050

---

## Цель этапа

Изучить официальную документацию Bitrix24 по таблице фактов "Трудозатрата", определить методы REST API для получения данных о трудозатратах, изучить структуру данных и формат единиц измерения. Подготовить техническую основу для реализации модуля.

---

## Контекст

- Модуль «Трудозатраты на Тикеты сектора 1С» (TASK-050) — 4-й модуль в дашборде сектора 1С
- Данные о трудозатратах получаются из таблицы фактов Bitrix24 "Трудозатрата" (не из тикетов напрямую)
- Необходимо определить точные методы API и структуру данных перед началом разработки
- Связь данных: Трудозатраты → Задачи → Тикеты (тикеты могут быть созданы в другие недели)

---

## Задачи этапа

### 1. Изучение документации Bitrix24

**Источники документации:**
- https://context7.com/bitrix24/rest/ (общая документация REST API)
- https://apidocs.bitrix24.ru/ (официальная документация API)
- Раздел "Таблицы фактов" или "Time Tracking" в документации

**Что нужно найти:**
- Методы REST API для работы с таблицей фактов "Трудозатрата"
- Возможные методы: `tasks.elapseditem.getlist`, `tasks.elapseditem.get` или аналогичные
- Структура данных записей трудозатрат
- Поля: время создания, задача, сотрудник, временной промежуток
- Формат единиц измерения (секунды, минуты, часы)

### 2. Определение структуры данных

**Требуется зафиксировать:**
- Точные названия полей в API ответе:
  - Время создания записи (`CREATED_DATE`, `DATE_CREATE` или другое)
  - Задача (`TASK_ID` или другое)
  - Сотрудник (`USER_ID`, `CREATED_BY` или другое)
  - Временной промежуток (`MINUTES`, `SECONDS`, `HOURS` или другое)
- Формат единиц измерения (секунды, минуты, часы)
- Структура ответа API (JSON формат)

### 3. Изучение логики матчинга задач с тикетами

**Требуется понять:**
- Как связать задачи (`TASK_ID`) с тикетами 140 сервис деска
- Есть ли поле связи в задачах или тикетах
- Метод получения задач по `TASK_ID` из Bitrix24 API
- Метод получения тикетов, связанных с задачами

### 4. Изучение существующих модулей сектора 1С

**Что изучить:**
- Модуль "График приёма и закрытий сектора 1С" (TASK-041):
  - Логика определения недель (ISO-8601)
  - Логика фильтрации по сектору 1С
  - Структура API endpoint
- Модуль "График состояния сектора 1С":
  - Логика определения сотрудников сектора 1С
  - Структура доступа и фильтров
  - Принципы работы с данными

### 5. Определение константы отделов

**Требуется найти:**
- Какая именно константа используется для определения сектора 1С
- Где она хранится (Bitrix24, конфигурационный файл, база данных)
- Как получить список сотрудников сектора 1С через эту константу
- Используется ли та же константа, что и в других модулях

---

## Ожидаемые результаты этапа

1. **Документация по API:**
   - Зафиксирован точный метод REST API для получения записей из таблицы фактов "Трудозатрата"
   - Зафиксирована структура данных записей (поля, форматы)
   - Зафиксирован формат единиц измерения

2. **Документация по структуре данных:**
   - Описание полей записи трудозатраты
   - Описание связи задач с тикетами
   - Примеры ответов API

3. **Конспект существующих модулей:**
   - Логика определения недель (ISO-8601)
   - Логика фильтрации по сектору 1С
   - Логика определения сотрудников
   - Структура компонентов и сервисов

4. **Определение константы отделов:**
   - Найдена константа для сектора 1С
   - Описан метод получения списка сотрудников

---

## Критерии приёмки этапа

- [x] Изучена официальная документация Bitrix24 по таблице фактов "Трудозатрата"
- [x] Определён точный метод REST API для получения записей (`tasks.elapseditem.getlist`)
- [x] Зафиксирована структура данных записей (поля, форматы, единицы измерения) — требуется уточнение через тестовые запросы
- [x] Изучена логика матчинга задач с тикетами — требуется уточнить поле связи
- [x] Изучены существующие модули сектора 1С (логика недель, фильтрации, сотрудников)
- [x] Определена константа отделов для сектора 1С (ID: 366)
- [x] Создан документ с результатами анализа: `DOCS/ANALYSIS/time-tracking-api-analysis.md`

---

## Дополнительные уточнения

- При изучении документации обратить внимание на ограничения API (лимиты запросов, пагинация)
- Проверить, есть ли примеры использования API в существующем коде проекта
- Если документация неполная, можно провести тестовые запросы к API для определения структуры данных

## Примеры использования Bitrix24 API в проекте

### Работа с CRest

**Файл:** `crest.php`

**Пример использования:**
```php
require_once __DIR__ . '/../crest.php';

// Вызов метода Bitrix24 API
$result = CRest::call('crm.item.list', [
    'entityTypeId' => 140,
    'filter' => [
        '>=createdTime' => '2025-12-15 00:00:00',
        '<=createdTime' => '2025-12-21 23:59:59'
    ],
    'select' => ['id', 'title', 'stageId', 'createdTime'],
    'start' => 0
]);

if (isset($result['error'])) {
    // Обработка ошибки
    error_log("Bitrix24 API error: " . $result['error_description']);
}
```

**См. примеры в:**
- `api/graph-1c-admission-closure.php` — использование CRest::call для получения тикетов
- `api/bitrix24.php` — прокси-эндпоинт для Vue.js

### Работа с задачами (Tasks)

**Возможные методы API:**
- `tasks.task.get` — получение задачи по ID
- `tasks.task.list` — получение списка задач
- `tasks.elapseditem.getlist` — получение записей трудозатрат (требуется проверить в документации)

**Пример получения задачи:**
```php
$task = CRest::call('tasks.task.get', [
    'taskId' => 12345,
    'select' => ['*', 'UF_*']
]);
```

### Работа с тикетами (CRM Items)

**Метод:** `crm.item.list` (для сервис деска 140)

**Пример из существующего кода:**
```php
// Из api/graph-1c-admission-closure.php
$result = CRest::call('crm.item.list', [
    'entityTypeId' => 140,
    'filter' => [
        '>=createdTime' => $weekStartStr,
        '<=createdTime' => $weekEndStr,
        'UF_CRM_7_TYPE_PRODUCT' => '1C' // Фильтр по сектору 1С
    ],
    'select' => [
        'id',
        'title',
        'stageId',
        'assignedById',
        'createdTime',
        'movedTime',
        'UF_CRM_7_TYPE_PRODUCT'
    ],
    'start' => $start
]);
```

## Изучение существующих модулей

### Модуль "График приёма и закрытий сектора 1С"

**Файлы для изучения:**
- `api/graph-1c-admission-closure.php` — backend API endpoint
  - Функции: `getWeekBounds()`, `getFourWeeksBounds()`, `calculateWeekMetrics()`
  - Логика фильтрации по сектору 1С (поле `UF_CRM_7_TYPE_PRODUCT`)
  - Логика расчёта недель (ISO-8601)
- `vue-app/src/services/graph-admission-closure/admissionClosureService.js` — frontend сервис
  - Метод `getAdmissionClosureData()` — получение данных
  - Нормализация ответа API
- `vue-app/src/components/graph-admission-closure/GraphAdmissionClosureDashboard.vue` — главный компонент
  - Структура компонента
  - Обработка состояний (loading, error)
  - Навигация (breadcrumbs)

### Модуль "График состояния сектора 1С"

**Файлы для изучения:**
- `vue-app/src/components/graph-state/GraphStateDashboard.vue` — структура дашборда
- `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js` — утилиты для работы с тикетами
  - `getAssignedById(ticket)` — получение ID ответственного
  - `parseEmployeeId(value)` — нормализация ID сотрудника
  - `isZeroPointTicket(ticket, keeperId)` — проверка нулевой точки

## Константа отделов

**Файл:** `vue-app/src/config/access-config.js`

**Структура:**
```javascript
export const accessConfig = {
  allowedDepartmentIds: [
    369,    // Битрикс24 отдел
    366,    // Сектор 1С
    7,     // Голова ИТ отдела
  ],
  // ...
};
```

**Использование:**
- Отдел 366 — Сектор 1С (используется для определения сотрудников сектора 1С)
- Проверить, как в других модулях получается список сотрудников по отделу

## Тестовые запросы к API

**Для определения структуры данных можно использовать:**

1. **Прямой запрос через CRest:**
```php
// Тестовый скрипт для проверки API
require_once __DIR__ . '/crest.php';

// Попытка получить записи трудозатрат
$result = CRest::call('tasks.elapseditem.getlist', [
    'filter' => [
        '>=CREATED_DATE' => '2025-12-01',
        '<=CREATED_DATE' => '2025-12-17'
    ],
    'select' => ['*'],
    'start' => 0
]);

var_dump($result);
```

2. **Проверка логов:**
- Логи запросов к Bitrix24 находятся в `logs/YYYY-MM-DD/HH/*log.json`
- Изучить структуру ответов API из логов

## Документирование результатов

**Формат документации результатов:**

Создать файл `DOCS/ANALYSIS/time-tracking-api-analysis.md` с результатами:

```markdown
# Анализ API для модуля «Трудозатраты на Тикеты сектора 1С»

## Метод API
- Название: `tasks.elapseditem.getlist`
- Документация: [ссылка]

## Структура данных
- Поля записи: [список полей]
- Формат единиц: [секунды/минуты/часы]
- Пример ответа: [JSON пример]

## Связь с задачами
- Поле связи: `TASK_ID`
- Метод получения задачи: `tasks.task.get`

## Связь с тикетами
- Логика матчинга: [описание]
- Поле связи: [название поля]
```

## История правок

- **2025-12-17 09:30 (UTC+3, Брест):** Создан этап анализа и изучения документации
- **2025-12-17 10:40 (UTC+3, Брест):** Добавлены детали:
  - Примеры использования Bitrix24 API в проекте
  - Ссылки на существующие файлы для изучения
  - Примеры кода из существующих модулей
  - Инструкции по тестовым запросам
  - Формат документирования результатов

---

## Следующий этап

После завершения этого этапа переходить к **TASK-050-02: Backend API endpoint для получения трудозатрат**

---

## История правок

- **2025-12-17 09:30 (UTC+3, Брест):** Создан этап анализа и изучения документации

