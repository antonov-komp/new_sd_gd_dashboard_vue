# TASK-038: Попап 1-го уровня — переключение между стадиями (Vue)

**Дата создания:** 2025-12-15 12:00 (UTC+3, Брест)  
**Статус:** Завершена  
**Приоритет:** Средний  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Модуль:** График состояния сектора 1С (`EmployeeDetailsModal.vue`, `GraphStateChart.vue`)  
**Контекст:** В попапе 1-го уровня при клике на название текущей стадии нужно показать список остальных стадий (всего три) и позволить открыть попап той стадии без закрытия модального окна. Базовое поведение уровней попапа описано в `DOCS/ANALYSIS/graph-state-popup-interactive-levels-analysis.md` и `DOCS/USER-GUIDE/graph-state-sector-1c/00-overview.md` (раздел «Детализация данных»).

## Этап 1. Анализ и UX-флоу
- Зафиксировать, как сейчас открывается попап 1-го уровня из линейного/столбчатого/кругового графиков.
- Определить, как хранить/передавать идентификаторы стадий (3 стадии) и их цвета.
- Сформировать пользовательский поток: клик по названию стадии → раскрытие списка стадий → выбор другой стадии → обновление данных попапа 1-го уровня.
- Зафиксировать контекст открытия (graphType, timePoint/snapshotId, stageId, stageColorMap) — понадобится при фолбэке на REST.

## Этап 2. Данные и загрузка
- Унифицировать метод получения данных 1-го уровня по произвольной стадии в текущем контексте (слепок/метаданные графиков или REST-запрос).
- Описать фолбэк: если данных по выбранной стадии нет, показывать уведомление в попапе и не ломать текущий стейт.
- Подготовить интерфейс данных (stageId, stageName, color, employees, totalCount).
- REST-фолбэк (при отсутствии метаданных): запрос к proxy-эндпоинту с payload `{ snapshotId | timePoint, stageId, graphType }`, ожидая `stageName, totalCount, employees[]`; таймаут 10–15s.

## Этап 3. UI/UX попапа 1-го уровня
- Добавить интерактивный контрол к заголовку стадии (dropdown/лист) со списком двух альтернативных стадий, с цветными индикаторами.
- Стейт: `currentStageId`, `availableStages[]`, `isStageListOpen`; при выборе — закрывать список, показывать лоадер, обновлять заголовок/счётчик.
- Сохранить текущие элементы уровня 1 (прогресс-бары сотрудников, «Другие», хранитель).
- Лоадер и overlay в области уровня 1 на время смены стадии; disabled для текущей стадии в списке.

## Этап 4. Навигация и состояния
- При смене стадии сбрасывать данные уровней 2/3, оставляя попап открытым.
- Поддержать back/esc: ESC закрывает попап; back из уровней 2/3 остаётся в рамках выбранной стадии.
- Обработать ошибки/таймауты: уведомление в попапе, кнопка «Повторить».

## Этап 5. Тестирование и документация
- Проверить сценарии: line/bar/doughnut → попап 1-го уровня → выбор другой стадии → возвращение к исходной.
- Проверить клавиатурную доступность: TAB по списку стадий, Enter для выбора, ESC для закрытия.
- Обновить документацию (кратко): добавить описание нового UX в `DOCS/USER-GUIDE/graph-state-sector-1c/00-overview.md` (блок детализации) и ссылку на используемые REST-методы (context7.com/apidocs).
- Пройти сценарии с пустым ответом/ошибкой REST: убедиться, что старая стадия и данные сохраняются, повтор работает.

