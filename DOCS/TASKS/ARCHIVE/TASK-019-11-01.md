# TASK-019-11-01: Детализация по сотрудникам в графиках и исправление батчей

**Дата создания:** 2025-12-08 13:38 (UTC+3, Брест)  
**Статус:** Выполнена  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)

## Описание

Добавление детализации по сотрудникам в графиках состояния сектора и исправление проблемы с батчами, когда загружались только первые 50 тикетов вместо всех.

## Контекст

Пользователь запросил:
1. Добавить детализацию по сотрудникам на уровне стадий (этапов)
2. Исправить проблему с батчами - всегда показывалось 50 тикетов

## Выполненные задачи

### 1. Детализация по сотрудникам на уровне стадий

**Проблема:** В графиках не было детализации по сотрудникам. Показывалась только общая статистика по этапам.

**Решение:**
- Добавлена секция "Детализация по сотрудникам" под графиком
- Для каждого этапа отображается:
  - Название этапа с цветовым индикатором
  - Общее количество тикетов на этапе
  - Детализация: список сотрудников с количеством их тикетов на этом этапе
  - Тикеты из "Неразобранного" (Хранитель объектов, ID: 1051) для каждого этапа

**Реализованные функции:**

1. **`getStageTotalCount(stageId)`** — получает общее количество тикетов на этапе
2. **`getEmployeesForStage(stageId)`** — получает список сотрудников для этапа с количеством их тикетов, включая "Хранитель объектов"
3. **`getKeeperTicketsCountForStage(stageId)`** — получает количество тикетов хранителя объектов для конкретного этапа

**Изменения в структуре данных:**

Добавлено поле `statistics.zeroPointByStage` в нормализованный слепок:
```javascript
statistics: {
  // ... существующие поля
  zeroPointByStage: {
    formed: { keeper: number, unassigned: number, total: number },
    review: { keeper: number, unassigned: number, total: number },
    execution: { keeper: number, unassigned: number, total: number }
  }
}
```

**Функция `extractZeroPointByStage()` в `snapshot-normalizer.js`:**
- Извлекает статистику нулевой точки по этапам
- Подсчитывает тикеты хранителя (ID: 1051) и неразобранные тикеты для каждого этапа

**UI изменения:**

- Добавлена секция детализации под графиком
- Сотрудники отсортированы по убыванию количества тикетов
- "Хранитель объектов (Неразобранное)" визуально выделен оранжевым цветом
- Адаптивный дизайн для мобильных устройств

### 2. Исправление проблемы с батчами

**Проблема:** Всегда показывалось 50 тикетов, независимо от реального количества. Батчи не загружались полностью.

**Причины:**
1. Использовался кеш со старыми данными (`useCache: true`)
2. Логика пагинации не проверяла поле `next` в ответе API Bitrix24

**Решение:**

1. **Отключён кеш для графика:**
   - Изменено `useCache: true` → `useCache: false` в `GraphStateChart.vue`
   - Теперь всегда загружаются актуальные данные с полной пагинацией

2. **Исправлена логика пагинации в `TicketRepository`:**
   ```javascript
   // Было:
   hasMore = batchTickets.length === limit;
   
   // Стало:
   const hasNext = result?.result?.next !== null && 
                  result?.result?.next !== undefined && 
                  result?.result?.next !== '';
   hasMore = batchTickets.length === limit && hasNext;
   ```
   - Теперь проверяется наличие поля `next` в ответе API Bitrix24
   - Если `next` есть и не пустое, загрузка продолжается
   - Если `next` отсутствует или пустое, загрузка завершается

## Изменённые файлы

### Vue.js компоненты

1. **`vue-app/src/components/graph-state/GraphStateChart.vue`**
   - Добавлена секция детализации по сотрудникам
   - Добавлены функции `getStageTotalCount()`, `getEmployeesForStage()`, `getKeeperTicketsCountForStage()`
   - Изменено `useCache: false` для загрузки текущего состояния
   - Добавлены стили для визуального выделения хранителя объектов

### Сервисы

2. **`vue-app/src/services/graph-state/snapshot-normalizer.js`**
   - Добавлена функция `extractZeroPointByStage()` для извлечения статистики нулевой точки по этапам
   - Обновлена структура нормализованного слепка: добавлено поле `statistics.zeroPointByStage`

3. **`vue-app/src/services/dashboard-sector-1c/data/ticket-repository.js`**
   - Исправлена логика пагинации: добавлена проверка поля `next` из ответа API Bitrix24
   - Теперь корректно обрабатываются все батчи, а не только первые 50 тикетов

## Структура детализации

```
Этап: "Сформировано обращение"
├── Общее количество: 25 тикетов
└── Детализация по сотрудникам:
    ├── Иван Иванов: 10 тикетов
    ├── Петр Петров: 8 тикетов
    ├── Сидор Сидоров: 5 тикетов
    └── Хранитель объектов (Неразобранное): 2 тикета [выделено оранжевым]
```

## Технические детали

### API Bitrix24

Метод `crm.item.list` возвращает поле `next` в ответе:
```javascript
{
  result: {
    items: [...], // массив тикетов
    next: "50"    // ID следующего элемента (если есть)
  }
}
```

Если `next` присутствует и не пустое, значит есть ещё данные для загрузки.

### Структура данных zeroPointByStage

```javascript
zeroPointByStage: {
  formed: {
    keeper: 2,      // Тикеты с ответственным "Хранитель объектов" (ID: 1051)
    unassigned: 1,  // Тикеты без ответственного
    total: 3        // Общее количество тикетов в нулевой точке для этапа
  },
  review: { ... },
  execution: { ... }
}
```

## Критерии приёмки

- [x] В графиках отображается детализация по сотрудникам для каждого этапа
- [x] Показывается "Хранитель объектов (Неразобранное)" с количеством тикетов для каждого этапа
- [x] Хранитель объектов визуально выделен оранжевым цветом
- [x] Загружаются все тикеты, а не только первые 50
- [x] Пагинация работает корректно для всех батчей
- [x] Кеш отключён для графика, данные всегда актуальные
- [x] Сборка проходит без ошибок
- [x] Обратная совместимость со старыми слепками сохранена

## Тестирование

1. **Проверка детализации:**
   - Открыть график состояния
   - Проверить наличие секции "Детализация по сотрудникам"
   - Убедиться, что для каждого этапа показываются сотрудники и их тикеты
   - Проверить наличие "Хранитель объектов (Неразобранное)" для этапов с такими тикетами

2. **Проверка батчей:**
   - Создать более 50 тикетов в секторе 1С
   - Открыть график состояния
   - Убедиться, что загружаются все тикеты, а не только первые 50
   - Проверить в консоли браузера, что выполняются запросы для всех батчей

## История правок

- **2025-12-08 13:38 (UTC+3, Брест):** Создана задача и выполнена
- **2025-12-08 13:38 (UTC+3, Брест):** Добавлена детализация по сотрудникам
- **2025-12-08 13:38 (UTC+3, Брест):** Исправлена проблема с батчами
- **2025-12-08 13:38 (UTC+3, Брест):** Добавлена поддержка "Хранителя объектов" в детализации
- **2025-12-08 13:54 (UTC+3, Брест):** Задача закрыта как успешная (все задачи TASK-019 завершены)

## Связанные задачи

- TASK-019-10-01: Написание тестов для дашборда "График состояния"
- TASK-019-06-01: Разработка компонента графика состояния (GraphStateChart.vue)
- TASK-019-07-01: Реализация логики сравнения слепков и визуализации изменений

