# TASK-003: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–ª—É–∂–±—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Bitrix24

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-07 05:05 (UTC+3, –ë—Ä–µ—Å—Ç)  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–∞  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å  
**–¢–∏–ø:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–ª—É–∂–±—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Bitrix24. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –æ—Ç Bitrix24, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏—Ö, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON-—Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–∏—ë–º –∏—Å—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Bitrix24
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–æ–≤ (HMAC-SHA256)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (–ó–∞–¥–∞—á–∏, –°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å—ã)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JSON-—Ñ–∞–π–ª—ã —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —á–∞—Å–∞–º
- API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üéØ –ö–æ–Ω—Ç–µ–∫—Å—Ç

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bitrix24. –û–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ü–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Bitrix24
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã –≤–µ–±—Ö—É–∫–æ–≤
- –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞–¥–∞—á–∞—Ö –∏ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

**–°–≤—è–∑–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Vue.js –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ —á–µ—Ä–µ–∑ API
- –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –û–±—â–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
Bitrix24 ‚Üí [–ò—Å—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫] ‚Üí api/webhook-handler.php ‚Üí [–í–∞–ª–∏–¥–∞—Ü–∏—è] ‚Üí [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ] ‚Üí logs/webhooks/
                                                                                              ‚îú‚îÄ‚îÄ tasks/
                                                                                              ‚îú‚îÄ‚îÄ smart-processes/
                                                                                              ‚îî‚îÄ‚îÄ errors/
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤** (`api/webhook-handler.php`)
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç Bitrix24
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–∞
   - –ü–∞—Ä—Å–∏—Ç payload
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏—è
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ —Ñ–∞–π–ª

2. **API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤** (`api/webhook-logs.php`)
   - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API –¥–ª—è —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å–æ–±—ã—Ç–∏—é, –¥–∞—Ç–µ
   - –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é

3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤** (`logs/webhooks/`)
   - `tasks/` ‚Äî —Å–æ–±—ã—Ç–∏—è –∑–∞–¥–∞—á (ONTASK*)
   - `smart-processes/` ‚Äî —Å–æ–±—ã—Ç–∏—è —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (ONCRMDYNAMIC*)
   - `errors/` ‚Äî –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`webhook-secret.php`)
   - –•—Ä–∞–Ω–∏—Ç —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏
   - –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ git (.gitignore)

5. **–£—Ç–∏–ª–∏—Ç—ã**
   - `check-webhook-logs.php` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
/var/www/back/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ webhook-handler.php      # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ webhook-logs.php         # API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ webhooks/
‚îÇ       ‚îú‚îÄ‚îÄ tasks/               # –õ–æ–≥–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞–¥–∞—á
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2025-12-07-00.json
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2025-12-07-01.json
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îú‚îÄ‚îÄ smart-processes/    # –õ–æ–≥–∏ —Å–æ–±—ã—Ç–∏–π —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îî‚îÄ‚îÄ errors/              # –õ–æ–≥–∏ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ webhook-secret.php           # –°–µ–∫—Ä–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–Ω–µ –≤ git)
‚îî‚îÄ‚îÄ check-webhook-logs.php       # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤
```

### –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

- **–®–∞–±–ª–æ–Ω:** `YYYY-MM-DD-HH.json`
- **–ü—Ä–∏–º–µ—Ä:** `2025-12-07-00.json` (–ª–æ–≥–∏ –∑–∞ 7 –¥–µ–∫–∞–±—Ä—è 2025, —Å 00:00 –¥–æ 00:59)
- **–ü—Ä–∏–Ω—Ü–∏–ø:** –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ —á–∞—Å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞

### –®–∞–≥ 1: –ü—Ä–∏—ë–º –∑–∞–ø—Ä–æ—Å–∞

**Endpoint:** `POST /api/webhook-handler.php`

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- `Content-Type: application/x-www-form-urlencoded` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è Bitrix24)
- `X-Bitrix-Signature: <HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å>` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
- –§–æ—Ä–º–∞—Ç: URL-encoded –∏–ª–∏ JSON
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `event`, `data`

### –®–∞–≥ 2: –ü–∞—Ä—Å–∏–Ω–≥ payload

```php
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
$contentType = $_SERVER['CONTENT_TYPE'] ?? '';
$rawBody = file_get_contents('php://input');

// –ü–∞—Ä—Å–∏–Ω–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Content-Type
if (strpos($contentType, 'application/json') !== false) {
    $payload = json_decode($rawBody, true);
} else {
    // URL-encoded (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è Bitrix24)
    $payload = $_POST ?? parse_str($rawBody, $payload);
}
```

### –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏

**–ê–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –∏–∑ `webhook-secret.php` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –ü–æ–∏—Å–∫ –ø–æ–¥–ø–∏—Å–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Bitrix-Signature` –∏–ª–∏ –≤ payload
3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ HMAC-SHA256 –æ—Ç raw body —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–∞
4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ `hash_equals()` (–∑–∞—â–∏—Ç–∞ –æ—Ç timing attacks)

```php
function validateWebhookSignature($rawBody, $signature, $secret) {
    $computedSignature = hash_hmac('sha256', $rawBody, $secret);
    return hash_equals($signature, $computedSignature);
}
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏:**
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ `X-Bitrix-Signature` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–±)
2. –ü–æ–ª–µ `signature` –≤ payload
3. –ü–∞—Ä–∞–º–µ—Ç—Ä `token` –≤ URL (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)

### –®–∞–≥ 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏—è

**–ü—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏:**

```php
$category = null;
if (strpos($eventType, 'ONCRMDYNAMIC') === 0) {
    $category = 'smart-processes';
} elseif (strpos($eventType, 'ONTASK') === 0) {
    $category = 'tasks';
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:**

**–ó–∞–¥–∞—á–∏ (tasks):**
- `ONTASKADD` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `ONTASKUPDATE` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `ONTASKDELETE` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `ONTASKCOMMENTADD` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- `ONTASKCOMMENTUPDATE` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- `ONTASKCOMMENTDELETE` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è

**–°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å—ã (smart-processes):**
- `ONCRMDYNAMICITEMADD` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
- `ONCRMDYNAMICITEMUPDATE` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
- `ONCRMDYNAMICITEMDELETE` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞

### –®–∞–≥ 5: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è

**–î–ª—è —Å–æ–±—ã—Ç–∏–π –∑–∞–¥–∞—á:**
```php
if (strpos($eventType, 'ONTASK') === 0) {
    if (isset($eventData['TASK'])) {
        $details['task_id'] = $eventData['TASK']['ID'] ?? null;
        $details['task_title'] = $eventData['TASK']['TITLE'] ?? null;
        $details['created_by'] = $eventData['TASK']['CREATED_BY'] ?? null;
        $details['responsible_id'] = $eventData['TASK']['RESPONSIBLE_ID'] ?? null;
    }
    
    // –î–ª—è —Å–æ–±—ã—Ç–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    if (strpos($eventType, 'ONTASKCOMMENT') === 0) {
        $details['comment_id'] = $eventData['COMMENT']['ID'] ?? null;
        $details['comment_text'] = $eventData['COMMENT']['POST_MESSAGE'] ?? null;
        $details['task_id'] = $eventData['COMMENT']['TASK_ID'] ?? null;
    }
}
```

**–î–ª—è —Å–æ–±—ã—Ç–∏–π —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤:**
```php
if (strpos($eventType, 'ONCRMDYNAMIC') === 0) {
    $details['entity_id'] = $eventData['FIELDS']['ID'] ?? null;
    $details['title'] = $eventData['FIELDS']['TITLE'] ?? null;
    $details['entity_type_id'] = $eventData['ENTITY_TYPE_ID'] ?? null;
    
    // –î–ª—è UPDATE —Å–æ–±—ã—Ç–∏—è
    if ($eventType === 'ONCRMDYNAMICITEMUPDATE') {
        $details['changed_fields'] = array_keys($eventData['PREVIOUS_FIELDS']);
    }
}
```

### –®–∞–≥ 6: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞:**

```json
{
    "timestamp": "2025-12-07T00:00:01+03:00",
    "ip": "195.208.184.34",
    "event": "ONTASKCOMMENTADD",
    "category": "tasks",
    "payload": {
        "event": "ONTASKCOMMENTADD",
        "event_handler_id": "348",
        "data": {
            "FIELDS_BEFORE": "undefined",
            "FIELDS_AFTER": {
                "ID": "424863",
                "TASK_ID": "73799"
            },
            "IS_ACCESSIBLE_BEFORE": "N",
            "IS_ACCESSIBLE_AFTER": "undefined"
        },
        "ts": "1765054800",
        "auth": {
            "domain": "bitrix24.kompo.by",
            "client_endpoint": "https://bitrix24.kompo.by/rest/",
            "server_endpoint": "https://oauth.bitrix24.tech/rest/",
            "member_id": "abd30b4e058922b2b0876f1a439fb9cc",
            "application_token": "6ej52x0qe46wlvqgme9rqnvk10qqnn00"
        }
    },
    "details": []
}
```

**–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–∏—Å–∏:**
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É: `logs/webhooks/{category}/YYYY-MM-DD-HH.json`
2. –ß—Ç–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ –º–∞—Å—Å–∏–≤
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –≤ —Ñ–∞–π–ª —Å `LOCK_EX` (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞)

```php
function logWebhookEvent($eventType, $eventData, $category, $fullPayload, $clientIp) {
    $logDir = __DIR__ . '/../logs/webhooks/' . $category . '/';
    $logFile = $logDir . date('Y-m-d-H') . '.json';
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!is_dir($logDir)) {
        mkdir($logDir, 0755, true);
    }
    
    $logEntry = [
        'timestamp' => date('c'),
        'ip' => $clientIp,
        'event' => $eventType,
        'category' => $category,
        'payload' => $fullPayload,
        'details' => extractEventDetails($eventType, $eventData)
    ];
    
    $logs = [];
    if (file_exists($logFile)) {
        $logs = json_decode(file_get_contents($logFile), true) ?? [];
    }
    
    $logs[] = $logEntry;
    
    file_put_contents(
        $logFile,
        json_encode($logs, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE),
        LOCK_EX
    );
}
```

### –®–∞–≥ 7: –û—Ç–≤–µ—Ç Bitrix24

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
    "success": true,
    "event": "ONTASKCOMMENTADD",
    "category": "tasks",
    "timestamp": "2025-12-07T00:00:01+03:00"
}
```

**HTTP —Å—Ç–∞—Ç—É—Å:** `200 OK`

**–û—à–∏–±–∫–∞:**
```json
{
    "error": "Webhook processing failed",
    "error_description": "Missing required field: event"
}
```

**HTTP —Å—Ç–∞—Ç—É—Å:** `400 Bad Request` –∏–ª–∏ `401 Unauthorized` (–¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
- Bitrix24 –≤—ã—á–∏—Å–ª—è–µ—Ç HMAC-SHA256 –æ—Ç raw body –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–∞
- –ü–æ–¥–ø–∏—Å—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Bitrix-Signature`
- –°–µ—Ä–≤–µ—Ä –≤—ã—á–∏—Å–ª—è–µ—Ç —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø–æ–ª—É—á–µ–Ω–Ω–æ–π

**–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `hash_equals()` –≤–º–µ—Å—Ç–æ `===` (–∑–∞—â–∏—Ç–∞ –æ—Ç timing attacks)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ä–µ—Ç–∞ –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–µ–∫—Ä–µ—Ç–∞ (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):**
1. –§–∞–π–ª `webhook-secret.php` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
2. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `BITRIX24_WEBHOOK_SECRET`
3. –§–∞–π–ª `settings.json` (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

**–§–æ—Ä–º–∞—Ç `webhook-secret.php`:**
```php
<?php
return 'n7t5pttg22m1udi0cr6di7shs1f2aoke';
```

**–í–∞–∂–Ω–æ:**
- –§–∞–π–ª –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ git (.gitignore)
- –°–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ Bitrix24 –ø–æ—Ä—Ç–∞–ª–∞
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Å–µ–∫—Ä–µ—Ç –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ä—Ç–∞–ª–æ–≤

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫:**
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `logs/webhooks/errors/YYYY-MM-DD-HH.json`
- –§–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç:
  - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  - –§–∞–π–ª –∏ —Å—Ç—Ä–æ–∫–∞, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
  - Payload (–µ—Å–ª–∏ –±—ã–ª)
  - Preview raw body (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤)
  - –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –æ—à–∏–±–∫–∏:**
```json
{
    "timestamp": "2025-12-07T00:00:01+03:00",
    "error": "Missing required field: event",
    "file": "/var/www/back/api/webhook-handler.php",
    "line": 308,
    "payload": null,
    "raw_body_preview": "data[FIELDS][ID]=123",
    "content_type": "application/x-www-form-urlencoded",
    "request_method": "POST",
    "headers": {
        "X-Bitrix-Signature": null,
        "Content-Type": "application/x-www-form-urlencoded"
    }
}
```

---

## üì° API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤

### Endpoint

**URL:** `GET /api/webhook-logs.php`

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|----------|-----|----------|--------|
| `category` | string | –ö–∞—Ç–µ–≥–æ—Ä–∏—è (tasks, smart-processes, errors) | `tasks` |
| `event` | string | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | `ONTASKADD` |
| `date` | string | –î–∞—Ç–∞ (YYYY-MM-DD) | `2025-12-07` |
| `hour` | int | –ß–∞—Å (0-23) | `0` |
| `page` | int | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞—è —Å 1) | `1` |
| `limit` | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (1-1000) | `50` |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:**
```
GET /api/webhook-logs.php
```

**–ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∑–∞–¥–∞—á –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å:**
```
GET /api/webhook-logs.php?category=tasks&date=2025-12-07&hour=0
```

**–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ:**
```
GET /api/webhook-logs.php?event=ONTASKADD&page=1&limit=20
```

**–ü–æ–ª—É—á–∏—Ç—å –æ—à–∏–±–∫–∏:**
```
GET /api/webhook-logs.php?category=errors
```

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
    "success": true,
    "logs": [
        {
            "timestamp": "2025-12-07T00:00:01+03:00",
            "ip": "195.208.184.34",
            "event": "ONTASKCOMMENTADD",
            "category": "tasks",
            "payload": { ... },
            "details": { ... }
        },
        ...
    ],
    "pagination": {
        "page": 1,
        "limit": 50,
        "total": 150,
        "pages": 3
    }
}
```

**–û—à–∏–±–∫–∞:**
```json
{
    "error": "Failed to get logs",
    "error_description": "Invalid date format"
}
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã API

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –ª–æ–≥–æ–≤:**
   - –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí `logs/webhooks/{category}/`
   - –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ ‚Üí —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

2. **–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:**
   - –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: `{date}-{hour}.json`
   - –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —á–∞—Å ‚Üí —á—Ç–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
   - –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∑–∞ –¥–µ–Ω—å

3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
   - –ü–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `event`)
   - –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `category`)

4. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:**
   - –ü–æ timestamp (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)

5. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:**
   - –†–∞–∑–±–∏–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - –í–æ–∑–≤—Ä–∞—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

---

## üõ†Ô∏è –£—Ç–∏–ª–∏—Ç—ã

### check-webhook-logs.php

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
php check-webhook-logs.php
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –¥–ª—è –ª–æ–≥–æ–≤
- –ù–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π —á–∞—Å
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–µ–∫—É—â–µ–º —Ñ–∞–π–ª–µ
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö
- –ù–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- –ù–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ–∫—Ä–µ—Ç–∞ –≤–µ–±—Ö—É–∫–∞

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤–µ–±—Ö—É–∫–æ–≤ ===

–ö–∞—Ç–µ–≥–æ—Ä–∏—è: tasks
–ü–∞–ø–∫–∞: /var/www/back/logs/webhooks/tasks/
  –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: 2025-12-07-00.json
  ‚úÖ –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–ø–∏—Å–µ–π: 5
  –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∑–∞–ø–∏—Å–∏:
    [3] ONTASKADD - 2025-12-07T00:15:30+03:00
    [4] ONTASKUPDATE - 2025-12-07T00:20:45+03:00
    [5] ONTASKCOMMENTADD - 2025-12-07T00:25:10+03:00
  –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: 12
  –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∞–π–ª—ã:
    - 2025-12-07-00.json (15234 bytes, 2025-12-07 00:30:15)
    - 2025-12-06-23.json (12345 bytes, 2025-12-06 23:59:59)
    ...

=== –û–®–ò–ë–ö–ò ===
–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ (–∏–∑ 2025-12-07-00.json):
  - Invalid JSON: Syntax error
    –í—Ä–µ–º—è: 2025-12-07T00:10:20+03:00

=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ===
‚úÖ –¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω: n7t5pttg22...
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã

**–ß—Ç–æ –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- IP-–∞–¥—Ä–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

1. **–†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫:**
   ```bash
   php check-webhook-logs.php
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤:**
   - –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–±—ã—Ç–∏–π —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç —Ä–∞—Å—Ç–∏
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–æ—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ endpoint:**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ health-check –¥–ª—è `/api/webhook-handler.php`
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞

4. **–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å–æ–±—ã—Ç–∏–π:**
   - –ü–æ–∏—Å–∫ –∞–Ω–æ–º–∞–ª–∏–π –≤ —á–∞—Å—Ç–æ—Ç–µ —Å–æ–±—ã—Ç–∏–π
   - –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ Bitrix24

**–®–∞–≥–∏:**
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º** ‚Üí **–î—Ä—É–≥–æ–µ** ‚Üí **–ò—Å—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏**
2. –ù–∞–∂–∞—Ç—å **–î–æ–±–∞–≤–∏—Ç—å –≤–µ–±—Ö—É–∫**
3. –£–∫–∞–∑–∞—Ç—å:
   - **URL:** `https://your-domain.com/api/webhook-handler.php`
   - **–°–æ–±—ã—Ç–∏—è:** –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–ó–∞–¥–∞—á–∏, –°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å—ã)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ–±—Ö—É–∫
5. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (—Å–µ–∫—Ä–µ—Ç) –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–µ–±—Ö—É–∫–∞
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ `webhook-secret.php`

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Bitrix24:**
- https://context7.com/bitrix24/rest/webhook/
- https://apidocs.bitrix24.ru/rest_help/general/webhooks/index.php

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

**–ü–∞–ø–∫–∏ –ª–æ–≥–æ–≤:**
```bash
chown -R www-data:www-data /var/www/back/logs/webhooks/
chmod -R 755 /var/www/back/logs/webhooks/
```

**–§–∞–π–ª —Å–µ–∫—Ä–µ—Ç–∞:**
```bash
chmod 600 /var/www/back/webhook-secret.php
chown www-data:www-data /var/www/back/webhook-secret.php
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```bash
export BITRIX24_WEBHOOK_SECRET="your_secret_here"
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

**1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—ë–º–∞ –≤–µ–±—Ö—É–∫–∞:**
```bash
curl -X POST https://your-domain.com/api/webhook-handler.php \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "event=ONTASKADD&data[TASK][ID]=123&data[TASK][TITLE]=Test"
```

**2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏:**
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç `401 Unauthorized`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

**3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ `logs/webhooks/tasks/`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞

**4. –ü—Ä–æ–≤–µ—Ä–∫–∞ API:**
```bash
curl "https://your-domain.com/api/webhook-logs.php?category=tasks&date=2025-12-07"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Bitrix24

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è:**
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Bitrix24
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞ `ONTASKADD`
3. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞ `ONTASKCOMMENTADD`

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Bitrix24

- **REST API - –í–µ–±—Ö—É–∫–∏:** https://context7.com/bitrix24/rest/webhook/
- **REST API - –°–æ–±—ã—Ç–∏—è:** https://context7.com/bitrix24/rest/events/
- **–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://apidocs.bitrix24.ru/rest_help/general/webhooks/index.php

### –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞

- **TASK-003-01:** PHP handler –¥–ª—è –ø—Ä–∏—ë–º–∞ –≤–µ–±—Ö—É–∫–æ–≤
- **TASK-003-02:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–µ–±—Ö—É–∫–æ–≤ –≤ JSON —Ñ–∞–π–ª—ã
- **TASK-003-03:** –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π
- **GUIDES/webhook-setup.md:** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –≤–µ–±—Ö—É–∫–∞ Bitrix24
- **GUIDES/webhook-troubleshooting.md:** –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –≤–µ–±—Ö—É–∫–∞–º–∏

---

## üîÑ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–±—ã—Ç–∏–π

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è –≤ `api/webhook-handler.php`:
   ```php
   if (strpos($eventType, 'ONCRM') === 0) {
       $category = 'crm';
   }
   ```

2. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤:
   ```bash
   mkdir -p logs/webhooks/crm/
   ```

3. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `extractEventDetails()` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏–π

4. –û–±–Ω–æ–≤–∏—Ç—å API `webhook-logs.php` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

**–ü—Ä–∏–º–µ—Ä:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```php
// –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
if ($category === 'tasks' && $eventType === 'ONTASKADD') {
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    processNewTask($eventData);
}

// –ó–∞—Ç–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logWebhookEvent($eventType, $eventData, $category, $payload, $clientIp);
```

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫

- **2025-12-07 05:05 (UTC+3, –ë—Ä–µ—Å—Ç):** –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–ª—É–∂–±—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Bitrix24

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- [x] –û–ø–∏—Å–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞
- [x] –û–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
- [x] –û–ø–∏—Å–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤
- [x] –û–ø–∏—Å–∞–Ω—ã —É—Ç–∏–ª–∏—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [x] –£–∫–∞–∑–∞–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Bitrix24
- [x] –û–ø–∏—Å–∞–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- **TASK-003-01:** PHP handler –¥–ª—è –ø—Ä–∏—ë–º–∞ –≤–µ–±—Ö—É–∫–æ–≤
- **TASK-003-02:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–µ–±—Ö—É–∫–æ–≤ –≤ JSON —Ñ–∞–π–ª—ã
- **TASK-003-03:** –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π
- **TASK-003-04:** Vue.js –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤

