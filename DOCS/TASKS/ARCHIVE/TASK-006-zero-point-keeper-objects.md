# TASK-006: Расширение логики нулевой точки для тикетов с ответственным "Хранитель объектов" (1051)

**Дата создания:** 2025-12-06 13:12 (UTC+3, Брест)  
**Статус:** Завершена  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)

---

## Описание

Расширить логику определения нулевой точки в дашборде сектора 1С. Помимо тикетов без назначенного сотрудника, в нулевую точку должны попадать тикеты с ответственным **1051 "Хранитель объектов"**.

**Текущая логика:**
- Нулевая точка = тикеты без назначенного сотрудника (`assignedById === null`)

**Новая логика:**
- Нулевая точка = тикеты без назначенного сотрудника ИЛИ тикеты с ответственным 1051 (Хранитель объектов)

---

## Контекст

В дашборде сектора 1С есть блок "Нулевая точка" — это нулевое хранение тикетов на уровне дизайна. На уровне элементов тикета это соответствует ответственному **1051 "Хранитель объектов"**.

**Бизнес-логика:**
- Если в стадии найден тикет с ответственным 1051 (Хранитель объектов), его тикеты должны складываться в Нулевую точку на уровне дизайна
- Тикеты с ответственным 1051 не должны отображаться в колонках сотрудников
- Тикеты с ответственным 1051 должны отображаться только в нулевой точке соответствующего этапа
- **Сотрудник с ID 1051 не должен отображаться в рендере стадий** (не должен быть в списке сотрудников этапа)

**Связь с существующим кодом:**
- Логика определения нулевой точки находится в `vue-app/src/services/dashboard-sector-1c/groupers/ticket-grouper.js`
- Функция `getZeroPointTickets()` определяет, какие тикеты попадают в нулевую точку
- Функция `groupTicketsByStages()` распределяет тикеты по этапам и сотрудникам

---

## Модули и компоненты

### Файлы для изменения:

1. **`vue-app/src/services/dashboard-sector-1c/groupers/ticket-grouper.js`**
   - Функция `getZeroPointTickets()` — добавить проверку на ответственного 1051
   - Функция `groupTicketsByStages()` — исключить тикеты с ответственным 1051 из колонок сотрудников
   - Функция `groupTicketsByStages()` — исключить самого сотрудника с ID 1051 из списка сотрудников этапа (чтобы он не рендерился в колонках)

2. **`vue-app/src/services/dashboard-sector-1c/index.js`** (опционально)
   - Проверить, что логика корректно используется в `getSectorData()`

3. **`vue-app/src/components/dashboard/ZeroPoint.vue`** (опционально)
   - Обновить описание компонента, если нужно

### Константы:

- **ID ответственного "Хранитель объектов":** `1051`
- Константу можно вынести в отдельный файл конфигурации или добавить в существующий

---

## Зависимости

### От других задач:
- **TASK-005** — дашборд сектора 1С должен быть реализован и работать

### От модулей:
- `ticket-grouper.js` — логика группировки тикетов
- `ticket-mapper.js` — маппинг тикетов (если нужно)

---

## Ступенчатые подзадачи

Задача разбита на отдельные подзадачи с детальными описаниями:

1. **TASK-006-01:** Обновление функции `getZeroPointTickets()` для включения тикетов с ответственным 1051
   - Добавить проверку на `assignedById === 1051`
   - Обновить комментарии и документацию

2. **TASK-006-02:** Обновление функции `groupTicketsByStages()` для исключения тикетов с ответственным 1051 из колонок сотрудников
   - Добавить фильтрацию тикетов с `assignedById === 1051`
   - Убедиться, что такие тикеты не попадают в колонки сотрудников
   - **Исключить самого сотрудника с ID 1051 из списка сотрудников этапа** (чтобы он не отображался в рендере стадий)

3. **TASK-006-03:** Добавление константы и обновление документации
   - Создать константу для ID "Хранитель объектов" (1051)
   - Обновить комментарии в коде
   - Обновить документацию в DOCS/

4. **TASK-006-04:** Тестирование и проверка работы
   - Проверить отображение тикетов с ответственным 1051 в нулевой точке
   - Проверить, что тикеты с ответственным 1051 не отображаются в колонках сотрудников
   - Проверить работу Drag & Drop для тикетов из нулевой точки

---

## API-методы Bitrix24

### Используемые методы:

1. **`crm.item.list`** — получение списка тикетов
   - Документация: https://context7.com/bitrix24/rest/crm.item.list
   - Параметры: `filter`, `select`, `order`
   - Поле `assignedById` (или `ASSIGNED_BY_ID`) содержит ID ответственного

2. **`crm.item.get`** — получение детальной информации о тикете
   - Документация: https://context7.com/bitrix24/rest/crm.item.get
   - Параметры: `id`
   - Используется для проверки ответственного тикета

---

## Технические требования

### Версии:
- **Vue.js:** 3.x (Composition API)
- **Bitrix24 REST API:** актуальная версия

### Логика определения нулевой точки:

**Текущая логика:**
```javascript
// Тикеты без назначенного сотрудника
tickets.filter(t => !(t.assignedById || t.ASSIGNED_BY_ID))
```

**Новая логика:**
```javascript
// Тикеты без назначенного сотрудника ИЛИ с ответственным 1051
const KEEPER_OBJECTS_ID = 1051;
tickets.filter(t => {
  const assignedById = t.assignedById || t.ASSIGNED_BY_ID;
  return !assignedById || parseInt(assignedById) === KEEPER_OBJECTS_ID;
})
```

### Ограничения:
- Не изменять логику работы с другими ответственными
- Сохранить обратную совместимость с существующим кодом
- Тикеты с ответственным 1051 должны обрабатываться так же, как тикеты без ответственного

---

## Критерии приёмки

- [x] Функция `getZeroPointTickets()` обновлена и включает тикеты с ответственным 1051
- [x] Функция `groupTicketsByStages()` исключает тикеты с ответственным 1051 из колонок сотрудников
- [x] Функция `groupTicketsByStages()` исключает самого сотрудника с ID 1051 из списка сотрудников этапа
- [x] Тикеты с ответственным 1051 отображаются только в нулевой точке соответствующего этапа
- [x] Тикеты с ответственным 1051 не отображаются в колонках сотрудников
- [x] Сотрудник с ID 1051 не отображается в рендере стадий (не рендерится в колонках)
- [x] Константа для ID "Хранитель объектов" (1051) создана и используется
- [x] Комментарии в коде обновлены
- [x] Документация обновлена
- [x] Тестирование пройдено успешно
- [x] Обратная совместимость сохранена (тикеты без ответственного работают как раньше)
- [x] Код соответствует стандартам Vue.js и PSR-12 (для комментариев)

---

## Тестирование

### Функциональное тестирование:

1. **Проверка отображения тикетов с ответственным 1051 в нулевой точке:**
   - Создать или найти тикет с ответственным 1051 в стадии "Сформировано обращение"
   - Открыть дашборд сектора 1С
   - Проверить, что тикет отображается в нулевой точке этапа "Сформировано обращение"
   - Проверить, что тикет НЕ отображается в колонках сотрудников

2. **Проверка тикетов без ответственного:**
   - Создать или найти тикет без ответственного
   - Проверить, что тикет отображается в нулевой точке (как раньше)

3. **Проверка тикетов с другими ответственными:**
   - Создать или найти тикет с ответственным (не 1051)
   - Проверить, что тикет отображается в колонке соответствующего сотрудника
   - Проверить, что тикет НЕ отображается в нулевой точке

4. **Проверка Drag & Drop:**
   - Перетащить тикет с ответственным 1051 из нулевой точки на сотрудника
   - Проверить, что тикет переместился в колонку сотрудника
   - Проверить, что тикет исчез из нулевой точки

### Интеграционное тестирование:

1. Проверить загрузку данных из Bitrix24 REST API
2. Проверить корректность маппинга полей `assignedById` и `ASSIGNED_BY_ID`
3. Проверить работу с кешем (если тикеты кешируются)

---

## Примеры кода

### Пример 1: Обновлённая функция `getZeroPointTickets()`

```javascript
/**
 * Получение тикетов нулевой точки
 * 
 * Нулевая точка включает:
 * - Тикеты без назначенного сотрудника (assignedById === null)
 * - Тикеты с ответственным 1051 (Хранитель объектов)
 * 
 * @param {Array} tickets - Массив тикетов
 * @returns {object} Объект с тикетами для каждого этапа
 */
export function getZeroPointTickets(tickets) {
  const KEEPER_OBJECTS_ID = 1051; // ID ответственного "Хранитель объектов"
  
  const zeroPointTickets = {
    formed: [],
    review: [],
    execution: []
  };

  if (!Array.isArray(tickets)) {
    console.warn('Tickets is not an array in getZeroPointTickets:', tickets);
    return zeroPointTickets;
  }

  // Тикеты без назначенного сотрудника ИЛИ с ответственным 1051
  tickets
    .filter(t => {
      const assignedById = t.assignedById || t.ASSIGNED_BY_ID;
      const employeeId = assignedById ? parseInt(assignedById) : null;
      
      // Попадают в нулевую точку:
      // 1. Тикеты без ответственного
      // 2. Тикеты с ответственным 1051 (Хранитель объектов)
      return !employeeId || employeeId === KEEPER_OBJECTS_ID;
    })
    .forEach(ticket => {
      const stageId = mapStageId(ticket.stageId || ticket.STAGE_ID || '');
      if (zeroPointTickets[stageId]) {
        zeroPointTickets[stageId].push(mapTicket(ticket));
      }
    });

  return zeroPointTickets;
}
```

### Пример 2: Обновлённая функция `groupTicketsByStages()`

```javascript
/**
 * Группировка тикетов по этапам
 * 
 * Исключает тикеты с ответственным 1051 из колонок сотрудников.
 * Также исключает самого сотрудника с ID 1051 из списка сотрудников этапа.
 * Такие тикеты попадают в нулевую точку через getZeroPointTickets().
 * 
 * @param {Array} tickets - Массив тикетов из Bitrix24
 * @param {Array} employees - Массив сотрудников
 * @returns {Array} Массив этапов с тикетами
 */
export function groupTicketsByStages(tickets, employees) {
  const KEEPER_OBJECTS_ID = 1051; // ID ответственного "Хранитель объектов"
  
  // Проверяем, что tickets - массив
  if (!Array.isArray(tickets)) {
    console.warn('Tickets is not an array:', tickets);
    tickets = [];
  }

  // Проверяем, что employees - массив
  if (!Array.isArray(employees)) {
    console.warn('Employees is not an array:', employees);
    employees = [];
  }

  // Исключаем сотрудника с ID 1051 (Хранитель объектов) из списка сотрудников
  // Он не должен отображаться в колонках, только в нулевой точке
  const filteredEmployees = employees.filter(emp => {
    const empId = emp.id ? parseInt(emp.id) : null;
    return empId !== KEEPER_OBJECTS_ID;
  });

  const stages = [
    {
      id: 'formed',
      name: 'Сформировано обращение',
      color: '#007bff',
      employees: filteredEmployees.map(emp => ({ ...emp, tickets: [] }))
    },
    // ... остальные этапы ...
  ];
  
  // Распределяем тикеты по этапам и сотрудникам
  tickets.forEach(ticket => {
    const stageId = mapStageId(ticket.stageId || ticket.STAGE_ID || '');
    const stage = stages.find(s => s.id === stageId);
    
    if (stage) {
      const assignedById = ticket.assignedById || ticket.ASSIGNED_BY_ID || null;
      const employeeId = assignedById ? parseInt(assignedById) : null;
      
      // Пропускаем тикеты с ответственным 1051 (они попадают в нулевую точку)
      if (employeeId === KEEPER_OBJECTS_ID) {
        return; // Пропускаем этот тикет
      }
      
      if (employeeId) {
        // ... существующий код для распределения по сотрудникам ...
      }
    }
  });

  return stages;
}
```

---

## История правок

- **2025-12-06 13:12 (UTC+3, Брест):** Создана задача TASK-006 для расширения логики нулевой точки
- **2025-12-06 13:24 (UTC+3, Брест):** Добавлено исключение сотрудника с ID 1051 из списка сотрудников этапа (чтобы он не рендерился в колонках стадий)
- **2025-12-06 13:33 (UTC+3, Брест):** Задача успешно завершена. Все изменения реализованы и протестированы. Функциональность работает корректно.

---

**Автор:** Технический писатель  
**Статус:** Завершена ✅

