# TASK-065: Рефакторинг `api/graph-1c-admission-closure.php` на слои и отдельный модуль

**Дата создания:** 2025-12-23 00:00 (UTC+3, Брест)  
**Статус:** Завершён  
**Приоритет:** Высокий  
**Исполнитель:** Рефактор-менеджер / Технический писатель (для планирования), далее — команда разработки  
**Дата завершения недельного режима:** 2025-12-23 (UTC+3, Брест)  
**Дата завершения месячного режима:** 2025-12-23 (UTC+3, Брест)  
**Дата завершения задачи:** 2025-12-23 (UTC+3, Брест)  

## Цель
Перенести монолитный endpoint `api/graph-1c-admission-closure.php` в отдельную папку модуля, разделить на слои (bootstrap → controller → service → bitrix-client → domain → cache → util → config), сохранив текущий контракт API и функционал (weeks/months, debug, кеш, carryover/new/closed метрики, стадии).

## Контекст
- Текущий файл ~2800 строк, содержит смешанную логику: парсинг входа, расчёты дат, вызовы Bitrix24, агрегация метрик, кеш, логирование, формирование ответа.
- Нужна модульность для сопровождения: легче локализовать баги, тестировать слои, переиспользовать дату/агрегации, упростить смену Bitrix24-клиента.
- Контракт ответа (meta + data + debug) должен остаться неизменным.

## Область работ
- Только модуль графика приёма/закрытий 1С.  
- API поведение не меняем: входные параметры (`periodMode`, `includeTickets`, `includeCarryoverTickets*`, `includeNewTicketsByStages`, `forceRefresh`, `debug`) и выходной JSON идентичны.  
- Логи и кеш — сохранить, но перенести в слой.

## План работ (10 этапов, кодовые номера 65-x)

### 65-1. Инвентаризация и фиксация контракта
- Выписать вход/выход (формат meta/data/debug, ключи series/weeksData/stagesByWeek/responsible, поля carryoverDebug).
- Зафиксировать используемые флаги и дефолты (`periodMode=weeks`, `include*`, `forceRefresh`, `debug`).
- Зафиксировать зависимости: `CRest`, `GraphAdmissionClosureCache`, хардкоды стадий/keeperId/pageSize, категории длительности.
- Артефакт: `DOCS/ANALYSIS/graph-admission-closure-spec.md` (кратко, без изменений логики).

### 65-2. Проект структуры модуля
- Создать схему каталогов `api/graph-admission-closure/` (или `api/graph/admission-closure/`):
  - `bootstrap.php` (входная точка), `controller/`, `service/`, `bitrix/`, `domain/`, `cache/`, `config/`, `util/`.
- Согласовать именование классов и файлов (PSR-4 или require_once).
- Артефакт: мини-ADR/решение в spec.md + скелет папок (пустые файлы-заглушки).

### 65-3. Конфигурация и константы
- Вынести стадии, цвета, `keeperId`, `pageSize`, `durationCategories`, product-фильтр в `config/Config.php`.
- Заменить хардкоды на обращения к конфигу.
- Без изменения поведения/значений.

### 65-4. Утилиты дат и периодов
- Перенести функции дат: `getWeekBounds`, `getFourWeeksBounds`, `calculateLastFourMonths`, `calculateWeeksInMonth`, `isInRange`, `calculateDurationCategory` в `util/DatePeriodHelper.php`.
- Покрыть weeks/months режим, без побочных эффектов.

### 65-5. Слой доступа к Bitrix24
- Создать `bitrix/BitrixClient.php`, инкапсулировать вызовы `CRest`, параллельные запросы, пагинацию.
- Методы: `fetchCreatedTickets(period)`, `fetchClosedTickets(period, closingStages)`, `fetchCarryoverTickets(targetStages, endDate)`.
- Единая обработка ошибок/логов; контракт данных оставить как сейчас (массивы items).

### 65-6. Доменная агрегация
- Вынести расчёт метрик в `domain/Aggregator.php` и DTO/массивы (`WeekMetrics`).
- Логика `calculateWeekMetrics`, месячная агрегация, разбивка carryover (this/prev/older), стадии/ответственные.
- Чистые функции: без ввода/вывода, кроме условных логов debug.

### 65-7. Сервисный слой (orchestration)
- `service/GraphAdmissionClosureService.php`: валидация входа → выбор режима (weeks/months) → загрузка данных через BitrixClient → агрегация → ответ.
- Интеграция с кеш-слоем; единая точка сценария.

### 65-8. Кеш и логирование
- Перенести `GraphAdmissionClosureCache` в `cache/CacheStore.php`, сохранить ключи/TTL/clearExpired.
- Подключить из сервиса; оставить формат ответа идентичным.
- Логи централизовать через helper (но уровни/сообщения оставить эквивалентными).

### 65-9. Входная точка/контроллер
- Создать тонкий `bootstrap.php` в новой папке: хедеры, чтение тела, вызов сервиса, `jsonResponse`, обработка ошибок.
- Старый файл `graph-1c-admission-closure.php` оставить прокси или заменить на require новой точки (для совместимости путей).

### 65-10. Сверка функционала и обратная совместимость
- Прогнать контрольные запросы (weeks + months, c/без include*, forceRefresh, debug) до/после — сравнить JSON (ключи/значения).
- Проверить кеш-хиты/промахи, carryover sums (this+prev+older = total), series длины.
- Обновить `spec.md` итогами; описать, что контракт не изменён.

## Критерии приёмки
- Контракт API (ключи/структура/дефолты) не изменён; сравнение ответов на фиктивных данных совпадает.
- Логи и кеш работают как до рефактора.
- Код разделён на слои в новой папке; старый путь запроса остаётся рабочим (прокси/require).
- Документация (spec + краткая схема модулей) обновлена.

## Зависимости / риски
- Требуется аккуратное копирование логики агрегации (особенно carryover breakdown и series).
- Параллельные запросы к Bitrix24 — сохранить fallback и обработку expired_token.
- Время выполнения не должно увеличиться (проверить на выборке).

## Последующие подзадачи
- По каждому этапу 65-x завести отдельный таск/подзадачу с чек-листом и тестами.

## Детальная документация
- **`TASK-065-10-stages-detailed.md`** — детальное описание всех 10 этапов с задачами, артефактами и критериями завершения
- **`TASK-067-remove-dead-code.md`** — задача на удаление мёртвого кода из legacy файла

