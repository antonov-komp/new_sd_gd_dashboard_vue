# TASK-040: Сортировка «По заказчикам» в попапе «По сотрудникам» (График состояния сектора 1С)

**Дата создания:** 2025-12-15 12:30 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)

## Цель
Добавить второй подвид сортировки «По заказчикам» в попап уровня 1 режима «По сотрудникам» модуля «График состояния сектора 1С», с переходом к тикетам по выбранному заказчику для выбранного сотрудника, аналогично уже существующему попапу «По заказчикам».

## Контекст
- Текущий попап уровня 1 в режиме «По сотрудникам» имеет сортировку «по времени» и далее показывает тикеты сотрудника.  
- Требуется на том же уровне (до перехода на тикеты) дать альтернативный режим сортировки — «по заказчикам» выбранного сотрудника.  
- Источник заказчика в тикете: поле `UF_CRM_7_DEPARTMENT_HEAD`. Логика идентификации уже используется в попапе «По заказчикам» (история выполненных работ).
- UI: переключатель режимов должен быть размещён правее чипа стадии в попапе; кнопка более заметная (CTA) для выбора режима.

## Требования
1. UI-переключатель режима сортировки
   - Разместить правее чипа стадии в попапе уровня 1 (режим «По сотрудникам»).
   - Варианты: «По времени» (текущий), «По заказчикам» (новый) — табы/кнопки, явный selected-state.
   - Визуальный акцент: сделать CTA (контрастный фон/бордер, hover/active), сохранить общую палитру/скругления модуля; не ломать мобильную вёрстку (wrap/stack).
2. Режим «По заказчикам» для выбранного сотрудника
   - Группировка/сортировка тикетов сотрудника по заказчикам (`UF_CRM_7_DEPARTMENT_HEAD`), по аналогии с существующим попапом «По заказчикам».
   - Отображение списка заказчиков с агрегированными данными (кол-во тикетов; при наличии — имя/ид заказчика, возможно отдел), формат данных как в текущем попапе «По заказчикам».
   - Переход при выборе заказчика к списку тикетов, отфильтрованных по выбранному сотруднику + выбранному заказчику.
3. Совместимость и навигация
   - Не ломать текущую сортировку «по времени».
   - Состояние/роутинг попапов должен корректно переключаться между подрежимами.
   - Обработка ошибок/пустых данных (нет заказчиков для сотрудника) — показать понятное сообщение/нулевой стейт.

## Детализация UI/UX
- Размещение: переключатель (табы/кнопки) справа от чипа стадии, в одной горизонтальной линии; при узкой ширине — допускается перенос в следующую строку без наложений.
- Состояния: default, hover, active/selected, disabled (если данные не загружены).
- CTA-акцент: контрастный фон или бордер, сохраняя брендовые цвета модуля (использовать текущую палитру попапа).
- Список заказчиков: аналогично попапу «По заказчикам» — строки/карточки с названием заказчика, количеством тикетов; кликабельная вся строка (не только текст).
- Нулевой стейт: лаконичное сообщение + кнопка «Обновить» (reuse текущего паттерна retry).
- Адаптив: проверить ширины, чтобы кнопки не сжимались до нечитаемости; текст переносится.

## Детализация данных
- Поле заказчика: `UF_CRM_7_DEPARTMENT_HEAD` в сущности тикета; если null/пусто — показывать «Не указан».
- Группировка: собрать тикеты выбранного сотрудника, сгруппировать по значению поля; посчитать count.
- Формат элементов списка заказчиков (пример, на основе существующего попапа):
  - `id` (значение UF)
  - `name`/`label` (отформатированное имя заказчика)
  - `count` (кол-во тикетов)
  - опционально: `department/branch` если уже используется в попапе «По заказчикам».
- Переход к тикетам: фильтр = { employeeId, customerId }, сортировки/пагинация тикетов — как в текущем списке тикетов попапа.

## Навигация и состояние
- Источник стейта: локальный стейт попапа уровня 1 (GraphStateChart.vue) либо Vuex/композиция — согласовать с текущим подходом.
- Подрежимы: `byTime` (default), `byCustomer`. Переключение не должно сбрасывать выбранного сотрудника/стадию.
- Закрытие попапа: сбрасывает подрежим к default (`byTime`), чтобы не влиять на следующий запуск (если так принято).
- Ошибки загрузки: показать сообщение в контентной области + кнопка «Повторить»; лог в консоль dev.

## Модули и компоненты (предварительно)
- `vue-app/src/components/graph-state/GraphStateChart.vue` — логика попапа/переключателя режимов.
- `vue-app/src/utils/graph-state/stageLevel1Loader.js` — загрузка данных для попапа уровня 1 (сотрудники/тикеты).
- Компоненты/утилиты попапа «По заказчикам» (по месту) — переиспользование логики группировки по `UF_CRM_7_DEPARTMENT_HEAD`.
- Стили попапа/кнопок (локально в компоненте или общие стили модуля).

## Подзадачи
1. Изучить текущий флоу попапа «По сотрудникам» и существующий попап «По заказчикам»: где формируются данные, как определяется `UF_CRM_7_DEPARTMENT_HEAD`, как реализован переход к тикетам.
2. Добавить UI-переключатель «По времени / По заказчикам» в попап уровня 1 (правее чипа стадии), оформить CTA.
3. Реализовать режим «По заказчикам» для выбранного сотрудника:
   - Группировка тикетов сотрудника по `UF_CRM_7_DEPARTMENT_HEAD`.
   - Отрисовка списка заказчиков с ключевыми метриками (как в текущем попапе «По заказчикам»).
4. Добавить переход: выбор заказчика → список тикетов с фильтром (employee + customer).
5. Обработать нулевой стейт и ошибки загрузки; не ломать режим «по времени».
6. Протестировать переключение режимов, загрузку данных, переход к тикетам, отсутствие регрессий.

## Технические детали
- Поле заказчика: `UF_CRM_7_DEPARTMENT_HEAD` (использовать существующую логику из попапа «По заказчикам»). Если поле отсутствует/пусто — заказчик считается «Не указан».
- Структура данных для списка заказчиков: переиспользовать текущий формат (id, name/label, count, опционально департамент/отдел). Проверить, что фильтр employeeId + customerId передаётся далее в загрузку тикетов.
- UI-кнопка переключения должна быть визуально выделена (CTA), но соответствовать стилю модуля (цвета/радиус/шрифт); добавить hover/active/focus.
- Состояние выбранного подрежима хранить рядом с состоянием попапа уровня 1; сброс при закрытии попапа.
- Требуется сохранить совместимость с текущими данными и контрактом попапов; при необходимости расширить контракт аккуратно (добавить optional поле, не ломая вызовы).
- Нулевой стейт: «Для выбранного сотрудника заказчики не найдены» + повторная попытка/обновление данных.
- Ошибки загрузки: отобразить unobtrusive сообщение в попапе; логировать в консоль (dev), не блокировать закрытие попапа.

## API-методы Bitrix24 (референс для данных тикетов)
- Используются те же источники, что и в текущем модуле; дополнительных REST-вызовов не требуется, если данные уже загружены для попапа сотрудника. При необходимости свериться с существующей реализацией загрузки тикетов (см. `stageLevel1Loader.js` и связанные сервисы).

## Критерии приёмки
- [ ] В попапе «По сотрудникам» появился переключатель «По времени / По заказчикам» справа от чипа стадии, визуально заметен (CTA), корректно работает hover/active.
- [ ] Режим «По заказчикам» показывает список заказчиков для выбранного сотрудника, данные соответствуют группировке по `UF_CRM_7_DEPARTMENT_HEAD`, как в существующем попапе «По заказчикам».
- [ ] При выборе заказчика открывается список тикетов, отфильтрованных по выбранному сотруднику и выбранному заказчику; список отображается в текущем формате карточек тикетов.
- [ ] Режим «по времени» работает как раньше; переключение между подрежимами не ломает навигацию попапов и не меняет выбранного сотрудника/стадию.
- [ ] Нулевой стейт и ошибки загрузки обрабатываются (сообщение + retry), нет новых ошибок в консоли.
- [ ] Адаптив: кнопки/табы читаемы на узких ширинах, список заказчиков и тикетов не ломает верстку.

## Тестирование
1. Открыть попап уровня 1 в режиме «По сотрудникам» → увидеть переключатель справа от чипа стадии.
2. Проверить режим «По времени»: отображается как раньше, переход к тикетам работает.
3. Переключить в «По заказчикам»: загрузка списка заказчиков, корректные названия и counts.
4. Клик по заказчику → открывается список тикетов с фильтром (employee + customer); сравнить count с агрегатом.
5. Нулевой стейт: выбрать сотрудника без заказчиков → показать сообщение и retry, без падений.
6. Ошибки (симулировать): показать сообщение, консоль без необработанных исключений.
7. Адаптив: сужение контейнера — кнопки не накладываются, текст переносится, список кликабелен.
8. Регрессия: возврат в «По времени» после «По заказчикам» не ломает стейт, закрытие/открытие попапа возвращает default-подрежим.

## Риски и примечания
- Возможные расхождения контрактов данных между попапом «По сотрудникам» и «По заказчикам» — согласовать формат (id/label/count) и не ломать существующие вызовы.
- Объём данных по заказчикам может быть большим; при необходимости — виртуальный скролл или lazy, но по умолчанию используем текущее поведение попапа «По заказчикам».
- Следить за производительностью группировки на клиенте; если источник уже агрегирован — использовать готовые данные.

## Вопросы/ответы
- Нужно ли добавить визуальные подсказки (иконка/текст) для различия режимов «по времени» и «по заказчикам»? (по умолчанию — текстовые табы/кнопки).
- Есть ли ограничения на количество заказчиков в списке (пагинация/скролл) или используем текущее поведение попапа «По заказчикам»?


