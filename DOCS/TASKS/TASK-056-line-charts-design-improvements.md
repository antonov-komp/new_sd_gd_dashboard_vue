# TASK-056: Улучшение дизайна линейных графиков модуля "График приема и закрытий сектора 1С"

**Дата создания:** 2025-12-17 14:27 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связанные модули:** 
- График приёма и закрытий сектора 1С (TASK-041) — базовый модуль
- TASK-052: Разделение линейного графика на две части — текущая реализация
- TASK-048: Линейный график за 4 недели — текущая реализация

---

## Цель

Улучшить визуальный дизайн линейных графиков модуля «График приёма и закрытий сектора 1С» для повышения читаемости, информативности и эстетической привлекательности. Улучшения должны применяться к обоим графикам (Новые/Закрытые и Переходящие).

---

## Контекст

**Текущее состояние:**
- Два линейных графика расположены рядом (TASK-052)
- Левый график: «Новые и Закрытые тикеты» (4 серии)
- Правый график: «Переходящие тикеты» (3 серии)
- Графики работают с данными за 4 недели
- Используется Chart.js с Vue.js
- Базовые настройки визуализации (линии, tooltips, легенда)

**Проблемы текущего дизайна:**
1. Линии графика выглядят плоскими, нет визуальной глубины
2. Tooltips содержат базовую информацию, можно улучшить форматирование
3. Легенда занимает много места, можно оптимизировать
4. Нет визуального выделения важных точек (максимумы, минимумы)
5. Сетка графика может быть более тонкой и ненавязчивой
6. Нет градиентов под линиями для лучшей визуализации трендов
7. Точки на линиях не выделены, сложно точно определить значения
8. Нет анимаций при загрузке данных
9. Цветовая схема может быть улучшена для лучшей контрастности

---

## Требования

### 1. Улучшение визуализации линий

**Толщина и стили линий:**
- **Основные линии** (Новые, Закрытые все, Переходящие все): толщина `3px`
- **Вспомогательные линии** (созданы этой/другой неделей): толщина `2px`, пунктир `[8, 4]` (вместо `[5, 5]`)
- **Скругление линий:** `tension: 0.4` (вместо `0.3`) для более плавных кривых

**Точки на линиях:**
- Добавить точки на всех линиях с радиусом `5px` для основных линий
- Радиус `4px` для вспомогательных линий
- Точки должны быть видимы только при hover (по умолчанию скрыты)
- Цвет точек соответствует цвету линии
- Обводка точек: белая (`#ffffff`) с шириной `2px`

**Градиенты под линиями:**
- Добавить градиентную заливку под основными линиями
- Градиент от цвета линии (opacity 0.3) до прозрачного
- Применять только к основным линиям (Новые, Закрытые все, Переходящие все)
- Вспомогательные линии без заливки

### 2. Улучшение tooltips

**Форматирование:**
- Улучшить структуру tooltip: заголовок недели + значения серий
- Добавить иконки для каждой серии (цветной индикатор)
- Форматирование чисел: разделитель тысяч (пробел)
- Добавить единицы измерения: "тикетов" / "тикета" / "тикет" (склонение)
- Фон tooltip: белый с тенью, скругление `8px`
- Padding: `16px`

**Структура tooltip:**
```
Неделя 51 (15 дек — 21 дек)
━━━━━━━━━━━━━━━━━━━━━━━━━━
● Новые: 25 тикетов
● Закрытые (все): 18 тикетов
● Закрытые (созданы этой неделей): 12 тикетов
● Закрытые (созданы другой неделей): 6 тикетов
```

**Анимация появления:**
- Плавное появление tooltip с fade-in эффектом
- Задержка появления: `200ms` (не сразу при hover)

### 3. Оптимизация легенды

**Расположение:**
- Легенда внизу графика (вместо сверху)
- Горизонтальное расположение элементов
- Максимум 2 строки легенды (если не помещается)

**Стилизация:**
- Уменьшить размер шрифта: `13px` (вместо `15px`)
- Уменьшить padding: `12px` (вместо `16px`)
- Уменьшить boxWidth: `18px` (вместо `20px`)
- Добавить hover-эффект на элементы легенды (подсветка соответствующей линии)
- Клик по элементу легенды скрывает/показывает серию (toggle)

**Группировка:**
- Основные серии (Новые, Закрытые все, Переходящие все) — обычный стиль
- Вспомогательные серии (созданы этой/другой неделей) — более светлый цвет текста

### 4. Улучшение сетки графика

**Стили сетки:**
- Толщина линий сетки: `1px` (вместо `1.5px`)
- Цвет сетки: `#e5e7eb` (светло-серый, менее навязчивый)
- Стиль линий: сплошной
- Добавить более тёмные линии для основных делений (каждые 5 единиц на оси Y)

**Оси:**
- Улучшить форматирование подписей осей
- Ось Y: добавить разделитель тысяч (если значения > 1000)
- Ось X: улучшить читаемость подписей недель (можно добавить даты в скобках)

### 5. Цветовая схема

**Основные цвета (улучшенные):**
- Новые: `#007bff` (синий, основной)
- Закрытые (все): `#28a745` (зелёный, успех)
- Закрытые (созданы этой неделей): `#6cbd45` (светло-зелёный)
- Закрытые (созданы другой неделей): `#ffc107` (жёлтый, предупреждение)
- Переходящие (все): `#ff9800` (оранжевый)
- Переходящие (созданы этой неделей): `#ffb74d` (светло-оранжевый)
- Переходящие (созданы другой неделей): `#f57c00` (тёмно-оранжевый)

**Контрастность:**
- Убедиться, что все цвета соответствуют WCAG AA (контрастность минимум 4.5:1)
- Проверить читаемость на светлом и тёмном фоне

### 6. Анимации

**Анимация загрузки:**
- Плавное появление графика при загрузке данных
- Анимация рисования линий: от левого края к правому
- Длительность анимации: `800ms`
- Easing: `ease-out`

**Анимация hover:**
- Плавное увеличение точек при наведении на линию
- Подсветка линии при hover (увеличение толщины на `1px`)
- Плавное появление tooltip

### 7. Интерактивность

**Hover-эффекты:**
- При наведении на линию — подсветка всей линии
- При наведении на точку — увеличение точки и показ точного значения
- При наведении на элемент легенды — подсветка соответствующей линии

**Клики:**
- Клик по элементу легенды — скрытие/показ серии
- Клик по точке графика — можно добавить в будущем (пока не требуется)

### 8. Адаптивность

**Мобильные устройства:**
- На экранах < 768px графики располагаются вертикально
- Уменьшить размер шрифтов в легенде: `11px`
- Уменьшить размер точек: `4px` для основных, `3px` для вспомогательных
- Оптимизировать tooltip для мобильных (полная ширина, снизу)

---

## Модули и компоненты

### Файлы для изменения:

1. **`vue-app/src/components/graph-admission-closure/GraphAdmissionClosureChart.vue`**
   - Обновление конфигурации Chart.js для линейных графиков
   - Добавление градиентов под линиями
   - Улучшение tooltips
   - Оптимизация легенды
   - Добавление анимаций

2. **`vue-app/src/utils/chart-config.js`** (если существует)
   - Обновление цветовой схемы
   - Добавление утилит для градиентов

3. **Создать новый файл (опционально):**
   - `vue-app/src/utils/chart-gradients.js` — утилиты для создания градиентов

---

## Ступенчатые подзадачи

1. **Обновить конфигурацию линий графика:**
   - Изменить толщину линий (3px для основных, 2px для вспомогательных)
   - Обновить стиль пунктира для вспомогательных линий `[8, 4]`
   - Увеличить tension до `0.4`

2. **Добавить точки на линиях:**
   - Настроить точки для всех серий
   - Скрыть точки по умолчанию (`pointRadius: 0`)
   - Показывать точки при hover (`pointHoverRadius: 5` для основных, `4` для вспомогательных)
   - Добавить обводку точек (белая, 2px)

3. **Реализовать градиенты под линиями:**
   - Создать функцию для генерации градиентов
   - Применить градиенты к основным линиям (Новые, Закрытые все, Переходящие все)
   - Настроить opacity градиента (0.3)

4. **Улучшить tooltips:**
   - Обновить структуру tooltip (заголовок + список значений)
   - Добавить иконки (цветные индикаторы) для каждой серии
   - Форматировать числа с разделителем тысяч
   - Добавить склонение единиц измерения
   - Улучшить стили tooltip (фон, тень, скругление)

5. **Оптимизировать легенду:**
   - Переместить легенду вниз графика
   - Уменьшить размеры (шрифт, padding, boxWidth)
   - Добавить hover-эффект на элементы легенды
   - Реализовать toggle серий при клике на элемент легенды

6. **Улучшить сетку графика:**
   - Уменьшить толщину линий сетки до `1px`
   - Изменить цвет сетки на `#e5e7eb`
   - Добавить более тёмные линии для основных делений

7. **Обновить цветовую схему:**
   - Проверить контрастность всех цветов
   - Убедиться в соответствии WCAG AA
   - Обновить цвета в `chart-config.js` (если нужно)

8. **Добавить анимации:**
   - Настроить анимацию загрузки графика (800ms, ease-out)
   - Добавить анимацию hover для точек и линий
   - Настроить плавное появление tooltip

9. **Протестировать адаптивность:**
   - Проверить отображение на мобильных устройствах
   - Оптимизировать размеры для экранов < 768px
   - Протестировать tooltip на мобильных

10. **Финальная проверка:**
    - Проверить все улучшения на обоих графиках
    - Убедиться в консистентности дизайна
    - Проверить производительность (анимации не должны лагать)

---

## Технические детали

### Конфигурация Chart.js для линейных графиков

**Пример обновлённой конфигурации:**

```javascript
const chartOptions = computed(() => ({
  responsive: true,
  maintainAspectRatio: false,
  resizeDelay: 0,
  animation: {
    duration: 800,
    easing: 'ease-out'
  },
  interaction: {
    intersect: false,
    mode: 'index'
  },
  plugins: {
    tooltip: {
      enabled: true,
      backgroundColor: 'rgba(255, 255, 255, 0.98)',
      titleColor: '#111827',
      bodyColor: '#374151',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      cornerRadius: 8,
      padding: 16,
      titleFont: {
        size: 14,
        weight: 'bold'
      },
      bodyFont: {
        size: 13
      },
      displayColors: true,
      callbacks: {
        title: (items) => {
          // Улучшенное форматирование заголовка
          const index = items[0]?.dataIndex;
          const weeks = props.meta?.weeks || [];
          if (weeks.length > 0 && index !== undefined && weeks[index]) {
            const week = weeks[index];
            return `Неделя ${week.weekNumber} (${formatDate(week.weekStartUtc)} — ${formatDate(week.weekEndUtc)})`;
          }
          return items[0]?.label || '';
        },
        label: (context) => {
          // Улучшенное форматирование значений
          const value = context.parsed.y;
          const label = context.dataset.label || '';
          const unit = getUnitLabel(value); // Функция для склонения
          return `${label}: ${formatNumber(value)} ${unit}`;
        }
      }
    },
    legend: {
      position: 'bottom',
      labels: {
        font: {
          size: 13,
          weight: '500'
        },
        padding: 12,
        boxWidth: 18,
        boxHeight: 12,
        usePointStyle: true,
        pointStyle: 'circle'
      },
      onClick: (e, legendItem) => {
        // Toggle серии при клике на элемент легенды
        const index = legendItem.datasetIndex;
        const chart = e.chart;
        const meta = chart.getDatasetMeta(index);
        meta.hidden = !meta.hidden;
        chart.update();
      }
    }
  },
  scales: {
    y: {
      beginAtZero: true,
      ticks: {
        precision: 0,
        font: {
          size: 14
        },
        padding: 10,
        callback: (value) => {
          // Форматирование с разделителем тысяч
          return formatNumber(value);
        }
      },
      grid: {
        color: '#e5e7eb',
        lineWidth: 1
      }
    },
    x: {
      ticks: {
        maxRotation: 45,
        minRotation: 45,
        font: {
          size: 14
        },
        padding: 10
      },
      grid: {
        color: '#e5e7eb',
        lineWidth: 1
      }
    }
  }
}));
```

**Конфигурация datasets с улучшениями:**

```javascript
{
  label: 'Новые',
  data: newSeries,
  backgroundColor: chartColors.primary,
  borderColor: chartColors.primary,
  borderWidth: 3, // Увеличена толщина
  tension: 0.4, // Увеличено скругление
  fill: true, // Включена заливка для градиента
  pointRadius: 0, // Скрыты точки по умолчанию
  pointHoverRadius: 5, // Показывать точки при hover
  pointHoverBorderWidth: 2,
  pointHoverBorderColor: '#ffffff',
  pointBackgroundColor: chartColors.primary
}
```

**Функция для создания градиента:**

```javascript
function createGradient(ctx, chartArea, color) {
  const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
  gradient.addColorStop(0, color + '4D'); // opacity 0.3
  gradient.addColorStop(1, color + '00'); // прозрачный
  return gradient;
}
```

**Функции для форматирования:**

```javascript
function formatNumber(value) {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

function getUnitLabel(count) {
  const lastDigit = count % 10;
  const lastTwoDigits = count % 100;
  
  if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
    return 'тикетов';
  }
  
  if (lastDigit === 1) {
    return 'тикет';
  }
  
  if (lastDigit >= 2 && lastDigit <= 4) {
    return 'тикета';
  }
  
  return 'тикетов';
}
```

---

## Критерии приёмки

- [ ] Линии графика имеют улучшенную толщину (3px основные, 2px вспомогательные)
- [ ] Пунктирные линии имеют стиль `[8, 4]`
- [ ] Точки на линиях скрыты по умолчанию и появляются при hover
- [ ] Градиенты под основными линиями работают корректно
- [ ] Tooltips имеют улучшенное форматирование с иконками и склонением
- [ ] Легенда расположена внизу графика
- [ ] Элементы легенды имеют hover-эффект
- [ ] Клик по элементу легенды скрывает/показывает серию
- [ ] Сетка графика имеет улучшенные стили (тонкие линии, светлый цвет)
- [ ] Цветовая схема соответствует WCAG AA
- [ ] Анимации работают плавно (800ms, ease-out)
- [ ] Графики адаптивны для мобильных устройств
- [ ] Все улучшения применены к обоим графикам (Новые/Закрытые и Переходящие)
- [ ] Производительность не ухудшилась (анимации не лагают)

---

## Примеры улучшений

### До улучшений:
- Плоские линии без глубины
- Базовые tooltips
- Легенда сверху, занимает много места
- Нет точек на линиях
- Нет градиентов

### После улучшений:
- Линии с градиентами и точками
- Информативные tooltips с форматированием
- Компактная легенда внизу с интерактивностью
- Плавные анимации
- Улучшенная читаемость

---

## Тестирование

1. **Визуальное тестирование:**
   - Проверить отображение обоих графиков
   - Убедиться в корректности цветов и градиентов
   - Проверить tooltips при hover
   - Проверить работу легенды (hover, toggle)

2. **Функциональное тестирование:**
   - Проверить анимации загрузки
   - Проверить hover-эффекты
   - Проверить toggle серий через легенду
   - Проверить форматирование чисел и единиц измерения

3. **Адаптивное тестирование:**
   - Проверить на экранах разных размеров
   - Проверить на мобильных устройствах
   - Проверить tooltip на мобильных

4. **Производительность:**
   - Проверить плавность анимаций
   - Проверить время загрузки графика
   - Убедиться, что нет лагов при взаимодействии

---

## История правок

- 2025-12-17 14:27 (UTC+3, Брест): Создана задача TASK-056 с улучшениями дизайна линейных графиков

---

## Дополнительные рекомендации

1. **Производительность:**
   - Использовать `will-change` CSS-свойство для анимируемых элементов
   - Оптимизировать градиенты (кэшировать canvas context)
   - Избегать излишних перерисовок

2. **Доступность:**
   - Убедиться, что все цвета соответствуют WCAG AA
   - Добавить ARIA-атрибуты для интерактивных элементов
   - Поддержка клавиатурной навигации (если возможно)

3. **Совместимость:**
   - Проверить работу в разных браузерах (Chrome, Firefox, Safari, Edge)
   - Убедиться в корректной работе на разных версиях Chart.js

4. **Будущие улучшения:**
   - Можно добавить возможность масштабирования графика (zoom)
   - Можно добавить экспорт графика в изображение
   - Можно добавить сравнение периодов (overlay нескольких периодов)

