# TASK-071-03: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–µ—à–∞ –≤ TimeTrackingService

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-23 18:03 (UTC+3, –ë—Ä–µ—Å—Ç)  
**–°—Ç–∞—Ç—É—Å:** –ù–æ–≤–∞—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** Backend Developer (PHP)  
**–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞:** [TASK-071: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥—É–ª—è "–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –¢–∏–∫–µ—Ç—ã —Å–µ–∫—Ç–æ—Ä–∞ 1–°"](./TASK-071-cache-time-tracking-sector-1c.md)  
**–ü–æ–¥–∑–∞–¥–∞—á–∞:** –≠—Ç–∞–ø 3 –∏–∑ TASK-071

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—ã–π –∫–µ—à –≤ `TimeTrackingService` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–µ—à–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 API –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à. –ö–µ—à –¥–æ–ª–∂–µ–Ω —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–µ—à–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –≤ `TimeTrackingService`.

---

## üéØ –ö–æ–Ω—Ç–µ–∫—Å—Ç

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

- –ö–ª–∞—Å—Å `TimeTrackingCache` —Å–æ–∑–¥–∞–Ω (TASK-071-01)
- –û–±—ë—Ä—Ç–∫–∞ `CacheStore` —Å–æ–∑–¥–∞–Ω–∞ (TASK-071-02)
- `TimeTrackingService` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à
- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

### –¢—Ä–µ–±—É–µ—Ç—Å—è:

- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `CacheStore` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `TimeTrackingService`
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–µ—à–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π

---

## üèóÔ∏è –ú–æ–¥—É–ª–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:

- `api/tickets-time-tracking-sector-1c/service/TimeTrackingService.php` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–µ—à–∞ –≤ —Å–µ—Ä–≤–∏—Å

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **–û—Ç –∑–∞–¥–∞—á:** 
  - TASK-071-01: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ TimeTrackingCache (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
  - TASK-071-02: –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ë—Ä—Ç–∫–∏ CacheStore (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
  - TASK-071: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥—É–ª—è "–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –¢–∏–∫–µ—Ç—ã —Å–µ–∫—Ç–æ—Ä–∞ 1–°"
- **–û—Ç –º–æ–¥—É–ª–µ–π:** 
  - –ö–ª–∞—Å—Å: `CacheStore` –≤ `api/tickets-time-tracking-sector-1c/cache/CacheStore.php`
  - –ö–ª–∞—Å—Å: `TimeTrackingService` –≤ `api/tickets-time-tracking-sector-1c/service/TimeTrackingService.php`
- **–û—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫:** 
  - PHP 8.4+

---

## üéØ –°—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ CacheStore –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `CacheStore` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `TimeTrackingService`.

**–®–∞–≥–∏:**

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∞**
   ```php
   protected CacheStore $cacheStore;
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä**
   ```php
   public function __construct(
       EmployeeRepository $employeeRepository,
       TaskRepository $taskRepository,
       ElapsedTimeRepository $elapsedTimeRepository,
       TicketRepository $ticketRepository,
       TaskTicketMatcher $taskTicketMatcher,
       TimeAggregator $timeAggregator,
       EmployeeSummaryBuilder $employeeSummaryBuilder,
       CacheStore $cacheStore // TASK-071-03: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∫–µ—à–∞
   ) {
       $this->employeeRepository = $employeeRepository;
       $this->taskRepository = $taskRepository;
       $this->elapsedTimeRepository = $elapsedTimeRepository;
       $this->ticketRepository = $ticketRepository;
       $this->taskTicketMatcher = $taskTicketMatcher;
       $this->timeAggregator = $timeAggregator;
       $this->employeeSummaryBuilder = $employeeSummaryBuilder;
       $this->cacheStore = $cacheStore; // TASK-071-03: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–µ—à–∞
   }
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å use-–¥–∏—Ä–µ–∫—Ç–∏–≤—É**
   ```php
   use TimeTracking\Cache\CacheStore;
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏:**
- [ ] –°–≤–æ–π—Å—Ç–≤–æ `$cacheStore` –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] –ü–∞—Ä–∞–º–µ—Ç—Ä `CacheStore` –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- [ ] use-–¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] –ö–µ—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–≤–æ–π—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∞

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–µ—à–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–µ—à–∞ –≤ –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ `getTimeTrackingData()` –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 API.

**–®–∞–≥–∏:**

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `forceRefresh`**
   ```php
   $forceRefresh = $params['forceRefresh'] ?? false;
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–µ—à–∞ (–µ—Å–ª–∏ –Ω–µ `forceRefresh`)**
   ```php
   if (!$forceRefresh) {
       $cacheKey = $this->cacheStore->generateKey($params);
       $cachedData = $this->cacheStore->get($cacheKey);
       
       if ($cachedData !== null) {
           error_log("[TimeTrackingService] Cache hit for key: {$cacheKey}");
           return $cachedData;
       }
       
       error_log("[TimeTrackingService] Cache miss for key: {$cacheKey}");
   } else {
       error_log("[TimeTrackingService] Force refresh requested, skipping cache");
   }
   ```

3. **–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–µ—à–∞ –≤ –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ `getTimeTrackingData()`**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ Bitrix24 API
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–µ—à–µ, –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –∏—Ö —Å—Ä–∞–∑—É

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏:**
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –Ω–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤–æ–∑–≤—Ä–∞—Ç –∏–∑ –∫–µ—à–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö)
- [ ] –ü–∞—Ä–∞–º–µ—Ç—Ä `forceRefresh` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∫–µ—à–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24 API.

**–®–∞–≥–∏:**

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞**
   ```php
   // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
   $response = [
       'success' => true,
       'meta' => [...],
       'data' => [...]
   ];
   
   // TASK-071-03: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
   if (!$forceRefresh) {
       $cacheKey = $this->cacheStore->generateKey($params);
       
       if ($this->cacheStore->set($cacheKey, $response, 300)) {
           error_log("[TimeTrackingService] Cache saved for key: {$cacheKey}");
       } else {
           error_log("[TimeTrackingService] Failed to save cache for key: {$cacheKey}");
       }
   }
   ```

2. **–†–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 API
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - TTL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏:**
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `forceRefresh`
- [ ] TTL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 300 —Å–µ–∫—É–Ω–¥
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∫–µ—à–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π (–∫–∞–∂–¥—ã–π 10-–π –∑–∞–ø—Ä–æ—Å).

**–®–∞–≥–∏:**

1. **–î–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π**
   ```php
   // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π (–∫–∞–∂–¥—ã–π 10-–π –∑–∞–ø—Ä–æ—Å)
   if (rand(1, 10) === 1) {
       $deleted = $this->cacheStore->clearExpired();
       if ($deleted > 0) {
           error_log("[TimeTrackingService] Cleared {$deleted} expired cache entries");
       }
   }
   ```

2. **–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–µ—à**
   - –û—á–∏—Å—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `forceRefresh`
   - –û—á–∏—Å—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 1/10 (–∫–∞–∂–¥—ã–π 10-–π –∑–∞–ø—Ä–æ—Å)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏:**
- [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 1/10
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ TimeTrackingService:

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ:**
   ```php
   protected CacheStore $cacheStore;
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
   ```php
   public function __construct(
       // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ...
       CacheStore $cacheStore
   ) {
       // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
       $this->cacheStore = $cacheStore;
   }
   ```

3. **–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getTimeTrackingData()`:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ –≤ –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–µ—à–∞:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞
   - –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞–π–¥–µ–Ω—ã (–∏ –Ω–µ `forceRefresh`)

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–µ—à —Å TTL 300 —Å–µ–∫—É–Ω–¥
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ/–Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

3. **–û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π:**
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 1/10 (–∫–∞–∂–¥—ã–π 10-–π –∑–∞–ø—Ä–æ—Å)
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

### –û–±—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏:
- [ ] –ö–µ—à –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `TimeTrackingService`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∫–µ—à–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] –ü–∞—Ä–∞–º–µ—Ç—Ä `forceRefresh` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º PSR-12
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ TASK-071-03

### –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞:**
```php
// –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä CacheStore
public function __construct(
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ...
    CacheStore $cacheStore
) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    $this->cacheStore = $cacheStore;
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–∞ getTimeTrackingData():**
```php
// –í –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
if (!$forceRefresh) {
    $cacheKey = $this->cacheStore->generateKey($params);
    $cachedData = $this->cacheStore->get($cacheKey);
    if ($cachedData !== null) {
        return $cachedData;
    }
}

// ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Bitrix24 API ...

// –ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
if (!$forceRefresh) {
    $cacheKey = $this->cacheStore->generateKey($params);
    $this->cacheStore->set($cacheKey, $response, 300);
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
    if (rand(1, 10) === 1) {
        $this->cacheStore->clearExpired();
    }
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–µ—à–∞:**
   ```php
   // –°–æ–∑–¥–∞—Ç—å –∫–µ—à
   $params = ['product' => '1C'];
   $cacheKey = $cacheStore->generateKey($params);
   $cacheStore->set($cacheKey, ['test' => 'data'], 60);
   
   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞
   $result = $service->getTimeTrackingData($params);
   assert($result['test'] === 'data', 'Service should return cached data');
   ```

2. **–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–µ—à:**
   ```php
   // –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
   $params = ['product' => '1C'];
   $cacheKey = $cacheStore->generateKey($params);
   $cacheStore->delete($cacheKey);
   
   // –í—ã–∑–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å
   $result = $service->getTimeTrackingData($params);
   
   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–µ—à
   $cached = $cacheStore->get($cacheKey);
   assert($cached !== null, 'Data should be cached');
   ```

3. **–¢–µ—Å—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ forceRefresh:**
   ```php
   // –°–æ–∑–¥–∞—Ç—å –∫–µ—à
   $params = ['product' => '1C'];
   $cacheKey = $cacheStore->generateKey($params);
   $cacheStore->set($cacheKey, ['old' => 'data'], 60);
   
   // –í—ã–∑–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å forceRefresh
   $params['forceRefresh'] = true;
   $result = $service->getTimeTrackingData($params);
   
   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–µ—à –±—ã–ª –ø—Ä–æ–ø—É—â–µ–Ω (–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤–µ–∂–∏–º–∏)
   assert($result['old'] !== 'data', 'forceRefresh should skip cache');
   ```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ TimeTrackingService:

```php
<?php

namespace TimeTracking\Service;

use TimeTracking\Cache\CacheStore; // TASK-071-03: –î–æ–±–∞–≤–ª–µ–Ω use
// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ use ...

class TimeTrackingService
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ ...
    protected CacheStore $cacheStore; // TASK-071-03: –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–≤–æ–π—Å—Ç–≤–æ
    
    public function __construct(
        EmployeeRepository $employeeRepository,
        TaskRepository $taskRepository,
        ElapsedTimeRepository $elapsedTimeRepository,
        TicketRepository $ticketRepository,
        TaskTicketMatcher $taskTicketMatcher,
        TimeAggregator $timeAggregator,
        EmployeeSummaryBuilder $employeeSummaryBuilder,
        CacheStore $cacheStore // TASK-071-03: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä
    ) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
        $this->cacheStore = $cacheStore; // TASK-071-03: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–µ—à–∞
    }
    
    public function getTimeTrackingData(array $params): array
    {
        error_log("[TimeTrackingService] Starting data collection");
        
        // TASK-071-03: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤
        $forceRefresh = $params['forceRefresh'] ?? false;
        
        if (!$forceRefresh) {
            $cacheKey = $this->cacheStore->generateKey($params);
            $cachedData = $this->cacheStore->get($cacheKey);
            
            if ($cachedData !== null) {
                error_log("[TimeTrackingService] Cache hit for key: {$cacheKey}");
                return $cachedData;
            }
            
            error_log("[TimeTrackingService] Cache miss for key: {$cacheKey}");
        } else {
            error_log("[TimeTrackingService] Force refresh requested, skipping cache");
        }
        
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bitrix24 API ...
        
        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        $response = [
            'success' => true,
            'meta' => [...],
            'data' => [...]
        ];
        
        // TASK-071-03: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
        if (!$forceRefresh) {
            $cacheKey = $this->cacheStore->generateKey($params);
            
            if ($this->cacheStore->set($cacheKey, $response, 300)) {
                error_log("[TimeTrackingService] Cache saved for key: {$cacheKey}");
            } else {
                error_log("[TimeTrackingService] Failed to save cache for key: {$cacheKey}");
            }
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–µ—à–µ–π (–∫–∞–∂–¥—ã–π 10-–π –∑–∞–ø—Ä–æ—Å)
            if (rand(1, 10) === 1) {
                $deleted = $this->cacheStore->clearExpired();
                if ($deleted > 0) {
                    error_log("[TimeTrackingService] Cleared {$deleted} expired cache entries");
                }
            }
        }
        
        return $response;
    }
}
```

---

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –î–≤–æ–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫–µ—à–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—é—á –∫–µ—à–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã (–ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏).

**–†–µ—à–µ–Ω–∏–µ:**
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ ‚Äî –±—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∫–µ—à.

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [TASK-071: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥—É–ª—è "–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –¢–∏–∫–µ—Ç—ã —Å–µ–∫—Ç–æ—Ä–∞ 1–°"](./TASK-071-cache-time-tracking-sector-1c.md)
- [TASK-071-01: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ TimeTrackingCache](./TASK-071-01-create-time-tracking-cache.md)
- [TASK-071-02: –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ë—Ä—Ç–∫–∏ CacheStore](./TASK-071-02-create-cache-store-wrapper.md)
- [TASK-068-03: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ –≤ —Å–µ—Ä–≤–∏—Å](./TASK-068-03-add-cache-to-service.md) (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å)

---

## üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫

- **2025-12-23 18:03 (UTC+3, –ë—Ä–µ—Å—Ç):** –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∞ TASK-071-03 –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫–µ—à–∞ –≤ TimeTrackingService

---

**–ê–≤—Ç–æ—Ä:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0

