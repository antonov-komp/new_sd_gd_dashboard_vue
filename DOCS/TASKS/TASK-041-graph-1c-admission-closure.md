# TASK-041: График приёма и закрытий сектора 1С

**Дата создания:** 2025-12-15 12:23 (UTC+0300, Brest)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js Developer)  
**Связанные модули:** График состояния сектора 1С (использовать его структуру и доступы)

## Цель
Создать третий модуль в основном REST-приложении — «График приёма и закрытий сектора 1С». Модуль должен наследовать текущую структуру «Графика состояния сектора 1С», сохранить доступы и фильтры, но убрать селектор «Этапы для отображения» и сразу выводить все стадии. Графики: линейный, столбчатый и круговая диаграмма.

## Контекст
- Данные тикетов доступны через Bitrix24 и кешируются в `logs/` (например, `logs/2025-12-15/11/1765786306_callCurl_5109403log.json`).
- Аналогичные модули уже реализованы для сектора 1С; необходимо повторно использовать их подходы к доступам, фильтрам и визуальным компонентам.
- Неделя определяется по ISO-8601: старт в понедельник, окончание в воскресенье. Номер недели и её границы вычисляет бэкенд.
- Сектор 1С определяется по полю `product` (см. `UF_CRM_7_TYPE_PRODUCT` в логах). Фильтр по продукту применяется первым шагом до любых расчётов.

## Основные требования
- **Доступы:** использовать те же правила, что и в существующих 1С-модулях (без изменений).
- **Фильтры:** секция фильтров без изменений относительно текущего модуля «График состояния сектора 1С».
- **Отбор тикетов:** в первую очередь отфильтровать тикеты по сектору 1С по полю `product` (как в двух существующих модулях).
- **Удалить селектор «Этапы для отображения»:** в этом модуле его нет; все стадии должны отображаться сразу.
- **Графики:** линейный и столбчатый — данные агрегированы за неделю (одна точка/столбец на неделю). Круговая диаграмма: «Новые» vs «Закрытые».
- **Нормализация времени:** все расчёты по датам и агрегациям — в UTC. Неделю (номер, начало, конец) рассчитывает бэкенд.
- **Неделя:** понедельник–воскресенье (ISO-8601).
- **Новые тикеты:** количество тикетов, у которых `createdTime` попадает в текущую неделю. Нужен только счёт (без детализации на графиках).
- **Закрытые тикеты:** количество тикетов, у которых `stageId` ∈ {`DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`} и `movedTime` попадает в текущую неделю.
- **Даты:** опираться на служебные поля `createdTime` и `movedTime` из тикетов (см. логи).
- **Круговая диаграмма:** сравнение «Новые» vs «Закрытые» за неделю.
- **Попапы:** только попапы 1-го уровня. Они изолированы от существующих — отдельная реализация/файлы. Содержимое: «Сотрудники ответственные» из поля `assigned` (ticket assignedById).
- **Stage mapping:** закрывающие стадии жёстко заданы (`DT140_12:SUCCESS`, `DT140_12:FAIL`, `DT140_12:UC_0GBU8Z`). При расширении списка — правка только на бэкенде.
- **Временные зоны:** входящие поля Bitrix24 содержат смещение (например, `+02:00`), но для расчётов все значения приводятся к UTC на бэкенде; фронт использует уже нормализованные UTC значения.
- **Агрегация:** одна неделя → одна точка на линейном и один столбец на бар-чарте (аггрегированные суммы new/closed). При пролистывании недель (если будет добавлено) предполагается один набор на каждую неделю.
- **Загрузка при открытии:** сразу запрашиваем текущую неделю (номер + границы) и выдаём данные; нет отдельного шага выбора этапов.

## API/Контракт (черновик)
Бэкенд (REST) формирует данные за текущую неделю:
```json
{
  "meta": {
    "weekNumber": 51,
    "weekStartUtc": "2025-12-15T00:00:00Z",
    "weekEndUtc": "2025-12-21T23:59:59Z"
  },
  "data": {
    "newTickets": 12,
    "closedTickets": 8,
    "series": {
      "new": [12],
      "closed": [8]
    },
    "stages": [
      {
        "stageId": "DT140_12:SUCCESS",
        "count": 5
      },
      {
        "stageId": "DT140_12:FAIL",
        "count": 2
      },
      {
        "stageId": "DT140_12:UC_0GBU8Z",
        "count": 1
      }
    ],
    "responsible": [
      { "id": 123, "name": "Иванов Иван", "count": 4 },
      { "id": 456, "name": "Петров Пётр", "count": 3 }
    ]
  }
}
```
- `newTickets` — счёт по `createdTime` в текущей неделе (после фильтрации по продукту 1С).
- `closedTickets` — счёт по `movedTime` в текущей неделе и `stageId` в списке закрывающих стадий.
- `series` — агрегированные значения по неделям (для линейного/бар-чарта; пока одна неделя = один элемент массива).
- `stages` — распределение закрытых по стадиям (для линейного/столбчатого графиков при необходимости цветового кодирования).
- `responsible` — данные для попапа 1-го уровня (агрегация по `assigned` / `assignedById`).

### Требования к бэкенду (для фронта)
- Отфильтровать только тикеты сектора 1С (`product`).
- Рассчитать `weekNumber`, `weekStartUtc`, `weekEndUtc` (UTC, ISO-8601, пн–вс).
- Вернуть агрегаты: `newTickets`, `closedTickets`, `series.new[]`, `series.closed[]`.
- Вернуть распределение по закрывающим стадиям `stages[]`.
- Вернуть агрегат по ответственным `responsible[]` (id, name, count) для попапа.
- Все даты в ответе — UTC (ISO8601).

### Ожидаемая структура фильтра запроса (пример)
```json
{
  "product": "1C",
  "weekStartUtc": "2025-12-15T00:00:00Z",
  "weekEndUtc": "2025-12-21T23:59:59Z"
}
```

## UI/UX и фронтенд
- Брать визуальные компоненты графиков из модуля «График состояния сектора 1С».
- Убрать селектор «Этапы для отображения» на UI этого модуля.
- Линейный и столбчатый графики: показывать суммарные значения за неделю (агрегированная точка/столбец).
- Круговая: «Новые» vs «Закрытые».
- Фильтры — без изменений (как в текущем модуле).
- Попап 1-го уровня (отдельный файл/модуль) показывает «Сотрудники ответственные» на основе `assigned`.
- Цветовая схема, легенды, тултипы — повторить существующий модуль; убрать элементы, связанные с выбором этапов.
- В попапе: имя ответственного, количество, при наличии — аватар/идентификатор из существующей маппинг-логики (если уже используется в других попапах).
- Поведение при пустых данных: показывать пустое состояние/нулевые значения, графики не ломаются, попап открывается с сообщением «Нет данных».

## Данные и источники
- Основной источник: Bitrix24 CRM items (пример структуры см. лог `logs/2025-12-15/11/1765786306_callCurl_5109403log.json` — содержит `createdTime`, `movedTime`, `stageId`, `UF_CRM_7_TYPE_PRODUCT` и `assignedById`).
- Кеш/проверка: содержимое запросов в `logs/` (использовать для валидации структуры полей).
- Поля для использования фронтом:  
  - `createdTime` — для новых;  
  - `movedTime` — для закрытых;  
  - `stageId` — для определения закрывающих стадий;  
  - `UF_CRM_7_TYPE_PRODUCT` — фильтр на 1С;  
  - `assignedById` (или `assigned`) — для попапа;  
  - вспомогательные поля (id, title) — опционально для подсказок, если бэкенд вернёт.
- **Как получаем ответственных в модулях 1 и 2 (повторить):**  
  - Используем утилиту `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js`.  
  - Извлечение ID: `getAssignedById(ticket)` перебирает варианты полей (`assignedById`, `ASSIGNED_BY_ID`, `assignedByIdId`, объект с `id/ID/value`).  
  - Нормализация: `parseEmployeeId` приводит значение к числу, возвращает `null` при невалидных/пустых значениях.  
  - Нулевая точка: `isZeroPointTicket` относит к «нулю» тикеты без ответственного или с ответственным `KEEPER_OBJECTS_ID = 1051`.  
  - Агрегация ответственных в первом/втором модуле строится на этих функциях; для нового модуля использовать ту же логику (исключить/учесть «нулевые» тикеты по действующим правилам проекта).

## Этапы работ (для VUE разработчика)
1) Подготовка и анализ  
   - Ознакомиться с кодом существующих модулей «График состояния сектора 1С» (структура, доступы, фильтры, компоненты графиков).  
   - Подтвердить, что фильтр по `product` применён первым шагом (как в первых двух модулях).

2) Бэкенд-контракт и данные  
   - Зафиксировать конечный REST-эндпоинт модуля.  
   - Убедиться, что бэкенд считает номер недели, `weekStartUtc`, `weekEndUtc` (UTC, понедельник–воскресенье) и фильтрует тикеты по 1С.  
   - Уточнить формат массива `responsible` (id, name, count) и перечень полей, требуемых фронтом.
   - Проверить, что в ответе уже есть агрегаты для графиков (`series`) и распределения по стадиям (`stages`).

3) UI без селектора этапов  
   - Удалить селектор «Этапы для отображения» в UI этого модуля.  
   - Сохранить блок фильтров и визуальный каркас графиков.

4) Графики (агрегация неделя)  
   - Линейный и столбчатый: использовать агрегированные недельные значения (новые/закрытые).  
   - Цвета/легенды — как в текущем модуле (адаптировать под новый набор серий при отсутствии селектора).  
   - Круговая: отобразить две категории «Новые» и «Закрытые» за неделю.

5) Попап 1-го уровня (изолированный)  
   - Создать отдельный модуль/файл для попапа 1-го уровня, не смешивать с существующими попапами.  
   - Наполнение: список ответственных (`assigned`) с количествами.  
   - Сценарий открытия — по клику на соответствующий элемент графика (аналогично существующим попапам, но с изолированным кодом).
   - Обработать кейс пустого списка (нет ответственных) — показать информативное сообщение.

6) Интеграция и навигация  
   - Подключить модуль в общий роутинг/меню приложения с теми же правилами доступа.  
   - Убедиться, что фильтры и графики обновляются при смене фильтров аналогично текущему модулю.
   - Синхронизировать состояние фильтров с глобальным стором/контекстом (если используется в проекте).

7) Тестирование  
   - Проверить отображение данных за текущую неделю (UTC расчёт).  
   - Проверить кейсы: нет новых, нет закрытых, есть только один тип закрытия, разные ответственные.  
   - Валидировать структуру данных через логи `logs/` и реальный ответ API.  
   - Проверить, что селектор этапов отсутствует, фильтры работают, попап 1-го уровня открывается корректно.
   - Проверить корректность легенд и тултипов после удаления селектора этапов.  
   - Проверить устойчивость к отсутствию `assigned` (нет ответственного) — отображать «Не назначен» / 0.

## Критерии приёмки
- Фильтры и доступы идентичны модулю «График состояния сектора 1С».  
- Селектор «Этапы для отображения» отсутствует.  
- Линейный/столбчатый графики отображают суммарные недельные значения (новые/закрытые).  
- Круговая диаграмма показывает «Новые» vs «Закрытые» за неделю.  
- Попап 1-го уровня реализован отдельно и показывает ответственных (`assigned`) с корректными данными.  
- Неделя, её номер, start/end считаются на бэкенде (UTC, понедельник–воскресенье).  
- Данные берутся только по продукту 1С (как в первых двух модулях).  
- Все даты нормализованы к UTC для расчётов/агрегаций.
- Пустые состояния и отсутствие ответственных обрабатываются корректно; UI не ломается.

## Дополнительные уточнения для реализации
- Визуальные паттерны берём из `vue-app/src/components/graph-state/GraphStateChart.vue` и связанных компонентов (цвета, легенды, тултипы); соблюдаем существующую палитру.  
- Поведение попапов в текущем модуле можно посмотреть в `vue-app/src/components/graph-state/EmployeeDetailsModal.vue`, но для нового попапа код изолируем.  
- Логи для валидации структуры полей расположены по дате/часу: `logs/YYYY-MM-DD/HH/*log.json` (пример указан выше).  
- Для ответственных используем подход из `vue-app/src/services/dashboard-sector-1c/utils/ticket-utils.js`; бэкенд желательно нормализует поле сразу (числовой ID).  
- Если понадобится вывод названий стадий, используем те же label/цвета, что и в существующем модуле; список закрывающих стадий меняется только на бэкенде.

