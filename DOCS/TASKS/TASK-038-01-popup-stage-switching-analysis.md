# TASK-038-01: Анализ и UX-флоу переключения стадий в попапе 1-го уровня (Vue)

**Дата создания:** 2025-12-15 12:10 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Связь:** Часть TASK-038 (`TASK-038-popup-stage-switching.md`)  
**Модуль:** График состояния сектора 1С (`EmployeeDetailsModal.vue`, `GraphStateChart.vue`)  

## Цель
Проанализировать текущий UX/поток и данные для попапа 1-го уровня, чтобы при клике по названию стадии показывать список других стадий (всего три) и открывать попап выбранной стадии без закрытия модального окна. Подготовить детальный план UX и данных для последующей разработки (этапы 2–5).

## Контекст и входные материалы
- `DOCS/TASKS/TASK-038-popup-stage-switching.md` — общий эпик по переключению стадий.
- `DOCS/ANALYSIS/graph-state-popup-interactive-levels-analysis.md` — поведение уровней 1–3 попапа.
- `DOCS/USER-GUIDE/graph-state-sector-1c/00-overview.md` — блок “Детализация данных”.
- `vue-app/src/components/graph-state/EmployeeDetailsModal.vue` — текущий попап с уровнями 1–3.
- `vue-app/src/components/graph-state/GraphStateChart.vue` — обработчики кликов по графикам (line/bar/doughnut).
- Палитра и сигнатуры стадий — см. UI-анализ и общий справочник цветов стадий (синий/жёлтый/зелёный).

## Задачи этапа (детализация)
1) Зафиксировать UX-поток переключения стадий:
   - Открытие попапа из line/bar/doughnut.
   - Клик по названию стадии → раскрытие списка двух альтернативных стадий.
   - Выбор другой стадии → обновление 1-го уровня (стадия, totallCount, employees) без закрытия попапа.
   - Возврат к исходной стадии (повторным выбором).
2) Определить идентификаторы и метаданные стадий:
   - 3 стадии: id/label/color (использовать уже принятые id: formed/review/execution или их аналоги).
   - Единая схема хранения цветов (stage color map) для тултипов/прогресс-баров/списка стадий.
   - Проверить наличие stage map в util/константах фронта; при отсутствии — зафиксировать требуемый словарь.
3) Проанализировать источник данных для альтернативных стадий в текущем контексте:
   - Предпочтительно: метаданные графиков/слепков, чтобы не делать лишние REST-запросы.
   - Фолбэк: REST-загрузка, если нет данных в мета (зафиксировать, какой метод и payload понадобятся).
   - Уточнить, какие timePoint/snapshotId доступны из обработчика клика (line: weekStart/weekEnd/current; doughnut: current; bar: сравнение?).
4) Описать состояние попапа при переключении:
   - Какие части состояния сбрасывать (levels 2/3, ошибки, загрузку).
   - Что сохранять (видимость, фокус/scroll внутри модального окна).
   - События: открытие списка стадий, выбор стадии, ошибка загрузки.
5) Зафиксировать требования по доступности и управлению с клавиатуры:
   - TAB-навигация по пунктам списка стадий.
   - Enter для выбора, ESC для закрытия списка, ESC для закрытия попапа (не ломая перехват на Esc).
   - Фокус-менеджмент: после закрытия списка вернуть фокус на заголовок или первый интерактивный элемент уровня 1.

## Ожидаемые артефакты
- Краткая текстовая схема UX-флоу (можно в этом файле или в комментарии к эпикам).
- Таблица стадий с id/label/color и источником данных (слепок/метаданные/REST).
- Решение по источнику данных при переключении (приоритет: метаданные → REST-фолбэк) и список полей, которые нужны для 1-го уровня (stageName, totalCount, employees, others?).
- Список стейтов/флагов, которые должны сбрасываться/сохраняться при смене стадии.
- Чек-лист сценариев для последующей разработки (что нужно реализовать на этапах 2–4).
 - Карта доступных точек данных (line/bar/doughnut) с описанием доступных метаданных для уровня 1.

## Критерии приёмки
- Описан полный UX-флоу переключения стадий в попапе 1-го уровня (клик по названию → выбор → обновление).
- Идентификаторы и цвета стадий задокументированы; указано, где их брать в коде.
- Определён основной источник данных и фолбэк (REST) с указанием требуемых полей.
- Задокументировано, какие части состояния попапа сбрасываются/сохраняются при смене стадии.
- Учтена клавиатурная доступность (TAB/Enter/ESC) и совместимость с текущими обработчиками закрытия модалки.
- Есть список шагов/сценариев для реализации (будет использован на этапах 2–4).

## Связанные материалы
- `DOCS/TASKS/TASK-038-popup-stage-switching.md`
- `DOCS/ANALYSIS/graph-state-popup-interactive-levels-analysis.md`
- `DOCS/USER-GUIDE/graph-state-sector-1c/00-overview.md`
- `vue-app/src/components/graph-state/EmployeeDetailsModal.vue`
- `vue-app/src/components/graph-state/GraphStateChart.vue`

