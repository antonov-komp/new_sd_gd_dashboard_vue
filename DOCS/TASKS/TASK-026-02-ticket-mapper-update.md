# TASK-026-02: Обновление маппера тикетов под UF_SLA_SERVICE_STR (плашка "В работе", сектор 1С)

**Дата создания:** 2025-12-11 18:55 (UTC+3, Брест)  
**Дата завершения:** 2025-12-11 13:26 (UTC+3, Брест)  
**Статус:** ✅ Завершена  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Родитель:** TASK-026 (Система конфигурации значения "В работе" для сектора 1С)

## Цель
Обновить маппер тикетов для корректной работы с полем Bitrix24 `UF_SLA_SERVICE_STR`, используя новый конфиг `service-config.js` (этап 026-01). Обеспечить корректное извлечение значения "В работе", регистронезависимую обработку, fallback для пустых/неизвестных значений, обратную совместимость и подготовку к отображению в UI.

## Контекст
- Источник: поле `UF_SLA_SERVICE_STR` в Bitrix24, значение — текст.  
- Использование: плашка "В работе" в карточках тикетов (канбан, дашборд сектора 1С).  
- Конфиг: `vue-app/src/config/service-config.js` (добавлен на этапе 026-01).  
- Важно: конфиг и маппинг относятся только к сектору 1С. Для других секторов будут отдельные конфиги/мапперы.
- Аналогия: подход как в задачах по приоритетам (`TASK-025-02`), но для `UF_SLA_SERVICE_STR`.

## Область работ и файлы
- **Основной файл для изменения:**  
  - `vue-app/src/services/dashboard-sector-1c/mappers/ticket-mapper.js`
- **Ссылочно (без изменений в этом этапе):**  
  - `vue-app/src/config/service-config.js` — источник конфигурации и утилит.  
  - `vue-app/src/components/dashboard/TicketCard.vue` — будет использовать результат маппера на этапе 026-03.  
  - `vue-app/src/services/dashboard-sector-1c/utils/constants.js` — проверить, не требуется ли поддержка старых полей (обратная совместимость).

## Требования к маппингу
- Извлекать `UF_SLA_SERVICE_STR` из объекта тикета. Учитывать возможные варианты именования:  
  - `UF_SLA_SERVICE_STR`, `uf_sla_service_str`, `UfSlaServiceStr`, `ufSlaServiceStr`.  
- Нормализовать значение (trim, toLowerCase) перед поиском в конфиге.
- Использовать утилиты конфига:  
  - `getServiceByBitrixValue(value)` → объект из конфига или fallback.  
  - `getDefaultService()` — fallback.  
  - `isValidService(value)` — проверка наличия значения в конфиге.  
- Fallback: если значение пустое/неизвестное → вернуть объект fallback (из конфига).  
- Обратная совместимость: если ранее использовалось другое поле/формат, добавить безопасный fallback (например, существующий `service` или аналог, если есть в коде; не ломать старые вызовы).  
- Не менять структуру публичного интерфейса маппера для других данных тикета (минимальные правки).  
- Логирование (dev): можно логировать неидентифицированные значения (временно), но в проде — тихий fallback (как в приоритетах).  

## Подзадачи
1. Импортировать конфиг и утилиты из `service-config.js` в `ticket-mapper.js`.  
2. Добавить нормализованный геттер значения `UF_SLA_SERVICE_STR` (учесть регистр/форматы).  
3. Встроить маппинг через `getServiceByBitrixValue` и fallback.  
4. Обновить обратный маппинг (в сторону Bitrix24), чтобы при отправке использовалось корректное текстовое значение `bitrixValue`.  
5. Сохранить обратную совместимость: если старое поле (например, `service`) использовалось, подхватывать его как запасной источник (при отсутствии `UF_SLA_SERVICE_STR`).  
6. Добавить (опционально, dev) логирование неизвестных значений, завернуть под условие окружения или оставить комментарий-тоггл.  
7. Убедиться, что итоговая структура данных, которую потребляет UI, содержит полный объект сервиса (или поля, ожидаемые компонентом).  
8. Самопроверка импорта/экспорта: сборка не должна ломаться.

## Интерфейс данных (для UI)
- Рекомендуется возвращать объект сервиса (из конфига) либо, если используется упрощённая форма, вернуть ключевые поля:  
  ```javascript
  {
    service: {
      id,
      label,
      bitrixValue,
      color,
      backgroundColor,
      textColor,
      order,
      description
    }
  }
  ```  
  или `service` (объект) как часть `mappedTicket`. Финальный контракт согласовать с текущим использованием в `TicketCard.vue` (этап 026-03).

## Критерии приёмки (для этапа 026-02) ✅
- [x] `ticket-mapper.js` извлекает `UF_SLA_SERVICE_STR` с учётом разных кейсов именования.  
- [x] Нормализация значения перед маппингом (trim + lower).  
- [x] Используется конфиг `service-config.js` и утилиты (`getServiceByBitrixValue`, fallback).  
- [x] Fallback срабатывает для пустых/неизвестных значений.  
- [x] Обратный маппинг в Bitrix24 отправляет текстовое `bitrixValue`.  
- [x] Обратная совместимость сохранена (старое поле не ломает маппинг, если ещё используется).  
- [x] Нет регрессий в других полях маппера.  
- [x] Импорты/экспорты валидны, сборка не ломается.

## Тестирование (быстрый чек)
- Смоделировать объект тикета с разными вариантами поля:  
  - `UF_SLA_SERVICE_STR: '1С.Бухгалтерия'` → маппинг возвращает объект сервиса с label "1С.Бухгалтерия".  
  - `uf_sla_service_str: '1с.зуп'` (нижний регистр) → корректный объект "1С.ЗУП".  
  - Отсутствует/`''`/`null` → fallback.  
  - Неизвестное значение `"Foo"` → fallback (опционально лог dev).  
- Обратный маппинг: при отправке тикета/обновлении значение должно уходить в Bitrix24 как строка (`bitrixValue`).  
- Сборка: `npm run build` не ломается из-за импортов/экспортов.

## Зависимости/заметки
- Требуется наличие `UF_SLA_SERVICE_STR` в ответах Bitrix24 (`crm.item.list`).  
- Конфиг `service-config.js` должен быть завершён (этап 026-01).  
- Для других секторов маппинг будет аналогичный, но с другими конфигами — не смешивать.  
- Логирование неизвестных значений в проде — без шума (тихий fallback).

## История правок
- 2025-12-11 18:55 (UTC+3, Брест): Создана задача 026-02.
- 2025-12-11 13:26 (UTC+3, Брест): ✅ Этап успешно выполнен. Маппер обновлён для работы с `UF_SLA_SERVICE_STR`, интегрирован конфиг, добавлен fallback и обратный маппинг. Обратная совместимость сохранена.

