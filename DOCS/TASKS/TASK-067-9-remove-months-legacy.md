# TASK-067-9: Удаление месячного режима из legacy файла

**Дата создания:** 2025-12-23 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Средний  
**Родитель:** TASK-067  
**Цель:** Удалить код месячного режима из legacy файла после успешного переноса в новый модуль.

## Область
- Создать резервную копию legacy файла
- Удалить код месячного режима (строки 640-1693)
- Оставить только:
  - Общие функции (если они не используются новым модулем)
  - Прокси для обоих режимов (weeks и months)
  - Обработку ошибок
- Проверить синтаксис PHP
- Протестировать прокси

## Требования к реализации
- Файл: `api/graph-1c-admission-closure.php`
- После удаления файл должен содержать:
  - setupAppLogging() — если используется
  - jsonResponse(), parseJsonBody() — если используются
  - Прокси для weeks и months режимов
  - Обработку ошибок (try-catch)
- Удалить:
  - Код месячного режима (if ($periodMode === 'months') { ... })
  - Все функции, которые используются только месячным режимом (если они не нужны новому модулю)

## Детальная структура файла после удаления

### Что остаётся в legacy файле

#### 1. Заголовок и require (строки 1-16)
```php
<?php
/**
 * API endpoint: График приёма и закрытий сектора 1С
 * ...
 */
require_once __DIR__ . '/../crest.php';
require_once __DIR__ . '/cache/GraphAdmissionClosureCache.php';
```

#### 2. setupAppLogging() (строки 25-41)
- Оставляем, если используется новым модулем
- Или удаляем, если новый модуль использует свою логику

#### 3. jsonResponse() и parseJsonBody() (строки 46-60)
- **Важно:** Эти функции могут использоваться новым модулем через require
- Проверить, использует ли bootstrap.php эти функции
- Если да — оставить
- Если нет — можно удалить (новый модуль имеет свои функции)

#### 4. Прокси для обоих режимов (строки 663-672)
```php
// TASK-065: Для недельного режима используем новый модуль
if ($periodMode === 'weeks') {
    require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
    exit;
}

// TASK-067-8: Для месячного режима используем новый модуль
if ($periodMode === 'months') {
    require_once __DIR__ . '/graph-admission-closure/bootstrap.php';
    exit;
}
```

#### 5. Обработка ошибок (строки 2788-2794)
```php
} catch (Exception $e) {
    http_response_code(500);
    jsonResponse([
        'success' => false,
        'message' => 'Ошибка получения данных: ' . $e->getMessage()
    ]);
}
```

### Что удаляется

#### 1. Код месячного режима (строки 669-1693)
- Весь блок `if ($periodMode === 'months') { ... }`
- Включает:
  - Проверку кеша
  - Расчёт месяцев
  - Загрузку тикетов
  - Агрегацию
  - Формирование ответа
  - Сохранение в кеш

#### 2. Функции, используемые только месячным режимом
- Проверить каждую функцию:
  - `calculateLastFourMonths()` — используется только месячным режимом? → удалить (перенесена в DatePeriodHelper)
  - `calculateWeeksInMonth()` — используется только месячным режимом? → удалить (перенесена в DatePeriodHelper)
  - `getWeekBounds()`, `getFourWeeksBounds()` — используются недельным режимом? → оставить (используются новым модулем)
  - `calculateWeekMetrics()` — используется месячным режимом? → удалить (перенесена в Aggregator)
  - `isCarryoverTicket()` — используется месячным режимом? → удалить (перенесена в Aggregator)
  - `isInRange()` — используется месячным режимом? → удалить (перенесена в DatePeriodHelper)
  - `calculateDurationCategory()` — используется месячным режимом? → удалить (перенесена в DatePeriodHelper)

#### 3. Мёртвый код недельного режима (строки 1695-2787)
- Уже должен быть удалён в первой части TASK-067
- Если остался — удалить

## План выполнения
1) Создать резервную копию legacy файла:
   ```bash
   cp api/graph-1c-admission-closure.php api/graph-1c-admission-closure.php.backup
   ```
   - Или закоммитить в git перед удалением
2) Проверить, какие функции используются новым модулем:
   - **Проверить bootstrap.php:**
     - Использует ли `jsonResponse()` и `parseJsonBody()`?
     - Если да — оставить в legacy
     - Если нет — можно удалить
   - **Проверить DatePeriodHelper:**
     - Все функции дат перенесены? → можно удалить из legacy
   - **Проверить Aggregator:**
     - Все функции агрегации перенесены? → можно удалить из legacy
3) Удалить код месячного режима:
   - **Удалить блок if ($periodMode === 'months'):**
     - Найти строку 669: `if ($periodMode === 'months') {`
     - Найти строку 1693: закрывающая скобка `}`
     - Удалить весь блок (строки 669-1693)
   - **Удалить функции, используемые только месячным режимом:**
     - `calculateLastFourMonths()` (строки 181-220)
     - `calculateWeeksInMonth()` (строки 230-268) — если не используется
     - Другие функции после проверки
4) Оставить только прокси и обработку ошибок:
   - Заголовок и require
   - setupAppLogging() — если нужен
   - jsonResponse(), parseJsonBody() — если используются новым модулем
   - Прокси для weeks и months
   - Обработка ошибок (try-catch)
5) Проверить синтаксис PHP:
   ```bash
   php -l api/graph-1c-admission-closure.php
   ```
   - Должно быть: `No syntax errors detected`
6) Протестировать прокси:
   - **Тест 1: weeks режим**
     - Запрос: `{"periodMode": "weeks"}`
     - Ожидаемое: ответ из нового модуля
   - **Тест 2: months режим**
     - Запрос: `{"periodMode": "months"}`
     - Ожидаемое: ответ из нового модуля
   - **Тест 3: Обработка ошибок**
     - Невалидный periodMode: `{"periodMode": "invalid"}`
     - Ожидаемое: ошибка 400
   - **Тест 4: Размер файла**
     - До удаления: ~2796 строк
     - После удаления: ~100-200 строк (только прокси)

## Артефакты
- Обновлённый `api/graph-1c-admission-closure.php` (тонкий прокси)
- Резервная копия (если нужна)

## Критерии приёмки
- [ ] Код месячного режима удалён из legacy
- [ ] Legacy файл стал тонким прокси
- [ ] Синтаксис PHP корректен
- [ ] Прокси работает корректно:
  - weeks режим перенаправляется на новый модуль
  - months режим перенаправляется на новый модуль
- [ ] Обработка ошибок работает
- [ ] Файл стал значительно короче

## Риски и заметки
- Важно не удалить функции, которые используются новым модулем через require
- Резервная копия критична на случай проблем
- После удаления legacy файл должен быть максимально простым (только прокси)

