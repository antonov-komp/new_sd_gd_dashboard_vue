# Карта зависимостей модуля логирования вебхуков

**Дата создания:** 2025-12-07

---

## 🔗 Зависимости между компонентами

### Граф зависимостей

```
┌─────────────────────────────────┐
│   webhook-handler.php            │
│   (352 строки, 5 функций)        │
├─────────────────────────────────┤
│ • getWebhookSecret()             │
│ • validateWebhookSignature()     │
│ • logWebhookEvent()              │
│   └── extractEventDetails()     │
│ • logWebhookError()              │
└─────────────────────────────────┘
           │
           │ Записывает логи
           ▼
┌─────────────────────────────────┐
│   logs/webhooks/                │
│   ├── tasks/                    │
│   ├── smart-processes/          │
│   └── errors/                   │
└─────────────────────────────────┘
           ▲
           │ Читает логи
           │
┌─────────────────────────────────┐
│   webhook-logs.php              │
│   (153 строки, 0 функций)       │
├─────────────────────────────────┤
│ • readLogsForDate() [анонимная] │
│ • Фильтрация по category        │
│ • Фильтрация по event           │
│ • Сортировка по timestamp       │
│ • Пагинация                     │
└─────────────────────────────────┘
           │
           │ Используется Vue.js
           ▼
┌─────────────────────────────────┐
│   WebhookLogsApiService         │
│   (vue-app/src/services/)       │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│   webhook-realtime.php          │
│   (160 строк, 3 функции)        │
├─────────────────────────────────┤
│ • sendEvent()                   │
│ • sendComment()                 │
│ • checkForNewLogs()             │
└─────────────────────────────────┘
           │
           │ Используется Vue.js
           ▼
┌─────────────────────────────────┐
│   useRealtime composable        │
│   (vue-app/src/composables/)    │
└─────────────────────────────────┘
```

---

## 📦 Внешние зависимости

### PHP зависимости
- `crest.php` - подключен, но не используется
- Стандартные PHP функции: `file_get_contents`, `file_put_contents`, `json_encode`, `json_decode`

### Глобальные переменные
- `$_SERVER` - используется для получения заголовков, IP, метода запроса
- `$_GET` - используется для получения параметров фильтрации
- `$_POST` - используется для получения данных вебхука
- `$_REQUEST` - не используется

### Файловая система
- `logs/webhooks/` - структура директорий для хранения логов
- Формат файлов: `YYYY-MM-DD-HH.json`

---

## 🔄 Потоки данных

### Поток 1: Обработка вебхука
```
Bitrix24 → webhook-handler.php → logs/webhooks/{category}/YYYY-MM-DD-HH.json
```

### Поток 2: Чтение логов
```
Vue.js → WebhookLogsApiService → /api/webhook-logs.php → logs/webhooks/ → JSON ответ
```

### Поток 3: Realtime обновления
```
Vue.js → useRealtime → /api/webhook-realtime.php → logs/webhooks/ → SSE события
```

---

## ⚠️ Проблемы зависимостей

1. **Прямые обращения к файловой системе**
   - Все компоненты напрямую работают с файлами
   - Нет абстракции для работы с хранилищем

2. **Дублирование логики чтения/записи**
   - Каждый компонент реализует свою логику работы с файлами
   - Нет единого места для управления файлами

3. **Жёсткая связь с форматом хранения**
   - Изменение формата хранения потребует изменений во всех компонентах
   - Нет возможности легко перейти на другое хранилище (БД, кеш)

---

## 💡 Рекомендации

1. Создать `WebhookLogsRepository` для абстракции работы с файлами
2. Использовать паттерн Repository для изоляции логики хранения
3. Добавить интерфейс для работы с хранилищем (для возможной миграции на БД)







