# Анализ работы модуля "График приема и закрытий сектора 1С"

**Дата создания:** 2025-12-23 14:58 (UTC+3, Брест)  
**Версия:** 1.0  
**Автор:** Технический писатель  
**Статус:** Актуально

---

## Оглавление

1. [Обзор модуля](#обзор-модуля)
2. [Архитектура модуля](#архитектура-модуля)
3. [Режимы работы](#режимы-работы)
4. [Механизм кеширования](#механизм-кеширования)
5. [Потоки данных](#потоки-данных)
6. [Производительность](#производительность)
7. [Зависимости и интеграции](#зависимости-и-интеграции)
8. [Рекомендации по оптимизации](#рекомендации-по-оптимизации)

---

## Обзор модуля

### Назначение

Модуль "График приема и закрытий сектора 1С" (`graph-1c-admission-closure.php`) предоставляет API endpoint для получения статистики по тикетам смарт-процесса 140 (сектор 1С) в Bitrix24.

### Основные функции

- Подсчёт новых тикетов за период
- Подсчёт закрытых тикетов за период
- Подсчёт переходящих тикетов (в работе)
- Агрегация по стадиям, ответственным, срокам
- Поддержка двух режимов отображения: **4 недели** и **3 месяца**

### Точка входа

**Legacy endpoint:** `api/graph-1c-admission-closure.php`  
**Новый модуль:** `api/graph-admission-closure/bootstrap.php`

---

## Архитектура модуля

### Структура файлов

```
api/
├── graph-1c-admission-closure.php          # Legacy точка входа (перенаправляет на bootstrap.php)
├── graph-admission-closure/                # Новый модульный код
│   ├── bootstrap.php                      # Точка входа нового модуля
│   ├── controller/
│   │   └── GraphAdmissionClosureController.php
│   ├── service/
│   │   └── GraphAdmissionClosureService.php
│   ├── bitrix/
│   │   └── BitrixClient.php
│   ├── domain/
│   │   └── Aggregator.php
│   ├── cache/
│   │   └── CacheStore.php
│   ├── config/
│   │   └── Config.php
│   └── util/
│       └── DatePeriodHelper.php
└── cache/
    └── GraphAdmissionClosureCache.php     # Реализация файлового кеша
```

### Слои архитектуры

1. **Controller** (`GraphAdmissionClosureController`)
   - Парсинг входных данных
   - Делегирование в сервисный слой
   - Формирование ответа

2. **Service** (`GraphAdmissionClosureService`)
   - Оркестрация бизнес-логики
   - Выбор режима работы (weeks/months)
   - Управление кешированием
   - Формирование структуры ответа

3. **BitrixClient** (`BitrixClient`)
   - Загрузка данных из Bitrix24 через REST API
   - Пагинация запросов
   - Фильтрация по продукту

4. **Aggregator** (`Aggregator`)
   - Агрегация метрик по неделям/месяцам
   - Подсчёт переходящих тикетов
   - Разбивка по стадиям и ответственным

5. **CacheStore** (`CacheStore`)
   - Обёртка над `GraphAdmissionClosureCache`
   - Управление кешем для режима "3 месяца"

6. **Config** (`Config`)
   - Централизованная конфигурация
   - Стадии, ID хранителя, размер страницы

---

## Режимы работы

### Режим "4 недели" (`periodMode: 'weeks'`)

**Характеристики:**
- **Кеширование:** ❌ Отсутствует (всегда прямой запрос к Bitrix24)
- **Период:** Текущая неделя + 3 предыдущие (ISO-8601)
- **Обработка:** Метод `handle()` в `GraphAdmissionClosureService`
- **Производительность:** Медленнее (каждый запрос = загрузка данных из Bitrix24)

**Поток выполнения:**

```php
// 1. Определение границ 4 недель
$weeks = $this->dateHelper->getFourWeeksBounds($weekStart, $weekEnd);

// 2. Загрузка тикетов из Bitrix24 (БЕЗ кеша)
$createdTickets = $this->bitrixClient->fetchCreatedTickets($periodStart, $periodEnd);
$closedTickets = $this->bitrixClient->fetchClosedTickets($periodStart, $periodEnd);
$carryoverTickets = $this->bitrixClient->fetchCarryoverTickets(...);

// 3. Фильтрация по product=1C
$tickets = $this->bitrixClient->filterByProduct($allTickets, $product);

// 4. Агрегация метрик
$aggregated = $this->aggregator->aggregateWeeks(...);

// 5. Формирование ответа
return $response;
```

**Особенности:**
- Каждый запрос выполняет полную загрузку данных из Bitrix24
- Нет проверки кеша
- Нет сохранения результатов в кеш
- Актуальные данные в реальном времени

### Режим "3 месяца" (`periodMode: 'months'`)

**Характеристики:**
- **Кеширование:** ✅ Работает (TTL: 300 секунд = 5 минут)
- **Период:** Последние 3 месяца (для отображения) + 4-й месяц (для процентов)
- **Обработка:** Метод `handleMonthsMode()` в `GraphAdmissionClosureService`
- **Производительность:** Быстрее (использует кеш)

**Поток выполнения:**

```php
// 1. Проверка кеша (если не forceRefresh)
$cacheKey = $this->cacheStore->generateKey([...]);
$cachedData = $this->cacheStore->get($cacheKey);
if ($cachedData !== null) {
    return $cachedData; // Возврат из кеша
}

// 2. Если кеш не найден - загрузка данных из Bitrix24
$allMonths = $this->dateHelper->calculateLastFourMonths();
$allTickets = $this->bitrixClient->fetchTicketsForMonths(...);

// 3. Агрегация метрик
$aggregationResult = $this->aggregator->aggregateMonths(...);

// 4. Формирование ответа
$response = [...];

// 5. Сохранение в кеш
$this->cacheStore->set($cacheKey, $response, 300);

// 6. Периодическая очистка устаревших кешей (каждый 10-й запрос)
if (rand(1, 10) === 1) {
    $this->cacheStore->clearExpired();
}

return $response;
```

**Особенности:**
- Проверка кеша перед загрузкой данных
- Сохранение результатов в кеш после обработки
- TTL кеша: 5 минут (300 секунд)
- Параметр `forceRefresh` для принудительного обновления
- Периодическая очистка устаревших кешей

---

## Механизм кеширования

### Реализация кеша

**Класс:** `GraphAdmissionClosureCache`  
**Расположение:** `api/cache/GraphAdmissionClosureCache.php`  
**Тип:** Файловый кеш (JSON файлы)

### Структура кеша

**Директория:** `api/cache/graph-admission-closure/months/`  
**Формат файлов:** `{cacheKey}.json`

**Структура данных в кеше:**

```json
{
  "data": {
    "success": true,
    "meta": {...},
    "data": {...}
  },
  "metadata": {
    "created_at": 1703328000,
    "expires_at": 1703328300,
    "ttl": 300
  }
}
```

### Генерация ключа кеша

**Метод:** `GraphAdmissionClosureCache::generateKey()`

**Параметры, влияющие на ключ:**
- `product` (по умолчанию: '1C')
- `periodMode` (по умолчанию: 'months')
- `includeTickets` (по умолчанию: false)
- `includeNewTicketsByStages` (по умолчанию: false)
- `includeCarryoverTickets` (по умолчанию: true)
- `includeCarryoverTicketsByDuration` (по умолчанию: false)

**Формат ключа:** `months_{MD5_хеш_параметров}`

**Пример:** `months_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

### Операции с кешем

1. **Получение данных** (`get()`)
   - Проверка существования файла
   - Проверка истечения TTL
   - Автоматическое удаление истёкших файлов
   - Возврат `null` если кеш не найден/истёк

2. **Сохранение данных** (`set()`)
   - Создание директории, если не существует
   - Атомарная запись через временный файл
   - Формирование метаданных (created_at, expires_at, TTL)

3. **Очистка устаревших** (`clearExpired()`)
   - Сканирование всех файлов в директории
   - Удаление файлов с истёкшим TTL
   - Возврат количества удалённых файлов

4. **Очистка всего кеша** (`clear()`)
   - Удаление всех JSON файлов в директории

### Когда используется кеш

**Режим "4 недели":**
- ❌ Кеш **не используется**
- Всегда прямой запрос к Bitrix24

**Режим "3 месяца":**
- ✅ Кеш **используется**
- Проверка кеша перед загрузкой данных
- Сохранение результатов в кеш после обработки
- TTL: 300 секунд (5 минут)

### Параметр `forceRefresh`

**Назначение:** Принудительное обновление кеша

**Использование:**
```json
{
  "periodMode": "months",
  "forceRefresh": true
}
```

**Поведение:**
- Пропускает проверку кеша
- Всегда загружает данные из Bitrix24
- Сохраняет новые данные в кеш

---

## Потоки данных

### Режим "4 недели" (без кеша)

```
[Клиент]
    ↓ POST /api/graph-1c-admission-closure.php
    ↓ { "periodMode": "weeks" }
[graph-1c-admission-closure.php]
    ↓ require bootstrap.php
[bootstrap.php]
    ↓ Инициализация зависимостей
[GraphAdmissionClosureController]
    ↓ handle($payload)
[GraphAdmissionClosureService]
    ↓ handle() → handleWeeksMode()
    ↓ НЕТ проверки кеша
[BitrixClient]
    ↓ fetchCreatedTickets()
    ↓ fetchClosedTickets()
    ↓ fetchCarryoverTickets()
    ↓ REST API Bitrix24
[Bitrix24]
    ↓ Возврат данных
[BitrixClient]
    ↓ Фильтрация по product=1C
[Aggregator]
    ↓ aggregateWeeks()
    ↓ Подсчёт метрик
[GraphAdmissionClosureService]
    ↓ Формирование ответа
    ↓ НЕТ сохранения в кеш
[GraphAdmissionClosureController]
    ↓ JSON ответ
[Клиент]
```

### Режим "3 месяца" (с кешем)

```
[Клиент]
    ↓ POST /api/graph-1c-admission-closure.php
    ↓ { "periodMode": "months" }
[graph-1c-admission-closure.php]
    ↓ require bootstrap.php
[bootstrap.php]
    ↓ Инициализация зависимостей
[GraphAdmissionClosureController]
    ↓ handle($payload)
[GraphAdmissionClosureService]
    ↓ handle() → handleMonthsMode()
    ↓ Проверка кеша
[CacheStore]
    ↓ get($cacheKey)
[GraphAdmissionClosureCache]
    ↓ Проверка файла кеша
    ↓ Проверка TTL
    ├─ [Кеш найден и актуален]
    │  ↓ Возврат данных из кеша
    │  ↓ JSON ответ
    │  [Клиент] ← Быстрый ответ
    │
    └─ [Кеш не найден/истёк]
       ↓ Загрузка данных
[BitrixClient]
    ↓ fetchTicketsForMonths()
    ↓ REST API Bitrix24
[Bitrix24]
    ↓ Возврат данных
[BitrixClient]
    ↓ Фильтрация по product=1C
[Aggregator]
    ↓ aggregateMonths()
    ↓ Подсчёт метрик
[GraphAdmissionClosureService]
    ↓ Формирование ответа
    ↓ Сохранение в кеш
[CacheStore]
    ↓ set($cacheKey, $response, 300)
[GraphAdmissionClosureCache]
    ↓ Сохранение в файл
[GraphAdmissionClosureController]
    ↓ JSON ответ
[Клиент]
```

---

## Производительность

### Режим "4 недели"

**Время выполнения:**
- Зависит от количества тикетов в Bitrix24
- Типичное время: 2-5 секунд
- Нет кеширования → каждый запрос = полная загрузка

**Факторы влияния:**
- Количество тикетов за период (4 недели)
- Количество переходящих тикетов (если `includeCarryoverTickets: true`)
- Скорость ответа Bitrix24 REST API
- Количество пагинаций (pageSize: 50)

**Логирование производительности:**
- Нет специального логирования времени выполнения
- Логируются только ошибки и отладочная информация

### Режим "3 месяца"

**Время выполнения:**

1. **При попадании в кеш (cache hit):**
   - Типичное время: 0.01-0.05 секунд
   - Логируется: `[MONTHS-PERFORMANCE] Total execution time (from cache): X.XXX seconds`

2. **При промахе кеша (cache miss):**
   - Типичное время: 5-15 секунд
   - Зависит от количества тикетов за 4 месяца
   - Логируется: `[MONTHS-PERFORMANCE] Total execution time: XX.XX seconds`

**Факторы влияния:**
- Количество тикетов за период (4 месяца)
- Количество переходящих тикетов
- Скорость ответа Bitrix24 REST API
- Количество пагинаций

**Логирование производительности:**
```php
error_log("[MONTHS-PERFORMANCE] Total execution time (from cache): " . round($cacheResponseTime, 3) . " seconds");
error_log("[MONTHS-PERFORMANCE] Total execution time: " . round($monthsModeTotalTime, 2) . " seconds");
```

### Сравнение производительности

| Режим | Кеширование | Типичное время | Максимальное время |
|-------|-------------|----------------|-------------------|
| 4 недели | ❌ Нет | 2-5 сек | 10+ сек |
| 3 месяца (cache hit) | ✅ Да | 0.01-0.05 сек | 0.1 сек |
| 3 месяца (cache miss) | ✅ Да | 5-15 сек | 30+ сек |

---

## Зависимости и интеграции

### Внешние зависимости

1. **Bitrix24 REST API**
   - Метод: `crm.item.list`
   - Документация: https://context7.com/bitrix24/rest/crm.item.list
   - Используется для загрузки тикетов

2. **CRest** (`crest.php`)
   - Обёртка над Bitrix24 REST API
   - Используется в `BitrixClient`

### Внутренние зависимости

1. **Config** (`Config.php`)
   - EntityTypeId: 140
   - PageSize: 50
   - KeeperId: 1051
   - Стадии (targetStages, closingStages)

2. **DatePeriodHelper** (`DatePeriodHelper.php`)
   - Работа с датами (ISO-8601)
   - Расчёт границ недель/месяцев

3. **CacheStore** → **GraphAdmissionClosureCache**
   - Файловый кеш
   - Только для режима "3 месяца"

### Конфигурация смарт-процесса 140

**Рабочие стадии (targetStages):**
- `DT140_12:UC_0VHWE2` - Сформировано обращение
- `DT140_12:PREPARATION` - Рассмотрение ТЗ
- `DT140_12:CLIENT` - Исполнение

**Закрывающие стадии (closingStages):**
- `DT140_12:SUCCESS` - Успешное закрытие
- `DT140_12:FAIL` - Отклонено
- `DT140_12:UC_0GBU8Z` - Закрыли без задачи

**Фильтр по продукту:**
- `product: '1C'` (по умолчанию)
- Поле: `UF_CRM_7_TYPE_PRODUCT` или `ufCrm7TypeProduct`

---

## Рекомендации по оптимизации

### Для режима "4 недели"

**Проблема:** Отсутствие кеширования приводит к медленным ответам при каждом запросе.

**Рекомендации:**

1. **Добавить кеширование (аналогично режиму "3 месяца")**
   - TTL: 60-120 секунд (1-2 минуты)
   - Кеш должен учитывать `weekStartUtc` и `weekEndUtc` в ключе
   - Параметр `forceRefresh` для принудительного обновления

2. **Оптимизация запросов к Bitrix24**
   - Использовать батч-запросы, если возможно
   - Кешировать список переходящих тикетов отдельно (они меняются реже)

3. **Логирование производительности**
   - Добавить логирование времени выполнения (как в режиме "3 месяца")
   - Отслеживать медленные запросы

### Для режима "3 месяца"

**Текущее состояние:** Кеширование работает хорошо.

**Рекомендации:**

1. **Настройка TTL**
   - Текущий TTL: 300 секунд (5 минут)
   - Рекомендуется: 180-300 секунд (3-5 минут)
   - Зависит от частоты обновления данных в Bitrix24

2. **Очистка кеша**
   - Текущая: случайная очистка (каждый 10-й запрос)
   - Рекомендуется: cron-задача для периодической очистки
   - Или: очистка при каждом cache miss (если файл истёк)

3. **Мониторинг кеша**
   - Логировать статистику cache hit/miss
   - Отслеживать размер директории кеша
   - Алерты при проблемах с записью кеша

### Общие рекомендации

1. **Единообразие режимов**
   - Добавить кеширование в режим "4 недели"
   - Унифицировать логику работы с кешем

2. **Мониторинг производительности**
   - Централизованное логирование времени выполнения
   - Метрики cache hit/miss ratio
   - Алерты при медленных запросах (>10 секунд)

3. **Оптимизация структуры кеша**
   - Рассмотреть использование Redis вместо файлового кеша
   - Кеширование отдельных компонентов (тикеты, метрики)

4. **Документация**
   - Документировать различия между режимами
   - Указать рекомендации по использованию `forceRefresh`

---

## Заключение

### Текущее состояние

- ✅ Режим "3 месяца" работает с кешированием
- ❌ Режим "4 недели" не использует кеш (всегда прямой запрос)
- ✅ Архитектура модульная и расширяемая
- ✅ Логирование производительности для режима "3 месяца"

### Ключевые различия

| Аспект | Режим "4 недели" | Режим "3 месяца" |
|--------|------------------|-------------------|
| Кеширование | ❌ Нет | ✅ Да (TTL: 300 сек) |
| Производительность | Медленнее (2-5 сек) | Быстрее (0.01-0.05 сек из кеша) |
| Логирование времени | ❌ Нет | ✅ Да |
| Параметр forceRefresh | ❌ Не используется | ✅ Используется |

### Следующие шаги

1. Добавить кеширование в режим "4 недели"
2. Унифицировать логику работы с кешем
3. Добавить мониторинг производительности для обоих режимов
4. Рассмотреть миграцию на Redis для кеша

---

**История правок:**
- 2025-12-23 14:58 (UTC+3, Брест): Создан документ с глобальным анализом работы модуля

