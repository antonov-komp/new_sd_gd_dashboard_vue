# Устранение проблем с вебхуками Bitrix24

**Дата создания:** 2025-12-06 (UTC+3, Брест)

---

## Проверка текущего состояния

### 1. Проверка логов

Запустите скрипт проверки:
```bash
php check-webhook-logs.php
```

Или проверьте вручную:
```bash
# Проверка наличия файлов логов
ls -lah logs/webhooks/tasks/
ls -lah logs/webhooks/smart-processes/
ls -lah logs/webhooks/errors/

# Просмотр последних логов
cat logs/webhooks/tasks/$(date +%Y-%m-%d-%H).json
```

### 2. Мониторинг в реальном времени

Запустите скрипт мониторинга:
```bash
./monitor-webhooks.sh
```

Скрипт будет обновляться каждые 2 секунды и показывать новые события.

---

## Типичные проблемы

### Проблема: Логи пустые, события не приходят

**Возможные причины:**

1. **Неправильный URL в Bitrix24**
   - Проверьте URL вебхука в настройках Bitrix24
   - Должен быть: `https://your-domain.com/api/webhook-handler.php`
   - Убедитесь, что используется HTTPS (если настроен SSL)

2. **Endpoint недоступен извне**
   - Проверьте доступность: `curl https://your-domain.com/api/webhook-handler.php`
   - Проверьте настройки веб-сервера (nginx/apache)
   - Проверьте firewall

3. **События не выбраны в настройках вебхука**
   - В Bitrix24 проверьте, какие события выбраны для вебхука
   - Должны быть выбраны: Задачи, Смарт-процессы

4. **Валидация подписи блокирует запросы**
   - Проверьте токен в `webhook-secret.php`
   - Убедитесь, что токен совпадает с токеном в Bitrix24

### Проблема: Ошибка валидации подписи (HTTP 401)

**Решение:**

1. Проверьте токен в `webhook-secret.php`:
   ```bash
   cat webhook-secret.php
   ```

2. Убедитесь, что токен совпадает с токеном в Bitrix24

3. Проверьте, как Bitrix24 отправляет подпись:
   - В заголовке `X-Bitrix-Signature`
   - В URL как параметр `?token=xxx`
   - В payload запроса

4. Временно отключите валидацию для теста (не рекомендуется для продакшена):
   - Переименуйте `webhook-secret.php` в `webhook-secret.php.bak`
   - Handler продолжит работу без валидации

### Проблема: Endpoint возвращает 404

**Решение:**

1. Проверьте путь к файлу:
   ```bash
   ls -la api/webhook-handler.php
   ```

2. Проверьте настройки веб-сервера:
   - Nginx: проверьте `location` для `/api/`
   - Apache: проверьте `.htaccess` или конфигурацию виртуального хоста

3. Проверьте права доступа:
   ```bash
   chmod 644 api/webhook-handler.php
   ```

### Проблема: Логи не создаются

**Решение:**

1. Проверьте права на папку:
   ```bash
   chmod -R 755 logs/webhooks/
   chown -R www-data:www-data logs/webhooks/  # или ваш пользователь веб-сервера
   ```

2. Проверьте, что PHP может писать в папку:
   ```bash
   php -r "echo is_writable('logs/webhooks') ? 'OK' : 'НЕТ ПРАВ';"
   ```

---

## Тестирование

### 1. Тест endpoint локально

```bash
./test-webhook-endpoint.sh localhost
```

### 2. Тест с реальным доменом

```bash
./test-webhook-endpoint.sh your-domain.com
```

### 3. Ручной тест через curl

```bash
curl -X POST https://your-domain.com/api/webhook-handler.php \
  -H "Content-Type: application/json" \
  -H "X-Bitrix-Signature: test" \
  -d '{"event":"ONTASKADD","data":{"TASK":{"ID":"123","TITLE":"Тест"}}}'
```

---

## Проверка в Bitrix24

1. **Настройки вебхука:**
   - Перейдите в Настройки → Разработчикам → Другое → Исходящие вебхуки
   - Проверьте URL вебхука
   - Проверьте выбранные события
   - Проверьте статус вебхука (активен/неактивен)

2. **Тестовое событие:**
   - Создайте задачу в Bitrix24
   - Или создайте элемент смарт-процесса
   - Проверьте логи через 1-2 минуты

3. **Логи Bitrix24:**
   - В настройках вебхука может быть раздел "История отправок"
   - Проверьте, отправляются ли запросы

---

## Полезные команды

```bash
# Проверка логов
php check-webhook-logs.php

# Мониторинг в реальном времени
./monitor-webhooks.sh

# Просмотр последних логов
tail -f logs/webhooks/tasks/$(date +%Y-%m-%d-%H).json

# Поиск ошибок
find logs/webhooks/errors -name "*.json" -exec cat {} \;

# Проверка конфигурации
cat webhook-secret.php
```

---

## Контакты для поддержки

Если проблема не решена:
1. Проверьте логи ошибок: `logs/webhooks/errors/`
2. Проверьте логи веб-сервера
3. Соберите информацию:
   - URL вебхука в Bitrix24
   - Результат `php check-webhook-logs.php`
   - Последние ошибки из `logs/webhooks/errors/`

---

## История правок

- **2025-12-06 (UTC+3, Брест):** Создана инструкция по устранению проблем


