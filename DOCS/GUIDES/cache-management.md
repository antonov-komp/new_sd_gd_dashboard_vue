# Управление кешами

**Дата создания:** 2025-12-24 13:50 (UTC+3, Брест)  
**Версия:** 1.0  
**Описание:** Руководство по проверке и очистке кешей в системе

---

## Скрипты для управления кешами

### 1. Проверка кешей

**Скрипт:** `scripts/check-cache.sh`

**Использование:**
```bash
./scripts/check-cache.sh
```

**Что делает:**
- Показывает все существующие файлы кеша
- Выводит количество файлов и размер для каждого модуля
- Показывает общую статистику

**Модули, которые проверяются:**
- `GraphAdmissionClosure` (months и weeks)
- `TimeTracking`
- Статусы задач создания кеша

**Пример вывода:**
```
==========================================
  ПРОВЕРКА ВСЕХ КЕШЕЙ В СИСТЕМЕ
==========================================

1. GraphAdmissionClosure - months:
   Файлов: 0
   Размер: 4.0K

2. GraphAdmissionClosure - weeks:
   Файлов: 0
   Размер: 4.0K

3. TimeTracking:
   Файлов: 0
   Размер: 4.0K

4. Статусы задач создания кеша:
   Файлов: 0
   Размер: 4.0K

==========================================
  ИТОГО
==========================================
Всего файлов кеша: 0
Общий размер: 120K

✅ Кеш пуст - можно начинать тестирование с чистого листа
```

---

### 2. Очистка всех кешей

**Скрипт:** `scripts/clear-cache.sh`

**Использование:**
```bash
# Интерактивная очистка (с подтверждением)
./scripts/clear-cache.sh

# Принудительная очистка (без подтверждения)
./scripts/clear-cache.sh --force
```

**Что делает:**
- Удаляет все файлы кеша из всех модулей
- Очищает статусы задач создания кеша
- Показывает результат очистки

**Безопасность:**
- По умолчанию требует подтверждения (`yes`)
- При использовании `--force` очищает без подтверждения

**Пример вывода:**
```
==========================================
  ОЧИСТКА ВСЕХ КЕШЕЙ
==========================================

Найдено файлов кеша: 2

Начинаю очистку...

1. Очистка GraphAdmissionClosure - months...
   ✅ Очищено
2. Очистка GraphAdmissionClosure - weeks...
   ✅ Очищено
3. Очистка TimeTracking...
   ✅ Очищено
4. Очистка статусов задач...
   ✅ Очищено

==========================================
  РЕЗУЛЬТАТ
==========================================
✅ Все кеши успешно очищены
   Удалено файлов: 2
```

---

## API для управления кешами

### Очистка кеша через API

**Endpoint:** `/api/admin/cache-clear.php`

**Метод:** `POST`

**Параметры:**
```json
{
  "module_id": "all",
  "confirm": true
}
```

**Пример запроса:**
```javascript
fetch('/api/admin/cache-clear.php', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    module_id: 'all',
    confirm: true
  })
})
.then(response => response.json())
.then(data => {
  console.log('Кеш очищен:', data);
});
```

**Ответ (успех):**
```json
{
  "success": true,
  "message": "Cache cleared successfully",
  "cleared_modules": [
    "graph-admission-closure-months",
    "graph-admission-closure-weeks",
    "time-tracking-default",
    "time-tracking-detailed",
    "time-tracking-summary"
  ]
}
```

---

## Структура директорий кеша

```
api/cache/
├── graph-admission-closure/
│   ├── months/          # Кеши для режима "месяцы"
│   └── weeks/           # Кеши для режима "недели"
├── time-tracking-sector-1c/  # Кеши для модуля учёта времени
└── task-status/         # Статусы задач создания кеша
```

---

## Рекомендации

### Перед тестированием

1. **Проверьте текущее состояние кешей:**
   ```bash
   ./scripts/check-cache.sh
   ```

2. **Очистите все кеши для чистого тестирования:**
   ```bash
   ./scripts/clear-cache.sh --force
   ```

3. **Проверьте, что кеши очищены:**
   ```bash
   ./scripts/check-cache.sh
   ```

### После создания кеша вручную

1. **Проверьте, что кеш создан:**
   ```bash
   ./scripts/check-cache.sh
   ```

2. **Откройте модуль и проверьте, что используется созданный кеш**

3. **Проверьте уведомления о использовании кеша**

---

## Устранение проблем

### Кеш не используется после создания

**Проблема:** После ручного создания кеша модуль не использует его и создаёт новый.

**Решение:**
1. Проверьте параметры создания кеша (должны совпадать с параметрами запроса модуля)
2. Проверьте ключ кеша (должен совпадать)
3. Очистите кеш и создайте заново с правильными параметрами

### Кеш не очищается

**Проблема:** Скрипт очистки не удаляет файлы.

**Решение:**
1. Проверьте права доступа к файлам:
   ```bash
   ls -la api/cache/*/
   ```
2. Удалите файлы вручную:
   ```bash
   rm -f api/cache/*/*/*.json
   ```
3. Проверьте права на запись в директории:
   ```bash
   chmod -R 755 api/cache/
   ```

---

## История правок

- 2025-12-24 13:50 (UTC+3, Брест): Создана документация по управлению кешами

