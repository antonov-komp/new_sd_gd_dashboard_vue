# Настройка исходящего вебхука Bitrix24

**Дата создания:** 2025-12-06 (UTC+3, Брест)  
**Версия:** 1.0

---

## Описание

Инструкция по настройке исходящего вебхука в Bitrix24 для отправки событий на наш сервер.

---

## Шаги настройки

### 1. Получение URL endpoint

URL для настройки вебхука в Bitrix24:
```
https://your-domain.com/api/webhook-handler.php
```

Замените `your-domain.com` на ваш реальный домен.

### 2. Настройка вебхука в Bitrix24

1. Перейдите в **Настройки** → **Разработчикам** → **Другое** → **Исходящие вебхуки**
2. Нажмите **Добавить вебхук**
3. Укажите:
   - **URL**: `https://your-domain.com/api/webhook-handler.php`
   - **События**: Выберите нужные события (Задачи, Смарт-процессы)
4. Сохраните вебхук

### 3. Получение токена от Bitrix24

После создания вебхука Bitrix24 предоставит **токен** (секрет) для валидации запросов.

**Способы передачи токена Bitrix24:**

1. **В заголовке запроса** (стандартный способ):
   - Заголовок: `X-Bitrix-Signature`
   - Подпись вычисляется как HMAC-SHA256 от body запроса

2. **В URL как параметр**:
   - URL: `https://your-domain.com/api/webhook-handler.php?token=ваш_токен`
   - Bitrix24 может включать токен в URL вебхука

3. **В payload запроса**:
   - Поле `signature` в JSON payload

**Где найти токен:**
- В настройках созданного вебхука в Bitrix24
- В URL вебхука (если Bitrix24 включает его в URL)
- В документации Bitrix24 по исходящим вебхукам
- Обычно токен отображается при создании/редактировании вебхука

### 4. Сохранение токена на сервере

1. Откройте файл `webhook-secret.php` в корне проекта
2. Замените `YOUR_WEBHOOK_SECRET_HERE` на токен, полученный от Bitrix24:

```php
<?php
return 'ваш_токен_от_bitrix24';
```

3. Сохраните файл

**Важно:** Файл `webhook-secret.php` уже добавлен в `.gitignore` и не попадает в git.

### 5. Проверка работы

1. В Bitrix24 создайте/измените задачу или элемент смарт-процесса
2. Проверьте логи в `logs/webhooks/`:
   - `logs/webhooks/tasks/` — события задач
   - `logs/webhooks/smart-processes/` — события смарт-процессов
   - `logs/webhooks/errors/` — ошибки обработки

3. Проверьте интерфейс просмотра логов:
   - Откройте `/webhook-logs` в приложении
   - Должны отображаться логи событий

---

## Типы событий

### События задач:
- `ONTASKADD` — Создание задачи
- `ONTASKUPDATE` — Обновление задачи
- `ONTASKDELETE` — Удаление задачи
- `ONTASKCOMMENTADD` — Добавление комментария
- `ONTASKCOMMENTUPDATE` — Обновление комментария
- `ONTASKCOMMENTDELETE` — Удаление комментария

### События смарт-процессов:
- `ONCRMDYNAMICITEMADD` — Добавление элемента
- `ONCRMDYNAMICITEMUPDATE` — Изменение элемента
- `ONCRMDYNAMICITEMDELETE` — Удаление элемента

---

## Валидация подписи

Handler автоматически валидирует подпись вебхука, если:
- Файл `webhook-secret.php` существует
- Токен в файле не пустой

Если подпись невалидна, запрос отклоняется с HTTP 401.

**Если токен не настроен:**
- Handler продолжит работу, но будет логировать предупреждение
- Валидация подписи будет отключена

---

## Структура файлов

```
/var/www/back/
├── api/
│   └── webhook-handler.php      # Endpoint для приёма вебхуков
├── webhook-secret.php            # Токен (не в git)
├── webhook-secret.php.example   # Пример файла
└── logs/
    └── webhooks/
        ├── tasks/                # Логи событий задач
        ├── smart-processes/     # Логи событий смарт-процессов
        └── errors/               # Логи ошибок
```

---

## Устранение проблем

### Вебхук не принимается

1. Проверьте доступность URL:
   ```bash
   curl -X POST https://your-domain.com/api/webhook-handler.php
   ```

2. Проверьте логи ошибок в `logs/webhooks/errors/`

3. Проверьте, что токен правильно сохранён в `webhook-secret.php`

### Ошибка валидации подписи

1. Убедитесь, что токен в `webhook-secret.php` совпадает с токеном в Bitrix24
2. Проверьте, что Bitrix24 отправляет подпись в заголовке `X-Bitrix-Signature`
3. Проверьте логи ошибок

### Логи не создаются

1. Проверьте права доступа на папку `logs/webhooks/`:
   ```bash
   chmod -R 755 logs/webhooks/
   ```

2. Проверьте, что события выбраны в настройках вебхука в Bitrix24

---

## Дополнительные ресурсы

- [Bitrix24 REST API - Вебхуки](https://context7.com/bitrix24/rest/webhook/)
- [Bitrix24 REST API - События](https://context7.com/bitrix24/rest/events/)
- [Официальная документация Bitrix24](https://apidocs.bitrix24.ru/rest_help/general/webhooks/index.php)

---

## История правок

- **2025-12-06 (UTC+3, Брест):** Создана инструкция по настройке вебхука

